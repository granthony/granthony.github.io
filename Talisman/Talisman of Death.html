<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Talisman of Death</title>
<style title="Twine CSS">@keyframes appear{0%{opacity:0}to{opacity:1}}@keyframes fade-in-out{0%,to{opacity:0}50%{opacity:1}}@keyframes rumble{25%{top:-0.1em}75%{top:0.1em}0%,to{top:0px}}@keyframes shudder{25%{left:0.1em}75%{left:-0.1em}0%,to{left:0px}}@keyframes buoy{25%{top:0.25em}75%{top:-0.25em}0%,to{top:0px}}@keyframes sway{25%{left:0.25em}75%{left:-0.25em}0%,to{left:0px}}@keyframes pulse{0%{transform:scale(0, 0)}20%{transform:scale(1.2, 1.2)}40%{transform:scale(0.9, 0.9)}60%{transform:scale(1.05, 1.05)}80%{transform:scale(0.925, 0.925)}to{transform:scale(1, 1)}}@keyframes zoom-in{0%{transform:scale(0, 0)}to{transform:scale(1, 1)}}@keyframes shudder-in{0%, to{transform:translateX(0em)}5%, 25%, 45%{transform:translateX(-1em)}15%, 35%, 55%{transform:translateX(1em)}65%{transform:translateX(-0.6em)}75%{transform:translateX(0.6em)}85%{transform:translateX(-0.2em)}95%{transform:translateX(0.2em)}}@keyframes rumble-in{0%, to{transform:translateY(0em)}5%, 25%, 45%{transform:translateY(-1em)}15%, 35%, 55%{transform:translateY(1em)}65%{transform:translateY(-0.6em)}75%{transform:translateY(0.6em)}85%{transform:translateY(-0.2em)}95%{transform:translateY(0.2em)}}@keyframes fidget{0%, 8.1%, 82.1%, 31.1%, 38.1%, 44.1%, 40.1%, 47.1%, 74.1%, 16.1%, 27.1%, 72.1%, 24.1%, 95.1%, 6.1%, 36.1%, 20.1%, 4.1%, 91.1%, 14.1%, 87.1%, to{left:0px;top:0px}8%, 82%, 31%, 38%, 44%{left:-1px}40%, 47%, 74%, 16%, 27%{left:1px}72%, 24%, 95%, 6%, 36%{top:-1px}20%, 4%, 91%, 14%, 87%{top:1px}}@keyframes slide-right{0%{transform:translateX(-100vw)}}@keyframes slide-left{0%{transform:translateX(100vw)}}@keyframes slide-up{0%{transform:translateY(100vh)}}@keyframes slide-down{0%{transform:translateY(-100vh)}}@keyframes fade-right{0%{opacity:0;transform:translateX(-1em)}to{opacity:1}}@keyframes fade-left{0%{opacity:0;transform:translateX(1em)}to{opacity:1}}@keyframes fade-up{0%{opacity:0;transform:translateY(1em)}to{opacity:1}}@keyframes fade-down{0%{opacity:0;transform:translateY(-1em)}to{opacity:1}}@keyframes flicker{0%,29%,31%,63%,65%,77%,79%,86%,88%,91%,93%{opacity:0}30%{opacity:0.2}64%{opacity:0.4}78%{opacity:0.6}87%{opacity:0.8}92%, to{opacity:1}}@keyframes blur{0%{filter:blur(2rem);opacity:0}25%{opacity:1}to{filter:blur(0rem);opacity:1}}.dom-debug-mode tw-story,.dom-debug-mode tw-passage,.dom-debug-mode tw-sidebar,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{outline:1px solid #f5a3da;min-height:32px;display:block !important}.dom-debug-mode tw-story::before,.dom-debug-mode tw-passage::before,.dom-debug-mode tw-sidebar::before,.dom-debug-mode tw-include::before,.dom-debug-mode tw-hook::before,.dom-debug-mode tw-expression::before,.dom-debug-mode tw-link::before,.dom-debug-mode tw-dialog::before,.dom-debug-mode tw-columns::before,.dom-debug-mode tw-column::before,.dom-debug-mode tw-align::before{position:absolute;top:0;left:0;height:16px;background-color:#f5a3da;color:black;font-size:16px;font-weight:normal;font-style:normal;font-family:monospace;display:inline-block;line-height:100%;white-space:pre;z-index:999997}.dom-debug-mode tw-story:hover,.dom-debug-mode tw-passage:hover,.dom-debug-mode tw-sidebar:hover,.dom-debug-mode tw-include:hover,.dom-debug-mode tw-hook:hover,.dom-debug-mode tw-expression:hover,.dom-debug-mode tw-link:hover,.dom-debug-mode tw-dialog:hover,.dom-debug-mode tw-columns:hover,.dom-debug-mode tw-column:hover,.dom-debug-mode tw-align:hover{outline:1px solid #fc9}.dom-debug-mode tw-story:hover::before,.dom-debug-mode tw-passage:hover::before,.dom-debug-mode tw-sidebar:hover::before,.dom-debug-mode tw-include:hover::before,.dom-debug-mode tw-hook:hover::before,.dom-debug-mode tw-expression:hover::before,.dom-debug-mode tw-link:hover::before,.dom-debug-mode tw-dialog:hover::before,.dom-debug-mode tw-columns:hover::before,.dom-debug-mode tw-column:hover::before,.dom-debug-mode tw-align:hover::before{background-color:#fc9;transition:background-color 1s}.dom-debug-mode tw-passage,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{padding:1em;margin:0}.dom-debug-mode tw-story::before{content:'<tw-story tags="' attr(tags) '">'}.dom-debug-mode tw-passage::before{top:-16px;content:'<tw-passage tags="' attr(tags) '">'}.dom-debug-mode tw-sidebar::before{top:-16px;content:"<tw-sidebar>"}.dom-debug-mode tw-hook::before{content:'<tw-hook name="' attr(name) '">'}.dom-debug-mode tw-expression::before{content:'<tw-expression name="' attr(name) '">'}.dom-debug-mode tw-link::before{content:'<tw-link name="' attr(name) '">'}.dom-debug-mode tw-dialog::before{content:"<tw-dialog>"}.dom-debug-mode tw-columns::before{content:"<tw-columns>"}.dom-debug-mode tw-column::before{content:"<tw-column>"}.dom-debug-mode tw-align::before{content:"<tw-align>"}.dom-debug-mode tw-include::before{content:'<tw-include type="' attr(type) '" title="' attr(title) '">'}.debug-mode tw-expression{display:inline-block !important}.debug-mode tw-expression[type=variable]::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"$" attr(name)}.debug-mode tw-expression[type=tempVariable]::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"_" attr(name)}.debug-mode tw-expression[return=boolean]{background-color:rgba(179,179,179,0.2)}.debug-mode tw-expression[return=array]{background-color:rgba(255,102,102,0.2)}.debug-mode tw-expression[return=dataset]{background-color:rgba(255,128,0,0.2)}.debug-mode tw-expression[return=number]{background-color:rgba(255,179,102,0.2)}.debug-mode tw-expression[return=datamap]{background-color:rgba(255,255,102,0.2)}.debug-mode tw-expression[return=changer]{background-color:rgba(179,255,102,0.2)}.debug-mode tw-expression[return=lambda]{background-color:rgba(102,255,102,0.2)}.debug-mode tw-expression[return=hookname]{background-color:rgba(102,255,204,0.2)}.debug-mode tw-expression[return=string]{background-color:rgba(102,255,255,0.2)}.debug-mode tw-expression[return=datatype]{background-color:rgba(102,153,255,0.2)}.debug-mode tw-expression[return=gradient],.debug-mode tw-expression[return=colour]{background-color:rgba(204,102,255,0.2)}.debug-mode tw-expression[return=instant],.debug-mode tw-expression[return=macro]{background-color:rgba(240,117,199,0.2)}.debug-mode tw-expression[return=command]{background-color:rgba(153,153,255,0.2)}.debug-mode tw-expression.false{background-color:rgba(255,0,0,0.2) !important}.debug-mode tw-expression[type=macro]::before{content:"(" attr(name) ":)";padding:0 0.5rem;font-size:1rem;vertical-align:middle;line-height:normal;background-color:inherit;border:1px solid rgba(255,255,255,0.5)}.debug-mode tw-hook{background-color:rgba(0,85,255,0.1) !important}.debug-mode tw-hook::before{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"["}.debug-mode tw-hook::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"]"}.debug-mode tw-hook[name]::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"]<" attr(name) "|"}.debug-mode tw-pseudo-hook{background-color:rgba(255,170,0,0.1) !important}.debug-mode tw-collapsed::before{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"{"}.debug-mode tw-collapsed::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"}"}.debug-mode tw-verbatim::before,.debug-mode tw-verbatim::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:"`"}.debug-mode tw-align[style*="text-align: center"]{background:linear-gradient(to right, rgba(255,204,189,0) 0%, rgba(255,204,189,0.25) 50%, rgba(255,204,189,0) 100%)}.debug-mode tw-align[style*="text-align: left"]{background:linear-gradient(to right, rgba(255,204,189,0.25) 0%, rgba(255,204,189,0) 100%)}.debug-mode tw-align[style*="text-align: right"]{background:linear-gradient(to right, rgba(255,204,189,0) 0%, rgba(255,204,189,0.25) 100%)}.debug-mode tw-column{background-color:rgba(189,228,255,0.2)}.debug-mode tw-enchantment{animation:enchantment 0.5s infinite;border:1px solid}.debug-mode tw-link::after,.debug-mode tw-broken-link::after{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:attr(passage-name)}.debug-mode tw-include{background-color:rgba(204,128,51,0.1)}.debug-mode tw-include::before{font-size:0.8rem;padding-left:0.2rem;padding-right:0.2rem;vertical-align:top;content:attr(type) ' "' attr(title) '"'}@keyframes enchantment{0%,to{border-color:#ffb366}50%{border-color:#6fc}}tw-debugger{position:fixed;box-sizing:border-box;bottom:0;right:0;z-index:999999;min-width:10em;min-height:1em;padding:0em 0.5em 0.5em 1em;font-size:1.25em;font-family:sans-serif;color:#000;border-left:solid #000 2px;border-top:solid #000 2px;border-top-left-radius:.5em;background:#fff;opacity:1}tw-debugger select{margin-right:1em;width:12em}tw-debugger button{border-radius:3px;border:solid #999 1px;margin:auto 4px;background-color:#fff;font-size:inherit;color:#000}tw-debugger button.enabled{background-color:#eee;box-shadow:inset #ddd 3px 5px 0.5em}tw-debugger .panel{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;position:absolute;bottom:100%;left:-2px;right:0;padding:1em;max-height:40vh;overflow-y:scroll;overflow-x:hidden;z-index:999998;background:#fff;border:inherit;border-bottom:solid #999 2px;border-top-left-radius:.5em;border-bottom-left-radius:.5em;font-size:0.8em}tw-debugger .panel:empty,tw-debugger .panel[hidden]{display:none}tw-debugger .panel-source,tw-debugger .panel-row-source{font-family:monospace;overflow-x:scroll;white-space:pre;-ms-flex-preferred-size:100%;flex-basis:100%}tw-debugger .panel-row-source{margin:5px 0}tw-debugger .panel-rows{width:100%;overflow-x:scroll}tw-debugger .panel-rows>*{display:table-row}tw-debugger .panel-rows>div:nth-of-type(2n){background:#EEE}tw-debugger .panel-row-buttons{text-align:right}tw-debugger .panel-variables .panel-rows:empty::before{content:"~ No variables ~";font-style:italic;color:#888;text-align:center}tw-debugger .panel-enchantments .panel-rows:empty::before{content:"~ No enchantments ~";font-style:italic;color:#888;text-align:center}tw-debugger .panel-errors .panel-rows:empty::before{content:"~ No errors... for now. ~";font-style:italic;color:#888;text-align:center}tw-debugger .panel-rows:empty+.panel-variables-bottom{display:none}tw-debugger .panel-storylets:not(.panel-exclusive) .storylet-exclusive,tw-debugger .panel-storylets:not(.panel-urgent) .storylet-urgent{display:none}tw-debugger .panel-variables-bottom{padding-top:5px}tw-debugger .enchantment-row{min-height:1.5em}tw-debugger .variable-path{opacity:0.4}tw-debugger .temporary-variable-scope,tw-debugger .enchantment-local{font-family:sans-serif;font-weight:normal;opacity:0.8;font-size:0.75em}tw-debugger .temporary-variable-scope:not(:empty)::before,tw-debugger .enchantment-local:not(:empty)::before{content:" in "}tw-debugger .variable-name,tw-debugger .enchantment-name{font-family:monospace;font-weight:bold}tw-debugger .variable-type{color:#444;font-weight:normal;text-overflow:ellipsis;overflow:hidden;max-width:10em}tw-debugger .error-row{display:table-row;background-color:rgba(230,101,204,0.3)}tw-debugger .error-row:nth-of-type(2n){background-color:rgba(237,145,219,0.3)}tw-debugger .error-row>*{display:table-cell;padding:0.25em 0.5em}tw-debugger .error-row .error-message{cursor:help}tw-debugger .error-row .error-passage{color:#444}tw-debugger .storylet-row{background-color:rgba(201,233,222,0.3)}tw-debugger .storylet-row:nth-child(2n){background-color:rgba(128,203,178,0.3)}tw-debugger .storylet-row.storylet-closed{font-style:italic;opacity:0.4;background-color:rgba(217,217,217,0.3)}tw-debugger .storylet-row.storylet-closed:nth-child(2n){background-color:rgba(166,166,166,0.3)}.storylet-error tw-debugger .storylet-row{background-color:rgba(230,101,204,0.3)}.storylet-error tw-debugger .storylet-row:nth-child(2n){background-color:rgba(237,145,219,0.3)}tw-debugger .storylet-row .storylet-name,tw-debugger .storylet-row .storylet-value{display:inline-block;width:50%}tw-debugger .tabs{padding-bottom:0.5em}tw-debugger .tab{border-radius:0px 0px 0.5em 0.5em;border-top:none}tw-debugger .resizer{position:absolute;height:3em;border-left:2px solid #ccc;border-right:2px solid #ccc;top:10px;left:4px;width:8px;cursor:ew-resize}tw-dialog{z-index:999997;border:#fff solid 2px;padding:2em;color:#fff;background-color:#000;display:block}@media (min-width: 576px){tw-dialog{max-width:50vw}}tw-dialog input[type=text]{font-size:inherit;width:100%}tw-dialog-links{text-align:right;display:-ms-flexbox;display:flex;-ms-flex-pack:end;justify-content:flex-end}tw-backdrop{z-index:999996;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,0.8);display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center}tw-backdrop ~ tw-backdrop{display:none}tw-link,.link,tw-icon,.enchantment-clickblock{cursor:pointer}tw-link,.enchantment-link{color:#4169E1;font-weight:bold;text-decoration:none;transition:color 0.2s ease-in-out}tw-passage [style^="color"] tw-link:not(:hover),tw-passage [style*=" color"] tw-link:not(:hover),tw-passage [style^="color"][hover="true"] tw-link:hover,tw-passage [style*=" color"][hover="true"] tw-link:hover,tw-passage [style^="color"] .enchantment-link:not(:hover),tw-passage [style*=" color"] .enchantment-link:not(:hover),tw-passage [style^="color"][hover="true"] .enchantment-link:hover,tw-passage [style*=" color"][hover="true"] .enchantment-link:hover{color:inherit}tw-link:hover,.enchantment-link:hover{color:#00bfff}tw-link:active,.enchantment-link:active{color:#DD4B39}.visited{color:#6941e1}tw-passage [style^="color"] .visited:not(:hover),tw-passage [style*=" color"] .visited:not(:hover),tw-passage [style^="color"][hover="true"] .visited:hover,tw-passage [style*=" color"][hover="true"] .visited:hover{color:inherit}.visited:hover{color:#E3E}tw-broken-link{color:#993333;border-bottom:2px solid #993333;cursor:not-allowed}tw-passage [style^="color"] tw-broken-link:not(:hover),tw-passage [style*=" color"] tw-broken-link:not(:hover),tw-passage [style^="color"][hover="true"] tw-broken-link:hover,tw-passage [style*=" color"][hover="true"] tw-broken-link:hover{color:inherit}.enchantment-mouseover{border-bottom:2px dashed #999}.enchantment-mouseout{border:rgba(64,149,191,0.6) 1px solid}.enchantment-mouseout:hover{background-color:rgba(175,197,207,0.75);border:transparent 1px solid;border-radius:0.2em}.enchantment-clickblock{width:100%;height:100%;display:block}.enchantment-clickblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;color:rgba(65,105,225,0.5);transition:color 0.2s ease-in-out}.enchantment-clickblock>:not(tw-enchantment):hover::after{color:rgba(0,191,255,0.5)}.enchantment-clickblock>:not(tw-enchantment):active::after{color:rgba(222,78,59,0.5)}.enchantment-clickblock>:not(tw-enchantment)::after{box-shadow:inset 0 0 0 0.5vmax}.enchantment-clickblock>tw-passage::after,.enchantment-clickblock>tw-sidebar::after{box-shadow:0 0 0 0.5vmax}.enchantment-mouseoverblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:2px dashed #999}.enchantment-mouseoutblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:rgba(64,149,191,0.6) 2px solid}.enchantment-mouseoutblock:hover>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;background-color:rgba(175,197,207,0.75);border:transparent 2px solid;border-radius:0.2em}tw-link.enchantment-button,.enchantment-link.enchantment-button,.enchantment-button:not(.enchantment-link) tw-link,.enchantment-button:not(.enchantment-link) .enchantment-link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block}tw-dialog-links{padding-top:1.5em}tw-dialog-links tw-link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block;display:inline-block}html{margin:0;height:100%;overflow-x:hidden}*,:before,:after{position:relative;box-sizing:inherit}body{margin:0;height:100%}tw-storydata{display:none}tw-story{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;font:100% Georgia, serif;box-sizing:border-box;width:100%;min-height:100%;font-size:1.5em;line-height:1.5em;padding:5% 5%;overflow:hidden;background-color:#000;color:#fff}tw-story [style*=content-box] *{box-sizing:border-box}@media (min-width: 576px){tw-story{padding:5% 20%}}tw-story tw-consecutive-br{display:block;height:1.6ex;visibility:hidden}tw-story select{background-color:transparent;font:inherit;border-style:solid;padding:2px}tw-story select:not([disabled]){color:inherit}tw-story textarea{resize:none;background-color:transparent;font:inherit;color:inherit;border-style:none;padding:2px}tw-story input[type=checkbox]{transform:scale(1.5);margin:0 0.5em}tw-story tw-noscript{animation:appear 0.8s}tw-passage{display:block}tw-sidebar{text-align:center;display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between}@media (min-width: 576px){tw-sidebar{left:-5em;width:3em;position:absolute;-ms-flex-direction:column;flex-direction:column}tw-enchantment[style*="width"]>tw-sidebar{width:inherit}}tw-icon{display:inline-block;margin:0.5em 0;font-size:66px;font-family:"Verdana",sans-serif}tw-icon[alt]{opacity:0.2}tw-icon[alt]:hover{opacity:0.4}tw-icon[data-label]::after{font-weight:bold;content:attr(data-label);font-size:20px;bottom:-20px;left:-50%;white-space:nowrap}tw-meter{display:block}tw-hook:empty,tw-expression:empty{display:none}tw-error{display:inline-block;border-radius:0.2em;padding:0.2em;font-size:1rem;cursor:help;white-space:pre-wrap}tw-error.error{background-color:rgba(223,58,190,0.6);color:#fff}tw-error.warning{background-color:rgba(223,140,58,0.6);color:#fff;display:none}.debug-mode tw-error.warning{display:inline}tw-error-explanation{display:block;font-size:0.8rem;line-height:1rem}tw-open-button,tw-folddown{cursor:pointer;line-height:0em;border-radius:1px;border:1px solid black;font-size:0.8rem;margin:0 0.4rem;padding:2px;white-space:pre}tw-folddown::after{content:"\25b6"}tw-folddown.open::after{content:"\25bc"}tw-open-button::after{content:"Open"}tw-notifier{border-radius:0.2em;padding:0.2em;font-size:1rem;background-color:rgba(223,182,58,0.4);display:none}.debug-mode tw-notifier{display:inline}tw-notifier::before{content:attr(message)}tw-colour{border:1px solid black;display:inline-block;width:1em;height:1em}tw-enchantment:empty{display:none}h1{font-size:3em}h2{font-size:2.25em}h3{font-size:1.75em}h1,h2,h3,h4,h5,h6{line-height:1em;margin:0.3em 0 0.6em 0}pre{font-size:1rem;line-height:initial}small{font-size:70%}big{font-size:120%}mark{color:rgba(0,0,0,0.6);background-color:#ff9}ins{color:rgba(0,0,0,0.6);background-color:rgba(255,242,204,0.5);border-radius:0.5em;box-shadow:0em 0em 0.2em #ffe699;text-decoration:none}center{text-align:center;margin:0 auto;width:60%}blink{text-decoration:none;animation:fade-in-out 1s steps(1, end) infinite alternate}tw-align{display:block}tw-columns{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;-ms-flex-pack:justify;justify-content:space-between}.transition-in{animation:appear 0ms step-start}.transition-out{animation:appear 0ms step-end}[data-t8n^=dissolve].transition-in,[data-t8n=fade].transition-in{animation:appear .8s}[data-t8n^=dissolve].transition-out,[data-t8n=fade].transition-out{animation:appear .8s reverse}[data-t8n^=shudder].transition-in{display:inline-block !important;animation:shudder-in .8s}[data-t8n^=shudder].transition-out{display:inline-block !important;animation:shudder-in .8s reverse}[data-t8n^=rumble].transition-in{display:inline-block !important;animation:rumble-in .8s}[data-t8n^=rumble].transition-out{display:inline-block !important;animation:rumble-in .8s reverse}[data-t8n^=pulse].transition-in{animation:pulse .8s;display:inline-block !important}[data-t8n^=pulse].transition-out{animation:pulse .8s reverse;display:inline-block !important}[data-t8n^=zoom].transition-in{animation:zoom-in .8s;display:inline-block !important}[data-t8n^=zoom].transition-out{animation:zoom-in .8s reverse;display:inline-block !important}[data-t8n^=blur].transition-in{animation:blur .8s;display:inline-block !important}[data-t8n^=blur].transition-out{animation:blur .8s reverse;display:inline-block !important}[data-t8n^=slideleft].transition-in{animation:slide-left .8s;display:inline-block !important}[data-t8n^=slideleft].transition-out{animation:slide-right .8s reverse;display:inline-block !important}[data-t8n^=slideright].transition-in{animation:slide-right .8s;display:inline-block !important}[data-t8n^=slideright].transition-out{animation:slide-left .8s reverse;display:inline-block !important}[data-t8n^=slideup].transition-in{animation:slide-up .8s;display:inline-block !important}[data-t8n^=slideup].transition-out{animation:slide-down .8s reverse;display:inline-block !important}[data-t8n^=slidedown].transition-in{animation:slide-down .8s;display:inline-block !important}[data-t8n^=slidedown].transition-out{animation:slide-up .8s reverse;display:inline-block !important}[data-t8n^=fadeleft].transition-in{animation:fade-left .8s;display:inline-block !important}[data-t8n^=fadeleft].transition-out{animation:fade-right .8s reverse;display:inline-block !important}[data-t8n^=faderight].transition-in{animation:fade-right .8s;display:inline-block !important}[data-t8n^=faderight].transition-out{animation:fade-left .8s reverse;display:inline-block !important}[data-t8n^=fadeup].transition-in{animation:fade-up .8s;display:inline-block !important}[data-t8n^=fadeup].transition-out{animation:fade-down .8s reverse;display:inline-block !important}[data-t8n^=fadedown].transition-in{animation:fade-down .8s;display:inline-block !important}[data-t8n^=fadedown].transition-out{animation:fade-up .8s reverse;display:inline-block !important}[data-t8n^=flicker].transition-in{animation:flicker .8s}[data-t8n^=flicker].transition-out{animation:flicker .8s reverse}
</style>
</head>
<body>
<tw-story><noscript><tw-noscript>JavaScript needs to be enabled to play Talisman of Death.</tw-noscript></noscript></tw-story>
<tw-storydata name="Talisman of Death" startnode="12" creator="Twine" creator-version="2.3.14" ifid="625BB558-2BA5-4F56-B8CF-0E5266D9A770" zoom="0.6" format="Harlowe" format-version="3.2.2" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">body, tw-story, tw-sidebar {
  font-family: Palatino, "Palatino LT STD", "Palatino Linotype", "Book Antiqua", Georgia, serif;
}

tw-sidebar {
    display: flex;
    left: -15em;
    width: 12.5em;
    text-align: left;
}

tw-sidebar [name="meter"]+br {
    display: none;
}

tw-story {
	padding: 5% 15% 5% 30%;
}

tw-story br { content: ""; display: block; margin: 1rem 0; }
tw-sidebar br { content: none; margin: 0; }

tw-link, .enchantment-link {
    color: #fff;
    border-bottom: 1px dotted #ddd;
}

tw-include[type="startup"] {
  display: none;
}

.visited {
  color: white;
}
.visited:hover {
  color: #00bfff;
}

tw-include[title="MOBILE TOGGLE"] {
  display: none;
}
span.ellipsis {
    white-space: nowrap;
}

a {
	color: #fff;
	font-weight: bold;
}
a:hover {
    color: #00bfff;
}
@media only screen and (max-width: 1023px) {
  body, tw-story, tw-sidebar {
	font-size: 1.2rem;
	line-height: 1.4;
  }
  tw-sidebar {
    position: fixed;
    left: -100vh;
    top: 0;
    width: 85vw;
    height: 100vh;
    z-index: 2;
    background-color: #222;
    transition: left 0.3s;
	padding: 60px 15px;
  }
  tw-sidebar.open {
	left: 0;
  }
  tw-include[title="MOBILE TOGGLE"] {
	  position: fixed;
	  z-index: 10;
	  display: block;
	  text-align: center;
	  line-height: 50px;
	  font-size: 30px;
	  right: 15px;
	  bottom: 15px;
	  width: 60px;
	  height: 60px;
	  background-color: #aaa;
	  border: 1px solid #fff;
	  border-radius: 100%;
 	  cursor: pointer;
  }
  tw-story {
	padding: 60px 15px 120px;
  }
}	
@media only screen and (min-width: 1024px) {
	tw-sidebar {
  		height: 80vh;
		overflow-y: auto;
	}
}

tw-sidebar .inventory {
  border-top: 1px solid #404040;
  border-bottom: 1px solid #404040;
  padding: 1em 0;
  margin: 1em 0;
}</style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-tag name="TODO" color="blue"></tw-tag>,<tw-tag name="cellardoor" color="blue"></tw-tag>,<tw-tag name="death" color="red"></tw-tag>,<tw-tag name="door" color="blue"></tw-tag>,<tw-tag name="item" color="yellow"></tw-tag>,<tw-tag name="key" color="green"></tw-tag>,<tw-tag name="monster" color="red"></tw-tag>,<tw-tag name="mordana" color="yellow"></tw-tag>,<tw-tag name="pentacle" color="yellow"></tw-tag>,<tw-tag name="skill-check" color="orange"></tw-tag>,<tw-tag name="stat-change" color="purple"></tw-tag>,<tw-tag name="stat-change:done" color="green"></tw-tag>,<tw-tag name="test-your-luck" color="orange"></tw-tag>,<tw-tag name="torture" color="orange"></tw-tag>,<tw-tag name="weapon" color="yellow"></tw-tag><tw-passagedata pid="1" name="Intro 1" tags="intro" position="1176,1467" size="100,100">&lt;center&gt;BACKGROUND&lt;/center&gt;
You are regaining consciousness. Your eyes flutter open to the sound of a songbird, trilling joyously. You are lying on a couch of green velvet, set on the topmost turret of a great white castle hanging in the clouds. Rising to your feet you look around. The songbird, whose sleek feathers are a warm burnished gold, is perched on the battlements, resplendent against the ocean-blue canopy of a sky in which there is no sun. 
You are clad in strange, outlandish clothes, breeches of dark-green leather and a thickly quilled leather jerkin. On your feet are russet-red calfskin boots, supple and comfortable, into which the breeches are tucked at mid-calf. A heavy sword is belted at your side and, with a shock, you realize that somehow you know how to use it skilfully and with deadly force. As the songbird trills you try, in vain, to recall memories of Earth but everything is hazy and distant. You have been taken from the world you know and trained in the art of sword-play. You cannot remember even who trained you or why, but the hilt of the sword fits your hand snugly. Drawing it, you lunge and parry, marvelling at how the sword cuts through the air faster than the eye can follow. The songbird seems unperturbed by your fine display of swordsmanship, but you are surprised when it cocks its head and [[speaks-&gt;Intro 2]] to you, its voice fluting merrily.</tw-passagedata><tw-passagedata pid="2" name="Page 1" tags="" position="1737,1928" size="100,100">When awareness returns you look around. You are standing in a huge vaulted chamber, deep underground.  In the chill air you wonder what terrible fate may be in store for you. You are utterly alone, without a friend in the world, and you have no ìdea what fiendish horrors may exist here, so far from home. There are no windows in the chamber, nor natural light, only the ruddy glow of flaming torches that are fixed to pillars soaring beyond sight. The walls are running with damp, the air musty and heavy with age. There are two archways at the back of the cavern. Before you can investigate further, the torchlight flickers, and a cool gust chills you to the marrow; something in the unseen darkness is causing the air to move. A light flashes briefly ahead and an infernal howling echoes across the vast vault. No living thing could possibly have made that dreadful sound, you think to yourself, but then you remember that you know nothing of the dreadful denizens of Orb. You hear the sound of running footsteps approaching rapidly; you cannot yet see who or what is coming.  Will you run through the nearest [[archway-&gt;Page 17]], or hold your ground and [[draw your sword-&gt;Page 30]]?
|testing)[(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First BADDIE&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 7
		)
	,
		(dm:
		  &quot;name&quot;, &quot;Second BADDIE&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 7
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[Congratulations!  You win!]]</tw-passagedata><tw-passagedata pid="3" name="INIT" tags="startup" position="101,1702" size="100,100">(display: &quot;INIT_STATS&quot;)
(display: &quot;FUNCTIONS&quot;)
(display: &quot;SET_GENDERS&quot;)</tw-passagedata><tw-passagedata pid="4" name="STATS" tags="" position="139,2547" size="100,100">(meter: bind $player&#39;s skill, 12, &quot;X&quot;, &quot; SKILL: (str:$player&#39;s skill) / (str:$player&#39;s max_skill)&quot;, #d0b000)
(meter: bind $player&#39;s stamina, 24, &quot;X&quot;, &quot; STAMINA: (str:$player&#39;s stamina) / (str:$player&#39;s max_stamina)&quot;, #00b000)
(meter: bind $player&#39;s luck, 12, &quot;X&quot;, &quot; LUCK: (str:$player&#39;s luck) / (str:$player&#39;s max_luck)&quot;, blue)</tw-passagedata><tw-passagedata pid="5" name="SIDEBAR" tags="header footer" position="56,2398" size="100,100">(replace: ?sidebar)[{
	(display: &quot;STATS&quot;)
	(display: &quot;INVENTORY&quot;)
	(if: $weapons is not (ds:))[(display: &quot;WEAPONS&quot;)]
	(if: $keyring contains any of (a:&quot;Mordana in Abaddon&quot;, &quot;Cellar Door&quot;))[(display: &quot;SPECIALS&quot;)]
	(if: (history:)&#39;s length &gt; 0)[{(link: &quot;RESTART&quot;)[(restart:)]&lt;br/&gt;}]
	(if: $savemode is true)[(display: &quot;SAVE&quot;)]
}]</tw-passagedata><tw-passagedata pid="6" name="INSTADEATH" tags="footer" position="68,2256" size="100,100">|instadeath&gt;[(if: $player&#39;s stamina &lt;= 0 and $monsters is (a:))[{
	(replace: ?link)[]}
	Your STAMINA ran out!  Your adventure ends ($dotdotdot:&quot;here&quot;)
	{(link:&quot;Try again?&quot;)[(restart:)]}
]
(if: (passage: )&#39;s tags contains &#39;death&#39;)[
	GAME OVER.
	(link:&quot;Try again?&quot;)[(restart:)]
	(link-undo:&quot;Undo&quot;) the last move? (Not guaranteed to save you.)
] ]</tw-passagedata><tw-passagedata pid="7" name="SET_STATS" tags="" position="138,1952" size="100,100">{(set: $player&#39;s max_skill to (random: 1,6) + 6)
(set: $player&#39;s skill to $player&#39;s max_skill)
(set: $player&#39;s max_stamina to (random: 1,6) + (random: 1,6) +  12)
(set: $player&#39;s stamina to $player&#39;s max_stamina)
(set: $player&#39;s max_luck to (random: 1,6) + 6)
(set: $player&#39;s luck to $player&#39;s max_luck)
(set: $player&#39;s weapon to (dm: &quot;name&quot;, &quot;Sword&quot;, &quot;modifier&quot;, 2))}
(set: $player&#39;s gold to 0)</tw-passagedata><tw-passagedata pid="8" name="FUNCTIONS" tags="" position="278,1954" size="100,100">(set: $STAMINA to (macro: num-type _amount, [ \
	(set: $player&#39;s stamina to (max: 0, (min: it + _amount, $player&#39;s max_stamina)))(display: &quot;INSTADEATH&quot;)(display: &quot;SIDEBAR&quot;)(output:)[]]))
(set: $SKILL to (macro: num-type _amount, [ \
	(set: $player&#39;s skill to (max: 0, (min: it + _amount, $player&#39;s max_skill)))(display: &quot;SIDEBAR&quot;)(output:)[]]))
(set: $LUCK to (macro: num-type _amount, [ \
	(set: $player&#39;s luck to (max: 0, (min: it + _amount, $player&#39;s max_luck)))(display: &quot;SIDEBAR&quot;)(output:)[]]))
(set: $GOLD to (macro: num-type _amount, [ \
	(set: $player&#39;s gold to (max: 0, it + _amount))(display: &quot;SIDEBAR&quot;)(output:)[]]))
(set: $PROVISIONS to (macro: num-type _amount, [ \
	(set: $player&#39;s provisions to (max: 0, it + _amount))(display: &quot;SIDEBAR&quot;)(output:)[]]))
(set: $dotdotdot to (macro: str-type _text, [ \
	(output:)[&lt;span class=&quot;ellipsis&quot;&gt;_text . . .&lt;/span&gt;]]))
(set: $add_key to (macro: str-type _key, [{
	(set: $keyring to it + (ds: key))
	(output:)[]
}]))
(set: $add_item to (macro: str-type _item, [{
	(set: $inventory to it + (ds: _item))
	(output:)[(display: &quot;SIDEBAR&quot;)]
}]))
(set: $remove_item to (macro: str-type _item, [{
	(set: $inventory to it - (ds: _item))
	(output:)[(display: &quot;SIDEBAR&quot;)]
}]))
(set: $add_weapon to (macro: dm-type _item, [{
	(set: $weapons to it + (ds: _item))
	(set: $player&#39;s skill to it - $player&#39;s weapon&#39;s modifier)
	(set: $player&#39;s weapon to _item)
	(set: $player&#39;s skill to it + $player&#39;s weapon&#39;s modifier)
	(output:)[(display: &quot;SIDEBAR&quot;)]
}]))
(set: $remove_weapon to (macro: [{
	(set: $player&#39;s skill to it - $player&#39;s weapon&#39;s modifier)
	(set: $player&#39;s weapon to (dm: &quot;name&quot;, &quot;bare hands&quot;, &quot;modifier&quot;, 0))
	(output:)[(display: &quot;SIDEBAR&quot;)]
}]))
(set: $lose_weapon to (macro: [{
	(set: $weapons to it - (ds: $player&#39;s weapon))
	($remove_weapon:)
	(output:)[(display: &quot;SIDEBAR&quot;)]
}]))</tw-passagedata><tw-passagedata pid="9" name="KILLED" tags="" position="319,2146" size="100,100">You have been defeated in combat.  Your adventure ends here.
(link:&quot;Try again?&quot;)[(restart:)]</tw-passagedata><tw-passagedata pid="10" name="INVENTORY" tags="" position="253,2550" size="100,100">|INVENTORY&gt;[&lt;div class=&quot;inventory&quot;&gt;INVENTORY
&lt;ul&gt;(for: each _item, ...$inventory)[{
(if: _item is &quot;Pentacle&quot;)[(display: &quot;PENTACLE&quot;)]
(elseif: _item is &quot;Golden Apple&quot;)[(display: &quot;GOLDEN APPLE&quot;)]
(else:)[&lt;li&gt;(print: _item)&lt;/li&gt;]
}]
(if: $player&#39;s gold &gt; 0)[{&lt;li&gt;(plural: $player&#39;s gold, &quot;gold piece&quot;)&lt;/li&gt;}]
(if: $player&#39;s provisions &gt; 0)[(display: &quot;PROVISIONS&quot;)]
(if: $player&#39;s torches &gt; 0)[(display: &quot;TORCHES&quot;)]
&lt;/ul&gt;&lt;/div&gt;]</tw-passagedata><tw-passagedata pid="11" name="WEAPONS" tags="" position="373,2541" size="100,100">&lt;div class=&quot;weapons&quot;&gt;WEAPONS
&lt;ul&gt;(for: each _weapon, ...$weapons)
[{
	&lt;li&gt;
		(if: $player&#39;s weapon is _weapon)[
			(print: _weapon&#39;s name) (wielded)
		](else:)[(link-rerun: _weapon&#39;s name)[
			(set: $player&#39;s skill to it - $player&#39;s weapon&#39;s modifier)
			(set: $player&#39;s weapon to _weapon)
			(set: $player&#39;s skill to it + $player&#39;s weapon&#39;s modifier)
			(display: &quot;SIDEBAR&quot;)
		]]&lt;/li&gt;
}]&lt;/ul&gt;&lt;/div&gt;</tw-passagedata><tw-passagedata pid="12" name="TITLE" tags="" position="977,1691" size="100,100">&lt;center&gt;
&lt;h2&gt;Jamie Thomson and Mark Smith&lt;/h2&gt;
&lt;h1&gt;Talisman Of Death&lt;/h1&gt;
[[Read the Instructions-&gt;Instructions]]
(link-repeat:&quot;Begin&quot;)[(set: $show_intro to 1)(goto: &quot;Starting Equipment&quot;)] / (link-repeat:&quot;Skip Intro and Begin&quot;)[(set: $show_intro to 0)(goto: &quot;Starting Equipment&quot;)]
(link-repeat:&quot;Re-roll Stats&quot;)[(display: &quot;SET_STATS&quot;)(display:&quot;SIDEBAR&quot;)]
Save Mode: (if: $savemode is true)[(link-repeat:&quot;On&quot;)[(set: $savemode to false)(goto:&quot;TITLE&quot;)]](else:)[(link-repeat:&quot;Off&quot;)[(set: $savemode to true)(goto:&quot;TITLE&quot;)]]
[[Version History-&gt;VERSIONS]]
&lt;h3&gt;&lt;code&gt;WORK IN PROGRESS, NOT FOR RELEASE&lt;/code&gt;&lt;/h3&gt;
&lt;/center&gt;</tw-passagedata><tw-passagedata pid="13" name="Instructions 1" tags="" position="716,2104" size="100,100">&lt;center&gt;HOW TO FIGHT THE CREATURES OF ORB&lt;/center&gt;
&lt;p&gt;Before embarking on your adventure, you must first determine your own strengths and weaknesses. You have in your possession a sword, a backpack containing provisions (food and drink), and fire flares to combat the dark terrors of Orb. After weeks of intensive training, your sword-play is swift and deadly.&lt;/p&gt;
&lt;p&gt;To discover the strength of your courage and the power of luck you must use the dice to determine your initial STAMINA and LUCK scores. On pages 18-19 there is an Adventure Sheet which you may use to record the details of an adventure. On it you will find boxes for recording your SKILL and  STAMINA and LUCK scores.&lt;/p&gt;
&lt;p&gt;You are advised either to record your scores on the Adventure Sheet in pencil or to make photocopies of the page to use in future adventures.&lt;/p&gt;
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 2]]</tw-passagedata><tw-passagedata pid="14" name="Instructions 2" tags="" position="711,2254" size="100,100">&lt;center&gt;&lt;b&gt;Battles&lt;/b&gt;&lt;/center&gt;
You will often come across pages in the book which instruct you to fight a creature of some sort. An option to flee may be given, but if not - or if you choose to attack the creature anyway — you must resolve the battle as described below:
First record the creature&#39;s SKILL and STAMINA in the first vacant Monster Encounter Box on your Adventure Sheet.  The scores for each creature are given in the book each time you have an encounter.
The sequence of combat is then:
1. Roll both dice once for the creature. Add its SKILL score. This total is the creature’s Attack Strength.
2. Roll both dice once for yourself. Add the number rolled to your current SKILL score. This total is your Attack Strength.
3. If your Attack Strength is higher than that of the creature, you have wounded it. Proceed to step 4. If the creature&#39;s Attack Strength is higher than yours, it has wounded you. Proceed to step 5. If both Attack Strength totals are the same, you have avoided each other’s blows — start the next Attack Round from step 1 above.
4. You have wounded the creature, so subtract 2 points from its STAMINA score. You may use your Luck here to do additional damage (see below).
5. The creature has wounded you, so subtract 2 points from your own STAMINA score. Again you may use LUCK at this stage (see below).
6. Make the appropriate adjustments to either the creature’s or your own STAMINA scores (and your LUCK score if you used Luck — see below).
7. Begin the next Attack Round by returning to your current SKILL score and repeating steps 1-6. This sequence continues until the STAMINA score of either you or the creature you are fighting has been reduced to zero (death).
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 3]]</tw-passagedata><tw-passagedata pid="15" name="Instructions 3" tags="" position="711,2404" size="100,100">&lt;center&gt;&lt;b&gt;Escaping&lt;/b&gt;&lt;/center&gt;
On some pages you may be given the option of running away from a battle should things be going badly for you. However, if you do run away, the creature automatically gets in one wound on you (subtract 2 STAMINA points) as you flee. Such is the price of cowardice. Note that you may use LUCK on this wound in the normal way (see below). You may only &lt;i&gt;Escape&lt;/i&gt; if that option is specifically given to you on the page.
&lt;center&gt;&lt;b&gt;Fighting More Than One Creature&lt;/b&gt;&lt;/center&gt;
Sometimes you will find yourself under attack from more than one person or creature. When this happens, each will have a separate attack on you in each Attack Round but you must choose which one you will fight. Attack your chosen target as in normal battle. Against the other, you must throw for your Attack Strength in the normal way but, even if your Attack Strength is greater, you will not inflict a wound. Just count this as though you have parried an incoming blow.  However if your Attack Strength is lower, you will have been wounded in the normal way.
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 4]]</tw-passagedata><tw-passagedata pid="16" name="Instructions 4" tags="" position="711,2554" size="100,100">&lt;center&gt;&lt;b&gt;Luck&lt;/b&gt;&lt;/center&gt;
At various times during your adventure, either in battles or when you come across situations in which you could either be lucky or unlucky (details of these are given on the pages themselves), you may call on your LUCK to make the outcome more favourable. But beware! Using Luck is a risky business and if you are &lt;i&gt;un&lt;/i&gt;lucky, the results could be disastrous.
The procedure for using your Luck is as follows: roll two dice. If the number rolled is equal to or less than your current LUCK score, you have been lucky and the result will go in your favour. If the number rolled is higher than your current LUCK score, you have been unlucky and you will be penalized.
This procedure is known as &lt;i&gt;Testing your Luck&lt;/i&gt;. Each time you &lt;i&gt;Test your Luck&lt;/i&gt;, you must subtract one point from your current LUCK score. Thus you will soon realize that the more you rely on your luck, the more risky this will become.
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 5]]</tw-passagedata><tw-passagedata pid="17" name="VERSIONS" tags="" position="561,1872" size="100,100">[==
=&gt;&lt;=
&lt;h3&gt;Version History&lt;/h3&gt;
&lt;==
v0.0.1 (THIS VERSION)
&lt;ul&gt;
&lt;li&gt;Starting from a bare framework, based on my earlier port of House Of Hell.&lt;/li&gt;
&lt;li&gt;Completely and significantly rewrote the code for battles. Still not happy with it.&lt;/li&gt;
&lt;li&gt;The first hundred-fifty or so page references OCRed, tidied up, linked, and mostly implemented.&lt;/li&gt;
&lt;/ul&gt;
[[Back to title page-&gt;TITLE]]</tw-passagedata><tw-passagedata pid="18" name="Instructions" tags="" position="724,1965" size="100,100">&lt;center&gt;&lt;b&gt;Instructions&lt;/b&gt;&lt;/center&gt;
You can either read the [[original instructions-&gt;Instructions 1]], as printed in the book, or else my [[brief recap]].</tw-passagedata><tw-passagedata pid="19" name="brief recap" tags="" position="971,1975" size="100,100">&lt;center&gt;Instructions in brief&lt;/center&gt;
Character stats (SKILL, STAMINA and LUCK) are tracked automatically, and displayed in the sidebar at left. As you progress, items and weapons in your inventory will also appear here. Weapons you acquire must be wielded (by clicking on them) before they will give you a SKILL increase.
Fights are a roll-off: 2d6 + your skill versus 2d6 + your opponent&#39;s skill. Successful hits deal 2 points of STAMINA damage;  ties have no effect.  After a hit, you can choose to &quot;Test Your Luck&quot;, to either reduce the damage you&#39;ve taken, or deal additional damage.  If you succeed, you deal 2 additional damage / receive 1 less damage. If you fail, you deal 1 less damage / take 1 additional damage.  (&quot;Testing your luck&quot; requires you to roll less-than-or-equal-to your LUCK score on two dice, and every attempt made reduces your LUCK by 1 point.)
The above is much more easily understood by just playing the game and getting into some fights.
[[Return to title screen-&gt;TITLE]]
Read the [[Original Instructions-&gt;Instructions 1]]</tw-passagedata><tw-passagedata pid="20" name="Instructions 5" tags="" position="711,2704" size="100,100">&lt;center&gt;&lt;i&gt;Using Luck in Battles&lt;/i&gt;&lt;/center&gt;
On certain pages of the book you will be told to &lt;i&gt;Test your Luck&lt;/i&gt; and will be told the consequences of your being lucky or unlucky. However, in battles, you always have the option of using your Luck either to inflict a more serious wound on a creature you have just wounded, or to minimize the effects of a wound the creature has just inflicted on you.
If you have just wounded the creature, you may &lt;i&gt;Test your Luck&lt;/i&gt; as described above. If you are lucky, you have inflicted a severe wound and may subtract an extra 2 points from the creature’s STAMINA score. However, if you are unlucky, the wound was a mere graze and you must restore 1 point to the creature&#39;s STAMINA (i.e. instead of scoring the normal 2 points of damage, you have now scored only 1).
If the creature has just wounded you, you may &lt;i&gt;Test your Luck&lt;/i&gt; to try to minimize the wound. If you are lucky, you have managed to avoid the full damage of the blow. Restore 1 point of STAMINA (i.e. instead of doing 2 points of damage it has done only 1). If you are unlucky, you have taken a more serious blow. Subtract 1 extra STAMINA point.
Remember that you must subtract 1 point from your own LUCK score each time you &lt;i&gt;Test your Luck&lt;/i&gt;.
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 6]]</tw-passagedata><tw-passagedata pid="21" name="Instructions 6" tags="" position="711,2854" size="100,100">&lt;center&gt;&lt;b&gt;Restoring Skill, Stamina and Luck&lt;/b&gt;&lt;/center&gt;
Your SKILL, STAMINA and LUCK scores may change during your adventure. Your SKILL will increase (from ‘Starting SKILL’) if you find a WEAPON.  Your STAMINA will drain as you fight creatures, and may be restored by eating or resting as instructed by the text. Your LUCK will run out as you must deduct one LUCK point each time you &lt;i&gt;Test your Luck&lt;/i&gt;. Occasionally a particularly lucky find or encounter may restore some of your LUCK.
Note that any bonuses you are awarded can never be used to exceed your Initial SKILL, STAMINA and LUCK scores.
[[Return to title screen-&gt;TITLE]] / [[Continue-&gt;Instructions 7]]</tw-passagedata><tw-passagedata pid="22" name="Instructions 7" tags="" position="711,3004" size="100,100">&lt;center&gt;HINTS ON PLAY&lt;/center&gt;
There is one true way through the mysterious world of Orb and it will take you several attempts to find it. Make notes and draw a map as you explore — this map will be invaluable in future adventures and enable you to progress rapidly through to unexplored sections.
Not all areas contain treasure; some merely contain traps and creatures which you will no doubt fall foul of.  You may make wrong turnings during your quest and while you may indeed progress through to your ultimate destination, it is by no means certain that you will find what you are searching for.
It will be realized that entries make no sense if read in numerical order. It is essential that you read only the entries you are instructed to read. Reading other entries will only cause confusion and may lessen the excitement during play.
The one true way involves a minimum of risk and any player, no matter how weak on initial dice rolls, should be able to get through fairly easily.
May the luck of the gods go with you on the adventure ahead!
[[Return to title screen-&gt;TITLE]]</tw-passagedata><tw-passagedata pid="23" name="MOBILE TOGGLE" tags="header" position="252,1689" size="100,100">&amp;hellip;(hidden:)[This element is used to display a toggle button on mobile devices.]
&lt;script&gt;
  var toggle;
  $(document).ready( function() {
	  toggle = $(&#39;tw-include[title=&quot;MOBILE TOGGLE&quot;]&#39;);
	  toggle.click(function() {
		  $(&#39;tw-sidebar&#39;).toggleClass(&#39;open&#39;);
	  });
  });
&lt;/script&gt;</tw-passagedata><tw-passagedata pid="24" name="TEST YOUR LUCK" tags="" position="283,1831" size="100,100">&lt;i&gt;(link-reveal:&quot;Test your Luck&quot;)[{
	(set: _roll to (random: 1,6) + (random: 1,6))
	(if: _roll &gt; $player&#39;s luck)[{
		(dialog: &quot;You rolled  _roll.&quot;, &quot;Unlucky!&quot;)
		($LUCK: -1)(display: &quot;SIDEBAR&quot;)(show: ?unlucky)
	}](if: _roll &lt;= $player&#39;s luck)[{
		(dialog: &quot;You rolled  _roll.&quot;, &quot;Lucky!&quot;)
		($LUCK: -1)(display: &quot;SIDEBAR&quot;)(show: ?lucky)
	}]
}]&lt;/i&gt;</tw-passagedata><tw-passagedata pid="25" name="SET_GENDERS" tags="" position="140,2104" size="100,100">(set: $gender_neutral to (dm:
	&quot;possessive&quot;, &quot;its&quot;,
	&quot;subjective&quot;, &quot;it&quot;,
	&quot;objective&quot;, &quot;it&quot;))
(set: $gender_male to (dm:
	&quot;possessive&quot;, &quot;his&quot;,
	&quot;subjective&quot;, &quot;he&quot;,
	&quot;objective&quot;, &quot;him&quot;))
(set: $gender_female to (dm:
	&quot;possessive&quot;, &quot;her&quot;,
	&quot;subjective&quot;, &quot;she&quot;,
	&quot;objective&quot;, &quot;her&quot;))
(set: $gender_plural to (dm:
	&quot;possessive&quot;, &quot;their&quot;,
	&quot;subjective&quot;, &quot;they&quot;,
	&quot;objective&quot;, &quot;them&quot;))</tw-passagedata><tw-passagedata pid="26" name="SPECIALS" tags="" position="284,2670" size="100,100">&lt;div class=&quot;special&quot;&gt;(if: $keyring contains &quot;Mordana in Abaddon&quot;)[
		&lt;i&gt;(link-rerun:&quot;Mordana in Abaddon&quot;)[{
			(if: (passage:)&#39;s tags contains &quot;mordana&quot;)[
				(show: ?Mordana)
			](else:)[
				(dialog: &quot;This is not the right place.&quot;)
			]
		}]&lt;/i&gt;&lt;br&gt;
	](if: $keyring contains &quot;Cellar Door&quot;)[
		&lt;i&gt;Look for (link-rerun:&quot;secret doors&quot;)[{
			(if: (passage:)&#39;s tags contains &quot;cellardoor&quot;)[
				(show: ?cellardoor)
			](else:)[
				(dialog: &quot;This is not the right place.&quot;)
			]
		}]&lt;/i&gt;?
	]
&lt;/div&gt;</tw-passagedata><tw-passagedata pid="27" name="SAVE" tags="" position="124,2671" size="100,100">{
	&lt;div class=&quot;save&quot;&gt;(link:&quot;Save&quot;)[
		(if:(save-game:&quot;Slot A&quot;))[Game saved!]
		(else: )[Sorry, I couldn&#39;t save your game.]
	]
	(if: (saved-games:) contains &quot;Slot A&quot;)[
		/ (link: &quot;Restore&quot;)[(load-game:&quot;Slot A&quot;)]
	]&lt;/div&gt;
}</tw-passagedata><tw-passagedata pid="28" name="INIT_STATS" tags="" position="96,1822" size="100,100">{(set: $inventory to (ds:))
(set: $weapons to (ds: (dm: &quot;name&quot;, &quot;Sword&quot;, &quot;modifier&quot;, 2)))
(set: $keyring to (ds:))
(set: $monsters to (a:))
(set: $player to (dm:))
(set: $player&#39;s provisions to 10)
(set: $player&#39;s gold to 0)
(set: $player&#39;s torches to 5)
(display:&quot;SET_STATS&quot;)}</tw-passagedata><tw-passagedata pid="29" name="FIGHT" tags="" position="538,1511" size="100,100">&lt;!-- We don&#39;t want to both show and re-run combat on the first run --&gt;
(if: $monsters is not (a:))[{
	|TALLY_MONSTERS&gt;[
		(for: each _monster, ...$monsters) [
			(if: _monster&#39;s stamina &lt;= 0) [
				(set: $monsters to it - (a: _monster))
			]
		]
	]
	|INITIAL_MONSTER_LIST&gt;[
	&lt;ol&gt;
		(rerun:?TALLY_MONSTERS)(hide:?ATTACK_ACTIONS)
		(set: _i to 1)
		(for: each _monster, ...$monsters) [
			(set: _monster&#39;s index to _i)
			&lt;li&gt;(print: _monster&#39;s name)
			&lt;b&gt;SKILL&lt;/b&gt;: (print: _monster&#39;s skill)
			&lt;b&gt;STAMINA&lt;/b&gt;: (print: _monster&#39;s stamina)
			(link: &quot;Attack!&quot;)|ATTACK_OPTION&gt;[
				(set: $target to _monster)
				(hide: ?INITIAL_MONSTER_LIST)
				(show: ?ATTACK)
			]
			(set: _i to it + 1)
		&lt;/li&gt;
	  ]
	&lt;/ol&gt;]
	|MONSTER_LIST)[&lt;ol&gt;
		(rerun:?TALLY_MONSTERS)(hide:?ATTACK_ACTIONS)
		(set: _i to 1)
		(for: each _monster, ...$monsters) [
			(set: _monster&#39;s index to _i)
			&lt;li&gt;(print: _monster&#39;s name)
			&lt;b&gt;SKILL&lt;/b&gt;: (print: _monster&#39;s skill)
			&lt;b&gt;STAMINA&lt;/b&gt;: (print: _monster&#39;s stamina)
			(link: &quot;Attack!&quot;)|ATTACK_OPTION&gt;[
				(set: $target to _monster)
				(hide: ?MONSTER_LIST)
				(rerun: ?ATTACK)
			]
			(set: _i to it + 1)
		&lt;/li&gt;
	  ]
	&lt;/ol&gt;]
	|ATTACK)[
		(rerun: ?TALLY_MONSTERS)
		(show:?ATTACK_RESULTS)
		(set: $combat_stage to &quot;combat&quot;)
		(display: &quot;ATTACK&quot;)
		(show:?ATTACK_ACTIONS)
		(rerun:?ATTACK_ACTIONS)
		(set: $combat_stage to &quot;post-combat&quot;)
		(for: each _monster, ...$monsters) [
			(if: _monster contains &quot;special&quot;)[
				(display: _monster&#39;s special)
			]
		]
	]
	|ATTACK_RESULTS)[]
	|ATTACK_ACTIONS)[
		(rerun: ?TALLY_MONSTERS)
		[
		  (if: $monsters is an empty) [
			  (link-rerun:&#39;&lt;p class=&quot;congratulations&quot;&gt;Congratulations, you won the battle.&lt;/p&gt;&#39;)[(show: ?win)]
		  ] (elseif: $player&#39;s stamina &gt; 0) [
			  (link-rerun:&quot;Combat continues...&quot;)[(display: &quot;ATTACK ACTIONS&quot;)]
		  ] (else:) [
			  Your adventure ends here.
		  ]
		]&lt;ACTION_OPTIONS|
		(set: $combat_stage to &quot;combat-actions&quot;)
		(for: each _monster, ...$monsters) [
			(if: _monster contains &quot;special&quot;)[
				(display: _monster&#39;s special)
			]
		]
	]
}]</tw-passagedata><tw-passagedata pid="30" name="ATTACK" tags="" position="674,1516" size="100,100">(replace:?ATTACK_RESULTS)[{
	&lt;!-- You attack &lt;b&gt;(print: $target&#39;s name)&lt;/b&gt;. --&gt;
	(set: _order to (range: 1, $monsters&#39;s length) - (a: $target&#39;s index))
	(set: _order to (a: $target&#39;s index) + it)
	&lt;ol&gt;
		(for: each _i, ..._order) [
			&lt;li&gt;
				(set: _monster to $monsters&#39;s (_i))
				(set: _player_roll to (random: 1, 6) + (random: 1, 6) + $player&#39;s skill)
				(set: _monster_roll to (random: 1, 6) + (random: 1, 6) + _monster&#39;s skill)
				|CALCULATE_DAMAGE&gt;[
					(if: _player_roll &lt; _monster_roll)[
						($STAMINA: -2)
					] (elseif: _player_roll &gt; _monster_roll) [
						(if: $target&#39;s index is _i) [
							(set: _monster&#39;s stamina to it - 2)
						]
					]
				]
				|DISPLAY_RESULTS&gt;[
					(if: $target&#39;s index is _i) [
				  		You attack &lt;b&gt;(print: _monster&#39;s name)&lt;/b&gt;.
			  		] (else:) [
				  		(print: _monster&#39;s name) attacks.
			  		]
					You roll: (print: _player_roll).
					It rolls: (print: _monster_roll).
					(if: _player_roll is _monster_roll) [
						(if: $target&#39;s index is _i) [
							You dodge each other&#39;s blows.
						] (else:) [
							You parry the attack.
						]
					] (elseif: $target&#39;s index is _i) [
						(if: _player_roll &lt; _monster_roll) [
							It hits! (display: &quot;LUCKY DODGE&quot;)
						] (else:) [
							You hit it!
							(if: _monster&#39;s stamina &gt; 0)[
								(display: &quot;LUCKY STRIKE&quot;) 
							] (else:) [
								The blow is fatal!
							]
						]
					] (else:) [
						(if: _player_roll &lt; _monster_roll) [
							It hits! (display: &quot;LUCKY DODGE&quot;)
						] (else:) [
							You parry the attack.
						]
					]
				]
				(if: _monster contains &quot;special&quot;)[
					(display: _monster&#39;s special)
				]
				(set: $monsters&#39;s (_i) to _monster)
			&lt;/li&gt;
		]
	&lt;/ol&gt;
	|CHECK_DEATHS&gt;[
		(if: $player&#39;s stamina &lt;= 0) [
			Your wounds are fatal.
			(rerun:?ATTACK_ACTIONS)
		]
		(for: each _monster, ...$monsters)[
			(if: _monster&#39;s stamina &lt;= 0) [
				(print: _monster&#39;s name) has fallen.
				(rerun:?ATTACK_ACTIONS)
			]
		]
	]
}]</tw-passagedata><tw-passagedata pid="31" name="LUCKY DODGE" tags="" position="574,1648" size="100,100">(link: &quot;Test your luck?&quot;)[{
	(set: _roll to (random: 1, 6) + (random: 1, 6))
	(if: _roll &lt;= $player&#39;s luck) [
		Lucky dodge! Restore 1 STAMINA.
		($STAMINA: 1)
		(rerun: ?ATTACK_ACTIONS)
	] (else:) [
		Failed to dodge! 1 additional damage.
		($STAMINA: -1)
	]
	($LUCK: -1)
	(rerun: ?CHECK_DEATHS)
}]&lt;testyourluck|</tw-passagedata><tw-passagedata pid="32" name="LUCKY STRIKE" tags="" position="710,1646" size="100,100">(link: &quot;Test your luck?&quot;)[{
	(set: _roll to (random: 1, 6) + (random: 1, 6))
	(if: _roll &lt;= $player&#39;s luck) [
		&lt;i&gt;Lucky strike!&lt;/i&gt; 2 additional damage.
		(set: _monster&#39;s stamina to it - 2)
		(if: _monster&#39;s stamina &lt;= 0) [
			The blow is fatal.
		]
	] (else:) [
		&lt;i&gt;Grazed!&lt;/i&gt; 1 less damage.
		(set: _monster&#39;s stamina to it + 1)
	]
	(set: $monsters&#39;s (_i) to _monster)
	($LUCK: -1)
	(rerun: ?CHECK_DEATHS)
}]&lt;testyourluck|</tw-passagedata><tw-passagedata pid="33" name="Intro 2" tags="" position="1324,1469" size="100,100">&#39;Welcome, Champion of Fate. Do not be dismayed, you are not yet in danger.&#39;
&#39;Where am I?&#39; you ask, feeling as if you are in a dream.
&#39;Far, far from your home, I fear to say. This is the world of Orb and you are in the Garden of the Gods.&#39;
&#39;What is Orb?&#39; you demand.
&#39;You will find it most strange and full of wonder, for it is very different from Earth. Men must share it not just with talking creatures such as I but with weird and fell monsters, giants, dragons and demons. There are warlocks and sorcerers, too, great wielders of magic, in the cities. But do not fear, you have been chosen to be our champion, for you are more likely to succeed than any other on Earth. Now I must complete my task. Come, my masters bid you join them in the chamber below. Please [[follow me-&gt;Intro 3]].&#39;</tw-passagedata><tw-passagedata pid="34" name="Intro 3" tags="" position="1494,1466" size="100,100">With that the golden songbird flutters away down a spiral staircase. Shaking your head in confusion you descend the stone steps into a large circular room where two beings turn towards you. &#39;Welcome,&#39; says one, a pale female figure enfolded in a swirling robe of many colours above which you can only see a perfectly smooth and hairless head. The robe shimmers, its colours shifting as she steps towards you, catching your mind before you realize what is happening. Looking into her face, you see an image of yourself, fighting for your life inside a huge temple. Then the image shifts and you see yourself leaving a walled city, hastening alone across a desolate moor, only to find yourself deep in a jungle, surrounded by devils with blue skins. Your nape bristles as you realize that she is revealing glimpses of your destiny. It is only when they are over that you notice she has no eyes in her smooth pale face.
The other figure changes even as you look at him.  At one moment he is an ancient white-haired man, heavy with knowledge, at another an infant, wise beyond his years. The metamorphosis through youth to age takes but a few instants, yet flows so smoothly you cannot see the features change. His voice is soft and ageless. &#39;We have summoned you here to the world of Orb because we wish to prevent a fatal upset in the balance of nature. The cosmic scales have been tipped too far and you must play a part in righting them. It is not for us in the Garden of the Gods to set things right. We cannot fight him who would bring chaos to Orb. Rather we use men as our tools. I shall not say whether you will [[succeed-&gt;Intro 4]].</tw-passagedata><tw-passagedata pid="35" name="Intro 4" tags="" position="1664,1474" size="100,100">The floor of the room upon which you are standing is the most realistic and detailed map imaginable. You can even see small figures tilling the fields and walking the streets of an entire world; a world of pinnacled castles; knights on horseback, their men-at-arms bearing banners which stream in the wind; and strange high-walled cities with towers and spires, concealing the dives of assassins and thieves amongst the splendour. The eyeless immortal steps forward, her robe now the colour of the deep sea, and caresses your cheek.
&#39;We are sending you down to the surface of Orb. If you fall into the clutches of Death we cannot aid you. Do not fail us!&#39;
&#39;Fail in what?&#39; you begin to ask. But just then, to your horror, you find yourself being drawn inexorably towards a black crack in the map. The realization thatyour destiny is being tampered with angers you, and you resolve to find a wayback to Earth and your home at any cost. As the world of Orb rises up to engulf you, the awesomeness of what is happening overwhelms you and [[you lose consciousness-&gt;Page 1]].</tw-passagedata><tw-passagedata pid="36" name="Page 17" tags="" position="1515,2013" size="100,100">As you dash towards the forbidding blackness of the archway, you hear a click followed by a rumbling sound ahead. The floor beneath your feet begins to tremble. Do you want to [[hurl yourself through the archway-&gt;Page 41]], into the darkness, or [[stop your headlong flight-&gt;Page 21]]?</tw-passagedata><tw-passagedata pid="37" name="Page 30" tags="" position="1797,2116" size="100,100">The footsteps are coming closer; suddenly, a sound like a clap of thunder reverberates around the chamber. You look round and see that both the archways have been sealed by huge stone blocks.  You are [[trapped-&gt;Page 13]].</tw-passagedata><tw-passagedata pid="38" name="Page 41" tags="" position="1440,2163" size="100,100">Before you can charge through the archway a slab of smooth rock slams down from above, with a sound like a clap of thunder that reverberates around the cavern. It blocks the archway completely. Unfortunately you cannot stop in mid-leap; you crash sickeningly into the stone with bone-jarring force. Lose 2 STAMINA points. ($STAMINA: -2)Feeling somewhat groggy, you pick yourself up and realize that the other archway is similarly sealed. Seeing you have no option you turn to face the oncoming footsteps and [[draw your sword-&gt;Page 13]].</tw-passagedata><tw-passagedata pid="39" name="Page 21" tags="" position="1590,2163" size="100,100">You stop just in time - a slab of smooth rock slams down from above with a crash that reverberates around the cavern. It blocks the arch completely. The other one is similarly sealed. Realizing that you have no choice, you turn to face the oncoming footsteps and [[draw your sword-&gt;Page 13]].</tw-passagedata><tw-passagedata pid="40" name="Page 13" tags="" position="1587,2378" size="100,100">A woman wearing chainmail and carrying a loaded crossbow bursts into the torchlight ahead of you. Seeing you, she immediately points the bow in your direction. Three men, panting heavily, appear behind her. The first, a tall and handsome man, is dressed in shining silver armour and the blade of his two-handed sword glows with a faint white radiance. The next is dressed in a flowing robe of cloth-of-gold and wears a smiling golden mask. He carries an ivory staff. The last is a thick-set man with a white surcoat over chainmail. A red cross adorns his breast and a spiked mace hangs at his side. They stop. Once agaìn you hear a wailing, louder than before. &#39;They are almost upon us,&#39; cries the man with the glittering sword. The Shieldmaiden calls to you, &#39;Who are you and what are you doing here in the Rift, the spawning place of all evil?&#39; Will you:
&lt;ul&gt;
&lt;li&gt;Say you have come from [[another world-&gt;Page 247]]?&lt;/li&gt;
&lt;li&gt;Say that you are on a [[quest against evil-&gt;Page 60]]?&lt;/li&gt;
&lt;li&gt;Try to [[play for time-&gt;Page 75]]?&lt;/li&gt;
&lt;li&gt;[[Attack the Shieldmaiden-&gt;Page 5]]?&lt;/li&gt;</tw-passagedata><tw-passagedata pid="41" name="Page 247" tags="" position="1362,2528" size="100,100">Her eyebrows rise in surprise. All four of them look at you in disbelief. The man in gold turns to the Priest in the white surcoat and asks, &#39;Is it the truth?&#39;  Knowing your story to be true, you decide to wait while the Priest casts a spell. &#39;It is the truth,&#39; he says, &#39;and spoken from a true heart.&#39; The Shieldmaiden lowers the bow and moves over to guard the entrance of the cavern.  &#39;What are we to do? The exits are blocked and I have only the power to teleport one of us out now,&#39; says the man in gold. &#39;Perhaps this warrior has been sent by the gods to continue the quest.&#39; Sensing the goodness in these people, you wait to hear how you can [[aid them-&gt;Page 100]]. </tw-passagedata><tw-passagedata pid="42" name="Page 60" tags="" position="1519,2521" size="100,100">&#39;Alone?&#39; asks the Shieldmaiden in disbelief. The man in gold turns to the Priest. &#39;Is it true?&#39; he asks.  Knowing your story to be a lie you wait anxiously while the Priest casts a spell. &#39;It is a lie,&#39; says the Priest. The Shieldmaiden turns to you accusingly. &#39;Why are you lying to us? I ask you again, who are you and what are you doing here?&#39; Will you [[tell them the truth-&gt;Page 70]], or ask them [[what business it ís of theirs-&gt;Page 75]]?</tw-passagedata><tw-passagedata pid="43" name="Page 75" tags="" position="1679,2674" size="100,100">We have no time to dally with the likes of you,&#39; says the man in gold. Turning to his companions, he continues. &#39;What are we to do? The exits are blocked and I have only enough power to teleport one of us out now.&#39;
The man with the glittering sword, a Paladin, says gravely, &#39;Then we will die together, Wizard, and they will pay dearly.&#39;
&#39;But what of the Talisman?&#39; asks the Priest. &#39;Perhaps we can use this warrior to continue the quest.&#39; He steps forward and, before you can act, casts a spell. You feel a trance coming over you - the man has hypnotized you - and you [[tell them everything-&gt;Page 100]]. Lose 1 LUCK point. ($LUCK: -1)</tw-passagedata><tw-passagedata pid="44" name="Page 5" tags="" position="1799,2411" size="100,100">You charge at the Shieldmaiden. She coolly takes aim and unleashes a crossbow bolt. It slams into the shoulder of your sword-arm, crippling it with a searing pain. Lose 1 SKILL point and 2 STAMINA points.($SKILL:-1)($STAMINA:-2) As you fall, the Shieldmaiden places her sword at your throat. &#39;Don&#39;t make a move if you wish to [[live-&gt;Page 75]],&#39; she says.</tw-passagedata><tw-passagedata pid="45" name="Page 100" tags="" position="1452,2849" size="100,100">The Priest steps towards you and tells you this story. &#39;Long ago the minions of the God Death, in the City of the Runes of Doom, fashioned a Talisman that would allow them, if the time was right, to summon their God to the surface of this world. That time has now come. If Death is summoned all life will cease. Only Death&#39;s minions will continue to exist in an awful half-life. His presence will spread like a grey shadow across the world of Orb. Everything will turn to dust and the balance of nature will be disrupted for ever. The Loremasters of Serakub, a group of holy people, have striven to prevent this. They sent a group of Crusaders, of which we four alone survive, on a quest to steal the Talisman. The Fleshless King of the minions of Death had sent the Talisman to the depths of the Rift for safe-keeping.  We have entered this pit of evil and seized it.&#39; He pulls a necklace out from under his surcoat. On it hangs a disc of obsidian,in the middle of which is a skull carved in ruby - the Talisman of Death! He hands it to you.($add_item: &quot;Talisman of Death&quot;) &#39;Here. For the sake of all Orb you must take this Talisman and continue the quest. It cannot be destroyed, but if you can take it to your world, it will be beyond the reach of the claw of the Fleshless King.&#39;
You are impressed by the courage and unselfish fortitude of these people and resolve to continue the quest. You take the Talisman. It feels cold and heavy around your neck. The Wizard turns to you and says, &#39;I am going to use the powers of magic to transport you to the surface. Head west until you come to the city of learning, Greyguilds-on-the-Moor, where you may discover a way to return to your own world. Do not fail us! Here, take this gold, it may be of use.&#39; He gives you a purse with 10 gold pieces in it. ($GOLD: 10)As the Wizard prepares his spell, a [[horde of creatures-&gt;Page 125]] boils into the cavern.</tw-passagedata><tw-passagedata pid="46" name="Page 70" tags="" position="1512,2666" size="100,100">Her eyebrows rise in surprise. All four of them look at you doubtfully. The Priest pauses, then says, &#39;It is the truth and spoken from a true heart.&#39; The Shieldmaiden lowers the bow and turns to guard the entrance of the cavern.
&#39;What are we to do? The exits are blocked and I only have enough power to teleport one of us out now,&#39; asks the man in gold.
The man with the glittering sword, a Paladin, says gravely, &#39;Then we will die together, Wizard, and they will pay dearly.&#39;
&#39;But what of the Talisman?&#39; asks the Priest. &#39;Perhaps this warrior has been sent by the gods to continue the quest?&#39; Sensing the goodness in these people you wait to hear how you can [[aid them-&gt;Page 100]].</tw-passagedata><tw-passagedata pid="47" name="Page 125" tags="" position="1452,2999" size="100,100">Dark Elves and Cave Trolls are pouring into the cavern, attacking the Shieldmaiden. As the Paladin and Priest rush to her aid, you see a huge shadowy form looming behind the sea of Elves and Trolls. The Paladin&#39;s glittering sword cuts through the horde but the Dark Elves are using magic and the Shieldmaiden is unable to turn back their attack. She falls beneath their onslaught. The huge fiend howls triumphantly, just as the wizard [[completes his spell-&gt;Page 185]].</tw-passagedata><tw-passagedata pid="48" name="Page 185" tags="" position="1536,3182" size="100,100">Suddenly, you are in blinding sunshine. You are standing at the lip of an immense chasm. You realize that this must be the Rift the Crusaders spoke of. The rocky earth is blackened and cracked, full of pits and fissures, and noisome fumes rise from the depths of the chasm. To the west you see a range of green hills partially covered in trees and thick woodland. A few hundred metres to your right you can see where a forest begins, extending all the way to the hills. You realize that you must head in the direction of the hills to reach Greyguilds - but which route will you take?  Will you go [[through the forest-&gt;Page 256]], or would you rather take the more direct route across [[open ground-&gt;Page 134]]?</tw-passagedata><tw-passagedata pid="49" name="Page 256" tags="" position="988,3236" size="100,100">You enter the green, gloomy shade of the woods. After a while, you stumble into a clearing and stop in surprise at the sight that greets you. A huge, white SHE-WOLF, almost as large as a pony, is suckling two cubs. She pushes them aside and crouches, snarling. Will you:
&lt;ul&gt;
&lt;li&gt;[[Back off-&gt;Page 218]] and leave?&lt;/li&gt;
&lt;li&gt;Offer the wolf some [[dried meat-&gt;Page 52]]?&lt;/li&gt;
&lt;li&gt;[[Attack-&gt;Page 232]] her?&lt;/li&gt;
&lt;/ul&gt;
</tw-passagedata><tw-passagedata pid="50" name="Page 134" tags="" position="2294,3031" size="100,100">You set off across the rocky broken ground towards the hills. After a short while you notice two armed bands running towards you. The group to the south consists of twenty or more Orcs, snarling as they lope purposefully towards you. They are hunched and misshapen, dressed in greasy, blackened leather and carrying saw-toothed scimitars. Their shields are emblazoned with a purple claw. To the north, you can make out a small group of Dark Elves, similar to those which killed the Shieldmaiden. They are tall and lithe, wearing ornately spiked armour and carrying longswords of a dull black metal. They are some way off but are closing fast. Will you:
&lt;ul&gt;
	&lt;li&gt;Head for the [[Orcs-&gt;Page 68]]?&lt;/li&gt;
	&lt;li&gt;Head for the [[Elves-&gt;Page 214]]?&lt;/li&gt;
	&lt;li&gt;Run for the [[hills-&gt;Page 63]]?&lt;/li&gt;
	&lt;li&gt;[[Hide-&gt;Page 148]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="51" name="Page 218" tags="" position="938,3386" size="100,100">Hastily, you leave the clearing. Luckily, it seems she was interested only in protecting her cubs.  You press on [[through the wood-&gt;Page 159]] towards the hills, skirting the clearing.</tw-passagedata><tw-passagedata pid="52" name="Page 52" tags="" position="1103,3375" size="100,100">Cross one of your Provisions off your Adventure Sheet. ($PROVISIONS: -1)Crouching on one knee, you toss the dried meat to the wolf, speaking in soothing tones as you do so. The wolf accepts your gift. Then a green-robed figure steps into the clearing. He has an oak staff in one hand and a silver sickle in the other. A crown of mistletoe rests on his head. He smiles at you and says, &#39;My name is Wodeman. I am the Guardian Druid of this Sacred Grove. My friend, Snowmane, thanks you for the gift of food. Such gentle generosity deserves reward. The Blessing of the Druids wil1 go with you. May fortune smile on you.&#39; You gain 1 LUCK point for the Druid&#39;s Blessing. ($LUCK: 1)&#39;You look weary,&#39; he says. &#39;Here, have this.&#39; He takes a golden apple from his robes and hands it to you.  Note it down on your Adventure Sheet - such apples are wonderfully refreshing and will restore up to 4 STAMINA points when you eat one. You thank him, and knowing you must continue on your quest, reluctantly [[leave-&gt;Page 159]] the idyllic peace of the Sacred Grove.($add_item: &quot;Golden Apple&quot;)</tw-passagedata><tw-passagedata pid="53" name="Page 232" tags="" position="771,3378" size="100,100">Drawing your sword, you run forward to attack.
[(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;WHITE SHE-WOLF&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 9
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you win, [[click here-&gt;Page 199]].]</tw-passagedata><tw-passagedata pid="54" name="PROVISIONS" tags="" position="178,2893" size="100,100">&lt;li&gt;(link-rerun:&quot;Provisions&quot;)[{
	(if: $monsters is an empty and $player&#39;s stamina &lt; $player&#39;s max_stamina)[
		($STAMINA: 4)
		($PROVISIONS: -1)
		(rerun:?INVENTORY)
	](else:)[
	  	(if: $monsters is not an empty)[
			(dialog: &quot;You can&#39;t stop to eat provisions in combat!&quot;)
	  	]
	  	(if: $player&#39;s stamina &gt;= $player&#39;s max_stamina)[
		  	(dialog: &quot;You&#39;re already at full STAMINA.&quot;)
		]
	]
}] x (print: $player&#39;s provisions)&lt;/li&gt;</tw-passagedata><tw-passagedata pid="55" name="Page 159" tags="" position="1004,3680" size="100,100">You force through heavy undergrowth for some time, making your way over the hill and into the thick, wooded valley on the other side. You then take a trail heading westand are making good speed until, rounding a corner, you see a huge brown-scaled lizard with eight legs, basking in the sun. Its heavy horned jaw is filled with long pointed teeth. You may (display: &quot;TEST YOUR LUCK&quot;) to see if you can slip past without waking it. If you prefer not to take this risk you can [[leave the path-&gt;Page 384]] to cut a way through the undergrowth. 
|lucky)[(goto: &quot;Page 267&quot;)]|unlucky)[(goto: &quot;Page 135&quot;)]
(hidden:)[ [[Page 267]] [[Page 135]] ]</tw-passagedata><tw-passagedata pid="56" name="Page 199" tags="" position="767,3516" size="100,100">As you are looking around you, checking that there is no mate near by to avenge her death, a green robed figure appears in the centre of the clearing, as if by magic. He has an oak staff in one hand and a silver sickle in the other. A crown of mistletoe rests on his head. Striking the ground with his staff, he says, &#39;I am the Guardian Druid of this Sacred Grove and you have slain my friend, Snowmane, and left her cubs motherless. May the hand that killed her never be still.&#39; You feel a tremor running down your arm - your sword-hand begins to shake. Lose 1 SKILL point for the Druid&#39;s curse.($SKILL: -1) Do you [[attack the Druid-&gt;Page 177]] in order to force him to lift the curse? If you decide not to risk further dealings with this man, you may [[leave the clearing-&gt;Page 159]].</tw-passagedata><tw-passagedata pid="57" name="Page 177" tags="" position="599,3681" size="100,100">You charge at the Druid, your sword raised. Before you can strike, your jaw drops in amazement. Where once there was a man carrying an oak staff, there is now a skylark. Trilling shrilly, it flies around you and away. After a few minutes you see the skylark wheeling above you again. It could be trying to draw attention to you, or perhaps it is preparing to attack you itself. Do you now wish to [[leave the clearing-&gt;Page 187]], or [[stay and hide-&gt;Page 147]]?</tw-passagedata><tw-passagedata pid="58" name="Page 187" tags="" position="777,3636" size="100,100">You [[leave the clearing-&gt;Page 159]], anxious that you should not anger the Druid further by staying in the Sacred Grove.</tw-passagedata><tw-passagedata pid="59" name="Page 147" tags="death" position="741,3909" size="100,100">You hide in the middle of a clump of bushes and peer out into the clearing. After a while, the Druid reappears in front of you. &#39;Since you have chosen to further defile the Sacred Grove by remaining here, I shall assume you have no wish to leave.&#39; Before you can move, he utters some strange words and the bushes begin to grow around you. The leafy tendrils which wrap themselves around your limbs are surprisingly tough. You are held fast. You plead with him to free you but to no avail. After three days without water you slip from delirium into a coma, from which you never recover. </tw-passagedata><tw-passagedata pid="60" name="GOLDEN APPLE" tags="" position="302,2900" size="100,100">&lt;li&gt;(link-rerun:&quot;Golden Apple&quot;)[{
	(if: $monsters is an empty and $player&#39;s stamina &lt; $player&#39;s max_stamina)[
		($STAMINA: 4)
		($remove_item: &quot;Golden Apple&quot;)
		(rerun:?INVENTORY)
	](else:)[
	  	(if: $monsters is not an empty)[
			(dialog: &quot;You can&#39;t stop to eat during combat!&quot;)
	  	]
	  	(if: $player&#39;s stamina &gt;= $player&#39;s max_stamina)[
		  	(dialog: &quot;You&#39;re already at full STAMINA.&quot;)
		]
	]
}]&lt;/li&gt;</tw-passagedata><tw-passagedata pid="61" name="Page 384" tags="" position="1309,3831" size="100,100">You hack your way through the undergrowth but dense thorn bushes make progress slow and difficult. You are soon panting for breath, and exertion has made you hungry. You must eat - cross one Provision off your Adventure Sheet. ($PROVISIONS: -1)You do not gain any STAMINA from this meal. You [[battle on-&gt;Page 65]].</tw-passagedata><tw-passagedata pid="62" name="Page 267" tags="" position="891,3831" size="100,100">Creeping stealthily, you barely rustle the dried leaves underfoot. The soporific BASILISK does not even notice you, which is just as well. Its eyes flicker open for a moment and a small mouse which happens to be running across its line of vision slows and turns to stone. You hurry quickly [[on your way-&gt;Page 270]], lest you suffer the same fate.</tw-passagedata><tw-passagedata pid="63" name="Page 135" tags="" position="1154,3830" size="100,100">Treading on some dry leaves, you are unlucky to snap a hidden twig. As the BASILISK turns its gaze upon you, your body grows heavy. You fling yourself into the undergrowth as your skin begins to turn a stony grey colour. You have just avoided being turned to stone by the reptile&#39;s gaze, but the effects of partial petrification have damaged your muscle fibres. Lose 1 SKILL point. ($SKILL: -1)Hastily, you cut a path through the undergrowth and leave the sluggish but deadly monster behind, rejoining the path [[further on-&gt;Page 270]].</tw-passagedata><tw-passagedata pid="64" name="Page 270" tags="" position="1061,3991" size="100,100">The trail winds between the spurs of two hills and plunges down into a moist and mossy dell. At the bottom, a large dew pond, covered with algae, is shaded by the boughs of a horse-chestnut tree. Your attention is caught by a weak cry. An old woman is up to her neck in the middle of the pool. Her matted hair is streaked green with the scum of the pool. &#39;I&#39;m drowning! Help me, I&#39;m tangled in the weeds!&#39; she begs piteously. Do you decide to [[help her-&gt;Page 230]], or [[ignore her-&gt;Page 65]] and hurry on?</tw-passagedata><tw-passagedata pid="65" name="Page 230" tags="monster" position="922,4076" size="100,100">You wade carefully into the scum-covered pond and hold out your hand to the old woman. There is a sudden churning in the water and slimy tentacles slither around your thighs. The old woman&#39;s head rears up at you, revealing a huge, horny beak where her chest should have been, above a bloated body, sprouting six tentacles. You must fight the GRENDEL.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;GRENDEL&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 9
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you win, [[click here-&gt;Page 65]].]</tw-passagedata><tw-passagedata pid="66" name="Page 65" tags="" position="1266,4160" size="100,100">Eventually, the hills give way to a desolate grey moor stretching out to the west. After half an hour or so, you see a cloud of dust ahead. You can soon make out a group of twenty horsemen. They wheel their steeds towards you and the drumming of hoofs carries to you over the breeze. As they get nearer, you can see that this is a band of warrior women, clad in chainmail and studded leather armour. Their faces look grim and unwelcoming as they wheel around you, forming a closed circle. Their Captain spurs her horse forward and tersely demands what you are doing out here, alone on the edge of the moor. Will you:
&lt;ol&gt;
&lt;li&gt;Tell them about your [[quest-&gt;Page 101]]?&lt;/li&gt;
&lt;li&gt;Say that you are from [[another world-&gt;Page 73]]?&lt;/li&gt;
&lt;li&gt;Tell them that you are the last survivor of an [[ambushed caravan-&gt;Page 322]]?&lt;/li&gt;
&lt;li&gt;Pretend that you are [[deaf and dumb-&gt;Page 35]]?&lt;/li&gt;
&lt;li&gt;Demand they [[escort you-&gt;Page 95]] to Greyguilds-on-the-Moor?&lt;/li&gt;
&lt;/ol&gt;</tw-passagedata><tw-passagedata pid="67" name="Page 101" tags="" position="1016,4550" size="100,100">The Captain and other members of the patrol start to laugh at you. She throws her head back with her hands on her hips and stares at you. &#39;Give me your sword and climb up behind Elvira here.&#39; She points to one of the younger women. &#39;We must take you back to Greyguilds.&#39; Will you [[hand your sword to her-&gt;Page 155]], or [[refuse to give it up-&gt;Page 142]]?</tw-passagedata><tw-passagedata pid="68" name="Page 73" tags="" position="1239,4550" size="100,100">The Captain&#39;s brow furrows as you tell your story. There is some muttering from her companions, which she silences with a quick gesture. &#39;We must take you to Hawkana, in Greyguilds. She will want to speak with you. Climb up behind Elvira here, and give me your sword.&#39; She points to one of the younger women.  Will you [[hand over your sword-&gt;Page 155]] and get on the horse, or [[refuse-&gt;Page 142]], saying that you would rather make your own way?</tw-passagedata><tw-passagedata pid="69" name="Page 322" tags="" position="1939,4535" size="100,100">&#39;Where did the caravan come from - the Spires of Foreshadowing, perhaps?&#39; demands the Captain of the patrol. Where will you say it came from?
&lt;ol&gt;
&lt;li&gt;[[The Spires-&gt;Page 173]]&lt;/li&gt;
&lt;li&gt;[[The City of the Runes of Doom-&gt;Page 123]]&lt;/li&gt;
&lt;li&gt;[[Serakub-&gt;Page 191]]&lt;/li&gt;
&lt;/ol&gt;</tw-passagedata><tw-passagedata pid="70" name="Page 35" tags="" position="1648,4550" size="100,100">You make some unintelligible signs and grunts, pointing to your mouth and ears. For a moment some of them think that you are casting a spell and draw their swords, but soon you hear one of them saying, &#39;A deaf warrior - well, there&#39;s a turn-up for the scrolls!&#39; The Captain motions you to mount behind one of the younger women, Elvira, who does not seem pleased at having to share her horse with:you. You ride for some time and after a while the women resume their normal conversation. You realize they are members of the Watch, or law-enforcers from Greyguilds-on-the-Moor. You also realize that there is rivalry between them and the Priestesses of the All-Mother in that city. lt appears that the leniency of the Priestesses has [[annoyed them-&gt;Page 197]].</tw-passagedata><tw-passagedata pid="71" name="Page 95" tags="" position="1389,4542" size="100,100">The Captain sneers at you and says sarcastically, &#39;Why yes, mighty warrior, we shall be glad to do as you ask. You shall dine with our leader, Hawkana, tonight. Mount yourself behind Elvira here,&#39; she says, pointing at one of the younger women. The women begin to chuckle and then the Captain says, &#39;But first we must take [[your weapon-&gt;Page 142]].&#39;</tw-passagedata><tw-passagedata pid="72" name="Page 155" tags="" position="1021,4769" size="100,100">Elvira helps you up behind her. She appears none too pleased at the prospect of sharing her horse with you and you ride in silence across the wilderness. Lose 2 SKILL points until you acquire [[another sword-&gt;Page 257]].($lose_weapon:)</tw-passagedata><tw-passagedata pid="73" name="Page 142" tags="" position="1264,4825" size="100,100">At a command from the Captain, the circle of horses closes in on you. You draw your sword and manage to wound one of the women before you are attacked from all sides. They are strong fighters and use the flat blades of their swords to stun you. You drop your sword and fall to the ground. ($lose_weapon:)Lose 2 SKILL points. When you acquire another sword, you may restore them. There are too many warriors to resist, so you decide to do as you are told for a while and accept a helping hand on to Elvira&#39;s horse. She does not look too pleased that you are going to sit behind her all the way to Greyguilds. You console yourself with the thought that at least you are going in the right [[direction-&gt;Page 257]].</tw-passagedata><tw-passagedata pid="74" name="Page 197" tags="" position="1582,4687" size="100,100">Suddenly, from behind you, the Captain shouts, &#39;Look out! Ambush! Everybody duck!&#39; You hear the sound of an arrow whistling through the air as Elvira ducks in front of you. Will you [[duck-&gt;Page 240]] or wait to [[see what happens-&gt;Page 224]]?</tw-passagedata><tw-passagedata pid="75" name="Page 173" tags="" position="1763,4682" size="100,100">&#39;Impossible,&#39; snaps the Captain, &#39;The Spires lie to the west of Greyguilds and you are going towards it not coming away from it. [[You are under arrest.-&gt;Page 152]]&#39;</tw-passagedata><tw-passagedata pid="76" name="Page 123" tags="" position="1956,4722" size="100,100">The arrogance of the warrior-women is ruffled at your mention of the City of the Runes of Doom. The Captain hesitates, narrowing her eyes. There is a flicker of fear in the eyes of some of the younger women. The Captain clears her throat and says, &#39;We must take you to Hawkana, Marshal of the Watch at [[Greyguilds-&gt;Page 152]].&#39;</tw-passagedata><tw-passagedata pid="77" name="Page 191" tags="" position="2092,4710" size="100,100">The Captain nods and says, &#39;We will escort you safely to Greyguilds. These moors are well-known for brigands. Perhaps you would like to ride behind Elvira here.&#39; She points to one of the younger women. You thank her and accept a helping hand up, thankful to rest your legs. Elvira does not seem too pleased at having to share her horse with you and you ride across the wilderness in [[silence-&gt;Page 268]].</tw-passagedata><tw-passagedata pid="78" name="Page 257" tags="" position="1169,5002" size="100,100">You ride on into the late afternoon, moving from the wilderness to a grey and desolate moor. Ahead you can see the walls of a large city. A salute is given as you approach the huge arched gate in the fortified wall. The Captain details half her patrol to remain on guard at the gate. Turning to you she says, &#39;We are taking you to Hawkana - she will want to ask you some questions.&#39; Do you want to seize the first opportunity to [[fight your way out-&gt;Page 318]], or go quietly and [[see what happens-&gt;Page 334]]?</tw-passagedata><tw-passagedata pid="79" name="Page 240" tags="" position="1399,4967" size="100,100">You duck and hear the sound of an arrow embedding itself in a tree some way off. &#39;Oh ho!&#39; you hear the Captain crow. &#39;Suddenly regained our sense of hearing, have we? A truly miraculous recovery.&#39; She shouts a command and Elvira twists in the saddle and throws you to the ground. Landing on top of you, she knocks the breath out of you and overpowers you. Your hands are tied behind your back and your sword is taken. From now on you must fight with your dagger. Lose 2 SKILL points. When you acquire another sword you may restore them.  [[Continue-&gt;Page 257]].</tw-passagedata><tw-passagedata pid="80" name="Page 224" tags="" position="1581,4964" size="100,100">Realizing that the whole thing was a trick designed to test you, you make no move and the arrow, fired by one of the women, thuds harmlessly into a tree. They now believe that you are truly deaf and dumb. You ride on into the late afternoon, moving from the wilderness to a grey and desolate moor. Ahead you can see the walls of a large city. A salute is given as you approach the huge arched gate in the fortified wall. The Captain gestures to you to dismount and waves you into Greyguìlds itself. Thankful for your escort, you wave farewell and set out to discover if there is any way of returning to [[Earth-&gt;Page 296]].</tw-passagedata><tw-passagedata pid="81" name="Page 296" tags="" position="1668,5160" size="100,100">You walk into the city along a street called Moorgate. Many of the buildings are quite grand, built of light grey stone. The streets are crowded with a mixture of people shopping and young men and women carrying books and scrolls. Will you walk down a continuation of Moorgate, called [[Store Street-&gt;Page 357]], or turn left into [[Smith Street-&gt;Page 303]]?</tw-passagedata><tw-passagedata pid="82" name="Page 268" tags="" position="1879,5019" size="100,100">You ride on into the late afternoon, moving from the wilderness to a grey and desolate moor. Ahead you can see the walls of a large city. A salute is given as you approach the huge arched gate in the fortified wall. The Captain tells you to dismount and [[sends you on your way-&gt;Page 296]].</tw-passagedata><tw-passagedata pid="83" name="Page 152" tags="" position="1736,4840" size="100,100">The Captain of the patrol demands that you surrender your sword, and says, &#39;Climb up behind Elvira there.&#39; She points to one of the younger women. Will you [[obey-&gt;Page 155]], or [[refuse-&gt;Page 142]]?</tw-passagedata><tw-passagedata pid="84" name="Page 318" tags="" position="1316,5130" size="100,100">Still seated behind Elvira, you are riding into the City of Learning, Greyguilds, along a street called Moorgate. Many of the buildings are quite grand, built of a light grey stone. You see a mixture of people. There are men wearing light blue togas who are Sages and professors from the Guilds of Learning. Other groups of young men and women are carrying books and scrolls. There are eight of the warrior-women still with you. Will you jump down and try to [[fight your way free-&gt;Page 362]], or change your mind and [[go quietly-&gt;Page 351]] to meet Hawkana?</tw-passagedata><tw-passagedata pid="85" name="Page 334" tags="" position="919,5277" size="100,100">You ride into the City of Learning, Greyguilds, along a street called Moorgate. Many of the buildings are quite grand, built of light grey stone. You see a mixture of people in the streets. There are some men wearing light blue togas who are Sages and professors from the Guilds of Learning. Other groups of young men and women are carrying books and scrolls.  You realize that, unarmed as you are, you are no match for these women and have no alternative but to [[go with them-&gt;Page 351]].</tw-passagedata><tw-passagedata pid="86" name="Page 68" tags="death" position="1941,3180" size="100,100">You run across the rough ground towards the Orcs, drawing your sword. Unfortunately, as you close with them their Captain, a huge and hulking Orc with yellowed tusks, crashes into you. You grab him but lose your balance and topple over the edge of the chasm. You fall for what seems like an eternity. At least you won&#39;t die alone.</tw-passagedata><tw-passagedata pid="87" name="Page 214" tags="death" position="2091,3180" size="100,100">As you close with the Elves, one of them makes a strange gesture. You realize with horror that he is using magic. A drowsy paralysis seizes your limbs and you are unable to move. Laughing cruelly, they bind you hand and foot. You are to be taken down into the Rift and you will never see daylight again. Your quest ends here.</tw-passagedata><tw-passagedata pid="88" name="Page 63" tags="" position="2274,3181" size="100,100">You run as fast you can along the rocky ground. Your lungs are burning with the effort. As you approach the hills, you look back and see that both groups are now roughly the same distance behind you. The Elves coming from the north are in a tight pack, while the Orcs to the south are beginning to string out. Will you:
&lt;ul&gt;
&lt;li&gt;Head north to meet the [[Elves-&gt;Page 214]]?&lt;/li&gt;
&lt;li&gt;Climb a hill to the south, to face the [[Orcs-&gt;Page 282]]?&lt;/li&gt;
&lt;li&gt;[[Run on-&gt;Page 227]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="89" name="Page 148" tags="" position="2563,3238" size="100,100">You dart down a gully and conceal yourself as best you can in a crack in the rock that reeks of sulphur, hoping that the stream of pebbles you dislodged will not give you away. Soon you can hear the ominous sounds of snuffling as the Orcs try to sniff you out. Suddenly one of them cries out - you have been discovered! You struggle out of your hiding-place and draw your sword but you are bowled over in the rush. One of them grabs your pouch of gold. The coins fly out into the air.  Immediately they begin to squabble over the spoils. They do not notice that the group of Elves have appeared at the top of the gully and are looking down. Without a word, the five Elves descend upon the Orcs and, thanks to their magic, soon prevail. Seizíng your opportunity, you grab your empty pouch and flee over the hill into [[the valley beyond-&gt;Page 203]].(set: $player&#39;s gold to 0)</tw-passagedata><tw-passagedata pid="90" name="Page 227" tags="" position="2334,3330" size="100,100">Your legs are beginning to grow heavy as you reach a gap between two hills. You are slowing now, and wonder how much longer you can keep this up. Looking back, you are pleased to see that the Elves and Orcs have met and are engaged in bloody battle. The Elves are making short work of the Orcs - strange sparks leap from their hands, killing the Orcs instantly. You realize that any respite you have gained will be short-lived, and press on. Over the hill you come to a [[verdant valley-&gt;Page 203]], deep in ferns.</tw-passagedata><tw-passagedata pid="91" name="Page 203" tags="" position="2434,3538" size="100,100">When you reach the floor of the va11ey, you find a pool into which a spring is bubbling. Feeling thirsty after having come so far, you step forward to the pool to drink where the branches of a gnarled old willow meet the water. Almost immediately you begin to feel strangely sleepy and realize that you are swaying, about to topple into the pool. (display: &quot;TEST YOUR LUCK&quot;)
|lucky)[(goto: &quot;Page 36&quot;)]|unlucky)[(goto: &quot;Page 319&quot;)]
(hidden:)[[Page 36]](hidden:)[[Page 319]]</tw-passagedata><tw-passagedata pid="92" name="Page 282" tags="monster" position="2159,3320" size="100,100">You struggle up the nearest hill and halt at its summit. You have a few moments to catch your breath, before the first Orcs are upon you. Luckily, being no more than an undisciplined mob, they run at you one at a time. You must fight the first three in order. The third is apparently their leader, a huge broad brute with curving yellow tusks and a jagged-edged scimítar.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First ORC&quot;,
		  &quot;skill&quot;, 5,
		  &quot;stamina&quot;, 6
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;Second ORC&quot;,
		  &quot;skill&quot;, 5,
		  &quot;stamina&quot;, 4
		)
	)
)
(hide: ?ATTACK_RESULTS)
(show: ?MONSTER_LIST)
(rerun:?MONSTER_LIST)|win)[
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;Leader ORC&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 7
		)
	)
)
(hide: ?ATTACK_RESULTS)
(show: ?MONSTER_LIST)
(rerun:?MONSTER_LIST)|win)[(goto: &quot;Page 111&quot;)]
]
](hidden:)[[Page 111]]</tw-passagedata><tw-passagedata pid="93" name="Page 111" tags="" position="2249,3474" size="100,100">When they see that you have overcome their leader single-handed, the rest of the Orcs turn tail and run. You hurry on down the far side of the hill. Before you lies a steep-sided valley deep in ferns. You decide to [[head down into it-&gt;Page 203]], hoping to elude the Elves.</tw-passagedata><tw-passagedata pid="94" name="Page 36" tags="monster" position="2337,3679" size="100,100">You struggle to overcome the drowsiness and the spell is broken. Looking up you can see two large green eyes staring at you from the trunk of the willow. Before you can step back you are attacked by the branches of the enraged tree. You must fight the WILLOW WEIRD.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;WILLOW WEIRD&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 20,
		  &quot;special&quot;, &quot;WILLOW WEIRD SPECIAL&quot;,
		  &quot;hits&quot;, 0
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 26&quot;)]
(hidden:)[[Page 26]]</tw-passagedata><tw-passagedata pid="95" name="Page 319" tags="monster" position="2509,3688" size="100,100">You struggle to tear yourself away from the pool, but a gentle and soothing voice suggests that you fall into a peaceful sleep. You feel nothing as you enter the cool green water. You are charmed by the WILLOW WEIRD. It thrashes you with its branches as you sink beneath the water. Lose 4 STAMINA points.($STAMINA: -4) The pain shocks you out of your reverie and you struggle out of the pool. Looking up, you can see two large green eyes staring at you from the trunk of the willow. You must fight it.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;WILLOW WEIRD&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;WILLOW WEIRD SPECIAL&quot;,
		  &quot;hits&quot;, 0
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 26&quot;)]
(hidden:)[[Page 26]]</tw-passagedata><tw-passagedata pid="96" name="WILLOW WEIRD SPECIAL" tags="" position="2210,3681" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &gt; _monster_roll)[(set: _monster&#39;s hits to it + 1)]
}](elseif: $combat_stage is &quot;combat-actions&quot;)[{
	(if: _monster&#39;s hits &gt;= 4)[
		(replace: ?ACTION_OPTIONS)[
			(set: $monsters to (a:))
			If you make four successful attacks, [[click here-&gt;Page 26]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="97" name="Page 26" tags="" position="2266,3859" size="100,100">With a mighty blow, your sword cuts through one of the Willow&#39;s branches and some sap from the tree falls on to your arm. The Willow gives a low moan, stops attacking and pulls its branches back from you. Will you plunge your arm into the [[pool-&gt;Page 161]], or beat a hasty [[retreat-&gt;Page 39]]?</tw-passagedata><tw-passagedata pid="98" name="Page 161" tags="" position="2191,4009" size="100,100">Before you plunge your arm into the water, you notice that the sap from the tree is healing a small graze on your wrist. You realize it has healing powers and decide to collect some more sap from the branch you cut from the tree. You may use the Sap of the Willow to restore 4 STAMINA points once, when you think it will help you most. Moving quickly away from the spring you decide to follow the small river that runs through the valley, heading [[west-&gt;Page 39]].($add_item: &quot;Sap of the Willow&quot;)</tw-passagedata><tw-passagedata pid="99" name="Page 39" tags="" position="2341,4009" size="100,100">You wend your way along the bank of the river that runs west from the spring and leave the ferns behind. The terrain has become a little more open now. Looking back, your heart quickens as you catch sight of one of the Dark Elves sniffing at your trail. He moves with a lithe swiftness which would seem graceful, if it wasn&#39;t for his spiked black armour, and deadly expression. While you are watching, he stands up and points in your direction; they are not far behind. You must decide quickly. Will you:
&lt;ul&gt;
	&lt;li&gt;Run along the [[river bank-&gt;Page 359]]?&lt;/li&gt;
	&lt;li&gt;Plunge [[into the river-&gt;Page 253]] and run along for some distance before scrambling up the bank?&lt;/li&gt;
	&lt;li&gt;[[Hide-&gt;Page 307]] in a clump of bushes?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="100" name="Page 359" tags="death" position="2623,4134" size="100,100">You run as fast as you can but your exertions have left you exhausted. Unable to find a hiding-place, you have to turn to face the Dark Elves who are almost upon you. One of them gestures strangely. A sudden pain grips you and you fall to the ground. The Elves are using foul sorcery. Unable to resist, you can do nothing as they bind you hand and foot. You are to be taken back to the depths of the Rift, never to see daylight again. Your quest ends here.</tw-passagedata><tw-passagedata pid="101" name="Page 253" tags="" position="2266,4154" size="100,100">The river winds between the hills. You wade along it, knowing that the Dark Elves will lose your scent in the water. After a while, you climb out on the other side of the river and [[continue on your way-&gt;Page 331]].</tw-passagedata><tw-passagedata pid="102" name="Page 307" tags="" position="2464,4137" size="100,100">You hide yourself in the bushes, hoping that the Elves will be unable to follow your trail. (display: &quot;TEST YOUR LUCK&quot;)
|lucky)[(goto: &quot;Page 293&quot;)]|unlucky)[(goto: &quot;Page 344&quot;)]
(hidden:)[[Page 293]](hidden:)[[Page 344]]</tw-passagedata><tw-passagedata pid="103" name="Page 331" tags="" position="1702,4159" size="100,100">The river flows out of the hills into a wide plain, where it turns north. You strike out west across the wild grasslands. Just when you think you have finally lost your pursuers, you notice a group of figures closing fast. Cursing under your breath, you realize that they are on to you again. Doggedly, you force yourself on, but the strain takes its toll. Lose 2 STAMINA points.($STAMINA:-2) Just as you are steeling yourself to turn and face your fell adversaries, you see a cloud of dust ahead. You can soon make out a group of twenty horsemen. They wheel their steeds towards you and the drumming of hoofs carries to you over the breeze as they canter in your direction. Seeing this, the Elves seem to give up the chase and fall back, obviously unwilling to encounter the riders. You are thankful to see the back of them and decide to wait for the riders to approach. As they get nearer, you can see that this is a band of warrior-women, clad in chaínmaíl and studded leather armour. Their faces look grim and unwelcoming as they wheel around you, forming a close circle. Their Captain spurs her horse forward and tersely demands what you are doing out here, along the edge of the moor. What will you do:
&lt;ul&gt;
&lt;li&gt;Ask them to aid you in your [[quest-&gt;Page 101]]?&lt;/li&gt;
&lt;li&gt;Say you are from [[another world-&gt;Page 73]]?&lt;/li&gt;
&lt;li&gt;Say you are the sole survivor of an [[ambushed caravan-&gt;Page 322]]?&lt;/li&gt;
&lt;li&gt;Pretend that you are [[deaf and dumb-&gt;Page 35]]?&lt;/li&gt;
&lt;li&gt;Demand they [[escort you-&gt;Page 95]] to Greyguìlds-on-the-Moor?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="104" name="Page 293" tags="" position="2347,4293" size="100,100">You wait for some time, trying to ignore the growing ache in your muscles. Nothing happens. You decide to risk breaking cover and [[cross the river-&gt;Page 331]].</tw-passagedata><tw-passagedata pid="105" name="Page 344" tags="death" position="2539,4287" size="100,100">Within moments you can hear the Elves swarming round you. They begin driving their swords into the bushes. Realizing you have little choice but to face them, you stand up and rush at them with your sword drawn. One of them makes a strange gesture. A sudden pain grips you and you fall to the ground. The Elves are using foul sorcery. Unable to resist, you watch helplessly as they bind you hand and foot. You are to be taken back to the depths of the Rift, never to see daylight again. Your quest ends here.</tw-passagedata><tw-passagedata pid="106" name="Page 362" tags="monster" position="1294,5307" size="100,100">You jump down and back into a corner between two shops, so that they cannot all attack you at once. The Captain and Elvira dismount and draw their swords while another turns and gallops back to Moorgate. You must fight these two first.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;CAPTAIN&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 10,
		  &quot;special&quot;, &quot;CAPTAIN SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;ELVIRA&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 8
		)
	)
)
(hide: ?ATTACK_RESULTS)
(show: ?MONSTER_LIST)
(rerun:?MONSTER_LIST)|win)[(goto: &quot;Page 376&quot;)]
](hidden:)[ [[Page 376]] [[Page 393]] ]</tw-passagedata><tw-passagedata pid="107" name="Page 351" tags="" position="1095,5475" size="100,100">You are taken along Moorgate, past various food and pottery shops, and then down bustling Store Street.  They turn right down Guard Street and come to a halt outside a squat grey building. It is the watch-house. The patrol dismounts and you are ushered [[inside-&gt;Page 78]].</tw-passagedata><tw-passagedata pid="108" name="Page 357" tags="" position="1611,5668" size="100,100">You are now in Store Street. It is crowded with shoppers but your attention is drawn to a woman in green robes, who is looking at you speculatively. Her straight hair is cut fairly short and she is wearing no ornaments. She crosses the street, and asks politely, in a quiet but clear voice, &#39;I believe you are a stranger in this city.  Who are you and where have you come from?&#39; Will you tell her that you are on a [[holy quest-&gt;Page 198]] and have crossed the wilderness, or say that you are [[just passing through-&gt;Page 130]] and start to walk briskly on?</tw-passagedata><tw-passagedata pid="109" name="Page 303" tags="" position="1949,5561" size="100,100">You stride down Smith Street. Next door to a tinker&#39;s shop you see what appears to be an armourers.  Do you wish to [[go in-&gt;Page 139]], or [[pass by-&gt;Page 104]]?</tw-passagedata><tw-passagedata pid="110" name="Page 376" tags="" position="1478,5305" size="100,100">The others ride away from you, raising a hue and cry as they go. You run along Store Street and then double back along a dark alley that parallels Moorgate, and conceal yourself behind some old barrels. After waiting for some time you dare to come out of hiding and walk carefully back on to Moorgate. Will you go down [[Store Street-&gt;Page 357]], or turn left into [[Smith Street-&gt;Page 303]]? </tw-passagedata><tw-passagedata pid="111" name="Page 393" tags="" position="1084,5278" size="100,100">Wanting to take you alive, the Captain closes with you and slams her shield into your sword-arm. Before you can strike again she brings the hilt of her sword crashing into the side of your neck; you slump to the floor, stunned. Your arms are tied behind you and you are [[pushed on your way-&gt;Page 351]] once more.</tw-passagedata><tw-passagedata pid="112" name="CAPTAIN SPECIAL" tags="" position="1293,5438" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &lt; _monster_roll and _monster_roll &gt;= 18)[
		(set: _monster&#39;s flag to 1)
	]
}](elseif: _monster contains &quot;flag&quot;)[{
	(set: $monsters to (a:))
	(replace: ?ATTACK_ACTIONS)[
		In any round, if the Captain&#39;s Attack Strength is 18 or more and she wounds you, [[click here-&gt;Page 393]].
	]	
}]</tw-passagedata><tw-passagedata pid="113" name="ATTACK ACTIONS" tags="" position="820,1511" size="100,100">(replace:?ATTACK_ACTIONS)[{
	(rerun:?TALLY_MONSTERS)
	(hide:?ATTACK_RESULTS)
	(hide:?ATTACK_ACTIONS)
	(show:?MONSTER_LIST)
	(rerun:?MONSTER_LIST)
}]</tw-passagedata><tw-passagedata pid="114" name="Page 78" tags="" position="909,5693" size="100,100">After a short delay, you are taken into a large office. Inside is a tall, striking, raven-haired woman, dressed in a long black cloak which parts to reveal the po1ished hilt of a longsword. Her bearing suggests great personal power. She stands and greets you. &#39;I am Hawkana, High Priestess of the temple of Fell-Kyrinla and Marshal of the Watch.  You have been telling some unusual stories.&#39; She nods and the guards begin to search you.  You try to resist but are held powerless.  The Talisman is ripped from its place of concealment and handed to Hawkana.($remove_item: &quot;Talisman of Death&quot;) She recognizes it immediately, and she laughs with rapturous delight. She turns away and says, &#39;I am going to the temple. Throw this fool out into the street.&#39; You are hustled out and the door of the watch-house slams shut behind you. You have lost the Talisman! What will you do next:
&lt;ul&gt;&lt;li&gt;Go back down Guard Street to [[Store Street-&gt;Page 357]]?&lt;/li&gt;
&lt;li&gt;Turn down [[Smith Street-&gt;Page 303]]?&lt;/li&gt;
&lt;li&gt;Walk down the [[Street of Seven Sins-&gt;Page 264]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="115" name="Page 198" tags="" position="1254,5782" size="100,100">&#39;You have come across the wilderness? Did you by any chance come across a man dressed in green robes similar to my own? He would have carried an oak staff and worn a crown of mistletoe; he would have told you his name.&#39; Will you answer:
&lt;ul&gt;&lt;li&gt;&#39;[[I did not meet him-&gt;Page 226]]&#39;?&lt;/li&gt;
&lt;li&gt;&#39;His name was [[Dwithian-&gt;Page 212]]&#39;?&lt;/li&gt;
&lt;li&gt;&#39;His name was [[Wodeman-&gt;Page 166]]&#39;?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="116" name="Page 130" tags="" position="1614,6099" size="100,100">As you walk along Store Street once more, you notice that the stores are closing. The throng of people hurrying home parts, to make way for a large black carriage drawn by two black mares. They carry plumed headdresses made of long black feathers. The cloaked coachman stares grimly ahead. You step into the gutter to let the coach pass and, as you do so, the coachman reins in. Inside you sèe an empty black coffin, but the name inscribed in silver letters on the lid is your own. The door of the funeral carriage opens and a handsome man with a silver cane steps down. He is dressed in the finest silver satin and sable furs. A storekeeper greets him.  He smiles and nods, then turns to you. &#39;I am the envoy of Death; I have come for the Talisman,&#39; he says in a voice of doom.  As you prepare to resist, a startling transformation takes place, which seems to be ignored by all around. His magnificent furs turn to rags. Where once blue eyes looked out from a finely featured face, now hollow sockets gaze at you from a blackened and cracked skull. His skeletal hand now grips a tarnished rapier. You realize that nobody else can see this transformation. &#39;Give it to me,&#39; he says. Will you:
&lt;ul&gt;(if: $inventory contains &quot;Talisman of Death&quot;)[&lt;li&gt;[[Give him the Talisman-&gt;Page 179]]?&lt;/li&gt;]
&lt;li&gt;[[Attack him ìmmediately-&gt;Page 271]]?&lt;/li&gt;
&lt;li&gt;[[Deny that you have it-&gt;Page 220]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="117" name="Page 139" tags="" position="1874,5711" size="100,100">Inside, working at an anvil, is a brawny man, glistening with sweat. He is fashioning the hilt of a sword. Other finished swords stand in a rack along one side of the shop. &#39;Take your pick. Seven gold pieces,&#39; he says, without looking up. You may (link-reveal:&quot;buy one&quot;)[(if: $player&#39;s gold &gt;= 7)[(goto: &quot;Page 160&quot;)](else:)[(dialog:&quot;You can&#39;t afford this.&quot;)]] if you wish, or thank him and [[leave-&gt;Page 104]].(hidden:)[[Page 160]]</tw-passagedata><tw-passagedata pid="118" name="Page 104" tags="" position="2168,5701" size="100,100">You continue on down Smith Street. There are no shops here and the street is deserted except for a stooping, cowled figure, who looks like a beggar. He comes up to you and suddenly draws himself up to his full height. Inside the cowl there is nothing - no face, just two glowing coals suspended in blackness. Your horror at this apparition turns to dread as it hisses in a sibilant whisper, &#39;Did you think you could run from Death? Give me the Talisman.&#39; A black-gloved claw reaches out towards you. Do you say that [[you no longer have the Talisman-&gt;Page 81]], or [[attack this thing-&gt;Page 96]] immediately?</tw-passagedata><tw-passagedata pid="119" name="Page 264" tags="" position="507,5865" size="100,100">As dusk comes, you walk on down the Street of Seven Sins until you reach the Red Dragon Inn. A thick-set man opens the door and flings a pail of red, stained sawdust across the road. &#39;Sorry, closed,&#39; he growls at you and slams the door again. Before you can move you notice the pile of sawdust being disturbed. Footsteps appear, one by one, leading from the sawdust towards you. Will you:
&lt;ul&gt;&lt;li&gt;[[Shout loud1y-&gt;Page 297]], to attract attention?&lt;/li&gt;
&lt;li&gt;[[Scoop up some dirt and fling it-&gt;Page 348]] at the footsteps?&lt;/li&gt;
&lt;li&gt;Wait to [[see what happens-&gt;Page 208]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="120" name="TORCHES" tags="" position="55,2899" size="100,100">&lt;li&gt;Torches x (print: $player&#39;s torches)&lt;/li&gt;</tw-passagedata><tw-passagedata pid="121" name="Page 81" tags="monster" position="2093,5851" size="100,100">&#39;Lies,&#39; it hisses, and strikes you with its claw before you can move. A chill numbness spreads from the wound and you feel as if your life-blood is being drained away. Lose 1 SKILL and 2 STAMINA points. Now you must fight the MINION OF DEATH. Each time it strikes you, you lose 1 SKILL point as well as the normal STAMINA loss.($SKILL:-1)($STAMINA:-2)(set: $lost_skill to 1)
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;MINION OF DEATH&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 7,
		  &quot;special&quot;, &quot;MINION SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 175&quot;)]
(hidden:)[[Page 175]]</tw-passagedata><tw-passagedata pid="122" name="Page 96" tags="monster" position="2243,5851" size="100,100">You catch it by surprise and strike it a mighty blow. It hisses in rage and pain and comes at you with its claws. You must fight the MINION OF DEATH. Each time it strikes you, it draws your life-force, so you lose 1 SKILL point, as well as the normal STAMINA loss.(set: $lost_skill to 0)
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;MINION OF DEATH&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 10,
		  &quot;special&quot;, &quot;MINION SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 175&quot;)]
(hidden:)[[Page 175]]</tw-passagedata><tw-passagedata pid="123" name="MINION SPECIAL" tags="" position="2287,5729" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &lt; _monster_roll)[
		(if: $player&#39;s skill &gt; 0) [
			(set: $lost_skill to it + 1)
			($SKILL: -1)
		]
	]
}]</tw-passagedata><tw-passagedata pid="124" name="Page 175" tags="" position="2178,6001" size="100,100">Your last blow meets no resistance. The grey cloak billows to the ground in a heap. All is silent except for a sudden keenìng of the wind. You rest and begin to overcome the shock to your system. If you have lost any SKILL points, all but 1 are restored($SKILL: (max: 0, $lost_skill - 1)). Cautiously, you move on, coming to [[Silver Street-&gt;Page 85]].</tw-passagedata><tw-passagedata pid="125" name="Page 85" tags="" position="2203,6151" size="100,100">Turning down Silver Street, you are startled by what sounds like men&#39;s voices, whispering near by. You soon realize that a trick of the wind is carrying their words to you through a broken piece of pipe, which connects a ramshackle house to an open drain. There are three ofthem and it seems that they are planning to rob the jeweller&#39;s, which you can plainly see on the bend of Silver Street. There is a shabby staircase leading up to the house, and you creep towards it. Will you:
&lt;ul&gt;&lt;li&gt;Go up the [[staircase-&gt;Page 245]]?&lt;/li&gt;
&lt;li&gt;Walk quickly to the [[jeweller&#39;s-&gt;Page 278]]?&lt;/li&gt;
&lt;li&gt;Ignore this and turn into [[Store Street-&gt;Page 243]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="126" name="Page 245" tags="monster" position="2258,6313" size="100,100">Just as you are about to enter the bare, roofless room, a rotten stair breaks, betraying your presence. Realizing that they may have been overheard, one of the thieves runs off across a nearby roof-top. The other two, mean-looking thugs in brown breeches, attack you. They try to come at you from different sides, but after springing up the last stairs your footwork is too good for them and you hold the stairway, where they can only come at you one at a time. You must fight them in order.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First THIEF&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 7
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;Second THIEF&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 6
		)
	)
)
(hide: ?ATTACK_RESULTS)
(show: ?MONSTER_LIST)
(rerun:?MONSTER_LIST)|win)[(goto: &quot;Page 329&quot;)]
]
(hidden:)[[Page 329]]</tw-passagedata><tw-passagedata pid="127" name="Page 278" tags="" position="2537,6294" size="100,100">You enter the jeweller&#39;s. It seems to be curiously lacking in things of real value. The jeweller, a small man with a monocle, is just locking the large safe behind his counter. As he reaches for the closed sign, before you have the chance to speak, the three thieves you overheard burst into the shop, brandishing swords. Will you seek to get in with the thieves by [[capturing the jeweller-&gt;Page 309]], or leap to the jeweller&#39;s aid and [[attack the thieves-&gt;Page 286]]?</tw-passagedata><tw-passagedata pid="128" name="Page 243" tags="" position="2046,6314" size="100,100">You continue along Store Street and then down a tree-lined avenue called Booker&#39;s Wall. Two very grand buildings, built of blocks of grey stone, stand on either side of the road. A group of young people in blue togas, escorted by a white-haired old man in pale blue robes, enters the building opposite. A flag, showing books and scrolls, is flying from the nearest building; it appears to be a library. Will you see what information the [[library-&gt;Page 346]] has to offer, or investigate [[the other building-&gt;Page 279]], to find out what the young people are doing?</tw-passagedata><tw-passagedata pid="129" name="Page 160" tags="" position="1918,5861" size="100,100">You choose a sword which feels well-balanced. It is a well-crafted longsword, similar to those used by the warrior-women. You may restore the 2 SKILL points you lost if you had your sword taken.($add_weapon:(dm: &quot;name&quot;, &quot;Longsword&quot;, &quot;modifier&quot;, 2))($GOLD: -7)You pay the man and [[leave-&gt;Page 104]].</tw-passagedata><tw-passagedata pid="130" name="Page 226" tags="" position="1402,5901" size="100,100">&#39;Ah, it is a long time since we had news. I am a Priestess of the All-Mother, the Fountain of Life. The Druids are our friends. I trust you will enjoy your stay in Greyguilds. Goodbye, stranger.&#39; She walks on and is soon lost in the crowd. You continue on down [[Store Street-&gt;Page 130]].</tw-passagedata><tw-passagedata pid="131" name="Page 212" tags="" position="1277,5927" size="100,100">&#39;I see,&#39; she says shortly and turns away.  She walks off and is soon lost in the crowd.  You shrug your shoulders and [[walk on-&gt;Page 130]].</tw-passagedata><tw-passagedata pid="132" name="Page 166" tags="" position="1149,5979" size="100,100">Smiling delightedly, she asks about Wodeman. You tell her what happened in the Sacred Grove. &#39;Then you are welcome at the temple. I am Lillantha, a Priestess of the All-Mother, Fountain of Life. I am on my way to prayer. Perhaps you would like to join me?&#39; Will you [[accompany her-&gt;Page 117]], or [[decline-&gt;Page 130]] and say you must be on your way?</tw-passagedata><tw-passagedata pid="133" name="Page 179" tags="death" position="1484,6301" size="100,100">You hastily hand the Talisman to the skeletal envoy of Death. As he receives it, he seems to draw unholy strength from it. &#39;You fool,&#39; he mocks, his voice deep and resonant, full of malice.  He touches you with the Talisman uncannily quickly. It is as if Death himself had touched you and your heart beats no more. Nothing can save you. Your quest ends here.</tw-passagedata><tw-passagedata pid="134" name="Page 271" tags="monster" position="1613,6297" size="100,100">You catch it by surprise and strike it a mighty blow. It hisses in rage and pain and lunges at you with its rapier. You must fight the ENVOY OF DEATH. Each tíme it strikes you, you lose 1 SKILL point as well as the normal STAMINA loss.(set: $lost_skill to 0)
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;ENVOY OF DEATH&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 4,
		  &quot;special&quot;, &quot;MINION SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 254&quot;)]
(hidden:)[[Page 254]]</tw-passagedata><tw-passagedata pid="135" name="Page 220" tags="monster" position="1738,6296" size="100,100">&#39;Lies,&#39; it hisses, and lunges at you with its rapier before you can move. A chill numbness spreads from the wound and you feel as if your life-blood is being drained away. Lose 1 SKILL and 2 STAMINA points. ($SKILL:-1)($STAMINA:-2)Now you must fight the ENVOY OF DEATH. Each time it strikes you, you lose 1 SKILL point as well as the normal STAMINA loss.(set: $lost_skill to 1)
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;ENVOY OF DEATH&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 6,
		  &quot;special&quot;, &quot;MINION SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 254&quot;)]
(hidden:)[[Page 254]]</tw-passagedata><tw-passagedata pid="136" name="Page 297" tags="monster" position="357,6015" size="100,100">The only people in sight hurry away, not looking at you. The footsteps come on and a dull, rasping voice intones, &#39;I am a spirit of the dead. We are beyond number.&#39; Suddenly, a terrible blow knocks you backwards. Lose 2 STAMINA points.($STAMINA:-2) You must fight the UNSEEN STALKER.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;UNSEEN STALKER&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 8
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 250&quot;)]
(hidden:)[[Page 250]]</tw-passagedata><tw-passagedata pid="137" name="Page 348" tags="monster" position="507,6015" size="100,100">The dirt you have thrown splatters across an invisible form. It outlines the shape of a thin man-like being about three metres tall. It moves towards you, almost mechanically, until it towers above you and you realize it is about to attack. You must fight the UNSEEN STALKER.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;UNSEEN STALKER&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 8
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 250&quot;)]
(hidden:)[[Page 250]]</tw-passagedata><tw-passagedata pid="138" name="Page 208" tags="monster" position="657,6015" size="100,100">The footsteps come on and from the air above you a dull rasping voice intones: &#39;I am a spirit of the dead and we are beyond number.&#39; Suddenly a terrible blow knocks you backwards. Lose 2 STAMINA points.($STAMINA:-2) You must fight the UNSEEN STALKER, striking out blindly and hoping your thrusts will harm it.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;UNSEEN STALKER&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 8
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 250&quot;)]
(hidden:)[[Page 250]]</tw-passagedata><tw-passagedata pid="139" name="Page 250" tags="" position="508,6190" size="100,100">Exhausted from the rigours of the day, you stop and draw breath. The attack by an unseen foe has left you unnerved. You look around, then listen carefully in case another attack should be imminent. As night falls you are thankful to find an empty stable. You go in and curl up in a heap of straw, [[ready for the night-&gt;Page 91]].</tw-passagedata><tw-passagedata pid="140" name="Page 91" tags="monster" position="704,6180" size="100,100">You fall into deep slumber and then begin to dream. The Paladin crusader you saw in the Rift appears to you and seems to be giving advice. The shimmering that once limned his sword now surrounds him like a halo. He urges you to enlist the help of the Thieves&#39; Guild, &#39;though it grieves me to suggest you should have dealings with such people. You may find them in the Red Dragon Inn. They may help you to recover the Talisman from Fell-Kyrinla&#39;s temple, where it now lies.&#39; Suddenly the dream seems even more real and the Paladin is shouting, &#39;Awake, awake! You are in grave danger.&#39; You wake; everything is silent. By the light of the moon you see tendrils of mist curling round the door-jamb. The door crashes open. A pall of mist spills into the stable and a warrior clad in full plate armour, as black as night, and wielding a cruelly spiked mace steps forward. He raises his visor. You can see nothing inside the helmet. Your gaze is held. Now it seems you are looking upon the fires of hell. You are filled with despair as the black mace is raised to crush you. You must fight the DEATH-KNIGHT. 
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;DEATH-KNIGHT&quot;,
		  &quot;skill&quot;, 10,
		  &quot;stamina&quot;, 15,
		  &quot;special&quot;, &quot;DEATH-KNIGHT SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 62&quot;)]
(hidden:)[ [[Page 62]] [[Page 193]] ]</tw-passagedata><tw-passagedata pid="141" name="Page 117" tags="" position="1319,6072" size="100,100">You walk with the Priestess into a small grassy square. On the far side of the square stands a magnificent tiered temple, covered by a wonderful hanging garden. A flock of many types of small coloured birds takes flight as you pass two guards and enter through the wide green doors. Inside is a long hall, decorated with flowers. You both kneel in prayer before the altar, which is loaded with grain and fruit. She prays for the protection of all living things. After a few moments of reflection, she takes your hand in hers and leads you into a small room at the side of the hall. On a stand is a suit of silvery chainmail. Lillantha says, &#39;The All-Mother has spoken to me of your quest. She wishes you to take this - it may be of help.&#39; Thanking her, you put on the chainmail which is miraculously light. It is obviously magical - gain 1 SKILL point.($add_item:&quot;Magical Chainmail&quot;)(set: $player&#39;s skill to it + 1) &#39;One final thing: the gates are guarded by followers of the All-Mother on the evenings of market-days and for the three days following. If you wish to leave the city without others knowing, leave then.&#39; You thank her and, leaving the peace of the temple, return to the hubbub of [[Store Street-&gt;Page 130]].</tw-passagedata><tw-passagedata pid="142" name="Page 62" tags="" position="599,6332" size="100,100">Wìth a clatter of armour the Death-knight folds at the knees and vanishes. A vision of the Paladin appears. &#39;Well done. You are a valiant warrior, worthy of the quest. Here, take my Holy Sword: it will aid you, for I no longer can.&#39; He hands you his glittering sword and the vision fades. The sword feels real enough and its glow lights up the stable. Your wounds are healed magically as you touch it (regain up to 6 STAMINA points)($STAMINA: 6) - a gift from the Paladin. You may add 1 to your SKILL when using the [[Holy Sword-&gt;Page 121]].($add_weapon:(dm: &quot;name&quot;, &quot;Holy Sword&quot;, &quot;modifier&quot;, 3))</tw-passagedata><tw-passagedata pid="143" name="DEATH-KNIGHT SPECIAL" tags="" position="899,6191" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: $player&#39;s stamina &lt;= 6 )[
		(replace: ?ATTACK_ACTIONS)[
			If your STAMINA is reduced to 6 or below, [[click here-&gt;Page 193]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="144" name="Page 193" tags="" position="836,6333" size="100,100">(set: $monsters to (a:))You are weakening. You realize you are close to death. A sudden blinding light halts the Death-knight&#39;s onslaught. To your amazement the Paladin crusader stands before you, bathed in a silvery radiance. The Death-knight steps back, shielding its face. The Paladins&#39; Holy Sword hums through the air and cuts the Death-knight in two. As abruptly as he came, the Paladìn dìsappears. There is no sígn of your adversary but the Holy Sword remains, casting a glow where it lies on the straw. You pick it up, realizing that it is meant for you to use in your struggle against Death. As you grasp it, your wounds heal magically. You regain 6 STAMINA points.($STAMINA: 6) You may add 1 to your SKILL when using the [[Holy Sword-&gt;Page 121]].($add_weapon:(dm: &quot;name&quot;, &quot;Holy Sword&quot;, &quot;modifier&quot;, 3))</tw-passagedata><tw-passagedata pid="145" name="Page 121" tags="" position="836,6483" size="100,100">You sleep again, until the late morning sun, shining into the stable, wakes you. You stretch and your hand touches something cold lying in the straw. It is a gold piece, which you decide to pocket before leaving the stable.($GOLD:1) Do you want to go down one of the sìde-streets that leads to the Street of Seven Sins and the [[Red Dragon Inn-&gt;Page 57]], or do you decide against mixing with thieves and try to take the Talisman from the temple [[on your own-&gt;Page 221]]?</tw-passagedata><tw-passagedata pid="146" name="Page 57" tags="" position="859,6883" size="100,100">You take a side-street which leads towards the Street of Seven Sins and are almost pushed aside by a couple of students in blue togas. They are quarrelling and begin fighting in front of you. It seems one of them disagrees violently with something the other has said. As they tussle, you notice that the angry young man has dropped a small brass tiger charm. Will you:
&lt;ul&gt;
&lt;li&gt;Interrupt the quarrel and [[give the charm back-&gt;Page 47]]?&lt;/li&gt;
&lt;li&gt;[[Ignore them-&gt;Page 156]] and go on your way?&lt;/li&gt;
&lt;li&gt;[[Pick up the charm-&gt;Page 32]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="147" name="Page 221" tags="" position="1286,6504" size="100,100">You spot one of the warrior-women who you know are members of the temple of Fell-Kyrinla. Hoping she is on her way to the temple, you follow her at a distance. Eventually, you come to a building made of a white stone, with dark grey columns. Steps lead up to the entrance between two pillars and there is a guard at the top. What will you do:
&lt;ul&gt;&lt;li&gt;[[Attack the guard-&gt;Page 234]]?&lt;/li&gt;
&lt;li&gt;[[Tell her you have a message-&gt;Page 202]] for the High Priestess?&lt;/li&gt;
&lt;li&gt;Give up and go to the [[Red Dragon Inn-&gt;Page 24]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="148" name="Page 254" tags="" position="1688,6457" size="100,100">Your last blow meets no resistance. The skeletal form collapses to the ground in a heap. All is silent except for a sudden keening of the wind. You rest and begin to overcome the shock to your system. If you have lost any SKILL points, all except 1 are restored.($SKILL: (max: 0, $lost_skill - 1)) Cautiously, you continue along Store Street and then down a tree-lined avenue called Booker&#39;s Walk. Two very grand buildings, built of blocks of grey stone, stand on either side of the road. A group of young people in blue togas, escorted by a white-haired old man in pale blue robes, enters the building opposite. A flag showing books and scrolls is flying from the nearest building; it appears to be a library. Will you see what information the [[library-&gt;Page 346]], or investigate [[the other building-&gt;Page 279]], to find out what the young people are doing?</tw-passagedata><tw-passagedata pid="149" name="Page 346" tags="" position="1571,6948" size="100,100">The entrance hall of the library is filled with desks at which scribes are working, copying books and scrolls. Reclining on a plush window-seat is a wrinkled old fellow in the pale blue robes of a scholar. You feel out of place, wearing armour in the quiet of the library, where the stillness is broken only by the scratching of pens. &#39;Welcome to the largest library in the Manmarch,&#39; says the Sage. &#39;Choose any tome or scroll you may wish to peruse. Perhaps I may be of assistance.  What is your field of study?&#39; Will you ask to read something about [[the Gods-&gt;Page 336]], or ask to read about the [[history of Greyguilds-&gt;Page 196]]?</tw-passagedata><tw-passagedata pid="150" name="Page 279" tags="" position="1767,6962" size="100,100">You slip inside the huge building and walk cautiously down empty corridors. You find a reading-room and decide to look at some of the scrolls. You find one which tells you that the women who brought you to Greyguilds worship Fell-Kyrinla. Another lists the different types of magic and the names given to those who practise them: warlocks, shamans, witches, necromancers, elementalists, thaumaturgists, demonists, cabalists, spellbinders and many more. The necromancers&#39; magic interests you, for these are the death-magicians who perform human sacrifices and other unspeakable abominations in their pursuit of power. Then you notice a red book bound in strange multi-coloured scales. It seems to beckon you. Will you [[open the tome-&gt;Page 262]], or [[leave-&gt;Page 186]] before you are discovered?</tw-passagedata><tw-passagedata pid="151" name="Page 329" tags="" position="2159,6463" size="100,100">You search the two thieves and find 6 gold pieces.($GOLD: 6)
(hidden:)[ [[Page 304]] ](display: &quot;Page 304&quot;)</tw-passagedata><tw-passagedata pid="152" name="Page 309" tags="" position="2840,6437" size="100,100">The jeweller reaches for a sword behind the counter but you are too quick for him. You grab the sword and hold its edge to his throat. He tenses up and says, &#39;There&#39;s my safe. Take it all but don&#39;t hurt me!&#39; He points to the safe at the back of the room. One of the thieves, a thin weasel of a man, binds the jeweller. You may keep the jeweller&#39;s (link-reveal:&quot;sword&quot;)[($add_weapon: (dm: &quot;name&quot;, &quot;Short Sword&quot;, &quot;modifier&quot;, 2))], if you wish. The other two, mean-looking thugs in brown breeches, look you over coolly. Will you [[demand your pick-&gt;Page 66]] of the loot, or [[ask for a small share-&gt;Page 354]] of the booty?</tw-passagedata><tw-passagedata pid="153" name="Page 286" tags="monster" position="2455,6460" size="100,100">Two of the thieves, thick-set bruisers in brown leather breeches, turn to face you, while the third, a thin weasel-faced man, goes for the jeweller. You must fight the two thieves together.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First THIEF&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 7,
		  &quot;special&quot;, &quot;THIEVES SPECIAL&quot;
		)
	,
		(dm:
		  &quot;name&quot;, &quot;Second THIEF&quot;,
		  &quot;skill&quot;, 5,
		  &quot;stamina&quot;, 6,
		  &quot;special&quot;, &quot;THIEVES SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 299&quot;) [[Page 299]] ]</tw-passagedata><tw-passagedata pid="154" name="THIEVES SPECIAL" tags="" position="2596,6451" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: $monsters&#39;s length &lt;= 1)[
		(replace: ?ATTACK_ACTIONS)[
			(set: $monsters to (a:))
			If you kill one of the thieves, [[click here-&gt;Page 299]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="155" name="Page 299" tags="" position="2446,6641" size="100,100">With a shout of victory, the jeweller steps back from the fallen body of his assailant, a bloodied short-sword in his hand. You are surprised that such a small old man is so skilful. Seeing this, your other opponent throws down his sword and runs out of the shop. You may pick up the thief&#39;s (link-reveal:&quot;sword&quot;)[($add_weapon: (dm: &quot;name&quot;, &quot;Sword&quot;, &quot;modifier&quot;, 2))]. The jeweller turns to you, his monocle swinging at his waist, and thanks you. He reaches behind the counter and hands you a leather pouch containing 10 gold pieces($GOLD: 10) and a small velvet-covered box. Inside the box is a magnificent ruby.($add_item: &quot;Ruby&quot;) &#39;No one can call Olio the Jeweller a miser,&#39; he says. Scarcely believing your good fortune, you thank him and [[leave-&gt;Page 304]]. Gain 1 LUCK point.($LUCK: 1)</tw-passagedata><tw-passagedata pid="156" name="Page 304" tags="" position="2061,6638" size="100,100">You continue down Silver Street, past the jeweller&#39;s, which is closed, and turn left into a tree-lined avenue called Booker&#39;s Walk. Two very grand buildings, built of blocks of grey stone, stand on either side of the road. A group of young people in blue togas, escorted by a white-haired old man in pale blue robes, enters the building opposite. A flag showing books and scrolls is flying from the nearest building. It appears to be a library. Will you see what information the [[library-&gt;Page 346]] has to offer, or investigate [[the other building-&gt;Page 279]] to find out what the young people are doing?</tw-passagedata><tw-passagedata pid="157" name="Page 66" tags="monster" position="2740,6627" size="100,100">&#39;Here&#39;s your share of the loot, you insolent dog&#39;, shouts the biggest thug, attempting to bury his sword in your stomach. You jump aside and meet the attack of the two bruisers. As you do so, the weaselly thief mercilessly kills the jeweller. You must fight both thieves.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First THIEF&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 7,
		  &quot;special&quot;, &quot;THIEVES SPECIAL 2&quot;
		)
	,
		(dm:
		  &quot;name&quot;, &quot;Second THIEF&quot;,
		  &quot;skill&quot;, 5,
		  &quot;stamina&quot;, 6,
		  &quot;special&quot;, &quot;THIEVES SPECIAL 2&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 320&quot;) [[Page 320]] ]</tw-passagedata><tw-passagedata pid="158" name="Page 354" tags="" position="2917,6627" size="100,100">The weasel-faced thief buries his sword in the unfortunate jeweller&#39;s back and says to you, as if nothing had happened, &#39;Well, I don&#39;t know - you&#39;re not even a member of the Guild. I&#39;ll tell you what, though, if you open the safe we&#39;ll give you a share. It is protected by a magical Glyph of Warding. You must say, &quot;I am undone&quot;, to cancel the power that guards the safe.&#39; Will you go to the safe and [[do as he says-&gt;Page 341]] - hopìng to get first pick of anything inside? Or do you [[refuse and invite him-&gt;Page 364]] to try it?</tw-passagedata><tw-passagedata pid="159" name="Page 341" tags="" position="2842,6777" size="100,100">As you reach for the safe, a blinding sheet of flame envelops you. The safe was fire-trapped and you have been [[fried-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="160" name="Page 364" tags="monster" position="2992,6777" size="100,100">&#39;Shame,&#39; he says, &#39;you would have been killed.&#39; At this the two large thieves attack you.  You must fight them. 
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;First THIEF&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 7,
		  &quot;special&quot;, &quot;THIEVES SPECIAL 3&quot;
		)
	,
		(dm:
		  &quot;name&quot;, &quot;Second THIEF&quot;,
		  &quot;skill&quot;, 5,
		  &quot;stamina&quot;, 6,
		  &quot;special&quot;, &quot;THIEVES SPECIAL 3&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 391&quot;) [[Page 391]] ]</tw-passagedata><tw-passagedata pid="161" name="Page 320" tags="" position="2575,6809" size="100,100">The other two thieves run for it when they see how skilfully you dispatched their ferocious friend. You are left alone in the shop with the dead jeweller. His eyes seem to gaze at you in mute reproach.  Will you put up the closed sign and try to [[open the jeweller&#39;s safe-&gt;Page 341]], or [[leave immediately-&gt;Page 304]] in case you are accused of murder?</tw-passagedata><tw-passagedata pid="162" name="THIEVES SPECIAL 2" tags="" position="2597,6626" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(rerun: ?TALLY_MONSTERS)
	(if: $monsters&#39;s length is 1 and _monster&#39;s name is &quot;Second THIEF&quot;)[
		(replace: ?ATTACK_ACTIONS)[
			(set: $monsters to (a:))
			If you kill the first thief, [[click here-&gt;Page 320]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="163" name="Page 109" tags="" position="2278,6906" size="100,100">Your spirit floats gently towards the Valley of Death. The featureless, wind-blasted plain stretches away endlessly, beyond the horizon. The souls of the dead wander there aimlessly, in solitude. Just as you approach the edge of the valley, an ethereal wind gets up and your soul is wafted away. Soon you feel yourself in the presence of the two who summoned you to this fantastic world of magic. The eyeless being in robes of shifting hues says, &#39;All is not yet lost.&#39; You understand the words without hearing them. &#39;If your spirit is willing we will reunite it with your body and turn back the wheels of time.&#39; The other being offers you a choice: &#39;If you wish it, I will send you back in time. You will be at the lip of the Rift again.&#39; Do you wish to (link-reveal:&quot;go back in time&quot;)[(show:?1)] to attempt the quest again? |1)[If you do, he lays a hand on your shoulder. They disappear. You are alive again. Your wounds are healed and you have 10 Provisions. You have only the equipment with which you began the adventure, including the Talisman of Death, if you had lost it. Anything else you picked up on the way has disappeared and will have to be crossed off your Adventure Sheet. Your SKILL, STAMINA and LUCK are at their Initial levels. Suddenly you are on the surface of Orb [[once again-&gt;Page 185]].
[{(set: $inventory to (ds:&quot;Talisman of Death&quot;))
(set: $weapons to (ds: (dm: &quot;name&quot;, &quot;Sword&quot;, &quot;modifier&quot;, 2)))
(set: $keyring to (ds:))
(set: $monsters to (a:))
(set: $player&#39;s skill to $player&#39;s max_skill)
(set: $player&#39;s stamina to $player&#39;s max_stamina)
(set: $player&#39;s luck to $player&#39;s max_luck)
(set: $player&#39;s provisions to 10)
(set: $player&#39;s gold to 10)
(set: $player&#39;s torches to 5)
(display: &quot;SIDEBAR&quot;)
}]
]</tw-passagedata><tw-passagedata pid="164" name="Page 391" tags="" position="2949,6924" size="100,100">Seeing your deadly sword-play, the third thief bolts into the street. The other one pleads for mercy, throwing down his sword. &#39;I&#39;ll tell you what the right words are,&#39; he gabbles. &#39;Just say, &quot;I am a casket of iron and fire&quot;!&#39; Will you [[try the safe-&gt;Page 381]], using these words, or [[order him to try-&gt;Page 399]] the safe?</tw-passagedata><tw-passagedata pid="165" name="THIEVES SPECIAL 3" tags="" position="3142,6747" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: $monsters&#39;s length &lt;= 1)[
		(replace: ?ATTACK_ACTIONS)[
			(set: $monsters to (a:))
			If you kill one of the thieves, [[click here-&gt;Page 391]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="166" name="Page 381" tags="" position="2730,6882" size="100,100">As you say the words and reach for the safe, a blinding sheet of flame envelops you. The safe was fire-trapped and you have been [[fried-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="167" name="Page 399" tags="" position="2674,7084" size="100,100">The thief says, sullenly, &#39;If I must,&#39; and moves over to the safe. Suddenly he leaps acrobatically over the counter and is out of the shop like a flash. Will you try to [[open the safe-&gt;Page 381]] saying, &#39;I am a casket of iron and fire&#39;, or [[leave the shop-&gt;Page 304]] in case the thug tells the Watch you have killed the jeweller?</tw-passagedata><tw-passagedata pid="168" name="Page 47" tags="" position="753,7035" size="100,100">The angry young man turns to you, a puzzled expression on his face. He thanks you and says, &#39;I don&#39;t know why we are quarrelling really.&#39; He takes the charm from you and you walk on. Fortune will smile on you for being so honest (gain 1 LUCK point).($LUCK:1) Soon afterwards you hear the fight breaking out again. &#39;You&#39;re always making trouble,&#39; shouts the other young man. You [[leave them to it-&gt;Page 156]].</tw-passagedata><tw-passagedata pid="169" name="Page 156" tags="" position="876,7161" size="100,100">You come out into the Street of Seven Sins and soon find the Red Dragon Inn. Steps lead downwards and the sound of raucous laughter floats up from the smoke-filled gloom below. You enter and walk over to the only part of the dive where it is light enough to make anything out. Passing tables and stools, you come to the bar, behind which stands the bulky proprietor of the inn. Do you have the (link-reveal:&quot;brass tiger charm&quot;)[(show:?tiger_charm)]?
|tiger_charm)[(if: $inventory contains &quot;Tiger Charm&quot;)[ [[You do-&gt;Page 11]]. ](else:)[ [[You do not-&gt;Page 3]].] ]</tw-passagedata><tw-passagedata pid="170" name="Page 32" tags="" position="981,7035" size="100,100">The brass tiger has a mischievous grin. You hang it round your neck, hoping it will bring luck or [[protection-&gt;Page 156]]. ($add_item:&quot;Tiger Charm&quot;)</tw-passagedata><tw-passagedata pid="171" name="Page 234" tags="monster" position="1972,6915" size="100,100">As you rush up the stairs, the guard strikes a hidden bell and attacks you. You must fight her.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TEMPLE GUARD&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 8	
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 255&quot;)]
(hidden:)[[Page 255]]</tw-passagedata><tw-passagedata pid="172" name="Page 202" tags="" position="2033,6779" size="100,100">The guard beckons you inside the temple. Just as you enter you almost bump into Hawkana, the tall, raven-haired High Priestess.  &#39;Who is this?&#39; she barks. The guard explains that you claim to be a secret messenger, but have failed to give any password. Hawkana says, &#39;This person is no messenger. Die, desecrator!&#39;  Cursing your ill luck at meeting Hawkana so soon after entering the temple, you turn to run. Hawkana lets out a scream of invocation, calling on the powers of her Goddess. A pillar of flame engulfs you as the power of Fell-Kyrinla is unleashed. You are [[burnt to a cinder-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="173" name="Page 24" tags="" position="714,6800" size="100,100">You go down the steps and emerge into a long low cellar, set with tables and stools. The only light part is the bar, behind which stands the bulky [[proprietor-&gt;Page 3]] of the inn.</tw-passagedata><tw-passagedata pid="174" name="Page 255" tags="" position="2042,7118" size="100,100">As the stricken woman slides down the temple steps, leaving a trail of blood behind her, you are dismayed to see Hawkana, the raven-haired High Priestess. She lets out a scream of invocation, calling on the powers of her Goddess. A pillar of flame engulfs you as the power of Fell-Kyrinla is unleashed. You are [[burnt to a cinder-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="175" name="Page 3" tags="" position="483,7346" size="100,100">You ask the barman for a mug of ale.  While he pours you your drink, your eyes adjust to the gloom and you survey his customers. You have never seen a more disreputable bunch of villainous-looking cut-throats. The barman says, &#39;That will be a piece of gold.&#39; You hand over the money.($GOLD: -1) As you replace your money-pouch a dozen pairs of eyes watch closely. The only one who doesn&#39;t watch is a stooped old man, cleaning slops off an empty table. Will you:
&lt;ul&gt;
&lt;li&gt;Talk to the [[barman-&gt;Page 88]]?&lt;/li&gt;
&lt;li&gt;Walk over to the [[old man-&gt;Page 19]]?&lt;/li&gt;
&lt;li&gt;Approach [[six surly-looking men-&gt;Page 280]], who look like thieves?&lt;/li&gt;
&lt;/ul&gt;
</tw-passagedata><tw-passagedata pid="176" name="Page 336" tags="" position="1622,7156" size="100,100">The sage directs you to &lt;i&gt;The Book of the Gods&lt;/i&gt;, a large leather-bound tome, inlaid with gold leaf. Turning the gilt-edged pages you realize the Gods of Orb are many. You recognize a symbol on one of the pages as being the token borne by the warrior-women. Their goddess is Fell-Kyrinla, swordsmistress of the heavens. She is sworn to oppose Rocheval the Good, God of Paladins. To your excitement you díscover a reference to the Talisman: &lt;i&gt;Some believe that it can be used to command the undead minions of Death&lt;/i&gt;. Turning the page you come to a reference to the All-Mother, &lt;i&gt;Nature herself, preserver of life, who cares for all&lt;/i&gt;. Then you see a bizarrely illustrated page dealing with &lt;i&gt;Anarchil, breaker of edifices, who spurns order&lt;/i&gt;. You are just learning of &lt;i&gt;Avatar the One, essence of light&lt;/i&gt;, when you realize that it has grown dark while you were reading. You thank the Sage and leave quickly, hoping to find a [[safe place to sleep-&gt;Page 186]].</tw-passagedata><tw-passagedata pid="177" name="Page 196" tags="" position="1834,7186" size="100,100">The Sage shows you to a side room, full of reading desks. A few are occupied by students of history, young and old. With an expansive gesture he points to a wall lined with shelves, which are filled with scrolls and tablets. You choose a set of scrolls called &lt;i&gt;Greyguilds Revisited&lt;/i&gt;, by Nyleve. It is the story of a dissolute young nobleman who failed to take advantage of the education offered by the Guilds of Learning. You are able to glean much interesting information about the city. The religious orders hold all the power. You are astonished to find that Vagar, the God of thieves, liars and cut-throats, has most followers within the city. There is a temple to Death in the city as well. Indeed it seems that Greyguilds is not the tranquil city that it once was. The armed forces protecting the city come from two groups, the warrior-women who worship the evil goddess Fell-Kyrinla, and the followers of the All-Mother. Greyguilds lies on the edge of a large plain, called the Manmarch, or lands of men. It is just one of many cities in this part of the world. As you are wondering whether you will ever visit Doomover, or the Spires of Foreshadowing, the other students begin filing out. With a start you realize it is already dark and you leave quickly, looking for a [[safe place to sleep-&gt;Page 186]].</tw-passagedata><tw-passagedata pid="178" name="Page 186" tags="" position="1684,7336" size="100,100">You leave the building and continue on down Booker&#39;s Walk. The streets are already deserted and there are few lights in this part of the city. You search for the welcoming light of an inn. Then, without warning, the steel teeth of a hidden man-trap snap shut round your leg, ripping your flesh. You are in terrible pain. Lose 2 STAMINA points.($STAMINA: -2) Shadowy figures loom out of the murk all around you. Their faces glow with a sickly pallor in the moonlight. They are wearing black robes clasped at the neck by shrunken human skulls. Do you still have the (link-reveal:&quot;Talisman of Death&quot;)[(show: ?talisman)]? |talisman)[(if: $inventory contains &quot;Talisman of Death&quot;)[If you have, [[click here-&gt;Page 162]].](else:)[If you have not got it, [[click here-&gt;Page 150]].]]</tw-passagedata><tw-passagedata pid="179" name="Page 162" tags="" position="1609,7486" size="100,100">&#39;We are the priesthood of Death,&#39; says one of the figures. &#39;We have come for what is ours.&#39; Your arms are held and you are searched. The Talisman is torn from you by their leader.($remove_item: &quot;Talisman of Death&quot;) &#39;I have it, brothers, I have it,&#39; he exclaims in triumph. &#39;Now may our Lord enter his kingdom.&#39; They cheer loudly, oblivious to the approach of a large group of riders. &#39;Stand, make no move,&#39; a woman&#39;s voice rings out. It is the Watch. One of the priests mumbles an unholy incantation. You see a wave of fear break over the women and their steeds. Some cannot control their horses, others flee, but the bravest charge the priests with loud cries of battle. The priests are unprepared: some are knocked to the ground, others make good their escape, as silently as they came. The Talisman falls to the ground, its bearer decapitated as he turns to flee. It is caught up by one of the Watch, who announces her intention of taking it to the temple of Fell-Kyrinla. They wheel their horses and ride away, leàving you to rot. You have lost the Talisman. Cursing bitterly, you resolve that if you escape you will not rest until you have [[regained it-&gt;Page 128]].</tw-passagedata><tw-passagedata pid="180" name="Page 150" tags="" position="1759,7486" size="100,100">&#39;We are the priesthood of Death,&#39; says one of the figures. &#39;We have come for what is ours.&#39; Your arms are held and you are searched. Realizing that you are not carrying the Talisman, they step back. One of them strikes you  across the face. &#39;Where is it hidden - worm?&#39; Suddenly, the clatter of hooves disturbs the menacing priests. A large group of riders carrying torches comes into sight and the priests melt back into the shadows as silently as they came. The riders of the Watch halt before you. &#39;You&#39;re in a pretty pickle. That&#39;s one less problem for us tonight, eh, girls?&#39; This provokes a gale of laughter but you fail to see the funny side as they ride off, leaving you held fast in the jaws of the [[trap-&gt;Page 128]].</tw-passagedata><tw-passagedata pid="181" name="Page 128" tags="" position="1714,7636" size="100,100">You are left alone to wonder how the law-keepers of this city could be so cruel as to leave an innocent person in such dire straits. You tear feverishly at the trap, terrified of some footpad slitting your throat for his own vile amusement. Soft footsteps approach. You look over your shoulder and see a man approaching. &#39;Here,&#39; he says, &#39;let me rescue you from this trap.&#39; He steps on the release catch, which had been out of your reach and the trap springs open. You step free and he walks along by your side. &#39;Have you a place to stay tonight? Perhaps you would like to sleep in my humble abode?&#39; he asks, looking sideways at you. You are curious that he should be walking the streets alone at night, but you are also exhausted. Will you [[accept his offer-&gt;Page 143]] and go home with him, or [[decline his offer-&gt;Page 107]]?</tw-passagedata><tw-passagedata pid="182" name="Page 143" tags="" position="1521,7664" size="100,100">The man&#39;s house is a small stone bungalow. He leads you into his bedroom and offers you a straw-filled mattress behind a curtain. Thankful for the chance to rest, you go to sleep without asking any questions. You sleep deeply and regain 4 STAMINA points. ($STAMINA: 4)You wake to find that your host is sitting watching you. &#39;I hope you are well rested. You talked in your sleep.&#39; He smiles at you and says, &#39;Do you need help? Has someone stolen something from you? How did you come to be trapped, alone on the street late at night?&#39; Do you want to [[tell him the whole story-&gt;Page 98]] and ask him for advice, or would you prefer to say that [[you cannot answer-&gt;Page 92]]?</tw-passagedata><tw-passagedata pid="183" name="Page 107" tags="monster" position="1721,7836" size="100,100">You walk off in the opposite direction. Your leg aches where the man-trap wounded you and you cannot find an inn. Unable to go any further, you curl up in an alley and sleep, despite the cold. Your awakening is rude indeed, for you are being dangled in front of the face of a huge OGRE! He grins evilly as he swings your head against the wall and drops you. Lose 2 STAMINA points. ($STAMINA: -2)If you are still alive you must fight the Ogre.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;OGRE&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 10,
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 74&quot;) [[Page 74]] ]</tw-passagedata><tw-passagedata pid="184" name="Page 98" tags="" position="1496,7181" size="100,100">You tell him everything and he listens with growing amazement. He introduces himself as Apothecus, a sage of history. &#39;I have heard of the Talisman of Death. You must recover it at all costs.&#39; He suggests that you enlist the help of the Thieves&#39; Guild, as he doesn&#39;t think you can recapture it alone. &#39;It will be in the temple to Fell-Kyrinla by now, I&#39;ll warrant. Hawkana, the High Priestess, will be holding it there. Go to the Red Dragon Inn on the Street of Seven Sins. It is dangerous, but you may make contact with the thieves there.&#39; He gives you a breakfast of savoury pancakes and invites you to dinner that evening, saying that he will try to discover more to aid you. &#39;In the meantime,&#39; he says, &#39;take these.&#39; He hands you five pieces of gold($GOLD: 5) and a ring. &#39;It is a ring which increases your skill at arms.&#39; Add 1 to your SKILL score while wearing this ring.($add_item:&quot;Apothecus&#39;s Ring&quot;)(set: $player&#39;s skill to it + 1)As you leave he gives you a jade rose.($add_item:&quot;Jade Rose&quot;) &#39;When you return this evening show this and I will know that you are not a shape-changer.&#39; You thank him for his help and leave the bungalow. Will you go to the [[Red Dragon Inn-&gt;Page 57]], or head for the [[temple-&gt;Page 221]]?</tw-passagedata><tw-passagedata pid="185" name="Page 92" tags="" position="1008,6808" size="100,100">&#39;Well if you won&#39;t trust me you must go your own way,&#39; he says brusquely. &#39;If you have lost something and wish to regain it you should contact the Thieves&#39; Guild. That type often frequents the Red Dragon Inn, on the Street of Seven Sins.&#39; You thank him and gather up your belongings. As you leave he calls after you, &#39;And don&#39;t come back, you&#39;ll only bring trouble.&#39; You go on your way wondering whether you have made a mistake: could he have helped you? You check your belongings and to your surprise find a pouch you have never seen before, containing five gold pieces.($GOLD: 5) Will you go to the [[Red Dragon Inn-&gt;Page 57]], or head for the [[temple to Fell-Kyrinla-&gt;Page 221]]?</tw-passagedata><tw-passagedata pid="186" name="Page 74" tags="" position="1447,7804" size="100,100">You stumble off through the darkness, looking for somewhere safer to rest. At last you see an empty stable. You bed down in the [[straw-&gt;Page 91]].</tw-passagedata><tw-passagedata pid="187" name="Page 88" tags="" position="249,7496" size="100,100">The barman says, &#39;You&#39;re not like my usual customers. A rough lot comes in here, most days. These fellows don&#39;t rely on charity for a crust, you know.&#39; Will you try to make friends and ask him [[how he keeps order-&gt;Page 119]], or ask him [[how they get their money-&gt;Page 102]]?</tw-passagedata><tw-passagedata pid="188" name="Page 19" tags="" position="466,7496" size="100,100">The toothless old man mutters at you. He tells you that this ale cellar is a dangerous place. Having given his warning, he shuffles fearfully away. Will you go [[back to the bar-&gt;Page 88]], or go over to the table where [[six surly-looking men-&gt;Page 280]] are sitting?</tw-passagedata><tw-passagedata pid="189" name="Page 280" tags="" position="575,7855" size="100,100">You introduce yourself to the motley group of villains. They do not reply. You persevere, saying that you only wish to speak to them for a few moments. One of them, whose face is marked by a jagged scar, running from ear to chin, fixes you with a stare and grates, &#39;We don&#39;t care for the law, so watch yourself. You could be dead before you knew we&#39;d moved.&#39; Will you: 
&lt;ul&gt;
&lt;li&gt;Ask them the way to the [[Thieves&#39; Guild-&gt;Page 145]]?&lt;/li&gt;
&lt;li&gt;Say you need help with some [[unfinished business-&gt;Page 246]]?&lt;/li&gt;
&lt;li&gt;Boldly retort that their threats [[don&#39;t scare you-&gt;Page 167]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="190" name="Page 11" tags="monster" position="979,7341" size="100,100">You stop at the bar and are about to ask the barman what there is to drink, when you hear yourself saying, &#39;You fat pig, pour me a drink before the sight of your squalid pus-ridden face makes me vomit.&#39; The barman stiffens, astonished and incensed. He gives a strangled cry of rage, grabs his club and hurdles the bar. You step back, drawing your sword. Your eyes have adjusted to the gloom and you notice that some of his customers are rìsìng to their feet. They are the most disreputable bunch of villainous-looking cut-throats you have ever seen; one has a scar running from his ear to his chin. You must fight the barman and one other.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;BARMAN&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 8,
		  &quot;special&quot;, &quot;BARMAN SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)
|win)[{If you reduce the Barman&#39;s STAMINA to 4 or less, he scurries behind the bar.
	(link-reveal: &quot;Combat continues&quot;)[
		(set: $monsters to
			(a:
				(dm:
					&quot;name&quot;, &quot;First CUT-THROAT&quot;,
					&quot;skill&quot;, 8,
					&quot;stamina&quot;, 9,
					&quot;special&quot;, &quot;CUTTHROAT SPECIAL&quot;
				)
			)
	  	)
	  	(hide: ?ATTACK_RESULTS)
	  	(show: ?MONSTER_LIST)
	  	(rerun:?MONSTER_LIST)|win)[
			If you reduce the First Cut-Throat&#39;s STAMINA to 5 or less, (display: &quot;TEST YOUR LUCK&quot;).  |lucky)[(goto: &quot;Page 200&quot;)]|unlucky)[(goto:&quot;Page 181&quot;)]
		]
	]
}](hidden:)[ [[Page 200]] [[Page 181]] ]</tw-passagedata><tw-passagedata pid="191" name="Page 200" tags="" position="871,7506" size="100,100">During the fight the brass tiger charm falls to the floor.($remove_item: &quot;Tiger Charm&quot;) Now that it is gone you realize that it was cursed and that it forced you to insult the barman.  You make no attempt to recover it.  The cut-throat yields and you are looked at with some admiration and respect. The barman tries to make light of things saying, &#39;You are truly a mighty warrior - you could even be a match for Tyutchev.&#39; He tells you the story of how Tyutchev beat Heimdol the Mighty. It seems that Heimdol was one of the strongest and most unpleasant men ever to swill ale at the Red Dragon. One day a stranger, Tyutchev, accepted his challenge to a bout of arm-wrestling. Heimdol lost for the first time in his life. He was furious and threatened awful reprisals if Tyutchev ever returned. A few nights later Tyutchev did return and began to insult Heimdol and two of his friends.  In the inevitable fight which followed, Tyutchev killed them all and carved his initials on Heimdol&#39;s forehead. &#39;He worships the God of insane chaos, Anarchil, and since that night none has dared gainsay him here.&#39; Do you want to ask the whereabouts of the [[Thieves&#39; Guild-&gt;Page 236]]? Or would you rather ask them for aid in completing some [[unfinished business-&gt;Page 246]]?</tw-passagedata><tw-passagedata pid="192" name="BARMAN SPECIAL" tags="" position="1131,7316" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s stamina &lt;= 4)[
		(set: $monsters to (a:))
		(replace: ?ATTACK_ACTIONS) [(show:?win)]
	]
}]</tw-passagedata><tw-passagedata pid="193" name="CUTTHROAT SPECIAL" tags="" position="1251,7316" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s stamina &lt;= 5)[
		(set: $monsters to (a:))
		(replace: ?ATTACK_ACTIONS) [(show:?win)]
	]
}]</tw-passagedata><tw-passagedata pid="194" name="Page 181" tags="" position="1170,7501" size="100,100">The cut-throat yields and you are looked at with some admiration and respect. The barman tries to make light of things saying, &#39;You are truly a mighty warrior... you could even be a match for Tyutchev.&#39; He tells you the story of Heimdol the Mighty. It seems that Heìmdol was one of the strongest and most unpleasant men ever to swill ale at the Red Dragon. One day a stranger, Tyutchev, accepted his challenge to a bout of arm-wrestling. Heimdol lost for the first time in his life. He was furious and threatened awful reprisals if Tyutchev ever returned. A few nights later Tyutchev did return and began to insult Heimdol and two of his friends. In the inevitable fight which followed, Tyutchev killed them all and carved his initials on Heimdol&#39;s forehead: &#39;He worships the God of insane chaos, Anarchil, and since that night none has dared gainsay him here.&#39; Do you want to ask the whereabouts of the [[Thieves&#39; Guild-&gt;Page 210]]? Or would you rather ask the cut-throats for aid in completing some [[unfinished business-&gt;Page 223]]?</tw-passagedata><tw-passagedata pid="195" name="Page 210" tags="monster key" position="1273,7642" size="100,100">Your request comes out more like a demand, spoken tersely and loudly. Nevertheless, one of them tells you that the entrance to the Thieves&#39; Guild is through an open storm-drain which leads into the sewers near Trader&#39;s Row. You gruffly tell them to meet you there at midday tomorrow.($add_key: &quot;storm-drain&quot;) You decide to leave straight away, before you insult anyone else. On your way to the door the gloom darkens as two people come down the steps from the street. The first has to stoop to avoid hitting his head. His tall wiry frame is wreathed in a cloak that seems to deepen the darkness about him. The only hint of colour is his hair, very curly and dyed bright corn-yellow. The second is a handsome young woman, dressed in a bizarre patchwork of armour. &#39;Tyutchev, Cassandra, welcome!&#39; cries the barman obsequiously. They wait for you to step out of their way. &#39;Get out of my way, ogre breath,&#39; you say before you can stop yourself. With a flash of insight you realize the brass tiger charm must be cursed. Tyutchev smiles. They step to either side of you, drawing their swords. Together they strike with the speed and grace of panthers. Tyutchev&#39;s sword is almost as tall as you are and he wields it negligently in one hand. Cassandra&#39;s glows coldly. Every time she hits you, subtract 3 STAMINA points.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TYUTCHEV&quot;,
		  &quot;skill&quot;, 10,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;TYUTCHEV SPECIAL&quot;
		),
		(dm:
		  &quot;name&quot;, &quot;CASSANDRA&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 10,
		  &quot;special&quot;, &quot;CASSANDRA SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you reduce Tyutchev&#39;s STAMINA to 4 or less, [[click here-&gt;Page 355]].]</tw-passagedata><tw-passagedata pid="196" name="Page 223" tags="monster key" position="1093,7647" size="100,100">They appear interested and offer you some ale. You accept a mug and do not drink. You suggest that in helping you they might gain a great deal. They agree to meet you and tell you to come to the Thieves&#39; Guild at midday tomorrow, vía the disguised coal-hole in Hornbeam Road.($add_key:&quot;coal-hole&quot;) You are beginning to chat to them when two newcomers enter the ale cellar. &#39;Ah! Tyutchev, Cassandra, welcome!&#39; cries the barman obsequiously. The thieves with whom you are sitting move quickly to another table. The first stranger is a very tall, wiry, man whose frame is wreathed in a black cloak which seems to deepen the darkness around him. The only hint of colour is his hair, very curly and dyed bright corn-yellow. The second is a handsome young woman dressed in a bizarre patchwork of armour. The man, Tyutchev, strolls to the bar, but the woman called Cassandra comes over and sits at your table, looking you over. &#39;Find your own table, wrinkled hag,&#39; you say before you can stop yourself. With a flash of insight you realize that the brass tiger charm must be cursed. Cassandra spits in your face and moving with the grace of a panther, draws her sword. It glows coldly and is rimed with frost. Each time she attacks successfully you lose 3 STAMINA points as biting cold sears your wound. Tyutchev merely looks on, grinning.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;CASSANDRA&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 10,
		  &quot;special&quot;, &quot;CASSANDRA SPECIAL 2&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you reduce Cassandra&#39;s STAMINA to 4 or less, [[click here-&gt;Page 342]].]</tw-passagedata><tw-passagedata pid="197" name="Page 236" tags="key" position="919,7656" size="100,100">They invite you to join them for a drink, which you do. One of them tells you that the entrance to the Thieves&#39; Guild is through an open storm-drain which leads into the sewers near Trader&#39;s Row. They will meet you there at [[midday tomorrow-&gt;Page 169]].($add_key:&quot;storm-drain&quot;)</tw-passagedata><tw-passagedata pid="198" name="Page 246" tags="key" position="738,7655" size="100,100">They appear interested and offer you some ale. You accept a mug and do not drink. You suggest that in helping you, they might gain a great deal. They agree to meet you and tell you to come to the Thieves&#39; Guild at midday tomorrow, via the disguised coal-hole in Hornbeam Road. You begin to [[chat to them-&gt;Page 169]].($add_key:&quot;coal-hole&quot;)</tw-passagedata><tw-passagedata pid="199" name="Page 119" tags="" position="268,7626" size="100,100">&#39;I manage, mostly,&#39; he says; &#39;but it puts me in mind of one time not so long ago when things really got out of hand.&#39; He goes on to tell you a story about Heimdol the Mighty. It seems that Heimdol was one of the strongest and most unpleasant men ever to have swilled beer in the Red Dragon. One day a stranger, Tyutchev, accepted his invitation to a bout of arm-wrestling. Heimdol lost for the first time in his life. He was furious and threatened awful reprisals if Tyutchev ever returned. A few nights later Tyutchev did return and began methodically to insult Heimdol and two of his friends. In the inevitable fight which followed Tyutchev killed them all and carved his initials on Heimdol&#39;s forehead. &#39;He worships the God of insane chaos, Anarchil, and since then none has dared gainsay him here, even though they are all thieves and murderers.&#39; You decide the time has come to introduce yourself to the thieves, and you walk over to [[their table-&gt;Page 280]].</tw-passagedata><tw-passagedata pid="200" name="Page 102" tags="" position="418,7626" size="100,100">The surly men around the ale cellar scowl at you. The barman says, &#39;Don&#39;t know I&#39;m sure. Why don&#39;t you ask them?&#39; and then shuts up. One of the men at the table of six says menacingly, &#39;Yes, come on and [[ask us-&gt;Page 280]].&#39;</tw-passagedata><tw-passagedata pid="201" name="TYUTCHEV SPECIAL" tags="" position="1161,7776" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s stamina &lt;= 4)[
		(set: $monsters to (a:))
		(replace: ?ATTACK_ACTIONS) [(show:?win)]
	]
}]</tw-passagedata><tw-passagedata pid="202" name="CASSANDRA SPECIAL" tags="" position="1114,7903" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &lt; _monster_roll)[($STAMINA: -1)]
}](elseif: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s stamina &lt;= 4)[
		(prepend:?ATTACK_ACTIONS)[&lt;p&gt;Cassandra drops back and Tyutchev moves in to cover her.&lt;/p&gt;]
		(set: $monsters to it - (a: _monster))
	]
}]</tw-passagedata><tw-passagedata pid="203" name="Page 355" tags="" position="1402,8028" size="100,100">Your last blow has drawn a gout of blood from Tyutchev&#39;s side. He jumps back and cries, &#39;Anarchil, breaker of edifices, aid me.&#39; Before you can strike the killing blow the cellar starts to shake. An earthquake opens great cracks in the floor. There is a roar of tumbling masonry and the inn is filled with dust. In the confusion Tyutchev and Cassandra make good their escape. When the quake has stopped you climb the steps, throwing the cursed tiger charm to the ground,($remove_item:&quot;Tiger Charm&quot;) and head out into the [[blinding sunlight-&gt;Page 289]].</tw-passagedata><tw-passagedata pid="204" name="Page 342" tags="monster" position="972,8029" size="100,100">Tyutchev steps between you. His sword is almost as tall as you and he hefts it negligently in one hand. Cassandra steps back, clasping her arm. &#39;You&#39;ve a difficult fight on your hands, Tyutchev,&#39; she gasps.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TYUTCHEV&quot;,
		  &quot;skill&quot;, 10,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;TYUTCHEV SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you reduce Tyutchev&#39;s STAMINA to 4 or less, [[click here-&gt;Page 355]].]</tw-passagedata><tw-passagedata pid="205" name="CASSANDRA SPECIAL 2" tags="" position="1226,7900" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &lt; _monster_roll)[($STAMINA: -1)]
}](elseif: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s stamina &lt;= 4)[
		(set: $monsters to (a:))
		(replace: ?ATTACK_ACTIONS) [(show:?win)]
	]
}]</tw-passagedata><tw-passagedata pid="206" name="Page 169" tags="" position="775,8055" size="100,100">Two newcomers enter the Red Dragon ale cellar. The first is a very tall, wiry, man whose frame is draped in a black cloak. The only hint of colour is his hair, very curly and dyed bright corn-yellow. The second is a handsome young woman dressed in a bizarre patchwork of armour. The barman mutters under his breath, then forces his face into a smile. ‘Tyutchev, Cassandra, welcome!” he shouts obsequiously. The thieves move away from you to sit at another table. Tyutchev strolls to the bar and orders a drink. Cassandra sits opposite you, at your table. She ignores you and Tyutchev joins her. Will you:
&lt;ul&gt;
&lt;li&gt;[[Say nothing-&gt;Page 2]]?&lt;/li&gt;
&lt;li&gt;[[Get up and leave-&gt;Page 363]] the ale cellar?&lt;/li&gt;
&lt;li&gt;[[Introduce yourself-&gt;Page 374]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="207" name="Page 289" tags="" position="1381,8301" size="100,100">You step out, squinting against the bright light of the late afternoon sun. Add 1 LUCK point for visiting the Red Dragon Inn and living to tell the tale.($LUCK:1) You are back in the Street of Seven Sins. If you have met a Sage and he has invited you to dinner, you may now (link-reveal:&quot;go to meet him&quot;)[(if: $inventory contains &quot;Jade Rose&quot;)[(goto: &quot;Page 229&quot;)](else:)[(dialog:&quot;You have had no such invitation.&quot;)] ]. If you have not been invited, or do not wish to go, you may go down a side street called [[Cobbler&#39;s Walk-&gt;Page 195]], heading west, or go down [[Merchant Street-&gt;Page 394]], heading north-west.(hidden:)[[Page 229]]</tw-passagedata><tw-passagedata pid="208" name="Page 195" tags="monster" position="1621,8456" size="100,100">You continue along Cobbler’s Walk, turning a corner or two. Suddenly, a body comes crashing through a nearby window into the street. Splinters of glass fly everywhere, but you are unharmed.  Moving closer you see the mangled corpse of a man dressed in black robes covered with odd symbols. A door to the nearby house bursts open and a man dressed in a silver robe with black symbols, runs into the street screaming, ‘Flee! Run for your life!’ as he disappears. In the open doorway a monstrous figure now stands. It springs at you with a demonic howl. It is three metres high, with the head and hind legs of an elk. Its bloated humanoid torso is mottled blue and grey and its breath clouds the air with crystals of ice. It points at you and a gale of freezing sleet hits you. The chill is almost crippling - lose 3 STAMINA points.($STAMINA:-3) If you are still alive, the Demon reaches for you with its powerful talons. You must fight it.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;ICE DEMON&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 10
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto:&quot;Page 61&quot;)[[Page 61]].]</tw-passagedata><tw-passagedata pid="209" name="Page 394" tags="" position="1752,8465" size="100,100">You pass several markets where grain-merchants are dealing, but one small, drab shop looks more interesting — a board announces ‘Alembic the Alchemist’. There is nothing in the window but a small plate with what look like five hazel nuts on it, and a stuffed lynx. Peering in, you see a man dressed in a white, sleeveless robe with a phoenix rising from flames embroidered on it. Will you [[enter the shop-&gt;Page 372]], or [[go on your way-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="210" name="Page 145" tags="" position="351,7921" size="100,100">Scarface says, &#39;What do you mean? Are you suggesting we are thieves?&#39; There is an edge in his voice and a tension among his comrades, two of whom have their hands upon their daggers. Will you:
&lt;ul&gt;&lt;li&gt;Hotly [[deny it-&gt;Page 272]]?&lt;/li&gt;
&lt;li&gt;Say that [[you are-&gt;Page 281]]?&lt;/li&gt;
&lt;li&gt;Ignore this, and say you have [[valuable information-&gt;Page 246]] for them?&lt;/li&gt;&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="211" name="Page 167" tags="monster" position="465,8106" size="100,100">Their eyes narrow and suddenly a terrible pain shoots into your kidneys. A thief has crept up silently behind you and knifed you in the back (lose 6 STAMINA points).($STAMINA: -6)If you are still alive, you whirl round and back to the bar. You see a wiry young man holding a dagger dripping with your blood. The thieves close in but with your back to the bar only three can attack you. You must fight all three at once.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;BACK-STABBER&quot;,
		  &quot;skill&quot;, 6,
		  &quot;stamina&quot;, 6,
		),
		(dm:
		  &quot;name&quot;, &quot;SCARFACE&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 9,
		),
		(dm:
		  &quot;name&quot;, &quot;Second CUT-THROAT&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 8,
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[]</tw-passagedata><tw-passagedata pid="212" name="Page 272" tags="" position="276,8071" size="100,100">&#39;Well, how would we know, then?&#39; says Scarface. The others laugh at you and turn their backs. Do you want to [[go back to the barman-&gt;Page 295]] and ask him the way to the Thieves&#39; Guild? Or would you rather [[tap Scarface on the shoulder-&gt;Page 167]] and say, &#39;Come on now, I won&#39;t tell anyone&#39;?</tw-passagedata><tw-passagedata pid="213" name="Page 281" tags="key" position="606,7986" size="100,100">Scarface laughs. They remove their hands from their daggers and a young man appears from behind you and sits down. ‘Of course we are thieves,&#39; he says. ‘What is the Red Dragon if not a den of thieves?’ They invite you to join them for a drink, which you do. One of them tells you that the entrance to the Thieves’ Guild is through an open storm-drain which leads into the sewers near Trader&#39;s Row. You ask if it is possible to go there right away, but they say no and you agree to meet them there at midday tomorrow. [[You begin to chat-&gt;Page 169]].($add_key:&quot;storm-drain&quot;)</tw-passagedata><tw-passagedata pid="214" name="Starting Equipment" tags="" position="1100,1584" size="100,100">You will start your adventure with a bare minimum of equipment, but you may find or buy other items during your travels. You are armed with a sword and are dressed in leather armour. You have a backpack to hold your Provisions and any treasures you may come across.
In addition, you may take one bottle of a magic potion which will aid you on your quest. You may choose to take a bottle of any of the following:
&lt;ul&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Skill&quot;)[($add_item:&quot;Potion of Skill&quot;)(show:?continue)] - restores SKILL points&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Strength&quot;)[($add_item:&quot;Potion of Strength&quot;)(show:?continue)] - restores STAMINA points&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Fortune&quot;)[($add_item:&quot;Potion of Fortune&quot;)(show:?continue)] - restores LUCK points and adds 1 to Initial LUCK&lt;/li&gt;
&lt;/ul&gt;
These potions may be taken at any time during your adventure (except when engaged in a Battle). Taking a measure of potion wìll restore SKILL, STAMINA or LUCK scores to their Initial level (and the Potion of Fortune will add 1 point to your Initial LUCK score before LUCK is restored).
Each bottle of potion contains enough for one measure, i.e. the characteristic may be restored once during an adventure. Make a note on your Adventure Sheet when you have used up a potion. Remember also that you may only choose &lt;i&gt;one&lt;/i&gt; of the three potions to take on your trip, so choose wisely!
To explore the network of caves and tunnels and to combat the terrors of the night, you are also equipped with five torches. To light them you have a flint and tinder - guard them with your life!
|continue)[(if: $show_intro is 1)[(goto: &quot;Intro 1&quot;)](else:)[(goto: &quot;Page 1&quot;)]]</tw-passagedata><tw-passagedata pid="215" name="Page 262" tags="" position="2003,7271" size="100,100">As you open the book, the scales glitter and seem to change colour. Its title is &lt;i&gt;Tome of Misfortune&lt;/i&gt; and the letters on the page seem to glow ominously. You shut the book, but it is too late. You can feel the malice of evil magic. You are the victim of some ancient curse! Lose 1 LUCK point. ($LUCK:-1)You leave the Guilds of Learning in [[disgust-&gt;Page 186]].</tw-passagedata><tw-passagedata pid="216" name="Page 2" tags="" position="526,8331" size="100,100">There is an uneasy silence in the ale cellar. Tyutchev looks across at you and says, &#39;I don&#39;t like your face.&#39; Cassandra nods agreement. Do you retort, &#39;At least, unlike you, [[I am wholesome to look upon-&gt;Page 294]]?&#39;  Or will you meekly reply, &#39;I&#39;m sorry, [[I was born that way-&gt;Page 305]],&#39; and leave the ale cellar?</tw-passagedata><tw-passagedata pid="217" name="Page 363" tags="" position="706,8389" size="100,100">‘Stay! says Tyutchev, arrogantly gesturing you back to your seat. Will you [[keep going-&gt;Page 316]], or do as he bids and [[return to your stool-&gt;Page 374]]?</tw-passagedata><tw-passagedata pid="218" name="Page 374" tags="" position="888,8612" size="100,100">They tell you their names are Tyutchev and Cassandra.  Tyutchev says, &#39;You are a newcomer - what brings you to the Red Dragon?&#39; The beautiful Cassandra takes a dagger from her boot and starts to toss it end over end, catching it each time by the tip. As you consider your answer she tosses it again but does not catch it. It buries itself in the table, a centimetre from your hand. Will you:
&lt;ul&gt;&lt;li&gt;Say that you wish to meet some [[thieves-&gt;Page 340]]?&lt;/li&gt;
&lt;li&gt;Say you came in for [[a drink-&gt;Page 386]]?&lt;/li&gt;
&lt;li&gt;Tell him to [[mind his own business-&gt;Page 397]]?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="219" name="Page 295" tags="" position="277,8327" size="100,100">The barman says, &#39;I will tell you, but it will cost you six gold pieces and not a silver less.&#39; ($if: $player&#39;s gold &gt;= 6)[Will you [[pay him-&gt;Page 323]]?] If you do not have the money or do not wish to pay him, [[click here-&gt;Page 312]].</tw-passagedata><tw-passagedata pid="220" name="Page 323" tags="key" position="985,8215" size="100,100">He takes the money greedily($GOLD:-7) and says, ‘The entrance lies through an open storm-drain which leads into the sewers near Trader&#39;s Row. I wouldn&#39;t go there now, if I were you, but it will be safe around midday tomorrow.&#39;($add_key:&quot;storm-drain&quot;) You thank him and prepare to leave.  Just then, two new customers enter the gloomy ale cellar. The first is a very tall, wiry, man whose frame is wreathed in a black cloak which seems to deepen the darkness around him. The only hint of colour is his hair, very curly and dyed bright corn-yellow. The second is a handsome young woman dressed in a bizarre patchwork of armour. The barman mutters under his breath and then forces his face into a smile. ‘Tyutchev, Cassandra, welcome!” he shouts obsequiously. He moves to the other end of the bar to serve Tyutchev, who orders a carafe of Spirits of Ra. Cassandra sits at a nearby empty table and Tyutchev joins her. Will you:
&lt;ul&gt;
&lt;li&gt;Turn away from the bar and [[leave-&gt;Page 363]]?&lt;/li&gt;
&lt;li&gt;Sit down and [[finish your ale-&gt;Page 2]]?&lt;/li&gt;
&lt;li&gt;[[Introduce yourself-&gt;Page 374]] to Tyutchev and Cassandra?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="221" name="Page 312" tags="" position="124,8041" size="100,100">Unfortunately the thieves have overheard you. The youngest moves soundlessly behind you, hidden by one of the tapestries. A searing pain rips into your back. He has stabbed you with a poisoned dagger. You [[sink to the floor-&gt;Page 109]], unable to move. The young thief callously pockets your purse.</tw-passagedata><tw-passagedata pid="222" name="Page 294" tags="" position="427,8565" size="100,100">At this they leap up, whipping out their blades, and move to [[attack-&gt;Page 368]].</tw-passagedata><tw-passagedata pid="223" name="Page 305" tags="" position="577,8565" size="100,100">As you walk across the sawdust-covered tiles towards the door, you hear Tyutchev say to the barman, &#39;Who was that frightened rabbit?&#39; He walks over to the thieves. Do you want to [[hurry out-&gt;Page 289]] of this den of thieves, thankful to be alive, or [[draw your sword-&gt;Page 294]] and shout &#39;Who&#39;s frightened?&#39;</tw-passagedata><tw-passagedata pid="224" name="Page 316" tags="" position="289,8557" size="100,100">&#39;You don&#39;t walk out on Tyutchev!&#39;  They leap up, whipping out their blades, and move to [[attack-&gt;Page 368]].</tw-passagedata><tw-passagedata pid="225" name="Page 368" tags="monster" position="525,8750" size="100,100">Tyutchev’s sword is almost as tall as you are and he wields it negligently in one hand. Cassandra&#39;s glows coldly. Each time she hits you must subtract 3 STAMINA points.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TYUTCHEV&quot;,
		  &quot;skill&quot;, 10,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;TYUTCHEV SPECIAL&quot;
		),
		(dm:
		  &quot;name&quot;, &quot;CASSANDRA&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 10,
		  &quot;special&quot;, &quot;CASSANDRA SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[If you reduce Tyutchev&#39;s STAMINA to 4 or less, [[click here-&gt;Page 353]].]</tw-passagedata><tw-passagedata pid="226" name="Page 340" tags="" position="1072,8799" size="100,100">&#39;I am a thief, among other things,&#39; says Tyutchev. &#39;Why do you wish to meet thieves?&#39; You tell him that you have some unfinished business and need some help. &#39;Ah yes,&#39; he says, &#39;but I am needed at my temple. I am not interested.&#39; Will you [[take your leave-&gt;Page 289]] and go up the steps out into the street, or mention that the business involves the [[Talisman of Death-&gt;Page 327]]?</tw-passagedata><tw-passagedata pid="227" name="Page 386" tags="" position="922,8797" size="100,100">&#39;Alone?&#39; inquires Tyutchev. &#39;Strangers don&#39;t come to the Red Dragon just for a drink. Don&#39;t you know we&#39;re all thieves? What are you up to?&#39; Will you tell him to [[mind his own business-&gt;Page 397]], or apologize, say you must have made a mistake and [[leave-&gt;Page 289]]?</tw-passagedata><tw-passagedata pid="228" name="Page 397" tags="" position="760,8796" size="100,100">&#39;I think you&#39;re going to regret that,&#39; says Tyutchev between gritted teeth. Cassandra says, softly, &#39;I think, stranger, it would be better if you begged his pardon, don&#39;t you?&#39; What will you say: &#39;I&#39;ll [[not apologize-&gt;Page 294]] to the likes of him&#39;, or ‘Oh yes, [[I beg your pardon-&gt;Page 337]]’?</tw-passagedata><tw-passagedata pid="229" name="Page 229" tags="" position="2336,8471" size="100,100">On your way towards the Sage’s house a small boy runs up to you and asks if you would like to help a very clever scholar and make some money doing it.
&#39;It won&#39;t take long,&#39; he adds, tugging at your sleeve. Do you want to thank him, but decline and [[go on your way-&gt;Page 273]], or will you [[go with the boy-&gt;Page 216]]?</tw-passagedata><tw-passagedata pid="230" name="Page 61" tags="" position="1457,8621" size="100,100">You have banished the Ice Demon to the plane from which it came, through defeating it in combat. The shards of broken glass crunch underfoot. Will you [[enter the house-&gt;Page 49]] it came from, or continue down [[Cobbler’s Walk-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="231" name="Page 372" tags="" position="1775,8615" size="100,100">Alembic greets you and says cheerfully, &#39;You look like an adventurous person. Would you like to buy something?&#39; You inquire what he has to offer. He shows you the following things, each marked with a price. Do you want to buy:($GOLD: 50)
(display: &quot;APOTHECARY MENU&quot;)
Or would you rather turn and [[leave-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="232" name="Page 28" tags="" position="1572,8957" size="100,100">You turn down Carriage Street and see the sign of an inn, the Silver Trinket. It is next to a large stable and work-house. It seems a much more pleasant place than the Red Dragon Inn and, as it is growing late, you decide to [[go in-&gt;Page 15]].</tw-passagedata><tw-passagedata pid="233" name="Page 273" tags="" position="2424,8751" size="100,100">You come to the door of the Sage&#39;s house and knock. After a few moments a manservant opens the door. You explain that you have come to see the Sage. The manservant asks you for the (link-reveal:&quot;token&quot;)[(if: $inventory contains &quot;Jade Rose&quot;)[(goto: &quot;Page 6&quot;)[[Page 6]] ](else:)[(goto: &quot;Page 131&quot;)[[Page 131]] ]].</tw-passagedata><tw-passagedata pid="234" name="Page 216" tags="" position="2619,8616" size="100,100">The boy leads you to the Guilds of Learning. You hurry down a cloister, which surrounds a square of tall grass speckled with scarlet poppies, and on towards a huge greenhouse made of tarred wood and glass. Two scholars wearing the pale blue robes of the Sages come out to greet you. One is spindly and bald, the other is very chubby and peers at you through his pince-nez. They are obviously pleased to see you and introduce themselves as Moreau and Polonius. The fat one, Polonius, asks you to come with them, if you would like to earn twenty gold pieces for twenty minutes&#39; work. Will you [[go with them-&gt;Page 182]] into the greenhouse, or [[politely decline-&gt;Page 273]] and go back to the Sage&#39;s house?</tw-passagedata><tw-passagedata pid="235" name="Page 353" tags="" position="1012,8423" size="100,100">Your last blow has drawn a gout of blood from Tyutchev’s side. He jumps back and says, ‘Anarchil, breaker of edifices, aid me.” He is calling upon his God. Before you can strike the killing blow the cellar starts to shake. An earthquake opens great cracks in the floor. There is a roar of tumbling masonry and the inn is filled with dust. In the confusion, Tyutchev and Cassandra make good their escape. When the quake has stopped you climb the steps and [[leave-&gt;Page 289]].</tw-passagedata><tw-passagedata pid="236" name="Page 327" tags="" position="1138,8950" size="100,100">They betray a flicker of interest. Tyutchev calmly says, &#39;I have no time for such adventures,&#39; but his curiosity is obvious. You begin to think you may have made a mistake in telling them and get up to leave. As you climb the steps to the [[street-&gt;Page 289]] you see Tyutchev walking over to the thieves.</tw-passagedata><tw-passagedata pid="237" name="Page 337" tags="" position="760,8946" size="100,100">They seem to lose interest in you and leave your table to talk to the six thieves. You decide to [[leave the Red Dragon-&gt;Page 289]], while you still can.</tw-passagedata><tw-passagedata pid="238" name="Page 49" tags="" position="1376,8776" size="100,100">You walk through the front door, which is glistening with frost. A trail of frost leads from the door to a large pentacle chalked on the floor. Sand is strewn where the frost crosses the edge of the pentacle. On a table lie various strange pieces of equipment. On the floor next to it lies an (link-reveal:&quot;Amulet&quot;)[($add_item: &quot;Unicorn Horn Amulet&quot;)], made from the tip of a Unicorn’s Horn, with strange runes engraved on it. You may take it if you wish. There appears to be nothing else of any use to you, so you [[leave-&gt;Page 28]].</tw-passagedata><tw-passagedata pid="239" name="Page 360" tags="" position="1754,8773" size="100,100">($GOLD:-12)The alchemist gives you the bottle in exchange for the gold, telling you to drink it while it is fresh. You decide to do so there and then. It has the pungent odour of wild garlic. Drinking it, you feel invigorated. Increase your Initial STAMINA score by 2 points. You can now restore your STAMINA to this new maximum.(set: $player&#39;s max_stamina to it + 2)(set: $player&#39;s stamina to $player&#39;s max_stamina) You feel your money has been well spent as you have been given a new lease of life. If you have any money left, you may purchase any other items which you haven&#39;t tried.
(display: &quot;APOTHECARY MENU&quot;)
Or are you ready to leave and [[continue on your way-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="240" name="Page 306" tags="" position="1890,8775" size="100,100">The alchemist gives you the jar of ointment in exchange for the gold. &#39;Rub it into your arms and chest right away. It will make your skin as tough as bark for a week.&#39; You take his advice. As soon as you have rubbed on all the ointment, your skin begins to burn. The pain is excruciating and your skin blisters. Lose 2 STAMINA points. ($STAMINA: -2)If you are still alive, Alembic says, mildly concerned, &#39;Alas, something must have curdled. It will pass. I am a fair man. Here are your seven gold pieces. Perhaps you would like to try something else?&#39; You accept your money back. If you have not tried them already, you can buy any of his other wares:
(display: &quot;APOTHECARY MENU&quot;)
Or would you rather [[leave his shop-&gt;Page 28]] in disgust?</tw-passagedata><tw-passagedata pid="241" name="Page 266" tags="" position="2015,8771" size="100,100">($GOLD:-10)The alchemist gives you the Fortunate Luckstone in exchange for the gold. You can feel its power when he hands it to you. Add 1 to your LUCK score.($LUCK:1)($add_item: &quot;Luckstone&quot;) If you have not tried them already, you can buy any of his other wares:
(display: &quot;APOTHECARY MENU&quot;)
Or are you ready to leave and [[continue on your way-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="242" name="Page 233" tags="" position="2166,8771" size="100,100">($GOLD:-10)($add_item:&quot;Vapours of Speed&quot;)The alchemist gives you the Vial of Vapours of Speed in exchange for the gold, telling you to inhale the Vapours when you wish to speed up your actions. If you have any money left, you can buy any of his other wares which you haven&#39;t tried:
(display: &quot;APOTHECARY MENU&quot;)
Or are you ready to leave and [[continue on your way-&gt;Page 28]]?</tw-passagedata><tw-passagedata pid="243" name="APOTHECARY MENU" tags="" position="1900,8610" size="100,100">&lt;ul&gt;[{
(unless: (history:) contains &quot;Page 360&quot; or (passage:)&#39;s name is &quot;Page 360&quot;)[&lt;li&gt;A small potion-bottle marked &#39;(link-repeat:&quot;Elixir of Life&quot;)[(if: $player&#39;s gold &gt;= 12)[(goto: &quot;Page 360&quot;)[[Page 360]] ](else:)[(dialog:&quot;You do not have enough gold&quot;)]]&#39; for 12 gold pieces?&lt;/li&gt;]
(unless: (history:) contains &quot;Page 306&quot; or (passage:)&#39;s name is &quot;Page 306&quot;)[&lt;li&gt;A jar of ointment labelled &#39;(link-repeat:&quot;Barkskin&quot;)[(if: $player&#39;s gold &gt;= 7)[(goto: &quot;Page 306&quot;)[[Page 306]] ](else:)[(dialog:&quot;You do not have enough gold&quot;)]]&#39; for 7 gold pieces?&lt;/li&gt;]
(unless: (history:) contains &quot;Page 266&quot; or (passage:)&#39;s name is &quot;Page 266&quot;)[&lt;li&gt;A &#39;(link-repeat:&quot;Fortunate Luckstone&quot;)[(if: $player&#39;s gold &gt;= 10)[(goto: &quot;Page 266&quot;)[[Page 266]] ](else:)[(dialog:&quot;You do not have enough gold&quot;)]]&#39; for 10 gold pieces?&lt;/li&gt;]
(unless: (history:) contains &quot;Page 233&quot; or (passage:)&#39;s name is &quot;Page 233&quot;)[&lt;li&gt;A small vial labelled &#39;(link-repeat:&quot;Vapours of Speed&quot;)[(if: $player&#39;s gold &gt;= 10)[(goto: &quot;Page 233&quot;)[[Page 233]] ](else:)[(dialog:&quot;You do not have enough gold&quot;)]]&#39; for 10 gold pieces?&lt;/li&gt;]
}]&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="244" name="Page 6" tags="" position="2391,9009" size="100,100">The servant says, &#39;Ah yes, you are expected. Please come in.&#39; You follow him into the parlour. The dining-table is laid for three. Apothecus rises to greet you and introduces you to his friend, Diodorus, a Sage who is an expert on travel between the planes of existence. He tells you that there are portals or gates, allowing travel between Orb and other worlds. He suspects that you may have been brought from Earth to Orb by means of such a portal. &#39;When you recover the Talisman,&#39; he says, &#39;you must leave Greyguilds and walk south-east until you come to the Great Plateau. Mount Star-reach, the tallest mountain on the plateau, has, at its summit, one of these portals, through which you must pass if you wish to return to Earth.&#39; 
&#39;And now to more immediate matters,&#39; says Apothecus. &#39;You can leave the city by the postem gate in the cemetery.($add_key:&quot;Cemetery&quot;) If you get into serious trouble you may be able to call on the All-Mother for aid. To do so cry, &quot;All-Mother, nature herself, preserve me.&quot;&#39; He makes you repeat the words and you commit them to memory; note them on your Adventure Sheet. He explains that the All-Mother is the Fountain of all Life, the opposite of Death. She may be prepared to help you, but only once, at the time of your greatest need. &#39;However, remember this: no deity can intervene in another&#39;s temple.&#39; You thank them both and turn in early after the sumptuous meal of peacock basted in Spirits of Ra, and other exotic dishes. You wake up refreshed -gain 4 STAMINA points.($STAMINA: 4) You bid Apothecus farewell, thanking him for all his help and hoping that you won&#39;t let him down. You set out to find the [[Thieves&#39; Guild-&gt;Page 64]].</tw-passagedata><tw-passagedata pid="245" name="Page 131" tags="" position="2227,8919" size="100,100">Realizing that you cannot stay with the Sage, you set out to find [[a bed for the night-&gt;Page 28]].</tw-passagedata><tw-passagedata pid="246" name="Page 182" tags="" position="2774,8749" size="100,100">&#39;We are scholars,&#39; says Moreau excitedly. &#39;Vivisection is our field of study. We use surgery and magic to create new forms of life. Just wait till you see our creation.&#39; They take you to a large sunken pit in the middle of the massive greenhouse. The pit is ringed at the top with downward pointing spikes. They lower a ladder and you all descend into it. In a barred cage at the edge of the pit is a most loathsome sight. The scholars&#39; creation is a massive beast with the body of a giant cockroach, six giant arms for legs and two heads, one above the other. The top one is the head of a crocodile and below is the warty face of an ogre. &#39;Isn&#39;t she beautiful?&#39; says Moreau. Polonius says, ‘We need a valiant warrior to test her. We want her to be used as a war-beast. Do not worry, though; the minute she looks like harming you, Polonius here will put her to sleep with a special spell.&#39; The ogre face, which looks distinctly male, roars and slavers. Do you want to say, &#39;Thank you, no, [[I&#39;m not fighting that-&gt;Page 201]],&#39; and leave immediately, or would you rather say, &#39;This should be interesting,&#39; and prepare to [[fight the beast-&gt;Page 189]]?</tw-passagedata><tw-passagedata pid="247" name="Page 201" tags="monster" position="2699,8899" size="100,100">&#39;Ah well, that&#39;s a pity,&#39; says Polonius, and presses the far wall of the pit. With a great clang bars spring up between you and the two scholars. To your horror you see that at the same time the bars separating you from their awful creation have slid into the ground. The beast comes towards you, intent on turning you into a meal. You must fight the VIVISECT. The scholars produce wax tablets and begin to take notes.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;VIVISECT&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;VIVISECT SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 176&quot;)[[Page 176]]]</tw-passagedata><tw-passagedata pid="248" name="Page 189" tags="monster" position="2849,8899" size="100,100">&#39;Excellent, excellent,&#39; enthuses Moreau. They climb the ladder and draw it up behind them. With a clang the bars of the cage slide into the ground. The beast comes towards you, intent on making you its next meal. You must fight the VIVISECT. The Sages produce wax tablets and begin to take notes. (set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;VIVISECT&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;VIVISECT SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 176&quot;)[[Page 176]]]</tw-passagedata><tw-passagedata pid="249" name="Page 15" tags="" position="1787,9029" size="100,100">The taproom of the inn is empty. You ask for a hot meal and a room for the night. The innkeeper tells you that this will cost you (link-reveal:&quot;three pieces of gold&quot;)[($GOLD: -3)], but says that he is short-handed and that if you will (link-reveal:&quot;do the washing-up&quot;)[] he will let you stay for nothing. The choice is yours. You have a delicious meal of roast hippogriff in cream sauce. After your meal you sleep like a log and wake up feeling refreshed. Gain 4 STAMINA points.($STAMINA: 4) You set out in search of the [[Thieves’ Guild-&gt;Page 64]].</tw-passagedata><tw-passagedata pid="250" name="Page 64" tags="" position="2065,9057" size="100,100">As you set off, you see a small group of people clustered around a man wearing a flowing grey cloak and one dangling gold ear-ring. He is making huge bunches of flowers appear and disappear to cries of delight and amusement from the crowd. Will you:
[{&lt;ul&gt;
&lt;li&gt;Try to find a way into the [[Thieves’ Guild-&gt;Page 83]]?&lt;/li&gt;
&lt;li&gt;Try to regain the Talisman [[on your own-&gt;Page 383]]?&lt;/li&gt;
&lt;li&gt;Stay and [[watch the magic-&gt;Page 106]]?&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="251" name="Page 176" tags="" position="2659,9071" size="100,100">The vile monstrosity sinks to the ground, squelching in a pool of blood and green ichor. The stench of its spilled entrails is nauseating. The sages are woebegone at the death of their creation, but they help you out of the pit. &#39;I&#39;m sorry,&#39; says Moreau, &#39;my spell did not work. What a shame you had to kill her.&#39; You shake your head at their madness and ask for your gold. Polonius dives his hands into various pockets and folds of his robes, a look of consternation crossing his features. He is about to make some excuse, when he sees your growing anger. Eventually, he offers you a magic scroll as payment instead.($add_item:&quot;Scroll of Doom&quot;) It contains a Spell of Agonizing Doom, which you can use once only. You accept, take your leave, and head for the [[house of the Sage-&gt;Page 273]].</tw-passagedata><tw-passagedata pid="252" name="VIVISECT SPECIAL" tags="" position="2873,9051" size="100,100">(if: $combat_stage is &quot;post-combat&quot;)[{
	(append: ?ATTACK_ACTIONS)[
		You can [[appeal for help-&gt;Page 158]] at any time.
	]
}]</tw-passagedata><tw-passagedata pid="253" name="Page 158" tags="" position="2873,9201" size="100,100">You ask the scholars to use their spell. &#39;Something appears to be wrong,&#39; mumbles Moreau guiltily. The spell is not working. Out of the corner of your eye you can see him gesticulating as if casting a spell, but the beast is unaffected. You must fight it to the death.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;VIVISECT&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, $monsters&#39;s 1st&#39;s stamina
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 176&quot;)[[Page 176]]]</tw-passagedata><tw-passagedata pid="254" name="Page 83" tags="" position="2722,9459" size="100,100">Have you been told about the (link-reveal:&quot;storm-drain&quot;)[(show:?1)]?
|1)[(if: $keyring contains &quot;storm-drain&quot;)[[[You have-&gt;Page 183]].](else:)[[[You have not-&gt;Page 149]].]]</tw-passagedata><tw-passagedata pid="255" name="Page 383" tags="" position="2222,7306" size="100,100">You spot one of the warrior-women who you know are members of the temple of Fell-Kyrinia. Hoping she is on her way to the temple, you follow her at a distance. Eventually, you come to a building made of a white stone, with dark grey columns. Steps lead up to the entrance between two pillars and there is a guard at the top. What will you do:
[{&lt;ul&gt;
&lt;li&gt;[[Attack the guard-&gt;Page 234]]?&lt;/li&gt;
&lt;li&gt;Tell her you have a message for the [[High Priestess-&gt;Page 202]]?&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="256" name="Page 106" tags="" position="1730,9304" size="100,100">The magician conjures up a cloud of blue, green and pink smoke, which engulfs the spectators. While you watch, Tyutchev, the man from the Red Dragon Inn, appears from the shadows and enters the smoke. By the time it clears neither he nor the magician in the grey robes are anywhere to be seen, but the members of the crowd are accusing one another, between coughing fits, of being cutpurses. You realize that Tyutchev and the magician are in cahoots. As you turn to leave, a servant places a silver salver under your nose. It bears a gold-embossed card inviting you to take sherry with one Mortphilio. ‘This way if you please,” says the man. You ask who Mortphilio is and he replies, ‘One of the elders of the city,” but says no more. Will you [[go with him-&gt;Page 144]], or [[decline-&gt;Page 83]] the invitation?</tw-passagedata><tw-passagedata pid="257" name="Page 144" tags="monster" position="1730,9454" size="100,100">You are led along tree-lined avenues, through a quarter of the city you have not yet visited. Ahead of you is a large gothic building with pinnacles surmounted by bat-like gargoyles. Before you reach it, the servant leads you into a nearby house. You follow him through to a dark parlour at the back.
The walls are made of pale bamboo and in a gloomy corner a decrepit-looking invalid is sitting in a bath-chair, most of his form hidden under blankets. The servant lights four large black candles before leaving you alone with Mortphilio. &#39;Thank you for coming. It is seldom that I entertain anyone who looks so vital and full of life.&#39; His voice is hoarse and he finds it an effort to speak. The smoke from the candles makes you feel sleepy, but you are startled back to full awareness when a human skull on the mantelpiece starts to talk. &#39;This is the one, master.&#39; At a command from Mortphilio, the skull lifts off the mantelpiece and hovers, shadowy wings holding it aloft. &#39;Kill,&#39; says the necromancer and the skull hurtles towards you, jaws snapping. You must fight the WINGED SKULL.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;WINGED SKULL&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 6
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 396&quot;)[[Page 396]]]</tw-passagedata><tw-passagedata pid="258" name="Page 396" tags="" position="1730,9604" size="100,100">You smash the skull into splinters of bone, but Mortphilio has not been idle. The walls of the parlour are not bamboo but are made from the bones of the necromancer’s victims. He summons them forth to attack you. He is soon surrounded by skeletal warriors and you decide to run before you are overwhelmed. The only clear way is down a long stone corridor that leads to an archway across which a black blanket is draped. You run through, pushing the blanket aside and catch your breath in [[amazement-&gt;Page 97]].</tw-passagedata><tw-passagedata pid="259" name="Page 97" tags="" position="1730,9754" size="100,100">You have run into the gothic building you saw from the road. It is the temple of Death and a huge congregation is taking part in a religious ceremony.  Hundreds of black-cowled figures kneel at prayer in the dark, vaulted church. The black candles shed enough light for you to see that many of them have embraced Death already. Quickly, you swathe yourself in one of the black robes of worship hanging by the arch. The organ sounds a loud and doleful chord and the high priest, Somnus, is invited to begin. He raises his arms and his voice echoes round the vaults as he chants an invocation in the same doleful tones. The altar is suffused with red light and a phantom lake of boiling blood appears. Emerging from the lake are six mounted wraiths, hunched figures cloaked in a pall of evil. The blood pours from them as they spur their black hell-steeds into the aisle. Somnus cries, ‘I charge you, Instruments of Death, to recover the Talisman!” In unison the long-dead lords reply, their voices harsh with the hatred of ages, ‘It shall be done.’ The congregation sighs with a mixture of fear and awe. You notice one of them walking to the back of the church where he places a helmet on his head and disappears completely. Will you:
[{&lt;ul&gt;
&lt;li&gt;Melt into the congregation and [[kneel down-&gt;Page 157]]?&lt;/li&gt;
&lt;li&gt;Make a [[run for the door-&gt;Page 188]]?&lt;/li&gt;
&lt;li&gt;Put on one of the [[helmets-&gt;Page 165]]?&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="260" name="Page 157" tags="" position="2045,9905" size="100,100">You kneel at the end of a row of worshippers. A golden chalice is being passed along and each member of the congregation drinks from it. Your neighbour drinks with relish and then turns to you; his face is waxen and white, but his eyes are crimson and bloodshot. Blood drips from his vampire fangs. He hands you the chalice and you have to drink. It is human blood, cursed in Death’s name. It curdles in your stomach, and you are seized by a palsy and lose 4 STAMINA points.($STAMINA: -4) If you are still alive, you see the wraiths ride into the inner chapel, accompanied by Somnus, and the congregation begins to file out. You manage to gain the street without being noticed and, flinging the black robe away, you set out in search of the [[Thieves’ Guild-&gt;Page 83]].</tw-passagedata><tw-passagedata pid="261" name="Page 188" tags="death" position="1730,9904" size="100,100">You run for the door to the street at the back of the church. Somnus sees you and points majestically.  &#39;Die,&#39; he whispers. A huge dark figure appears before you, a great black sword in its hand.  It has black wings of shadow and a tall white crest sweeps back from the black helmet which hides its features. Your heart palpitates wildly and then stops beating. The mere sight of the ANGEL OF DEATH destroys you. You will wander the barren plain of the Valley of Death until the end of time.</tw-passagedata><tw-passagedata pid="262" name="Page 165" tags="" position="1880,9904" size="100,100">Worshippers make way for you as you walk towards the helmet, your face shrouded in the cowl of the black robe. It is standing on a table and is made of interwoven silver bands. You place it in your head and find yourself outside in the street. The helmet bestows quickness of thought and reaction to its wearer. Add 1 to your SKILL score.($SKILL:1) You guess that powerful Priests of Death use the helmets to come and go from the temple without being seen. Feeling lucky to be alive you set out to find the [[Thieves’ Guild-&gt;Page 83]].</tw-passagedata><tw-passagedata pid="263" name="Page 183" tags="" position="2584,9610" size="100,100">You turn right, down Trader&#39;s Row, and walk for some way, looking for the storm-drain. Eventually you see it and, checking that you are unobserved, jump down it. You land up to your knees in slime. You wade down the huge drain until you come to a small round door set in the left-hand wall. (display: &quot;TEST YOUR LUCK&quot;)
|lucky)[(goto:&quot;Page 238&quot;)[[Page 238]]]|unlucky)[(goto:&quot;Page 205&quot;)[[Page 205]]]</tw-passagedata><tw-passagedata pid="264" name="Page 149" tags="" position="2797,9609" size="100,100">You turn left down Hornbeam Road, looking for the coal-hole. You see what looks like a coal-cellar at the back of a dilapidated warehouse. You duck into it and find a small crawl-way hidden on the other side of the pile of coal. You craw! down a chute and out into a small passageway that winds for some distance beneath the city. You come to a door and push it open. You step into a magnificently furnished room; evidently the Thieves’ Guild lacks nothing. A group of men is waiting for you, lounging on sofas. Some of them you recognize from the Red Dragon Inn, in particular the one with a scar running from [[ear to chin-&gt;Page 209]].</tw-passagedata><tw-passagedata pid="265" name="Page 209" tags="" position="2805.333333333333,9820.666666666666" size="100,100">Scarface looks you up and down for a moment. Then he says, &#39;Right, I&#39;ll get the Guildmaster, we&#39;ll see what he has to say.&#39; There is an uneasy silence before he returns with another man. Scarface says, &#39;This is Vagrant, Guildmaster of Thieves.&#39; Vagrant is a handsome, middle-aged man wearing an ermine jacket. Twirling his moustache, he asks you the purpose of your visit. What will you say:
[{&lt;ul&gt;
&lt;li&gt;You need help to [[steal something-&gt;Page 315]]?&lt;/li&gt;
&lt;li&gt;You want to steal the [[Talisman of Death-&gt;Page 276]]?&lt;/li&gt;
&lt;li&gt;You will lead them to a hoard of [[priceless jewellery-&gt;Page 291]]?&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="266" name="Page 238" tags="" position="2429,9756.666666666668" size="100,100">As you open the door you slip on the slime underfoot. A glancing blow catches you on the side as a harpoon thuds into the door. Lose 2 STAMINA points.($STAMINA: -2) If you are still alive, you look behind and see the firing mechanism of the trap. You open the door and step into a magnificently furnished room. Evidently the Thieves’ Guild lacks nothing. A group of men, some of whom you recognize from the Red Dragon, are lounging on sofas. They leap to their feet in surprise and reach for their swords. Will you place your back to the wall and [[draw your sword-&gt;Page 242]], or calmly tell them that you have been [[invited-&gt;Page 252]]?</tw-passagedata><tw-passagedata pid="267" name="Page 205" tags="" position="2657.3333333333335,9760" size="100,100">As you are about to open the door, you hear a click and something thumps you on the back. Looking down you see the bloody head of a harpoon protruding from your stomach. Your hands clutch at the gaping wound as you try to stop your entrails spilling into the slime of the sewer. Mercifully, death takes you [[swiftly-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="268" name="Page 315" tags="" position="2943.6666666666665,10158.999999999998" size="100,100">&#39;Oh yes?&#39; says Vagrant. &#39;What is this thing?&#39; Will you say you&#39;re not prepared to tell what it is, but it lies [[in the temple of Fell-Kyrinla-&gt;Page 370]]? Or will you tell them it’s [[the Talisman of Death-&gt;Page 276]] and you are prepared to share the spoils when you get it?</tw-passagedata><tw-passagedata pid="269" name="Page 276" tags="" position="2688.6666666666665,9987.333333333332" size="100,100">There is a hushed silence, broken by Vagrant. &#39;That is indeed beyond price.&#39; He suddenly barks out an order: &#39;We&#39;ll mount an expedition before they move the Talisman. It is market-day - a good time. Scarface, Jemmy the Rat, Bloodheart and young Lord Min, you will accompany our friend here.&#39; Some hours later, when they have finished their preparations, you set off. As you leave, you see a piece of graffiti scrawled in blood on a wall: &lt;i&gt;There is no honour among thieves!&lt;/i&gt; You resolve to be [[on your guard-&gt;Page 241]].</tw-passagedata><tw-passagedata pid="270" name="Page 291" tags="" position="3162,9990.666666666666" size="100,100">&#39;Where is this priceless jewellery stashed?&#39; demands Vagrant. Do you tell them to follow you and [[you&#39;ll show them-&gt;Page 349]], or tell them that it lies [[in the temple to Fell-Kyrinla-&gt;Page 333]]?</tw-passagedata><tw-passagedata pid="271" name="Page 242" tags="" position="2275.6666666666665,9915.000000000002" size="100,100">As they move towards you, one of them produces a crossbow and fires. You duck but he was aiming at your leg and the bolt slams into your thigh, spinning you sideways. You feel as if your veins are on fire. The bolt was poisoned, and you soon sink into [[the oblivion of death-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="272" name="Page 252" tags="" position="2472.3333333333335,9940.000000000002" size="100,100">&#39;If we had really wanted you to come, don&#39;t you think we would have told you the safe route?&#39; says a thief with a scar running from ear to chin, whom you recognize from the Red Dragon. They move towards you purposefully. &#39;This is the welcome we give to the likes of you,&#39; he continues. Will you place your back to the wall and [[draw your sword-&gt;Page 242]], or sit down, telling them to kill you if they like, but they&#39;ll miss out on an [[attractive proposition-&gt;Page 209]]?</tw-passagedata><tw-passagedata pid="273" name="Page 241" tags="" position="2688.6666666666665,10137.333333333332" size="100,100">Scarface leads you through a maze of back alleys into a building that Jemmy the Rat tells you is a safe house. You climb on to the roof and continue running across the roof-tops of the city. Soon you are on top of a tall house, just below the top of the temple to Fell-Kyrinla. Bloodheart, a hulking, silent fellow, takes a rope and grappling hook from his shoulder. He effortlessly throws it round the top of one of the temple columns. He secures his end to a chimney-stack and walks across on the tightrope he has created. You all manage to cross hand-over-hand and join him in the temple eaves. Jemmy the Rat, a wiry man with fingers like spider&#39;s legs, finds a skylight and, true to his name, prises off the bars and picks the lock. Reaching inside he disarms a trap containing a poisoned dart. You marvel at his nimble-fingered skill. They lower a rope and you all drop down to the top of a staircase. You catch sight of an old serving-man passing a doorway on the landing. The others have not noticed him.  Will you [[silence him-&gt;Page 217]], in case he has seen you, or [[ignore him-&gt;Page 228]], hoping he didn&#39;t see you?</tw-passagedata><tw-passagedata pid="274" name="Page 349" tags="" position="3268.6666666666665,10127.333333333332" size="100,100">Vagrant sneers, &#39;Who do you think you are - a God? Vagar the Deceiver himself? Get thee gone.&#39; He waves his arm [[dismissively-&gt;Page 367]].</tw-passagedata><tw-passagedata pid="275" name="Page 333" tags="" position="3133.666666666667,10172.333333333332" size="100,100">Vagrant replies, &#39;Are you mad? Nothing is worth raiding the temple of Fell-Kyrinla for.&#39; Will you tell them about [[the Talisman of Death-&gt;Page 276]]? Or do you decide to call their bluff, saying that you will [[find someone else-&gt;Page 367]] to share the spoils with?</tw-passagedata><tw-passagedata pid="276" name="Page 217" tags="" position="2695.333333333333,10305.666666666666" size="100,100">You creep up behind the old man as he shuffles along the corridor.  Will you use the pommel of your sword and try to [[knock him out-&gt;Page 206]], or [[strike him down-&gt;Page 194]] with your sword?</tw-passagedata><tw-passagedata pid="277" name="Page 228" tags="" position="2845.333333333333,10305.666666666666" size="100,100">You hurry on down the stairs but the old man has [[seen you-&gt;Page 283]].</tw-passagedata><tw-passagedata pid="278" name="Page 283" tags="" position="3020.333333333333,10559.000000000002" size="100,100">You are padding silently along the landing towards the stairs which lead down, when a loud pealing of bells fills the air. &#39;The alarm,&#39; snarls Scarface. You freeze. Looking back you are astonished to find that you cannot see the thieves, who you thought were behind you. All you can see are shadows. You are on your own. Will you [[go back-&gt;Page 213]] to find the thieves, or [[run down the stairs-&gt;Page 180]] ahead of you?
</tw-passagedata><tw-passagedata pid="279" name="Page 206" tags="" position="2576.9999999999995,10454" size="100,100">You strike the old temple-servant across the back of his neck with the pommel of your sword. He collapses soundlessly. You go to tie him up. &#39;Good work,&#39; says Lord Min, a small, agile young man. &#39;Now I&#39;ll finish it.&#39; He steps forward with his dagger, meaning to slit the old man&#39;s throat. Will you [[stop him-&gt;Page 251]], or let him [[kill the old man-&gt;Page 239]]?</tw-passagedata><tw-passagedata pid="280" name="Page 194" tags="" position="2770.333333333333,10452.333333333334" size="100,100">You drive your sword into his back. He lets out a scream of pain as he dies. Lord Min, a small, agile young man is behind you. He says, &#39;Sloppily done. We may all pay for that. Now, [[hurry-&gt;Page 283]]!&#39;</tw-passagedata><tw-passagedata pid="281" name="Page 251" tags="" position="2778.666666666666,10602.333333333334" size="100,100">You reach out and knock the young thief&#39;s hand away. He drops his dagger, which clatters noisily all the way down the stairs. &#39;Sentimental fool,&#39; he snaps. &#39;The guards will have heard that.&#39; He draws another dagger from his boot. &#39;Hurry, we have little time now,&#39; says Scarface. [[You hurry on-&gt;Page 283]].</tw-passagedata><tw-passagedata pid="282" name="Page 239" tags="" position="2651.9999999999995,10604" size="100,100">The old man gurgles softly and dies. Lord Min grins wolfishly. Lose 1 LUCK point for your callous action.($LUCK:-1) You hurry on down the stairs which lead to a set of double doors. A guard is on duty but she is overwhelmed before she can make a sound. Inside the Inner Sanctum of the temple a tall raven-haired woman is praying at the altar, upon which lies the Talisman of Death. She appears to be talkíng to her goddess, Fell-Kyrinla. Beyond the altar is a large marble statue of the goddess, wearing chainmail, her expression arrogant and cruelly beautiful. The tall woman rises and turns towards you. &#39;Hounds of Hell! It&#39;s Hawkana, the High Priestess!&#39; breathes Jemmy the Rat. &#39;I&#39;m off.&#39; You look around to see the thieves have disappeared. Before you can try to follow, Hawkana casts a spell and the doors [[fly shut-&gt;Page 222]].</tw-passagedata><tw-passagedata pid="283" name="Page 222" tags="" position="2651.9999999999995,10754" size="100,100">&#39;How dare you desecrate the temple. How dare you interrupt me when I&#39;m speaking with the Goddess,&#39; she says softly, white with rage. &#39;I dedicate your soul to the Goddess.&#39; She drives her fist into the air and chops it downwards. A pillar of flame descends from the vaulted roof. (link-reveal:&quot;Roll one die&quot;)[(display: &quot;ROLL TWO&quot;)(dialog: &quot;Your roll: &quot; + (str: $die_1))(show: ?result)].
|result)[{
	(if: $die_1 &lt;= 4)[If you score 1-4, [[click here-&gt;Page 105]].]
	(else:)[If you score a 5 or a 6, [[click here-&gt;Page 132]].]}
]</tw-passagedata><tw-passagedata pid="284" name="ROLL TWO" tags="" position="361.66666666666674,2288" size="100,100">[{
(set: $die_1 to (random: 1, 6))
(set: $die_2 to (random: 1, 6))
}]</tw-passagedata><tw-passagedata pid="285" name="Page 105" tags="" position="2408.666666666666,10899" size="100,100">You jump aside at the last moment but are still caught by the heat of the blast. Lose 3 STAMINA points.($STAMINA: -3) If you are still alive you may wish to use one of the following, if you have any of them:
[{&lt;ul&gt;
&lt;li&gt;A Vial of (link-reveal:&quot;Vapours of Speed&quot;)[(if: $inventory contains &quot;Vapours of Speed&quot;)[(goto: &quot;Page 76&quot;)[[Page 76]]](else:)[(dialog: &quot;You do not have this item.&quot;)]].&lt;/li&gt;
&lt;li&gt;An (link-reveal:&quot;Amulet made from the Horn of a Unicorn&quot;)[(if: $inventory contains &quot;Unicorn Horn Amulet&quot;)[(goto: &quot;Page 87&quot;)][[Page 87]](else:)[(dialog: &quot;You do not have this item.&quot;)]]&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Scroll of Agonizing Doom&quot;)[(if: $inventory contains &quot;Scroll of Doom&quot;)[(goto: &quot;Page 59&quot;)[[Page 59]]](else:)[(dialog: &quot;You do not have this item.&quot;)]]&lt;/li&gt;
&lt;li&gt;[[None of these things-&gt;Page 50]]&lt;/li&gt;
&lt;/ul&gt;
}]</tw-passagedata><tw-passagedata pid="286" name="Page 132" tags="" position="2891.9999999999995,10889" size="100,100">You are engulfed in flame. The pain is terrible and you can hardly see. Lose 6 STAMINA points.($STAMINA: -6) If you are still alive you may wish to use one of the following, if you have any of them:
[{&lt;ul&gt;
&lt;li&gt;A Vial of (link-reveal:&quot;Vapours of Speed&quot;)[(if: $inventory contains &quot;Vapours of Speed&quot;)[(goto: &quot;Page 76&quot;)[[Page 76]]](else:)[(dialog: &quot;You do not have this item.&quot;)]].&lt;/li&gt;
&lt;li&gt;An (link-reveal:&quot;Amulet made from the Horn of a Unicorn&quot;)[(if: $inventory contains &quot;Unicorn Horn Amulet&quot;)[(goto: &quot;Page 87&quot;)][[Page 87]](else:)[(dialog: &quot;You do not have this item.&quot;)]]&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Scroll of Agonizing Doom&quot;)[(if: $inventory contains &quot;Scroll of Doom&quot;)[(goto: &quot;Page 59&quot;)[[Page 59]]](else:)[(dialog: &quot;You do not have this item.&quot;)]]&lt;/li&gt;
&lt;li&gt;[[None of these things-&gt;Page 50]]&lt;/li&gt;
&lt;/ul&gt;
}]</tw-passagedata><tw-passagedata pid="287" name="Page 50" tags="monster" position="2610.3333333333326,11039" size="100,100">Hawkana draws her sword and advances on you, snarling with tigerish ferocity. You must fight the High Priestess.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;HAWKANA&quot;,
		  &quot;skill&quot;, 12,
		  &quot;stamina&quot;, 14
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 44&quot;)[[Page 44]]]</tw-passagedata><tw-passagedata pid="288" name="Page 76" tags="monster" position="2460.3333333333326,11039" size="100,100">($remove-item:&quot;Vapours of Speed&quot;)Hawkana draws her sword and advances on you, snarling with tigerish ferocity. You have just enough time to take out the Vial of Vapours ofSpeed and inhale. There seems to be no effect — the alchemist has sold you fresh air! With the speed of a cobra Hawkana is upon you and her sword pierces your arm as you drop the empty vial. Lose 2 STAMINA points.($STAMINA:-2) If you are still alive you must fight the High Priestess.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;HAWKANA&quot;,
		  &quot;skill&quot;, 12,
		  &quot;stamina&quot;, 14
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 44&quot;)[[Page 44]]]</tw-passagedata><tw-passagedata pid="289" name="Page 87" tags="monster" position="2730.3333333333326,11039" size="100,100">You touch the Amulet as Hawkana draws her sword and advances, snarling with tigerish ferocity. It is an Amulet of Strength against Evil and it increases your SKILL by 2 points, in this battle only. With the speed of a cobra Hawkana is upon you. You must fight the High Priestess.
(set: $player&#39;s skill to it + 2)(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;HAWKANA&quot;,
		  &quot;skill&quot;, 12,
		  &quot;stamina&quot;, 14
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(set: $player&#39;s skill to it - 2)(goto: &quot;Page 44&quot;)[[Page 44]]]</tw-passagedata><tw-passagedata pid="290" name="Page 59" tags="monster" position="2850.3333333333326,11039" size="100,100">($remove-item:&quot;Scroll of Doom&quot;)After that display of power, you hurriedly use your Scroll of Agonizing Doom. Hawkana draws her sword and advances on you, snarling with tigerish ferocity. But the spell works and a crackling electric-blue aura surrounds her. She throws back her head and howls with agony. She is very badly hurt and staggers, but then exerts her will and recovers. You must fight the High Priestess.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;HAWKANA&quot;,
		  &quot;skill&quot;, 12,
		  &quot;stamina&quot;, 6
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 44&quot;)[[Page 44]]]</tw-passagedata><tw-passagedata pid="291" name="Page 44" tags="" position="2688.6666666666656,11247.333333333332" size="100,100">Hawkana collapses to the floor, lifeless. You walk to the altar and take the Talisman of Death.($add_item:&quot;Talisman of Death&quot;) It is cold and heavy. At last you have regained it. Gain 1 LUCK point.($LUCK:1) You look back at Hawkana and your scalp crawls. Her wounds are healing. Even as you watch she tries to raise herself from the pool of blood in which she lies.  Will you [[go back to Hawkana-&gt;Page 54]], or [[run to the double doors-&gt;Page 31]]?</tw-passagedata><tw-passagedata pid="292" name="Page 54" tags="" position="2613.6666666666656,11397.333333333332" size="100,100">You notice that a ring on Hawkana&#39;s finger is glowing with a green light as her wounds close up. Quickly you take it off before she comes fully back to life. You place it on your own finger. It is a Ring of Regeneration; regain 6 STAMINA points.($STAMINA: 6)($add_item:&quot;Hawkana&#39;s Ring&quot;) Will you now try to [[leave through the double doors-&gt;Page 16]], or [[search the Inner Sanctum-&gt;Page 137]]?</tw-passagedata><tw-passagedata pid="293" name="Page 31" tags="" position="2493.6666666666656,11245.666666666666" size="100,100">The doors are still magically sealed shut. You cannot force them open. You turn to see that Hawkana has risen to her feet and taken up her sword again. Her eyes are filled with malice. ‘You cannot kill me. This time I will carve out your spleen.’ She is slower than before but you must fight her again.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;HAWKANA&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 6
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 54&quot;)[[Page 54]]]</tw-passagedata><tw-passagedata pid="294" name="Page 16" tags="" position="2793.6666666666656,11443.999999999998" size="100,100">The doors open easily. It seems the magic has faded now that Hawkana is truly dead. The thieves have been spying on you through the keyhole. Scarface says, &#39;The door was locked and we couldn&#39;t get in.&#39; He leads the way back up to the skylight. If you still have Hawkana&#39;s ring, you feel it grow cold and see that it has tarnished to a dull grey metal. Its magic only works within the Inner Sanctum. Suddenly, the alarm bell tolls loudly. As you reach the top landing, a group of warrior-women appears on the stairs behind you in hot pursuit. You all run for the rope hanging from the skylight. As you reach it, you sense a movement at your side and dodge the murderous thrust of Bloodheart&#39; s dagger just in time. Before he can strike again, the warrior-women let loose a volley of crossbow bolts. Bloodheart&#39;s body is peppered with quarrels, shìeldíng you as you climb the rope. Leaving the stricken Bloodheart to his fate, the remaining thieves jump agilely from the temple roof to the roof of a nearby house. You will have to jump, too. (link-reveal:&quot;Roll two dice&quot;)[(display: &quot;ROLL TWO&quot;)(dialog: &quot;Your roll: &quot; + (str: $die_1) + &quot; and &quot; + (str: $die_2))(show: ?result)].
|result)[{
	(if: $die_1 + $die_2 &lt;= $player&#39;s skill)[If the total is less than or equal to your SKILL score, [[click here-&gt;Page 163]].]
	(else:)[If the total is greater than your SKILL score, [[click here-&gt;Page 56]].]
}]</tw-passagedata><tw-passagedata pid="295" name="Page 137" tags="" position="2628.6666666666656,11543.999999999998" size="100,100">($remove_item:&quot;Hawkana&#39;s Ring&quot;)You begin rummaging through the trappings of the temple. You feel a tingling sensation in your finger, followed by a sharp pain. Looking at your hand you see that Hawkana’s ring is shrinking. You try to pull it off but it is too late. You can only watch as the ring constricts to a solid ball and severs your finger. Lose 1 SKILL and 2 STAMINA points.($SKILL:-1)($STAMINA:-2) You can feel the dreadful malice of the Goddess directed against you and you decide to [[try the doors-&gt;Page 16]].</tw-passagedata><tw-passagedata pid="296" name="Page 163" tags="" position="2953.6666666666656,11363.999999999998" size="100,100">You land safely next to the thieves. Scarface looks surprised to see you. &#39;Bloodheart?&#39; he inquires. &#39;Failed, you treacherous dogs,&#39; you reply, brandishing your sword. Jemmy the Rat turns tail and flees across the rooftops. Lord Min looks at Scarface and shrugs. &#39;I&#39;m not fighting the killer of Hawkana,&#39; he says. They swing under the eaves and climb like spiders to an open window. Not wishing to attempt this climb, you make your way back to the safe house across the roof-tops, and climb down to the street, where you stop to regain your breath before [[leaving the city-&gt;Page 235]].</tw-passagedata><tw-passagedata pid="297" name="Page 56" tags="" position="2920.333333333332,11540.666666666666" size="100,100">You fly through the air, but not far enough. You slam into the side of the building with bone-shattering force and plummet to the street below. Luck has not deserted you completely, for you land in a stinking pile of refuse, which breaks your fall a little. Lose 3 STAMINA points.($STAMINA: -3) If you are still alive, you drag yourself off down an alleyway which leads towards the safe house. Near the safe house you pause to rest before [[leaving the city-&gt;Page 235]].</tw-passagedata><tw-passagedata pid="298" name="Page 235" tags="" position="3078.666666666666,11443.999999999998" size="100,100">As you catch your breath three shadows appear on the road before you. Looking up, you see Tyutchev and Cassandra, with a hideous squid-like creature hovering in the air between them. One of the squid’s tentacles is curled loosely around Cassandra’s waist. &#39;We meet again,&#39; says Tyutchev. &#39;Young Lord Min tells me you have been successful. Congratulations, you have done us a favour. Now you&#39;ll be glad, your peril is over. We are taking the Talisman.&#39; Grimly, you draw your sword. &#39;I see,&#39; says Tyutchev. &#39;Then let me introduce Thaum,&#39; he continues, gesturing towards the squid-like monster. Its form dissolves and becomes the man with the gold ear-ring and flowing grey robes you saw producing flowers out of the air for the crowds. He is a Master of Illusion. At that moment a huge and ugly Troll appears from within the safe house. &#39;Here is Harg,&#39; says Thaum. Harg raises a huge hammer ready to strike you. Is he real, or is he one of Thaum’s illusions? Will you [[attack the Troll-&gt;Page 45]], or [[allow his hammer to strike you-&gt;Page 141]]?</tw-passagedata><tw-passagedata pid="299" name="Page 370" tags="" position="3020.333333333333,10292.333333333332" size="100,100">&#39;Thank you,&#39; says Vagrant. &#39;Now that we know where to go we have no further need of you.&#39; He snaps his fingers. A volley of crossbow bolts find their mark and you crash to the ground, [[dead-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="300" name="Page 213" tags="" position="3463.6666666666665,10545.666666666668" size="100,100">You run back into the room with the skylight, but there is nothing to be seen. The rope is gone and the skylight is shut. You hear the tramp of feet coming up the stairs. You look around desperately but there is nowhere to hide. Ten of the warrior-women burst in. You fight valiantly but there are too many of them. You are overwhelmed and [[slain-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="301" name="Page 180" tags="" position="3235.3333333333335,10667.333333333334" size="100,100">You run down the stairs four at a time. You reach another landing before you hear the tramp of feet coming up from below. Thinking quickly, you hide behind an arras. (display:&quot;TEST YOUR LUCK&quot;).
|lucky)[(goto: &quot;Page 140&quot;)[[Page 140]]]|unlucky)[(goto: &quot;Page 153&quot;)[[Page 153]]]</tw-passagedata><tw-passagedata pid="302" name="Page 367" tags="" position="3362,10325.666666666666" size="100,100">‘Good luck to you, then,’ says Scarface. The thieves are still pointing their crossbows at you. Vagrant leaves and you decide it would be prudent to do the same. There seems to be nothing else you can do except tackle the temple to Fell-Kyrinla alone. You [[set off-&gt;Page 383]] in search of it.</tw-passagedata><tw-passagedata pid="303" name="Page 140" tags="monster" position="3160.3333333333335,10817.333333333334" size="100,100">You can hear the clank of armour as a group of guards rushes past the arras, heading up the stairs. You continue down until you reach the double doors at the bottom. A guard remains on duty before them. She shouts a warning and runs forward to attack you. You must defeat her within 5 attack rounds.
(set: $combat_round to 0)
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TEMPLE GUARD&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 8,
		  &quot;special&quot;, &quot;TEMPLE GUARD SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 113&quot;)[[Page 113]]]
|lose)[If she is still alive after five combat rounds, turn to
[[Page 124]].]</tw-passagedata><tw-passagedata pid="304" name="Page 153" tags="" position="3577,10809" size="100,100">With a shock, you realize that your foot is poking out under the arras. You pull it back as fast as you can, but you hear footsteps stopping on the other side. A woman&#39;s voice rings out, &#39;Ha! A rat, dead for a silver.&#39; She plunges her sword through the arras and into your stomach. Within moments you are [[dead-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="305" name="Page 113" tags="" position="2962,10740.666666666668" size="100,100">You step over the fallen guard and, pushing open the double doors, enter the Inner Sanctum of the temple. A tall raven-haired woman, Hawkana, the High Priestess, is praying at the altar, upon which lies the Talisman of Death. Beyond the altar is a large marble statue of the Goddess wearing chain-mail, her expression arrogant and cruelly beautiful. Hawkana rises and turns. She resembles the statue and is wearing a long dress of [[black chainmail-&gt;Page 222]].</tw-passagedata><tw-passagedata pid="306" name="Page 124" tags="" position="3673.666666666667,10979" size="100,100">The guards come back down the stairs and you are attacked from all sides. You fight valiantly but there are too many of them. You are overwhelmed and [[slain-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="307" name="TEMPLE GUARD SPECIAL" tags="" position="3163.3333333333335,10930.666666666666" size="100,100">(if: $combat_stage is &quot;combat-actions&quot;)[{
	(set: $combat_round to it + 1)
	(if: $combat_round &gt; 5 and _monster&#39;s stamina &gt; 0) [
		(replace: ?ACTION_OPTIONS)[
			If she is still alive after five combat rounds, [[click here-&gt;Page 124]]
		]
	]
}]</tw-passagedata><tw-passagedata pid="308" name="Page 45" tags="" position="3230.3333333333326,11338.999999999998" size="100,100">You fight Harg. Your blows cause black blood to flow, but the wounds close up as fast as you can inflict them. Harg’s hammer catches you on the shoulder — lose 2 STAMINA points. ($STAMINA: -2)At this Thaum snaps his fingers and Harg, an illusion after all, [[disappears-&gt;Page 171]].</tw-passagedata><tw-passagedata pid="309" name="Page 141" tags="" position="3215.3333333333326,11523.999999999998" size="100,100">Harg disappears before the hammer lands. &#39;Very good,&#39; says Thaum. &#39;Now, [[what about this-&gt;Page 171]]?&#39;</tw-passagedata><tw-passagedata pid="310" name="Page 171" tags="" position="3383.6666666666656,11435.666666666666" size="100,100">While Tyutchev draws his sword, Thaum points at you. From his finger a ball of multi-coloured fire flies towards you. Will you try to [[avoid the fireball-&gt;Page 244]] by running at Tyutchev, or [[hold your ground-&gt;Page 225]]?</tw-passagedata><tw-passagedata pid="311" name="Page 244" tags="" position="3550.3333333333326,11520.666666666666" size="100,100">The fireball bursts behind you, but a burning pain sears your back and you smell charred cloth. Lose 3 STAMINA points.($STAMINA: -3) If you are still alive, you press [[home your attack-&gt;Page 265]] on Tyutchev.</tw-passagedata><tw-passagedata pid="312" name="Page 225" tags="" position="3550.333333333332,11335.666666666666" size="100,100">The fireball erupts around you. The excruciating pain and the smell of your burnt flesh tells you that it was real. Lose 6 STAMINA points.($STAMINA:-6) If you are still alive, you hear Thaum laughing cruelly as Tyutchev moves to [[attack-&gt;Page 265]].</tw-passagedata><tw-passagedata pid="313" name="Page 265" tags="monster" position="3726.999999999999,11427.333333333332" size="100,100">Tyutchev’s bastard sword, almost as long as you, hums through the air as he parries your first attack with the agility of a cat. The black cloak he wears makes it difficult for you to tell exactly where he is. Cassandra and Thaum, looking confident, stand back to watch. You fight Tyutchev.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;TYUTCHEV&quot;,
		  &quot;skill&quot;, 10,
		  &quot;stamina&quot;, 12,
		  &quot;special&quot;, &quot;TYUTCHEV SPECIAL 2&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 301&quot;)[[Page 301]]]</tw-passagedata><tw-passagedata pid="314" name="TYUTCHEV SPECIAL 2" tags="" position="3725,11290" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(if: _player_roll &gt; _monster_roll)[(set: _monster&#39;s hits to 1)]
}](elseif: $combat_stage is &quot;post-combat&quot;)[{
	(if: _monster&#39;s hits is 1)[
		(replace: ?ATTACK_ACTIONS)[
			(set: $monsters to (a:))
			After your first successful attack on him, [[click here-&gt;Page 301]].
		]
	]
}]</tw-passagedata><tw-passagedata pid="315" name="Page 301" tags="" position="3903.666666666666,11428.999999999998" size="100,100">As soon as you wound Tyutchev, you notice Thaum gesturing. Tyutchev becomes invisible. As you start back in surprise, Cassandra is upon you, her sword darting at you. Tyutchev reappears behind you, raising his sword to strike and Thaum is gesturing again. You feel threatened from all sides and you are hard pressed to defend yourself. Do you wish to [[call upon a God-&gt;Page 330]] for aid, or do you think you can triumph by the [[skill of your own hand-&gt;Page 292]]?</tw-passagedata><tw-passagedata pid="316" name="Page 292" tags="" position="3861.9999999999995,11082.333333333332" size="100,100">A spray of brightly coloured light speeds from Thaum&#39;s hands into your eyes, dazzling you. Cassandra stabs you neatly in the heart as Tyutchev [[cleaves your head from your shoulders-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="317" name="Page 330" tags="" position="3906.999999999999,11585.666666666664" size="100,100">Which god will you call on?
[{&lt;ul&gt;
&lt;li&gt;[[Avatar the One-&gt;Page 347]]&lt;/li&gt;
&lt;li&gt;[[Lifespirit-&gt;Page 284]]&lt;/li&gt;
&lt;li&gt;[[Rocheval, God of the Paladins-&gt;Page 361]]&lt;/li&gt;
&lt;li&gt;[[The All-Mother-&gt;Page 248]]&lt;/li&gt;
&lt;li&gt;[[Fate-&gt;Page 389]]&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="318" name="Page 347" tags="" position="4021.9999999999986,11423.999999999998" size="100,100">[[Nothing happens-&gt;Page 292]].</tw-passagedata><tw-passagedata pid="319" name="Page 284" tags="" position="4425.333333333332,11630.666666666664" size="100,100">[[Nothing happens-&gt;Page 292]].</tw-passagedata><tw-passagedata pid="320" name="Page 361" tags="" position="4156.999999999999,11437.33333333333" size="100,100">[[Nothing happens-&gt;Page 292]].</tw-passagedata><tw-passagedata pid="321" name="Page 248" tags="" position="3733.666666666665,11730.666666666664" size="100,100">You are swept up in the talons of a great white eagle. Your assailants are soon specks below you on the street. Rising high above the roof-tops you look to the south-east and see, far away, a mountain on top of a large plateau. A voice speaks in your head — the voice of the All-Mother. &#39;That is Mount Star-reach, your goal. At its summit lies the portal that will take you back to your own world.&#39; For a moment it seems the eagle will bear you to the mountain, but the Talisman seems to weigh like a ball of lead around your neck and the eagle is forced to land in a deserted alley of Store Street. Before you can thank it, it takes to the air again and is soon soaring far above the city. Are you wearing (link-reveal:&quot;magical chainmail&quot;)[(show: ?result)]?
|result)[(if: $inventory contains &quot;Magical Chainmail&quot;)[[[You are-&gt;Page 375]].](else:)[[[You are not-&gt;Page 258]].]]</tw-passagedata><tw-passagedata pid="322" name="Page 389" tags="" position="4301.999999999999,11515.666666666664" size="100,100">You hear a voice speaking in your head, &#39;I will help you but, for now, Death will take you. What is destined to happen, must [[come to pass-&gt;Page 292]].&#39;</tw-passagedata><tw-passagedata pid="323" name="Page 375" tags="" position="3530.3333333333317,11872.33333333333" size="100,100">Store Street is an extension of Moorgate, the road leading to the arch through which you entered the city. The market-day crowds are thronging the streets and you look around nervously. Will you:
[{&lt;ul&gt;
&lt;li&gt;Hasten down Store Street to the [[Moorgate arch-&gt;Page 237]]?&lt;/li&gt;
&lt;li&gt;[[Lie low in an alley-&gt;Page 126]] until evening?&lt;/li&gt;
(if: $keyring contains &quot;Cemetery&quot;)[&lt;li&gt;Or, if you had dinner with a Sage, [[ask the way to the cemetery-&gt;Page 261]]?&lt;/li&gt;]
&lt;/ul&gt;
}]</tw-passagedata><tw-passagedata pid="324" name="Page 258" tags="" position="3948.666666666665,11880.666666666664" size="100,100">Store Street is an extension of Moorgate. Will you hurry down Store Street to the [[end of Moorgate-&gt;Page 237]], or, if you had dinner with a Sage, (link-reveal:&quot;ask the way to the cemetery&quot;)[(if: $keyring contains &quot;Cemetery&quot;)[(goto:&quot;Page 261&quot;)[[Page 261]]](else:)[(dialog:&quot;But you did not have dinner with a Sage.&quot;)]]?</tw-passagedata><tw-passagedata pid="325" name="Page 237" tags="" position="4565.333333333332,11803.999999999996" size="100,100">Coming along Moorgate you realize that the guards on the gate have been doubled, following the death of Hawkana. To your dismay, a mounted patrol enters Moorgate from Smith Street and you are trapped between the cavalry and the guards at the gate. As you slip through the gate, one of the warrior-women recognizes you. They scream for your blood. You flee across the wilderness, but the cavalry are swifter and there is nowhere to hide. You turn and fight, but there are too many of them and they are hungry for revenge. [[The end is mercifully swift-&gt;Page 109]].</tw-passagedata><tw-passagedata pid="326" name="Page 126" tags="monster" position="3415.333333333332,12022.333333333332" size="100,100">At nightfall you set off for the Moorgate hoping that the followers of the All-Mother will now be on-guard. As you leave Store Street, a figure steps from the shadows. He wears a hood which conceals his features but you recognize the ornately spiked armour and black-steel sword of a Dark Elf. One of those who attacked the Crusaders in the Rift must have infiltrated the city! He doesn’t waste words but swings his sword. You must fight the Dark Elf.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;DARK ELF&quot;,
		  &quot;skill&quot;, 8,
		  &quot;stamina&quot;, 8
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 249&quot;)[[Page 249]]]</tw-passagedata><tw-passagedata pid="327" name="Page 261" tags="" position="3741.9999999999986,12005.666666666664" size="100,100">You stop a passing student who directs you to the cemetery. You run down Pallbearer&#39;s Row, anxious to escape from the city. As you approach the cemetery, an ox-cart, returning from the market, loses a wheel and overturns, almost blocking the road. You run for the gap between it and the cemetery wall, but it is blocked by a man with a shaven head. He wears baggy scarlet trousers which end just below the knee and a loose scarlet jacket tied with a black cotton belt. On his forehead is a tattoo of a scarlet praying mantis. He doesn’t seem inclined to let you pass. Will you:
[{&lt;ul&gt;
&lt;li&gt;[[Ask him politely-&gt;Page 338]] to let you through?&lt;/li&gt;
&lt;li&gt;Tell him to [[get out of your way-&gt;Page 311]]?&lt;/li&gt;
&lt;li&gt;[[Attack him-&gt;Page 288]]?&lt;/li&gt;
}]</tw-passagedata><tw-passagedata pid="328" name="Page 338" tags="" position="3591.9999999999986,12155.666666666664" size="100,100">He does not let you pass. Will you step aside and [[invite him to pass first-&gt;Page 379]], or ask him less politely to [[move out of the way-&gt;Page 311]]?</tw-passagedata><tw-passagedata pid="329" name="Page 311" tags="monster" position="3741.9999999999986,12155.666666666664" size="100,100">The man is a monk of the Order of the Scarlet Mantis, an expert in unarmed combat. He attacks you without hesitation. He kicks and punches with deadly force.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;MONK OF THE SCARLET MANTIS&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 8,
		  &quot;special&quot;, &quot;MONK SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 325&quot;)[[Page 325]]]
(hidden:)[[Page 366]]</tw-passagedata><tw-passagedata pid="330" name="Page 288" tags="monster" position="3891.999999999998,12155.666666666664" size="100,100">The man is a monk of the Order of the Scarlet Mantis, an expert in unarmed combat. He kicks and punches with deadly force.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;MONK OF THE SCARLET MANTIS&quot;,
		  &quot;skill&quot;, 9,
		  &quot;stamina&quot;, 8,
		  &quot;special&quot;, &quot;MONK SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 325&quot;)[[Page 325]]]
(hidden:)[[Page 366]]</tw-passagedata><tw-passagedata pid="331" name="Page 249" tags="" position="3330.333333333332,12197.333333333332" size="100,100">You hurry along to the Moorgate itself. There is a group of warriors on guard, men and women, in green livery. They are followers of the All-Mother who have been given your description by Lillantha. They wave you through the gate and you walk out into the night. ($LUCK:1)Gain 1 LUCK point for [[escaping the city-&gt;Page 8]].</tw-passagedata><tw-passagedata pid="332" name="Page 8" tags="" position="2973.6666666666656,12542.333333333334" size="100,100">You put several miles between yourself and Greyguilds and sleep the night in a hayrick. You awake refreshed. Gain 2 STAMINA points.($STAMINA:2) Which direction will you take towards the plateau? You could take the direct route, south-east, across rough moorland; continue along the old trade road, due south for a while and then strike east; or head east across the heath to the hills before turning south.
[{&lt;ul&gt;&lt;li&gt;[[South-east-&gt;Page 287]]&lt;/li&gt;
&lt;li&gt;[[South, then east-&gt;Page 300]]&lt;/li&gt;
&lt;li&gt;[[East, then south-&gt;Page 313]]&lt;/li&gt;
&lt;/ul&gt;}]</tw-passagedata><tw-passagedata pid="333" name="MONK SPECIAL" tags="" position="4090.3333333333317,12155.000000000002" size="100,100">(if: $combat_stage is &quot;combat&quot;)[{
	(set: _monster&#39;s flag to 0)
	(if: _player_roll &lt; _monster_roll)[(set: _monster&#39;s flag to 1)]
}](elseif: $combat_stage is &quot;combat-actions&quot;)[{
	(if: _monster&#39;s flag is 1)[
		(replace: ?ACTION_OPTIONS)[
			Each time he wins an attack round, (link-reveal:&quot;roll one die&quot;)[(display: &quot;ROLL TWO&quot;)(dialog:&quot;Result: &quot; + (str:$die_1))(show:?monk_result)].
			|monk_result)[(if: $die_1 &gt; 4)[If you threw a 5 or a 6, [[click here-&gt;Page 366]].](else:)[If you threw 4 or lower, (link-rerun:&quot;Continue the battle&quot;)[(display: &quot;ATTACK ACTIONS&quot;)].]
			]
		]
	]
}]</tw-passagedata><tw-passagedata pid="334" name="Page 325" tags="" position="3788.666666666665,12353.999999999996" size="100,100">Your blade slashes him across the chest and he slumps to the ground.  You step over his body and walk past the cart. Looking back, to your surprise you see the monk has risen to his feet and is running away! Obviously he was feigning death. You [[shrug your shoulders-&gt;Page 392]] and go on.</tw-passagedata><tw-passagedata pid="335" name="Page 366" tags="" position="3951.9999999999986,12351.666666666668" size="100,100">With a grunt of effort, the monk kicks your wrist, disarming you with his left foot, and scissors his right foot into your chin before his other foot has touched the ground. You go out like a light. You regain consciousness when water is splashed on to your face by the driver of the ox-cart. Your head is still ringing. &#39;I&#39;m afraid he robbed you,&#39; says the peasant. Frantically, you check for the Talisman, but the monk has only taken the ring you found on [[Hawkana-&gt;Page 392]].($remove_item: &quot;Hawkana&#39;s Ring&quot;)(set:$monsters to (a:))</tw-passagedata><tw-passagedata pid="336" name="Page 392" tags="" position="3803.6666666666656,12538.333333333334" size="100,100">Dusk is deepening as you enter the cemetery. You begin to explore the city wall, looking for the postern gate. You do not look at the headstones for fear of finding your name at the head of an open grave.  Your eye is caught by what looks like a lantern, hanging from a post in the midst of the graves. Will you walk over to the [[lantern-&gt;Page 274]], or ignore the lantern and [[continue searching-&gt;Page 99]] along the wall?</tw-passagedata><tw-passagedata pid="337" name="Page 379" tags="" position="3591.9999999999986,12305.666666666664" size="100,100">You step back and wave the monk through. [[He walks past arrogantly-&gt;Page 392]], without a word of thanks.</tw-passagedata><tw-passagedata pid="338" name="Page 274" tags="monster" position="3921.999999999999,12673.333333333334" size="100,100">You thread your way through the moss-covered tombs and headstones. As you approach the light, it shimmers and moves towards you, floating in the darkness. You are entranced. The will-o’-the-wisp draws you, mesmerized, towards a large grey tomb. A withered hand thrusts through the earth beneath your feet and grabs your ankle. You hack at it but yet another mouldering arm grips you. There is a grating noise as a fiendish GHOUL staggers from the tomb before you. Other zombies erupt from their earthy graves around you. In your panic, you find the strength to rip yourself out of the ghastly grasp of the zombies — but the ghoul is almost upon you! You must defeat it within five rounds of combat.
(set: $monsters to
	(a:
		(dm:
		  &quot;name&quot;, &quot;GHOUL&quot;,
		  &quot;skill&quot;, 7,
		  &quot;stamina&quot;, 8,
		  &quot;special&quot;, &quot;GHOUL SPECIAL&quot;
		)
	)
)
(display: &quot;FIGHT&quot;)|win)[(goto: &quot;Page 343&quot;)[[Page 343]]]
(hidden:)[[Page 298]]</tw-passagedata><tw-passagedata pid="339" name="Page 99" tags="" position="3638.3333333333335,12551.666666666666" size="100,100">You continue along the wall and, to your relief, find the postem gate. You duck through and out into [[the night beyond-&gt;Page 8]]. Gain 1 LUCK point($LUCK:1) for escaping the city.</tw-passagedata><tw-passagedata pid="340" name="Page 287" tags="" position="2823.6666666666656,12692.333333333334" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="341" name="Page 300" tags="" position="2973.6666666666656,12692.333333333334" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="342" name="Page 313" tags="" position="3123.6666666666656,12692.333333333334" size="100,100">Double-click this passage to edit it.</tw-passagedata><tw-passagedata pid="343" name="GHOUL SPECIAL" tags="" position="4045.0000000000005,12673.333333333334" size="100,100">(if: $combat_stage is &quot;combat-actions&quot;)[{
	(set: $combat_round to it + 1)
	(if: $combat_round &gt; 5 and _monster&#39;s stamina &gt; 0) [
		(replace: ?ACTION_OPTIONS)[
			If it is still alive after five combat rounds, [[click here-&gt;Page 298]]
		]
	]
}]</tw-passagedata><tw-passagedata pid="344" name="Page 298" tags="death" position="4091.6666666666674,12825.000000000002" size="100,100">You are still struggling with the Ghoul when you see the other Zombies closing in on you. Soon you are surrounded. A score of cold, dead hands grasp you and you are laid struggling in a newly dug grave. You scream as the earth is piled upon you. You are entering the wastelands of Death.</tw-passagedata><tw-passagedata pid="345" name="Page 343" tags="" position="3780.0000000000005,12820" size="100,100">With a mighty slash, your sword bites into the pale, slimy neck of the Ghoul, decapitating it. It slumps to the floor, truly dead at last. As fast as you can, you spring past the questing arms of the lumbering zombies and dash back to the wall, knowing you must find the [[postern gate-&gt;Page 99]] as soon as possible.</tw-passagedata></tw-storydata>
<script title="Twine engine code" data-main="harlowe">"use strict";var _slicedToArray=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(a)throw i}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}!function(){
/**
 * @license almond 0.3.3 Copyright jQuery Foundation and other contributors.
 * Released under MIT license, http://github.com/requirejs/almond/LICENSE
 */var requirejs,require,define,root,factory;!function(e){var t,n,r,a,i={},o={},s={},c={},u=Object.prototype.hasOwnProperty,l=[].slice,p=/\.js$/;function f(e,t){return u.call(e,t)}function d(e,t){var n,r,a,i,o,c,u,l,f,d,h,y=t&&t.split("/"),m=s.map,g=m&&m["*"]||{};if(e){for(o=(e=e.split("/")).length-1,s.nodeIdCompat&&p.test(e[o])&&(e[o]=e[o].replace(p,"")),"."===e[0].charAt(0)&&y&&(e=y.slice(0,y.length-1).concat(e)),f=0;f<e.length;f++)if("."===(h=e[f]))e.splice(f,1),f-=1;else if(".."===h){if(0===f||1===f&&".."===e[2]||".."===e[f-1])continue;f>0&&(e.splice(f-1,2),f-=2)}e=e.join("/")}if((y||g)&&m){for(f=(n=e.split("/")).length;f>0;f-=1){if(r=n.slice(0,f).join("/"),y)for(d=y.length;d>0;d-=1)if((a=m[y.slice(0,d).join("/")])&&(a=a[r])){i=a,c=f;break}if(i)break;!u&&g&&g[r]&&(u=g[r],l=f)}!i&&u&&(i=u,c=l),i&&(n.splice(0,c,i),e=n.join("/"))}return e}function h(t,r){return function(){var a=l.call(arguments,0);return"string"!=typeof a[0]&&1===a.length&&a.push(null),n.apply(e,a.concat([t,r]))}}function y(e){return function(t){i[e]=t}}function m(n){if(f(o,n)){var r=o[n];delete o[n],c[n]=!0,t.apply(e,r)}if(!f(i,n)&&!f(c,n))throw new Error("No "+n);return i[n]}function g(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function v(e){return e?g(e):[]}r=function(e,t){var n,r,a=g(e),i=a[0],o=t[1];return e=a[1],i&&(n=m(i=d(i,o))),i?e=n&&n.normalize?n.normalize(e,(r=o,function(e){return d(e,r)})):d(e,o):(i=(a=g(e=d(e,o)))[0],e=a[1],i&&(n=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},a={require:function(e){return h(e)},exports:function(e){var t=i[e];return void 0!==t?t:i[e]={}},module:function(e){return{id:e,uri:"",exports:i[e],config:function(e){return function(){return s&&s.config&&s.config[e]||{}}}(e)}}},t=function(t,n,s,u){var l,p,d,g,b,w,T,S=[],x=void 0===s?"undefined":_typeof(s);if(w=v(u=u||t),"undefined"===x||"function"===x){for(n=!n.length&&s.length?["require","exports","module"]:n,b=0;b<n.length;b+=1)if("require"===(p=(g=r(n[b],w)).f))S[b]=a.require(t);else if("exports"===p)S[b]=a.exports(t),T=!0;else if("module"===p)l=S[b]=a.module(t);else if(f(i,p)||f(o,p)||f(c,p))S[b]=m(p);else{if(!g.p)throw new Error(t+" missing "+p);g.p.load(g.n,h(u,!0),y(p),{}),S[b]=i[p]}d=s?s.apply(i[t],S):void 0,t&&(l&&l.exports!==e&&l.exports!==i[t]?i[t]=l.exports:d===e&&T||(i[t]=d))}else t&&(i[t]=s)},requirejs=require=n=function(i,o,c,u,l){if("string"==typeof i)return a[i]?a[i](o):m(r(i,v(o)).f);if(!i.splice){if((s=i).deps&&n(s.deps,s.callback),!o)return;o.splice?(i=o,o=c,c=null):i=e}return o=o||function(){},"function"==typeof c&&(c=u,u=l),u?t(e,i,o,c):setTimeout(function(){t(e,i,o,c)},4),n},n.config=function(e){return n(e)},requirejs._defined=i,(define=function(e,t,n){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");t.splice||(n=t,t=[]),f(i,e)||f(o,e)||(o[e]=[e,t,n])}).amd={jQuery:!0}}(),define("almond",function(){}),
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.3/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
root=this,factory=function(){var e,t,n=Function.call.bind(Function.apply),r=Function.call.bind(Function.call),a=Array.isArray,i=Object.keys,o=function(e){try{return e(),!1}catch(e){return!0}},s=function(e){try{return e()}catch(e){return!1}},c=(e=o,function(){return!n(e,this,arguments)}),u=!!Object.defineProperty&&!o(function(){return Object.defineProperty({},"x",{get:function(){}})}),l="foo"===function(){}.name,p=Function.call.bind(Array.prototype.forEach),f=Function.call.bind(Array.prototype.reduce),d=Function.call.bind(Array.prototype.filter),h=Function.call.bind(Array.prototype.some),y=function(e,t,n,r){!r&&t in e||(u?Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:!0,value:n}):e[t]=n)},m=function(e,t,n){p(i(t),function(r){var a=t[r];y(e,r,a,!!n)})},g=Function.call.bind(Object.prototype.toString),v="function"==typeof/abc/?function(e){return"function"==typeof e&&"[object Function]"===g(e)}:function(e){return"function"==typeof e},b=function(e,t,n){if(!u)throw new TypeError("getters require true ES5 support");Object.defineProperty(e,t,{configurable:!0,enumerable:!1,get:n})},w=function(e,t,n){if(!u)throw new TypeError("getters require true ES5 support");var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,{configurable:r.configurable,enumerable:r.enumerable,get:function(){return e[t]},set:function(n){e[t]=n}})},T=function(e,t,n){if(u){var r=Object.getOwnPropertyDescriptor(e,t);r.value=n,Object.defineProperty(e,t,r)}else e[t]=n},S=function(e,t,n){u?Object.defineProperty(e,t,n):"value"in n&&(e[t]=n.value)},x=function(e,t){t&&v(t.toString)&&y(e,"toString",t.toString.bind(t),!0)},k=Object.create||function(e,t){var n=function(){};n.prototype=e;var r=new n;return void 0!==t&&i(t).forEach(function(e){S(r,e,t[e])}),r},O=function(e,t){return!!Object.setPrototypeOf&&s(function(){var n=function t(n){var r=new e(n);return Object.setPrototypeOf(r,t.prototype),r};return Object.setPrototypeOf(n,e),n.prototype=k(e.prototype,{constructor:{value:n}}),t(n)})},j=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),A=j.isFinite,C=Function.call.bind(String.prototype.indexOf),E=Function.apply.bind(Array.prototype.indexOf),_=Function.call.bind(Array.prototype.concat),N=Function.call.bind(String.prototype.slice),P=Function.call.bind(Array.prototype.push),I=Function.apply.bind(Array.prototype.push),M=Function.call.bind(Array.prototype.shift),D=Math.max,R=Math.min,L=Math.floor,q=Math.abs,F=Math.exp,V=Math.log,H=Math.sqrt,z=Function.call.bind(Object.prototype.hasOwnProperty),$=function(){},B=j.Map,W=B&&B.prototype.delete,U=B&&B.prototype.get,G=B&&B.prototype.has,X=B&&B.prototype.set,Y=j.Symbol||{},J=Y.species||"@@species",K=Number.isNaN||function(e){return e!=e},Z=Number.isFinite||function(e){return"number"==typeof e&&A(e)},Q=v(Math.sign)?Math.sign:function(e){var t=Number(e);return 0===t?t:K(t)?t:t<0?-1:1},ee=function(e){var t=Number(e);return t<-1||K(t)?NaN:0===t||t===1/0?t:-1===t?-1/0:1+t-1==0?t:t*(V(1+t)/(1+t-1))},te=function(e){return"[object Arguments]"===g(e)},ne=te(arguments)?te:function(e){return null!==e&&"object"===(void 0===e?"undefined":_typeof(e))&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==g(e)&&"[object Function]"===g(e.callee)},re=function(e){return null===e||"function"!=typeof e&&"object"!==(void 0===e?"undefined":_typeof(e))},ae=function(e){return"[object String]"===g(e)},ie=function(e){return"[object RegExp]"===g(e)},oe=function(e){return"function"==typeof j.Symbol&&"symbol"===(void 0===e?"undefined":_typeof(e))},se=function(e,t,n){var r=e[t];y(e,t,n,!0),x(e[t],r)},ce="function"==typeof Y&&"function"==typeof Y.for&&oe(Y()),ue=oe(Y.iterator)?Y.iterator:"_es6-shim iterator_";j.Set&&"function"==typeof(new j.Set)["@@iterator"]&&(ue="@@iterator"),j.Reflect||y(j,"Reflect",{},!0);var le,pe=j.Reflect,fe=String,de="undefined"!=typeof document&&document?document.all:null,he=null==de?function(e){return null==e}:function(e){return null==e&&e!==de},ye={Call:function(e,t){var r=arguments.length>2?arguments[2]:[];if(!ye.IsCallable(e))throw new TypeError(e+" is not a function");return n(e,t,r)},RequireObjectCoercible:function(e,t){if(he(e))throw new TypeError(t||"Cannot call method on "+e);return e},TypeIsObject:function(e){return null!=e&&!0!==e&&!1!==e&&("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e))||e===de)},ToObject:function(e,t){return Object(ye.RequireObjectCoercible(e,t))},IsCallable:v,IsConstructor:function(e){return ye.IsCallable(e)},ToInt32:function(e){return ye.ToNumber(e)>>0},ToUint32:function(e){return ye.ToNumber(e)>>>0},ToNumber:function(e){if("[object Symbol]"===g(e))throw new TypeError("Cannot convert a Symbol value to a number");return+e},ToInteger:function(e){var t=ye.ToNumber(e);return K(t)?0:0!==t&&Z(t)?(t>0?1:-1)*L(q(t)):t},ToLength:function(e){var t=ye.ToInteger(e);return t<=0?0:t>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:t},SameValue:function(e,t){return e===t?0!==e||1/e==1/t:K(e)&&K(t)},SameValueZero:function(e,t){return e===t||K(e)&&K(t)},IsIterable:function(e){return ye.TypeIsObject(e)&&(void 0!==e[ue]||ne(e))},GetIterator:function(e){if(ne(e))return new t(e,"value");var n=ye.GetMethod(e,ue);if(!ye.IsCallable(n))throw new TypeError("value is not an iterable");var r=ye.Call(n,e);if(!ye.TypeIsObject(r))throw new TypeError("bad iterator");return r},GetMethod:function(e,t){var n=ye.ToObject(e)[t];if(!he(n)){if(!ye.IsCallable(n))throw new TypeError("Method not callable: "+t);return n}},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var n=ye.GetMethod(e,"return");if(void 0!==n){var r,a;try{r=ye.Call(n,e)}catch(e){a=e}if(!t){if(a)throw a;if(!ye.TypeIsObject(r))throw new TypeError("Iterator's return method returned a non-object.")}}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ye.TypeIsObject(t))throw new TypeError("bad iterator");return t},IteratorStep:function(e){var t=ye.IteratorNext(e);return!ye.IteratorComplete(t)&&t},Construct:function(e,t,n,r){var a=void 0===n?e:n;if(!r&&pe.construct)return pe.construct(e,t,a);var i=a.prototype;ye.TypeIsObject(i)||(i=Object.prototype);var o=k(i),s=ye.Call(e,o,t);return ye.TypeIsObject(s)?s:o},SpeciesConstructor:function(e,t){var n=e.constructor;if(void 0===n)return t;if(!ye.TypeIsObject(n))throw new TypeError("Bad constructor");var r=n[J];if(he(r))return t;if(!ye.IsConstructor(r))throw new TypeError("Bad @@species");return r},CreateHTML:function(e,t,n,r){var a=ye.ToString(e),i="<"+t;""!==n&&(i+=" "+n+'="'+ye.ToString(r).replace(/"/g,"&quot;")+'"');return i+">"+a+"</"+t+">"},IsRegExp:function(e){if(!ye.TypeIsObject(e))return!1;var t=e[Y.match];return void 0!==t?!!t:ie(e)},ToString:function(e){return fe(e)}};if(u&&ce){var me=function(e){if(oe(Y[e]))return Y[e];var t=Y.for("Symbol."+e);return Object.defineProperty(Y,e,{configurable:!1,enumerable:!1,writable:!1,value:t}),t};if(!oe(Y.search)){var ge=me("search"),ve=String.prototype.search;y(RegExp.prototype,ge,function(e){return ye.Call(ve,e,[this])});se(String.prototype,"search",function(e){var t=ye.RequireObjectCoercible(this);if(!he(e)){var n=ye.GetMethod(e,ge);if(void 0!==n)return ye.Call(n,e,[t])}return ye.Call(ve,t,[ye.ToString(e)])})}if(!oe(Y.replace)){var be=me("replace"),we=String.prototype.replace;y(RegExp.prototype,be,function(e,t){return ye.Call(we,e,[this,t])});se(String.prototype,"replace",function(e,t){var n=ye.RequireObjectCoercible(this);if(!he(e)){var r=ye.GetMethod(e,be);if(void 0!==r)return ye.Call(r,e,[n,t])}return ye.Call(we,n,[ye.ToString(e),t])})}if(!oe(Y.split)){var Te=me("split"),Se=String.prototype.split;y(RegExp.prototype,Te,function(e,t){return ye.Call(Se,e,[this,t])});se(String.prototype,"split",function(e,t){var n=ye.RequireObjectCoercible(this);if(!he(e)){var r=ye.GetMethod(e,Te);if(void 0!==r)return ye.Call(r,e,[n,t])}return ye.Call(Se,n,[ye.ToString(e),t])})}var xe=oe(Y.match),ke=xe&&((le={})[Y.match]=function(){return 42},42!=="a".match(le));if(!xe||ke){var Oe=me("match"),je=String.prototype.match;y(RegExp.prototype,Oe,function(e){return ye.Call(je,e,[this])});se(String.prototype,"match",function(e){var t=ye.RequireObjectCoercible(this);if(!he(e)){var n=ye.GetMethod(e,Oe);if(void 0!==n)return ye.Call(n,e,[t])}return ye.Call(je,t,[ye.ToString(e)])})}}var Ae=function(e,t,n){x(t,e),Object.setPrototypeOf&&Object.setPrototypeOf(e,t),u?p(Object.getOwnPropertyNames(e),function(r){r in $||n[r]||w(e,r,t)}):p(Object.keys(e),function(r){r in $||n[r]||(t[r]=e[r])}),t.prototype=e.prototype,T(e.prototype,"constructor",t)},Ce=function(){return this},Ee=function(e){u&&!z(e,J)&&b(e,J,Ce)},_e=function(e,t){var n=t||function(){return this};y(e,ue,n),!e[ue]&&oe(ue)&&(e[ue]=n)},Ne=function(e,t,n){if(function(e,t,n){u?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n}(e,t,n),!ye.SameValue(e[t],n))throw new TypeError("property is nonconfigurable")},Pe=function(e,t,n,r){if(!ye.TypeIsObject(e))throw new TypeError("Constructor requires `new`: "+t.name);var a=t.prototype;ye.TypeIsObject(a)||(a=n);var i=k(a);for(var o in r)if(z(r,o)){var s=r[o];y(i,o,s,!0)}return i};if(String.fromCodePoint&&1!==String.fromCodePoint.length){var Ie=String.fromCodePoint;se(String,"fromCodePoint",function(e){return ye.Call(Ie,this,arguments)})}var Me={fromCodePoint:function(e){for(var t,n=[],r=0,a=arguments.length;r<a;r++){if(t=Number(arguments[r]),!ye.SameValue(t,ye.ToInteger(t))||t<0||t>1114111)throw new RangeError("Invalid code point "+t);t<65536?P(n,String.fromCharCode(t)):(t-=65536,P(n,String.fromCharCode(55296+(t>>10))),P(n,String.fromCharCode(t%1024+56320)))}return n.join("")},raw:function(e){var t=ye.ToObject(e,"bad callSite"),n=ye.ToObject(t.raw,"bad raw value"),r=n.length,a=ye.ToLength(r);if(a<=0)return"";for(var i,o,s,c,u=[],l=0;l<a&&(i=ye.ToString(l),s=ye.ToString(n[i]),P(u,s),!(l+1>=a));)o=l+1<arguments.length?arguments[l+1]:"",c=ye.ToString(o),P(u,c),l+=1;return u.join("")}};String.raw&&"xy"!==String.raw({raw:{0:"x",1:"y",length:2}})&&se(String,"raw",Me.raw),m(String,Me);var De={repeat:function(e){var t=ye.ToString(ye.RequireObjectCoercible(this)),n=ye.ToInteger(e);if(n<0||n>=1/0)throw new RangeError("repeat count must be less than infinity and not overflow maximum string size");return function e(t,n){if(n<1)return"";if(n%2)return e(t,n-1)+t;var r=e(t,n/2);return r+r}(t,n)},startsWith:function(e){var t=ye.ToString(ye.RequireObjectCoercible(this));if(ye.IsRegExp(e))throw new TypeError('Cannot call method "startsWith" with a regex');var n,r=ye.ToString(e);arguments.length>1&&(n=arguments[1]);var a=D(ye.ToInteger(n),0);return N(t,a,a+r.length)===r},endsWith:function(e){var t=ye.ToString(ye.RequireObjectCoercible(this));if(ye.IsRegExp(e))throw new TypeError('Cannot call method "endsWith" with a regex');var n,r=ye.ToString(e),a=t.length;arguments.length>1&&(n=arguments[1]);var i=void 0===n?a:ye.ToInteger(n),o=R(D(i,0),a);return N(t,o-r.length,o)===r},includes:function(e){if(ye.IsRegExp(e))throw new TypeError('"includes" does not accept a RegExp');var t,n=ye.ToString(e);return arguments.length>1&&(t=arguments[1]),-1!==C(this,n,t)},codePointAt:function(e){var t=ye.ToString(ye.RequireObjectCoercible(this)),n=ye.ToInteger(e),r=t.length;if(n>=0&&n<r){var a=t.charCodeAt(n);if(a<55296||a>56319||n+1===r)return a;var i=t.charCodeAt(n+1);return i<56320||i>57343?a:1024*(a-55296)+(i-56320)+65536}}};if(String.prototype.includes&&!1!=="a".includes("a",1/0)&&se(String.prototype,"includes",De.includes),String.prototype.startsWith&&String.prototype.endsWith){var Re=o(function(){return"/a/".startsWith(/a/)}),Le=s(function(){return!1==="abc".startsWith("a",1/0)});Re&&Le||(se(String.prototype,"startsWith",De.startsWith),se(String.prototype,"endsWith",De.endsWith))}ce&&(s(function(){var e=/a/;return e[Y.match]=!1,"/a/".startsWith(e)})||se(String.prototype,"startsWith",De.startsWith),s(function(){var e=/a/;return e[Y.match]=!1,"/a/".endsWith(e)})||se(String.prototype,"endsWith",De.endsWith),s(function(){var e=/a/;return e[Y.match]=!1,"/a/".includes(e)})||se(String.prototype,"includes",De.includes));m(String.prototype,De);var qe=["\t\n\v\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join(""),Fe=new RegExp("(^["+qe+"]+)|(["+qe+"]+$)","g"),Ve=function(){return ye.ToString(ye.RequireObjectCoercible(this)).replace(Fe,"")},He=["\x85","\u200b","\ufffe"].join(""),ze=new RegExp("["+He+"]","g"),$e=/^[-+]0x[0-9a-f]+$/i,Be=He.trim().length!==He.length;y(String.prototype,"trim",Ve,Be);var We=function(e){return{value:e,done:0===arguments.length}},Ue=function(e){ye.RequireObjectCoercible(e),this._s=ye.ToString(e),this._i=0};Ue.prototype.next=function(){var e=this._s,t=this._i;if(void 0===e||t>=e.length)return this._s=void 0,We();var n,r,a=e.charCodeAt(t);return r=a<55296||a>56319||t+1===e.length?1:(n=e.charCodeAt(t+1))<56320||n>57343?1:2,this._i=t+r,We(e.substr(t,r))},_e(Ue.prototype),_e(String.prototype,function(){return new Ue(this)});var Ge={from:function(e){var t,n,a,i,o,s,c=this;if(arguments.length>1&&(t=arguments[1]),void 0===t)n=!1;else{if(!ye.IsCallable(t))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(a=arguments[2]),n=!0}if(void 0!==(ne(e)||ye.GetMethod(e,ue))){o=ye.IsConstructor(c)?Object(new c):[];var u,l,p=ye.GetIterator(e);for(s=0;!1!==(u=ye.IteratorStep(p));){l=u.value;try{n&&(l=void 0===a?t(l,s):r(t,a,l,s)),o[s]=l}catch(e){throw ye.IteratorClose(p,!0),e}s+=1}i=s}else{var f,d=ye.ToObject(e);for(i=ye.ToLength(d.length),o=ye.IsConstructor(c)?Object(new c(i)):new Array(i),s=0;s<i;++s)f=d[s],n&&(f=void 0===a?t(f,s):r(t,a,f,s)),Ne(o,s,f)}return o.length=i,o},of:function(){for(var e=arguments.length,t=this,n=a(t)||!ye.IsCallable(t)?new Array(e):ye.Construct(t,[e]),r=0;r<e;++r)Ne(n,r,arguments[r]);return n.length=e,n}};m(Array,Ge),Ee(Array),m((t=function(e,t){this.i=0,this.array=e,this.kind=t}).prototype,{next:function(){var e=this.i,n=this.array;if(!(this instanceof t))throw new TypeError("Not an ArrayIterator");if(void 0!==n)for(var r=ye.ToLength(n.length);e<r;e++){var a,i=this.kind;return"key"===i?a=e:"value"===i?a=n[e]:"entry"===i&&(a=[e,n[e]]),this.i=e+1,We(a)}return this.array=void 0,We()}}),_e(t.prototype),Array.of===Ge.of||function(){var e=function(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&2===t.length}()||se(Array,"of",Ge.of);var Xe={copyWithin:function(e,t){var n,r=ye.ToObject(this),a=ye.ToLength(r.length),i=ye.ToInteger(e),o=ye.ToInteger(t),s=i<0?D(a+i,0):R(i,a),c=o<0?D(a+o,0):R(o,a);arguments.length>2&&(n=arguments[2]);var u=void 0===n?a:ye.ToInteger(n),l=u<0?D(a+u,0):R(u,a),p=R(l-c,a-s),f=1;for(c<s&&s<c+p&&(f=-1,c+=p-1,s+=p-1);p>0;)c in r?r[s]=r[c]:delete r[s],c+=f,s+=f,p-=1;return r},fill:function(e){var t,n;arguments.length>1&&(t=arguments[1]),arguments.length>2&&(n=arguments[2]);var r=ye.ToObject(this),a=ye.ToLength(r.length);t=ye.ToInteger(void 0===t?0:t);for(var i=(n=ye.ToInteger(void 0===n?a:n))<0?a+n:n,o=t<0?D(a+t,0):R(t,a);o<a&&o<i;++o)r[o]=e;return r},find:function(e){var t=ye.ToObject(this),n=ye.ToLength(t.length);if(!ye.IsCallable(e))throw new TypeError("Array#find: predicate must be a function");for(var a,i=arguments.length>1?arguments[1]:null,o=0;o<n;o++)if(a=t[o],i){if(r(e,i,a,o,t))return a}else if(e(a,o,t))return a},findIndex:function(e){var t=ye.ToObject(this),n=ye.ToLength(t.length);if(!ye.IsCallable(e))throw new TypeError("Array#findIndex: predicate must be a function");for(var a=arguments.length>1?arguments[1]:null,i=0;i<n;i++)if(a){if(r(e,a,t[i],i,t))return i}else if(e(t[i],i,t))return i;return-1},keys:function(){return new t(this,"key")},values:function(){return new t(this,"value")},entries:function(){return new t(this,"entry")}};if(Array.prototype.keys&&!ye.IsCallable([1].keys().next)&&delete Array.prototype.keys,Array.prototype.entries&&!ye.IsCallable([1].entries().next)&&delete Array.prototype.entries,Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ue]&&(m(Array.prototype,{values:Array.prototype[ue]}),oe(Y.unscopables)&&(Array.prototype[Y.unscopables].values=!0)),l&&Array.prototype.values&&"values"!==Array.prototype.values.name){var Ye=Array.prototype.values;se(Array.prototype,"values",function(){return ye.Call(Ye,this,arguments)}),y(Array.prototype,ue,Array.prototype.values,!0)}m(Array.prototype,Xe),1/[!0].indexOf(!0,-0)<0&&y(Array.prototype,"indexOf",function(e){var t=E(this,arguments);return 0===t&&1/t<0?0:t},!0),_e(Array.prototype,function(){return this.values()}),Object.getPrototypeOf&&_e(Object.getPrototypeOf([].values()));var Je,Ke=s(function(){return 0===Array.from({length:-1}).length}),Ze=1===(Je=Array.from([0].entries())).length&&a(Je[0])&&0===Je[0][0]&&0===Je[0][1];if(Ke&&Ze||se(Array,"from",Ge.from),!s(function(){return Array.from([0],void 0)})){var Qe=Array.from;se(Array,"from",function(e){return arguments.length>1&&void 0!==arguments[1]?ye.Call(Qe,this,arguments):r(Qe,this,e)})}var et=-(Math.pow(2,32)-1),tt=function(e,t){var n={length:et};return n[t?(n.length>>>0)-1:0]=!0,s(function(){return r(e,n,function(){throw new RangeError("should not reach here")},[]),!0})};if(!tt(Array.prototype.forEach)){var nt=Array.prototype.forEach;se(Array.prototype,"forEach",function(e){return ye.Call(nt,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.map)){var rt=Array.prototype.map;se(Array.prototype,"map",function(e){return ye.Call(rt,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.filter)){var at=Array.prototype.filter;se(Array.prototype,"filter",function(e){return ye.Call(at,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.some)){var it=Array.prototype.some;se(Array.prototype,"some",function(e){return ye.Call(it,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.every)){var ot=Array.prototype.every;se(Array.prototype,"every",function(e){return ye.Call(ot,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.reduce)){var st=Array.prototype.reduce;se(Array.prototype,"reduce",function(e){return ye.Call(st,this.length>=0?this:[],arguments)})}if(!tt(Array.prototype.reduceRight,!0)){var ct=Array.prototype.reduceRight;se(Array.prototype,"reduceRight",function(e){return ye.Call(ct,this.length>=0?this:[],arguments)})}var ut=8!==Number("0o10"),lt=2!==Number("0b10"),pt=h(He,function(e){return 0===Number(e+0+e)});if(ut||lt||pt){var ft=Number,dt=/^0b[01]+$/i,ht=/^0o[0-7]+$/i,yt=dt.test.bind(dt),mt=ht.test.bind(ht),gt=ze.test.bind(ze),vt=$e.test.bind($e),bt=function(){var e=function(t){var n;"string"==typeof(n=arguments.length>0?re(t)?t:function(e){var t;if("function"==typeof e.valueOf&&(t=e.valueOf(),re(t)))return t;if("function"==typeof e.toString&&(t=e.toString(),re(t)))return t;throw new TypeError("No default value")}(t):0)&&(n=ye.Call(Ve,n),yt(n)?n=parseInt(N(n,2),2):mt(n)?n=parseInt(N(n,2),8):(gt(n)||vt(n))&&(n=NaN));var r=this,a=s(function(){return ft.prototype.valueOf.call(r),!0});return r instanceof e&&!a?new ft(n):ft(n)};return e}();Ae(ft,bt,{}),m(bt,{NaN:ft.NaN,MAX_VALUE:ft.MAX_VALUE,MIN_VALUE:ft.MIN_VALUE,NEGATIVE_INFINITY:ft.NEGATIVE_INFINITY,POSITIVE_INFINITY:ft.POSITIVE_INFINITY}),Number=bt,T(j,"Number",bt)}var wt=Math.pow(2,53)-1;m(Number,{MAX_SAFE_INTEGER:wt,MIN_SAFE_INTEGER:-wt,EPSILON:2.220446049250313e-16,parseInt:j.parseInt,parseFloat:j.parseFloat,isFinite:Z,isInteger:function(e){return Z(e)&&ye.ToInteger(e)===e},isSafeInteger:function(e){return Number.isInteger(e)&&q(e)<=Number.MAX_SAFE_INTEGER},isNaN:K}),y(Number,"parseInt",j.parseInt,Number.parseInt!==j.parseInt),1===[,1].find(function(){return!0})&&se(Array.prototype,"find",Xe.find),0!==[,1].findIndex(function(){return!0})&&se(Array.prototype,"findIndex",Xe.findIndex);var Tt,St,xt,kt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable),Ot=function(e,t){u&&kt(e,t)&&Object.defineProperty(e,t,{enumerable:!1})},jt=function(){for(var e=Number(this),t=arguments.length,n=t-e,r=new Array(n<0?0:n),a=e;a<t;++a)r[a-e]=arguments[a];return r},At=function(e){return function(t,n){return t[n]=e[n],t}},Ct=function(e,t){var n,r=i(Object(t));return ye.IsCallable(Object.getOwnPropertySymbols)&&(n=d(Object.getOwnPropertySymbols(Object(t)),kt(t))),f(_(r,n||[]),At(t),e)},Et={assign:function(e,t){var n=ye.ToObject(e,"Cannot convert undefined or null to object");return f(ye.Call(jt,1,arguments),Ct,n)},is:function(e,t){return ye.SameValue(e,t)}};if(Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}}()&&se(Object,"assign",Et.assign),m(Object,Et),u){var _t={setPrototypeOf:function(e,t){var n,a=function(e,t){return function(e,t){if(!ye.TypeIsObject(e))throw new TypeError("cannot set prototype on a non-object");if(null!==t&&!ye.TypeIsObject(t))throw new TypeError("can only set prototype to an object or null"+t)}(e,t),r(n,e,t),e};try{n=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set,r(n,{},null)}catch(t){if(e.prototype!=={}.__proto__)return;n=function(e){this.__proto__=e},a.polyfill=a(a({},null),e.prototype)instanceof e}return a}(Object)};m(Object,_t)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&null!==Object.getPrototypeOf(Object.setPrototypeOf({},null))&&null===Object.getPrototypeOf(Object.create(null))&&(Tt=Object.create(null),St=Object.getPrototypeOf,xt=Object.setPrototypeOf,Object.getPrototypeOf=function(e){var t=St(e);return t===Tt?null:t},Object.setPrototypeOf=function(e,t){return xt(e,null===t?Tt:t)},Object.setPrototypeOf.polyfill=!1),!!o(function(){return Object.keys("foo")})){var Nt=Object.keys;se(Object,"keys",function(e){return Nt(ye.ToObject(e))}),i=Object.keys}if(o(function(){return Object.keys(/a/g)})){var Pt=Object.keys;se(Object,"keys",function(e){if(ie(e)){var t=[];for(var n in e)z(e,n)&&P(t,n);return t}return Pt(e)}),i=Object.keys}if(Object.getOwnPropertyNames&&!!o(function(){return Object.getOwnPropertyNames("foo")})){var It="object"===("undefined"==typeof window?"undefined":_typeof(window))?Object.getOwnPropertyNames(window):[],Mt=Object.getOwnPropertyNames;se(Object,"getOwnPropertyNames",function(e){var t=ye.ToObject(e);if("[object Window]"===g(t))try{return Mt(t)}catch(e){return _([],It)}return Mt(t)})}if(Object.getOwnPropertyDescriptor&&!!o(function(){return Object.getOwnPropertyDescriptor("foo","bar")})){var Dt=Object.getOwnPropertyDescriptor;se(Object,"getOwnPropertyDescriptor",function(e,t){return Dt(ye.ToObject(e),t)})}if(Object.seal&&!!o(function(){return Object.seal("foo")})){var Rt=Object.seal;se(Object,"seal",function(e){return ye.TypeIsObject(e)?Rt(e):e})}if(Object.isSealed&&!!o(function(){return Object.isSealed("foo")})){var Lt=Object.isSealed;se(Object,"isSealed",function(e){return!ye.TypeIsObject(e)||Lt(e)})}if(Object.freeze&&!!o(function(){return Object.freeze("foo")})){var qt=Object.freeze;se(Object,"freeze",function(e){return ye.TypeIsObject(e)?qt(e):e})}if(Object.isFrozen&&!!o(function(){return Object.isFrozen("foo")})){var Ft=Object.isFrozen;se(Object,"isFrozen",function(e){return!ye.TypeIsObject(e)||Ft(e)})}if(Object.preventExtensions&&!!o(function(){return Object.preventExtensions("foo")})){var Vt=Object.preventExtensions;se(Object,"preventExtensions",function(e){return ye.TypeIsObject(e)?Vt(e):e})}if(Object.isExtensible&&!!o(function(){return Object.isExtensible("foo")})){var Ht=Object.isExtensible;se(Object,"isExtensible",function(e){return!!ye.TypeIsObject(e)&&Ht(e)})}if(Object.getPrototypeOf&&!!o(function(){return Object.getPrototypeOf("foo")})){var zt=Object.getPrototypeOf;se(Object,"getPrototypeOf",function(e){return zt(ye.ToObject(e))})}var $t,Bt=u&&(($t=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags"))&&ye.IsCallable($t.get));if(u&&!Bt){b(RegExp.prototype,"flags",function(){if(!ye.TypeIsObject(this))throw new TypeError("Method called on incompatible type: must be an object.");var e="";return this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.unicode&&(e+="u"),this.sticky&&(e+="y"),e})}var Wt,Ut=u&&s(function(){return"/a/i"===String(new RegExp(/a/g,"i"))}),Gt=ce&&u&&((Wt=/./)[Y.match]=!1,RegExp(Wt)===Wt),Xt=s(function(){return"/abc/"===RegExp.prototype.toString.call({source:"abc"})}),Yt=Xt&&s(function(){return"/a/b"===RegExp.prototype.toString.call({source:"a",flags:"b"})});if(!Xt||!Yt){var Jt=RegExp.prototype.toString;y(RegExp.prototype,"toString",function(){var e=ye.RequireObjectCoercible(this);return ie(e)?r(Jt,e):"/"+fe(e.source)+"/"+fe(e.flags)},!0),x(RegExp.prototype.toString,Jt)}if(u&&(!Ut||Gt)){var Kt=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get,Zt=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{},Qt=ye.IsCallable(Zt.get)?Zt.get:function(){return this.source},en=RegExp,tn=function e(t,n){var r=ye.IsRegExp(t);return this instanceof e||!r||void 0!==n||t.constructor!==e?ie(t)?new e(ye.Call(Qt,t),void 0===n?ye.Call(Kt,t):n):(r&&(t.source,void 0===n&&t.flags),new en(t,n)):t};Ae(en,tn,{$input:!0}),RegExp=tn,T(j,"RegExp",tn)}if(u){var nn={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};p(i(nn),function(e){e in RegExp&&!(nn[e]in RegExp)&&b(RegExp,nn[e],function(){return RegExp[e]})})}Ee(RegExp);var rn=1/Number.EPSILON,an=Math.pow(2,-23),on=Math.pow(2,127)*(2-an),sn=Math.pow(2,-126),cn=Math.E,un=Math.LOG2E,ln=Math.LOG10E,pn=Number.prototype.clz;delete Number.prototype.clz;var fn={acosh:function(e){var t=Number(e);if(K(t)||e<1)return NaN;if(1===t)return 0;if(t===1/0)return t;var n=1/(t*t);if(t<2)return ee(t-1+H(1-n)*t);var r=t/2;return ee(r+H(1-n)*r-1)+1/un},asinh:function(e){var t=Number(e);if(0===t||!A(t))return t;var n=q(t),r=n*n,a=Q(t);return n<1?a*ee(n+r/(H(r+1)+1)):a*(ee(n/2+H(1+1/r)*n/2-1)+1/un)},atanh:function(e){var t=Number(e);if(0===t)return t;if(-1===t)return-1/0;if(1===t)return 1/0;if(K(t)||t<-1||t>1)return NaN;var n=q(t);return Q(t)*ee(2*n/(1-n))/2},cbrt:function(e){var t=Number(e);if(0===t)return t;var n,r=t<0;return r&&(t=-t),n=t===1/0?1/0:(t/((n=F(V(t)/3))*n)+2*n)/3,r?-n:n},clz32:function(e){var t=Number(e),n=ye.ToUint32(t);return 0===n?32:pn?ye.Call(pn,n):31-L(V(n+.5)*un)},cosh:function(e){var t=Number(e);if(0===t)return 1;if(K(t))return NaN;if(!A(t))return 1/0;var n=F(q(t)-1);return(n+1/(n*cn*cn))*(cn/2)},expm1:function(e){var t=Number(e);if(t===-1/0)return-1;if(!A(t)||0===t)return t;if(q(t)>.5)return F(t)-1;for(var n=t,r=0,a=1;r+n!==r;)r+=n,n*=t/(a+=1);return r},hypot:function(e,t){for(var n=0,r=0,a=0;a<arguments.length;++a){var i=q(Number(arguments[a]));r<i?(n*=r/i*(r/i),n+=1,r=i):n+=i>0?i/r*(i/r):i}return r===1/0?1/0:r*H(n)},log2:function(e){return V(e)*un},log10:function(e){return V(e)*ln},log1p:ee,sign:Q,sinh:function(e){var t=Number(e);if(!A(t)||0===t)return t;var n=q(t);if(n<1){var r=Math.expm1(n);return Q(t)*r*(1+1/(r+1))/2}var a=F(n-1);return Q(t)*(a-1/(a*cn*cn))*(cn/2)},tanh:function(e){var t=Number(e);return K(t)||0===t?t:t>=20?1:t<=-20?-1:(Math.expm1(t)-Math.expm1(-t))/(F(t)+F(-t))},trunc:function(e){var t=Number(e);return t<0?-L(-t):L(t)},imul:function(e,t){var n=ye.ToUint32(e),r=ye.ToUint32(t),a=65535&n,i=65535&r;return a*i+((n>>>16&65535)*i+a*(r>>>16&65535)<<16>>>0)|0},fround:function(e){var t=Number(e);if(0===t||t===1/0||t===-1/0||K(t))return t;var n=Q(t),r=q(t);if(r<sn)return n*(r/sn/an+rn-rn)*sn*an;var a=(1+an/Number.EPSILON)*r,i=a-(a-r);return i>on||K(i)?n*(1/0):n*i}},dn=function(e,t,n){return q(1-e/t)/Number.EPSILON<(n||8)};m(Math,fn),y(Math,"sinh",fn.sinh,Math.sinh(710)===1/0),y(Math,"cosh",fn.cosh,Math.cosh(710)===1/0),y(Math,"log1p",fn.log1p,-1e-17!==Math.log1p(-1e-17)),y(Math,"asinh",fn.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7)),y(Math,"asinh",fn.asinh,Math.asinh(1e300)===1/0),y(Math,"atanh",fn.atanh,0===Math.atanh(1e-300)),y(Math,"tanh",fn.tanh,-2e-17!==Math.tanh(-2e-17)),y(Math,"acosh",fn.acosh,Math.acosh(Number.MAX_VALUE)===1/0),y(Math,"acosh",fn.acosh,!dn(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON))),y(Math,"cbrt",fn.cbrt,!dn(Math.cbrt(1e-300),1e-100)),y(Math,"sinh",fn.sinh,-2e-17!==Math.sinh(-2e-17));var hn=Math.expm1(10);y(Math,"expm1",fn.expm1,hn>22025.465794806718||hn<22025.465794806718);var yn=Math.round,mn=0===Math.round(.5-Number.EPSILON/4)&&1===Math.round(Number.EPSILON/3.99-.5),gn=[rn+1,2*rn-1].every(function(e){return Math.round(e)===e});y(Math,"round",function(e){var t=L(e);return e-t<.5?t:-1===t?-0:t+1},!mn||!gn),x(Math.round,yn);var vn=Math.imul;-5!==Math.imul(4294967295,5)&&(Math.imul=fn.imul,x(Math.imul,vn)),2!==Math.imul.length&&se(Math,"imul",function(e,t){return ye.Call(vn,Math,arguments)});var bn,wn,Tn=function(){var e=j.setTimeout;if("function"==typeof e||"object"===(void 0===e?"undefined":_typeof(e))){ye.IsPromise=function(e){return!!ye.TypeIsObject(e)&&void 0!==e._promise};var t,n=function(e){if(!ye.IsConstructor(e))throw new TypeError("Bad promise constructor");var t=this;if(t.resolve=void 0,t.reject=void 0,t.promise=new e(function(e,n){if(void 0!==t.resolve||void 0!==t.reject)throw new TypeError("Bad Promise implementation!");t.resolve=e,t.reject=n}),!ye.IsCallable(t.resolve)||!ye.IsCallable(t.reject))throw new TypeError("Bad promise constructor")};"undefined"!=typeof window&&ye.IsCallable(window.postMessage)&&(t=function(){var e=[];return window.addEventListener("message",function(t){if(t.source===window&&"zero-timeout-message"===t.data){if(t.stopPropagation(),0===e.length)return;M(e)()}},!0),function(t){P(e,t),window.postMessage("zero-timeout-message","*")}});var a,i,o,s,c,u=ye.IsCallable(j.setImmediate)?j.setImmediate:"object"===("undefined"==typeof process?"undefined":_typeof(process))&&process.nextTick?process.nextTick:(a=j.Promise,(i=a&&a.resolve&&a.resolve())&&function(e){return i.then(e)}||(ye.IsCallable(t)?t():function(t){e(t,0)})),l=function(e){return e},p=function(e){throw e},f={},d=function(e,t,n){u(function(){h(e,t,n)})},h=function(e,t,n){var r,a;if(t===f)return e(n);try{r=e(n),a=t.resolve}catch(e){r=e,a=t.reject}a(r)},y=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(d(n.fulfillReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var a=1,i=0;a<r;a++,i+=3)d(n[i+0],n[i+2],t),e[i+0]=void 0,e[i+1]=void 0,e[i+2]=void 0;n.result=t,n.state=1,n.reactionLength=0},g=function(e,t){var n=e._promise,r=n.reactionLength;if(r>0&&(d(n.rejectReactionHandler0,n.reactionCapability0,t),n.fulfillReactionHandler0=void 0,n.rejectReactions0=void 0,n.reactionCapability0=void 0,r>1))for(var a=1,i=0;a<r;a++,i+=3)d(n[i+1],n[i+2],t),e[i+0]=void 0,e[i+1]=void 0,e[i+2]=void 0;n.result=t,n.state=2,n.reactionLength=0},v=function(e){var t=!1;return{resolve:function(n){var r;if(!t){if(t=!0,n===e)return g(e,new TypeError("Self resolution"));if(!ye.TypeIsObject(n))return y(e,n);try{r=n.then}catch(t){return g(e,t)}if(!ye.IsCallable(r))return y(e,n);u(function(){w(e,n,r)})}},reject:function(n){if(!t)return t=!0,g(e,n)}}},b=function(e,t,n,a){e===s?r(e,t,n,a,f):r(e,t,n,a)},w=function(e,t,n){var r=v(e),a=r.resolve,i=r.reject;try{b(n,t,a,i)}catch(e){i(e)}},T=c=function(e){if(!(this instanceof c))throw new TypeError('Constructor Promise requires "new"');if(this&&this._promise)throw new TypeError("Bad construction");if(!ye.IsCallable(e))throw new TypeError("not a valid resolver");var t=Pe(this,c,o,{_promise:{result:void 0,state:0,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}}),n=v(t),r=n.reject;try{e(n.resolve,r)}catch(e){r(e)}return t};o=T.prototype;var S=function(e,t,n,r){var a=!1;return function(i){a||(a=!0,t[e]=i,0==--r.count&&(0,n.resolve)(t))}};return m(T,{all:function(e){var t=this;if(!ye.TypeIsObject(t))throw new TypeError("Promise is not object");var r,a,i=new n(t);try{return function(e,t,n){for(var r,a,i=e.iterator,o=[],s={count:1},c=0;;){try{if(!1===(r=ye.IteratorStep(i))){e.done=!0;break}a=r.value}catch(t){throw e.done=!0,t}o[c]=void 0;var u=t.resolve(a),l=S(c,o,n,s);s.count+=1,b(u.then,u,l,n.reject),c+=1}0==--s.count&&(0,n.resolve)(o);return n.promise}(a={iterator:r=ye.GetIterator(e),done:!1},t,i)}catch(e){var o=e;if(a&&!a.done)try{ye.IteratorClose(r,!0)}catch(e){o=e}return(0,i.reject)(o),i.promise}},race:function(e){var t=this;if(!ye.TypeIsObject(t))throw new TypeError("Promise is not object");var r,a,i=new n(t);try{return function(e,t,n){for(var r,a,i,o=e.iterator;;){try{if(!1===(r=ye.IteratorStep(o))){e.done=!0;break}a=r.value}catch(t){throw e.done=!0,t}i=t.resolve(a),b(i.then,i,n.resolve,n.reject)}return n.promise}(a={iterator:r=ye.GetIterator(e),done:!1},t,i)}catch(e){var o=e;if(a&&!a.done)try{ye.IteratorClose(r,!0)}catch(e){o=e}return(0,i.reject)(o),i.promise}},reject:function(e){if(!ye.TypeIsObject(this))throw new TypeError("Bad promise constructor");var t=new n(this);return(0,t.reject)(e),t.promise},resolve:function(e){var t=this;if(!ye.TypeIsObject(t))throw new TypeError("Bad promise constructor");if(ye.IsPromise(e)&&e.constructor===t)return e;var r=new n(t);return(0,r.resolve)(e),r.promise}}),m(o,{catch:function(e){return this.then(null,e)},then:function(e,t){if(!ye.IsPromise(this))throw new TypeError("not a promise");var r,a=ye.SpeciesConstructor(this,T);r=arguments.length>2&&arguments[2]===f&&a===T?f:new n(a);var i,o=ye.IsCallable(e)?e:l,s=ye.IsCallable(t)?t:p,c=this._promise;if(0===c.state){if(0===c.reactionLength)c.fulfillReactionHandler0=o,c.rejectReactionHandler0=s,c.reactionCapability0=r;else{var u=3*(c.reactionLength-1);c[u+0]=o,c[u+1]=s,c[u+2]=r}c.reactionLength+=1}else if(1===c.state)i=c.result,d(o,r,i);else{if(2!==c.state)throw new TypeError("unexpected Promise state");i=c.result,d(s,r,i)}return r.promise}}),f=new n(T),s=o.then,T}}();if(j.Promise&&(delete j.Promise.accept,delete j.Promise.defer,delete j.Promise.prototype.chain),"function"==typeof Tn){m(j,{Promise:Tn});var Sn=O(j.Promise,function(e){return e.resolve(42).then(function(){})instanceof e}),xn=!o(function(){return j.Promise.reject(42).then(null,5).then(null,$)}),kn=o(function(){return j.Promise.call(3,$)}),On=function(e){var t=e.resolve(5);t.constructor={};var n=e.resolve(t);try{n.then(null,$).then(null,$)}catch(e){return!0}return t===n}(j.Promise),jn=u&&(bn=0,wn=Object.defineProperty({},"then",{get:function(){bn+=1}}),Promise.resolve(wn),1===bn),An=function e(t){var n=new Promise(t);t(3,function(){}),this.then=n.then,this.constructor=e};An.prototype=Promise.prototype,An.all=Promise.all;var Cn=s(function(){return!!An.all([1,2])});if(Sn&&xn&&kn&&!On&&jn&&!Cn||(Promise=Tn,se(j,"Promise",Tn)),1!==Promise.all.length){var En=Promise.all;se(Promise,"all",function(e){return ye.Call(En,this,arguments)})}if(1!==Promise.race.length){var _n=Promise.race;se(Promise,"race",function(e){return ye.Call(_n,this,arguments)})}if(1!==Promise.resolve.length){var Nn=Promise.resolve;se(Promise,"resolve",function(e){return ye.Call(Nn,this,arguments)})}if(1!==Promise.reject.length){var Pn=Promise.reject;se(Promise,"reject",function(e){return ye.Call(Pn,this,arguments)})}Ot(Promise,"all"),Ot(Promise,"race"),Ot(Promise,"resolve"),Ot(Promise,"reject"),Ee(Promise)}var In,Mn,Dn=function(e){var t=i(f(e,function(e,t){return e[t]=!0,e},{}));return e.join(":")===t.join(":")},Rn=Dn(["z","a","bb"]),Ln=Dn(["z",1,"a","3",2]);if(u){var qn=function(e,t){return t||Rn?he(e)?"^"+ye.ToString(e):"string"==typeof e?"$"+e:"number"==typeof e?Ln?e:"n"+e:"boolean"==typeof e?"b"+e:null:null},Fn=function(){return Object.create?Object.create(null):{}},Vn=function(e,t,n){if(a(n)||ae(n))p(n,function(e){if(!ye.TypeIsObject(e))throw new TypeError("Iterator value "+e+" is not an entry object");t.set(e[0],e[1])});else if(n instanceof e)r(e.prototype.forEach,n,function(e,n){t.set(n,e)});else{var i,o;if(!he(n)){if(o=t.set,!ye.IsCallable(o))throw new TypeError("bad map");i=ye.GetIterator(n)}if(void 0!==i)for(;;){var s=ye.IteratorStep(i);if(!1===s)break;var c=s.value;try{if(!ye.TypeIsObject(c))throw new TypeError("Iterator value "+c+" is not an entry object");r(o,t,c[0],c[1])}catch(e){throw ye.IteratorClose(i,!0),e}}}},Hn=function(e,t,n){if(a(n)||ae(n))p(n,function(e){t.add(e)});else if(n instanceof e)r(e.prototype.forEach,n,function(e){t.add(e)});else{var i,o;if(!he(n)){if(o=t.add,!ye.IsCallable(o))throw new TypeError("bad set");i=ye.GetIterator(n)}if(void 0!==i)for(;;){var s=ye.IteratorStep(i);if(!1===s)break;var c=s.value;try{r(o,t,c)}catch(e){throw ye.IteratorClose(i,!0),e}}}},zn={Map:function(){var e={},t=function(e,t){this.key=e,this.value=t,this.next=null,this.prev=null};t.prototype.isRemoved=function(){return this.key===e};var n,a=function(e,t){if(!ye.TypeIsObject(e)||!function(e){return!!e._es6map}(e))throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ye.ToString(e))},i=function(e,t){a(e,"[[MapIterator]]"),this.head=e._head,this.i=this.head,this.kind=t};_e(i.prototype={isMapIterator:!0,next:function(){if(!this.isMapIterator)throw new TypeError("Not a MapIterator");var e,t=this.i,n=this.kind,r=this.head;if(void 0===this.i)return We();for(;t.isRemoved()&&t!==r;)t=t.prev;for(;t.next!==r;)if(!(t=t.next).isRemoved())return e="key"===n?t.key:"value"===n?t.value:[t.key,t.value],this.i=t,We(e);return this.i=void 0,We()}});var o=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');if(this&&this._es6map)throw new TypeError("Bad construction");var r=Pe(this,e,n,{_es6map:!0,_head:null,_map:B?new B:null,_size:0,_storage:Fn()}),a=new t(null,null);return a.next=a.prev=a,r._head=a,arguments.length>0&&Vn(e,r,arguments[0]),r};return b(n=o.prototype,"size",function(){if(void 0===this._size)throw new TypeError("size method called on incompatible Map");return this._size}),m(n,{get:function(e){var t;a(this,"get");var n=qn(e,!0);if(null!==n)return(t=this._storage[n])?t.value:void 0;if(this._map)return(t=U.call(this._map,e))?t.value:void 0;for(var r=this._head,i=r;(i=i.next)!==r;)if(ye.SameValueZero(i.key,e))return i.value},has:function(e){a(this,"has");var t=qn(e,!0);if(null!==t)return void 0!==this._storage[t];if(this._map)return G.call(this._map,e);for(var n=this._head,r=n;(r=r.next)!==n;)if(ye.SameValueZero(r.key,e))return!0;return!1},set:function(e,n){a(this,"set");var r,i=this._head,o=i,s=qn(e,!0);if(null!==s){if(void 0!==this._storage[s])return this._storage[s].value=n,this;r=this._storage[s]=new t(e,n),o=i.prev}else this._map&&(G.call(this._map,e)?U.call(this._map,e).value=n:(r=new t(e,n),X.call(this._map,e,r),o=i.prev));for(;(o=o.next)!==i;)if(ye.SameValueZero(o.key,e))return o.value=n,this;return r=r||new t(e,n),ye.SameValue(-0,e)&&(r.key=0),r.next=this._head,r.prev=this._head.prev,r.prev.next=r,r.next.prev=r,this._size+=1,this},delete:function(t){a(this,"delete");var n=this._head,r=n,i=qn(t,!0);if(null!==i){if(void 0===this._storage[i])return!1;r=this._storage[i].prev,delete this._storage[i]}else if(this._map){if(!G.call(this._map,t))return!1;r=U.call(this._map,t).prev,W.call(this._map,t)}for(;(r=r.next)!==n;)if(ye.SameValueZero(r.key,t))return r.key=e,r.value=e,r.prev.next=r.next,r.next.prev=r.prev,this._size-=1,!0;return!1},clear:function(){a(this,"clear"),this._map=B?new B:null,this._size=0,this._storage=Fn();for(var t=this._head,n=t,r=n.next;(n=r)!==t;)n.key=e,n.value=e,r=n.next,n.next=n.prev=t;t.next=t.prev=t},keys:function(){return a(this,"keys"),new i(this,"key")},values:function(){return a(this,"values"),new i(this,"value")},entries:function(){return a(this,"entries"),new i(this,"key+value")},forEach:function(e){a(this,"forEach");for(var t=arguments.length>1?arguments[1]:null,n=this.entries(),i=n.next();!i.done;i=n.next())t?r(e,t,i.value[1],i.value[0],this):e(i.value[1],i.value[0],this)}}),_e(n,n.entries),o}(),Set:function(){var e,t=function(e,t){if(!ye.TypeIsObject(e)||!function(e){return e._es6set&&void 0!==e._storage}(e))throw new TypeError("Set.prototype."+t+" called on incompatible receiver "+ye.ToString(e))},n=function t(){if(!(this instanceof t))throw new TypeError('Constructor Set requires "new"');if(this&&this._es6set)throw new TypeError("Bad construction");var n=Pe(this,t,e,{_es6set:!0,"[[SetData]]":null,_storage:Fn()});if(!n._es6set)throw new TypeError("bad set");return arguments.length>0&&Hn(t,n,arguments[0]),n};e=n.prototype;var a=function(e){if(!e["[[SetData]]"]){var t=new zn.Map;e["[[SetData]]"]=t,p(i(e._storage),function(e){var n=function(e){var t=e;if("^null"===t)return null;if("^undefined"!==t){var n=t.charAt(0);return"$"===n?N(t,1):"n"===n?+N(t,1):"b"===n?"btrue"===t:+t}}(e);t.set(n,n)}),e["[[SetData]]"]=t}e._storage=null};b(n.prototype,"size",function(){return t(this,"size"),this._storage?i(this._storage).length:(a(this),this["[[SetData]]"].size)}),m(n.prototype,{has:function(e){var n;return t(this,"has"),this._storage&&null!==(n=qn(e))?!!this._storage[n]:(a(this),this["[[SetData]]"].has(e))},add:function(e){var n;return t(this,"add"),this._storage&&null!==(n=qn(e))?(this._storage[n]=!0,this):(a(this),this["[[SetData]]"].set(e,e),this)},delete:function(e){var n;if(t(this,"delete"),this._storage&&null!==(n=qn(e))){var r=z(this._storage,n);return delete this._storage[n]&&r}return a(this),this["[[SetData]]"].delete(e)},clear:function(){t(this,"clear"),this._storage&&(this._storage=Fn()),this["[[SetData]]"]&&this["[[SetData]]"].clear()},values:function(){return t(this,"values"),a(this),new o(this["[[SetData]]"].values())},entries:function(){return t(this,"entries"),a(this),new o(this["[[SetData]]"].entries())},forEach:function(e){t(this,"forEach");var n=arguments.length>1?arguments[1]:null,i=this;a(i),this["[[SetData]]"].forEach(function(t,a){n?r(e,n,a,a,i):e(a,a,i)})}}),y(n.prototype,"keys",n.prototype.values,!0),_e(n.prototype,n.prototype.values);var o=function(e){this.it=e};return o.prototype={isSetIterator:!0,next:function(){if(!this.isSetIterator)throw new TypeError("Not a SetIterator");return this.it.next()}},_e(o.prototype),n}()};if(j.Set&&!Set.prototype.delete&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys)&&(j.Set=zn.Set),j.Map||j.Set){s(function(){return 2===new Map([[1,2]]).get(1)})||(j.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new B;return arguments.length>0&&Vn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,j.Map.prototype),t},j.Map.prototype=k(B.prototype),y(j.Map.prototype,"constructor",j.Map,!0),x(j.Map,B));var $n=new Map,Bn=((Mn=new Map([[1,0],[2,0],[3,0],[4,0]])).set(-0,Mn),Mn.get(0)===Mn&&Mn.get(-0)===Mn&&Mn.has(0)&&Mn.has(-0)),Wn=$n.set(1,2)===$n;Bn&&Wn||se(Map.prototype,"set",function(e,t){return r(X,this,0===e?0:e,t),this}),Bn||(m(Map.prototype,{get:function(e){return r(U,this,0===e?0:e)},has:function(e){return r(G,this,0===e?0:e)}},!0),x(Map.prototype.get,U),x(Map.prototype.has,G));var Un=new Set,Gn=Set.prototype.delete&&Set.prototype.add&&Set.prototype.has&&((In=Un).delete(0),In.add(-0),!In.has(0)),Xn=Un.add(1)===Un;if(!Gn||!Xn){var Yn=Set.prototype.add;Set.prototype.add=function(e){return r(Yn,this,0===e?0:e),this},x(Set.prototype.add,Yn)}if(!Gn){var Jn=Set.prototype.has;Set.prototype.has=function(e){return r(Jn,this,0===e?0:e)},x(Set.prototype.has,Jn);var Kn=Set.prototype.delete;Set.prototype.delete=function(e){return r(Kn,this,0===e?0:e)},x(Set.prototype.delete,Kn)}var Zn=O(j.Map,function(e){var t=new e([]);return t.set(42,42),t instanceof e}),Qn=Object.setPrototypeOf&&!Zn,er=function(){try{return!(j.Map()instanceof j.Map)}catch(e){return e instanceof TypeError}}();0===j.Map.length&&!Qn&&er||(j.Map=function e(){if(!(this instanceof e))throw new TypeError('Constructor Map requires "new"');var t=new B;return arguments.length>0&&Vn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},j.Map.prototype=B.prototype,y(j.Map.prototype,"constructor",j.Map,!0),x(j.Map,B));var tr=O(j.Set,function(e){var t=new e([]);return t.add(42,42),t instanceof e}),nr=Object.setPrototypeOf&&!tr,rr=function(){try{return!(j.Set()instanceof j.Set)}catch(e){return e instanceof TypeError}}();if(0!==j.Set.length||nr||!rr){var ar=j.Set;j.Set=function e(){if(!(this instanceof e))throw new TypeError('Constructor Set requires "new"');var t=new ar;return arguments.length>0&&Hn(e,t,arguments[0]),delete t.constructor,Object.setPrototypeOf(t,e.prototype),t},j.Set.prototype=ar.prototype,y(j.Set.prototype,"constructor",j.Set,!0),x(j.Set,ar)}var ir=new j.Map,or=!s(function(){return ir.keys().next().done});if(("function"!=typeof j.Map.prototype.clear||0!==(new j.Set).size||0!==ir.size||"function"!=typeof j.Map.prototype.keys||"function"!=typeof j.Set.prototype.keys||"function"!=typeof j.Map.prototype.forEach||"function"!=typeof j.Set.prototype.forEach||c(j.Map)||c(j.Set)||"function"!=typeof ir.keys().next||or||!Zn)&&m(j,{Map:zn.Map,Set:zn.Set},!0),j.Set.prototype.keys!==j.Set.prototype.values&&y(j.Set.prototype,"keys",j.Set.prototype.values,!0),_e(Object.getPrototypeOf((new j.Map).keys())),_e(Object.getPrototypeOf((new j.Set).keys())),l&&"has"!==j.Set.prototype.has.name){var sr=j.Set.prototype.has;se(j.Set.prototype,"has",function(e){return r(sr,this,e)})}}m(j,zn),Ee(j.Map),Ee(j.Set)}var cr=function(e){if(!ye.TypeIsObject(e))throw new TypeError("target must be an object")},ur={apply:function(){return ye.Call(ye.Call,null,arguments)},construct:function(e,t){if(!ye.IsConstructor(e))throw new TypeError("First argument must be a constructor.");var n=arguments.length>2?arguments[2]:e;if(!ye.IsConstructor(n))throw new TypeError("new.target must be a constructor.");return ye.Construct(e,t,n,"internal")},deleteProperty:function(e,t){if(cr(e),u){var n=Object.getOwnPropertyDescriptor(e,t);if(n&&!n.configurable)return!1}return delete e[t]},has:function(e,t){return cr(e),t in e}};Object.getOwnPropertyNames&&Object.assign(ur,{ownKeys:function(e){cr(e);var t=Object.getOwnPropertyNames(e);return ye.IsCallable(Object.getOwnPropertySymbols)&&I(t,Object.getOwnPropertySymbols(e)),t}});var lr=function(e){return!o(e)};if(Object.preventExtensions&&Object.assign(ur,{isExtensible:function(e){return cr(e),Object.isExtensible(e)},preventExtensions:function(e){return cr(e),lr(function(){return Object.preventExtensions(e)})}}),u){var pr=function(e,t,n){var r=Object.getOwnPropertyDescriptor(e,t);if(!r){var a=Object.getPrototypeOf(e);if(null===a)return;return pr(a,t,n)}return"value"in r?r.value:r.get?ye.Call(r.get,n):void 0},fr=function(e,t,n,a){var i=Object.getOwnPropertyDescriptor(e,t);if(!i){var o=Object.getPrototypeOf(e);if(null!==o)return fr(o,t,n,a);i={value:void 0,writable:!0,enumerable:!0,configurable:!0}}return"value"in i?!!i.writable&&(!!ye.TypeIsObject(a)&&(Object.getOwnPropertyDescriptor(a,t)?pe.defineProperty(a,t,{value:n}):pe.defineProperty(a,t,{value:n,writable:!0,enumerable:!0,configurable:!0}))):!!i.set&&(r(i.set,a,n),!0)};Object.assign(ur,{defineProperty:function(e,t,n){return cr(e),lr(function(){return Object.defineProperty(e,t,n)})},getOwnPropertyDescriptor:function(e,t){return cr(e),Object.getOwnPropertyDescriptor(e,t)},get:function(e,t){cr(e);var n=arguments.length>2?arguments[2]:e;return pr(e,t,n)},set:function(e,t,n){cr(e);var r=arguments.length>3?arguments[3]:e;return fr(e,t,n,r)}})}if(Object.getPrototypeOf){var dr=Object.getPrototypeOf;ur.getPrototypeOf=function(e){return cr(e),dr(e)}}if(Object.setPrototypeOf&&ur.getPrototypeOf){Object.assign(ur,{setPrototypeOf:function(e,t){if(cr(e),null!==t&&!ye.TypeIsObject(t))throw new TypeError("proto must be an object or null");return t===pe.getPrototypeOf(e)||!(pe.isExtensible&&!pe.isExtensible(e))&&(!function(e,t){for(var n=t;n;){if(e===n)return!0;n=ur.getPrototypeOf(n)}return!1}(e,t)&&(Object.setPrototypeOf(e,t),!0))}})}Object.keys(ur).forEach(function(e){!function(e,t){ye.IsCallable(j.Reflect[e])?s(function(){return j.Reflect[e](1),j.Reflect[e](NaN),j.Reflect[e](!0),!0})&&se(j.Reflect,e,t):y(j.Reflect,e,t)}(e,ur[e])});var hr=j.Reflect.getPrototypeOf;if(l&&hr&&"getPrototypeOf"!==hr.name&&se(j.Reflect,"getPrototypeOf",function(e){return r(hr,j.Reflect,e)}),j.Reflect.setPrototypeOf&&s(function(){return j.Reflect.setPrototypeOf(1,{}),!0})&&se(j.Reflect,"setPrototypeOf",ur.setPrototypeOf),j.Reflect.defineProperty&&(s(function(){var e=!j.Reflect.defineProperty(1,"test",{value:1}),t="function"!=typeof Object.preventExtensions||!j.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})||se(j.Reflect,"defineProperty",ur.defineProperty)),j.Reflect.construct&&(s(function(){var e=function(){};return j.Reflect.construct(function(){},[],e)instanceof e})||se(j.Reflect,"construct",ur.construct)),"Invalid Date"!==String(new Date(NaN))){var yr=Date.prototype.toString;se(Date.prototype,"toString",function(){var e=+this;return e!=e?"Invalid Date":ye.Call(yr,this)})}var mr={anchor:function(e){return ye.CreateHTML(this,"a","name",e)},big:function(){return ye.CreateHTML(this,"big","","")},blink:function(){return ye.CreateHTML(this,"blink","","")},bold:function(){return ye.CreateHTML(this,"b","","")},fixed:function(){return ye.CreateHTML(this,"tt","","")},fontcolor:function(e){return ye.CreateHTML(this,"font","color",e)},fontsize:function(e){return ye.CreateHTML(this,"font","size",e)},italics:function(){return ye.CreateHTML(this,"i","","")},link:function(e){return ye.CreateHTML(this,"a","href",e)},small:function(){return ye.CreateHTML(this,"small","","")},strike:function(){return ye.CreateHTML(this,"strike","","")},sub:function(){return ye.CreateHTML(this,"sub","","")},sup:function(){return ye.CreateHTML(this,"sup","","")}};p(Object.keys(mr),function(e){var t=String.prototype[e],n=!1;if(ye.IsCallable(t)){var a=r(t,"",' " '),i=_([],a.match(/"/g)).length;n=a!==a.toLowerCase()||i>2}else n=!0;n&&se(String.prototype,e,mr[e])});var gr=function(){if(!ce)return!1;var e="object"===("undefined"==typeof JSON?"undefined":_typeof(JSON))&&"function"==typeof JSON.stringify?JSON.stringify:null;if(!e)return!1;if(void 0!==e(Y()))return!0;if("[null]"!==e([Y()]))return!0;var t={a:Y()};return t[Y()]=!0,"{}"!==e(t)}(),vr=s(function(){return!ce||"{}"===JSON.stringify(Object(Y()))&&"[{}]"===JSON.stringify([Object(Y())])});if(gr||!vr){var br=JSON.stringify;se(JSON,"stringify",function(e){if("symbol"!==(void 0===e?"undefined":_typeof(e))){var t;arguments.length>1&&(t=arguments[1]);var n=[e];if(a(t))n.push(t);else{var i=ye.IsCallable(t)?t:null;n.push(function(e,t){var n=i?r(i,this,e,t):t;if("symbol"!==(void 0===n?"undefined":_typeof(n)))return oe(n)?At({})(n):n})}return arguments.length>2&&n.push(arguments[2]),br.apply(this,n)}})}return j},"function"==typeof define&&define.amd?define("es6-shim",factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=factory():root.returnExports=factory(),function(e,t){"object"===("undefined"==typeof module?"undefined":_typeof(module))&&"object"===_typeof(module.exports)?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){var n=[],r=Object.getPrototypeOf,a=n.slice,i=n.flat?function(e){return n.flat.call(e)}:function(e){return n.concat.apply([],e)},o=n.push,s=n.indexOf,c={},u=c.toString,l=c.hasOwnProperty,p=l.toString,f=p.call(Object),d={},h=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},y=function(e){return null!=e&&e===e.window},m=e.document,g={type:!0,src:!0,nonce:!0,noModule:!0};function v(e,t,n){var r,a,i=(n=n||m).createElement("script");if(i.text=e,t)for(r in g)(a=t[r]||t.getAttribute&&t.getAttribute(r))&&i.setAttribute(r,a);n.head.appendChild(i).parentNode.removeChild(i)}function b(e){return null==e?e+"":"object"===(void 0===e?"undefined":_typeof(e))||"function"==typeof e?c[u.call(e)]||"object":void 0===e?"undefined":_typeof(e)}var w=function e(t,n){return new e.fn.init(t,n)};function T(e){var t=!!e&&"length"in e&&e.length,n=b(e);return!h(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e)}w.fn=w.prototype={jquery:"3.5.1",constructor:w,length:0,toArray:function(){return a.call(this)},get:function(e){return null==e?a.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=w.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return w.each(this,e)},map:function(e){return this.pushStack(w.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(a.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(w.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(w.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:o,sort:n.sort,splice:n.splice},w.extend=w.fn.extend=function(){var e,t,n,r,a,i,o=arguments[0]||{},s=1,c=arguments.length,u=!1;for("boolean"==typeof o&&(u=o,o=arguments[s]||{},s++),"object"===(void 0===o?"undefined":_typeof(o))||h(o)||(o={}),s===c&&(o=this,s--);s<c;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&o!==r&&(u&&r&&(w.isPlainObject(r)||(a=Array.isArray(r)))?(n=o[t],i=a&&!Array.isArray(n)?[]:a||w.isPlainObject(n)?n:{},a=!1,o[t]=w.extend(u,i,r)):void 0!==r&&(o[t]=r));return o},w.extend({expando:"jQuery"+("3.5.1"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==u.call(e))&&(!(t=r(e))||"function"==typeof(n=l.call(t,"constructor")&&t.constructor)&&p.call(n)===f)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){v(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(T(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},makeArray:function(e,t){var n=t||[];return null!=e&&(T(Object(e))?w.merge(n,"string"==typeof e?[e]:e):o.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:s.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,a=e.length;r<n;r++)e[a++]=t[r];return e.length=a,e},grep:function(e,t,n){for(var r=[],a=0,i=e.length,o=!n;a<i;a++)!t(e[a],a)!==o&&r.push(e[a]);return r},map:function(e,t,n){var r,a,o=0,s=[];if(T(e))for(r=e.length;o<r;o++)null!=(a=t(e[o],o,n))&&s.push(a);else for(o in e)null!=(a=t(e[o],o,n))&&s.push(a);return i(s)},guid:1,support:d}),"function"==typeof Symbol&&(w.fn[Symbol.iterator]=n[Symbol.iterator]),w.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){c["[object "+t+"]"]=t.toLowerCase()});var S=function(e){var t,n,r,a,i,o,s,c,u,l,p,f,d,h,y,m,g,v,b,w="sizzle"+1*new Date,T=e.document,S=0,x=0,k=ce(),O=ce(),j=ce(),A=ce(),C=function(e,t){return e===t&&(p=!0),0},E={}.hasOwnProperty,_=[],N=_.pop,P=_.push,I=_.push,M=_.slice,D=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",q="(?:\\\\[\\da-fA-F]{1,6}"+L+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",F="\\["+L+"*("+q+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+q+"))|)"+L+"*\\]",V=":("+q+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+F+")*)|.*)\\)|)",H=new RegExp(L+"+","g"),z=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),$=new RegExp("^"+L+"*,"+L+"*"),B=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),W=new RegExp(L+"|>"),U=new RegExp(V),G=new RegExp("^"+q+"$"),X={ID:new RegExp("^#("+q+")"),CLASS:new RegExp("^\\.("+q+")"),TAG:new RegExp("^("+q+"|[*])"),ATTR:new RegExp("^"+F),PSEUDO:new RegExp("^"+V),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,J=/^(?:input|select|textarea|button)$/i,K=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,Q=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\[\\da-fA-F]{1,6}"+L+"?|\\\\([^\\r\\n\\f])","g"),ne=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ae=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},ie=function(){f()},oe=we(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{I.apply(_=M.call(T.childNodes),T.childNodes),_[T.childNodes.length].nodeType}catch(e){I={apply:_.length?function(e,t){P.apply(e,M.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}function se(e,t,r,a){var i,s,u,l,p,h,g,v=t&&t.ownerDocument,T=t?t.nodeType:9;if(r=r||[],"string"!=typeof e||!e||1!==T&&9!==T&&11!==T)return r;if(!a&&(f(t),t=t||d,y)){if(11!==T&&(p=Q.exec(e)))if(i=p[1]){if(9===T){if(!(u=t.getElementById(i)))return r;if(u.id===i)return r.push(u),r}else if(v&&(u=v.getElementById(i))&&b(t,u)&&u.id===i)return r.push(u),r}else{if(p[2])return I.apply(r,t.getElementsByTagName(e)),r;if((i=p[3])&&n.getElementsByClassName&&t.getElementsByClassName)return I.apply(r,t.getElementsByClassName(i)),r}if(n.qsa&&!A[e+" "]&&(!m||!m.test(e))&&(1!==T||"object"!==t.nodeName.toLowerCase())){if(g=e,v=t,1===T&&(W.test(e)||B.test(e))){for((v=ee.test(e)&&ge(t.parentNode)||t)===t&&n.scope||((l=t.getAttribute("id"))?l=l.replace(re,ae):t.setAttribute("id",l=w)),s=(h=o(e)).length;s--;)h[s]=(l?"#"+l:":scope")+" "+be(h[s]);g=h.join(",")}try{return I.apply(r,v.querySelectorAll(g)),r}catch(t){A(e,!0)}finally{l===w&&t.removeAttribute("id")}}}return c(e.replace(z,"$1"),t,r,a)}function ce(){var e=[];return function t(n,a){return e.push(n+" ")>r.cacheLength&&delete t[e.shift()],t[n+" "]=a}}function ue(e){return e[w]=!0,e}function le(e){var t=d.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function pe(e,t){for(var n=e.split("|"),a=n.length;a--;)r.attrHandle[n[a]]=t}function fe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function de(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}function he(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function ye(e){return function(t){return"form"in t?t.parentNode&&!1===t.disabled?"label"in t?"label"in t.parentNode?t.parentNode.disabled===e:t.disabled===e:t.isDisabled===e||t.isDisabled!==!e&&oe(t)===e:t.disabled===e:"label"in t&&t.disabled===e}}function me(e){return ue(function(t){return t=+t,ue(function(n,r){for(var a,i=e([],n.length,t),o=i.length;o--;)n[a=i[o]]&&(n[a]=!(r[a]=n[a]))})})}function ge(e){return e&&void 0!==e.getElementsByTagName&&e}for(t in n=se.support={},i=se.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},f=se.setDocument=function(e){var t,a,o=e?e.ownerDocument||e:T;return o!=d&&9===o.nodeType&&o.documentElement?(h=(d=o).documentElement,y=!i(d),T!=d&&(a=d.defaultView)&&a.top!==a&&(a.addEventListener?a.addEventListener("unload",ie,!1):a.attachEvent&&a.attachEvent("onunload",ie)),n.scope=le(function(e){return h.appendChild(e).appendChild(d.createElement("div")),void 0!==e.querySelectorAll&&!e.querySelectorAll(":scope fieldset div").length}),n.attributes=le(function(e){return e.className="i",!e.getAttribute("className")}),n.getElementsByTagName=le(function(e){return e.appendChild(d.createComment("")),!e.getElementsByTagName("*").length}),n.getElementsByClassName=Z.test(d.getElementsByClassName),n.getById=le(function(e){return h.appendChild(e).id=w,!d.getElementsByName||!d.getElementsByName(w).length}),n.getById?(r.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&y){var n=t.getElementById(e);return n?[n]:[]}}):(r.filter.ID=function(e){var t=e.replace(te,ne);return function(e){var n=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}},r.find.ID=function(e,t){if(void 0!==t.getElementById&&y){var n,r,a,i=t.getElementById(e);if(i){if((n=i.getAttributeNode("id"))&&n.value===e)return[i];for(a=t.getElementsByName(e),r=0;i=a[r++];)if((n=i.getAttributeNode("id"))&&n.value===e)return[i]}return[]}}),r.find.TAG=n.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):n.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],a=0,i=t.getElementsByTagName(e);if("*"===e){for(;n=i[a++];)1===n.nodeType&&r.push(n);return r}return i},r.find.CLASS=n.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&y)return t.getElementsByClassName(e)},g=[],m=[],(n.qsa=Z.test(d.querySelectorAll))&&(le(function(e){var t;h.appendChild(e).innerHTML="<a id='"+w+"'></a><select id='"+w+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&m.push("[*^$]="+L+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||m.push("\\["+L+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+w+"-]").length||m.push("~="),(t=d.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||m.push("\\["+L+"*name"+L+"*="+L+"*(?:''|\"\")"),e.querySelectorAll(":checked").length||m.push(":checked"),e.querySelectorAll("a#"+w+"+*").length||m.push(".#.+[+~]"),e.querySelectorAll("\\\f"),m.push("[\\r\\n\\f]")}),le(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=d.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&m.push("name"+L+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&m.push(":enabled",":disabled"),h.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&m.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),m.push(",.*:")})),(n.matchesSelector=Z.test(v=h.matches||h.webkitMatchesSelector||h.mozMatchesSelector||h.oMatchesSelector||h.msMatchesSelector))&&le(function(e){n.disconnectedMatch=v.call(e,"*"),v.call(e,"[s!='']:x"),g.push("!=",V)}),m=m.length&&new RegExp(m.join("|")),g=g.length&&new RegExp(g.join("|")),t=Z.test(h.compareDocumentPosition),b=t||Z.test(h.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},C=t?function(e,t){if(e===t)return p=!0,0;var r=!e.compareDocumentPosition-!t.compareDocumentPosition;return r||(1&(r=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!n.sortDetached&&t.compareDocumentPosition(e)===r?e==d||e.ownerDocument==T&&b(T,e)?-1:t==d||t.ownerDocument==T&&b(T,t)?1:l?D(l,e)-D(l,t):0:4&r?-1:1)}:function(e,t){if(e===t)return p=!0,0;var n,r=0,a=e.parentNode,i=t.parentNode,o=[e],s=[t];if(!a||!i)return e==d?-1:t==d?1:a?-1:i?1:l?D(l,e)-D(l,t):0;if(a===i)return fe(e,t);for(n=e;n=n.parentNode;)o.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;o[r]===s[r];)r++;return r?fe(o[r],s[r]):o[r]==T?-1:s[r]==T?1:0},d):d},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if(f(e),n.matchesSelector&&y&&!A[t+" "]&&(!g||!g.test(t))&&(!m||!m.test(t)))try{var r=v.call(e,t);if(r||n.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(e){A(t,!0)}return se(t,d,null,[e]).length>0},se.contains=function(e,t){return(e.ownerDocument||e)!=d&&f(e),b(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!=d&&f(e);var a=r.attrHandle[t.toLowerCase()],i=a&&E.call(r.attrHandle,t.toLowerCase())?a(e,t,!y):void 0;return void 0!==i?i:n.attributes||!y?e.getAttribute(t):(i=e.getAttributeNode(t))&&i.specified?i.value:null},se.escape=function(e){return(e+"").replace(re,ae)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,r=[],a=0,i=0;if(p=!n.detectDuplicates,l=!n.sortStable&&e.slice(0),e.sort(C),p){for(;t=e[i++];)t===e[i]&&(a=r.push(i));for(;a--;)e.splice(r[a],1)}return l=null,e},a=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=a(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r++];)n+=a(t);return n},(r=se.selectors={cacheLength:50,createPseudo:ue,match:X,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return X.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&U.test(n)&&(t=o(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=k[e+" "];return t||(t=new RegExp("(^|"+L+")"+e+"("+L+"|$)"))&&k(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var a=se.attr(r,e);return null==a?"!="===t:!t||(a+="","="===t?a===n:"!="===t?a!==n:"^="===t?n&&0===a.indexOf(n):"*="===t?n&&a.indexOf(n)>-1:"$="===t?n&&a.slice(-n.length)===n:"~="===t?(" "+a.replace(H," ")+" ").indexOf(n)>-1:"|="===t&&(a===n||a.slice(0,n.length+1)===n+"-"))}},CHILD:function(e,t,n,r,a){var i="nth"!==e.slice(0,3),o="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===a?function(e){return!!e.parentNode}:function(t,n,c){var u,l,p,f,d,h,y=i!==o?"nextSibling":"previousSibling",m=t.parentNode,g=s&&t.nodeName.toLowerCase(),v=!c&&!s,b=!1;if(m){if(i){for(;y;){for(f=t;f=f[y];)if(s?f.nodeName.toLowerCase()===g:1===f.nodeType)return!1;h=y="only"===e&&!h&&"nextSibling"}return!0}if(h=[o?m.firstChild:m.lastChild],o&&v){for(b=(d=(u=(l=(p=(f=m)[w]||(f[w]={}))[f.uniqueID]||(p[f.uniqueID]={}))[e]||[])[0]===S&&u[1])&&u[2],f=d&&m.childNodes[d];f=++d&&f&&f[y]||(b=d=0)||h.pop();)if(1===f.nodeType&&++b&&f===t){l[e]=[S,d,b];break}}else if(v&&(b=d=(u=(l=(p=(f=t)[w]||(f[w]={}))[f.uniqueID]||(p[f.uniqueID]={}))[e]||[])[0]===S&&u[1]),!1===b)for(;(f=++d&&f&&f[y]||(b=d=0)||h.pop())&&((s?f.nodeName.toLowerCase()!==g:1!==f.nodeType)||!++b||(v&&((l=(p=f[w]||(f[w]={}))[f.uniqueID]||(p[f.uniqueID]={}))[e]=[S,b]),f!==t)););return(b-=a)===r||b%r==0&&b/r>=0}}},PSEUDO:function(e,t){var n,a=r.pseudos[e]||r.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[w]?a(t):a.length>1?(n=[e,e,"",t],r.setFilters.hasOwnProperty(e.toLowerCase())?ue(function(e,n){for(var r,i=a(e,t),o=i.length;o--;)e[r=D(e,i[o])]=!(n[r]=i[o])}):function(e){return a(e,0,n)}):a}},pseudos:{not:ue(function(e){var t=[],n=[],r=s(e.replace(z,"$1"));return r[w]?ue(function(e,t,n,a){for(var i,o=r(e,null,a,[]),s=e.length;s--;)(i=o[s])&&(e[s]=!(t[s]=i))}):function(e,a,i){return t[0]=e,r(t,null,i,n),t[0]=null,!n.pop()}}),has:ue(function(e){return function(t){return se(e,t).length>0}}),contains:ue(function(e){return e=e.replace(te,ne),function(t){return(t.textContent||a(t)).indexOf(e)>-1}}),lang:ue(function(e){return G.test(e||"")||se.error("unsupported lang: "+e),e=e.replace(te,ne).toLowerCase(),function(t){var n;do{if(n=y?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===h},focus:function(e){return e===d.activeElement&&(!d.hasFocus||d.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ye(!1),disabled:ye(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!r.pseudos.empty(e)},header:function(e){return K.test(e.nodeName)},input:function(e){return J.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:me(function(){return[0]}),last:me(function(e,t){return[t-1]}),eq:me(function(e,t,n){return[n<0?n+t:n]}),even:me(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:me(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:me(function(e,t,n){for(var r=n<0?n+t:n>t?t:n;--r>=0;)e.push(r);return e}),gt:me(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=r.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})r.pseudos[t]=de(t);for(t in{submit:!0,reset:!0})r.pseudos[t]=he(t);function ve(){}function be(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function we(e,t,n){var r=t.dir,a=t.next,i=a||r,o=n&&"parentNode"===i,s=x++;return t.first?function(t,n,a){for(;t=t[r];)if(1===t.nodeType||o)return e(t,n,a);return!1}:function(t,n,c){var u,l,p,f=[S,s];if(c){for(;t=t[r];)if((1===t.nodeType||o)&&e(t,n,c))return!0}else for(;t=t[r];)if(1===t.nodeType||o)if(l=(p=t[w]||(t[w]={}))[t.uniqueID]||(p[t.uniqueID]={}),a&&a===t.nodeName.toLowerCase())t=t[r]||t;else{if((u=l[i])&&u[0]===S&&u[1]===s)return f[2]=u[2];if(l[i]=f,f[2]=e(t,n,c))return!0}return!1}}function Te(e){return e.length>1?function(t,n,r){for(var a=e.length;a--;)if(!e[a](t,n,r))return!1;return!0}:e[0]}function Se(e,t,n,r,a){for(var i,o=[],s=0,c=e.length,u=null!=t;s<c;s++)(i=e[s])&&(n&&!n(i,r,a)||(o.push(i),u&&t.push(s)));return o}function xe(e,t,n,r,a,i){return r&&!r[w]&&(r=xe(r)),a&&!a[w]&&(a=xe(a,i)),ue(function(i,o,s,c){var u,l,p,f=[],d=[],h=o.length,y=i||function(e,t,n){for(var r=0,a=t.length;r<a;r++)se(e,t[r],n);return n}(t||"*",s.nodeType?[s]:s,[]),m=!e||!i&&t?y:Se(y,f,e,s,c),g=n?a||(i?e:h||r)?[]:o:m;if(n&&n(m,g,s,c),r)for(u=Se(g,d),r(u,[],s,c),l=u.length;l--;)(p=u[l])&&(g[d[l]]=!(m[d[l]]=p));if(i){if(a||e){if(a){for(u=[],l=g.length;l--;)(p=g[l])&&u.push(m[l]=p);a(null,g=[],u,c)}for(l=g.length;l--;)(p=g[l])&&(u=a?D(i,p):f[l])>-1&&(i[u]=!(o[u]=p))}}else g=Se(g===o?g.splice(h,g.length):g),a?a(null,o,g,c):I.apply(o,g)})}function ke(e){for(var t,n,a,i=e.length,o=r.relative[e[0].type],s=o||r.relative[" "],c=o?1:0,l=we(function(e){return e===t},s,!0),p=we(function(e){return D(t,e)>-1},s,!0),f=[function(e,n,r){var a=!o&&(r||n!==u)||((t=n).nodeType?l(e,n,r):p(e,n,r));return t=null,a}];c<i;c++)if(n=r.relative[e[c].type])f=[we(Te(f),n)];else{if((n=r.filter[e[c].type].apply(null,e[c].matches))[w]){for(a=++c;a<i&&!r.relative[e[a].type];a++);return xe(c>1&&Te(f),c>1&&be(e.slice(0,c-1).concat({value:" "===e[c-2].type?"*":""})).replace(z,"$1"),n,c<a&&ke(e.slice(c,a)),a<i&&ke(e=e.slice(a)),a<i&&be(e))}f.push(n)}return Te(f)}return ve.prototype=r.filters=r.pseudos,r.setFilters=new ve,o=se.tokenize=function(e,t){var n,a,i,o,s,c,u,l=O[e+" "];if(l)return t?0:l.slice(0);for(s=e,c=[],u=r.preFilter;s;){for(o in n&&!(a=$.exec(s))||(a&&(s=s.slice(a[0].length)||s),c.push(i=[])),n=!1,(a=B.exec(s))&&(n=a.shift(),i.push({value:n,type:a[0].replace(z," ")}),s=s.slice(n.length)),r.filter)!(a=X[o].exec(s))||u[o]&&!(a=u[o](a))||(n=a.shift(),i.push({value:n,type:o,matches:a}),s=s.slice(n.length));if(!n)break}return t?s.length:s?se.error(e):O(e,c).slice(0)},s=se.compile=function(e,t){var n,a=[],i=[],s=j[e+" "];if(!s){for(t||(t=o(e)),n=t.length;n--;)(s=ke(t[n]))[w]?a.push(s):i.push(s);(s=j(e,function(e,t){var n=t.length>0,a=e.length>0,i=function(i,o,s,c,l){var p,h,m,g=0,v="0",b=i&&[],w=[],T=u,x=i||a&&r.find.TAG("*",l),k=S+=null==T?1:Math.random()||.1,O=x.length;for(l&&(u=o==d||o||l);v!==O&&null!=(p=x[v]);v++){if(a&&p){for(h=0,o||p.ownerDocument==d||(f(p),s=!y);m=e[h++];)if(m(p,o||d,s)){c.push(p);break}l&&(S=k)}n&&((p=!m&&p)&&g--,i&&b.push(p))}if(g+=v,n&&v!==g){for(h=0;m=t[h++];)m(b,w,o,s);if(i){if(g>0)for(;v--;)b[v]||w[v]||(w[v]=N.call(c));w=Se(w)}I.apply(c,w),l&&!i&&w.length>0&&g+t.length>1&&se.uniqueSort(c)}return l&&(S=k,u=T),b};return n?ue(i):i}(i,a))).selector=e}return s},c=se.select=function(e,t,n,a){var i,c,u,l,p,f="function"==typeof e&&e,d=!a&&o(e=f.selector||e);if(n=n||[],1===d.length){if((c=d[0]=d[0].slice(0)).length>2&&"ID"===(u=c[0]).type&&9===t.nodeType&&y&&r.relative[c[1].type]){if(!(t=(r.find.ID(u.matches[0].replace(te,ne),t)||[])[0]))return n;f&&(t=t.parentNode),e=e.slice(c.shift().value.length)}for(i=X.needsContext.test(e)?0:c.length;i--&&(u=c[i],!r.relative[l=u.type]);)if((p=r.find[l])&&(a=p(u.matches[0].replace(te,ne),ee.test(c[0].type)&&ge(t.parentNode)||t))){if(c.splice(i,1),!(e=a.length&&be(c)))return I.apply(n,a),n;break}}return(f||s(e,d))(a,t,!y,n,!t||ee.test(e)&&ge(t.parentNode)||t),n},n.sortStable=w.split("").sort(C).join("")===w,n.detectDuplicates=!!p,f(),n.sortDetached=le(function(e){return 1&e.compareDocumentPosition(d.createElement("fieldset"))}),le(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||pe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),n.attributes&&le(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||pe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),le(function(e){return null==e.getAttribute("disabled")})||pe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(e);w.find=S,w.expr=S.selectors,w.expr[":"]=w.expr.pseudos,w.uniqueSort=w.unique=S.uniqueSort,w.text=S.getText,w.isXMLDoc=S.isXML,w.contains=S.contains,w.escapeSelector=S.escape;var x=function(e,t,n){for(var r=[],a=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(a&&w(e).is(n))break;r.push(e)}return r},k=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},O=w.expr.match.needsContext;function j(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var A=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function C(e,t,n){return h(t)?w.grep(e,function(e,r){return!!t.call(e,r,e)!==n}):t.nodeType?w.grep(e,function(e){return e===t!==n}):"string"!=typeof t?w.grep(e,function(e){return s.call(t,e)>-1!==n}):w.filter(t,e,n)}w.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?w.find.matchesSelector(r,e)?[r]:[]:w.find.matches(e,w.grep(t,function(e){return 1===e.nodeType}))},w.fn.extend({find:function(e){var t,n,r=this.length,a=this;if("string"!=typeof e)return this.pushStack(w(e).filter(function(){for(t=0;t<r;t++)if(w.contains(a[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)w.find(e,a[t],n);return r>1?w.uniqueSort(n):n},filter:function(e){return this.pushStack(C(this,e||[],!1))},not:function(e){return this.pushStack(C(this,e||[],!0))},is:function(e){return!!C(this,"string"==typeof e&&O.test(e)?w(e):e||[],!1).length}});var E,_=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(w.fn.init=function(e,t,n){var r,a;if(!e)return this;if(n=n||E,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:_.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof w?t[0]:t,w.merge(this,w.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:m,!0)),A.test(r[1])&&w.isPlainObject(t))for(r in t)h(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(a=m.getElementById(r[2]))&&(this[0]=a,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):h(e)?void 0!==n.ready?n.ready(e):e(w):w.makeArray(e,this)}).prototype=w.fn,E=w(m);var N=/^(?:parents|prev(?:Until|All))/,P={children:!0,contents:!0,next:!0,prev:!0};function I(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}w.fn.extend({has:function(e){var t=w(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(w.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,a=this.length,i=[],o="string"!=typeof e&&w(e);if(!O.test(e))for(;r<a;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(o?o.index(n)>-1:1===n.nodeType&&w.find.matchesSelector(n,e))){i.push(n);break}return this.pushStack(i.length>1?w.uniqueSort(i):i)},index:function(e){return e?"string"==typeof e?s.call(w(e),this[0]):s.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(w.uniqueSort(w.merge(this.get(),w(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),w.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return x(e,"parentNode")},parentsUntil:function(e,t,n){return x(e,"parentNode",n)},next:function(e){return I(e,"nextSibling")},prev:function(e){return I(e,"previousSibling")},nextAll:function(e){return x(e,"nextSibling")},prevAll:function(e){return x(e,"previousSibling")},nextUntil:function(e,t,n){return x(e,"nextSibling",n)},prevUntil:function(e,t,n){return x(e,"previousSibling",n)},siblings:function(e){return k((e.parentNode||{}).firstChild,e)},children:function(e){return k(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(j(e,"template")&&(e=e.content||e),w.merge([],e.childNodes))}},function(e,t){w.fn[e]=function(n,r){var a=w.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(a=w.filter(r,a)),this.length>1&&(P[e]||w.uniqueSort(a),N.test(e)&&a.reverse()),this.pushStack(a)}});var M=/[^\x20\t\r\n\f]+/g;function D(e){return e}function R(e){throw e}function L(e,t,n,r){var a;try{e&&h(a=e.promise)?a.call(e).done(t).fail(n):e&&h(a=e.then)?a.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}w.Callbacks=function(e){e="string"==typeof e?function(e){var t={};return w.each(e.match(M)||[],function(e,n){t[n]=!0}),t}(e):w.extend({},e);var t,n,r,a,i=[],o=[],s=-1,c=function(){for(a=a||e.once,r=t=!0;o.length;s=-1)for(n=o.shift();++s<i.length;)!1===i[s].apply(n[0],n[1])&&e.stopOnFalse&&(s=i.length,n=!1);e.memory||(n=!1),t=!1,a&&(i=n?[]:"")},u={add:function(){return i&&(n&&!t&&(s=i.length-1,o.push(n)),function t(n){w.each(n,function(n,r){h(r)?e.unique&&u.has(r)||i.push(r):r&&r.length&&"string"!==b(r)&&t(r)})}(arguments),n&&!t&&c()),this},remove:function(){return w.each(arguments,function(e,t){for(var n;(n=w.inArray(t,i,n))>-1;)i.splice(n,1),n<=s&&s--}),this},has:function(e){return e?w.inArray(e,i)>-1:i.length>0},empty:function(){return i&&(i=[]),this},disable:function(){return a=o=[],i=n="",this},disabled:function(){return!i},lock:function(){return a=o=[],n||t||(i=n=""),this},locked:function(){return!!a},fireWith:function(e,n){return a||(n=[e,(n=n||[]).slice?n.slice():n],o.push(n),t||c()),this},fire:function(){return u.fireWith(this,arguments),this},fired:function(){return!!r}};return u},w.extend({Deferred:function(t){var n=[["notify","progress",w.Callbacks("memory"),w.Callbacks("memory"),2],["resolve","done",w.Callbacks("once memory"),w.Callbacks("once memory"),0,"resolved"],["reject","fail",w.Callbacks("once memory"),w.Callbacks("once memory"),1,"rejected"]],r="pending",a={state:function(){return r},always:function(){return i.done(arguments).fail(arguments),this},catch:function(e){return a.then(null,e)},pipe:function(){var e=arguments;return w.Deferred(function(t){w.each(n,function(n,r){var a=h(e[r[4]])&&e[r[4]];i[r[1]](function(){var e=a&&a.apply(this,arguments);e&&h(e.promise)?e.promise().progress(t.notify).done(t.resolve).fail(t.reject):t[r[0]+"With"](this,a?[e]:arguments)})}),e=null}).promise()},then:function(t,r,a){var i=0;function o(t,n,r,a){return function(){var s=this,c=arguments,u=function(){var e,u;if(!(t<i)){if((e=r.apply(s,c))===n.promise())throw new TypeError("Thenable self-resolution");u=e&&("object"===(void 0===e?"undefined":_typeof(e))||"function"==typeof e)&&e.then,h(u)?a?u.call(e,o(i,n,D,a),o(i,n,R,a)):(i++,u.call(e,o(i,n,D,a),o(i,n,R,a),o(i,n,D,n.notifyWith))):(r!==D&&(s=void 0,c=[e]),(a||n.resolveWith)(s,c))}},l=a?u:function(){try{u()}catch(e){w.Deferred.exceptionHook&&w.Deferred.exceptionHook(e,l.stackTrace),t+1>=i&&(r!==R&&(s=void 0,c=[e]),n.rejectWith(s,c))}};t?l():(w.Deferred.getStackHook&&(l.stackTrace=w.Deferred.getStackHook()),e.setTimeout(l))}}return w.Deferred(function(e){n[0][3].add(o(0,e,h(a)?a:D,e.notifyWith)),n[1][3].add(o(0,e,h(t)?t:D)),n[2][3].add(o(0,e,h(r)?r:R))}).promise()},promise:function(e){return null!=e?w.extend(e,a):a}},i={};return w.each(n,function(e,t){var o=t[2],s=t[5];a[t[1]]=o.add,s&&o.add(function(){r=s},n[3-e][2].disable,n[3-e][3].disable,n[0][2].lock,n[0][3].lock),o.add(t[3].fire),i[t[0]]=function(){return i[t[0]+"With"](this===i?void 0:this,arguments),this},i[t[0]+"With"]=o.fireWith}),a.promise(i),t&&t.call(i,i),i},when:function(e){var t=arguments.length,n=t,r=Array(n),i=a.call(arguments),o=w.Deferred(),s=function(e){return function(n){r[e]=this,i[e]=arguments.length>1?a.call(arguments):n,--t||o.resolveWith(r,i)}};if(t<=1&&(L(e,o.done(s(n)).resolve,o.reject,!t),"pending"===o.state()||h(i[n]&&i[n].then)))return o.then();for(;n--;)L(i[n],s(n),o.reject);return o.promise()}});var q=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;w.Deferred.exceptionHook=function(t,n){e.console&&e.console.warn&&t&&q.test(t.name)&&e.console.warn("jQuery.Deferred exception: "+t.message,t.stack,n)},w.readyException=function(t){e.setTimeout(function(){throw t})};var F=w.Deferred();function V(){m.removeEventListener("DOMContentLoaded",V),e.removeEventListener("load",V),w.ready()}w.fn.ready=function(e){return F.then(e).catch(function(e){w.readyException(e)}),this},w.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--w.readyWait:w.isReady)||(w.isReady=!0,!0!==e&&--w.readyWait>0||F.resolveWith(m,[w]))}}),w.ready.then=F.then,"complete"===m.readyState||"loading"!==m.readyState&&!m.documentElement.doScroll?e.setTimeout(w.ready):(m.addEventListener("DOMContentLoaded",V),e.addEventListener("load",V));var H=function e(t,n,r,a,i,o,s){var c=0,u=t.length,l=null==r;if("object"===b(r))for(c in i=!0,r)e(t,n,c,r[c],!0,o,s);else if(void 0!==a&&(i=!0,h(a)||(s=!0),l&&(s?(n.call(t,a),n=null):(l=n,n=function(e,t,n){return l.call(w(e),n)})),n))for(;c<u;c++)n(t[c],r,s?a:a.call(t[c],c,n(t[c],r)));return i?t:l?n.call(t):u?n(t[0],r):o},z=/^-ms-/,$=/-([a-z])/g;function B(e,t){return t.toUpperCase()}function W(e){return e.replace(z,"ms-").replace($,B)}var U=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function G(){this.expando=w.expando+G.uid++}G.uid=1,G.prototype={cache:function(e){var t=e[this.expando];return t||(t={},U(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,a=this.cache(e);if("string"==typeof t)a[W(t)]=n;else for(r in t)a[W(r)]=t[r];return a},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][W(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(W):(t=W(t))in r?[t]:t.match(M)||[]).length;for(;n--;)delete r[t[n]]}(void 0===t||w.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!w.isEmptyObject(t)}};var X=new G,Y=new G,J=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,K=/[A-Z]/g;function Z(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(K,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n=function(e){return"true"===e||"false"!==e&&("null"===e?null:e===+e+""?+e:J.test(e)?JSON.parse(e):e)}(n)}catch(e){}Y.set(e,t,n)}else n=void 0;return n}w.extend({hasData:function(e){return Y.hasData(e)||X.hasData(e)},data:function(e,t,n){return Y.access(e,t,n)},removeData:function(e,t){Y.remove(e,t)},_data:function(e,t,n){return X.access(e,t,n)},_removeData:function(e,t){X.remove(e,t)}}),w.fn.extend({data:function(e,t){var n,r,a,i=this[0],o=i&&i.attributes;if(void 0===e){if(this.length&&(a=Y.get(i),1===i.nodeType&&!X.get(i,"hasDataAttrs"))){for(n=o.length;n--;)o[n]&&0===(r=o[n].name).indexOf("data-")&&(r=W(r.slice(5)),Z(i,r,a[r]));X.set(i,"hasDataAttrs",!0)}return a}return"object"===(void 0===e?"undefined":_typeof(e))?this.each(function(){Y.set(this,e)}):H(this,function(t){var n;if(i&&void 0===t)return void 0!==(n=Y.get(i,e))?n:void 0!==(n=Z(i,e))?n:void 0;this.each(function(){Y.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){Y.remove(this,e)})}}),w.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=X.get(e,t),n&&(!r||Array.isArray(n)?r=X.access(e,t,w.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=w.queue(e,t),r=n.length,a=n.shift(),i=w._queueHooks(e,t);"inprogress"===a&&(a=n.shift(),r--),a&&("fx"===t&&n.unshift("inprogress"),delete i.stop,a.call(e,function(){w.dequeue(e,t)},i)),!r&&i&&i.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return X.get(e,n)||X.access(e,n,{empty:w.Callbacks("once memory").add(function(){X.remove(e,[t+"queue",n])})})}}),w.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?w.queue(this[0],e):void 0===t?this:this.each(function(){var n=w.queue(this,e,t);w._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&w.dequeue(this,e)})},dequeue:function(e){return this.each(function(){w.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,a=w.Deferred(),i=this,o=this.length,s=function(){--r||a.resolveWith(i,[i])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";o--;)(n=X.get(i[o],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),a.promise(t)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ee=new RegExp("^(?:([+-])=|)("+Q+")([a-z%]*)$","i"),te=["Top","Right","Bottom","Left"],ne=m.documentElement,re=function(e){return w.contains(e.ownerDocument,e)},ae={composed:!0};ne.getRootNode&&(re=function(e){return w.contains(e.ownerDocument,e)||e.getRootNode(ae)===e.ownerDocument});var ie=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&re(e)&&"none"===w.css(e,"display")};function oe(e,t,n,r){var a,i,o=20,s=r?function(){return r.cur()}:function(){return w.css(e,t,"")},c=s(),u=n&&n[3]||(w.cssNumber[t]?"":"px"),l=e.nodeType&&(w.cssNumber[t]||"px"!==u&&+c)&&ee.exec(w.css(e,t));if(l&&l[3]!==u){for(c/=2,u=u||l[3],l=+c||1;o--;)w.style(e,t,l+u),(1-i)*(1-(i=s()/c||.5))<=0&&(o=0),l/=i;l*=2,w.style(e,t,l+u),n=n||[]}return n&&(l=+l||+c||0,a=n[1]?l+(n[1]+1)*n[2]:+n[2],r&&(r.unit=u,r.start=l,r.end=a)),a}var se={};function ce(e){var t,n=e.ownerDocument,r=e.nodeName,a=se[r];return a||(t=n.body.appendChild(n.createElement(r)),a=w.css(t,"display"),t.parentNode.removeChild(t),"none"===a&&(a="block"),se[r]=a,a)}function ue(e,t){for(var n,r,a=[],i=0,o=e.length;i<o;i++)(r=e[i]).style&&(n=r.style.display,t?("none"===n&&(a[i]=X.get(r,"display")||null,a[i]||(r.style.display="")),""===r.style.display&&ie(r)&&(a[i]=ce(r))):"none"!==n&&(a[i]="none",X.set(r,"display",n)));for(i=0;i<o;i++)null!=a[i]&&(e[i].style.display=a[i]);return e}w.fn.extend({show:function(){return ue(this,!0)},hide:function(){return ue(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ie(this)?w(this).show():w(this).hide()})}});var le,pe,fe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i;le=m.createDocumentFragment().appendChild(m.createElement("div")),(pe=m.createElement("input")).setAttribute("type","radio"),pe.setAttribute("checked","checked"),pe.setAttribute("name","t"),le.appendChild(pe),d.checkClone=le.cloneNode(!0).cloneNode(!0).lastChild.checked,le.innerHTML="<textarea>x</textarea>",d.noCloneChecked=!!le.cloneNode(!0).lastChild.defaultValue,le.innerHTML="<option></option>",d.option=!!le.lastChild;var ye={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function me(e,t){var n;return n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&j(e,t)?w.merge([e],n):n}function ge(e,t){for(var n=0,r=e.length;n<r;n++)X.set(e[n],"globalEval",!t||X.get(t[n],"globalEval"))}ye.tbody=ye.tfoot=ye.colgroup=ye.caption=ye.thead,ye.th=ye.td,d.option||(ye.optgroup=ye.option=[1,"<select multiple='multiple'>","</select>"]);var ve=/<|&#?\w+;/;function be(e,t,n,r,a){for(var i,o,s,c,u,l,p=t.createDocumentFragment(),f=[],d=0,h=e.length;d<h;d++)if((i=e[d])||0===i)if("object"===b(i))w.merge(f,i.nodeType?[i]:i);else if(ve.test(i)){for(o=o||p.appendChild(t.createElement("div")),s=(de.exec(i)||["",""])[1].toLowerCase(),c=ye[s]||ye._default,o.innerHTML=c[1]+w.htmlPrefilter(i)+c[2],l=c[0];l--;)o=o.lastChild;w.merge(f,o.childNodes),(o=p.firstChild).textContent=""}else f.push(t.createTextNode(i));for(p.textContent="",d=0;i=f[d++];)if(r&&w.inArray(i,r)>-1)a&&a.push(i);else if(u=re(i),o=me(p.appendChild(i),"script"),u&&ge(o),n)for(l=0;i=o[l++];)he.test(i.type||"")&&n.push(i);return p}var we=/^key/,Te=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Se=/^([^.]*)(?:\.(.+)|)/;function xe(){return!0}function ke(){return!1}function Oe(e,t){return e===function(){try{return m.activeElement}catch(e){}}()==("focus"===t)}function je(e,t,n,r,a,i){var o,s;if("object"===(void 0===t?"undefined":_typeof(t))){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)je(e,s,n,r,t[s],i);return e}if(null==r&&null==a?(a=n,r=n=void 0):null==a&&("string"==typeof n?(a=r,r=void 0):(a=r,r=n,n=void 0)),!1===a)a=ke;else if(!a)return e;return 1===i&&(o=a,(a=function(e){return w().off(e),o.apply(this,arguments)}).guid=o.guid||(o.guid=w.guid++)),e.each(function(){w.event.add(this,t,a,r,n)})}function Ae(e,t,n){n?(X.set(e,t,!1),w.event.add(e,t,{namespace:!1,handler:function(e){var r,i,o=X.get(this,t);if(1&e.isTrigger&&this[t]){if(o.length)(w.event.special[t]||{}).delegateType&&e.stopPropagation();else if(o=a.call(arguments),X.set(this,t,o),r=n(this,t),this[t](),o!==(i=X.get(this,t))||r?X.set(this,t,!1):i={},o!==i)return e.stopImmediatePropagation(),e.preventDefault(),i.value}else o.length&&(X.set(this,t,{value:w.event.trigger(w.extend(o[0],w.Event.prototype),o.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===X.get(e,t)&&w.event.add(e,t,xe)}w.event={global:{},add:function(e,t,n,r,a){var i,o,s,c,u,l,p,f,d,h,y,m=X.get(e);if(U(e))for(n.handler&&(n=(i=n).handler,a=i.selector),a&&w.find.matchesSelector(ne,a),n.guid||(n.guid=w.guid++),(c=m.events)||(c=m.events=Object.create(null)),(o=m.handle)||(o=m.handle=function(t){return void 0!==w&&w.event.triggered!==t.type?w.event.dispatch.apply(e,arguments):void 0}),u=(t=(t||"").match(M)||[""]).length;u--;)d=y=(s=Se.exec(t[u])||[])[1],h=(s[2]||"").split(".").sort(),d&&(p=w.event.special[d]||{},d=(a?p.delegateType:p.bindType)||d,p=w.event.special[d]||{},l=w.extend({type:d,origType:y,data:r,handler:n,guid:n.guid,selector:a,needsContext:a&&w.expr.match.needsContext.test(a),namespace:h.join(".")},i),(f=c[d])||((f=c[d]=[]).delegateCount=0,p.setup&&!1!==p.setup.call(e,r,h,o)||e.addEventListener&&e.addEventListener(d,o)),p.add&&(p.add.call(e,l),l.handler.guid||(l.handler.guid=n.guid)),a?f.splice(f.delegateCount++,0,l):f.push(l),w.event.global[d]=!0)},remove:function(e,t,n,r,a){var i,o,s,c,u,l,p,f,d,h,y,m=X.hasData(e)&&X.get(e);if(m&&(c=m.events)){for(u=(t=(t||"").match(M)||[""]).length;u--;)if(d=y=(s=Se.exec(t[u])||[])[1],h=(s[2]||"").split(".").sort(),d){for(p=w.event.special[d]||{},f=c[d=(r?p.delegateType:p.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),o=i=f.length;i--;)l=f[i],!a&&y!==l.origType||n&&n.guid!==l.guid||s&&!s.test(l.namespace)||r&&r!==l.selector&&("**"!==r||!l.selector)||(f.splice(i,1),l.selector&&f.delegateCount--,p.remove&&p.remove.call(e,l));o&&!f.length&&(p.teardown&&!1!==p.teardown.call(e,h,m.handle)||w.removeEvent(e,d,m.handle),delete c[d])}else for(d in c)w.event.remove(e,d+t[u],n,r,!0);w.isEmptyObject(c)&&X.remove(e,"handle events")}},dispatch:function(e){var t,n,r,a,i,o,s=new Array(arguments.length),c=w.event.fix(e),u=(X.get(this,"events")||Object.create(null))[c.type]||[],l=w.event.special[c.type]||{};for(s[0]=c,t=1;t<arguments.length;t++)s[t]=arguments[t];if(c.delegateTarget=this,!l.preDispatch||!1!==l.preDispatch.call(this,c)){for(o=w.event.handlers.call(this,c,u),t=0;(a=o[t++])&&!c.isPropagationStopped();)for(c.currentTarget=a.elem,n=0;(i=a.handlers[n++])&&!c.isImmediatePropagationStopped();)c.rnamespace&&!1!==i.namespace&&!c.rnamespace.test(i.namespace)||(c.handleObj=i,c.data=i.data,void 0!==(r=((w.event.special[i.origType]||{}).handle||i.handler).apply(a.elem,s))&&!1===(c.result=r)&&(c.preventDefault(),c.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,c),c.result}},handlers:function(e,t){var n,r,a,i,o,s=[],c=t.delegateCount,u=e.target;if(c&&u.nodeType&&!("click"===e.type&&e.button>=1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&("click"!==e.type||!0!==u.disabled)){for(i=[],o={},n=0;n<c;n++)void 0===o[a=(r=t[n]).selector+" "]&&(o[a]=r.needsContext?w(a,this).index(u)>-1:w.find(a,this,null,[u]).length),o[a]&&i.push(r);i.length&&s.push({elem:u,handlers:i})}return u=this,c<t.length&&s.push({elem:u,handlers:t.slice(c)}),s},addProp:function(e,t){Object.defineProperty(w.Event.prototype,e,{enumerable:!0,configurable:!0,get:h(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[w.expando]?e:new w.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return fe.test(t.type)&&t.click&&j(t,"input")&&Ae(t,"click",xe),!1},trigger:function(e){var t=this||e;return fe.test(t.type)&&t.click&&j(t,"input")&&Ae(t,"click"),!0},_default:function(e){var t=e.target;return fe.test(t.type)&&t.click&&j(t,"input")&&X.get(t,"click")||j(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},w.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},w.Event=function(e,t){if(!(this instanceof w.Event))return new w.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?xe:ke,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&w.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[w.expando]=!0},w.Event.prototype={constructor:w.Event,isDefaultPrevented:ke,isPropagationStopped:ke,isImmediatePropagationStopped:ke,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=xe,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=xe,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=xe,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},w.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&we.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&Te.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},w.event.addProp),w.each({focus:"focusin",blur:"focusout"},function(e,t){w.event.special[e]={setup:function(){return Ae(this,e,Oe),!1},trigger:function(){return Ae(this,e),!0},delegateType:t}}),w.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){w.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=e.relatedTarget,a=e.handleObj;return r&&(r===this||w.contains(this,r))||(e.type=a.origType,n=a.handler.apply(this,arguments),e.type=t),n}}}),w.fn.extend({on:function(e,t,n,r){return je(this,e,t,n,r)},one:function(e,t,n,r){return je(this,e,t,n,r,1)},off:function(e,t,n){var r,a;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,w(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"===(void 0===e?"undefined":_typeof(e))){for(a in e)this.off(a,t,e[a]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=ke),this.each(function(){w.event.remove(this,e,n,t)})}});var Ce=/<script|<style|<link/i,Ee=/checked\s*(?:[^=]|=\s*.checked.)/i,_e=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Ne(e,t){return j(e,"table")&&j(11!==t.nodeType?t:t.firstChild,"tr")&&w(e).children("tbody")[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Ie(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Me(e,t){var n,r,a,i,o,s;if(1===t.nodeType){if(X.hasData(e)&&(s=X.get(e).events))for(a in X.remove(t,"handle events"),s)for(n=0,r=s[a].length;n<r;n++)w.event.add(t,a,s[a][n]);Y.hasData(e)&&(i=Y.access(e),o=w.extend({},i),Y.set(t,o))}}function De(e,t,n,r){t=i(t);var a,o,s,c,u,l,p=0,f=e.length,y=f-1,m=t[0],g=h(m);if(g||f>1&&"string"==typeof m&&!d.checkClone&&Ee.test(m))return e.each(function(a){var i=e.eq(a);g&&(t[0]=m.call(this,a,i.html())),De(i,t,n,r)});if(f&&(o=(a=be(t,e[0].ownerDocument,!1,e,r)).firstChild,1===a.childNodes.length&&(a=o),o||r)){for(c=(s=w.map(me(a,"script"),Pe)).length;p<f;p++)u=a,p!==y&&(u=w.clone(u,!0,!0),c&&w.merge(s,me(u,"script"))),n.call(e[p],u,p);if(c)for(l=s[s.length-1].ownerDocument,w.map(s,Ie),p=0;p<c;p++)u=s[p],he.test(u.type||"")&&!X.access(u,"globalEval")&&w.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?w._evalUrl&&!u.noModule&&w._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):v(u.textContent.replace(_e,""),u,l))}return e}function Re(e,t,n){for(var r,a=t?w.filter(t,e):e,i=0;null!=(r=a[i]);i++)n||1!==r.nodeType||w.cleanData(me(r)),r.parentNode&&(n&&re(r)&&ge(me(r,"script")),r.parentNode.removeChild(r));return e}w.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,a,i,o,s,c,u,l=e.cloneNode(!0),p=re(e);if(!(d.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||w.isXMLDoc(e)))for(o=me(l),r=0,a=(i=me(e)).length;r<a;r++)s=i[r],c=o[r],void 0,"input"===(u=c.nodeName.toLowerCase())&&fe.test(s.type)?c.checked=s.checked:"input"!==u&&"textarea"!==u||(c.defaultValue=s.defaultValue);if(t)if(n)for(i=i||me(e),o=o||me(l),r=0,a=i.length;r<a;r++)Me(i[r],o[r]);else Me(e,l);return(o=me(l,"script")).length>0&&ge(o,!p&&me(e,"script")),l},cleanData:function(e){for(var t,n,r,a=w.event.special,i=0;void 0!==(n=e[i]);i++)if(U(n)){if(t=n[X.expando]){if(t.events)for(r in t.events)a[r]?w.event.remove(n,r):w.removeEvent(n,r,t.handle);n[X.expando]=void 0}n[Y.expando]&&(n[Y.expando]=void 0)}}}),w.fn.extend({detach:function(e){return Re(this,e,!0)},remove:function(e){return Re(this,e)},text:function(e){return H(this,function(e){return void 0===e?w.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return De(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Ne(this,e).appendChild(e)})},prepend:function(){return De(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Ne(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return De(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return De(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(w.cleanData(me(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return w.clone(this,e,t)})},html:function(e){return H(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Ce.test(e)&&!ye[(de.exec(e)||["",""])[1].toLowerCase()]){e=w.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(w.cleanData(me(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return De(this,arguments,function(t){var n=this.parentNode;w.inArray(this,e)<0&&(w.cleanData(me(this)),n&&n.replaceChild(t,this))},e)}}),w.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){w.fn[e]=function(e){for(var n,r=[],a=w(e),i=a.length-1,s=0;s<=i;s++)n=s===i?this:this.clone(!0),w(a[s])[t](n),o.apply(r,n.get());return this.pushStack(r)}});var Le=new RegExp("^("+Q+")(?!px)[a-z%]+$","i"),qe=function(t){var n=t.ownerDocument.defaultView;return n&&n.opener||(n=e),n.getComputedStyle(t)},Fe=function(e,t,n){var r,a,i={};for(a in t)i[a]=e.style[a],e.style[a]=t[a];for(a in r=n.call(e),t)e.style[a]=i[a];return r},Ve=new RegExp(te.join("|"),"i");function He(e,t,n){var r,a,i,o,s=e.style;return(n=n||qe(e))&&(""!==(o=n.getPropertyValue(t)||n[t])||re(e)||(o=w.style(e,t)),!d.pixelBoxStyles()&&Le.test(o)&&Ve.test(t)&&(r=s.width,a=s.minWidth,i=s.maxWidth,s.minWidth=s.maxWidth=s.width=o,o=n.width,s.width=r,s.minWidth=a,s.maxWidth=i)),void 0!==o?o+"":o}function ze(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function t(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ne.appendChild(u).appendChild(l);var t=e.getComputedStyle(l);r="1%"!==t.top,c=12===n(t.marginLeft),l.style.right="60%",o=36===n(t.right),a=36===n(t.width),l.style.position="absolute",i=12===n(l.offsetWidth/3),ne.removeChild(u),l=null}}function n(e){return Math.round(parseFloat(e))}var r,a,i,o,s,c,u=m.createElement("div"),l=m.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",d.clearCloneStyle="content-box"===l.style.backgroundClip,w.extend(d,{boxSizingReliable:function(){return t(),a},pixelBoxStyles:function(){return t(),o},pixelPosition:function(){return t(),r},reliableMarginLeft:function(){return t(),c},scrollboxSize:function(){return t(),i},reliableTrDimensions:function(){var t,n,r,a;return null==s&&(t=m.createElement("table"),n=m.createElement("tr"),r=m.createElement("div"),t.style.cssText="position:absolute;left:-11111px",n.style.height="1px",r.style.height="9px",ne.appendChild(t).appendChild(n).appendChild(r),a=e.getComputedStyle(n),s=parseInt(a.height)>3,ne.removeChild(t)),s}}))}();var $e=["Webkit","Moz","ms"],Be=m.createElement("div").style,We={};function Ue(e){var t=w.cssProps[e]||We[e];return t||(e in Be?e:We[e]=function(e){for(var t=e[0].toUpperCase()+e.slice(1),n=$e.length;n--;)if((e=$e[n]+t)in Be)return e}(e)||e)}var Ge=/^(none|table(?!-c[ea]).+)/,Xe=/^--/,Ye={position:"absolute",visibility:"hidden",display:"block"},Je={letterSpacing:"0",fontWeight:"400"};function Ke(e,t,n){var r=ee.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function Ze(e,t,n,r,a,i){var o="width"===t?1:0,s=0,c=0;if(n===(r?"border":"content"))return 0;for(;o<4;o+=2)"margin"===n&&(c+=w.css(e,n+te[o],!0,a)),r?("content"===n&&(c-=w.css(e,"padding"+te[o],!0,a)),"margin"!==n&&(c-=w.css(e,"border"+te[o]+"Width",!0,a))):(c+=w.css(e,"padding"+te[o],!0,a),"padding"!==n?c+=w.css(e,"border"+te[o]+"Width",!0,a):s+=w.css(e,"border"+te[o]+"Width",!0,a));return!r&&i>=0&&(c+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-i-c-s-.5))||0),c}function Qe(e,t,n){var r=qe(e),a=(!d.boxSizingReliable()||n)&&"border-box"===w.css(e,"boxSizing",!1,r),i=a,o=He(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(Le.test(o)){if(!n)return o;o="auto"}return(!d.boxSizingReliable()&&a||!d.reliableTrDimensions()&&j(e,"tr")||"auto"===o||!parseFloat(o)&&"inline"===w.css(e,"display",!1,r))&&e.getClientRects().length&&(a="border-box"===w.css(e,"boxSizing",!1,r),(i=s in e)&&(o=e[s])),(o=parseFloat(o)||0)+Ze(e,t,n||(a?"border":"content"),i,r,o)+"px"}function et(e,t,n,r,a){return new et.prototype.init(e,t,n,r,a)}w.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=He(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var a,i,o,s=W(t),c=Xe.test(t),u=e.style;if(c||(t=Ue(s)),o=w.cssHooks[t]||w.cssHooks[s],void 0===n)return o&&"get"in o&&void 0!==(a=o.get(e,!1,r))?a:u[t];"string"===(i=void 0===n?"undefined":_typeof(n))&&(a=ee.exec(n))&&a[1]&&(n=oe(e,t,a),i="number"),null!=n&&n==n&&("number"!==i||c||(n+=a&&a[3]||(w.cssNumber[s]?"":"px")),d.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),o&&"set"in o&&void 0===(n=o.set(e,n,r))||(c?u.setProperty(t,n):u[t]=n))}},css:function(e,t,n,r){var a,i,o,s=W(t);return Xe.test(t)||(t=Ue(s)),(o=w.cssHooks[t]||w.cssHooks[s])&&"get"in o&&(a=o.get(e,!0,n)),void 0===a&&(a=He(e,t,r)),"normal"===a&&t in Je&&(a=Je[t]),""===n||n?(i=parseFloat(a),!0===n||isFinite(i)?i||0:a):a}}),w.each(["height","width"],function(e,t){w.cssHooks[t]={get:function(e,n,r){if(n)return!Ge.test(w.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?Qe(e,t,r):Fe(e,Ye,function(){return Qe(e,t,r)})},set:function(e,n,r){var a,i=qe(e),o=!d.scrollboxSize()&&"absolute"===i.position,s=(o||r)&&"border-box"===w.css(e,"boxSizing",!1,i),c=r?Ze(e,t,r,s,i):0;return s&&o&&(c-=Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-parseFloat(i[t])-Ze(e,t,"border",!1,i)-.5)),c&&(a=ee.exec(n))&&"px"!==(a[3]||"px")&&(e.style[t]=n,n=w.css(e,t)),Ke(0,n,c)}}}),w.cssHooks.marginLeft=ze(d.reliableMarginLeft,function(e,t){if(t)return(parseFloat(He(e,"marginLeft"))||e.getBoundingClientRect().left-Fe(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),w.each({margin:"",padding:"",border:"Width"},function(e,t){w.cssHooks[e+t]={expand:function(n){for(var r=0,a={},i="string"==typeof n?n.split(" "):[n];r<4;r++)a[e+te[r]+t]=i[r]||i[r-2]||i[0];return a}},"margin"!==e&&(w.cssHooks[e+t].set=Ke)}),w.fn.extend({css:function(e,t){return H(this,function(e,t,n){var r,a,i={},o=0;if(Array.isArray(t)){for(r=qe(e),a=t.length;o<a;o++)i[t[o]]=w.css(e,t[o],!1,r);return i}return void 0!==n?w.style(e,t,n):w.css(e,t)},e,t,arguments.length>1)}}),w.Tween=et,et.prototype={constructor:et,init:function(e,t,n,r,a,i){this.elem=e,this.prop=n,this.easing=a||w.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=i||(w.cssNumber[n]?"":"px")},cur:function(){var e=et.propHooks[this.prop];return e&&e.get?e.get(this):et.propHooks._default.get(this)},run:function(e){var t,n=et.propHooks[this.prop];return this.options.duration?this.pos=t=w.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):et.propHooks._default.set(this),this}},et.prototype.init.prototype=et.prototype,et.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=w.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){w.fx.step[e.prop]?w.fx.step[e.prop](e):1!==e.elem.nodeType||!w.cssHooks[e.prop]&&null==e.elem.style[Ue(e.prop)]?e.elem[e.prop]=e.now:w.style(e.elem,e.prop,e.now+e.unit)}}},et.propHooks.scrollTop=et.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},w.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},w.fx=et.prototype.init,w.fx.step={};var tt,nt,rt=/^(?:toggle|show|hide)$/,at=/queueHooks$/;function it(){nt&&(!1===m.hidden&&e.requestAnimationFrame?e.requestAnimationFrame(it):e.setTimeout(it,w.fx.interval),w.fx.tick())}function ot(){return e.setTimeout(function(){tt=void 0}),tt=Date.now()}function st(e,t){var n,r=0,a={height:e};for(t=t?1:0;r<4;r+=2-t)a["margin"+(n=te[r])]=a["padding"+n]=e;return t&&(a.opacity=a.width=e),a}function ct(e,t,n){for(var r,a=(ut.tweeners[t]||[]).concat(ut.tweeners["*"]),i=0,o=a.length;i<o;i++)if(r=a[i].call(n,t,e))return r}function ut(e,t,n){var r,a,i=0,o=ut.prefilters.length,s=w.Deferred().always(function(){delete c.elem}),c=function(){if(a)return!1;for(var t=tt||ot(),n=Math.max(0,u.startTime+u.duration-t),r=1-(n/u.duration||0),i=0,o=u.tweens.length;i<o;i++)u.tweens[i].run(r);return s.notifyWith(e,[u,r,n]),r<1&&o?n:(o||s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u]),!1)},u=s.promise({elem:e,props:w.extend({},t),opts:w.extend(!0,{specialEasing:{},easing:w.easing._default},n),originalProperties:t,originalOptions:n,startTime:tt||ot(),duration:n.duration,tweens:[],createTween:function(t,n){var r=w.Tween(e,u.opts,t,n,u.opts.specialEasing[t]||u.opts.easing);return u.tweens.push(r),r},stop:function(t){var n=0,r=t?u.tweens.length:0;if(a)return this;for(a=!0;n<r;n++)u.tweens[n].run(1);return t?(s.notifyWith(e,[u,1,0]),s.resolveWith(e,[u,t])):s.rejectWith(e,[u,t]),this}}),l=u.props;for(!function(e,t){var n,r,a,i,o;for(n in e)if(a=t[r=W(n)],i=e[n],Array.isArray(i)&&(a=i[1],i=e[n]=i[0]),n!==r&&(e[r]=i,delete e[n]),(o=w.cssHooks[r])&&"expand"in o)for(n in i=o.expand(i),delete e[r],i)n in e||(e[n]=i[n],t[n]=a);else t[r]=a}(l,u.opts.specialEasing);i<o;i++)if(r=ut.prefilters[i].call(u,e,l,u.opts))return h(r.stop)&&(w._queueHooks(u.elem,u.opts.queue).stop=r.stop.bind(r)),r;return w.map(l,ct,u),h(u.opts.start)&&u.opts.start.call(e,u),u.progress(u.opts.progress).done(u.opts.done,u.opts.complete).fail(u.opts.fail).always(u.opts.always),w.fx.timer(w.extend(c,{elem:e,anim:u,queue:u.opts.queue})),u}w.Animation=w.extend(ut,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return oe(n.elem,e,ee.exec(t),n),n}]},tweener:function(e,t){h(e)?(t=e,e=["*"]):e=e.match(M);for(var n,r=0,a=e.length;r<a;r++)n=e[r],ut.tweeners[n]=ut.tweeners[n]||[],ut.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,a,i,o,s,c,u,l,p="width"in t||"height"in t,f=this,d={},h=e.style,y=e.nodeType&&ie(e),m=X.get(e,"fxshow");for(r in n.queue||(null==(o=w._queueHooks(e,"fx")).unqueued&&(o.unqueued=0,s=o.empty.fire,o.empty.fire=function(){o.unqueued||s()}),o.unqueued++,f.always(function(){f.always(function(){o.unqueued--,w.queue(e,"fx").length||o.empty.fire()})})),t)if(a=t[r],rt.test(a)){if(delete t[r],i=i||"toggle"===a,a===(y?"hide":"show")){if("show"!==a||!m||void 0===m[r])continue;y=!0}d[r]=m&&m[r]||w.style(e,r)}if((c=!w.isEmptyObject(t))||!w.isEmptyObject(d))for(r in p&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(u=m&&m.display)&&(u=X.get(e,"display")),"none"===(l=w.css(e,"display"))&&(u?l=u:(ue([e],!0),u=e.style.display||u,l=w.css(e,"display"),ue([e]))),("inline"===l||"inline-block"===l&&null!=u)&&"none"===w.css(e,"float")&&(c||(f.done(function(){h.display=u}),null==u&&(l=h.display,u="none"===l?"":l)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",f.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),c=!1,d)c||(m?"hidden"in m&&(y=m.hidden):m=X.access(e,"fxshow",{display:u}),i&&(m.hidden=!y),y&&ue([e],!0),f.done(function(){for(r in y||ue([e]),X.remove(e,"fxshow"),d)w.style(e,r,d[r])})),c=ct(y?m[r]:0,r,f),r in m||(m[r]=c.start,y&&(c.end=c.start,c.start=0))}],prefilter:function(e,t){t?ut.prefilters.unshift(e):ut.prefilters.push(e)}}),w.speed=function(e,t,n){var r=e&&"object"===(void 0===e?"undefined":_typeof(e))?w.extend({},e):{complete:n||!n&&t||h(e)&&e,duration:e,easing:n&&t||t&&!h(t)&&t};return w.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in w.fx.speeds?r.duration=w.fx.speeds[r.duration]:r.duration=w.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){h(r.old)&&r.old.call(this),r.queue&&w.dequeue(this,r.queue)},r},w.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ie).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var a=w.isEmptyObject(e),i=w.speed(t,n,r),o=function(){var t=ut(this,w.extend({},e),i);(a||X.get(this,"finish"))&&t.stop(!0)};return o.finish=o,a||!1===i.queue?this.each(o):this.queue(i.queue,o)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&this.queue(e||"fx",[]),this.each(function(){var t=!0,a=null!=e&&e+"queueHooks",i=w.timers,o=X.get(this);if(a)o[a]&&o[a].stop&&r(o[a]);else for(a in o)o[a]&&o[a].stop&&at.test(a)&&r(o[a]);for(a=i.length;a--;)i[a].elem!==this||null!=e&&i[a].queue!==e||(i[a].anim.stop(n),t=!1,i.splice(a,1));!t&&n||w.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,n=X.get(this),r=n[e+"queue"],a=n[e+"queueHooks"],i=w.timers,o=r?r.length:0;for(n.finish=!0,w.queue(this,e,[]),a&&a.stop&&a.stop.call(this,!0),t=i.length;t--;)i[t].elem===this&&i[t].queue===e&&(i[t].anim.stop(!0),i.splice(t,1));for(t=0;t<o;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),w.each(["toggle","show","hide"],function(e,t){var n=w.fn[t];w.fn[t]=function(e,r,a){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(st(t,!0),e,r,a)}}),w.each({slideDown:st("show"),slideUp:st("hide"),slideToggle:st("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){w.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),w.timers=[],w.fx.tick=function(){var e,t=0,n=w.timers;for(tt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||w.fx.stop(),tt=void 0},w.fx.timer=function(e){w.timers.push(e),w.fx.start()},w.fx.interval=13,w.fx.start=function(){nt||(nt=!0,it())},w.fx.stop=function(){nt=null},w.fx.speeds={slow:600,fast:200,_default:400},w.fn.delay=function(t,n){return t=w.fx&&w.fx.speeds[t]||t,n=n||"fx",this.queue(n,function(n,r){var a=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(a)}})},function(){var e=m.createElement("input"),t=m.createElement("select").appendChild(m.createElement("option"));e.type="checkbox",d.checkOn=""!==e.value,d.optSelected=t.selected,(e=m.createElement("input")).value="t",e.type="radio",d.radioValue="t"===e.value}();var lt,pt=w.expr.attrHandle;w.fn.extend({attr:function(e,t){return H(this,w.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){w.removeAttr(this,e)})}}),w.extend({attr:function(e,t,n){var r,a,i=e.nodeType;if(3!==i&&8!==i&&2!==i)return void 0===e.getAttribute?w.prop(e,t,n):(1===i&&w.isXMLDoc(e)||(a=w.attrHooks[t.toLowerCase()]||(w.expr.match.bool.test(t)?lt:void 0)),void 0!==n?null===n?void w.removeAttr(e,t):a&&"set"in a&&void 0!==(r=a.set(e,n,t))?r:(e.setAttribute(t,n+""),n):a&&"get"in a&&null!==(r=a.get(e,t))?r:null==(r=w.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!d.radioValue&&"radio"===t&&j(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,a=t&&t.match(M);if(a&&1===e.nodeType)for(;n=a[r++];)e.removeAttribute(n)}}),lt={set:function(e,t,n){return!1===t?w.removeAttr(e,n):e.setAttribute(n,n),n}},w.each(w.expr.match.bool.source.match(/\w+/g),function(e,t){var n=pt[t]||w.find.attr;pt[t]=function(e,t,r){var a,i,o=t.toLowerCase();return r||(i=pt[o],pt[o]=a,a=null!=n(e,t,r)?o:null,pt[o]=i),a}});var ft=/^(?:input|select|textarea|button)$/i,dt=/^(?:a|area)$/i;function ht(e){return(e.match(M)||[]).join(" ")}function yt(e){return e.getAttribute&&e.getAttribute("class")||""}function mt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(M)||[]}w.fn.extend({prop:function(e,t){return H(this,w.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[w.propFix[e]||e]})}}),w.extend({prop:function(e,t,n){var r,a,i=e.nodeType;if(3!==i&&8!==i&&2!==i)return 1===i&&w.isXMLDoc(e)||(t=w.propFix[t]||t,a=w.propHooks[t]),void 0!==n?a&&"set"in a&&void 0!==(r=a.set(e,n,t))?r:e[t]=n:a&&"get"in a&&null!==(r=a.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=w.find.attr(e,"tabindex");return t?parseInt(t,10):ft.test(e.nodeName)||dt.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),d.optSelected||(w.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),w.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){w.propFix[this.toLowerCase()]=this}),w.fn.extend({addClass:function(e){var t,n,r,a,i,o,s,c=0;if(h(e))return this.each(function(t){w(this).addClass(e.call(this,t,yt(this)))});if((t=mt(e)).length)for(;n=this[c++];)if(a=yt(n),r=1===n.nodeType&&" "+ht(a)+" "){for(o=0;i=t[o++];)r.indexOf(" "+i+" ")<0&&(r+=i+" ");a!==(s=ht(r))&&n.setAttribute("class",s)}return this},removeClass:function(e){var t,n,r,a,i,o,s,c=0;if(h(e))return this.each(function(t){w(this).removeClass(e.call(this,t,yt(this)))});if(!arguments.length)return this.attr("class","");if((t=mt(e)).length)for(;n=this[c++];)if(a=yt(n),r=1===n.nodeType&&" "+ht(a)+" "){for(o=0;i=t[o++];)for(;r.indexOf(" "+i+" ")>-1;)r=r.replace(" "+i+" "," ");a!==(s=ht(r))&&n.setAttribute("class",s)}return this},toggleClass:function(e,t){var n=void 0===e?"undefined":_typeof(e),r="string"===n||Array.isArray(e);return"boolean"==typeof t&&r?t?this.addClass(e):this.removeClass(e):h(e)?this.each(function(n){w(this).toggleClass(e.call(this,n,yt(this),t),t)}):this.each(function(){var t,a,i,o;if(r)for(a=0,i=w(this),o=mt(e);t=o[a++];)i.hasClass(t)?i.removeClass(t):i.addClass(t);else void 0!==e&&"boolean"!==n||((t=yt(this))&&X.set(this,"__className__",t),this.setAttribute&&this.setAttribute("class",t||!1===e?"":X.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+ht(yt(n))+" ").indexOf(t)>-1)return!0;return!1}});var gt=/\r/g;w.fn.extend({val:function(e){var t,n,r,a=this[0];return arguments.length?(r=h(e),this.each(function(n){var a;1===this.nodeType&&(null==(a=r?e.call(this,n,w(this).val()):e)?a="":"number"==typeof a?a+="":Array.isArray(a)&&(a=w.map(a,function(e){return null==e?"":e+""})),(t=w.valHooks[this.type]||w.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,a,"value")||(this.value=a))})):a?(t=w.valHooks[a.type]||w.valHooks[a.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(a,"value"))?n:"string"==typeof(n=a.value)?n.replace(gt,""):null==n?"":n:void 0}}),w.extend({valHooks:{option:{get:function(e){var t=w.find.attr(e,"value");return null!=t?t:ht(w.text(e))}},select:{get:function(e){var t,n,r,a=e.options,i=e.selectedIndex,o="select-one"===e.type,s=o?null:[],c=o?i+1:a.length;for(r=i<0?c:o?i:0;r<c;r++)if(((n=a[r]).selected||r===i)&&!n.disabled&&(!n.parentNode.disabled||!j(n.parentNode,"optgroup"))){if(t=w(n).val(),o)return t;s.push(t)}return s},set:function(e,t){for(var n,r,a=e.options,i=w.makeArray(t),o=a.length;o--;)((r=a[o]).selected=w.inArray(w.valHooks.option.get(r),i)>-1)&&(n=!0);return n||(e.selectedIndex=-1),i}}}}),w.each(["radio","checkbox"],function(){w.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=w.inArray(w(e).val(),t)>-1}},d.checkOn||(w.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),d.focusin="onfocusin"in e;var vt=/^(?:focusinfocus|focusoutblur)$/,bt=function(e){e.stopPropagation()};w.extend(w.event,{trigger:function(t,n,r,a){var i,o,s,c,u,p,f,d,g=[r||m],v=l.call(t,"type")?t.type:t,b=l.call(t,"namespace")?t.namespace.split("."):[];if(o=d=s=r=r||m,3!==r.nodeType&&8!==r.nodeType&&!vt.test(v+w.event.triggered)&&(v.indexOf(".")>-1&&(v=(b=v.split(".")).shift(),b.sort()),u=v.indexOf(":")<0&&"on"+v,(t=t[w.expando]?t:new w.Event(v,"object"===(void 0===t?"undefined":_typeof(t))&&t)).isTrigger=a?2:3,t.namespace=b.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+b.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:w.makeArray(n,[t]),f=w.event.special[v]||{},a||!f.trigger||!1!==f.trigger.apply(r,n))){if(!a&&!f.noBubble&&!y(r)){for(c=f.delegateType||v,vt.test(c+v)||(o=o.parentNode);o;o=o.parentNode)g.push(o),s=o;s===(r.ownerDocument||m)&&g.push(s.defaultView||s.parentWindow||e)}for(i=0;(o=g[i++])&&!t.isPropagationStopped();)d=o,t.type=i>1?c:f.bindType||v,(p=(X.get(o,"events")||Object.create(null))[t.type]&&X.get(o,"handle"))&&p.apply(o,n),(p=u&&o[u])&&p.apply&&U(o)&&(t.result=p.apply(o,n),!1===t.result&&t.preventDefault());return t.type=v,a||t.isDefaultPrevented()||f._default&&!1!==f._default.apply(g.pop(),n)||!U(r)||u&&h(r[v])&&!y(r)&&((s=r[u])&&(r[u]=null),w.event.triggered=v,t.isPropagationStopped()&&d.addEventListener(v,bt),r[v](),t.isPropagationStopped()&&d.removeEventListener(v,bt),w.event.triggered=void 0,s&&(r[u]=s)),t.result}},simulate:function(e,t,n){var r=w.extend(new w.Event,n,{type:e,isSimulated:!0});w.event.trigger(r,null,t)}}),w.fn.extend({trigger:function(e,t){return this.each(function(){w.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return w.event.trigger(e,t,n,!0)}}),d.focusin||w.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){w.event.simulate(t,e.target,w.event.fix(e))};w.event.special[t]={setup:function(){var r=this.ownerDocument||this.document||this,a=X.access(r,t);a||r.addEventListener(e,n,!0),X.access(r,t,(a||0)+1)},teardown:function(){var r=this.ownerDocument||this.document||this,a=X.access(r,t)-1;a?X.access(r,t,a):(r.removeEventListener(e,n,!0),X.remove(r,t))}}});var wt=e.location,Tt={guid:Date.now()},St=/\?/;w.parseXML=function(t){var n;if(!t||"string"!=typeof t)return null;try{n=(new e.DOMParser).parseFromString(t,"text/xml")}catch(e){n=void 0}return n&&!n.getElementsByTagName("parsererror").length||w.error("Invalid XML: "+t),n};var xt=/\[\]$/,kt=/\r?\n/g,Ot=/^(?:submit|button|image|reset|file)$/i,jt=/^(?:input|select|textarea|keygen)/i;function At(e,t,n,r){var a;if(Array.isArray(t))w.each(t,function(t,a){n||xt.test(e)?r(e,a):At(e+"["+("object"===(void 0===a?"undefined":_typeof(a))&&null!=a?t:"")+"]",a,n,r)});else if(n||"object"!==b(t))r(e,t);else for(a in t)At(e+"["+a+"]",t[a],n,r)}w.param=function(e,t){var n,r=[],a=function(e,t){var n=h(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!w.isPlainObject(e))w.each(e,function(){a(this.name,this.value)});else for(n in e)At(n,e[n],t,a);return r.join("&")},w.fn.extend({serialize:function(){return w.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=w.prop(this,"elements");return e?w.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!w(this).is(":disabled")&&jt.test(this.nodeName)&&!Ot.test(e)&&(this.checked||!fe.test(e))}).map(function(e,t){var n=w(this).val();return null==n?null:Array.isArray(n)?w.map(n,function(e){return{name:t.name,value:e.replace(kt,"\r\n")}}):{name:t.name,value:n.replace(kt,"\r\n")}}).get()}});var Ct=/%20/g,Et=/#.*$/,_t=/([?&])_=[^&]*/,Nt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Pt=/^(?:GET|HEAD)$/,It=/^\/\//,Mt={},Dt={},Rt="*/".concat("*"),Lt=m.createElement("a");function qt(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,a=0,i=t.toLowerCase().match(M)||[];if(h(n))for(;r=i[a++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function Ft(e,t,n,r){var a={},i=e===Dt;function o(s){var c;return a[s]=!0,w.each(e[s]||[],function(e,s){var u=s(t,n,r);return"string"!=typeof u||i||a[u]?i?!(c=u):void 0:(t.dataTypes.unshift(u),o(u),!1)}),c}return o(t.dataTypes[0])||!a["*"]&&o("*")}function Vt(e,t){var n,r,a=w.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((a[n]?e:r||(r={}))[n]=t[n]);return r&&w.extend(!0,e,r),e}Lt.href=wt.href,w.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:wt.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(wt.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Rt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":w.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Vt(Vt(e,w.ajaxSettings),t):Vt(w.ajaxSettings,e)},ajaxPrefilter:qt(Mt),ajaxTransport:qt(Dt),ajax:function(t,n){"object"===(void 0===t?"undefined":_typeof(t))&&(n=t,t=void 0),n=n||{};var r,a,i,o,s,c,u,l,p,f,d=w.ajaxSetup({},n),h=d.context||d,y=d.context&&(h.nodeType||h.jquery)?w(h):w.event,g=w.Deferred(),v=w.Callbacks("once memory"),b=d.statusCode||{},T={},S={},x="canceled",k={readyState:0,getResponseHeader:function(e){var t;if(u){if(!o)for(o={};t=Nt.exec(i);)o[t[1].toLowerCase()+" "]=(o[t[1].toLowerCase()+" "]||[]).concat(t[2]);t=o[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return u?i:null},setRequestHeader:function(e,t){return null==u&&(e=S[e.toLowerCase()]=S[e.toLowerCase()]||e,T[e]=t),this},overrideMimeType:function(e){return null==u&&(d.mimeType=e),this},statusCode:function(e){var t;if(e)if(u)k.always(e[k.status]);else for(t in e)b[t]=[b[t],e[t]];return this},abort:function(e){var t=e||x;return r&&r.abort(t),O(0,t),this}};if(g.promise(k),d.url=((t||d.url||wt.href)+"").replace(It,wt.protocol+"//"),d.type=n.method||n.type||d.method||d.type,d.dataTypes=(d.dataType||"*").toLowerCase().match(M)||[""],null==d.crossDomain){c=m.createElement("a");try{c.href=d.url,c.href=c.href,d.crossDomain=Lt.protocol+"//"+Lt.host!=c.protocol+"//"+c.host}catch(e){d.crossDomain=!0}}if(d.data&&d.processData&&"string"!=typeof d.data&&(d.data=w.param(d.data,d.traditional)),Ft(Mt,d,n,k),u)return k;for(p in(l=w.event&&d.global)&&0==w.active++&&w.event.trigger("ajaxStart"),d.type=d.type.toUpperCase(),d.hasContent=!Pt.test(d.type),a=d.url.replace(Et,""),d.hasContent?d.data&&d.processData&&0===(d.contentType||"").indexOf("application/x-www-form-urlencoded")&&(d.data=d.data.replace(Ct,"+")):(f=d.url.slice(a.length),d.data&&(d.processData||"string"==typeof d.data)&&(a+=(St.test(a)?"&":"?")+d.data,delete d.data),!1===d.cache&&(a=a.replace(_t,"$1"),f=(St.test(a)?"&":"?")+"_="+Tt.guid+++f),d.url=a+f),d.ifModified&&(w.lastModified[a]&&k.setRequestHeader("If-Modified-Since",w.lastModified[a]),w.etag[a]&&k.setRequestHeader("If-None-Match",w.etag[a])),(d.data&&d.hasContent&&!1!==d.contentType||n.contentType)&&k.setRequestHeader("Content-Type",d.contentType),k.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+("*"!==d.dataTypes[0]?", "+Rt+"; q=0.01":""):d.accepts["*"]),d.headers)k.setRequestHeader(p,d.headers[p]);if(d.beforeSend&&(!1===d.beforeSend.call(h,k,d)||u))return k.abort();if(x="abort",v.add(d.complete),k.done(d.success),k.fail(d.error),r=Ft(Dt,d,n,k)){if(k.readyState=1,l&&y.trigger("ajaxSend",[k,d]),u)return k;d.async&&d.timeout>0&&(s=e.setTimeout(function(){k.abort("timeout")},d.timeout));try{u=!1,r.send(T,O)}catch(e){if(u)throw e;O(-1,e)}}else O(-1,"No Transport");function O(t,n,o,c){var p,f,m,T,S,x=n;u||(u=!0,s&&e.clearTimeout(s),r=void 0,i=c||"",k.readyState=t>0?4:0,p=t>=200&&t<300||304===t,o&&(T=function(e,t,n){for(var r,a,i,o,s=e.contents,c=e.dataTypes;"*"===c[0];)c.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(a in s)if(s[a]&&s[a].test(r)){c.unshift(a);break}if(c[0]in n)i=c[0];else{for(a in n){if(!c[0]||e.converters[a+" "+c[0]]){i=a;break}o||(o=a)}i=i||o}if(i)return i!==c[0]&&c.unshift(i),n[i]}(d,k,o)),!p&&w.inArray("script",d.dataTypes)>-1&&(d.converters["text script"]=function(){}),T=function(e,t,n,r){var a,i,o,s,c,u={},l=e.dataTypes.slice();if(l[1])for(o in e.converters)u[o.toLowerCase()]=e.converters[o];for(i=l.shift();i;)if(e.responseFields[i]&&(n[e.responseFields[i]]=t),!c&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),c=i,i=l.shift())if("*"===i)i=c;else if("*"!==c&&c!==i){if(!(o=u[c+" "+i]||u["* "+i]))for(a in u)if((s=a.split(" "))[1]===i&&(o=u[c+" "+s[0]]||u["* "+s[0]])){!0===o?o=u[a]:!0!==u[a]&&(i=s[0],l.unshift(s[1]));break}if(!0!==o)if(o&&e.throws)t=o(t);else try{t=o(t)}catch(e){return{state:"parsererror",error:o?e:"No conversion from "+c+" to "+i}}}return{state:"success",data:t}}(d,T,k,p),p?(d.ifModified&&((S=k.getResponseHeader("Last-Modified"))&&(w.lastModified[a]=S),(S=k.getResponseHeader("etag"))&&(w.etag[a]=S)),204===t||"HEAD"===d.type?x="nocontent":304===t?x="notmodified":(x=T.state,f=T.data,p=!(m=T.error))):(m=x,!t&&x||(x="error",t<0&&(t=0))),k.status=t,k.statusText=(n||x)+"",p?g.resolveWith(h,[f,x,k]):g.rejectWith(h,[k,x,m]),k.statusCode(b),b=void 0,l&&y.trigger(p?"ajaxSuccess":"ajaxError",[k,d,p?f:m]),v.fireWith(h,[k,x]),l&&(y.trigger("ajaxComplete",[k,d]),--w.active||w.event.trigger("ajaxStop")))}return k},getJSON:function(e,t,n){return w.get(e,t,n,"json")},getScript:function(e,t){return w.get(e,void 0,t,"script")}}),w.each(["get","post"],function(e,t){w[t]=function(e,n,r,a){return h(n)&&(a=a||r,r=n,n=void 0),w.ajax(w.extend({url:e,type:t,dataType:a,data:n,success:r},w.isPlainObject(e)&&e))}}),w.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),w._evalUrl=function(e,t,n){return w.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){w.globalEval(e,t,n)}})},w.fn.extend({wrapAll:function(e){var t;return this[0]&&(h(e)&&(e=e.call(this[0])),t=w(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(e){return h(e)?this.each(function(t){w(this).wrapInner(e.call(this,t))}):this.each(function(){var t=w(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=h(e);return this.each(function(n){w(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(e){return this.parent(e).not("body").each(function(){w(this).replaceWith(this.childNodes)}),this}}),w.expr.pseudos.hidden=function(e){return!w.expr.pseudos.visible(e)},w.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},w.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch(e){}};var Ht={0:200,1223:204},zt=w.ajaxSettings.xhr();d.cors=!!zt&&"withCredentials"in zt,d.ajax=zt=!!zt,w.ajaxTransport(function(t){var n,r;if(d.cors||zt&&!t.crossDomain)return{send:function(a,i){var o,s=t.xhr();if(s.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(o in t.xhrFields)s[o]=t.xhrFields[o];for(o in t.mimeType&&s.overrideMimeType&&s.overrideMimeType(t.mimeType),t.crossDomain||a["X-Requested-With"]||(a["X-Requested-With"]="XMLHttpRequest"),a)s.setRequestHeader(o,a[o]);n=function(e){return function(){n&&(n=r=s.onload=s.onerror=s.onabort=s.ontimeout=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?i(0,"error"):i(s.status,s.statusText):i(Ht[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=n(),r=s.onerror=s.ontimeout=n("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&e.setTimeout(function(){n&&r()})},n=n("abort");try{s.send(t.hasContent&&t.data||null)}catch(e){if(n)throw e}},abort:function(){n&&n()}}}),w.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),w.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return w.globalEval(e),e}}}),w.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),w.ajaxTransport("script",function(e){var t,n;if(e.crossDomain||e.scriptAttrs)return{send:function(r,a){t=w("<script>").attr(e.scriptAttrs||{}).prop({charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&a("error"===e.type?404:200,e.type)}),m.head.appendChild(t[0])},abort:function(){n&&n()}}});var $t,Bt=[],Wt=/(=)\?(?=&|$)|\?\?/;w.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Bt.pop()||w.expando+"_"+Tt.guid++;return this[e]=!0,e}}),w.ajaxPrefilter("json jsonp",function(t,n,r){var a,i,o,s=!1!==t.jsonp&&(Wt.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Wt.test(t.data)&&"data");if(s||"jsonp"===t.dataTypes[0])return a=t.jsonpCallback=h(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(Wt,"$1"+a):!1!==t.jsonp&&(t.url+=(St.test(t.url)?"&":"?")+t.jsonp+"="+a),t.converters["script json"]=function(){return o||w.error(a+" was not called"),o[0]},t.dataTypes[0]="json",i=e[a],e[a]=function(){o=arguments},r.always(function(){void 0===i?w(e).removeProp(a):e[a]=i,t[a]&&(t.jsonpCallback=n.jsonpCallback,Bt.push(a)),o&&h(i)&&i(o[0]),o=i=void 0}),"script"}),d.createHTMLDocument=(($t=m.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===$t.childNodes.length),w.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(d.createHTMLDocument?((r=(t=m.implementation.createHTMLDocument("")).createElement("base")).href=m.location.href,t.head.appendChild(r)):t=m),i=!n&&[],(a=A.exec(e))?[t.createElement(a[1])]:(a=be([e],t,i),i&&i.length&&w(i).remove(),w.merge([],a.childNodes)));var r,a,i},w.fn.load=function(e,t,n){var r,a,i,o=this,s=e.indexOf(" ");return s>-1&&(r=ht(e.slice(s)),e=e.slice(0,s)),h(t)?(n=t,t=void 0):t&&"object"===(void 0===t?"undefined":_typeof(t))&&(a="POST"),o.length>0&&w.ajax({url:e,type:a||"GET",dataType:"html",data:t}).done(function(e){i=arguments,o.html(r?w("<div>").append(w.parseHTML(e)).find(r):e)}).always(n&&function(e,t){o.each(function(){n.apply(this,i||[e.responseText,t,e])})}),this},w.expr.pseudos.animated=function(e){return w.grep(w.timers,function(t){return e===t.elem}).length},w.offset={setOffset:function(e,t,n){var r,a,i,o,s,c,u=w.css(e,"position"),l=w(e),p={};"static"===u&&(e.style.position="relative"),s=l.offset(),i=w.css(e,"top"),c=w.css(e,"left"),("absolute"===u||"fixed"===u)&&(i+c).indexOf("auto")>-1?(o=(r=l.position()).top,a=r.left):(o=parseFloat(i)||0,a=parseFloat(c)||0),h(t)&&(t=t.call(e,n,w.extend({},s))),null!=t.top&&(p.top=t.top-s.top+o),null!=t.left&&(p.left=t.left-s.left+a),"using"in t?t.using.call(e,p):("number"==typeof p.top&&(p.top+="px"),"number"==typeof p.left&&(p.left+="px"),l.css(p))}},w.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){w.offset.setOffset(this,e,t)});var t,n,r=this[0];return r?r.getClientRects().length?(t=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:t.top+n.pageYOffset,left:t.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],a={top:0,left:0};if("fixed"===w.css(r,"position"))t=r.getBoundingClientRect();else{for(t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;e&&(e===n.body||e===n.documentElement)&&"static"===w.css(e,"position");)e=e.parentNode;e&&e!==r&&1===e.nodeType&&((a=w(e).offset()).top+=w.css(e,"borderTopWidth",!0),a.left+=w.css(e,"borderLeftWidth",!0))}return{top:t.top-a.top-w.css(r,"marginTop",!0),left:t.left-a.left-w.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===w.css(e,"position");)e=e.offsetParent;return e||ne})}}),w.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var n="pageYOffset"===t;w.fn[e]=function(r){return H(this,function(e,r,a){var i;if(y(e)?i=e:9===e.nodeType&&(i=e.defaultView),void 0===a)return i?i[t]:e[r];i?i.scrollTo(n?i.pageXOffset:a,n?a:i.pageYOffset):e[r]=a},e,r,arguments.length)}}),w.each(["top","left"],function(e,t){w.cssHooks[t]=ze(d.pixelPosition,function(e,n){if(n)return n=He(e,t),Le.test(n)?w(e).position()[t]+"px":n})}),w.each({Height:"height",Width:"width"},function(e,t){w.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){w.fn[r]=function(a,i){var o=arguments.length&&(n||"boolean"!=typeof a),s=n||(!0===a||!0===i?"margin":"border");return H(this,function(t,n,a){var i;return y(t)?0===r.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(i=t.documentElement,Math.max(t.body["scroll"+e],i["scroll"+e],t.body["offset"+e],i["offset"+e],i["client"+e])):void 0===a?w.css(t,n,s):w.style(t,n,a,s)},t,o?a:void 0,o)}})}),w.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){w.fn[t]=function(e){return this.on(t,e)}}),w.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),w.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,t){w.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}});var Ut=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;w.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),h(e))return r=a.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(a.call(arguments)))}).guid=e.guid=e.guid||w.guid++,i},w.holdReady=function(e){e?w.readyWait++:w.ready(!0)},w.isArray=Array.isArray,w.parseJSON=JSON.parse,w.nodeName=j,w.isFunction=h,w.isWindow=y,w.camelCase=W,w.type=b,w.now=Date.now,w.isNumeric=function(e){var t=w.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},w.trim=function(e){return null==e?"":(e+"").replace(Ut,"")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return w});var Gt=e.jQuery,Xt=e.$;return w.noConflict=function(t){return e.$===w&&(e.$=Xt),t&&e.jQuery===w&&(e.jQuery=Gt),w},void 0===t&&(e.jQuery=e.$=w),w}),define("jqueryplugins",["jquery"],function(e){e.prototype.extend({popAttr:function(e){var t=this.attr(e);return this.removeAttr(e),t},popData:function(e){var t=this.data(e);return this.removeData(e),t},tag:function(){return this[0]&&this[0].tagName&&this[0].tagName.toLowerCase()},textNodes:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*";return 1===this.length&&this[0]instanceof Text?[this[0]]:this.get().concat(this.contents().get(),this.find(e).contents().get()).filter(function(e,t,n){return e instanceof Text&&n.indexOf(e)===t}).sort(function(e,t){return 2&e.compareDocumentPosition(t)?1:-1})},findAndFilter:function(e){return this.filter(e).add(this.find(e))}})}),function(){var e=void 0,t={};function n(){for(var e=0;e<arguments.length;e++)for(var t in arguments[e])this[t]=arguments[e][t]}function r(e,t){e.childAt=e.childAt||{};for(var n=t.start;n<t.end;n+=1)e.childAt[n]=t}function a(e,t,n,r){return!(e.canFollow&&!(e.canFollow.indexOf(n&&n.type)>-1)||e.cannotFollow&&(-1!==e.cannotFollow.indexOf(n&&n.type)||e.cannotFollow.indexOf("text")>-1&&r)||e.peek&&e.peek.toLowerCase()!==t.slice(0,e.peek.length).toLowerCase())}function i(e){for(var n=e.innerText,r=[],i=0,s=i,c=n.length,u=null;i<c;){for(var l=n.slice(i),p=(r.length?r[0]:e).innerMode,f=0,d=p.length;f<d;f+=1){var h=t[p[f]];if(a(h,l,u,s<i)&&h.pattern.test(l)){var y=h.pattern.exec(l),m=h.fn(y),g=!1,v=0;if(m.matches){for(;v<r.length;v+=1){var b=r[v].type;if(b in m.matches){g=!0;break}0===b.indexOf("verbatim")&&(b="verbatimOpener"),m.cannotCross&&m.cannotCross.indexOf(b)>-1&&(v=r.length-1)}if(v>=r.length&&!m.isFront)continue}s<i&&e.addChild({type:"text",text:n.slice(s,i),innerMode:p}),s=i+=(u=e.addChild(m)).text.length,g&&(o(e,u,r[v]),r=r.slice(v+1)),u.isFrontToken()&&r.unshift(u);break}}f===d&&(i+=1,null===u&&(u={type:"text"}))}for(s<i&&e.addChild({type:"text",text:n.slice(s,i),innerMode:(r.length?r[0]:e).innerMode});r.length>0;)r.shift().demote();return e}function o(e,t,n){var a=e.children.indexOf(t),i=e.children.indexOf(n);t.children=e.children.splice(i+1,a-(i+1)),t.children.forEach(function(e){r(t,e)}),t.type=t.matches[n.type],t.innerText="";for(var o=0,s=t.children.length;o<s;o++)t.innerText+=t.children[o].text;t.start=n.start,t.text=n.text+t.innerText+t.text,Object.keys(n).forEach(function(e){Object.hasOwnProperty.call(t,e)||(t[e]=n[e])}),t.isFront&&(t.isFront=!1),e.children.splice(i,1),r(e,t)}n.prototype={constructor:n,addChild:function(e){var t=this.lastChildEnd(),a=new n({start:t,end:e.text&&t+e.text.length,children:[]},e);return a.innerText&&i(a),this.children.push(a),r(this,a),a},firstChild:function(){return this.children&&this.children[0]||null},lastChild:function(){return this.children&&this.children[this.children.length-1]||null},lastChildEnd:function(){var e=this.lastChild();return e?e.end:this.start+Math.max(0,this.text.indexOf(this.innerText))},tokenAt:function(e){if(e<this.start||e>=this.end)return null;if(this.childAt)return this.childAt[e]&&this.childAt[e].tokenAt(e)||this;if(this.children.length)for(var t=0;t<this.children.length;t+=1){var n=this.children[t].tokenAt(e);if(n)return n}return this},pathAt:function(e){if(e<this.start||e>=this.end)return[];if(this.childAt)return(this.childAt[e]&&this.childAt[e].pathAt(e)||[]).concat(this);var t=[];if(this.children.length)for(var n=0;n<this.children.length;n+=1){var r=this.children[n].pathAt(e);if(r.length){t.concat(r);break}}return t.concat(this)},nearestTokenAt:function(e){return e<this.start||e>=this.end?null:this.children?this.children.reduce(function(t,n){return t||(e>=n.start&&e<n.end?n:null)},null):this},everyLeaf:function(e){return this.children&&0!==this.children.length?this.children.reduce(function(t,n){return t&&n.everyLeaf(e)},!0):!!e(this)},isWhitespace:function(){return this.everyLeaf(function(e){return"whitespace"===e.type||!e.text.trim()})},isFrontToken:function(){return this.isFront},isBackToken:function(){return"matches"in this},demote:function(){this.type="text"},error:function(e){this.type="error",this.message=e},toString:function(){var e=this.type+"("+this.start+"\u2192"+this.end+")";return this.children&&this.children.length>0&&(e+="["+this.children+"]"),e}},e={lex:function(t,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"start";return i(new n({type:"root",start:r||0,end:t.length,text:t,innerText:t,children:[],childAt:{},innerMode:e.modes[a]}))},rules:t,modes:{}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=e:"function"==typeof define&&define.amd?define("lexer",[],function(){return e}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Lexer=e):this.TwineLexer=e}.call(eval("this")||("undefined"!=typeof global?global:window)),function(){var e;function t(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))?(Object.keys(e).forEach(function(n){e[n]=t(e[n])}),e):(e+"").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function n(e){return function(){return"("+e+Array.apply(0,arguments).join("|")+")"}}var r=n("?:"),a=n("?!"),i=n("?="),o="[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",s=o.replace("*","+"),c="\\b",u="[\\w\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",l=u.replace("\\-",""),p=r("\\n","$"),f=o+"(\\*+)"+s,d=o+"((?:0\\.)+)"+s,h=o+"-{3,}"+o+p,y=o+"(==+>|<=+|=+><=+|<==+>)"+o+p,m=o+"(=+\\|+|\\|+=+|=+\\|+=+|\\|=+\\|)"+o+p,g={opener:"\\[\\[(?!\\[)",text:"("+function(){return"[^"+Array.apply(0,arguments).map(t).join("")+"]*"}("]")+")",rightSeparator:r("\\->","\\|"),leftSeparator:"<\\-",closer:"\\]\\]",legacySeparator:"\\|",legacyText:"("+r("[^\\|\\]]","\\]"+a("\\]"))+"+)"},v=l+"*"+l.replace("\\w","a-zA-Z")+l+"*",b="\\$("+v+")",w="_("+v+")",T="'s"+s+"("+v+")",S="("+v+")"+s+"of"+c+a("it\\b"),x="'s"+s,k=r("it","time","visits?","exits?","pos")+c,O="its"+s+"("+v+")",j="its"+s,A="("+v+")"+s+"of"+s+"it"+c,C="of\\b"+s+"it"+c,E={opener:"\\(",name:"("+r("\\$","_")+"?"+u+"+):"+a("\\/"),closer:"\\)"},_=r("=<","=>","[gl]te?\\b","n?eq\\b","isnot\\b","are\\b","x\\b","isa\\b","or"+s+"a"+c),N="[a-zA-Z][\\w\\-]*",P="(?:\"[^\"]*\"|'[^']*'|[^'\">])*?",I="\\|("+u+"+)(>|\\))",M="(<|\\()("+u+"+)\\|",D="\\b(\\d+(?:\\.\\d+)?(?:[eE][+\\-]?\\d+)?)"+a("m?s")+c;g.main=g.opener+r(g.text+g.rightSeparator,g.text.replace("*","*?")+g.leftSeparator)+g.text,e={upperLetter:"[A-Z\\u00c0-\\u00de\\u0150\\u0170]",lowerLetter:"[a-z0-9_\\-\\u00df-\\u00ff\\u0151\\u0171]",anyLetter:u,anyLetterStrict:l,whitespace:s.replace("[","[\\n\\r"),escapedLine:"\\\\\\n\\\\?|\\n\\\\",br:"\\n(?!\\\\)",commentFront:"\x3c!--",commentBack:"--\x3e",tag:"<\\/?"+N+P+">",tagPeek:"<",scriptStyleTag:"<("+r("script","style","textarea")+")"+P+">[^]*?<\\/\\1>",scriptStyleTagOpener:"<",url:"("+r("https?","mailto","javascript","ftp","data")+":\\/\\/[^\\s<]+[^<.,:;\"')\\]\\s])",bullet:"\\*",hr:h,heading:"[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*(#{1,6})[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",align:y,column:m,bulleted:f,numbered:d,strikeOpener:t("~~"),italicOpener:t("//"),boldOpener:t("''"),supOpener:t("^^"),strongFront:t("**"),strongBack:t("**"),emFront:t("*"),emBack:t("*"),verbatimOpener:"`+",collapsedFront:"{",collapsedBack:"}",hookAppendedFront:"\\["+a("=+"),hookPrependedFront:I+"\\["+a("=+"),hookFront:"\\["+a("=+"),hookBack:"\\]"+a(M),hookAppendedBack:"\\]"+M,unclosedHook:"\\[=+",unclosedHookPrepended:I+"\\[=+",unclosedCollapsed:"\\{=+",passageLink:g.main+g.closer,passageLinkPeek:"[[",legacyLink:g.opener+g.legacyText+g.legacySeparator+g.legacyText+g.closer,legacyLinkPeek:"[[",simpleLink:g.opener+g.legacyText+g.closer,simpleLinkPeek:"[[",macroFront:E.opener+i(E.name),macroFrontPeek:"(",macroName:E.name,groupingFront:"\\("+a(E.name),groupingFrontPeek:"(",groupingBack:"\\)",twine1Macro:"<<[^>\\s]+\\s*(?:\\\\.|'(?:[^'\\\\]*\\\\.)*[^'\\\\]*'|\"(?:[^\"\\\\]*\\\\.)*[^\"\\\\]*\"|[^'\"\\\\>]|>(?!>))*>>",twine1MacroPeek:"<<",validPropertyName:v,property:T,propertyPeek:"'s",belongingProperty:S,possessiveOperator:x,belongingOperator:"of\\b",belongingOperatorPeek:"of",itsOperator:j,itsOperatorPeek:"its",belongingItOperator:C,belongingItOperatorPeek:"of",variable:b,variablePeek:"$",tempVariable:w,tempVariablePeek:"_",hookName:"\\?("+u+"+)\\b",hookNamePeek:"?",cssTime:"(\\d+\\.?\\d*|\\d*\\.?\\d+)(m?s)\\b",colour:r(r("Red","Orange","Yellow","Lime","Green","Cyan","Aqua","Blue","Navy","Purple","Fuchsia","Magenta","White","Gray","Grey","Black","Transparent"),"#[\\dA-Fa-f]{3}(?:[\\dA-Fa-f]{3})?"),datatype:r("alnum","alphanumeric","any(?:case)?","array","bool(?:ean)?","changer","colou?r","const","command","dm","data"+r("map","type","set"),"ds","digit","gradient","empty","even","int"+a("o")+"(?:eger)?","lambda","lowercase","macro","linebreak","num(?:ber)?","odd","str(?:ing)?","uppercase","whitespace")+c,number:D,boolean:r("true","false")+c,identifier:k,itsProperty:O,itsPropertyPeek:"its",belongingItProperty:A,escapedStringChar:"\\\\[^\\n]",singleStringOpener:"'",doubleStringOpener:'"',singleStringCloser:"'",doubleStringCloser:'"',is:"is"+a(s+"not"+c,s+"an?"+c,s+"in"+c,s+"<",s+">")+c,isNot:"is"+s+"not"+a(s+r("an?","in")+c)+c,isA:"is"+s+"an?"+c,isNotA:"is"+s+"not"+s+"an?"+c,matches:"matches\\b",doesNotMatch:"does"+s+"not"+s+"match"+c,and:"and\\b",or:"or\\b",not:"not\\b",inequality:"((?:is(?:"+s+"not)?"+o+")*)("+r("<(?!=)","<=",">(?!=)",">=")+")",isIn:"is"+s+"in"+c,contains:"contains\\b",doesNotContain:"does"+s+"not"+s+"contain"+c,isNotIn:"is"+s+"not"+s+"in"+c,addition:t("+")+a("="),subtraction:t("-")+a("=","type"),multiplication:t("*")+a("="),division:r("/","%")+a("="),comma:",",spread:"\\.\\.\\."+a("\\."),to:r("to\\b","="),into:"into\\b",making:"making\\b",where:"where\\b",when:"when\\b",via:"via\\b",each:"each\\b",augmentedAssign:r("\\+","\\-","\\*","\\/","%")+"=",bind:"2?bind\\b",typeSignature:t("-type")+c,incorrectOperator:_},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=e:"function"==typeof define&&define.amd?define("patterns",[],function(){return e}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Patterns=e):this.Patterns=e}.call(eval("this")||("undefined"!=typeof global?global:window)),function(){var e=void 0;Object.assign=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e};var t=Object.keys,n=Object.assign;function r(r){return Object.freeze({lex:function(r){function a(e){return e=e||"innerText",function(t){var n=t.reduceRight(function(e,t,n){return e||(n?t:"")},""),r={};return r[e]=n,r}}function i(e,t){var n={};return n[e]=t,function(){return{isFront:!0,matches:n,cannotCross:["verbatimOpener"]}}}var o=Object.bind(0,null);function s(e,t){return Object.keys(t).forEach(function(n){var r=t[n].fn;t[n].fn=function(t){var a=r(t);return a.text||(a.text=t[0]),a.type||(a.type=n),a.innerMode||(a.innerMode=e),a}}),t}var c=[],u=[],l=[],p=s(c,{hr:{fn:o},bulleted:{fn:function(e){return{depth:e[1].length}}},numbered:{fn:function(e){return{depth:e[1].length/2}}},heading:{fn:function(e){return{depth:e[1].length}}},align:{fn:function(e){var t=void 0,n=e[1],r=n.indexOf("><");return~r?25===(t=Math.round(r/(n.length-2)*50))&&(t="center"):"<"===n[0]&&">"===n.slice(-1)?t="justify":n.indexOf(">")>-1?t="right":n.indexOf("<")>-1&&(t="left"),{align:t}}},column:{fn:function(e){var t=void 0,n=e[1],r=n.indexOf("|");return r&&r<n.length-1?t="center":"|"===n[0]&&"|"===n.slice(-1)?t="none":r===n.length-1?t="right":r||(t="left"),{column:t,width:/\|+/.exec(n)[0].length,marginLeft:/^=*/.exec(n)[0].length,marginRight:/=*$/.exec(n)[0].length}}}});t(p).forEach(function(e){p[e].canFollow=[null,"br","hr","bulleted","numbered","heading","align","column","escapedLine"],p[e].cannotFollow=["text"]});var f=s(c,{twine1Macro:{fn:function(){return{type:"error",message:"Harlowe macros use a different syntax to Twine 1, SugarCube, and Yarn macros."}}},emBack:{fn:function(){return{matches:{emFront:"em"},cannotCross:["verbatimOpener"]}}},strongBack:{fn:function(){return{matches:{strongFront:"strong"},cannotCross:["verbatimOpener"]}}},strongFront:{fn:function(){return{isFront:!0}}},emFront:{fn:function(){return{isFront:!0}}},boldOpener:{fn:i("boldOpener","bold")},italicOpener:{fn:i("italicOpener","italic")},strikeOpener:{fn:i("strikeOpener","strike")},supOpener:{fn:i("supOpener","sup")},commentFront:{fn:function(){return{isFront:!0}}},commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},scriptStyleTag:{fn:o},tag:{fn:o},url:{fn:o},hookPrependedFront:{fn:function(e){return{name:e[1],hidden:")"===e[2],isFront:!0,tagPosition:"prepended"}}},hookFront:{fn:function(){return{isFront:!0}}},hookBack:{fn:function(){return{matches:{hookPrependedFront:"hook",hookFront:"hook"},cannotCross:["verbatimOpener"]}}},hookAppendedBack:{fn:function(e){return{name:e[2],hidden:"("===e[1],tagPosition:"appended",matches:{hookFront:"hook"},cannotCross:["verbatimOpener"]}}},unclosedHook:{fn:o},unclosedHookPrepended:{fn:function(e){return{type:"unclosedHook",name:e[1],hidden:")"===e[2]}}},verbatimOpener:{fn:function(e){var t=e[0].length,n={};return n["verbatim"+t]="verbatim",{type:"verbatim"+t,isFront:!0,matches:n}}},unclosedCollapsed:{fn:o},collapsedFront:{fn:function(){return{isFront:!0}}},collapsedBack:{fn:function(){return{matches:{collapsedFront:"collapsed"},cannotCross:["verbatimOpener"]}}},escapedLine:{fn:o},legacyLink:{fn:function(e){return{type:"twineLink",innerText:e[1],passage:e[2],innerMode:c}}},br:{fn:o}}),d=n(s(u,{macroFront:{fn:function(e){return{isFront:!0,name:e[1]}}},groupingBack:{fn:function(){return{matches:{groupingFront:"grouping",macroFront:"macro"},cannotCross:["singleStringOpener","doubleStringOpener"]}}},passageLink:{fn:function(e){var t=e[1]||"",n=e[2]||"",r=e[3]||"";return{type:"twineLink",innerText:n?r:t,passage:t?r:n,innerMode:c}}},simpleLink:{fn:function(e){return{type:"twineLink",innerText:e[1]||"",passage:e[1]||"",innerMode:c}}},variable:{cannotFollow:["macroFront"],fn:a("name")},tempVariable:{cannotFollow:["macroFront"],fn:a("name")}}),{hookFront:f.hookFront,hookBack:f.hookBack}),h=s(u,n({macroName:{canFollow:["macroFront"],fn:a("name")},groupingFront:{fn:function(){return{isFront:!0}}},property:{fn:a("name"),canFollow:["variable","hookName","property","tempVariable","colour","itsProperty","belongingItProperty","macro","grouping","string","datatype","hook","boolean","number"]},possessiveOperator:{fn:o},itsProperty:{cannotFollow:["text"],fn:a("name")},itsOperator:{cannotFollow:["text"],fn:o},belongingItProperty:{cannotFollow:["text"],fn:a("name")},belongingItOperator:{cannotFollow:["text"],fn:o},belongingProperty:{cannotFollow:["text"],fn:a("name")},belongingOperator:{cannotFollow:["text"],fn:o},escapedStringChar:{fn:function(){return{type:"text"}}},singleStringOpener:{fn:function(){return{isFront:!0,matches:{singleStringOpener:"string"},innerMode:l}}},doubleStringOpener:{fn:function(){return{isFront:!0,matches:{doubleStringOpener:"string"},innerMode:l}}},hookName:{fn:a("name")},cssTime:{fn:function(e){return{value:+e[1]*("s"===e[2].toLowerCase()?1e3:1)}}},datatype:{cannotFollow:["text"],fn:function(e){return{name:e[0].toLowerCase()}}},colour:{cannotFollow:["text"],fn:function(e){var t=e[0].toLowerCase(),n={red:"e61919",orange:"e68019",yellow:"e5e619",lime:"80e619",green:"19e619",cyan:"19e5e6",aqua:"19e5e6",blue:"197fe6",navy:"1919e6",purple:"7f19e6",fuchsia:"e619e5",magenta:"e619e5",white:"fff",black:"000",gray:"888",grey:"888"};return{colour:Object.hasOwnProperty.call(n,t)?"#"+n[t]:t}}},number:{fn:function(e){return{value:parseFloat(e[0])}}},inequality:{fn:function(e){return{operator:e[2],negate:e[1].indexOf("not")>-1}}},augmentedAssign:{fn:function(e){return{operator:e[0][0]}}},identifier:{fn:a("name"),cannotFollow:["text"]},whitespace:{fn:o,cannotFollow:"text"},incorrectOperator:{fn:function(e){var t={"=>":">=","=<":"<=",gte:">=",lte:"<=",gt:">",lt:"<",eq:"is",isnot:"is not",neq:"is not",isa:"is a",are:"is",x:"*","or a":"or"}[e[0].toLowerCase().replace(/\s+/g," ")];return{type:"error",message:"Please say "+(t?"'"+t+"'":"something else")+" instead of '"+e[0]+"'.",explanation:"In the interests of readability, I want certain operators to be in a specific form."}},cannotFollow:"text"}},["boolean","is","to","into","where","when","via","making","each","and","or","not","isNot","contains","doesNotContain","isIn","isA","isNotA","isNotIn","matches","doesNotMatch","bind"].reduce(function(e,t){return e[t]={fn:o,cannotFollow:["text"]},e},{}),["comma","spread","typeSignature","addition","subtraction","multiplication","division"].reduce(function(e,t){return e[t]={fn:o},e},{}))),y=s(l,{singleStringCloser:h.singleStringOpener,doubleStringCloser:h.doubleStringOpener,escapedStringChar:h.escapedStringChar});c.push.apply(c,_toConsumableArray(t(p)).concat(_toConsumableArray(t(d)),_toConsumableArray(t(f)))),u.push.apply(u,_toConsumableArray(t(d)).concat(_toConsumableArray(t(h)))),l.push.apply(l,_toConsumableArray(t(y)));var m=n({},p,f,d,h,y);t(m).forEach(function(t){var n=e[t];m[t].pattern="string"!=typeof n?n:RegExp("^(?:"+n+")","i"),e[t+"Peek"]&&(m[t].peek=e[t+"Peek"])}),n(r.rules,m);var g=r.modes;return g.start=g.markup=c,g.macro=u,g.string=l,r}(r).lex,Patterns:e})}"object"===("undefined"==typeof module?"undefined":_typeof(module))?(e=require("./patterns"),module.exports=r(require("./lexer"))):"function"==typeof define&&define.amd?define("markup",["lexer","patterns"],function(t,n){return e=n,r(t)}):this&&this.loaded&&this.modules?(e=this.modules.Patterns,this.modules.Markup=r(this.modules.Lexer)):(e=this.Patterns,this.TwineMarkup=r(this.TwineLexer))}.call(eval("this")||("undefined"!=typeof global?global:window)),define("utils/polyfills",[],function(){var e=Array.prototype;"function"!=typeof e.includes&&(e.includes=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!Number.isNaN(t)&&Number.isFinite(n)&&void 0!==t)return e.indexOf.call(this,t,n)>-1;var r=Object(this),a=parseInt(r.length);if(a<=0)return!1;for(var i=n>=0?n:Math.max(0,a+n);i<a;){if(Object.is(t,r[i]))return!0;i+=1}return!1}),!window.Symbol&&(window.Symbol={iterator:"_es6-shim iterator_"})}),define("utils",["jquery","markup","utils/polyfills"],function(e){var t=String.fromCharCode,n="audio,blockquote,canvas,div,h1,h2,h3,h4,h5,hr,ol,p,pre,table,ul,video,tw-align,tw-story,tw-passage,tw-sidebar,tw-columns,tw-column,tw-meter".split(","),r="a,b,i,em,strong,sup,sub,abbr,acronym,s,strike,del,big,small,script,img,button,input,tw-link,tw-broken-link,tw-verbatim,tw-collapsed,tw-error,tw-colour,tw-icon".split(","),a=["audio"],i=[function(e){return t(e)!==t(e).toLowerCase()},function(e){return t(e)!==t(e).toUpperCase()},function(e){return t(e).toLowerCase()!==t(e).toUpperCase()}].map(function(e){return"["+Array.from(Array(57343)).map(function(e,t){return t}).filter(e).map(function(e,n,r){return e===r[n-1]+1&&e===r[n+1]-1?"-":t(e)}).join("").replace(/\-+/g,"-")+"]"}),o=_slicedToArray(i,3),s=o[0],c=o[1],u=o[2];function l(e){return"instant"===e?0:800}var p=void 0,f=[],d={},h=0,y={},m=0,g={},v=void 0;function b(e,t,n,r,a){var i=null,o=0,s=t+n;function c(n){1&e[0].compareDocumentPosition(document)&&(s=0),i&&(s-=n-i,o+=n-i),i=n,r>0&&h+m>0&&(s-=r,e.css("animation-delay",(v.cssTimeUnit(e.css("animation-delay"))||0)-r+"ms")),s<=0?a(o):requestAnimationFrame(c),s<=t&&e.css("visibility","")}s?requestAnimationFrame(c):c()}return e(document.documentElement).on("keydown keyup mousedown mouseup",function(e){var t=e.key,n=e.button,r=e.type.includes("down"),a=t?d:y,i=t&&v.insensitiveName(t)||n;a[i]&&!r?t?h=Math.max(h-1,0):m=Math.max(m-1,0):!a[i]&&r&&(t?h+=1:m+=1),a[i]=r}).on("mousemove",function(e){var t=e.pageX,n=e.pageY;g.x=t,g.y=n}),v={lockProperty:function(e,t,n){var r=Object.create({configurable:0,writable:0});return n&&(r.value=n),Object.defineProperty(e,t,r),e},permutations:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=t.length,a=[[].concat(t)],i=Array(r).fill(0),o=1,s=void 0,c=void 0;o<r;)i[o]<o?(s=o%2&&i[o],c=t[o],t[o]=t[s],t[s]=c,++i[o],o=1,a.push([].concat(t))):(i[o]=0,++o);return a},shuffled:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t,n){var r=Math.random()*(n+1)|0;return r===n?e.push(t):(e.push(e[r]),e[r]=t),e},[])},matMul:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i;if(r.length>0)return(i=v).matMul.apply(i,[v.matMul(e,t)].concat(r));if(!t)return e;for(var o=[],s=0;s<e.length;s++){o[s]=[];for(var c=0;c<t[0].length;c++){for(var u=0,l=0;l<e[0].length;l++)u+=e[s][l]*t[l][c];o[s][c]=u}}return o},cssTimeUnit:function(e){return"ms"===(e=e.toLowerCase()).slice(-2)?+e.slice(0,-2)||0:"s"===e.slice(-1)&&1e3*+e.slice(0,-1)||0},nth:function(e){var t=(+e+"").slice(-1);return e+("1"===t?"st":"2"===t?"nd":"3"===t?"rd":"th")},plural:function(e,t){return e+" "+t+(e>1?"s":"")},andList:function(e){return 1===e.length?e[0]:e.slice(0,-1).join(", ")+" and "+e[e.length-1]},realWhitespace:"[ \\n\\r\\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]",anyRealLetter:"[\\dA-Za-z\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",anyUppercase:s,anyLowercase:c,anyCasedLetter:u,anyNewline:"(?:\\n|\\r|\\r\\n)",unescape:function(e){return e.replace(/&(?:amp|lt|gt|quot|nbsp|zwnj|#39|#96);/g,function(e){return{"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'","&nbsp;":String.fromCharCode(160),"&zwnj;":String.fromCharCode(8204)}[e]})},escape:function(e){return e.replace(/[&><"']/g,function(e){return{"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"}[e]})},insensitiveName:function(e){return(e+"").toLowerCase().replace(/-|_/g,"")},allKeysDown:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return d[e]})},someKeysDown:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function(e){return d[e]})},buttonsDown:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return y[e]})},anyInputDown:function(){return h+m>0},mouseCoords:g,parentColours:function(e){for(var t={colour:null,backgroundColour:null},n=/^\w+a\(.+?,\s*0\s*\)$|^transparent$/;e.length&&e[0]!==document;e=e.parent()){if(!t.backgroundColour){var r=e.css("background-color");r.match(n)||(t.backgroundColour=r)}if(!t.colour){var a=e.css("color");a.match(n)||(t.colour=a)}if(t.colour&&t.backgroundColour)return t}return{colour:"#fff",backgroundColour:"#000"}},childrenProbablyInline:function(e){var t=[];return[].every.call(e.findAndFilter("*"),function(e){return!!(e.hidden||/none|inline/.test(e.style.display)||/display: (none|inline)/.test(e.getAttribute("style")))||!n.includes(e.tagName.toLowerCase())&&!/display: (?!none|inline|inherit|unset)/.test(e.getAttribute("style"))&&(!!r.includes(e.tagName.toLowerCase())||(t.push(e),!0))})&&t.every(function(e){return window.getComputedStyle(e).display.includes("inline")})},transitionReplace:function(t,n,r){var a=t.closest("tw-hook");a.length>0&&(t=a);var i=e("<tw-transition-container>").css("position","relative");i.insertBefore(t.first());var o=void 0;n&&(o=e("<tw-transition-container>").appendTo(i),n.appendTo(o));var s=e("<tw-transition-container>").css("position","absolute").prependTo(i);t.detach().appendTo(s),v.transitionOut(s,r),n&&v.transitionIn(o,r,function(){o.unwrap().children().first().unwrap()})},transitionOut:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:void 0;0!==e.length&&(n=n||l(t),(e.length>1||!v.childrenProbablyInline(e)||!["tw-hook","tw-passage","tw-expression"].includes(e.tag()))&&(e=e.wrapAll("<tw-transition-container>").parent()),o&&e.css("transform-origin",o),e.attr("data-t8n",t).addClass("transition-out").css({"animation-duration":n+"ms","animation-delay":r-i+"ms"}),requestAnimationFrame(function(){v.childrenProbablyInline(e)?e.css("display","inline"):e.parent().is("tw-backdrop,tw-story")||e[0].setAttribute("style",e[0].getAttribute("style")+"display:block !important;width:100%")}),b(e,n,r-i,a,function(){e.remove()}))},transitionIn:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:void 0;if(0!==t.length){r=r||l(n);var u=t.length>1||!v.childrenProbablyInline(t)||!["tw-hook","tw-passage","tw-expression"].includes(t.tag());u&&(t=t.wrapAll("<tw-transition-container>").parent()),c&&t.css("transform-origin",c),t.attr("data-t8n",n).addClass("transition-in").css(Object.assign({"animation-duration":r+"ms","animation-delay":i-s+"ms"},i-s?{visibility:"hidden"}:{})),requestAnimationFrame(function(){v.childrenProbablyInline(t)?t.css("display","inline"):t.parent().is("tw-backdrop,tw-story")||t[0].setAttribute("style",t[0].getAttribute("style")+"display:block !important;width:100%")}),b(t,r,i-s,o,function(n){var r=0===t.filter(a.join(",")).length;u&&r?(t.find("tw-transition-container").each(function(t,r){(r=e(r)).css("animation-delay",v.cssTimeUnit(r.css("animation-delay")||0)-n+"ms")}),t.contents().unwrap()):t.removeClass("transition-in").removeAttr("data-t8n")})}},debounce:function(e){var t=void 0,n=void 0,r=0,a=function a(){Date.now()-r>300?(t=0,e.apply(void 0,_toConsumableArray(n))):t=requestAnimationFrame(a)};return function(){r=Date.now(),n=arguments,t&&cancelAnimationFrame(t),t=requestAnimationFrame(a)}},impossible:function(e,t){window.console&&console.error(e+"(): "+t)},assertMustHave:function(e,t){if(window.console)for(var n=0;n<t.length;n+=1)t[n]in e||console.error("Assertion failed: object lacks property "+t[n])},assertOnlyHas:function(e,t){if(window.console)for(var n in e)t.includes(n)||console.error("Assertion failed: object had unexpected property '"+n+"'!")},onStartup:function(e){f?f.push(e):e()},get storyElement(){return p}},e(function(){p=e("tw-story"),f.forEach(function(e){return e()}),f=null}),Object.freeze(v)}),define("utils/naturalsort",[],function(){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:String;return function(n,r){var a,i,o,s,c=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,u=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,p=/^0/,f=t(n).trim(),d=t(r).trim(),h=f.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),y=d.replace(c,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),m=parseInt(f.match(l))||1!==h.length&&f.match(u)&&Date.parse(f),g=parseInt(d.match(l))||m&&d.match(u)&&Date.parse(d)||null;if(e&&window.Intl&&window.Intl.Collator&&(o=window.Intl.Collator(e)),g){if(m<g)return-1;if(m>g)return 1}for(var v=0,b=Math.max(h.length,y.length);v<b;v++){if(a=!(h[v]||"").match(p)&&parseFloat(h[v])||h[v]||0,i=!(y[v]||"").match(p)&&parseFloat(y[v])||y[v]||0,isNaN(a)!==isNaN(i))return isNaN(a)?1:-1;if((void 0===a?"undefined":_typeof(a))!==(void 0===i?"undefined":_typeof(i)))a+="",i+="";else if("string"==typeof a&&o&&0!==(s=o.compare(a,i)))return s;if(a<i)return-1;if(a>i)return 1}return 0}}}),define("twinescript/compiler",["utils"],function(e){var t=e.impossible,n=JSON.stringify;function r(e,t){for(var n=0;n<e.length;n+=1)if(t.includes(e[n].type))return n;return NaN}function a(e,t){var n=[];return e.length?([["error"],["comma"],["to","into"],["where","when","via"],["making","each"],["typeSignature"],["augmentedAssign"],["and","or"],["is","isNot"],["contains","doesNotContain","isIn","isNotIn"],["isA","isNotA","matches","doesNotMatch"],["inequality"],["addition","subtraction"],["multiplication","division"],{rightAssociative:["spread","bind"]},{rightAssociative:["not","positive","negative"]},{rightAssociative:["belongingProperty","belongingItProperty","belongingOperator","belongingItOperator"]},["property","itsProperty","possessiveOperator","itsOperator"],["twineLink"],["macro"],["grouping"]]["most"===t?"reverse":"valueOf"]().some(function(t){var a=void 0;if(a=t.rightAssociative?r(e,t.rightAssociative):function(e,t){return e.length-1-r.apply(void 0,[[].concat(_toConsumableArray(e)).reverse(),t])}(e,t),!Number.isNaN(a)&&a>-1)return n=[e[a],a],!0}),n):n}function i(e){if("inequality"===e.type){var t=e.operator;return e.negate?{">":"<=","<":">=",">=":"<","<=":">"}[t]:t}return e.type}function o(e){var t=i(e);return{">":"<","<":">",">=":"<=","<=":">=",contains:"isIn",doesNotContain:"isNotIn",isIn:"contains",isA:"typifies",typifies:"isA",isNotA:"untypifies",untypifies:"isNotA"}[t]||t}var s=["inequality","is","isNot","isIn","contains","doesNotContain","isNotIn","isA","typifies","isNotA","untypifies","matches","doesNotMatch"];return function e(r){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},u=c.isVarRef,l=c.isTypedVar,p=c.whitespaceError,f=c.elidedComparison,d=c.testNeedsRight,h="Operations.Identifiers.it";if(!(r=[].concat(r)).length)return u&&p?"TwineError.create('operation',"+n(p)+")":"";var y=void 0;if(1===r.length){var m=(y=r[0]).type;if("identifier"===m)return u?"VarRef.create(Operations.Identifiers,"+n(y.text)+")":"Operations.Identifiers."+y.text.toLowerCase()+" ";if("variable"===m||"tempVariable"===m){var g="VarRef.create("+("tempVariable"===m?"section.stackTop.tempV":"State.v")+"ariables,"+n(y.name)+")"+(u||l?"":".get()");return l?"TypedVar.create(Datatype.create('any'),"+g+")":g}if("hookName"===m)return"HookSet.create({type:'name', data:'"+y.name+"'}) ";if("string"===m)return y.text.replace(/\n/g,"\\n");if("hook"===m)return"CodeHook.create("+n(y.text.slice(1,-1))+","+n(y.html||"")+")";if("colour"===m)return"Colour.create("+n(y.colour)+")";if("datatype"===m)return"Datatype.create("+n(y.name)+")";if("blockedValue"===m)return"section.blockedValue()";if("root"===m)return e(y.children);if("whitespace"===m&&u&&p)return"TwineError.create('operation',"+n(p)+")"}var v,b=a(r,"least"),w=_slicedToArray(b,2);y=w[0],v=w[1];var T=(y||{}).type,S=r.slice(0,v),x=r.slice(v+1),k=function(e,t){return{isVarRef:!0,isTypedVar:t,whitespaceError:"I need usable data to be on the "+e+' of "'+y.text+'".'}},O="must",j="mustn't",A="may",C=void 0,E=void 0,_="",N="",P="",I=O,M=O,D=!1;if(T)if("comma"===T)N=",",M=A;else if("spread"===T)_="Operations.makeSpreader(",P=")",I=A;else if("bind"===T)_="VarBind.create(",E=e(x,k("right")),P=(y.text.startsWith("2")?",'two way'":"")+")",I=j;else if("to"===T)_="Operations.makeAssignmentRequest(Operations.setIt(",E=e(x,k("right")),N="),",C=e(S,k("left",!0)),P=",'to')";else if("into"===T)_="Operations.makeAssignmentRequest(",E=e(S,k("left")),N=",Operations.setIt(",C=e(x,k("right",!0)),P="),'into')";else if("typeSignature"===T)_="TypedVar.create(",N=",",E=e(x,k("right")),P=")",l=!1;else if("where"===T||"when"===T||"via"===T)_="Lambda.create(",C=e(S,{isVarRef:!0,whitespaceError:null}).trim()||"undefined",N=","+n(y.type)+",",E=n(e(x)),P=","+n(r.map(function(e){return e.text}).join(""))+")";else if("making"===T||"each"===T)"each"===T?(_="Lambda.create(",E=e(x,k("right")).trim(),P=",'where','true',"+n(r.map(function(e){return e.text}).join(""))+")",I=A):(_="Lambda.create(",C=e(S,{isVarRef:!0,whitespaceError:null}).trim()||"undefined",N=","+n(y.type)+",",E=e(x,k("right")).trim(),P=","+n(r.map(function(e){return e.text}).join(""))+")");else if("augmentedAssign"===T)_="Operations.makeAssignmentRequest(",C=e(S,k("left")),N=",",E="Operations["+n(y.operator)+"]("+e(S)+","+e(x)+")",P=","+n(y.operator)+")";else if("and"===T||"or"===T){var R=function e(t){var n=a(t,"least"),r=_slicedToArray(n,2),i=r[0],o=r[1];if(i)return s.includes(i.type)?i:["and","or"].includes(i.type)?e(t.slice(0,o))||e(t.slice(o+1)):void 0},L=R(S),q=R(x),F="TwineError.create('operation', 'This use of \"is not\" and \""+T+"\" is grammatically ambiguous','Maybe try rewriting this as \"__ is not __ "+T+" __ is not __\"') ";if(_="Operations."+T+"(",N=",",P=")",f===y.type)_=P="",C=e(S,{isVarRef:u,elidedComparison:f}).trim(),E=e(x,{elidedComparison:f}).trim();else if(L&&!q){var V=L,H=n(i(V));if("isNot"===V.type||"isNotA"===V.type||"untypifies"===V.type)return F;E="Operations.elidedComparisonOperator("+n(y.type)+","+H+","+e(x,{elidedComparison:T})+")"}else if(!L&&q){var z=q,$=r.indexOf(z),B=n(o(z));if("isNot"===z.type||"isNotA"===z.type||"untypifies"===z.type)return F;E="Operations.elidedComparisonOperator("+n(y.type)+","+B+","+e(S,{elidedComparison:T})+")",C=e([].concat(_toConsumableArray(r.slice($+1)),[Object.assign(Object.create(z),_defineProperty({},"inequality"===z.type?"operator":"type",o(z)))],_toConsumableArray(r.slice(v+1,$))))}u=!1}else if(s.includes(T))D=!0,u=!1,_="Operations["+n(i(y))+"](",N=",",P=")";else if("addition"===T||"subtraction"===T){if(!e(S,{testNeedsRight:!0}).trim())return y.type={addition:"positive",subtraction:"negative"}[T],e(r,{isVarRef:u,whitespaceError:p,elidedComparison:f,testNeedsRight:d});u=!1,_="Operations["+n(y.text)+"](",N=",",P=")"}else if("multiplication"===T||"division"===T)u=!1,_="Operations["+n(y.text)+"](",N=",",P=")";else if("positive"===T||"negative"===T)u=!1,C="negative"===T?"-1":"1",_="Operations['*'](",N=",",P=")";else if("not"===T)_="Operations.not(",E=e(x),P=")",I=A;else if("belongingProperty"===T)_="VarRef.create(",E=e(x,k("right")),P=","+n(y.name)+")"+(u?"":".get()"),I=A;else if("belongingOperator"===T||"belongingItOperator"===T)C=y.type.includes("It")?h:e(x,k("right")),E=e(S),_="VarRef.create(",N=",{computed:true,value:",P="})"+(u?"":".get()");else if("property"===T)_="VarRef.create(",C=e(S,k("left")),P=","+n(y.name)+")"+(u?"":".get()"),M=A;else if("itsProperty"===T||"belongingItProperty"===T)_="VarRef.create(",C=h,P=","+n(y.name)+")"+(u?"":".get()"),I=M=A;else if("possessiveOperator"===T||"itsOperator"===T)y.type.includes("it")&&(C=h,I=A),_="VarRef.create(",N=",{computed:true,value:",P="})"+(u?"":".get()"),l=!1;else if("twineLink"===T)N='Macros.run("link-goto", [section,'+n(y.innerText)+","+n(y.passage)+"])",I=M=j;else if("macro"===T){var W=y.children[0],U="$"===W.text[0]||"_"===W.text[0];"macroName"===W.type||U||t("Compiler.compile","macro token had no macroName child token"),N="Macros.run"+(U?"Custom":"")+"("+(U?"VarRef.create("+("_"===W.text[0]?"section.stackTop.tempV":"State.v")+"ariables,"+n(W.text.trim().slice(1,-1))+").get()":'"'+y.name+'"')+", [section,"+e(y.children.slice(1),{isTypedVar:l})+"])",I=M=j}else if("grouping"===T)N="("+e(y.children,{isVarRef:u})+")",I=M=j;else if("error"===T)return"TwineError.create('syntax',"+n(y.message)+(y.explanation?", "+n(y.explanation):"")+")";return v>-1?(C=(C||e(S,{isVarRef:u,isTypedVar:l})).trim(),E=(E||e(x)).trim(),D&&!C&&(C=h),I===O&&!C||M===O&&!E?d&&M&&!E?"":"TwineError.create('operation','I need usable code to be "+(I===O?"left ":"")+(I===O&&M===O?"and ":"")+(M===O?"right ":"")+'of "'+y.text+"\"')":I===j&&C||M===j&&E?"TwineError.create('operation','There can't be code to the "+(I===j?"left ":"")+(I===j&&M===j?"or ":"")+(M===j?"right ":"")+'of "'+y.text+"\"')":_+C+N+E+P):1===r.length?(("value"in r[0]?r[0].value:r[0].text)+"").trim()||" ":r.reduce(function(t,n){return t+e(n,{isVarRef:u,isTypedVar:l})},"")}}),define("internaltypes/twineerror",["jquery","utils"],function(e,t){var n=t.impossible,r=t.escape;e(document.documentElement).on("click","tw-folddown",function(t){var n=t.target;for((n=e(n)).toggleClass("open");n&&!n.next().length;)n=n.parent();n&&n.next().toggle()});var a={syntax:"The markup seems to contain a mistake.",saving:"I tried to save or load the game, but I couldn't do it.",operation:"I tried to perform an operation on some data, but the data's type was incorrect.",macrocall:"I tried to use a macro, but its call wasn't written correctly.",datatype:"I tried to use a macro, but was given the wrong type of data to it.",custommacro:"I tried to use a custom macro, but its code hook had a mistake in it.",infinite:"I almost ended up doing the same thing over and over, forever.",property:"I tried to access a value in a string/array/datamap, but I couldn't find it.",unimplemented:"I currently don't have this particular feature. I'm sorry.",javascript:"This error message was reported by your browser's Javascript engine. I don't understand it either, but it usually means that an expression was badly written.",propagated:"Click the 'Open' button to see the code hook as it was executed.",user:"This is a custom error created by (error:). It usually means you used a custom macro incorrectly.",assertion:"This command exists to provide a helpful error if a certain important condition wasn't true."},i={error:[],warning:[]},o={create:function(e,t,r,i){return t&&"string"==typeof t||n("TwineError.create","has a bad message string"),r||e in a||n("TwineError.create","no error explanation given"),"user"!==e&&(t=t[0].toUpperCase()+t.slice(1)),Object.assign(Object.create(this),{type:e,message:t,explanation:r,source:void 0,innerDOM:i,appendTitleText:!1})},fromError:function(e){return o.create("javascript","\u2615 "+e.message)},containsError:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){return e||(t instanceof Error?t:o.isPrototypeOf(t)?t:!!Array.isArray(t)&&o.containsError.apply(o,_toConsumableArray(t)))},!1)},createWarning:function(e,t){return Object.assign(this.create(e,t),{warning:!0})},render:function(n){var o=this;n=n||this.source||"";var s=e("<tw-error class='"+("javascript"===this.type?"javascript ":"")+(this.warning?"warning":"error")+"' title='"+r(n)+"'>"+r(this.message+(this.appendTitleText?" "+n:""))+"</tw-error>"),c=e("<tw-error-explanation>").text(this.explanation||a[this.type]).hide(),u=e("<tw-folddown tabindex=0>");return this.innerDOM&&e("<tw-open-button>").on("click",function(){var n=e("<tw-backdrop><tw-dialog></tw-backdrop>");n.find("tw-dialog").prepend(o.innerDOM,e("<tw-link tabindex=0>OK</tw-link>").on("click",function(){o.innerDOM.detach(),n.remove()}).wrap("<tw-dialog-links>").parent()),t.storyElement.prepend(n)}).appendTo(s),s.append(u).append(c),s.data("TwineError",this),i.error.forEach(function(e){return e(o,n)}),s},on:function(e,t){if(e in i)return"function"!=typeof t||i[e].includes(t)||i[e].push(t),o;n("TwineError.on","invalid event name")}};return o}),define("renderer",["utils","markup","twinescript/compiler","internaltypes/twineerror"],function(e,t,n,r){var a=e.escape,i=e.impossible,o=e.insensitiveName,s=void 0;function c(e,t){return"<"+t+">"+e+"</"+t+">"}function u(e,t){var n=s.render(e.children);return n&&c(n,t)}var l,p,f="text-align: center; max-width:50%; ",d=RegExp(t.Patterns.macroFront+t.Patterns.macroName,"ig");return s={options:{debug:!1,blockerMacros:[],metadataMacros:[]},preprocess:function(e){var a=s.options.metadataMacros;if(!(e.match(d)||[]).some(function(e){return a.some(function(t){return o(e.slice(1,-1))===t})}))return{};var i=!1,c={};return t.lex(e).children.forEach(function e(t){if("macro"===t.type){if(a.some(function(e){return t.name===e})){if(r.isPrototypeOf(c[t.name]))return;if(i)return void(c[t.name]=r.create("syntax","The ("+t.name+":) macro can't appear after non-metadata macros."));if(c[t.name])return void(c[t.name]=r.create("syntax","There is more than one ("+t.name+":) macro."));c[t.name]={code:n(t),source:t.text}}else i=!0;t.children.forEach(function e(t){"macro"===t.type&&a.some(function(e){return t.name===e})?c[t.name]=r.create("syntax","The ("+t.name+":) macro can't be inside another macro."):t.children.forEach(e)})}else t.children.forEach(e)}),c},exec:(l=void 0,p=void 0,function(e){return"string"!=typeof e?(i("Renderer.exec","source was not a string, but "+(void 0===e?"undefined":_typeof(e))),""):e===l?p:(l=e,p=s.render(t.lex(e).children))}),render:function e(i){var l="",p=[];if(!i)return l;for(var d=i.length,h=0;h<d;h+=1){var y=i[h];switch(y.type){case"error":l+=r.create("syntax",y.message,y.explanation).render(a(y.text))[0].outerHTML;break;case"numbered":case"bulleted":var m="numbered"===y.type?"ol":"ul";l+="<"+m+">";for(var g=1;h<d&&i[h];){if("br"===i[h].type){if(l+="</li>",!i[h+1]||i[h+1].type!==y.type)break}else i[h].type===y.type?(l+=("<"+m+">").repeat(Math.max(0,i[h].depth-g)),l+=("</"+m+">").repeat(Math.max(0,g-i[h].depth)),l+="<li>",g=i[h].depth):l+=e([i[h]]);h+=1}l+=("</"+m+">").repeat(g+1);break;case"align":for(;y&&"align"===y.type;){var v=y.align,b=h+=1;if("left"===v){h-=1;break}for(;h<d&&i[h]&&"align"!==i[h].type;)h+=1;var w=e(i.slice(b,h)),T="";switch(v){case"center":T+=f+"margin-left: auto; margin-right: auto;";break;case"justify":case"right":T+="text-align: "+v+";";break;default:+v&&(T+=f+"margin-left: "+v+"%;")}l+="<tw-align "+(T?'style="'+T+'"':"")+">"+w+"</tw-align>\n",y=i[h]}break;case"column":for(var S=[];y&&"column"===y.type;){var x=y.column,k=h+=1;if("none"===x){h-=1;break}for(;h<d&&i[h]&&"column"!==i[h].type;)h+=1;S.push({text:y.text,type:x,body:e(i.slice(k,h)),width:y.width,marginLeft:y.marginLeft,marginRight:y.marginRight}),y=i[h]}S.length&&function(){var e=S.reduce(function(e,t){return e+t.width},0);l+="<tw-columns>"+S.map(function(t){return"<tw-column type="+t.type+'  style="width:'+t.width/e*100+"%; margin-left: "+t.marginLeft+"em; margin-right: "+t.marginRight+'em;">'+t.body+"</tw-column>\n"}).join("")+"</tw-columns>"}();break;case"heading":for(l+="<h"+y.depth+">";++h<d&&i[h];){if("br"===i[h].type){l+="</h"+y.depth+">";break}l+=e([i[h]])}break;case"br":if(!p.length||/td|th/.test(p[0])){l+="<br>";for(var O=i[h+1];O&&("br"===O.type||"tag"===O.type&&/^<br\b/i.test(O.text));)l+="<tw-consecutive-br"+("tag"===O.type?" data-raw":"")+"></tw-consecutive-br>",O=i[(h+=1)+1]}break;case"hr":l+="<hr>";break;case"escapedLine":case"comment":break;case"inlineUrl":l+='<a class="link" href="'+a(y.text)+'">'+y.text+"</a>";break;case"scriptStyleTag":case"tag":var j=y.text.toLowerCase();/^<\/?(?:table|thead|tbody|tr|tfoot|td|th)\b/.test(j)&&p[y.text.startsWith("</")?"shift":"unshift"](j),l+=y.text.startsWith("</")?y.text:y.text.replace(/>$/," data-raw>");break;case"sub":case"sup":case"strong":case"em":l+=u(y,y.type);break;case"strike":l+=u(y,"s");break;case"bold":l+=u(y,"b");break;case"italic":l+=u(y,"i");break;case"twineLink":var A=_slicedToArray(t.lex("(link-goto:"+JSON.stringify(y.innerText)+","+JSON.stringify(y.passage)+")").children,1)[0];l+='<tw-expression type="macro" name="link-goto"'+(s.options.debug?' title="'+a(y.text)+'"':"")+' js="'+a(n(A))+'"></tw-expression>';break;case"hook":l+="<tw-hook "+(y.hidden?"hidden ":"")+(y.name?'name="'+o(y.name)+'"':"")+(s.options.debug&&y.name?' title="Hook: ?'+y.name+'"':"")+' source="'+a(y.innerText)+'"></tw-hook>';break;case"unclosedHook":return l+="<tw-hook "+(y.hidden?"hidden ":"")+(y.name?'name="'+o(y.name)+'"':"")+'source="'+a(i.slice(h+1,d).map(function(e){return e.text}).join(""))+'"></tw-hook>';case"verbatim":l+=c(a(y.innerText).replace(/\n/g,"<br>"),"tw-verbatim");break;case"collapsed":l+=u(y,"tw-collapsed");break;case"unclosedCollapsed":return l+="<tw-collapsed>"+e(i.slice(h+1,d))+"</tw-collapsed>";case"variable":case"tempVariable":case"macro":var C=function(){var t=[],i=[];if("macro"===y.type&&function n(r){"string"!==r.type&&"hook"!==r.type&&r.children.every(n);var a=r.firstChild();if("macro"===r.type&&a&&"macroName"===a.type&&s.options.blockerMacros.includes(o(a.text.slice(0,-1))))t.push(r);else if("hook"===r.type){if(!r.everyLeaf(function(e){return"error"!==e.type||(i.push(e),!1)}))return!1;r.html=e(r.children)}return!0}(y),i.length)return{v:r.create("syntax","This code hook's markup contained "+i.length+" error"+(i.length?"s":"")+":<br>\u2014"+i.map(function(e){return e.message}).join("<br>\u2014")).render(a(y.text))[0].outerHTML};var c=t.length&&t.map(function(e){var t=n(e);return e.type="blockedValue",t});l+='<tw-expression type="'+y.type+'" name="'+a(y.name||y.text)+'"'+(s.options.debug?' title="'+a(y.text)+'"':"")+(t.length?' blockers="'+a(JSON.stringify(c))+'"':"")+' js="'+a(n(y))+'"></tw-expression>',t.forEach(function(e){return e.type="macro"})}();if("object"===(void 0===C?"undefined":_typeof(C)))return C.v;break;default:l+=y.children&&y.children.length?e(y.children):y.text}}return l}},Object.freeze(s)}),define("passages",["jquery","utils/naturalsort","utils","markup","renderer","internaltypes/twineerror"],function(e,t,n,r,a,i){var o=n.unescape,s=n.onStartup,c=Object.assign;function u(e){var t=o(e.html()),n=a.preprocess(t);return c(new Map([["source",t],["tags",(e.attr("tags")||"").split(/\s/)||[]],["name",e.attr("name")]]),{TwineScript_TypeName:"a passage datamap",TwineScript_ObjectName:"a passage datamap",metadata:n})}var l=c(new Map,{TwineScript_ObjectName:"the Passages datamap",getTagged:function(e){var n=t("en",function(e){return e.get("name")}),r=[];return this.forEach(function(t){var n=t instanceof Map&&t.get("tags");Array.isArray(n)&&n.includes(e)&&r.push(t)}),r.sort(n)},getStorylets:function(e,n){var r=n?n.filter(e,[].concat(_toConsumableArray(l.values()))):[].concat(_toConsumableArray(l.values()));if(i.containsError(r))return r;var a=[],o=-1/0,s=r.reduce(function(t,n){if(t)return t;var r=n.get("storylet");if(r){var s=e.speculate(r,n.get("name"),"a (storylet:) macro");if(i.containsError(s))return s.message="There's an error in the storylet passage \""+n.get("name")+'":\n'+s.message,s.source=r.TwineScript_ToSource(),s;if(s){var c=n.get("exclusivity");o=Math.max(o,"number"==typeof c?c:0),a.push(n)}}},void 0);if(s)return s;var c=t("en");return a.filter(function(e){var t=e.get("exclusivity");return(t="number"==typeof t?t:0)===o}).sort(function(e,t){var n=e.get("urgency"),r=t.get("urgency");return(n="number"==typeof n?n:0)!==(r="number"==typeof r?r:0)?r-n:c(e.get("name"),t.get("name"))})},allStorylets:function(){return[].concat(_toConsumableArray(l.values())).filter(function(e){return e.get("storylet")})},loadMetadata:function(e){var t=[];return l.forEach(function(n){n.metadata&&Object.keys(n.metadata).forEach(function(r){if(i.containsError(n.metadata[r]))t.push(n.metadata[r]);else{var a=n.metadata[r],o=a.code,s=a.source,c=e.speculate(o,n.get("name"),"a ("+r+":) macro"),u='In "'+n.get("name")+'":\n';if(i.containsError(c))return c.message=u+c.message,c.source=s,void t.push(c);c instanceof Map?c.forEach(function(e,t){return l(t,e)}):l(r,c)}function l(e,r){n.has(e)?t.push(i.create("syntax","This passage's datamap already has a '"+JSON.stringify(e)+"' data name.")):n.set(e,r)}}),n.metadata=void 0}),t},hasValid:function(e){var t=this.get(e);return t&&t instanceof Map&&t.has("source")},create:u});return s(function(){Array.from(e("tw-storydata > tw-passagedata")).forEach(function(t){t=e(t),l.set(t.attr("name"),new u(t))})}),l}),define("utils/operationutils",["utils/naturalsort","utils","internaltypes/twineerror","patterns"],function(e,t,n,r){var a=t.impossible,i=t.nth,o=t.insensitiveName,s=t.permutations,c=r.validPropertyName,u="object",l="boolean",p="string",f="number",d="function";function h(e){return!!e&&((void 0===e?"undefined":_typeof(e))===u||(void 0===e?"undefined":_typeof(e))===d)}function y(e){return e&&Object.getPrototypeOf(e)===Object.prototype}function m(e){return Array.isArray(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":(void 0===e?"undefined":_typeof(e))===p?p:e&&(void 0===e?"undefined":_typeof(e))===u?u:""}function g(e){if(!h(e))return e;if(_typeof(e.TwineScript_Clone)===d)return e.TwineScript_Clone();if(Array.isArray(e))return[].concat(_toConsumableArray(e));if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if((void 0===e?"undefined":_typeof(e))===d)return Object.assign(e.bind(),e);switch(Object.getPrototypeOf(e)){case Object.prototype:return Object.assign({},e);case null:return Object.assign(Object.create(null),e)}return a("OperationUtils.clone","The value "+e+" cannot be cloned!"),e}function v(e){return h(e)&&"TwineScript_ObjectName"in e?e.TwineScript_ObjectName:Array.isArray(e)?"an array":e instanceof Map?"a datamap":e instanceof Set?"a dataset":(void 0===e?"undefined":_typeof(e))===l?"the boolean value '"+e+"'":(void 0===e?"undefined":_typeof(e))===p||(void 0===e?"undefined":_typeof(e))===f?"the "+(void 0===e?"undefined":_typeof(e))+" "+JSON.stringify(e):void 0===e?"an empty variable":"...whatever this is"}function b(e,t){return(void 0===e?"undefined":_typeof(e))!==u&&(void 0===t?"undefined":_typeof(t))!==u?e===t:Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every(function(e,n){return b(t[n],e)}):e instanceof Map&&t instanceof Map?b(Array.from(e.entries()).sort(),Array.from(t.entries()).sort()):e instanceof Set&&t instanceof Set?b([].concat(_toConsumableArray(e)),[].concat(_toConsumableArray(t))):e&&_typeof(e.TwineScript_is)===d?e.TwineScript_is(t):e&&(void 0===e?"undefined":_typeof(e))===u&&t&&(void 0===t?"undefined":_typeof(t))===u&&y(e)&&y(t)?b(Object.getOwnPropertyNames(e).map(function(t){return[t,e[t]]}),Object.getOwnPropertyNames(t).map(function(e){return[e,t[e]]})):Object.is(e,t)}return Object.freeze({isObject:h,isPureObject:y,singleTypeCheck:function e(t,n){if(null===n)return void 0===t;var r=void 0===t?"undefined":_typeof(t);if((void 0===n?"undefined":_typeof(n))!==d&&n.pattern){if("optional"===n.pattern||"zero or more"===n.pattern)return void 0===t||e(t,n.innerType);if("either"===n.pattern)return n.innerType.some(function(n){return e(t,n)});if("lambda"===n.pattern&&e(t,n.innerType))return n.clauses.includes("where")==="where"in t&&n.clauses.includes("making")==="making"in t&&n.clauses.includes("via")==="via"in t&&n.clauses.includes("with")==="with"in t;if("insensitive set"===n.pattern)return n.innerType.includes(o(t));if("range"===n.pattern)return n.range(t);if("wrapped"===n.pattern)return e(t,n.innerType)}return(void 0===n||void 0!==t)&&("anything"===n.TwineScript_TypeName&&void 0!==t&&!t.TwineScript_Unstorable||"everything"===n.TwineScript_TypeName&&void 0!==t||(n===String?r===p:n===Boolean?r===l:n===parseInt?r===f&&!Number.isNaN(t)&&!(t+"").includes("."):n===Number?r===f&&!Number.isNaN(t):n===Array?Array.isArray(t):n===Map||n===Set?t instanceof n:Object.isPrototypeOf.call(n,t)))},isValidDatamapName:function(e,t){if(e instanceof Map||a("isValidDatamapName","called with non-Map"),n.containsError(t))return t;if((void 0===t?"undefined":_typeof(t))!==p&&(void 0===t?"undefined":_typeof(t))!==f)return n.create("property","Only strings and numbers can be used as data names for "+v(e)+", not "+v(t)+".");var r=(void 0===t?"undefined":_typeof(t))===p?+t:""+t;return!(!Number.isNaN(r)&&e.has(r))||n.create("property","You mustn't use both "+v(t)+" and "+v(r)+" as data names in the same datamap.")},collectionType:m,isSequential:function(e){return(void 0===e?"undefined":_typeof(e))===p||Array.isArray(e)||_typeof(e.hooks)===d},unstorableValue:function e(t){return t&&t.TwineScript_Unstorable&&t||Array.isArray(t)&&t.find(e)||t instanceof Map&&[].concat(_toConsumableArray(t.values())).find(e)||t instanceof Set&&[].concat(_toConsumableArray(t)).find(e)},clone:g,objectName:v,typeName:function e(t){var n=y(t);if(n&&t.innerType)return t.typeName?t.typeName:"insensitive set"===t.pattern?"a case-insensitive string name":"either"===t.pattern?(Array.isArray(t.innerType)||a("typeName",'"either" pattern had non-array inner type'),t.innerType.map(e).join(" or ")):"optional"===t.pattern?"(optional) "+e(t.innerType):e(t.innerType);if(n&&t.pattern&&"range"===t.pattern){if(t.name)return t.name;var r=t.min,i=t.max;return"a"+(r>0?" positive":"")+(t.integer?" whole":"")+" number"+(0===r?" between 0 and "+i:i<1/0?" up to "+i:"")}return t===String||t===Number||t===Boolean?"a "+_typeof(t()):t===parseInt?"a whole number":t===Map?"a datamap":t===Set?"a dataset":t===Array?"an array":h(t)&&"TwineScript_TypeName"in t?t.TwineScript_TypeName:v(t)},typeID:function(e){var t=void 0===e?"undefined":_typeof(e);return[l,p,f].includes(t)?t:Array.isArray(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":e.TwineScript_TypeID||""},toSource:function t(r,o){var s=n.containsError(r);return s&&a("toSource","received a TwineError: "+s.message),_typeof(r.TwineScript_ToSource)===d?r.TwineScript_ToSource():y(r)&&"first"in r&&"last"in r?(r.first<0?(-1!==r.first?i(-r.first):"")+"last":i(r.first+1))+"to"+(r.last<0?(-1!==r.last?i(-r.last):"")+"last":i(r.last+1)):Array.isArray(r)?"(a:"+("property"===o?r.map(function(e){return e+(e>0)}):r).map(t)+")":r instanceof Map?"(dm:"+Array.from(r.entries()).sort(function(t,n){return[t[0],n[0]].sort(e("en"))[0]===t[0]?-1:1}).map(function(e){return e.map(t)})+")":r instanceof Set?"(ds:"+Array.from(r).sort(e("en")).map(t)+")":(void 0===r?"undefined":_typeof(r))===f&&"property"===o?r<0?-1===r?"last":i(-r)+"last":i(r+1):(void 0===r?"undefined":_typeof(r))===p&&"property"===o?RegExp(c).test(r)?r:"("+JSON.stringify(r)+")":JSON.stringify(r)},is:b,contains:function(e,t){if(e||""===e){if((void 0===e?"undefined":_typeof(e))===p)return(void 0===t?"undefined":_typeof(t))!==p?n.create("operation",v(e)+" can only contain strings, not "+v(t)+"."):e.includes(t);if(Array.isArray(e))return e.some(function(e){return b(e,t)});if(e instanceof Set||e instanceof Map)return Array.from(e.keys()).some(function(e){return b(e,t)})}return n.create("operation",v(e)+" cannot contain any values, let alone "+v(t))},isA:function(e,t){return _typeof(t.TwineScript_IsTypeOf)===d?t.TwineScript_IsTypeOf(e):n.create("operation",'"is a" should only be used to compare type names, not '+v(t)+".")},matches:function e(t,r){var a=!1;if(t&&_typeof(t.TwineScript_IsTypeOf)===d){var i=t.TwineScript_IsTypeOf(r);if(n.containsError(i))return i;a|=i}if(r&&_typeof(r.TwineScript_IsTypeOf)===d){var o=r.TwineScript_IsTypeOf(t);if(n.containsError(o))return o;a|=o}if(a)return!0;if(Array.isArray(t)&&Array.isArray(r)){for(var c=0,u=0,l=!0;l&&c<t.length&&u<r.length;){var p=t[c],f=r[u];if(p.rest){for(;u<r.length&&e(p,f);)f=r[u+=1];c+=1}else if(f.rest){for(;c<t.length&&e(p,f);)p=t[c+=1];u+=1}else e(p,f)?(c+=1,u+=1):l=!1}return l&&c>=t.length&&u>=r.length}return t instanceof Map&&r instanceof Map?e(Array.from(t.entries()).sort(),Array.from(r.entries()).sort()):t instanceof Set&&r instanceof Set?(t=[].concat(_toConsumableArray(t)),s.apply(void 0,_toConsumableArray(r)).some(function(n){return e(t,n)})):b(t,r)},subset:function e(t,r,a){if(!r||!a)return n.create("macrocall","The sub"+m(t)+" index value must not be "+(r&&a)+".");var i=(void 0===t?"undefined":_typeof(t))===p;if(i&&(t=Array.from(t)),r<0&&(r=Math.max(0,t.length+r+1)),a<0&&(a=Math.max(0,t.length+a+1)),r>a)return e(arguments[0],a,r);var o=t.slice(r>0?r-1:r,a).map(g);return i?o.join(""):o},range:function e(t,n){if(t>n)return e(n,t);var r=[t];for(n-=t;n-- >0;)r.push(++t);return r},printBuiltinValue:function e(t){return n.containsError(t)?t:t&&_typeof(t.TwineScript_Print)===d?t.TwineScript_Print():t instanceof Map?(t=Array.from(t.entries()),n.containsError(t)?t:t.reduce(function(t,n){var r=_slicedToArray(n,2),a=r[0],i=r[1];return t+"<tr><td>`"+e(a)+"`</td><td>`"+e(i)+"`</td></tr>"},"<table class=datamap>")+"</table>"):t instanceof Set?Array.from(t.values()).map(e)+"":Array.isArray(t)?t.map(e)+"":t&&_typeof(t.jquery)===p?t:h(t)?n.create("unimplemented","I don't know how to print this value yet."):t+""},unique:function(e,t,n){return!n.slice(t+1).some(function(t){return b(e,t)})}})}),define("utils/renderutils",["jquery","utils","renderer"],function(e,t,n){var r=RegExp(t.realWhitespace+"+"),a=RegExp(t.realWhitespace+"+","g");function i(e,t,n){var r=e.textContent.length;if(!(t>=r)){var a=void 0,i=[a=0===t?e:e.splitText(t)];return n&&(n<=0&&(n=r-n),n<r&&i.push(a.splitText(n-t))),i}}var o,s=(o=void 0,function(){if(void 0!==o)return o;var t=e("<p>");return t[0].normalize?(t.append(document.createTextNode("0-"),document.createTextNode("2"),document.createTextNode(""))[0].normalize(),o=1===t.contents().length):o=!1});var c="tw-collapsed,[collapsing=true]";var u=/^(=*)([^=]+)=*$/;return Object.freeze({dialog:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=r.section,i=r.parent,o=void 0===i?t.storyElement:i,s=r.cd,c=r.message,u=void 0===c?"":c,l=r.defaultValue,p=r.buttons,f=void 0===p?[{name:"OK",confirm:!0,callback:Object}]:p,d=e("<tw-backdrop><tw-dialog>"+(l||""===l?"<input type=text style='display:block;margin:0 auto'></input>\n":"")+"<tw-dialog-links>"+(f.length?f.reduce(function(e,t,n){var r=t.name;return e+"<tw-link style='margin:0 "+(n===f.length-1?"0 0 0.5em":0===n?"0.5em 0 0":"0.5em")+"' tabindex=0>"+r+"</tw-link>"},""):"<tw-link tabindex=0>"+f[0].name+"</tw-link>")+"</tw-dialog-links></tw-dialog></tw-backdrop>"),h=d.find("tw-dialog");if(o.append(d),a){a.renderInto(u,h,Object.assign({},s,{append:"prepend"}));var y=s&&s.transition&&d.find("tw-dialog > tw-transition-container");y&&y.length&&y.appendTo(d).append(h.prepend(y.contents().detach()))}else h.prepend(n.exec(u));if(l){var m=d.find("input").last();m.val(l).on("keypress",function(e){13===e.which&&(d.remove(),f.filter(function(e){return e.confirm}).forEach(function(e){return e.callback()}))}),setTimeout(function(){return m.focus()},100)}return f.reverse().forEach(function(t,n){e(d.find("tw-link").get(-n-1)).on("click",function(){d.remove(),t.callback()})}),d},realWhitespace:r,textNodeToChars:function(e){var t=[].concat(_toConsumableArray(e.textContent));return 1===t.length?[e]:t.reduce(function(e,t){return t.match(r)&&e.length&&e[e.length-1].match(r)?e[e.length-1]+=t:e.push(t),e},[]).reduce(function(t,n){var r=e;return n.length<e.textContent.length&&(e=e.splitText(n.length)),t.concat(r)},[])},findTextInNodes:function e(t,n){var r=[],a="",o=[];if(!t.length||!n)return o;for(;t.length>0;){r.push(t[0]),a+=t[0].textContent,t.shift();var s=a.indexOf(n);if(s>-1){for(var c,u=a.length-(s+n.length);s>=r[0].textContent.length;)s-=r[0].textContent.length,r.shift();if(1===r.length){var l=i(r[0],s,s+n.length);o.push(l[0]),l[1]&&t.unshift(l[1]);break}o.push(i(r[0],s,r[0].length)[0]),(c=o).push.apply(c,_toConsumableArray(r.slice(1,-1)));var p=i(r[r.length-1],0,r[r.length-1].textContent.length-u);o.push(p[0]),p[1]&&t.unshift(p[1]),o=o.filter(Boolean);break}}return[o].concat(_toConsumableArray(e(t,n)))},collapse:function(t){function n(t){return 0===e(this||t).parentsUntil(c).filter("tw-verbatim, tw-expression, [collapsing=false]").length}var r=function e(t){var n=t[0],r=t.parent();if(!r.length||t.findAndFilter("tw-story").length)return null;var a=r.textNodes().filter(function(e){var t=e.compareDocumentPosition(n);return 4&t&&!(8&t)});return(a=a[a.length-1])||e(r)}(t);e(r).parents(c).length||(r=null);var i=function e(t){var n=t[0],r=t.parent();if(!r.length||t.findAndFilter("tw-story").length)return null;var a=r.textNodes().filter(function(e){var t=e.compareDocumentPosition(n);return 2&t&&!(8&t)})[0];return a||e(r)}(t);e(i).parents(c).length||(i=null);var o="br:not([data-raw]),tw-consecutive-br:not([data-raw])";t.find(o).filter(n).replaceWith(document.createTextNode(" "));var u=(t=e(t.get().map(function(t){return e(t).filter(n).is(o)?e(document.createTextNode(" ")).replaceAll(t)[0]:t}))).textNodes(),l=0;u.reduce(function(e,t){return n(t)?(t.textContent=t.textContent.replace(a," ")," "!==t.textContent[0]||e&&e.textContent&&!(e.textContent.search(/\s$/)>-1)||(t.textContent=t.textContent.slice(1)),t):document.createTextNode("A")},r),[].concat(_toConsumableArray(u)).reverse().every(function(e){return!!n(e)&&(e.textContent.match(/^\s*$/)?(l+=e.textContent.length,e.textContent="",!0):(e.textContent=e.textContent.replace(/\s+$/,function(e){return l+=e.length,""}),!1))}),l>0&&i&&(u[u.length-1].textContent+=" "),t[0]&&s()&&t[0].normalize()},geomStringRegExp:u,geomParse:function(e){var t=e.length,n=u.exec(e)||[],r=_slicedToArray(n,3),a=r[0],i=r[1],o=r[2];return a?{marginLeft:i.length/t*100,size:o.length/t*100}:{marginLeft:0,size:0}}})}),define("datatypes/hookset",["jquery","utils","utils/renderutils","utils/operationutils"],function(e,t,n,r){var a=n.textNodeToChars,i=n.realWhitespace,o=n.findTextInNodes,s=r.toSource;function c(n){var r=n.dom,s=e();this.next&&(s=s.add(c.call(this.next,n)));var u=function(t,n){if(Array.isArray(n))return n.reduce(function(e,n){return e.add(t.get(n))},e());if(n&&"object"===(void 0===n?"undefined":_typeof(n))&&"first"in n&&"last"in n){var r=n.first,o=n.last,s=t.length;r<0&&(r+=s),o<0&&(o+=s);for(var c=[t.get(r)];r!==o;)r+=Math.sign(o-r),c.push(t.get(r));return e(c)}if("string"==typeof n){if("chars"===n){var u=[],l=!0,p=!1,f=void 0;try{for(var d,h=t.textNodes(":not(tw-error, tw-error *)")[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var y=d.value,m=!0,g=!1,v=void 0;try{for(var b,w=a(y)[Symbol.iterator]();!(m=(b=w.next()).done);m=!0){var T=b.value;T.textContent.match(i)||u.push(T)}}catch(e){g=!0,v=e}finally{try{!m&&w.return&&w.return()}finally{if(g)throw v}}}}catch(e){p=!0,f=e}finally{try{!l&&h.return&&h.return()}finally{if(p)throw f}}return e(u)}if("links"===n)return t.findAndFilter("tw-link, .enchantment-link");if("visited"===n)return t.findAndFilter("tw-link.visited");if("lines"===n){var S=t.findAndFilter("br:not(tw-sidebar *),tw-consecutive-br:not(tw-sidebar *)").get(),x=[[]];return t.textNodes(":not(tw-error, tw-error *):not(tw-sidebar, tw-sidebar *)").forEach(function(e){S.length&&2&e.compareDocumentPosition(S[0])&&(S.shift(),x.push([])),x[x.length-1]=x[x.length-1].concat(e)}),x=x.map(function(t){return t.map(function(n){for(var r=n.parentNode;e(r).textNodes().every(function(e){return t.includes(e)})&&!t.every(function(t){return e(r).has(t).length});){r=(n=r).parentNode}return n})}),e(x.map(function(t){return e(t).wrapAll("<tw-pseudo-hook>").parent()[0]}))}}return e(t.get(n))};if(this.selector){var l=void 0;if("string"===this.selector.type)l=function(t,n){var r=o(n.textNodes(),t),a=e();return r.forEach(function(t){a=a.add(e(t).wrapAll("<tw-pseudo-hook>").parent())}),a}(this.selector.data,r);else{if("base"===this.selector.type)return s.add(u(c.call(this.selector.data,n),this.property));var p=function(e){var n='tw-hook[name="'+(e=t.insensitiveName(e).replace(/"/g,"&quot;"))+'"],tw-enchantment[name="'+e+'"]';return n+={page:", tw-story",passage:", tw-passage",sidebar:", tw-sidebar",link:", tw-link, .enchantment-link"}[e]||""}(this.selector.data);l=r.findAndFilter(p).add(r.parentsUntil(t.storyElement.parent())).filter(p)}s=this.property?s.add(u(l,this.property)):s.add(l)}return s}function u(e){if(!e)return[];var n=e.selector,r=e.property,a=e.next;return[JSON.stringify(["base"===n.type?u(n.data):t.insensitiveName(n.data),r])].concat(_toConsumableArray(u(a))).sort()}var l=Object.freeze({forEach:function(t,n){var r=c.call(this,t).each(function(t){n(e(this),t)});return t.dom.findAndFilter("tw-pseudo-hook").contents().unwrap(),r},hooks:function(e){return c.call(this,e)},get TwineScript_ObjectName(){return this.property||this.next?"a complex hook name":"?"+this.selector.data+" (a hook name)"},TwineScript_TypeID:"hookName",TwineScript_TypeName:"a hook name (like ?this)",TwineScript_Unstorable:!0,TwineScript_ToSource:function(){var e="",n=this.selector,r=n.type,a=n.data;return"name"===r?a.match(RegExp("^"+t.anyRealLetter+"+$"))?e+="?"+a:e+="(hooks-named:"+JSON.stringify(a)+")":"string"===r?e+=JSON.stringify(a):"base"===r&&(e+=a.TwineScript_ToSource()+"'s "+s(this.property,"property")),this.next&&(e+=" + "+this.next.TwineScript_ToSource()),e},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t},TwineScript_is:function(e){return u(this)+""==u(e)+""},TwineScript_GetProperty:function(e){return l.create({type:"base",data:this},e,void 0)},TwineScript_Properties:["chars","links","lines","visited"],TwineScript_Clone:function(){return l.create(this.selector,this.property,this.next)},create:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;return Object.assign(Object.create(this||l),{selector:Object.freeze(e),property:t,next:n})},from:function(e){return l.isPrototypeOf(e)||"string"==typeof e||t.impossible("HookSet.from() was given a non-HookSet non-string."),l.isPrototypeOf(e)?e:l.create({type:"string",data:e})}});return l}),define("internaltypes/changedescriptor",["jquery","utils","renderer","datatypes/hookset"],function(e,t,n,r){var a=t.assertOnlyHas,i=t.impossible,o=t.transitionIn,s=n.exec,c=Object.assign,u=Object.keys,l=Object.create,p=Object.seal,f=function(e){return e.split(/\n/g).reduce(function(e,t,n,r){var a=r.length;return e.concat(document.createTextNode(t),n!==a-1&&document.createElement(t.length?"br":"tw-consecutive-br"))},[])},d=void 0,h={source:"",appendSource:null,enabled:!0,enablers:null,verbatim:!1,target:null,append:"",newTargets:null,transition:"",transitionTime:null,transitionDeferred:!1,transitionDelay:0,transitionSkip:0,transitionOrigin:null,loopVars:null,styles:null,attr:null,data:null,innerEnchantments:null,section:null,timestamp:0,summary:function(){var e=this;return["source","appendSource","enabled","verbatim","target","append","newTargets","transition","transitionTime","transitionDeferred","transitionDelay","transitionSkip","transitionOrigin","innerEnchantments","enablers"].filter(function(t){return e.hasOwnProperty(t)}).concat([this.attr.length&&"attr",this.styles.length&&"styles",u(this.loopVars).length&&"loopVars",u(this.data).length&&"data"].filter(Boolean))},create:function(e,t){var n=c(l(this),{attr:[].concat(this.attr||[]),styles:[].concat(this.styles||[]),loopVars:this.loopVars||{},data:this.data||{}},e);return t&&t.run(n),n},update:function(){var e=this,t=this.section,n=this.newTargets,a=this.transition,i=this.transitionDeferred,s=this.append,c=this.target;"function"==typeof c&&(c=c());var l=function(t){if(Array.isArray(e.styles)&&e.styles.length>0){var n=e.styles.reduce(function(e,t){return u(t).forEach(function(n){var r=t[n];e[+("function"==typeof r)].push(_defineProperty({},n,r))}),e},[[],[]]),r=_slicedToArray(n,2),a=r[0],i=r[1];a.forEach(function(e){return t.css(e)}),setTimeout(function(){i.forEach(function(e){return t.css(e)})})}e.attr&&e.attr.forEach(function(e){return t.attr(e)}),e.data&&t.data(e.data)};if(Array.isArray(n)&&n.length&&(c=n.map(function(e){return e.target})),[].concat(c).forEach(function(e){r.isPrototypeOf(e)?e.forEach(t,l):l(e)}),a&&!i&&!s){var p=c,f=void 0;do{!(f=p.data("timestamp"))&&(p=p.parent())}while(!f&&p.length);o(c,a,this.transitionTime,this.transitionDelay,this.transitionSkip,f?Date.now()-f:0,this.transitionOrigin)}},render:function(){var t=this,n=this.source,u=this.transition,l=this.transitionTime,p=this.transitionDeferred,y=this.enabled,m=this.enablers,g=this.data,v=this.section,b=this.newTargets,w=this.innerEnchantments,T=this.appendSource,S=this.target,x=this.target,k=this.append;if("function"==typeof S&&(S=S()),a(this,d),!k)return i("ChangeDescriptor.render","This doesn't have an 'append' method chosen."),e();if(m&&m.length){var O=m[0],j=O.descriptor,A=O.changer,C=j.render();if(A){var E=h.create({section:v,target:C});A.run(E),E.update()}return C}if(!y||void 0!==S.attr("hidden"))return h.create({target:S,attr:this.attr.filter(function(e){return!("style"in e)}),data:c({},g,{originalSource:n,hidden:!0})}).update(),e();if(Array.isArray(b)&&b.length&&(S=b),!S)return i("ChangeDescriptor.render","ChangeDescriptor has source but not a target!"),e();var _=e();if([].concat(S).filter(function(e){return!e.jquery}).map(function(e){var t=k,n=void 0;if(e.target&&e.append){var r=e;t=r.append,n=r.before,e=e.target}return{elements:e.hooks(v,x).filter(function(){return!(n&&1&this.compareDocumentPosition(document)&&2&this.compareDocumentPosition(x[0]))}),append:t}},[]).forEach(function(n){var r=n.elements,a=n.append;r.each(function(n,r){r=e(r),_=_.add(t.create({target:r,append:a,newTargets:null}).render()),r.filter("tw-pseudo-hook").contents().unwrap()})}),_.length||Array.isArray(S)||r.isPrototypeOf(S))return _;if(!(k in S)){if("replace"!==k)return i("ChangeDescriptor.render","The target doesn't have a '"+k+"' method."),e();S[0]instanceof Text?k="replaceWith":(S.empty(),k="append")}return S[0]instanceof Text&&("append"===k&&(k="after"),"prepend"===k&&(k="before")),_=e(n&&(this.verbatim?f(n):e.parseHTML(s(n),document,!0))),Array.isArray(T)&&T.forEach(function(n){var r=n.source,a=n.append,i=e(t.verbatim?f(r):e.parseHTML(s(r),document,!0));_="append"===a?_.add(i):"prepend"===a?i.add(_):i}),S[k](_.length?_:void 0),S.data("timestamp",Date.now()),this.update(),u&&!p&&o("replace"===k?S:_,u,l,this.transitionDelay,this.transitionSkip,this.expedite,this.transitionOrigin),w&&w.map(function(e){return e(S)}).forEach(function(e){return v.addEnchantment(e)}),_}};return d=u(h),p(h)}),define("datatypes/changercommand",["utils","utils/operationutils","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r){var a=e.impossible,i=t.is,o=t.toSource,s={},c={TwineScript_TypeID:"changer",TwineScript_TypeName:"a changer",TwineScript_Print:function(){return"`[A ("+this.macroName+":) changer]`"},TwineScript_ToSource:function(){return"("+this.macroName+":"+("else"===this.name?"":this.params.map(o))+")"+(this.next?"+"+this.next.TwineScript_ToSource():"")},summary:function(){var e=n.create();return this.run(e),e.summary()},create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Array.isArray(t)||a("ChangerCommand.create","params was not an array but "+t),Object.assign(Object.create(this),{macroName:e,params:t,next:n,TwineScript_ObjectName:"a ("+e+":) changer"})},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t},TwineScript_is:function(e){if(c.isPrototypeOf(e))return this.macroName===e.macroName&&i(this.params,e.params)&&i(this.next,e.next)},TwineScript_Clone:function(){for(var e=this.create(this.macroName,this.params,this.next),t=e;t.next;)t=t.next=t.next.TwineScript_Clone();return e},run:function(e){var t=s[this.macroName].apply(s,[e].concat(_toConsumableArray(this.params)));if(r.containsError(t))return t;this.next&&this.next.run(e)},register:function(e,t){s[e]=t}};return Object.freeze(c)}),define("state",["utils","passages","datatypes/changercommand","internaltypes/twineerror","utils/operationutils","markup","twinescript/compiler"],function(e,t,n,r,a,i,o){var s=e.impossible,c=a.objectName,u=a.toSource,l=i.lex,p=Object.assign,f=Object.create,d=["localStorage","sessionStorage"].map(function(e){try{return!!window[e]&&(window[e].setItem("test","1"),window[e].removeItem("test"),!0)}catch(e){return!1}}),h=p(f(null),{TwineScript_ObjectName:"this story's variables",TwineScript_TypeDefs:f(null),TwineScript_VariableStore:!0,TwineScript_MockVisits:null}),y={passage:"",variables:h,create:function(e,t){var n=f(y);return n.passage=e||"",n.variables=p(f(this.variables),t),n}},m=[],g=-1,v=y.create(),b=void 0,w={forward:[],back:[],load:[]},T=void 0;function S(e){v=(m[g]||y).create(e),function(){if(T.hasSessionStorage){var e=T.serialise();if("string"==typeof e)try{sessionStorage.setItem("Saved Session",e)}catch(e){return}}}()}return T=p({get passage(){return v.passage},get variables(){return v.variables},get pastLength(){return g},get futureLength(){return m.length-1-g},get mockVisits(){return v.variables.TwineScript_MockVisits||[]},set mockVisits(e){v.variables.TwineScript_MockVisits=e},passageNameVisited:function(e){var n=0;if(!t.get(e))return 0;for(var r=0;r<=g;r++)n+=+(e===m[r].passage);return n},passageNameLastVisited:function(e){if(!t.get(e))return 1/0;if(e===v.passage)return 0;for(var n=g;n>0;n--)if(m[n].passage===e)return g-n+1;return 1/0},pastPassageNames:function(){for(var e=[],t=g-1;t>=0;t--)e.unshift(m[t].passage);return e},timelinePassageNames:function(){return m.map(function(e){return e.passage})},play:function(e){v||s("State.play","present is undefined!"),v.passage=e,m=m.slice(0,g+1).concat(v),g+=1,S(e),w.forward.forEach(function(t){return t(e)})},rewind:function(e){var t=1,n=!1;if(e)if("string"==typeof e){if((t=this.passageNameLastVisited(e))===1/0)return}else"number"==typeof e&&(t=e);for(;t>0&&g>0;t--)n=!0,g-=1;return n&&(S(m[g].passage),w.back.forEach(function(e){return e()})),n},fastForward:function(e){var t=1,n=!1;for("number"==typeof e&&(t=e);t>0&&m.length>0;t--)n=!0,g+=1;return n&&(S(m[g].passage),w.forward.forEach(function(e){return e(m[g].passage,"fastForward")})),n},on:function(e,t){if(e in w)return"function"!=typeof t||w[e].includes(t)||w[e].push(t),T;s("State.on","invalid event name")},reset:function(){m=[],g=-1,v=y.create(),b=void 0,w.load.forEach(function(e){return e(m)})},hasStorage:d[0],hasSessionStorage:d[1]},function(){function e(e,t){Object.keys(t).forEach(function(n){return!n.startsWith("TwineScript_")&&(t[n]=e.eval(o(l(t[n],0,"macro"))))})}return{serialise:function(){var e=m.slice(0,g+1),t=e.map(function(e){return Object.keys(e.variables).filter(function(t){return e.variables[t]&&(n=e.variables[t],a=void 0===n?"undefined":_typeof(n),!(!r.containsError(n)&&("function"==typeof n.TwineScript_ToSource||Array.isArray(n)||n instanceof Map||n instanceof Set||"string"===a||"number"===a||"boolean"===a||Object.isPrototypeOf.call(h.TwineScript_TypeDefs,n))));var n,a}).map(function(t){return[t,e.variables[t]]})});if(b||(b=t.reduce(function(e,t,n){var r=_slicedToArray(t,2),a=r[0],i=r[1];return e||a&&[a,i,n+1]},void 0)),b){var n=_slicedToArray(b,3),a=n[0],i=n[1],o=n[2];return r.create("saving","The variable $"+a+" holds "+c(i)+" (which is, or contains, a complex data value) on turn "+o+"; the game can no longer be saved.")}try{return JSON.stringify(e,function(e,t){return this.TwineScript_VariableStore?"TwineScript_TypeDefs"===e?Object.keys(t).reduce(function(e,n){return e[n]=u(t[n]),e},{}):u(t):t})}catch(e){return!1}},deserialise:function(n,r){var a,i=void 0,o=h,s="The save data is unintelligible.";try{i=JSON.parse(r)}catch(e){return Error(s)}return Array.isArray(i)?(a=(i=i.map(function(r){if("object"!==(void 0===r?"undefined":_typeof(r))||!r.hasOwnProperty("passage")||!r.hasOwnProperty("variables"))return Error(s);if(!t.hasValid(r.passage))return Error("The data refers to a passage named '"+r.passage+"', but it isn't in this story.");if(r.variables=p(f(o),r.variables),Object.hasOwnProperty.call(r.variables,"TwineScript_TypeDefs")){var a=r.variables.TwineScript_TypeDefs=p(f(o.TwineScript_TypeDefs),r.variables.TwineScript_TypeDefs);try{e(n,a)}catch(e){return Error(s)}}try{e(n,r.variables)}catch(e){return Error(s)}return o=r.variables,p(f(y),r)})).find(function(e){return e instanceof Error}))?a:(m=i,w.load.forEach(function(e){return e(m)}),g=m.length-1,S(m[g].passage),!0):Error(s)}}}()),Object.seal(y),Object.freeze(T)}),define("internaltypes/varref",["state","internaltypes/twineerror","utils","utils/operationutils","datatypes/hookset"],function(e,t,n,r,a){var i=n.impossible,o=n.andList,s=n.nth,c=r.is,u=r.isObject,l=r.toSource,p=r.isSequential,f=r.objectName,d=r.typeName,h=r.clone,y=r.isValidDatamapName,m=r.subset,g=r.collectionType,v=r.unstorableValue,b=r.matches,w=void 0,T=0,S={set:[],delete:[]};function x(e,n){var r=void 0;if(e instanceof Map&&(r=t.containsError(y(e,n))))return r;if(p(e)){var i=void 0,s="You can only access position strings/numbers ('4th', 'last', '2ndlast', (2), etc.) or slices ('1stTo2ndlast', '3rdTo5th'), ",c="You can't access the '0th' or '0thlast' position of "+f(e)+".";if("number"==typeof n){if(0===n)return t.create("property","You can't access elements at position 0 of "+f(e)+".","Only positive and negative position values exist.");n>0&&(n-=1)}else if("string"==typeof n&&(i=/^(\d+)(?:st|[nr]d|th)last$/i.exec(n))){if("0"===i[1])return t.create("property",c);n=-i[1]}else if("string"==typeof n&&(i=/^(\d+)(?:st|[nr]d|th)$/i.exec(n))){if("0"===i[1])return t.create("property",c);n=i[1]-1}else if("string"==typeof n&&(i=/^(?:(\d+)(?:st|[nr]d|th)(last)?|last)to(?:(\d+)(?:st|[nr]d|th)(last)?|last)$/i.exec(n))){var u=_slicedToArray(i,5),l=u[1],d=void 0===l?0:l,h=u[2],m=u[3],g=void 0===m?0:m;n={last:g=u[4]?-g:g-1,first:d=h?-d:d-1}}else if("last"===n)n=-1;else if("random"===n){if(!e.length)return t.create("property","I can't get a random value from "+f(e)+", because it's empty");n=Math.random()*Array.from(e).length|0}else{if(a.isPrototypeOf(e)&&!a.TwineScript_Properties.includes(n))return t.create("property",s+o(a.TwineScript_Properties.map(function(e){return"'"+e+"'"}))+" of "+f(e)+", not "+f(n)+".");if(!["length","any","all","start","end","random"].includes(n)&&!a.isPrototypeOf(e))return t.create("property",s+"'length', 'any', 'all', 'start', 'end', and 'random' of "+f(e)+", not "+f(n)+".")}}else if(e instanceof Set){if(!["length","any","all"].includes(n))return t.create("property","You can only get the 'length', 'any' and 'all' of "+f(e)+".","To check contained values, use the 'contains' operator.");"length"===n&&(n="size")}else{if(Array.isArray(e.TwineScript_Properties)&&!e.TwineScript_Properties.includes(n))return t.create("property","You can only get the "+o(e.TwineScript_Properties.map(function(e){return"'"+e+"'"}))+" of "+f(e)+", not "+f(n)+".");if("number"==typeof e||"boolean"==typeof e)return t.create("property","You can't get data values from "+f(e)+".")}return n}function k(e,t){return t-0<0&&Math.abs(t)<=e.length?e.length+(t-0):t}function O(e,t){if(void 0===e)return e;if(e instanceof Map||w.isPrototypeOf(e))return e.get(t);if(("any"===t||"all"===t||"start"===t||"end"===t)&&!e.TwineScript_VariableStoreName)return function(e,t){var n="'"+t+"' value"+("any"===t?"":"s")+" of ";return{determiner:t,array:[].concat(_toConsumableArray(e)),string:"string"==typeof e&&e,TwineScript_ObjectName:n+f(e),TwineScript_TypeName:n+"a data structure",TwineScript_Unstorable:!0,TwineScript_Print:function(){return"`["+this.TwineScript_TypeName+"]`"}}}(e,t);if("string"==typeof e&&(e=[].concat(_toConsumableArray(e))),p(e)&&Number.isFinite(t)&&(t=k(e,t)),e.TwineScript_GetProperty)return e.TwineScript_GetProperty(t);var n=e[t];return"function"!=typeof n?n:void 0}function j(e){if(e.computed){var t=e.value;return w.isPrototypeOf(t)&&(t=t.get()),"string"==typeof t?"('"+t+"')":"("+t+")"}return"number"==typeof e?s(e):"'"+e+"'"}function A(n,r,i){if(n.TwineScript_VariableStore){if(n.TwineScript_TypeDefs&&r in n.TwineScript_TypeDefs){var o=n.TwineScript_TypeDefs[r];if("const"===o.name){if(void 0!==n[r])return t.create("operation","I can't alter "+(n===e.variables?"$":"_")+r+" because it's been restricted to a constant value.","This variable can't be changed for the rest of the story.")}else if(!b(o,i))return t.create("operation","I can't set "+(n===e.variables?"$":"_")+r+" to "+d(i)+" because it's been restricted to "+l(o)+"-type data.","You can restrict a variable or data name by giving a typed variable to (set:) or (put:).")}return!0}return Array.isArray(r)?r.map(function(e){return A(n,e)}):n instanceof Map?"string"==typeof r||t.create("operation",f(n)+" can only have string data names, not "+f(r)+"."):p(n)?["length","random","any","all","start","end"].includes(r)?t.create("operation","I can't forcibly alter the '"+r+"' of "+f(n)+".","start"===r||"end"===r?"Alter the values at actual positions, like 1st or 2ndlast, rather than just the '"+r+"'.":void 0):+r==(0|r)||t.create("property",f(n)+" can only have position keys ('3rd', '1st', (5), etc.), not "+j(r)+"."):n.TwineScript_Identifiers&&r in n?t.create("keyword","I can't alter the value of the '"+r+"' identifier.","You can only alter data in variables and hooks, not fixed identifiers."):t.create("operation","I can't modify "+f(n),n instanceof Set?"You should use an (array:) if you need to modify the data inside this dataset.":a.isPrototypeOf(n)?"You should alter hooks indirectly using macros like (replace:) or (enchant:).":void 0)}function C(e,t,n){var r=t;e instanceof Map?e.set(t,n):(p(e)&&(t=k(e,t)),e.TwineScript_Set?e.TwineScript_Set(t):e[t]=n),S.set.forEach(function(t){return t(e,r,n)})}function E(e,t){var n=t;p(e)&&(t=k(e,t)),Array.isArray(e)&&/^(?:[1-9]\d*|0)$/.exec(t)?e.splice(t,1):e instanceof Map||e instanceof Set?e.delete(t):delete e[t],S.delete.forEach(function(t){return t(e,n)})}function _(e){return Object.assign(Object.create(w),{error:e})}function N(n,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:r;if(r&&"object"===(void 0===r?"undefined":_typeof(r))&&"last"in r&&"first"in r){if(a.isPrototypeOf(n))return n.TwineScript_GetProperty(r);var s=r.first,c=r.last;return m(n,s+(s>=0),c+(c>=0))}if(Array.isArray(r))return a.isPrototypeOf(n)?n.TwineScript_GetProperty(r):r.map(function(e){return N(n,e,e)})["string"==typeof n?"join":"valueOf"]("");var u=O(n,r);if(void 0===u){if(n===e.variables)return T;if(n.TwineScript_VariableStore)return t.create("property","There isn't a temp variable named _"+i+" in this place.","Temp variables only exist inside the same passage and hook in which they're (set:).");if(Array.isArray(n)&&"number"==typeof r)return t.create("property","This array of "+n.length+" elements doesn't have a "+j(i)+" element.",n.length?"It contains: "+o(n.map(f))+".":"The array is empty.");var l=Array.from("function"==typeof n.keys&&n.keys());return t.create("property","I can't find a "+j(i)+" data name in "+f(n),n instanceof Map&&l.length?"Its names include: "+o(l)+".":void 0)}return u}function P(e,n){var r=this,a=this.compiledPropertyChain.reduce(function(e,t){var n=void 0;return n=0===e.length?r.object:N.apply(void 0,_toConsumableArray(e[e.length-1])),e.push([n,t])&&e},[]).reduceRight(e,n);return t.containsError(a)?a:void 0}return w=Object.freeze({get:function(){return this.error?this.error:N(this.compiledPropertyChain.slice(0,-1).reduce(function(e,t){return N(e,t)},this.object),this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0])},set:function(n){var r=this;return this.error?this.error:!this.object||this.object.TwineScript_VariableStore||this.object.TwineScript_Identifiers?P.call(this,function(n,a,i){var o,s=_slicedToArray(a,2),c=s[0],l=s[1];if(o=t.containsError(n,c,l)||t.containsError(A(c,l,n)))return o;var d;if(d=v(n))return t.create("operation",f(n)+" can't be stored"+(g(n)?" because it holds "+f(d)+".":""));if(i>0)c=h(c);else if(c.TwineScript_VariableStore&&c!==e.variables){for(var y=c;y.TwineScript_VariableStore&&!y.hasOwnProperty(l);)y=Object.getPrototypeOf(y);y.TwineScript_VariableStore&&(c=y)}if("string"==typeof c){if("string"!=typeof n)return t.create("datatype","I can't put this non-string value, "+f(n)+", in a string.");if(n.length!==(Array.isArray(l)?l.length:1))return t.create("datatype",f(n)+"is not the right length to fit into this string location.");c=[].concat(_toConsumableArray(c));var m=[].concat(_toConsumableArray(n));[].concat(l).forEach(function(e){0+e<0&&(e=c.length+(0+e)),c=[].concat(_toConsumableArray(c.slice(0,e)),[m.shift()],_toConsumableArray(c.slice(e+1)))}),c=c.join("")}else u(c)&&(void 0!==n.TwineScript_KnownName&&(n.TwineScript_KnownName=r.TwineScript_ObjectName),Array.isArray(l)&&p(n)?("string"==typeof n&&(n=[].concat(_toConsumableArray(n))),l.map(function(e,t){return[e,n[t]]}).forEach(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return C(c,n,r)})):C(c,l,n));return c},n):t.create("macrocall","I can't (set:) "+f(this)+", if the "+(f(this.object).match(/ (.+$)/)||["","value"])[1]+" isn't stored in a variable.","Modifying data structures that aren't in variables won't change the game state at all.")},delete:function(){return this.error?this.error:P.call(this,function(e,n,r){var a,i=_slicedToArray(n,2),o=i[0],s=i[1];if(a=t.containsError(e,o,s)||t.containsError(A(o,s)))return a;if(r>0&&(o=h(o)),null===e){var c="string"==typeof o;c&&(o=[].concat(_toConsumableArray(o))),Array.isArray(s)?(p(o)&&(s=[].concat(_toConsumableArray(new Set(s)))).sort(function(e,t){return k(o,t)-k(o,e)}),s.forEach(function(e){return E(o,e)})):E(o,s),c&&(o=o.join(""))}else C(o,s,e);return o},null)},defineType:function(e){var n=this.object,r=this.compiledPropertyChain;if(!n||!n.TwineScript_VariableStore||1!==r.length||!n.TwineScript_TypeDefs)return t.create("unimplemented","I can only restrict the datatypes of variables, not data names or anything else.");var a=r[0];Object.hasOwnProperty.call(n,"TwineScript_TypeDefs")||(n.TwineScript_TypeDefs=Object.create(n.TwineScript_TypeDefs));var i=n.TwineScript_TypeDefs,o=i[a];if(o&&!c(o,e))return t.create("operation","I can't redefine the type of "+f(this)+" to "+(e.TwineScript_ObjectName||d(e))+", as it is already "+(o.TwineScript_ObjectName||d(o))+".");i[a]=e,"const"===e.name&&(n[a]=void 0)},matches:function(e,t){return this.object===e&&this.compiledPropertyChain[0]===t},getName:function(){return this.compiledPropertyChain[0]},create:function(e,n){var r=void 0;if(r=t.containsError(e))return _(r);n=[].concat(n),w.isPrototypeOf(e)&&(n=e.propertyChain.concat(n),e=e.object);var a=function(e,n){return n.reduce(function(r,a,i){var o;return a.computed&&(a=a.value),w.isPrototypeOf(a)&&(a=a.get()),a=Array.isArray(a)?a.map(function(t){return x(e,t)}):x(e,a),(o=t.containsError(r,a))?o:(i<n.length-1&&(e=N(e,a)),r.push(a),r)},[])}(e,n);return(r=t.containsError(a))?_(r):Object.assign(Object.create(w),{object:e,propertyChain:n,compiledPropertyChain:a})},TwineScript_ToSource:function(){var t=this,n=function(e,n){return!n&&t.object.TwineScript_VariableStore?e:j(e)};return(this.object===e.variables?"$":this.object.TwineScript_VariableStore?"_":f(this.object)+"'s ")+(1===this.propertyChain.length?n(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,r){return e+"'s "+n(t,r)}))},get TwineScript_ObjectName(){return this.TwineScript_ToSource()+(this.object.TwineScript_VariableStoreName?" in "+this.object.TwineScript_VariableStoreName:"")},on:function(e,t){if(e in S)return"function"!=typeof t||S[e].includes(t)||S[e].push(t),w;i("VarRef.on","invalid event name")}})}),define("internaltypes/varscope",[],function(){return Object.seal({TwineScript_ObjectName:"the temporary variables",TwineScript_VariableStore:!0,TwineScript_TypeDefs:Object.create(null)})}),define("internaltypes/twinenotifier",["jquery","utils"],function(e,t){var n=t.impossible,r={create:function(e){return e||n("TwineNotifier.create","called with only 1 string."),Object.assign(Object.create(r),{message:e})},render:function(){return e("<tw-notifier>").attr("message",this.message)}};return r}),define("datatypes/custommacro",["jquery","utils/operationutils","internaltypes/changedescriptor","internaltypes/varref","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(e,t,n,r,a,i,o){var s=t.objectName,c=t.typeName,u=t.matches,l=Object.assign,p=Object.create,f=function(t){return function(c){for(var u=arguments.length,f=Array(u>1?u-1:0),d=1;d<u;d++)f[d-1]=arguments[d];t.called+=1;var h=t.varNames,y=t.params,m=t.body,g=l(p(a),{TwineScript_VariableStoreName:t.TwineScript_ObjectName+" call #"+t.called,TwineScript_TypeDefs:p(null)}),v=[],b=0;f.forEach(function(e,t){var n=h[b];g.TwineScript_TypeDefs[n]=y[b].datatype.rest?y[b].datatype.create("array"):y[b].datatype;var a=r.create(g,n);if(y[b].datatype.rest){var i=(g[n]||[]).concat([e]);if(t<f.length-1)return void(g[n]=i);a.set(i)}else a.set(e),b+=1;v.push(o.create(s(a)+" is now "+s(g[n])))}),f.length&&(b+=1),y[b]&&y[b].datatype.rest&&(r.create(g,h[b]).set([]),g.TwineScript_TypeDefs[name]=y[b].datatype.create("array"));var w=void 0,T=e("<p>").append(m.html),S=c.stack.length;for(c.stack.unshift({tempVariables:g,dom:T,output:function(e){w=e}}),c.execute();c.stack.length>S;)c.stack.shift();var x,k,O=T.find("tw-error");return O.length?(T.prepend(v.map(function(e){return e.render()}),"<br>"),i.create("propagated",O.length+" error"+(O.length>1?"s":"")+" occurred when running "+t.TwineScript_ObjectName+".",void 0,T)):void 0===w?i.create("custommacro",t.TwineScript_ObjectName+" didn't output any data or hooks using (output:) or (output-data:)."):n.isPrototypeOf(w)?(x=w,k=l({TwineScript_TypeID:"command",TwineScript_ObjectName:"a custom command",TwineScript_TypeName:"a custom command",TwineScript_Print:function(){return"`[a custom command]`"},TwineScript_Attach:function(e){return e.run(x),k},TwineScript_Run:function(){return x}})):w}},d=Object.freeze({TwineScript_TypeID:"macro",TwineScript_TypeName:"a custom macro",get TwineScript_ObjectName(){return this.TwineScript_KnownName?"the "+this.TwineScript_KnownName+" macro":"a custom macro"},TwineScript_GetProperty:function(e){if("params"===e)return[].concat(_toConsumableArray(this.params))},TwineScript_Properties:["params"],TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},TwineScript_Clone:function(){return l(p(d),this)},TwineScript_ToSource:function(){return"(macro:"+this.params.map(function(e){return e.TwineScript_ToSource()}).concat("")+this.body.TwineScript_ToSource()+")"},create:function(e,t){var n=l(p(this),{params:e,called:0,varNames:e.map(function(e){return e.varRef.propertyChain[0]}),typeSignature:e.map(function(e){var t=void 0;return t=e.datatype.toTypeSignatureObject?e.datatype.toTypeSignatureObject({rest:e.rest}):{pattern:"range",range:function(t){return u(e.datatype,t)},name:c(e.datatype)},e.rest?{pattern:"zero or more",innerType:t}:t}),body:t,TwineScript_KnownName:""});return n.fn=f(n),n}});return d}),define("datatypes/lambda",["utils/operationutils","internaltypes/varscope","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r){var a=e.objectName,i=Object.freeze({TwineScript_TypeID:"lambda",TwineScript_TypeName:"a lambda",get TwineScript_ObjectName(){return'a "'+("making"in this?"making ... ":"")+("where"in this?"where ... ":"")+("when"in this?"when ... ":"")+("via"in this?"via ... ":"")+'" lambda'},TwineScript_Print:function(){return"`[A lambda]`"},TwineScript_is:function(e){return e===this},TwineScript_ToSource:function(){return this.source},TypeSignature:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"lambda",innerType:i,clauses:t,typeName:'a "'+t.concat("").join(" ...")+'" lambda'}},TwineScript_Clone:function(){return Object.assign(Object.create(i),this)},create:function(e,o,s,c){var u=void 0;function l(e){var r=e&&e.varRef?e.varRef:e;return void 0===r||r&&n.isPrototypeOf(r)&&t.isPrototypeOf(r.object)&&1===r.propertyChain.length}if("making"===o&&!l(s))return r.create("syntax","I need a temp variable, or typed temp variable, to the right of '"+o+"', not "+a(s)+".");if(r.containsError(e))return e;if(i.isPrototypeOf(e)){if("when"===o||"when"in e)return r.create("syntax","A 'when' lambda cannot have any other clauses, such as '"+o+"'.");if(o in e&&("where"!==o||"true"!==e[o]))return r.create("syntax","This lambda has two '"+o+"' clauses.");u=e}else{if("when"===o&&void 0!==e)return r.create("syntax","A 'when' lambda shouldn't begin with a temp variable (just use 'when' followed by the condition).");if(!l(e))return r.create("syntax","This lambda needs to start with a single temp variable, or typed temp variable, not "+a(e)+".");(u=Object.create(this)).loop=e||""}return u.source=c.trim(),u[o]=s,u.making&&u.making.getName()===(u.loop&&u.loop.getName())?r.create("syntax","This lambda has two variables named '"+u.loop.getName()+"'.","Lambdas should have all-unique parameter names."):u},apply:function(e,n){var a=n.loop,i=n.pos,o=n.making,s=n.ignoreVia,c=n.tempVariables;function u(e,t){if(e)if("datatype"in e&&"varRef"in e){var n=e.varRef.create(c,e.varRef.propertyChain);n.defineType(e.datatype);var a=n.set(t);if(r.containsError(a))return a}else c[e.getName()]=t}c=c||Object.create(e.stack.length?e.stackTop.tempVariables:t);var l=u(this.loop,a)||u(this.making,o);if(r.containsError(l))return l;e.stack.unshift(Object.assign(Object.create(e.stackTop||null),{tempVariables:c,lambdaPos:this.when?void 0:i}));var p=e.eval("Operations");!a||this.making||this.when?p.initialiseIt(r.create("operation","I can't use 'it', or an implied 'it', in "+this.TwineScript_ObjectName)):p.initialiseIt(a);var f=!s&&this.via,d=e.eval("where"in this||"when"in this?"Operations.where("+(this.where||this.when)+","+(f||"true")+",null)":f||"true");return e.stack.shift(),d},filter:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=void 0,o=t.reduce(function(t,o,s){if(i=r.containsError(t))return i;var c=n.apply(e,{loop:o,pos:s+1,ignoreVia:!0,tempVariables:a});return(i=r.containsError(c))?i:t.concat(c?[o]:[])},[]);return(i=r.containsError(o))?i:o}});return i}),define("datatypes/codehook",["internaltypes/twineerror","renderer"],function(e,t){var n=t.exec;return Object.freeze({TwineScript_TypeName:"a code hook",TwineScript_ObjectName:"a code hook",TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return"["+this.source+"]"},create:function(t,r){r||(r=n(t));var a=e.containsError(r);return a||Object.assign(Object.create(this),{source:t,html:r})}})}),define("datatypes/colour",["jquery","utils"],function(e,t){var n=t.matMul,r=Math.max,a=Math.min,i=Math.sin,o=Math.cos,s=Math.pow,c=Math.round,u=Math.floor,l=Math.atan2,p=Math.cbrt,f=Math.sqrt,d=Math.PI,h=Object.assign,y=Object.create,m=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,g=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,v=y(null);function b(e){var t=e.r,n=e.g,i=e.b,o=e.a,s=r(t/=255,n/=255,i/=255),u=a(t,n,i),l=(s+u)/2,p=s-u;if(s===u)return{h:0,s:0,l:l};var f=void 0;switch(s){case t:f=(n-i)/p+(n<i?6:0);break;case n:f=(i-t)/p+2;break;case i:f=(t-n)/p+4}return{h:f=c(60*f),s:l>.5?p/(2-s-u):p/(s+u),l:l,a:o}}var w=[.96422,1,.82521],T=24389/27,S=216/24389,x=function(e){return e.map(function(e){return[e]})},k=function(e){return e.map(function(e){return e[0]})};function O(e){var t=e.l,r=e.c,a=e.h,c=e.a;t*=100;var u=[];u[1]=(t+16)/116,u[0]=r*o(a*d/180)/500+u[1],u[2]=u[1]-r*i(a*d/180)/200;var l=[s(u[0],3)>S?s(u[0],3):(116*u[0]-16)/T,t>T*S?s((t+16)/116,3):t/T,s(u[2],3)>S?s(u[2],3):(116*u[2]-16)/T].map(function(e,t){return e*w[t]}),p=k(n([[.9555766,-.0230393,.0631636],[-.0282895,1.0099416,.0210077],[.0122982,-.020483,1.3299098]],n([[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],x(l)))).map(function(e){return 255*e}),f=_slicedToArray(p,3);return{r:f[0],g:f[1],b:f[2],a:c}}function j(e){var t=O(e);return[t.r,t.g,t.b].every(function(e){return e>=0&&e<=255})}var A=Object.freeze({TwineScript_TypeID:"colour",TwineScript_TypeName:"a colour",TwineScript_ObjectName:"a colour",TwineScript_DebugName:function(){return"a colour "+this.TwineScript_Print()},"TwineScript_+":function(e){var t=this.toRGBA(),n=e.toRGBA();return A.create({r:Math.min(Math.round(.6*(t.r+n.r)),255),g:Math.min(Math.round(.6*(t.g+n.g)),255),b:Math.min(Math.round(.6*(t.b+n.b)),255),a:(t.a+n.a)/2})},TwineScript_Print:function(){var e=this.toRGBA();return"<tw-colour style='background-color:rgba("+[e.r,e.g,e.b,e.a]+");'></tw-colour>"},TwineScript_is:function(e){if(!A.isPrototypeOf(e))return!1;if(e.lcha&&this.lcha)return e.lcha.l===this.lcha.l&&e.lcha.c===this.lcha.c&&e.lcha.h===this.lcha.h&&e.a===this.a;var t=this.toRGBA();return(e=e.toRGBA()).r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},TwineScript_Clone:function(){return A.create(this)},toRGBAString:function(){var e=this.toRGBA();return"rgba("+e.r+", "+e.g+", "+e.b+", "+e.a+")"},toHSLA:function(){return b(this.toRGBA())},toRGBA:function(){return this.lch?O(function(e){if(j(e))return e;var t=(e=h({},e)).c,n=0;for(e.c/=2;t-n>1e-5;)j(e)?n=e.c:t=e.c,e.c=(t+n)/2;return e}(h({},this.lch,{a:this.a}))):this},toLCHA:function(){return this.lch?h({},this.lch):(t=(e=this).r,r=e.g,a=e.b,i=e.a,o=k(n([[1.0478112,.0228866,-.050127],[.0295424,.9904844,-.0170491],[-.0092345,.0150436,.7521316]],n([[.4124564,.3575761,.1804375],[.2126729,.7151522,.072175],[.0193339,.119192,.9503041]],x([t/255,r/255,a/255])))).map(function(e,t){return e/w[t]}).map(function(e){return e>S?p(e):(T*e+16)/116}),c=[116*o[1]-16,500*(o[0]-o[1]),200*(o[1]-o[2])],u=180*l(c[2],c[1])/d,{l:c[0]/100,c:f(s(c[1],2)+s(c[2],2)),h:u>=0?u:u+360,a:i});var e,t,r,a,i,o,c,u},LCHRotate:function(e){e<0&&(e=360+e);var t=this.toLCHA();return t.h=(t.h+e)%360,t.a=this.a,A.create(t)},TwineScript_GetProperty:function(e){if("lch"===e){var t=this.toLCHA();return new Map([["l",t.l],["c",t.c],["h",t.h]])}var n=this.toRGBA();return"h"===e||"s"===e||"l"===e?b(n)[e]:"r"===e||"g"===e||"b"===e||"a"===e?n[e]:void 0},TwineScript_Properties:["h","s","l","r","g","b","a","lch"],TwineScript_ToSource:function(){var e=!this.lch&&b(this);if(e&&!e.h&&!e.s){if(1===e.l)return"white";if(0===e.l)return"black"}return"("+(this.lch?"lch":"hsl")+":"+(this.lch?[this.lch.l,this.lch.c,this.lch.h]:[e.h,e.s,e.l])+(1!==this.a?","+this.a:"")+")"},create:function(t){return"string"==typeof t?this.create((A.isHexString(t)?function(e){return"string"!=typeof e?e:(e=(e=e.replace("#","")).replace(m,"$1$1$2$2$3$3"),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)})}:function(t){if(t in v)return v[t];var n=e("<p>").css("background-color",t).css("background-color");return n="transparent"===n?{r:0,g:0,b:0,a:0}:n.startsWith("rgb")?n.match(/\d+/g).reduce(function(e,t,n){return e["rgb"[n]]=+t,e},{}):{r:192,g:192,b:192},v[t]=n,n})(t)):!("h"in t&&"s"in t&&"l"in t)||"r"in t||"g"in t||"b"in t?("a"in t&&"number"==typeof t.a||(t.a=1),h(y(this),"h"in t&&"c"in t&&!("s"in t)&&"l"in t?{a:t.a,lch:{l:t.l,c:t.c,h:t.h}}:t)):this.create(function(e){var t=e.h,n=e.s,r=e.l,a=e.a;if(0===n){var i=u(255*r);return{r:i,g:i,b:i}}var o=r<.5?r*(1+n):r+n-r*n,s=2*r-o;function c(e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?s+6*(o-s)*e:e<.5?o:e<2/3?s+(o-s)*(2/3-e)*6:s}return{r:u(255*c((t/=360)+1/3)),g:u(255*c(t)),b:u(255*c(t-1/3)),a:a}}(t))},isHexString:function(e){return"string"==typeof e&&"#"===e[0]&&(e.slice(1).match(m)||e.slice(1).match(g))},isCSS3Function:function(e){return"string"==typeof e&&/^(?:rgb|hsl)a?\(\s*\d+\s*,\s*\d+%?\s*,\s*\d+%?(?:,\s*\d+(?:\.\d+)?\s*)?\)$/.test(e)}});return A}),define("datatypes/gradient",["utils/operationutils"],function(e){var t=e.toSource,n=Object.freeze({TwineScript_TypeID:"gradient",TwineScript_TypeName:"a gradient",TwineScript_ObjectName:"a gradient",TwineScript_DebugName:function(){return"a gradient "+this.TwineScript_Print()},TwineScript_GetProperty:function(e){var t=this;return"angle"===e?this.angle:"stops"===e?this.stops.map(function(e){return new Map([[t.repeating?"pixels":"percent",e.stop],["colour",e.colour.TwineScript_Clone()]])}):void 0},TwineScript_Properties:["angle","stops"],TwineScript_ToSource:function(){return"(gradient:"+this.angle+","+this.stops.map(function(e){return t(e.stop)+","+t(e.colour)})+")"},TwineScript_is:function(e){var t=this;return e.angle===this.angle&&e.stops.length===this.stops.length&&e.stops.every(function(e,n){var r=e.colour,a=e.stop;return t.stops[n].stop===a&&t.stops[n].colour.TwineScript_is(r)})},TwineScript_Clone:function(){return n.create(this.angle,[].concat(_toConsumableArray(this.stops)))},TwineScript_Print:function(){return"<tw-colour style='background:"+this.toLinearGradientString()+"'></tw-colour>"},create:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return Object.assign(Object.create(this),{angle:e,stops:t.sort(function(e,t){return e.stop-t.stop}),repeating:n})},multiply:function(e){return n.create(this.angle,this.stops.map(function(t){return{colour:t.colour,stop:t.stop*e}}))},toLinearGradientString:function(){var e=this;return(this.repeating?"repeating-":"")+"linear-gradient("+this.angle+"deg, "+this.stops.reduce(function(t,n){var r=n.colour,a=n.stop;return t+r.toRGBAString()+" "+a*(e.repeating?1:100)+(e.repeating?"px,":"%,")},"").slice(0,-1)+")"}});return n}),define("datatypes/datatype",["utils","utils/operationutils","datatypes/changercommand","datatypes/colour","datatypes/gradient","datatypes/lambda","datatypes/custommacro","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s){var c=e.realWhitespace,u=e.anyRealLetter,l=e.anyCasedLetter,p=e.anyNewline,f=t.objectName,d=Object.assign,h=Object.seal,y=Object.keys,m=Math.floor,g=Math.abs,v=void 0,b=void 0,w={TwineScript_TypeID:"datatype",TwineScript_TypeName:"a datatype",TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},get TwineScript_ObjectName(){return"the "+(this.rest?"...":"")+this.name+" datatype"},TwineScript_is:function(e){return w.isPrototypeOf(e)&&e.name===this.name},TwineScript_Clone:function(){return this.rest?this:Object.create(this)},TwineScript_ToSource:function(){return(this.rest?"...":"")+this.name},TwineScript_IsTypeOf:function(e){var t=this.name,n=this.rest;return!!v[t]&&v[t](e,n)},toTypeSignatureObject:function(){var e=this.name,t={pattern:"range",range:v[e],name:"a "+("dm"===e?"datamap":"ds"===e?"dataset":"num"===e?e+"ber":"str"===e?e+"ing":"color"===e?"colour":"bool"===e?e+"ean":"alnum"===e?"alphanumeric character":"int"===e?e+"eger":"even"===e||"odd"===e?e+" number":e.endsWith("case")||"whitespace"===e?e+" character":"empty"===e?e+" value":e)};return this.rest?{pattern:"zero or more",innerType:t}:t},create:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e="datamap"===e?"dm":"dataset"===e?"ds":"number"===e?"num":"string"===e?"str":"color"===e?"colour":"boolean"===e?"bool":"alphanumeric"===e?"alnum":"integer"===e?"int":e;var n=Object.create(this);return n.name=e,n.rest=t,n},from:function(e){var t=y(b).find(function(t){return b[t](e)});return t?w.create(t):s.create("datatype",f(e)+" doesn't correspond to a datatype value.")}};return b={array:Array.isArray,dm:function(e){return e instanceof Map},ds:function(e){return e instanceof Set},datatype:function(e){return w.isPrototypeOf(e)},changer:function(e){return n.isPrototypeOf(e)},colour:function(e){return r.isPrototypeOf(e)},gradient:function(e){return a.isPrototypeOf(e)},lambda:function(e){return i.isPrototypeOf(e)},macro:function(e){return o.isPrototypeOf(e)},str:function(e){return"string"==typeof e},num:function(e){return"number"==typeof e},bool:function(e){return"boolean"==typeof e}},v=d({},b,{even:function(e){return!isNaN(e)&&m(g(e))%2==0},odd:function(e){return!isNaN(e)&&m(g(e))%2==1},empty:function(e){return e instanceof Map||e instanceof Set?!e.size:!(!Array.isArray(e)&&"string"!=typeof e)&&!e.length},int:function(e){return"number"==typeof e&&e===(0|e)},uppercase:function(e){return"string"==typeof e&&1===[].concat(_toConsumableArray(e)).length&&[].concat(_toConsumableArray(e)).every(function(e){return e!==e.toLowerCase()})},lowercase:function(e){return"string"==typeof e&&1===[].concat(_toConsumableArray(e)).length&&[].concat(_toConsumableArray(e)).every(function(e){return e!==e.toUpperCase()})},whitespace:function(e){return"string"==typeof e&&!!e.match("^"+c+"$")},digit:function(e){return"string"==typeof e&&!!e.match("^\\d$")},alnum:function(e){return"string"==typeof e&&!!e.match("^"+u+"$")},anycase:function(e){return"string"==typeof e&&!!e.match("^"+l+"$")},linebreak:function(e){return"string"==typeof e&&!!e.match("^"+p+"$")},any:function(){return!0},const:function(){return!0}}),h(w)}),define("datatypes/typedvar",["utils/operationutils","datatypes/datatype","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r){var a=e.typeName,i=e.matches,o=e.toSource,s=e.unstorableValue,c=Object.freeze,u=Object.assign,l=Object.create,p=c({TwineScript_TypeName:"a typed variable name",get TwineScript_ObjectName(){return this.TwineScript_ToSource()},TwineScript_Print:function(){return"`[A typed variable name]`"},TwineScript_Unstorable:!0,TwineScript_Clone:function(){return u(l(p),{datatype:this.datatype.TwineScript_Clone(),varRef:this.varRef})},TwineScript_ToSource:function(){return o(this.datatype)+"-type "+this.varRef.TwineScript_ToSource()},TwineScript_GetProperty:function(e){return"name"===e?this.getName():this[e]},TwineScript_Properties:["datatype","name"],TwineScript_IsTypeOf:function(e){return i(this.datatype,e)},get:function(){var e;return(e=this.varRef).get.apply(e,arguments)},getName:function(){return this.varRef.getName()},defineType:function(){if("any"!==this.datatype.name)return this.varRef.defineType(this.datatype)},create:function(e,t){var n;if(n=r.containsError(t)||r.containsError(e)||t.error)return n;var i=s(e);return i&&!p.isPrototypeOf(i)?r.create("syntax","The -type syntax can't have "+a(i)+" to its left."):u(l(this),{datatype:e,varRef:t})}});return p}),define("macros",["jquery","utils/naturalsort","utils","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/lambda","datatypes/hookset","datatypes/codehook","datatypes/typedvar","datatypes/datatype","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c,u,l,p,f){var d=n.insensitiveName,h=n.nth,y=n.plural,m=n.andList,g=n.lockProperty,v=(r.clone,r.objectName),b=r.typeName,w=r.singleTypeCheck,T=r.toSource,S=void 0,x={};function k(e,n,r){var a=n.fn,i=n.typeSignature,s=n.isChanger,u=void 0!==s&&s,l=r[0];r=function(e){return e.reduce(function(e,n){if(n&&!0===n.spreader){var r=n.value,a=f.containsError(r);if(a)e.push(a);else if(Array.isArray(r)||"string"==typeof r)for(var i=0;i<r.length;i++)e.push(r[i]);else r instanceof Set?e.push.apply(e,_toConsumableArray(Array.from(r).sort(t("en")))):e.push(f.create("operation","I can't spread out "+v(r)+", because it is not a string, dataset, or array."))}else e.push(n);return e},[])}(r.slice(1)),i=[].concat(i||[]);var p=!e,d=p?"":"("+(Array.isArray(e)&&e.length>1?e[0]:e)+":)";e=p?"this custom macro":"the "+d+" macro";var g=void 0;g=i.length>0?e+" must only be given "+m(i.map(b))+(i.length>1?", in that order":"."):e+" must not be given any data."+(p?"":" Just write "+d);for(var T=void 0,x=function(t,n){var a=i[t],s=r[t];if(f.containsError(s))return{v:s};if(c.isPrototypeOf(s)&&u)return{v:f.create("syntax","Please put this hook outside the parentheses of the changer macro, not inside it.","Hooks should appear after a macro"+(p?".":": "+d+"[Some text]"))};if(t>=i.length&&!T)return{v:f.create("datatype",r.length-i.length+" too many values were given to "+e+".",g)};if(a||(a=T),!a.innerType||"rest"!==a.pattern&&"zero or more"!==a.pattern||(T=a.innerType,"rest"===a.pattern&&(a=a.innerType)),!w(s,a)){if(void 0===s){var l=i.filter(function(e){return!("optional"===e.pattern||"zero or more"===e.pattern)}).length;return{v:f.create("datatype",e+" needs "+y(l-t,"more value")+".",g)}}return s&&s.TwineScript_Unstorable&&(a===S.TypeSignature.Any||a.innerType&&a.innerType===S.TypeSignature.Any)?{v:f.create("datatype",e+"'s "+h(t+1)+" value, "+v(s)+", is not valid data for this macro.",g)}:s&&o.isPrototypeOf(s)&&"lambda"===a.pattern?{v:f.create("datatype",e+"'s "+h(t+1)+" value (a lambda) should have "+m(["where","when","making","via","with"].filter(function(e){return a.clauses.includes(e)}).map(function(e){return"a '"+e+"' clause"}))+", not "+m(["where","when","making","via","with"].filter(function(e){return e in s}).map(function(e){return"a '"+e+"' clause"}))+".")}:"insensitive set"===a.pattern?{v:f.create("datatype",v(s)+" is not a valid name string for "+e+".","Only the following names are recognised (capitalisation and hyphens ignored): "+m(a.innerType)+".")}:{v:f.create("datatype",e+"'s "+h(t+1)+" value is "+v(s)+", but should be "+b(a)+".",a.message||g)}}},k=0,O=Math.max(r.length,i.length);k<O;k+=1){var j=x(k);if("object"===(void 0===j?"undefined":_typeof(j)))return j.v}return a.apply(void 0,[l].concat(_toConsumableArray(r)))}function O(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a={fn:t,typeSignature:n};r&&(a.isChanger=!0),Object.freeze(a),Array.isArray(e)?e.forEach(function(e){return g(x,d(e),a)}):g(x,d(e),a)}return S={has:function(e){return e=d(e),x.hasOwnProperty(e)},get:function(e){return e=d(e),x.hasOwnProperty(e)&&x[e]},add:function e(t,n,r){return O(t,n,r),e},addChanger:function e(t,n,r,i){return O(t,n,i,!0),a.register(Array.isArray(t)?t[0]:t,r),e},addCommand:function e(t,n,r,a){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return O(t,function(e,t,n,r){return function(a){for(var i=arguments.length,o=Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];var c=t.apply(void 0,o);if(c)return c;var u=p.create(),l=Object.assign({TwineScript_TypeID:"command",TwineScript_ObjectName:"a ("+e+":) command",TwineScript_TypeName:"a ("+e+":) command",TwineScript_Print:function(){return"`[A ("+e+":) command]`"},TwineScript_ToSource:function(){return"("+e+":"+o.map(T)+")"},TwineScript_is:function(e){return T(this)===T(e)}},r?{TwineScript_Attach:function(e,t){return u.section=e,t.run(u),l},TwineScript_Run:function(e){return n.apply(void 0,[u,e].concat(o))}}:{TwineScript_Run:function(e){return n.apply(void 0,[e].concat(o))}});return l}}([].concat(t)[0],n,r,i),a),e},TypeSignature:{optional:function(e){return{pattern:"optional",innerType:e}},zeroOrMore:function(e){return{pattern:"zero or more",innerType:e}},either:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"either",innerType:t}},rest:function(e){return{pattern:"rest",innerType:e}},insensitiveSet:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"insensitive set",innerType:t}},numberRange:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0;return{pattern:"range",min:e,max:t,range:function(n){return"number"==typeof n&&!Number.isNaN(n)&&n>=e&&n<=t}}},nonNegativeInteger:{pattern:"range",integer:!0,min:0,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&e>=0&&!(e+"").includes(".")}},positiveInteger:{pattern:"range",integer:!0,min:1,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&e>=1&&!(e+"").includes(".")}},wrapped:function(e,t){return{pattern:"wrapped",innerType:e,message:t}},Any:{TwineScript_TypeName:"anything"},Everything:{TwineScript_TypeName:"everything"}},run:function(e,t){return S.has(e)?k(e,S.get(e),t):f.create("macrocall","I can't run the macro '"+e+"' because it doesn't exist.","Did you mean to run a macro? If you have a word written like (this:), it is regarded as a macro name.")},runCustom:function(e,t){return i.isPrototypeOf(e)?k("",e,t):f.create("macrocall","I can't call "+v(e)+" because it isn't a custom macro.")}},Object.assign(S.TypeSignature,{positiveNumber:S.TypeSignature.numberRange(Math.pow(2,-52),1/0),nonNegativeNumber:S.TypeSignature.numberRange(0,1/0),percent:S.TypeSignature.numberRange(0,1)}),Object.freeze(S)}),define("datatypes/varbind",["jquery","utils","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r,a){var i=n.objectName;return r.on("set",function(n,r){n.TwineScript_VariableStore&&e(t.storyElement).find("[data-2bind]").each(function(t,a){var i=(a=e(a)).data("twoWayBindEvent");"function"==typeof i&&i(a,n,r)})}),Object.freeze({TwineScript_TypeName:"a bound variable",TwineScript_ObjectName:"a bound variable",TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return("two way"===this.bind?"2":"")+"bind "+this.varRef.TwineScript_ToSource()},set:function(e){var t,n=this.varRef.set(e);if(t=a.containsError(n))return t},create:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"one way";return r.isPrototypeOf(e)?e.error?e.error:Object.assign(Object.create(this),{varRef:e,bind:t}):a.create("operation","I can only 'bind' a variable, not "+i(e)+".")}})}),define("datatypes/assignmentrequest",["utils/operationutils","datatypes/typedvar","datatypes/datatype","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r,a){var i=e.objectName,o=e.matches;return Object.freeze({assignmentRequest:!0,TwineScript_TypeName:"a 'to' or 'into' expression",TwineScript_ObjectName:"a 'to' or 'into' expression",TwineScript_Unstorable:!0,set:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=void 0,c=[],u=function e(s,c){var u,l=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],p=[],f=void 0;if(f=c&&r.isPrototypeOf(c)?c.get():c,u=a.containsError(f))return u;if(Array.isArray(f)&&Array.isArray(s)){for(var d=0,h=0;d<s.length&&h<f.length;){var y=s[d],m=f[h];if(t.isPrototypeOf(y)&&y.datatype.rest||n.isPrototypeOf(y)&&y.rest){for(var g=h;h<f.length&&o(y,m);)m=f[h+=1];t.isPrototypeOf(y)?y.datatype=[y.datatype]:n.isPrototypeOf(y)&&(y=n.create("array")),p=p.concat(e(y,r.isPrototypeOf(c)?r.create(c,{first:g+1,last:h+1}):f.slice(g,h)))}else p=p.concat(e(y,r.isPrototypeOf(c)?r.create(c,h+1):m)),h+=1;d+=1}return d<s.length?l&&a.create("operation","I can't unpack this array because it needs "+(s.length-d)+" more value"+(s.length-d>0?"s":"")+"."):p}if(s instanceof Map&&f instanceof Map){var v=!0,b=!1,w=void 0;try{for(var T,S=s.entries()[Symbol.iterator]();!(v=(T=S.next()).done);v=!0){var x=_slicedToArray(T.value,2),k=x[0],O=x[1];if(!f.has(k))return l&&a.create("operation","I can't unpack this datamap because it needs a '"+k+"' data name.");p=p.concat(e(O,r.isPrototypeOf(c)?r.create(c,k):f.get(k)))}}catch(e){b=!0,w=e}finally{try{!v&&S.return&&S.return()}finally{if(b)throw w}}return p}if(t.isPrototypeOf(s)){if("function"==typeof s.datatype.destructure)return[{dest:s,value:f,src:c}].concat(s.datatype.destructure(f));if(!o(f,s.datatype))return[l&&a.create("operation","I can't unpack "+i(f)+" into "+s.varRef.TwineScript_ToSource()+" because it doesn't match "+i(s.datatype)+".")];p=p.concat(e(s.datatype,f))}return r.isPrototypeOf(s)||t.isPrototypeOf(s)?p.concat({dest:s,value:f,src:c}):"function"==typeof s.destructure?p.concat(s.destructure(f)):o(f,s)?p:l&&a.create("operation","I tried to unpack, but "+i(s)+" in the pattern didn't match "+i(f)+".")}(this.dest,this.src);if(s=a.containsError(u))return s;if(!u.length)return a.create("operation","I can't store a new value inside "+i(this.dest)+" that isn't in a variable.","You need a variable, or a data structure containing variables at certain positions, to store the value.");var l=!0,p=!1,f=void 0;try{for(var d,h=u.reverse()[Symbol.iterator]();!(l=(d=h.next()).done);l=!0){var y=d.value,m=y.dest,g=y.value,v=y.src;if(t.isPrototypeOf(m)){if(s=a.containsError(m.defineType()))return s;m=m.varRef}if(s=m.set(g),a.isPrototypeOf(s))return s;e&&v&&v.delete(),c.shift(i(m)+" is now "+i(g))}}catch(e){p=!0,f=e}finally{try{!l&&h.return&&h.return()}finally{if(p)throw f}}return c.join("; ")},create:function(e,t,n){return Object.assign(Object.create(this),{dest:e,src:t,operator:n})}})}),define("twinescript/operations",["jquery","state","datatypes/assignmentrequest","utils/operationutils","internaltypes/varref","datatypes/typedvar","datatypes/datatype","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s){var c=r.isObject,u=r.collectionType,l=r.is,p=r.isA,f=r.clone,d=r.unique,h=r.contains,y=r.matches,m=r.objectName,g=void 0,v=0;function b(e,t,n,r){return n=n||"do this to",function(a,i){1===t.length&&(i=a);var o;return(o=s.containsError(a,i))?o:(void 0===a?"undefined":_typeof(a))!==e||(void 0===i?"undefined":_typeof(i))!==e?s.create("operation","I can only "+n+" "+e+"s, not "+m((void 0===a?"undefined":_typeof(a))!==e?a:i)+".",r):t(a,i)}}function w(e){return function(t,n){var r;if(r=s.containsError(t,n))return r;if((void 0===t?"undefined":_typeof(t))!==(void 0===n?"undefined":_typeof(n))||c(t)&&"TwineScript_TypeName"in t&&c(n)&&"TwineScript_TypeName"in n&&t.TwineScript_TypeName!==n.TwineScript_TypeName||u(t)!==u(n)){var a=m(t)+" isn't the same type of data as "+m(n);return s.create("operation",a[0].toUpperCase()+a.slice(1))}return e(t,n)}}function T(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function r(a,i){var o=void 0;if(o=s.containsError(a,i))return o;v=a;var c=a.determiner?[a,i]:i.determiner?[i,a]:[],u=_slicedToArray(c,2),l=u[0],p=u[1];if(l){var f=l.determiner;if("start"===f||"end"===f){if(t)return s.create("operation","I can't use '"+t+"' with the 'start' or 'end' of "+m(l)+".");if(p.determiner){if("start"===p.determiner||"end"===p.determiner)return s.create("operation","I can't compare one value's 'start' or 'end' with another value's 'start' or 'end'.","Please change one of them to use an exact range, such as '1stto4th' or '2ndlasttolast'.");var d=[p,l];l=d[0],p=d[1]}for(var h=l.string||l.array,y=0;y<h.length+1;y+=1){var g=y?"end"===f?h.slice(-y):h.slice(0,y):h.constructor(),b=l===a?r(g,i):r(a,g);if(o=s.containsError(b))return o;if(b!==n)return b}return n}var w="all"===f;return l.array.reduce(function(e,t){var n,o=l===a?r(t,i):r(a,t);return(n=s.containsError(e,o))?n:w?e&&o:e||o},w)}return e(a,i)}}function S(e,t){return T(function(t,n){var r=e(t,n);return s.containsError(r)?r:!r},t,!0)}var x="If one of these values is a number, you may want to write a check that it 'is not 0'. Also, if one is a string, you may want to write a check that it 'is not \"\" '.";return g={create:function(n){var r=Object.create(this);return r.Identifiers={TwineScript_Identifiers:!0,get it(){return v},get time(){return n.stackTop&&n.stackTop.evaluateOnly?s.create("operation","'time' can't be used in "+n.stackTop.evaluateOnly+"."):Date.now()-n.timestamp},get visits(){var e=n.stackTop.speculativePassage,r=function(n){return n===(e||t.passage)};return t.pastPassageNames().filter(r).length+t.mockVisits.filter(r).length+(!e||e===t.passage)},get visit(){return r.Identifiers.visits},get exits(){return n.stackTop&&n.stackTop.evaluateOnly?s.create("operation","'exit' and 'exits' can't be used in "+n.stackTop.evaluateOnly+"."):n.dom.find("tw-enchantment, tw-link").filter(function(t,n){return e(n).data("enchantmentEvent")||e(n).parent().data("linkPassageName")||e(n).parent().data("clickEvent")}).length},get exit(){return r.Identifiers.exits},get pos(){return n.stackTop&&!n.stackTop.evaluateOnly&&n.stackTop.lambdaPos?+n.stackTop.lambdaPos||1:s.create("operation","'pos' can only be used in lambdas that aren't 'when' lambdas.")}},r},elidedComparisonOperator:function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return r.reduce(function(n,r){return"boolean"==typeof r?r:g[e](n,g[t](v,r))},"and"===e)},and:b("boolean",w(function(e,t){return e&&t}),"use 'and' to join",x),or:b("boolean",w(function(e,t){return e||t}),"use 'or' to join",x),not:b("boolean",function(e){return!e},"use 'not' to invert",x),"+":w(function(e,t){if(Array.isArray(e))return[].concat(_toConsumableArray(e),_toConsumableArray(t));var n=void 0;return e instanceof Map?(n=new Map(e),t.forEach(function(e,t){return n.set(t,e)}),n):e instanceof Set?new Set([].concat(_toConsumableArray(e),_toConsumableArray(t)).filter(d).map(f)):"function"==typeof e["TwineScript_+"]?e["TwineScript_+"](t):"string|number|boolean".includes(void 0===e?"undefined":_typeof(e))?e+t:s.create("operation","I can't use + on "+m(e)+".")}),"-":w(function(e,t){if(Array.isArray(e))return e.filter(function(e){return!t.some(function(t){return l(e,t)})});if(e instanceof Set){var n=[].concat(_toConsumableArray(t));return new Set([].concat(_toConsumableArray(e)).filter(function(e){return!n.some(function(t){return l(e,t)})}))}return"string"==typeof e?e.split(t).join(""):"number"==typeof e?e-t:s.create("operation","I can't use - on "+m(e)+".")}),"*":b("number",w(function(e,t){return e*t}),"multiply"),"/":b("number",w(function(e,t){return 0===t?s.create("operation","I can't divide "+m(e)+" by zero."):e/t}),"divide"),"%":b("number",w(function(e,t){return 0===t?s.create("operation","I can't modulo "+m(e)+" by zero."):e%t}),"modulus"),"<":T(b("number",w(function(e,t){return e<t}),"do < to"),"<"),">":T(b("number",w(function(e,t){return e>t}),"do > to"),">"),"<=":T(b("number",w(function(e,t){return e<=t}),"do <= to"),"<="),">=":T(b("number",w(function(e,t){return e>=t}),"do >= to"),">="),is:T(l),isNot:S(l),contains:T(h,"contains"),doesNotContain:S(h,"does not contain"),isIn:T(function(e,t){return h(t,e)},"is in"),isNotIn:S(function(e,t){return h(t,e)},"is not in"),isA:T(p,"is a"),isNotA:S(p,"is not a"),typifies:T(function(e,t){return p(t,e)}),untypifies:S(function(e,t){return p(t,e)}),matches:T(y),doesNotMatch:S(y),where:function(e,t,n){var r;return(r=s.containsError(e))?r:"boolean"!=typeof e?s.create("operation","This lambda's 'where' clause must evaluate to true or false, not "+m(e)+"."):e?t:n},makeSpreader:function(e){if(i.isPrototypeOf(e)||o.isPrototypeOf(e)){var t=f(e);return(i.isPrototypeOf(e)?t.datatype:t).rest=!0,t}return{value:e,spreader:!0,TwineScript_TypeName:"a spreaded '...' value",TwineScript_ObjectName:"a spreaded '...' value",TwineScript_Unstorable:!0}},makeAssignmentRequest:function(e,t,r){var a=s.containsError(e,t);return a||n.create(e,t,r)},setIt:function(e){return a.isPrototypeOf(e)||i.isPrototypeOf(e)?(v=e.get(),e):e},initialiseIt:function(e){v=e}},Object.freeze(g)}),define("twinescript/environ",["macros","state","utils","datatypes/colour","datatypes/hookset","datatypes/lambda","datatypes/datatype","datatypes/varbind","datatypes/codehook","datatypes/typedvar","internaltypes/varref","internaltypes/twineerror","twinescript/operations"],function(Macros,State,Utils,Colour,HookSet,Lambda,Datatype,VarBind,CodeHook,TypedVar,VarRef,TwineError,OperationsProto){return function(section){"object"===(void 0===section?"undefined":_typeof(section))&&section||Utils.impossible("TwineScript.environ","no Section argument was given!");var Operations=OperationsProto.create(section);return section.eval=function(){try{return eval(arguments[0])}catch(e){return e}},section}}),define("section",["jquery","utils","renderer","twinescript/environ","twinescript/operations","state","utils/operationutils","utils/renderutils","datatypes/changercommand","datatypes/hookset","datatypes/colour","datatypes/lambda","internaltypes/changedescriptor","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(e,t,n,r,a,i,o,s,c,u,l,p,f,d,h,y){var m,g=o.printBuiltinValue,v=o.objectName,b=o.typeID,w=s.collapse;function T(e,n,r){if(n&&"object"===(void 0===n?"undefined":_typeof(n))&&c.isPrototypeOf(n)){if(r.data("originalSource",r.popAttr("source")),!this.renderInto(r.data("originalSource"),r,n)){var a=t.insensitiveName(e.attr("name"));if(["if","elseif","unless","else","testfalse"].includes(a)&&(e.addClass("false"),"elseif"!==a&&(this.stackTop.lastHookShown=!1)),r.data("live")){var i=r.data("live"),o=i.delay,s=i.event;(function(e,n){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;i&&t.assertMustHave(i,["when"]);var o=n.data("originalSource")||"",s=_slicedToArray(this.stack,1)[0].tempVariables,c=this.whenUnblocked.bind(this,function(){if(r.inDOM()){var t=i&&i.filter(r,[!0],s);h.containsError(t)?t.render(e.attr("title")).replaceAll(e):!i||t[0]?(r.renderInto(o,n,{append:"replace"}),t||n.find("tw-expression[name='stop']").length||r.inDOM()&&setTimeout(c,a)):setTimeout(c,a)}});setTimeout(c,a)}).call(this,e,r,o,s)}return}}else{if(!1===n)return r.attr("source")&&(r.data("originalSource",r.popAttr("source")),r.data("hidden",!0)),e.addClass("false"),void(this.stackTop.lastHookShown=!1);!0!==n&&e.replaceWith(h.create("datatype",v(n)+" cannot be attached to this hook.","Only Booleans and changers can be attached to hooks.").render(e.attr("title")))}this.stackTop.lastHookShown=!0}function S(t){var n=(t instanceof e?t[0]:t).nextSibling;if(n&&(n instanceof Text&&!n.textContent.trim()||["br","tw-consecutive-br"].includes((n.tagName||"").toLowerCase()))){var r=S(n),a=r.whitespace,i=r.nextElem;return{whitespace:e(n).add(a),nextElem:i}}return{whitespace:e(),nextElem:e(n)}}var x={add:[],remove:[]};return m={create:function(e){var n=Object.assign(Object.create(this),{timestamp:Date.now(),dom:e||t.storyElement,stack:[],enchantments:[],unblockCallbacks:[]});return n=r(n)},get stackTop(){return this.stack[0]},inDOM:function(){return e(t.storyElement).find(this.dom).length>0},evaluateTwineMarkup:function(t,n){var r=e("<p>");this.stack.unshift({desc:f.create({target:r,source:t,section:this,append:"append"}),tempVariables:this.stackTop.tempVariables,evaluateOnly:n,finalIter:!0}),this.execute();var a;return(a=r.find("tw-error")).length>0?a:r},speculate:function(e,t,n){this.stack.unshift({evaluateOnly:n,finalIter:!0,tempVariables:Object.assign(Object.create(d),{TwineScript_VariableStoreName:n}),speculativePassage:t});var r=void 0;return r=p.isPrototypeOf(e)?e.apply(this,{fail:!1,pass:!0}):this.eval(e),this.stack.shift(),r},renderInto:function(t,n,r){var a=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=f.create({target:n,source:t,section:this,append:"append"});if(r)if(c.isPrototypeOf(r)){var s=r.run(o);if(h.containsError(s))return s.render(n.attr("title")).replaceAll(n),!1}else Object.assign(o,r);if((n=o.target,this.stack.length>=50)&&this.stack.reduce(function(e,t){return e+!!t.finalIter},0)>=50)return h.create("infinite","Printing this expression may have trapped me in an infinite loop.").render(n.attr("title")).replaceAll(n),!1;var u=function(t,r,i){var o=n instanceof e&&n.is("tw-hook")&&n.parents("tw-collapsed,[collapsing=true]").length>0;a.stack.unshift({desc:t,finalIter:i,tempVariables:r,collapses:o,evaluateOnly:a.stackTop&&a.stackTop.evaluateOnly})};if(i||(i=Object.create(this.stack.length?this.stackTop.tempVariables:d)),!i.hasOwnProperty("TwineScript_VariableStoreName")){var l=n&&n.tag();i.TwineScript_VariableStoreName="tw-hook"===l?n.attr("name")?"?"+n.attr("name"):"an unnamed hook":"tw-expression"===l?"a "+n.attr("type")+" expression":"tw-passage"===l?"this passage":"an unknown scope"}return Object.keys(o.loopVars).length?function(){var e=Object.assign({},o.loopVars),t=Math.min.apply(Math,_toConsumableArray(Object.keys(e).map(function(t){return e[t].length})));if(y.create(t+" loop"+(1!==t?"s":"")).render().prependTo(n),t){for(var r=function(n){u(o,Object.keys(e).reduce(function(t,r){return t[r]=e[r][n],t},Object.create(i),n===t-1))},s=t-1;s>=0;s-=1)r(s);for(s=t-1;s>=0&&!a.stackTop.blocked;s-=1)a.execute()}}():(u(o,i,!0),this.execute()),0===this.stack.length&&this.updateEnchantments(),o.enabled},execute:function(){var n=this,r=this.stackTop,i=r.desc,o=r.dom,s=r.collapses,u=r.evaluateOnly;i&&!o&&(o=i.render(),this.stackTop.dom=o,this.stackTop.desc=void 0),o.findAndFilter("tw-hook,tw-expression").each(function(r,i){if(n.stackTop.blocked)return!1;switch((i=e(i)).tag()){case"tw-hook":var o=i.popAttr("source")||"";if(o&&i.data("originalSource",o),i.data("tempVariables",n.stackTop.tempVariables),i.popAttr("hidden")){i.data("hidden",!0);break}o&&n.renderInto(o,i);break;case"tw-expression":if(i.attr("blockers")){if(u)return void i.removeAttr("blockers").removeAttr("js").replaceWith(h.create("syntax","I can't use a macro like (prompt:) or (confirm:) in "+u+".","Please rewrite this without putting such macros here.").render(i.attr("title"),i));var s=[];try{s=JSON.parse(i.popAttr("blockers")),i.data("blockers",s)}catch(e){t.impossible("Section.execute","JSON.parse blockers failed.")}}if(i.data("blockers")){var p=i.data("blockers");if(p.length){n.stackTop.blocked=!0;var d=n.eval(p.shift());return h.containsError(d)&&(n.stackTop.blocked=!1,i.removeData("blockers").replaceWith(d.render(i.attr("title"),i))),!1}i.removeData("blockers")}i.attr("js")&&function(n){var r=this.eval(n.popAttr("js")||"");this.stackTop.evaluateOnly&&r&&(c.isPrototypeOf(r)||"function"==typeof r.TwineScript_Run)&&(r=h.create("syntax","I can't work out what "+this.stackTop.evaluateOnly+" should evaluate to, because it contains a "+(c.isPrototypeOf(r)?"changer.":"command."),"Please rewrite this without putting changers or commands here."));var i=void 0,o=void 0,s=e();for(o=n;c.isPrototypeOf(r);){var u=S(o);if(i=u.whitespace,(o=u.nextElem)[0]instanceof Text&&"+"===o[0].textContent.trim()){var p,d=o,m=S(d);if(p=m.whitespace,(o=m.nextElem).is("tw-expression")){var w=this.eval(o.popAttr("js"));if(h.containsError(w)){r=w;break}var x=a["+"](r,w);e(i).add(d).add(p).remove(),r=h.containsError(x)?h.create("operation","I can't combine "+v(r)+" with "+v(w)+".","function"==typeof w.TwineScript_Run?"If you want to attach this changer to "+v(w)+", remove the + between them.":"Changers can only be added to other changers."):x;continue}}if(o.is("tw-expression")){var k=this.eval(o.popAttr("js"));if(h.containsError(k)){r=k;break}if(k&&"object"===(void 0===k?"undefined":_typeof(k))&&"function"==typeof k.TwineScript_Attach){r=k.TwineScript_Attach(this,r);break}return c.isPrototypeOf(k)?void n.replaceWith(h.create("operation","Changers like ("+r.macroName+":) need to be combined using + between them.","Place the + between the changer macros, or the variables holding them. The + is absent only between a changer and its attached hook or command.").render(n.attr("title"))):void n.replaceWith(h.create("operation",v(k)+" can't have changers like ("+r.macroName+":) attached.","Changers placed just before hooks, links and commands will attempt to attach, but in this case it didn't work.").render(n.attr("title")))}if(o.is("tw-hook")){i.remove(),s=o;break}r.macroName||t.impossible("Section.runExpression","changer has no macroName");var O=n.attr("title")||"("+r.macroName+": ...)";return void n.replaceWith(h.create("syntax","The ("+r.macroName+":) changer should be stored in a variable or attached to a hook.","Macros like this should appear before a hook: "+O+"[Some text]").render(n.attr("title")))}n.attr("return",b(r)),s=s.length?s:S(n).nextElem.filter("tw-hook");var j=void 0;if(j=h.containsError(r))j instanceof Error&&(j=h.fromError(j)),n.replaceWith(j.render(n.attr("title"),n));else if(y.isPrototypeOf(r))n.append(r.render());else if(r&&"function"==typeof r.TwineScript_Run)if(r=r.TwineScript_Run(this),h.containsError(r))n.replaceWith(r.render(n.attr("title")));else if(f.isPrototypeOf(r)){if(r.data&&r.data.live)return void n.replaceWith(h.create("unimplemented","I currently can't attach (live:) or (event:) macros to commands - only hooks.").render(n.attr("title")));r.section=this,r.target=o,this.renderInto("",o,r)}else{if("blocked"===r)return this.stackTop.blocked=!0,void n.attr("js","section.blockedValue()");r&&t.impossible("Section.runExpression","TwineScript_Run() returned a non-ChangeDescriptor "+(void 0===r?"undefined":_typeof(r))+': "'+r+'"')}else!s.length&&("string"==typeof r||"number"==typeof r||r instanceof Map||r instanceof Set||Array.isArray(r)||l.isPrototypeOf(r))||r&&"function"==typeof r.TwineScript_Print&&!c.isPrototypeOf(r)?(r=g(r),h.containsError(r)?(r instanceof Error&&(r=h.fromError(r)),n.replaceWith(r.render(n.attr("title")))):"string"!=typeof r?t.impossible("printBuiltinValue() produced a non-string "+(void 0===r?"undefined":_typeof(r))):this.renderInto(r,n)):s.length?T.call(this,n,r,s):c.isPrototypeOf(r)||"boolean"==typeof r||t.impossible("Section.runExpression","The expression evaluated to an unknown value: "+r)}.call(n,i)}}),this.stackTop.blocked||(o.length&&s&&w(o),o.findAndFilter("tw-collapsed,[collapsing=true]").each(function(){w(e(this))}),this.stack.shift())},updateEnchantments:function(){this.enchantments.forEach(function(e){e.disenchant(),e.enchantScope()})},on:function(e,t){return x[e].push(t),this},addEnchantment:function(e){var t=this;this.enchantments.push(e),x.add.forEach(function(n){return n(t,e)})},removeEnchantment:function(e){var t=this,n=this.enchantments.indexOf(e);this.enchantments.splice(n,1),e.disenchant(),x.remove.forEach(function(n){return n(t,e)})},unblock:function(e){for(this.stack.length||t.impossible("Section.unblock","stack is empty"),this.stackTop.blocked=!1,void 0!==e&&(this.stackTop.blockedValues=(this.stackTop.blockedValues||[]).concat(e));this.stack.length&&!this.stackTop.blocked;)this.execute();if(!this.stack.length)for(;this.unblockCallbacks.length>0;){if(this.unblockCallbacks.shift()(),this.stackTop&&this.stackTop.blocked)return}},whenUnblocked:function(e){this.stack.length&&this.stackTop.blocked?this.unblockCallbacks=this.unblockCallbacks.concat(e):e()},blockedValue:function(){var e=this.stackTop;return e||t.impossible("Section.blockedValue","stack is empty"),e.blockedValues&&e.blockedValues.length||t.impossible("Section.blockedValue","blockedValues is missing or empty"),e.blockedValues.shift()}},Object.preventExtensions(m)}),define("engine",["jquery","utils","state","section","passages"],function(e,t,n,r,a){var i,o=t.escape,s=t.impossible,c=t.passageSelector,u=t.transitionOut,l=Object.create(null);function p(e,t){return"<tw-include type="+e+" title='"+o(t.get("name"))+"'>"+t.get("source")+"</tw-include>"}function f(i){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.assertOnlyHas(o,["stretch","transition"]);var f=a.get(i),d=t.storyElement,h=d.parent(),y=o.stretch,m=o.transition,g=(m=void 0===m?{}:m).depart,v=void 0===g?"instant":g,b=m.arrive,w=void 0===b?"dissolve":b,T=m.departOrigin,S=m.arriveOrigin,x=m.time;h.findAndFilter("tw-enchantment").each(function(t,n){var r=(n=e(n)).data("enchantedProperties");r&&d.css(r.reduce(function(e,t){return e[t]="",e},{})),n[0]===h[0]&&(h=d.unwrap().parent())}),a.hasValid(i)||s("Engine.showPassage","There's no passage with the name \""+i+'"!');var k,O,j,A,C=d.children(c).not(".transition-out, .transition-out *"),E=(f.get("tags")||[]).join(" "),_=(k=e("<tw-passage><tw-sidebar>"),O=k.children("tw-sidebar"),j=e('<tw-icon tabindex=0 alt="Undo" title="Undo">&#8630;</tw-icon>'),A=e('<tw-icon tabindex=0 alt="Redo" title="Redo">&#8631;</tw-icon>'),n.pastLength<=0&&j.css("visibility","hidden"),n.futureLength<=0&&A.css("visibility","hidden"),O.append(j,A),k);"function"==typeof T&&(T=T.call(C)),"function"==typeof S&&(S=S.call(_)),d.detach(),_.appendTo(d).attr({tags:E}),!y&&v&&(u(C,v,x,0,0,0,T),C.css("position","absolute")),d.attr({tags:E});var N=r.create(_),P=f.get("source");P=a.getTagged("header").map(p.bind(0,"header")).join("")+(l.debug?a.getTagged("debug-header").map(p.bind(0,"debug-header")).join(""):"")+P+a.getTagged("footer").map(p.bind(0,"footer")).join("")+(l.debug?a.getTagged("debug-footer").map(p.bind(0,"debug-footer")).join(""):""),n.pastLength<=0&&(l.debug&&(P=a.getTagged("debug-startup").map(p.bind(0,"debug-startup")).join("")+P),P=a.getTagged("startup").map(p.bind(0,"startup")).join("")+P),N.renderInto(P,_,{transition:w,transitionTime:x,transitionOrigin:S}),h.append(d.parents().length?d.parents().last():d),scroll(0,y?_.offset().top-.05*e(window).height():d.offset().top)}return i={goBack:function(e){n.rewind()&&f(n.passage,e)},goForward:function(e){n.fastForward()&&f(n.passage,e)},goToPassage:function(e,t){n.play(e),f(e,t)},toggleFullscreen:function(){var e=document.documentElement;document.fullscreenElement?document.exitFullscreen():document.msFullscreenElement?document.msExitFullscreen():(e.msRequestFullscreen||e.requestFullscreen).call(e)},showPassage:f,options:l},Object.freeze(i)}),define("debugmode/panel",["jquery"],function(e){return Object.freeze({create:function(t){var n=t.className,r=t.rowAdd,a=t.rowCheck,i=t.columnHead,o=t.tabName,s=t.tabUpdate,c=e("<div class='panel panel-"+n+"' hidden><table class='panel-rows'></table></div>"),u=e("<button class='tab tab-"+n+"'>0 "+o+"s</button>");return u.click(function(){u.toggleClass("enabled"),u.parent().siblings(".panel").attr("hidden",""),u.is(".enabled")&&(u.siblings(".tab:not(.tab-"+n+")").removeClass("enabled"),c.removeAttr("hidden"))}),s||(s=function(e){return u.text(e+" "+o+(1!==e?"s":""))}),Object.assign(Object.create(this),{tabName:o,tab:u,panel:c,panelRows:c.find(".panel-rows"),rowAdd:r,rowCheck:a,columnHead:i,tabUpdate:s})},update:function(t,n){var r=this.rowCheck,a=this.rowAdd,i=this.panelRows,o=this.columnHead,s=[],c=i.children();t.forEach(function(t){var n=c.filter(function(n,a){return r(t,e(a))}),o=a(t);n.length?n.replaceWith(o):i.append(o),s.push(o[0])}),c.filter(function(e,t){return!s.includes(t)}).remove(),this.tabUpdate(n),n>0&&!i.find(".panel-head").length?i.prepend(o()):0===n&&i.find(".panel-head").remove()}})}),define("debugmode/mode",["jquery","utils","state","internaltypes/varref","internaltypes/twineerror","utils/operationutils","engine","passages","section","debugmode/panel"],function(e,t,n,r,a,i,o,s,c,u){var l=t.escape,p=t.nth,f=t.storyElement,d=t.debounce,h=i.objectName,y=i.isObject,m=i.toSource;return function(t,i){var g=e(document.documentElement),v=e("<tw-debugger>\n\t\t<div class='panel panel-errors' hidden><table></table></div>\n\t\t<div class='tabs'></div>\n\t\t<label style='user-select:none'>Turns: </label><select class='turns' disabled></select><button class='show-invisibles'>Debug View</button><button class='show-dom'>DOM View</button>\n\t\t<div class='resizer'>\n\t\t</tw-debugger>"),b=v.find(".tabs"),w=v.find(".show-dom"),T=v.find(".show-invisibles"),S=v.find(".turns");v.find(".resizer").mousedown(function(e){if(1!==e.which)return!0;e.stopPropagation();var t=e.pageX,n=v.width();g.on("mousemove.debugger-resizer",function(e){var r=e.pageX;v.width((n+t-r|0)+"px")}).on("mouseup.debugger-resizer",function(){g.off(".debugger-resizer")})}),T.click(function(){g.toggleClass("debug-mode").removeClass("dom-debug-mode"),T.toggleClass("enabled"),w.removeClass("enabled")}),w.click(function(){g.toggleClass("dom-debug-mode").removeClass("debug-mode"),w.toggleClass("enabled"),T.removeClass("enabled")}),n.timelinePassageNames().forEach(function(e,t){S.append("<option value="+t+">"+(t+1)+": "+e+"</option>")}),S.val(n.pastLength),n.pastLength>0&&S.removeAttr("disabled"),S.change(function(e){var t=e.target.value-n.pastLength;0!==t&&(n[t<0?"rewind":"fastForward"](Math.abs(t)),o.showPassage(n.passage))}),n.on("forward",function(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=n.pastLength;a>=1&&S.removeAttr("disabled"),r?(S.find("[selected]").removeAttr("selected"),S.val(a)):(S.children().each(function(t,n){t>=a&&e(n).remove()}),S.append("<option value="+a+">"+(a+1)+": "+t+"</option>").val(a))}).on("back",function(){n.pastLength<=1&&S.attr("disabled"),S.find("[selected]").removeAttr("selected"),S.val(n.pastLength)}).on("load",function(e){S.empty(),S[e.length<=1?"attr":"removeAttr"]("disabled"),e.forEach(function(e,t){return S.append("<option value="+t+">"+(t+1)+": "+e.passage+"</option>")})});var x=new Set,k=u.create({className:"variables",tabName:"Variable",rowAdd:function(t){var n=t.name,r=t.dataset,a=t.path,i=t.value,o=t.tempScope,s=t.type,c=y(i)&&i.TwineScript_DebugName?i.TwineScript_DebugName():l(h(i)),u="";a.length&&(u=a.reduce(function(e,t){return e+t+"'s "},"")),r&&(n="???");var p=s?m(s):"",f=c.length>48&&!i.TwineScript_DebugName,d="object"===(void 0===i?"undefined":_typeof(i))||f,g=f?c.slice(0,48)+"\u2026":c;return e('<div class="variable-row">').attr("data-name",n).attr("data-path",a+"").attr("data-scope",o||"").css("padding-left",Math.min(5,a.length)+"em").append("<td class='variable-type'>"+(p?p+"-type ":"")+"</td>","<td class='variable-name'>"+(u?"<span class='variable-path'>"+(o?"_":"$")+l(u)+"</span> ":"")+(u?"":o?"_":"$")+l(n+"")+"</td>","<td class='temporary-variable-scope'>"+(o||"")+"</td>","<td class='variable-value'>"+g+"</td><td class='panel-row-buttons'>"+(d?"<tw-folddown tabindex=0>(source:) </tw-folddown>":"")+"</td>").add(d?"<tr class='variable-row panel-row-source' style='display:none'><td colspan='5'>"+l(m(i))+"</td></tr>":"")},rowCheck:function(e,t){var n=e.name,r=e.path;e.tempScope;return t.attr("data-name")===n&&t.attr("data-path")===r+""},columnHead:function(){return'<tr class="panel-head"><th>Type</th><th>Name</th><th>Scope</th><th>Value</th></tr>'}}),O=d(function(){var e=[],t=n.variables,r=e.length;function a(t){if(!(e.length>500)){e.push(t);var n=t.path.concat(t.name),r=t.value,i=t.tempScope;Array.isArray(r)?r.forEach(function(e,t){return a({name:p(t+1),path:n,value:e,tempScope:i})}):r instanceof Map?[].concat(_toConsumableArray(r)).forEach(function(e){var t=_slicedToArray(e,2),r=t[0],o=t[1];return a({name:r,path:n,value:o,tempScope:i})}):r instanceof Set&&[].concat(_toConsumableArray(r)).forEach(function(e,t){return a({name:t,dataset:!0,path:n,value:e,tempScope:i})})}}for(var i in t)i.startsWith("TwineScript")||(r+=1,a({name:i,path:[],value:t[i],tempScope:"",type:t.TwineScript_TypeDefs&&t.TwineScript_TypeDefs[i]}));e.push.apply(e,_toConsumableArray(x)),r+=x.size,k.update(e,r),k.panel[(r?"remove":"add")+"Class"]("panel-variables-empty")}),j=void 0;r.on("set",function(e,t,r){if(e!==n.variables&&e.TwineScript_VariableStoreName&&!e.TwineScript_VariableStoreName.match(/#\d+$/)){var a=e.TwineScript_VariableStoreName,i=e.TwineScript_TypeDefs&&e.TwineScript_TypeDefs[t],o=[].concat(_toConsumableArray(x)).find(function(e){return e.name===t&&e.tempScope===a});o?o.value=r:x.add({name:t,path:[],value:r,tempScope:a,type:i})}O(),j()}).on("delete",function(){O(),j()}),k.panel.append("<div class='panel-variables-bottom'>\n\t\t\t<button class='panel-variables-copy'>Copy $ variables as (set:) call</button>\n\t\t\t<input class='clipboard' type=\"text\" style='opacity:0;pointer-events:none;position:absolute;'></input>\n\t\t</div>").removeAttr("hidden"),k.tab.addClass("enabled");var A=k.panel.find(".clipboard");g.on("click",".panel-variables-copy",function(){var e=[];for(var t in n.variables)t.startsWith("TwineScript")||e.push("$"+t+" to "+m(n.variables[t]));A.val("(set:"+e+")")[0].select(),document.execCommand("copy")});var C=u.create({className:"enchantments",tabName:"Enchantment",rowAdd:function(t){var n=t.scope,r=t.changer,a=t.name,i=t.localHook,o=void 0;return o=r?l(h(r)):"<em>enchanted via ("+a+":)</em>",e('<div class="enchantment-row">').data("enchantment",t).append("<td><span class='enchantment-name'>"+m(n)+(i?"</span><span class=enchantment-local>"+("function"==typeof i.TwineScript_ToSource?i.TwineScript_ToSource():i.attr("name")?"?"+i.attr("name"):"an unnamed hook"):"")+"</span></td><td class='enchantment-value'>"+o+"</td>"+(r?"<td class='panel-row-buttons'><tw-folddown tabindex=0>(source:)</tw-folddown></td>":"")).add(r?"<tr class='panel-row-source' style='display:none'><td colspan='3'>"+l(m(r))+"</td></tr>":"")},rowCheck:function(e,t){return t.data("enchantment")===e},columnHead:function(){return'<tr class="panel-head"><th>Scope</th><th>Value</th></div>'}}),E=d(function(e){C.update(e.enchantments,e.enchantments.length)});c.on("add",E).on("remove",E);var _=c.create(f),N=u.create({className:"storylets",tabName:"Storylet",rowAdd:function(t){var n=t.name,r=t.active,a=t.storyletSource,i=t.exclusive,o=t.urgent;return e('<tr class="storylet-row '+(r?"":"storylet-closed")+'">').attr("data-name",n).append("<td class='storylet-name'>"+n+"</td><td class='storylet-lambda'>"+a+"</td><td class='storylet-exclusive'>"+i+"</td><td class='storylet-urgent'>"+o+"</td>")},rowCheck:function(e,t){var n=e.name;return t.attr("data-name")===l(n+"")},columnHead:function(){return"<tr class=\"panel-head\"><th>Name</th><th>Condition</th><th class='storylet-exclusive'>Exclusivity</th><th class='storylet-urgent'>Urgency</th></tr>"}});N.tab.hide(),j=d(function(){var e=s.getStorylets(_),t=a.containsError(e),n=s.allStorylets();N.update(n.map(function(n){return{name:n.get("name"),storyletSource:n.get("storylet").TwineScript_ToSource(),active:!t&&e.some(function(e){return e.get("name")===n.get("name")}),exclusive:"number"==typeof n.get("exclusivity")?n.get("exclusivity"):0,urgent:"number"==typeof n.get("urgency")?n.get("urgency"):0}}),t?0:e.length),N.panel[(t?"add":"remove")+"Class"]("storylet-error");var r=n.some(function(e){return e.get("exclusivity")&&"number"==typeof e.get("exclusivity")}),i=n.some(function(e){return e.get("urgency")&&"number"==typeof e.get("urgency")});N.panel[(r?"add":"remove")+"Class"]("panel-exclusive"),N.panel[(i?"add":"remove")+"Class"]("panel-urgent"),n.length&&N.tab.show()});var P=u.create({className:"source",tabName:"Source",rowAdd:e.noop,rowCheck:e.noop,tabUpdate:e.noop,columnHead:e.noop});P.tab.text("Source");var I=u.create({className:"errors",tabName:"Error",rowAdd:e.noop,rowCheck:e.noop,columnHead:e.noop}),M=function(t,r){if("propagated"!==t.type){I.panelRows.children().length>500&&I.panelRows.children(":first-child").remove();var a=e('<tr class="error-row"><td class="error-passage">'+n.passage+'</td><td class="error-message">'+t.message+"</td></tr>");a.find(".error-message").attr("title",r),I.panelRows.append(a),I.tabUpdate(I.panelRows.children().length)}};function D(){if(x=new Set,O(),j(),C.panelRows.empty(),C.tabUpdate(0),n.passage){var e=s.get(n.passage);e&&P.panelRows.text(e.get("source"))}}a.on("error",M),v.prepend(k.panel,C.panel,I.panel,N.panel,P.panel),b.prepend(k.tab,C.tab,I.tab,N.tab,P.tab),n.on("forward",D).on("back",D).on("load",D),t&&(M(t,i),D()),e(document.body).append(v)}}),define("macrolib/values",["macros","utils","utils/operationutils","datatypes/colour","datatypes/gradient","datatypes/datatype","datatypes/hookset","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s){var c=t.realWhitespace,u=t.nth,l=t.anyRealLetter,p=n.subset,f=n.objectName,d=n.clone,h=n.toSource,y=e.TypeSignature,m=y.rest,g=y.zeroOrMore,v=y.either,b=y.optional,w=y.insensitiveSet,T=y.numberRange,S=y.percent,x=y.nonNegativeInteger,k=y.positiveInteger,O=y.Any,j=Math.max,A=Math.min,C=Math.round,E=Math.floor,_=Math.ceil;function N(e){return function(){var t=e.apply(void 0,arguments);return"number"!=typeof t||isNaN(t)?s.create("macrocall","This mathematical expression doesn't compute!"):t}}e.add(["str","string","text"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.join("")},[g(e.TypeSignature.either(String,Number,Boolean,Array))])("source",function(e,t){return t&&"command"===t.TwineScript_TypeID&&!t.TwineScript_ToSource?s.create("datatype","I can't construct the source code of a command created by a custom macro."):h(t)},[O])("substring",function(e,t,n,r){return p(t,n,r)},[String,parseInt,parseInt])("lowercase",function(e,t){return t.toLowerCase()},[String])("uppercase",function(e,t){return t.toUpperCase()},[String])("lowerfirst",function(e,t){return t.replace(RegExp(l+"+"),function(e){return(e=Array.from(e))[0].toLowerCase()+e.slice(1).join("").toLowerCase()})},[String])("upperfirst",function(e,t){return t.replace(RegExp(l+"+"),function(e){return(e=Array.from(e))[0].toUpperCase()+e.slice(1).join("").toLowerCase()})},[String])("words",function(e,t){return t.split(RegExp(c+"+")).filter(Boolean)},[String])(["str-repeated","string-repeated"],function(e,t,n){return 0===n.length?s.create("macrocall","I can't repeat an empty string."):n.repeat(t)},[x,String])(["str-reversed","string-reversed"],function(e,t){return[].concat(_toConsumableArray(t)).reverse().join("")},[String])("joined",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return r.join(t)},[m(String)])("plural",function(e,t,n,r){return n&&""!==r?t+" "+(1!==Math.abs(t)?r||n+"s":n):s.create("macrocall","The (plural:) macro can't be given empty strings.")},[parseInt,String,b(String)])(["str-nth","string-nth"],function(e,t){return u(t)},[parseInt])(["num","number"],function(e,t){return Number.isNaN(+t)?s.create("macrocall","I couldn't convert "+f(t)+" to a number."):+t},[String])("datatype",function(e,t){return i.from(t)},[O])("datapattern",function(e,t){return function e(t){var n,r=void 0;return Array.isArray(t)?r=t.map(e):t instanceof Map?(r=new Map,[].concat(_toConsumableArray(t)).forEach(function(t){var n=_slicedToArray(t,2),a=n[0],i=n[1];return r.set(a,e(i))})):r=i.from(t),(n=s.containsError(r))?n:r}(t)},[O])(["rgb","rgba"],function(e){return r.create({r:arguments.length<=1?void 0:arguments[1],g:arguments.length<=2?void 0:arguments[2],b:arguments.length<=3?void 0:arguments[3],a:arguments.length<=4?void 0:arguments[4]})},[T(0,255),T(0,255),T(0,255),b(S)])(["hsl","hsla"],function(e,t,n,a,i){return(t=C(t)%360)<0&&(t+=360),r.create({h:t,s:n,l:a,a:i})},[Number,S,S,b(S)])(["lch","lcha"],function(e,t,n,a,i){return(a=C(a)%360)<0&&(a+=360),r.create({l:t,c:n,h:a,a:i})},[S,T(0,132),Number,b(S)])("complement",function(e,t){return t.LCHRotate(180)},[r])("palette",function(e,t,n){var a=n.toLCHA(),i=a.l,o={l:i<=.75?.75+i/3:.75-3*(1-i),c:80,h:a.h,a:1},s=void 0,c=void 0,u=void 0;return s=r.create(o),o.l+=i<=.75?-.1:.1,o.l<.5&&(o.l*=.5/o.l),c=r.create(o),o.l+=i<=.85?.15:-.15,u=r.create(o),"adjacent"===t?(c=(s=s.LCHRotate(-30)).LCHRotate(30),u=s.LCHRotate(60)):"triad"===t&&(u=s.LCHRotate(180),c=s.LCHRotate(140),s=s.LCHRotate(-140)),[n,s,c,u]},[w("mono","adjacent","triad"),r])("gradient",function(e,t){for(var n=arguments.length,i=Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];if((t=C(t)%360)<0&&(t+=360),i.length<4)return s.create("datatype","(gradient:) must be given at least 2 colour-stop pairs of numbers and colours.");var c=void 0,u=[],l=i.reduce(function(e,t){if(s.containsError(e))return e;if(void 0===c)c=t;else{if("number"!=typeof c||!r.isPrototypeOf(t))return s.create("datatype","(gradient:) colour-stops should be pairs of numbers and colours, not colours and numbers.");u.push({stop:c,colour:d(t)}),c=void 0}return e},!0);return s.containsError(l)?l:void 0!==c?s.create("macrocall","This gradient has a colour-stop percent without a colour."):a.create(t,u)},[Number,m(v(S,r))])("stripes",function(e,t,n){for(var r=arguments.length,i=Array(r>3?r-3:0),o=3;o<r;o++)i[o-3]=arguments[o];(t=C(t)%360)<0&&(t+=360);var s=0,c=[];return i.forEach(function(e){c.push({stop:s,colour:d(e)}),s+=n,c.push({stop:s,colour:d(e)})}),a.create(t,c,!0)},[Number,k,r,m(r)])("hooks-named",function(e,t){return t?o.create({type:"name",data:t}):s.create("datatype","(hooks-named:) can't be given an empty string.")},[String])("cond",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=2){var n=arguments.length<=t+1?void 0:arguments[t+1];if(t===(arguments.length<=1?0:arguments.length-1)-1||s.containsError(n))return n;if("boolean"!=typeof n)return s.create("datatype","(cond:)'s "+u(t+1)+" value is "+f(n)+", but should be a boolean.");if(n)return arguments.length<=t+1+1?void 0:arguments[t+1+1]}return s.create("macrocall","An odd number of values must be given to (cond:), not "+(arguments.length<=1?0:arguments.length-1),"(cond:) must be given one or more pairs of booleans and values, as well as one final value.")},[Boolean,O,m(O)]),{weekday:[function(){return["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"][(new Date).getDay()]+"day"},null],monthday:[function(){return(new Date).getDate()},null],currenttime:[function(){var e=new Date,t=e.getHours()<12;return(e.getHours()%12||12)+":"+((e.getMinutes()<10?"0":"")+e.getMinutes())+" "+(t?"A":"P")+"M"},null],currentdate:[function(){return(new Date).toDateString()},null],min:[A,m(Number)],max:[j,m(Number)],abs:[Math.abs,Number],sign:[Math.sign,Number],sin:[Math.sin,Number],cos:[Math.cos,Number],tan:[Math.tan,Number],floor:[E,Number],round:[C,Number],trunc:[function(e){return e>0?E(e):_(e)},Number],ceil:[_,Number],pow:[N(Math.pow),[Number,Number]],exp:[Math.exp,Number],sqrt:[N(Math.sqrt),Number],log:[N(Math.log),Number],log10:[N(Math.log10),Number],log2:[N(Math.log2),Number],random:[function(e,t){var n=void 0,r=void 0;return t?(n=A(e,t),r=j(e,t)):(n=0,r=e),r+=1,~~(Math.random()*(r-n))+n},[parseInt,e.TypeSignature.optional(parseInt)]],either:[function(){var e;return e=~~(Math.random()*arguments.length),arguments.length<=e?void 0:arguments[e]},m(O)],nth:[function(e){var t;return e<=0?s.create("datatype","(nth:)'s first value should be a positive whole number, not "+e):(t=(e-1)%(arguments.length<=1?0:arguments.length-1)+1,arguments.length<=t?void 0:arguments[t])},[parseInt,m(O)]],"":function(){var t=this;Object.keys(this).forEach(function(n){if(n){var r=t[n][0],a=t[n][1];e.add(n,function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];return r.apply(void 0,n)},a)}})}}[""]()}),define("macrolib/commands",["jquery","macros","utils","state","passages","renderer","engine","internaltypes/twineerror","internaltypes/twinenotifier","datatypes/assignmentrequest","datatypes/hookset","datatypes/codehook","datatypes/lambda","datatypes/colour","datatypes/gradient","internaltypes/varref","datatypes/typedvar","datatypes/varbind","utils/operationutils","utils/renderutils"],function(e,t,n,r,a,i,o,s,c,u,l,p,f,d,h,y,m,g,v,b){var w=v.printBuiltinValue,T=v.objectName,S=v.clone,x=v.toSource,k=b.dialog,O=b.geomParse,j=b.geomStringRegExp,A=t.TypeSignature,C=A.Any,E=A.Everything,_=A.rest,N=A.either,P=A.optional,I=A.zeroOrMore,M=A.positiveInteger,D=A.positiveNumber,R=Object.assign,L=Math.floor,q=Math.ceil,F=Math.abs,V=Math.max,H=Math.min,z=e.noop;function $(e){return"("+e+" "+o.options.ifid+") "}["set","put","unpack"].forEach(function(e){return t.add(e,function(t){for(var n=0;n<(arguments.length<=1?0:arguments.length-1);n+=1){var r=arguments.length<=n+1?void 0:arguments[n+1];if("into"===r.operator&&"set"===e)return s.create("macrocall","Please say 'to' when using the (set:) macro.");if("to"===r.operator&&"set"!==e)return s.create("macrocall","Please say 'into' when using the (put:) or (unpack:) macro.");if((y.isPrototypeOf(r.dest)||m.isPrototypeOf(r.dest))===("unpack"===e))return s.create("macrocall","unpack"===e?"Please use the (unpack:) macro with arrays, datamaps or (p:) patterns containing variables to the right of 'into'.":"Please use the ("+e+":) macro with just single variables and typed variables to the "+("set"===e?"left of 'to'.":"right of 'into'."));var a=r.set();if(s.containsError(a))return a}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a ("+e+":) operation",TwineScript_ObjectName:"a ("+e+":) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return o.options.debug,""}}},[_(u)])}),t.add("move",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=1){var n=arguments.length<=t+1?void 0:arguments[t+1];if("into"!==n.operator)return s.create("macrocall","Please say 'into' when using the (move:) macro.");var r=n.set(!0);if(s.containsError(r))return r}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a (move:) operation",TwineScript_ObjectName:"a (move:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return o.options.debug,""}}},[_(u)]),t.addCommand("display",function(e){if(!a.hasValid(e))return s.create("macrocall","I can't (display:) the passage '"+e+"' because it doesn't exist.")},function(e,t,r){return R(e,{source:n.unescape(a.get(r).get("source"))})},[String])("print",z,function(e,t,n){return R(e,{source:w(n)})},[C])(["verbatim-print","v6m-print"],z,function(e,t,n){return R(e,{verbatim:!0,source:w(n)})},[C])(["verbatim-source","v6m-source"],function(e){if(e&&"command"===e.TwineScript_TypeID&&!e.TwineScript_ToSource)return s.create("datatype","I can't construct the source code of a command created by a custom macro.")},function(e,t,n){return R(e,{verbatim:!0,source:w(x(n))})},[C])("go-to",function(e){if(!a.hasValid(e))return s.create("macrocall","I can't (go-to:) the passage '"+e+"' because it doesn't exist.")},function(e,t,n){return requestAnimationFrame(function(){return o.goToPassage(n,{transition:e.data.passageT8n})}),"blocked"},[String])("undo",z,function(e){return r.pastLength<1?s.create("macrocall","I can't (undo:) on the first turn."):(requestAnimationFrame(function(){return o.goBack({transition:e.data.passageT8n})}),"blocked")},[]),n.onStartup(function(){return e(n.storyElement).on("click.icon","tw-icon",function(t){var n=e(this),a=n.data("clickEvent"),i=n.attr("alt");a&&a(n),"Undo"===i&&(t.stopPropagation(),o.goBack()),"Redo"===i&&(t.stopPropagation(),o.goForward()),"Fullscreen"===i&&(t.stopPropagation(),o.toggleFullscreen()),"Restart"===i&&(r.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload())})}),[["Undo","&#8630;",function(){return r.pastLength>0}],["Redo","&#8631;",function(){return r.futureLength>0}],["Fullscreen","&#9974;",function(){return document.fullscreenEnabled||document.msFullscreenEnabled}],["Restart","&#10226;",Object]].forEach(function(e){var n=_slicedToArray(e,3),r=n[0],a=n[1],i=n[2];t.addCommand("icon-"+r.toLowerCase(),function(e,t){if("string"==typeof e&&"string"==typeof t){var n=[].concat(_toConsumableArray(e)).length,a=[].concat(_toConsumableArray(t)).length;if(n>1&&a>1)return s.create("datatype","One of the two strings given to (icon-"+r.toLowerCase()+":) should be 1 character long, for its icon.");if(1===n&&1===a)return s.create("datatype","One of the two strings given to (icon-"+r.toLowerCase()+":) should be 2 or more characters long, for its label.")}},function(e,t,n,o){if("string"==typeof o&&1===[].concat(_toConsumableArray(o)).length||"string"==typeof n&&[].concat(_toConsumableArray(n)).length>1){var s=[o,n];n=s[0],o=s[1]}return R(e,{source:'<tw-icon tabindex=0 alt="'+r+'" '+(o?'data-label="'+o.replace('"',"&quot;")+'"':"")+' title="'+r+'" '+(i()?"":'style="visibility:hidden"')+">"+(n||a)+"</tw-icon>"})},[P(String),P(String)])}),t.addCommand("icon-counter",function(e,t,n){var r=" label string given to (icon-counter:) can't be empty or only whitespace.";return t&&t.trim()?"string"!=typeof n||n.trim()?void 0:s.create("datatype","The 2nd "+r):s.create("datatype","The 1st "+r)},function(e,t,r,a,i){e.attr.push({"data-2bind":!0}),e.data.twoWayBindEvent=function(t,n,o){if(r.varRef.matches(n,o)){var s=r.varRef.get();if("number"==typeof s)e.target.children("tw-icon").text(s>0?L(s):q(s)).attr("data-label",1!==F(s)&&void 0!==i?i:a)}};var o=r.varRef.get();return"number"!=typeof o?s.create("datatype","(icon-counter:) can only be bound to a variable holding a number, not "+T(o)+"."):R(e,{source:'<tw-icon data-label="'+n.escape(1!==F(o)&&void 0!==i?i:a)+'">'+(o>0?L(o):q(o))+"</tw-icon>"})},[g,String,P(String)]),t.addCommand("meter",function(e,t,n,r){return"string"!=typeof r||r.trim()?-1===n.search(j)||!n.includes("=")&&n.length>1?s.create("datatype",'The (meter:) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not '+JSON.stringify(n)+"."):void 0:s.create("datatype","The label string given to (meter:) can't be empty or only whitespace.")},function(e,t,n,r,a,i,o){i&&"string"!=typeof i&&(o=i,i=void 0),o||(o=d.create({h:0,s:0,l:.5,a:.5})),d.isPrototypeOf(o)&&(o=h.create(90,[{colour:o,stop:0},{colour:o,stop:1}]));var c=O(a),u=c.marginLeft,l=c.size,p=u>0&&Math.ceil(u+l)<100,f=function(e){var t=V(0,H(1,e/r)),n=o.repeating?o:o.multiply(r/e);return"height:100%;background-repeat:no-repeat;background-image:"+(p?R(n,n.repeating?{}:{angle:270}).toLinearGradientString()+", ":"")+R(n,n.repeating?{}:{angle:p||0===u?90:270}).toLinearGradientString()+";background-size:"+(p?Array(2).fill(50*t+"%"):100*t+"%")+";background-position-x:"+(p?-100/(2-t)+100+"%,"+100/(2-t)+"%":0===u?"left":"right")+";text-align:"+(p?"center":0===u?"left":"right")};e.styles.push({"margin-left":u+"%",width:l+"%",height:"1.5em",display:"block"}),e.attr.push({"data-2bind":!0});var y=i&&t.stackTop.tempVariables;e.data.twoWayBindEvent=function(t,r,a){if(n.varRef.matches(r,a)){var o=n.varRef.get();if("number"==typeof o){var s=e.target.children("tw-meter");s.attr("style",f(o)),i&&e.section.renderInto("",null,{source:i,target:s,append:"replace",transitionDeferred:!1},y)}}};var m=n.varRef.get();return"number"!=typeof m?s.create("datatype","(meter:) can only be bound to a variable holding a number, not "+T(m)+"."):R(e,{source:'<tw-meter style="'+f(m)+'">'+(i||"")+"</tw-meter>"})},[g,D,String,P(N(String,d,h)),P(N(d,h))]),[["cycling-link"],["seq-link","sequence-link"]].forEach(function(e,n){return t.addCommand(e,function(){return""===(arguments.length<=0?void 0:arguments[0])?s.create("datatype","The first string in a ("+e[0]+":) can't be empty."):arguments.length<=(g.isPrototypeOf(arguments.length<=0?void 0:arguments[0])?2:1)?s.create("datatype","I need two or more strings to "+(n?"sequence":"cycle")+" through, not just '"+(t=arguments.length-1,arguments.length<=t?void 0:arguments[t])+"'."):void 0;var t},function(e,t){for(var r=arguments.length,a=Array(r>2?r-2:0),i=2;i<r;i++)a[i-2]=arguments[i];var o=void 0;g.isPrototypeOf(a[0])&&(o=a.shift());var c=0;if(o&&"two way"===o.bind){e.attr.push({"data-2bind":!0});var u=a.indexOf(o.varRef.get());u>-1&&(c=u)}var l=t.stackTop.tempVariables;function p(t,r){var i=c>=a.length-1&&n,u=""===a[c]?"":i?a[c]:"<tw-link>"+a[c]+"</tw-link>";if(i&&(e.data.clickEvent=void 0),o&&!r){var p=o.set(a[c]);if(s.containsError(p))return void t.replaceWith(p.render(a[c]))}var f=R({},e,{source:u,transitionDeferred:!1});e.section.renderInto("",null,f,l)}a[c]&&(e.data.clickEvent=function(e){c=(c+1)%a.length,p(e,!1)})&&(e.data.twoWayBindEvent=function(e,t,n){if(o.varRef.matches(t,n)){var r=o.varRef.get(),i=a.indexOf(r);i>-1&&i!==c&&(c=i,p(e,!0))}});var f="<tw-link>"+a[c]+"</tw-link>";if(o){var d=o.set(a[c]);if(s.containsError(d))return d}return R(e,{source:f,append:"replace",transitionDeferred:!0})},[N(g,String),_(String)])}),n.onStartup(function(){return e(n.storyElement).on("change.dropdown-macro","select",function(){var t=e(this),n=t.closest("tw-expression, tw-hook").data("dropdownEvent");n&&n(t)})}),t.addCommand("dropdown",function(e){var t;return""===(arguments.length<=1?void 0:arguments[1])||""===(t=(arguments.length<=1?0:arguments.length-1)-1+1,arguments.length<=t?void 0:arguments[t])?s.create("datatype","The first or last strings in a (dropdown:) can't be empty.","Because empty strings create separators within (dropdown:)s, having them at the start or end doesn't make sense."):(arguments.length<=1?0:arguments.length-1)<=1?s.create("datatype","I need two or more strings to create a (dropdown:) menu, not just "+(arguments.length<=1?0:arguments.length-1)+"."):void 0},function(t,r,a){for(var i=arguments.length,o=Array(i>3?i-3:0),c=3;c<i;c++)o[c-3]=arguments[c];var u=0;if("two way"===a.bind){t.attr.push({"data-2bind":!0});var l=o.indexOf(a.varRef.get());l>-1&&(u=l)}var p=Math.max.apply(Math,_toConsumableArray(o.map(function(e){return[].concat(_toConsumableArray(e)).length}))),f="<select>"+o.map(function(e,t){return"<option"+(t===u?" selected":"")+(""===e?" disabled":"")+">"+n.escape(e||"\u2500".repeat(p))+"</option>"}).join("\n")+"</select>";t.data.dropdownEvent=function(e){var t=e.val(),n=a.set(t);s.containsError(n)&&e.replaceWith(n.render(t))},t.data.twoWayBindEvent=function(e,t,n){if(a.varRef.matches(t,n)){var r=a.varRef.get(),i=o.indexOf(r);i>-1&&i!==u&&(e.find("select").val(r),u=i)}},t.styles.push({"background-color":function(){return n.parentColours(e(this)).backgroundColour}});var d=a.set(o[u]);return s.containsError(d)?d:R(t,{source:f,append:"replace"})},[g,String,_(String)]),n.onStartup(function(){return e(n.storyElement).on("input.checkbox-macro","input[type=checkbox]",function(){var t=e(this),n=t.closest("tw-expression").data("checkboxEvent");n&&n(t)})});var B=1;t.addCommand("checkbox",function(){},function(e,t,n,r){var a=!1,i="checkbox-"+ ++B;if("two way"===n.bind){e.attr.push({"data-2bind":!0});var o=n.varRef.get();"boolean"==typeof o&&(a=o),e.data.twoWayBindEvent=function(e,t,r){if(n.varRef.matches(t,r)){var a=n.varRef.get();"boolean"==typeof a&&e.children("input[type=checkbox]").prop("checked",a)}}}return e.data.checkboxEvent=function(e){var t=e.is(":checked"),r=n.set(t);s.containsError(r)&&e.replaceWith(r.render(""))},R(e,{source:'<input id="'+i+'" type="checkbox" '+(a?"checked":"")+'><label for="'+i+'">'+r+"</label>",append:"replace"})},[g,String]),n.onStartup(function(){return e(document).on("fullscreenchange",function(){e("input[type=checkbox][id^=fullscreen]",n.storyElement).each(function(t,n){(e(n).closest("tw-expression").data("fullscreenEvent")||Object)(n)})})}),t.addCommand("checkbox-fullscreen",function(){},function(t,n,r){var a="fullscreenCheckbox-"+ ++B;return t.data.fullscreenEvent=function(t){return e(t).prop("checked",!(!document.fullscreenElement&&!document.msFullscreenElement))},t.data.checkboxEvent=function(){return o.toggleFullscreen()},R(t,{source:'<input id="'+a+'" type="checkbox" '+(document.fullscreenEnabled||document.msFullscreenEnabled?" ":"disabled ")+(document.fullscreenElement||document.msFullscreenElement?"checked":"")+'><label for="'+a+'">'+r+"</label>",append:"replace"})},[String]),n.onStartup(function(){return e(n.storyElement).on("input.input-box-macro","textarea",function(){var t=e(this),n=t.closest("tw-expression").data("inputBoxEvent");n&&n(t)})}),["input-box","force-input-box"].forEach(function(e){return t.addCommand(e,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var a=g.isPrototypeOf(n[0]),i="number"==typeof n[1+a],o="string"==typeof n[1+a+i],c=n[+a];if("string"!=typeof c||-1===c.search(j)||!c.includes("=")&&c.length>1)return s.create("datatype","The ("+e+':) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not '+JSON.stringify(c)+".");if("force-input-box"===e&&!o)return s.create("datatype","The ("+e+":) macro requires a string of text to forcibly input.");var u=1+a+i+o;return n.length>u?s.create("datatype","An incorrect combination of values was given to this ("+e+":) macro."):void 0},function(t,r){for(var a=arguments.length,i=Array(a>2?a-2:0),o=2;o<a;o++)i[o-2]=arguments[o];var c="force-input-box"===e,u=g.isPrototypeOf(i[0]),l="number"==typeof i[1+u],p=u&&i[0],f=l?i[1+u]:3,d=O(i[+u]),h=d.marginLeft,y=d.size,m="string"==typeof i[1+u+l]?i[1+u+l]:"",v=c?"":m;if("two way"===p.bind){t.attr.push({"data-2bind":!0});var b=p.varRef.get();if("string"==typeof b){v=c?m.slice(0,b.length):b;var w=p.set(v);if(s.containsError(w))return w}t.data.twoWayBindEvent=function(e,t,n){if(p.varRef.matches(t,n)){var r=p.varRef.get();"string"==typeof r&&e.find("textarea").val(c?m.slice(0,r.length):r)}}}else if(p){var T=p.set(c?"":m);if(s.containsError(T))return T}!c&&p&&(t.data.inputBoxEvent=function(e){var t=e.val(),n=p.set(t);s.containsError(n)&&e.replaceWith(n.render(""))});var S='<textarea style="width:100%" rows='+f+">"+n.escape(v)+"</textarea>";if(c){var x=Array.from(m);t.data.inputBoxEvent=function(e){var t=e.val().length,n=x.slice(0,t).join("");if(e.val(n),p){var r=p.set(n);s.containsError(r)&&e.replaceWith(r.render(""))}return!0}}return t.styles.push({display:"block","margin-left":h+"%",width:y+"%","border-style":function(){return this.style.borderStyle||"solid"}}),R(t,{source:S,append:"replace"})},[N(g,String),P(N(M,String)),P(N(M,String)),P(String)])}),["show","rerun"].forEach(function(n){return t.addCommand(n,z,function(t,r){for(var a=arguments.length,i=Array(a>2?a-2:0),o=2;o<a;o++)i[o-2]=arguments[o];return i.forEach(function(a){return a.forEach(r,function(a){var i=a.data("hidden");if(void 0!==i!=("rerun"===n))if(a.removeData("hidden"),i instanceof e)a.empty().append(i);else{var o=a.data("tempVariables");r.renderInto("",null,R({},t,{append:"replace",source:a.data("originalSource")||"",target:a}),o&&Object.create(o))}})}),t},[_(l)])});var W=function(e){return["I can't use a dialog macro in "+e+".","Please rewrite this without putting such macros here."]};t.addCommand("hide",z,function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];n.forEach(function(t){return t.forEach(e,function(e){Boolean(e.data("hidden"))||e.data("hidden",e.contents().detach())})})},[_(l)],!1)("stop",z,z,[],!1)("load-game",z,function(e,t){var n=localStorage.getItem($("Saved Game")+t);if(!n)return s.create("saving","I can't find a save slot named '"+t+"'!");var a=r.deserialise(e,n);if(a instanceof Error){var i=k({message:"Sorry to interrupt... The story tried to load saved data, but there was a problem.\n"+a.message+"\n\nThat data might have been saved from a different version of this story. Should I delete it?\n(Type 'delete' and choose Yes to delete it.)\n\nEither way, the story will now continue without loading the data.",defaultValue:"",buttons:[{name:"Yes",confirm:!0,callback:function(){"delete"===i.find("input").last().val()&&localStorage.removeItem($("Saved Game")+t),e.unblock("")}},{name:"No",cancel:!0,callback:function(){return e.unblock()}}]});return"blocked"}requestAnimationFrame(o.showPassage.bind(o,r.passage,!1))},[String],!1)("mock-visits",function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];if(!o.options.debug)return s.create("operation","(mock-visits:) cannot be used outside of debug mode.","This macro is not meant to be used outside of debugging your story.");var r=t.find(function(e){return!a.hasValid(e)});return r?s.create("datatype","I can't mock-visit '"+r+"' because no passage with that name exists."):void 0},function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];r.mockVisits=S(n)},[_(String)],!1)(["dialog","alert"],function(e,t){for(var r=arguments.length,a=Array(r>2?r-2:0),i=2;i<r;i++)a[i-2]=arguments[i];if(g.isPrototypeOf(e)){if("two way"===e.bind)return s.create("datatype","(dialog:) shouldn't be given two-way bound variables.");if(void 0===t)return s.create("datatype","(dialog:) needs a message string to display.")}else void 0!==t&&a.unshift(t);var o=a.findIndex(function(e){return""===e});if(o>-1)return s.create("datatype","(dialog:)'s "+n.nth(o+1)+" link text shouldn't be an empty string.")},function(e,t,n,r){for(var a=arguments.length,i=Array(a>4?a-4:0),o=4;o<a;o++)i[o-4]=arguments[o];return g.isPrototypeOf(n)||(void 0!==r&&i.unshift(r),r=n,n=void 0),i.length||(i=["OK"]),k({section:t,message:r,cd:e,buttons:i.map(function(e){return{name:e,callback:function(){t.unblock(n&&n.set(e)||"")}}})}),"blocked"},[N(g,String),I(String)])("open-url",z,function(e,t){window.open(t,"")},[String],!1)(["restart","reload"],z,function(){if(r.pastLength<1)return s.create("infinite","I mustn't (restart:) the story in the starting passage.");r.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload()},[],!1)("goto-url",z,function(e,t){window.location.assign(t)},[String],!1)("ignore",z,z,[I(E)])("assert-exists",function(e){if(""===e)return s.create("datatype","(assert-exists:) mustn't be given an empty string.")},function(e,t,n){var r=0;return("string"==typeof n?l.create({type:"string",data:n}):n).forEach(t,function(){++r}),r?e:s.create("assertion","I didn't see any "+("string"==typeof n?"text occurrences of":"hooks matching")+" "+x(n)+" in this passage.")},[N(l,String)]),t.add("assert",function(e,t){return t?{TwineScript_TypeID:"instant",TwineScript_TypeName:"an (assert:) operation",TwineScript_ObjectName:"an (assert:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}:R(s.create("assertion","An assertion failed: "),{appendTitleText:!0})},[Boolean])("save-game",function(e,t,n){if(n=n||"",!r.hasStorage)return!1;var a=r.serialise();if(s.containsError(a))return a;if(!1===a)return!1;try{return localStorage.setItem($("Saved Game")+t,a),localStorage.setItem($("Saved Game Filename")+t,n),!0}catch(e){return!1}},[String,P(String)])("prompt",function(e,t,n,r,a){if(e.stackTop&&e.stackTop.evaluateOnly)return s.create.apply(s,["macrocall"].concat(_toConsumableArray(W(e.stackTop.evaluateOnly))));if(""===a)return s.create("datatype","The text for (prompt:)'s confirm link can't be blank.");var i=k({section:e,message:t,defaultValue:n,buttons:[{name:a||"OK",confirm:!0,callback:function(){return e.unblock(i.find("input").last().val())}}].concat(""===r?[]:{name:r||"Cancel",cancel:!0,callback:function(){return e.unblock(n)}})});setTimeout(function(){return i.find("input").last().focus()},100)},[String,String,P(String),P(String)])("confirm",function(e,t,n,r){return e.stackTop&&e.stackTop.evaluateOnly?s.create.apply(s,["macrocall"].concat(_toConsumableArray(W(e.stackTop.evaluateOnly)))):""===r?s.create("datatype","The text for (confirm:)'s confirm link can't be blank."):void k({section:e,message:t,defaultValue:!1,buttons:[{name:r||"OK",confirm:!0,callback:function(){return e.unblock(!0)}}].concat(""===n?[]:{name:n||"Cancel",cancel:!0,callback:function(){return e.unblock(!1)}})})},[String,P(String),P(String)])("page-url",function(){return window.location.href},[]),i.options.blockerMacros.push("prompt","confirm")}),define("macrolib/datastructures",["jquery","utils","utils/naturalsort","macros","utils/operationutils","state","engine","passages","datatypes/lambda","datatypes/datatype","datatypes/typedvar","internaltypes/varref","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c,u,l,p,f){var d=t.shuffled,h=t.permutations,y=a.objectName,m=a.subset,g=a.collectionType,v=a.isValidDatamapName,b=a.is,w=a.unique,T=a.clone,S=a.range,x=r.TypeSignature,k=x.optional,O=x.rest,j=x.either,A=x.zeroOrMore,C=x.Any,E=x.nonNegativeInteger;r.add(["a","array"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n},A(j(l,C)))("range",function(e,t,n){return S(t,n)},[parseInt,parseInt])("subarray",function(e,t,n,r){return m(t,n,r)},[Array,parseInt,parseInt])("reversed",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reverse().map(T)},A(C))("shuffled",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return d.apply(void 0,n).map(T)},[C,O(C)])("sorted",function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];return r.sort(n("en"))},[j(Number,String),O(j(Number,String))])("rotated",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return 0===(t*=-1)?f.create("macrocall","I can't rotate these values by 0 positions."):Math.abs(t)>=r.length?f.create("macrocall","I can't rotate these "+r.length+" values by "+t+" positions."):r.slice(t).concat(r.slice(0,t)).map(T)},[parseInt,C,O(C)])("rotated-to",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i=t.filter(e,r);if(f.containsError(i))return i;if(!i.length)return f.create("macrocall","None of these "+r.length+" values matched the lambda, so I can't rotate them.");var o=r.indexOf(i[0]);return r.slice(o).concat(r.slice(0,o)).map(T)},[c.TypeSignature("where"),C,O(C)])("repeated",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];for(var i=[];t-- >0;)i.push.apply(i,r);return i.map(T)},[E,O(C)])("interlaced",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=Math.min.apply(Math,_toConsumableArray(n.map(function(e){return e.length}))),i=[],o=0;o<a;o+=1)for(var s=0;s<n.length;s+=1)i.push(T(n[s][o]));return i},[Array,O(Array)])("permutations",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.length?h.apply(void 0,n):[]},[A(C)]),r.add("altered",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return r.map(function(n,r){return t.apply(e,{loop:n,pos:r+1})})},[c.TypeSignature("via"),A(C)])("find",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return t.filter(e,r)},[c.TypeSignature("where"),A(C)])(["all-pass","pass"],function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i=t.filter(e,r);return f.containsError(i)||i.length===r.length},[c.TypeSignature("where"),A(C)])("some-pass",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i=t.filter(e,r);return f.containsError(i)||i.length>0},[c.TypeSignature("where"),A(C)])("none-pass",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i=t.filter(e,r);return f.containsError(i)||0===i.length},[c.TypeSignature("where"),A(C)])("folded",function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return"where"in t&&(r=t.filter(e,r)),f.containsError(r)||r.reduce(function(n,r,a){return t.apply(e,{making:n,loop:r,pos:a+1})})},[j(c.TypeSignature("where","via","making"),c.TypeSignature("via","making")),O(C)]),r.add("datanames",function(e,t){return Array.from(t.keys()).sort(n("en"))},[Map])("datavalues",function(e,t){return Array.from(t.entries()).sort(n("en",function(e){return String(e[0])})).map(function(e){return T(e[1])})},[Map])("dataentries",function(e,t){return Array.from(t.entries()).sort(function(e,t){return[e[0],t[0]].sort(n("en"))[0]===e[0]?-1:1}).map(function(e){return new Map([["name",e[0]],["value",T(e[1])]])})},[Map])("history",function(e,t){var n=i.mockVisits.concat(i.pastPassageNames());if(!t)return n;var r=t.filter(e,n.map(function(e){return s.get(e)}));return f.containsError(r)?r:r.map(function(e){return e.get("name")})},[k(c.TypeSignature("where"))])("passage",function(e,t){return T(s.get(t||i.passage))||f.create("macrocall","There's no passage named '"+t+"' in this story.")},[k(String)])("passages",function(e,t){var r=n("en"),a=[].concat(_toConsumableArray(s.values())).map(function(e){return T(e)}),i=t?t.filter(e,a):a,o=f.containsError(i);return o||i.sort(function(e,t){return r(e.get("name"),t.get("name"))})},[k(c.TypeSignature("where"))])("open-storylets",function(e,t){if(e.stackTop.evaluateOnly)return f.create("macrocall","(open-storylets:) can't be used in "+e.stackTop.evaluateOnly+".");var n=s.getStorylets(e,t),r=f.containsError(n);return r||n.map(T)},[k(c.TypeSignature("where"))])("savedgames",function(){function e(e){return"("+e+" "+o.options.ifid+") "}var t=0,n=void 0,r=new Map;do{if(!i.hasStorage)break;n=localStorage.key(t),t+=1;var a=e("Saved Game");n&&n.startsWith(a)&&(n=n.slice(a.length),r.set(n,localStorage.getItem(e("Saved Game Filename")+n)))}while(n);return r},[])(["datamap","dm"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=void 0,i=new Map,o=n.reduce(function(e,t){var n=void 0;if(f.containsError(e))return e;if(void 0===a)a=t;else{if(n=f.containsError(v(i,a)))return n;if(i.has(a))return f.create("macrocall","You used the same data name ("+y(a)+") twice in the same (datamap:) call.");i.set(a,T(t)),a=void 0}return e},!0);return f.containsError(o)?o:void 0!==a?f.create("macrocall","This datamap has a data name without a value."):i},A(j(l,C)))(["dataset","ds"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new Set(n.filter(w).map(T))},A(C))("count",function e(t,n){for(var r=arguments.length,a=Array(r>2?r-2:0),i=2;i<r;i++)a[i-2]=arguments[i];if(a.length>1){var o,s=a.map(function(r){return e(t,n,r)});return(o=f.containsError(s))?o:s.reduce(function(e,t){return e+t},0)}var c=a[0];switch(g(n)){case"dataset":case"datamap":return f.create("macrocall","(count:) shouldn't be given a datamap or dataset.","You should use the 'contains' operator instead. For instance, write: $variable contains 'value'.");case"string":return"string"!=typeof c?f.create("macrocall",y(n)+" can't contain  "+y(c)+" because it isn't also a string."):c?n.split(c).length-1:0;case"array":return n.reduce(function(e,t){return e+b(t,c)},0);default:return f.create("macrocall",y(n)+" can't contain values, let alone "+y(c)+".")}},[C,O(C)])}),define("macrolib/stylechangers",["jquery","macros","utils","utils/renderutils","datatypes/colour","datatypes/hookset","datatypes/gradient","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c,u,l){var p=r.geomParse,f=r.geomStringRegExp,d=Object.assign,h=t.TypeSignature,y=h.either,m=h.wrapped,g=h.optional,v=h.Any,b=h.Everything,w=h.zeroOrMore,T=h.rest,S=h.insensitiveSet,x=h.positiveNumber,k=h.positiveInteger,O=h.nonNegativeNumber,j=h.percent,A=[m(Boolean,'If you gave a number, you may instead want to check that the number is not 0. If you gave a string, you may instead want to check that the string is not "".')];n.onStartup(function(){return e(n.storyElement).on("mouseenter.hover-macro","[hover=false]",function(){var t=e(this),n=t.data("hoverChanger");t.data({mouseoutStyle:t.attr("style")||""}),u.create({target:t},n).update(),t.attr("hover",!0)}).on("mouseleave.hover-macro","[hover=true]",function(){var t=e(this),n=t.data("mouseoutStyle");t.attr("style",n).removeData("mouseoutStyle").attr("hover",!1)})});var C,E,_=S("instant","dissolve","fade","rumble","shudder","pulse","zoom","flicker","slideleft","slideright","slideup","slidedown","fadeleft","faderight","fadeup","fadedown","blur"),N=S("dotted","dashed","solid","double","groove","ridge","inset","outset","none");t.addChanger("if",function(e,t){return s.create("if",[t])},function(e,t){return e.enabled=e.enabled&&t},A)("unless",function(e,t){return s.create("unless",[t])},function(e,t){return e.enabled=e.enabled&&!t},A)("elseif",function(e,t){return"lastHookShown"in e.stack[0]?s.create("elseif",[!1===e.stack[0].lastHookShown&&!!t]):l.create("macrocall","There's no (if:) or something else before this to do (else-if:) with.")},function(e,t){return e.enabled=e.enabled&&t},A)("else",function(e){return"lastHookShown"in e.stack[0]?s.create("else",[!1===e.stack[0].lastHookShown]):l.create("macrocall","There's nothing before this to do (else:) with.")},function(e,t){return e.enabled=e.enabled&&t},null)("hidden",function(){return s.create("hidden")},function(e){return e.enabled=!1},null)(["verbatim","v6m"],function(){return s.create("verbatim")},function(e){return e.verbatim=!0},null)("live",function(e,t){return s.create("live",[t])},function(e,t){e.enabled=!1,e.data.live={delay:t}},g(Number))("event",function(e,t){return s.create("event",[t])},function(e,t){e.enabled=!1,e.data.live={event:t}},c.TypeSignature("when"))("more",function(){return s.create("more")},function(e){e.enabled=!1,e.data.live={event:{when:!0,filter:function(e){return 0!==e.eval("Operations").Identifiers.exits?[]:[!0]}}}},null)("after",function(e,t,n){return s.create("after",[t].concat(void 0!==n?[n]:[]))},function(e,t,r){e.enabled=!1,e.data.live={event:{when:!0,filter:function(e){return n.anyInputDown()&&(t-=r),e.eval("Operations").Identifiers.time>t?[!0]:[]}}}},[x,g(O)])("hook",function(e,t){return t?s.create("hook",[t]):l.create("datatype","(hook:) names can't be empty strings.")},function(e,t){return e.attr.push({name:t})},[String])(["for","loop"],function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return t.loop?s.create("for",[t].concat(r)):l.create("datatype","The lambda provided to (for:) must refer to a temp variable, not just 'it'.")},function(e,t){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var i,o=t.filter(e.section,r);if(i=l.containsError(o))return i;e.loopVars[t.loop.getName()]=o||[]},[c.TypeSignature("where"),w(v)])(["transition","t8n"],function(e,t){return s.create("transition",[n.insensitiveName(t)])},function(t,r){return t.transition=r,"zoom"===r&&(t.transitionOrigin=function(){var t=e(this).offset(),r=t.left,a=t.top;return n.mouseCoords.x-r+"px "+(n.mouseCoords.y-a)+"px"}),t},[_])(["transition-time","t8n-time"],function(e,t){return s.create("transition-time",[t])},function(e,t){return e.transitionTime=t,e.data.passageT8n=d(e.data.passageT8n||{},{time:t}),e},[x])(["transition-delay","t8n-delay"],function(e,t){return s.create("transition-delay",[t])},function(e,t){return e.transitionDelay=t,e},[O])(["transition-skip","t8n-skip"],function(e,t){return s.create("transition-skip",[t])},function(e,t){return e.transitionSkip=t,e},[x])(["transition-depart","t8n-depart"],function(e,t){return s.create("transition-depart",[n.insensitiveName(t)])},function(t,r){return t.data.passageT8n=d(t.data.passageT8n||{},{depart:r}),"zoom"===r&&(t.data.passageT8n.departOrigin=function(){var t=e(this).offset(),r=t.left,a=t.top;return n.mouseCoords.x-r+"px "+(n.mouseCoords.y-a)+"px"}),t},[_])(["transition-arrive","t8n-arrive"],function(e,t){return s.create("transition-arrive",[n.insensitiveName(t)])},function(t,r){return t.data.passageT8n=d(t.data.passageT8n||{},{arrive:r}),"zoom"===r&&(t.data.passageT8n.arriveOrigin=function(){var t=e(this),r=t.offset(),a=r.left,i=r.top,o=t.height();return{"transform-origin":100*(n.mouseCoords.x-a)/t.width()+"% "+100*(n.mouseCoords.y-i)/o+"%",height:o+"px"}}),t},[_])("button",function(){return s.create("button",[])},function(e){return e.attr.push({class:function(){return this.className+(this.classList.contains("enchantment-button")?"":" ".repeat(this.className.length>0)+"enchantment-button")}}),e},[])(["border","b4r"],function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];return s.create("border",r.map(n.insensitiveName))},function(t){for(var n=arguments.length,r=Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return t.styles.push({display:function(){var t=e(this).css("display");return r.every(function(e){return"none"===e})||!t.includes("inline")?t:"inline-block"},"border-style":r.join(" "),"border-width":function(){return this.style.borderWidth||"2px"}}),t},[N].concat(_toConsumableArray(Array(3).fill(g(N)))))(["border-size","b4r-size"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return s.create("border-size",n)},function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-width":n.map(function(e){return e+"px"}).join(" ")}),e},[O].concat(_toConsumableArray(Array(3).fill(g(O)))))("corner-radius",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return s.create("corner-radius",n)},function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-radius":n.map(function(e){return e+"px"}).join(" "),padding:function(){return this.style.padding||n.map(function(e){return e+"px"}).join(" ")}}),e},[O].concat(_toConsumableArray(Array(3).fill(g(O)))))(["border-colour","b4r-colour","border-color","b4r-color"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return s.create("border-colour",n.map(function(e){return a.isPrototypeOf(e)?e.toRGBAString(e):e}))},function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-color":n.join(" ")}),e},[y(String,a)].concat(_toConsumableArray(Array(3).fill(g(y(String,a))))))("opacity",function(e,t){return s.create("opacity",[t])},function(e,t){return e.styles.push({opacity:t})},[j])("font",function(e,t){return s.create("font",[t])},function(e,t){return e.styles.push({"font-family":t}),e},[String])("align",function(e,t){var n=void 0,r=t.indexOf("><");if(!/^(==+>|<=+|=+><=+|<==+>)$/.test(t))return l.create("datatype",'The (align:) macro requires an alignment arrow ("==>", "<==", "==><=" etc.) be provided, not "'+t+'"');if(~r){var a=Math.round(r/(t.length-2)*50);n=d({"text-align":"center","max-width":"50%"},25===a?{"margin-left":"auto","margin-right":"auto"}:{"margin-left":a+"%"})}else n="<"===t[0]&&">"===t.slice(-1)?{"text-align":"justify","max-width":"50%"}:t.includes(">")?{"text-align":"right"}:{"text-align":"left"};return n.display="inline-block",s.create("align",[n])},function(e,t){e.styles.push(t)},[String])(["text-colour","text-color","color","colour"],function(e,t){return s.create("text-colour",[t])},function(e,t){return a.isPrototypeOf(t)&&(t=t.toRGBAString(t)),e.styles.push({color:t}),e},[y(String,a)])(["text-size","size"],function(e,t){return s.create("text-size",[t])},function(e,t){return e.styles.push({"font-size":24*t+"px","line-height":36*t+"px"}),e},[O])("text-indent",function(e,t){return s.create("text-indent",[t])},function(e,t){return e.styles.push({"text-indent":t+"px",display:"inline-block"}),e},[O])(["text-rotate-z","text-rotate"],function(e,t){return s.create("text-rotate-z",[t])},function(t,n){return t.styles.push({display:"inline-block",transform:function(){var t=e(this).css("transform")||"";return"none"===t&&(t=""),t+" rotate("+n+"deg)"}}),t},[Number])("text-rotate-y",function(e,t){return s.create("text-rotate-y",[t])},function(t,n){return t.styles.push({display:"inline-block",transform:function(){var t=e(this).css("transform")||"";return"none"===t&&(t=""),t+" perspective(50vw) rotateY("+n+"deg)"}}),t},[Number])("text-rotate-x",function(e,t){return s.create("text-rotate-x",[t])},function(t,n){return t.styles.push({display:"inline-block",transform:function(){var t=e(this).css("transform")||"";return"none"===t&&(t=""),t+" perspective(50vw) rotateX("+n+"deg)"}}),t},[Number])(["background","bg"],function(e,t){return s.create("background",[t])},function(t,r){var i=void 0;return a.isPrototypeOf(r)?r=r.toRGBAString(r):o.isPrototypeOf(r)&&(r=r.toLinearGradientString(r)),i=a.isHexString(r)||a.isCSS3Function(r)?{"background-color":r}:r.startsWith("linear-gradient(")||r.startsWith("repeating-linear-gradient(")?{"background-image":r}:{"background-size":"cover","background-image":"url("+r+")"},t.styles.push(i,{display:function(){var t=e(this);return!t.children().length||n.childrenProbablyInline(t)?e(this).css("display"):"block"}}),t},[y(String,a,o)]).apply(void 0,_toConsumableArray((C={color:function(){return"transparent"}},E=d(Object.create(null),{none:{},bold:{"font-weight":"bold"},italic:{"font-style":"italic"},underline:{"text-decoration":"underline"},doubleunderline:{"text-decoration":"underline","text-decoration-style":"double"},wavyunderline:{"text-decoration":"underline","text-decoration-style":"wavy"},strike:{"text-decoration":"line-through"},doublestrike:{"text-decoration":"line-through","text-decoration-style":"double"},wavystrike:{"text-decoration":"line-through","text-decoration-style":"wavy"},superscript:{"vertical-align":"super","font-size":".83em"},subscript:{"vertical-align":"sub","font-size":".83em"},blink:{animation:"fade-in-out 1s steps(1,end) infinite alternate"},shudder:{animation:"shudder linear 0.1s 0s infinite"},mark:{"background-color":"hsla(60, 100%, 50%, 0.6)"},condense:{"letter-spacing":"-0.08em"},expand:{"letter-spacing":"0.1em"},outline:[{"text-shadow":function(){var t=e(this).css("color");return"-1px -1px 0 "+t+", 1px -1px 0 "+t+",-1px  1px 0 "+t+", 1px  1px 0 "+t}},{color:function(){return n.parentColours(e(this)).backgroundColour}}],shadow:{"text-shadow":function(){return"0.08em 0.08em 0.08em "+e(this).css("color")}},emboss:{"text-shadow":function(){return"0.04em 0.04em 0em "+e(this).css("color")}},smear:[{"text-shadow":function(){var t=e(this).css("color");return"0em   0em 0.02em "+t+",-0.2em 0em  0.5em "+t+", 0.2em 0em  0.5em "+t}},C],blur:[{"text-shadow":function(){return"0em 0em 0.08em "+e(this).css("color")}},C],blurrier:[{"text-shadow":function(){return"0em 0em 0.2em "+e(this).css("color")},"user-select":"none"},C],mirror:{display:"inline-block",transform:"scaleX(-1)"},upsidedown:{display:"inline-block",transform:"scaleY(-1)"},fadeinout:{animation:"fade-in-out 2s ease-in-out infinite alternate"},rumble:{animation:"rumble linear 0.1s 0s infinite"},sway:{animation:"sway linear 2.5s 0s infinite"},buoy:{animation:"buoy linear 2.5s 0s infinite"},fidget:{animation:function(){return"fidget step-end 60s "+60*-Math.random()+"s infinite"+(Math.random()<.5?" reverse":"")}}}),["text-style",function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];return s.create("text-style",r.map(n.insensitiveName))},function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0;a<n.length;a+=1)"none"===n[a]?e.styles=[]:e.styles=e.styles.concat(E[n[a]]);return e},[T(S.apply(void 0,_toConsumableArray(Object.keys(E))))]])))("collapse",function(){return s.create("collapse")},function(e){return e.attr.push({collapsing:!0}),e},[])("hover-style",function(e,t){var n=u.create(),r=(t.run(n),n.summary());return r+""=="styles"||r.every(function(e){return"styles"===e||"attr"===e})&&n.attr.every(function(e){return Object.keys(e)+""=="style"})?s.create("hover-style",[t]):l.create("datatype","The changer given to (hover-style:) must only change the hook's style.")},function(e,t){return e.data.hoverChanger=t,e.attr.push({hover:function(e,t){return void 0!==t&&t}}),e},[s])("css",function(e,t){return t.trim().endsWith(";")||(t+=";"),s.create("css",[t])},function(t,n){return t.attr.push({style:function(){return(e(this).attr("style")||"")+n}}),t},[String])("test-true",function(){return s.create("test-true",[])},function(e){return e.enabled=!0},w(b))("test-false",function(){return s.create("test-false",[])},function(e){return e.enabled=!1},w(b)),t.addCommand("animate",e.noop,function(e,t,r,a,i){r.forEach(t,function(t){var r=void 0;if("zoom"===name){var o=t.offset(),s=o.left,c=o.top;r=n.mouseCoords.x-s+"px "+(n.mouseCoords.y-c)+"px"}n.transitionIn(t,a,e.transitionTime||i,e.transitionDelay,e.transitionSkip,0,r)})},[T(i),S.apply(void 0,_toConsumableArray(_.innerType.filter(function(e){return"instant"!==e}))),g(x)]),["box","float-box"].forEach(function(r){return t.addChanger(r,function(e,t,n){var a=-1===t.search(f)||t.length>1&&!t.includes("="),i="float-box"===r&&(-1===n.search(f)||n.length>1&&!n.includes("="));return a||i?l.create("datatype","The ("+r+':) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not "'+(a?t:n)+'".'):s.create(r,[t,n].filter(function(e){return void 0!==e}))},function(t,a,i){var o,s=p(a),c=s.marginLeft,u=s.size,l=void 0;if("float-box"===r){var f=p(i);l=f.marginLeft,i=f.size}var h="box"===r?"%":"vw",y=(_defineProperty(o={display:"block",width:u+h,"max-width":u+h},"box"===r?"margin-left":"left",c+h),_defineProperty(o,"box-sizing","content-box"),_defineProperty(o,"overflow-y","auto"),_defineProperty(o,"padding",function(){return e(this).css("padding")||"1em"}),o);return void 0!==i&&(y.height=i+("box"===r?"em":"vh")),"float-box"===r&&d(y,{position:"fixed",top:l+"vh","background-color":function(){return n.parentColours(e(this)).backgroundColour}}),t.styles.push(y),t},[String,"box"===r?g(k):String])})}),define("internaltypes/enchantment",["jquery","utils","internaltypes/changedescriptor","datatypes/changercommand","utils/operationutils","internaltypes/twineerror","utils/renderutils"],function(e,t,n,r,a,i,o){var s=a.objectName,c=o.collapse,u={create:function(n){return t.assertOnlyHas(n,["scope","localHook","section","attr","data","changer","functions","lambda","name"]),Object.assign(Object.create(this),{enchantments:e()},n)},enchantScope:function(){var a=this,o=this.attr,u=this.data,l=this.functions,p=this.section,f=this.scope,d=this.localHook,h=this.lambda,y=[];f.forEach(p,function(m,g){if(!d||(d.jquery?d:d.hooks(p)).has(m[0]).length){var v=void 0;if(h)if(v=h.apply(p,{loop:f.TwineScript_GetProperty(g),pos:g+1}),i.containsError(v))m.replaceWith(v.render("")),h=v=null;else if(r.isPrototypeOf(v)){var b=v.summary();(b.includes("newTargets")||b.includes("target"))&&(m.replaceWith(i.create("macrocall","The changer produced by the 'via' lambda given to enchantment macros can't include a revision or enchantment changer like (replace:) or (click:).").render("")),h=v=null)}else m.replaceWith(i.create("macrocall","The 'via' lambda given to enchantment macros must return a changer, not "+s(v)+".").render("")),h=v=null;else v=a.changer;var w=!o&&!u&&(!v||v.summary().every(function(e){return e.startsWith("transition")})),T=w?m:m.wrap("<tw-enchantment>").parent();if(o&&T.attr(o),u&&T.data(u),l&&l.forEach(function(e){return e(T)}),v){var S=n.create({section:p,target:T});if(v.run(S),S.update(),m.is(t.storyElement)){var x=Object.keys(Object.assign.apply(Object,[{}].concat(_toConsumableArray(S.styles))));m.css(x.reduce(function(e,t){return e[t]="inherit",e},{})),T.data({enchantedProperties:x})}else if(m.is("tw-passage")&&S.styles.some(function(e){return"margin-left"in e||"margin"in e||"margin-right"in e})){var k="padding-left",O="padding-right";t.storyElement.css(k,"0px").css(O,"0px"),T.data({enchantedProperties:[k,O]})}}m.is(t.storyElement)&&T.css({width:"100%",height:"100%"}),"true"===T.attr("collapsing")&&(T.find("[collapsing=false]").each(function(){e(this).removeAttr("collapsing")}),c(T)),w||y.push(T)}}),this.enchantments=e(y)},disenchant:function(){this.enchantments.each(function(){e(this).contents().unwrap();var n=e(this).data("enchantedProperties");n&&t.storyElement.css(n.reduce(function(e,t){return e[t]="",e},{}))})}};return Object.freeze(u)}),define("macrolib/enchantments",["jquery","utils","utils/operationutils","engine","state","passages","macros","datatypes/hookset","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/enchantment","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c,u,l,p,f){var d=n.is,h=o.TypeSignature,y=h.either,m=h.rest,g=h.optional;function v(e,t){if(c.isPrototypeOf(t)){var n=t.summary();if(["newTargets","target","appendSource","functions"].some(function(e){return n.includes(e)}))return f.create("datatype","The changer given to ("+e+":) can't include a revision or enchantment changer like (replace:) or (click:).")}}["enchant","change"].forEach(function(e){o.addCommand(e,function(t,n){var r=v(e,n);if(r)return r},function(t,n,r){var a;n=s.from(n);var i=[];if(c.isPrototypeOf(r)){var o=l.create({section:t});if(r.run(o),(o.innerEnchantments||[]).length>0){var u=o.innerEnchantments.map(function(e){return e(n)});i.push.apply(i,_toConsumableArray(u))}}return i.push(p.create((_defineProperty(a={scope:n},c.isPrototypeOf(r)?"changer":"lambda",r),_defineProperty(a,"section",t),a))),i.forEach(function(n){"enchant"===e?(t.addEnchantment(n),t.updateEnchantments()):n.enchantScope()}),""},[y(s,String),y(c,u.TypeSignature("via"))],!1)}),o.addChanger("enchant-in",function(e,t,n){var r=v("enchant-in",n);return r||c.create("enchant-in",[t,n])},function(e,t,n){return e.innerEnchantments=(e.innerEnchantments||[]).concat(function(r){var a;return p.create((_defineProperty(a={scope:s.from(t),localHook:r},c.isPrototypeOf(n)?"changer":"lambda",n),_defineProperty(a,"section",e.section),a))}),e},[y(s,String),y(c,u.TypeSignature("via"))]),[["link-style",s.create({type:"name",data:"link"})],["line-style",s.create({type:"base",data:s.create({type:"name",data:"page"})},"lines",void 0)],["char-style",s.create({type:"base",data:s.create({type:"name",data:"page"})},"chars",void 0)]].forEach(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];o.addChanger(n,function(e,t){var r=v(n,t);return r||c.create(n,[t])},function(e,t){return e.innerEnchantments=(e.innerEnchantments||[]).concat(function(n){var a;return p.create((_defineProperty(a={scope:r,localHook:n},c.isPrototypeOf(t)?"changer":"lambda",t),_defineProperty(a,"section",e.section),a))}),e},[y(c,u.TypeSignature("via"))])});var b=["replace","append","prepend"];function w(n,a){return t.onStartup(function(){var r=n.classList.replace(/ /g,"."),a=n.blockClassList?n.blockClassList.replace(/ /g,"."):"",i="."+r+(a?",."+a:"");t.storyElement.on(n.event.map(function(e){return e+".enchantment"}).join(" "),i,function(){var t=e(Array.from(e(this).parents(i).add(this)).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0]),n=t.data("enchantmentEvent");n&&n(t)})}),[function(e,t,n){if(!t)return f.create("datatype","A string given to this ("+a+":) macro was empty.");if(n){var r=v(a,n);if(r)return r}return c.create(a,[s.from(t)].concat(n?[n]:[]))},function(e,t,i){e.enabled=!1,e.transitionDeferred=!0,n.rerender&&(e.newTargets=(e.newTargets||[]).concat({target:t,append:n.rerender}));var o=e.section&&e.section.stackTop?e.section.stackTop.tempVariables:Object.create(null),s=p.create(_defineProperty({functions:[function(e){e.attr("class",e.children().is("tw-story, tw-sidebar, tw-passage")||"block"===e.children().css("display")?n.blockClassList:n.classList)}],attr:(n.classList+"").match(/\b(?:link|enchantment-clickblock)\b/)?{tabIndex:"0"}:{},data:{enchantmentEvent:function(){e.section.stackTop&&e.section.stackTop.blocked||(n.once&&e.section.removeEnchantment(s),n.goto?r.goToPassage(n.goto,{transition:n.transition}):n.undo?r.goBack({transition:n.transition}):e.section.renderInto(e.source,null,Object.assign({},e,{enabled:!0,transitionDeferred:!1}),o))}},scope:t,section:e.section,name:a},c.isPrototypeOf(i)?"changer":"lambda",i));return e.section&&(e.section.addEnchantment(s),s.enchantScope()),e},[y(s,String),g(y(c,u.TypeSignature("via")))]]}b.forEach(function(t){o.addChanger(t,function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return r.every(Boolean)?c.create(t,r.map(s.from)):f.create("datatype","A string given to this ("+t+":) macro was empty.")},function(n){for(var r,a=arguments.length,i=Array(a>1?a-1:0),o=1;o<a;o++)i[o-1]=arguments[o];return e(n.target).parents().filter("tw-collapsed,[collapsing=true]").length>0||n.attr.some(function(e){return e.collapsing})||(n.attr=[].concat(_toConsumableArray(n.attr),[{collapsing:!1}])),n.newTargets=n.newTargets||[],(r=n.newTargets).push.apply(r,_toConsumableArray(i.filter(function(e){return!n.newTargets.some(function(n){var r=n.target,a=n.append;return d(e,r)&&t===a})}).map(function(e){return{target:e,append:t,before:!0}}))),n},m(y(s,String)))(t+"-with",function(e,n){return c.create(t+"-with",[n])},function(e,n){return e.appendSource=(e.appendSource||[]).concat({source:n,append:t}),e},String)});var T="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,S=[{name:"click",enchantDesc:{event:["click"],once:!0,rerender:"",classList:"link enchantment-link",blockClassList:"enchantment-clickblock"}},{name:"mouseover",enchantDesc:{event:["mouseenter",T?"click":""].filter(Boolean),once:!0,rerender:"",classList:"enchantment-mouseover",blockClassList:"enchantment-mouseoverblock"}},{name:"mouseout",enchantDesc:{event:["mouseleave",T?"click":""].filter(Boolean),once:!0,rerender:"",classList:"enchantment-mouseout",blockClassList:"enchantment-mouseoutblock"}}];S.forEach(function(e){return o.addChanger.apply(o,[e.name].concat(_toConsumableArray(w(e.enchantDesc,e.name))))}),t.onStartup(function(){S.forEach(function(n){var r=n.enchantDesc;r.blockClassList&&t.storyElement.on(r.event.map(function(e){return e+".enchantment"}).join(" "),function(){var t=e(Array.from(e(this).parents("."+r.blockClassList.replace(/ /g,"."))).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0]),n=t.data("enchantmentEvent");n&&n(t)})})}),b.forEach(function(e){S.forEach(function(t){var n=Object.assign({},t.enchantDesc,{rerender:e}),r=t.name+"-"+e;o.addChanger.apply(o,[r].concat(_toConsumableArray(w(n,r))))})}),S.forEach(function(e){["goto","undo"].forEach(function(t){var n=e.name+"-"+t;o.addCommand(n,function(e,r){return!e||!r&&"goto"===t?f.create("datatype","A string given to this ("+n+":) macro was empty."):"goto"!==t||i.hasValid(r)?void 0:f.create("macrocall","I can't ("+n+":) the passage '"+r+"' because it doesn't exist.")},function(r,i,o,c){if("undo"===t&&a.pastLength<1)return f.create("macrocall","I can't (undo:) on the first turn.");var u=w(Object.assign({},e.enchantDesc,{transition:r.data.passageT8n},"undo"===t?{undo:!0}:{goto:c}),n);return(0,_slicedToArray(u,2)[1])({section:i},s.from(o)),Object.assign(r,{source:""})},[y(s,String)].concat("undo"===t?[]:String))})})}),define("macrolib/metadata",["macros","renderer","utils/operationutils","datatypes/lambda","internaltypes/twineerror"],function(e,t,n,r,a){var i=n.clone,o=n.objectName,s=n.isValidDatamapName,c=e.TypeSignature,u=c.zeroOrMore,l=c.Any,p=t.options.metadataMacros,f=function(e){return{TwineScript_TypeName:"a ("+e+":) macro",TwineScript_ObjectName:"a ("+e+":) macro",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}};[["storylet",r.TypeSignature("when")],["urgency",Number],["exclusivity",Number]].forEach(function(t){var n=_slicedToArray(t,2),r=n[0],a=n[1];e.add(r,function(e,t){return e.stackTop.speculativePassage?t:f(r)},a),p.push(r)}),e.add("metadata",function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var c=void 0,u=new Map,l=n.reduce(function(e,t){var n=void 0;if(a.containsError(e))return e;if(void 0===c)c=t;else{if(n=a.containsError(s(u,c)))return n;if(u.has(c))return a.create("macrocall","You used the same data name ("+o(c)+") twice in the same (metadata:) call.");u.set(c,i(t)),c=void 0}return e},!0);return a.containsError(l)?l:void 0!==c?a.create("macrocall","This (metadata:) macro has a data name without a value."):e.stackTop.speculativePassage?u:f("storylet")},u(l)),p.push("metadata")}),define("macrolib/patterns",["jquery","macros","utils","utils/operationutils","datatypes/datatype","datatypes/typedvar","internaltypes/twineerror"],function(e,t,n,r,a,i,o){var s=n.anyRealLetter,c=n.anyUppercase,u=n.anyLowercase,l=n.anyCasedLetter,p=n.realWhitespace,f=n.impossible,d=r.objectName,h=r.toSource,y=t.TypeSignature,m=y.rest,g=y.either,v=y.optional,b=y.nonNegativeInteger,w=Object.assign,T=Object.create,S=m(g(String,a,i)),x=function e(t){var n,r=t.name,y=t.fullArgs,m=t.args,g=t.makeRegExpString,v=void 0===g?function(e){return e.join("")}:g,b=t.insensitive,S=void 0!==b&&b,x=t.canContainTypedVars,k=void 0===x||x,O=t.canBeUsedAlone,j=void 0===O||O,A=m||y,C=A.map(function e(t){if(i.isPrototypeOf(t)){if(!k)return o.create("operation","Optional string patterns, like ("+r+":)"+("p-many"===r?" with min 0":"")+", can't have typed variables inside them.");var n=e(t.datatype);return o.containsError(n)?n:"("+n+")"}if(a.isPrototypeOf(t)){if(!k&&"typedVars"in t&&t.typedVars().length)return o.create("operation","("+r+":) can't have typed variables inside its pattern.");if(t.regExp)return(t.rest?"(?:":"")+(S?t.insensitive().regExp:t.regExp)+(t.rest?")*":"");var h=t.name,y=t.rest?"*":"";return"alnum"===h?s+y:"whitespace"===h?p+y:"uppercase"===h?(S?l:c)+y:"lowercase"===h?(S?l:u)+y:"anycase"===h?l+y:"digit"===h?"\\d"+y:"linebreak"===h?"(?:\\r|\\n|\\r\\n)"+y:"str"===h?".*?":["even","odd","int","num"].includes(h)?o.create("datatype","Please use string datatypes like 'digit' in ("+r+":) instead of number datatypes."):o.create("datatype","The ("+r+":) macro must only be given string-related datatypes, not "+d(t)+".")}return"string"==typeof t?(t=t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),S&&(t=t.replace(RegExp("("+c+"|"+u+")","g"),function(e){return"["+e.toUpperCase()+e.toLowerCase()+"]"})),t):(f("createPattern","mapper() was given a non-string non-datatype "+t),"")});if(n=o.containsError(C))return n;var E=v(C),_=w(T(a),{name:r,regExp:E,insensitive:function(){return S?_:e({name:r,fullArgs:y,args:A.map(function(e){return a.isPrototypeOf(e)&&"function"==typeof e.insensitive?e.insensitive():e}),makeRegExpString:v,insensitive:!0,canContainTypedVars:k,canBeUsedAlone:j})},typedVars:function(){return A.reduce(function(t,n){return i.isPrototypeOf(n)&&(t=t.concat(S?i.create(e({name:"p-ins",fullArgs:[n.datatype],insensitive:!0}),n.varRef):n),n=n.datatype),a.isPrototypeOf(n)&&"function"==typeof n.typedVars&&(t=t.concat(n.typedVars())),t},[])},destructure:function(t){if("string"!=typeof t)return[o.create("operation","I can't unpack "+d(t)+" into "+this.TwineScript_ToSource()+" because it isn't a string.")];var n=this.typedVars();if(!n.length)return[];var r=(RegExp("^"+(this.rest?"(?:":"")+E+(this.rest?")*":"")+"$").exec(t)||[]).slice(1);return r.length?r.map(function(t,r){var a=n[r];if(a)return a.datatype.rest&&!a.datatype.regExp&&((a=a.TwineScript_Clone()).datatype=e({name:"p",fullArgs:[a.datatype]})),{dest:a,value:t||"",src:void 0}}).filter(Boolean):[o.create("operation","I can't unpack "+d(t)+" because it doesn't match the pattern "+this.TwineScript_ToSource()+".")]},TwineScript_IsTypeOf:function(e){return j?"string"==typeof e&&!!e.match("^"+(this.rest?"(?:":"")+E+(this.rest?")*":"")+"$"):o.create("operation","A ("+r+":) datatype must only be used with a (p:) macro.")},TwineScript_toTypeSignatureObject:function(){var e=this;return{pattern:"range",name:r,range:function(t){return e.TwineScript_IsTypeOf(t)}}},TwineScript_ToSource:function(){return(this.rest?"...":"")+"("+r+":"+y.map(h)+")"}});return Object.defineProperty(_,"TwineScript_ObjectName",{get:function(){return"a ("+r+":) datatype"}}),_};t.add(["p","pattern"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return x({name:"p",fullArgs:n})},S)(["p-either","pattern-either"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return x({name:"p-either",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("|")+")"}})},S)(["p-opt","pattern-opt","p-optional","pattern-optional"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return x({name:"p-opt",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("")+")?"}})},S)(["p-not","pattern-not"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.find(function(e){return"string"==typeof e?1!==[].concat(_toConsumableArray(e)).length:e.rest||e.regExp||["str","empty"].includes(e.name)})?o.create("datatype","(p-not:) should only be given single character"):x({name:"p-not",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"[^"+e.map(function(e){return e.startsWith("[")&&e.endsWith("]")?e.slice(1,-1):e}).join("")+"]"}})},S)(["p-many","pattern-many"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var s=n.slice(),c=void 0,u=void 0;if("number"==typeof n[0]&&(c=n.shift(),u="number"==typeof n[0]?n.shift():1/0),void 0!==u&&u<c)return o.create("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.");if(!n.length)return o.create("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.");var l=n.find(function(e){return"string"!=typeof e&&!a.isPrototypeOf(e)&&!i.isPrototypeOf(e)});return l?o.create("datatype","This (p-many:) macro can only be given a min and max number followed by datatypes or strings, but was also given "+d(l)+"."):x({name:"p-many",args:n,fullArgs:s,canContainTypedVars:c>0,makeRegExpString:function(e){return"(?:"+e.join("")+")"+(void 0!==c?"{"+c+(u===1/0?",":u!==c?","+u:"")+"}":"+")}})},[m(g(b,String,a,i))])(["p-ins","pattern-ins","p-insensitive","pattern-insensitive"],function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return x({name:"p-ins",fullArgs:n,insensitive:!0})},S)(["split","splitted"],function(e,t,n){if(t=x({name:"split",fullArgs:[t],canContainTypedVars:!1}),o.containsError(t))return t;if(!n)return[""];if(!t.regExp)return[].concat(_toConsumableArray(n));for(var r=RegExp(t.regExp),a=[],i=void 0;n&&(i=r.exec(n));){if(i.index+i[0].length===0)return a;a.push(n.slice(0,i.index)),n=n.slice(i.index+i[0].length)}return a.concat(n||[])},[g(String,a),String])("trimmed",function(e,t,n){return void 0===n||a.isPrototypeOf(t)&&"whitespace"===t.name?t.trim():(t=x({name:"trimmed",fullArgs:[t],canContainTypedVars:!1}),o.containsError(t)?t:t.regExp?n.replace(RegExp("^("+t.regExp+")*|("+t.regExp+")*$","g"),""):n)},[g(String,a),v(String)])}),define("macrolib/links",["jquery","macros","utils","state","passages","engine","datatypes/changercommand","internaltypes/changedescriptor","datatypes/hookset","datatypes/lambda","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c,u,l){var p=t.TypeSignature,f=p.optional,d=p.rest,h=p.either,y=["Links can't have empty strings for their displayed text.","In the link syntax, a link's displayed text is inside the [[ and ]], and on the non-pointy side of the -> or <- arrow if it's there."],m=Object.assign;function g(e,t,r){r=r||t;var i=a.hasValid(t)&&t===r,o=e.evaluateTwineMarkup(n.unescape(r),"a link's passage name"),s=void 0;if(i){var c=o.children().length>0?"`".repeat((r.match(/`+/)||[]).reduce(function(e,t){return Math.max(e,t.length+1)},1)):"";t=c+"\0".repeat(!!c)+t+"\0".repeat(!!c)+c}else o.findAndFilter("tw-error").length&&(s=o.findAndFilter("tw-error").data("TwineError")),r=o.text();return{text:t,passage:r,error:s}}n.onStartup(function(){e(n.storyElement).on("click.passage-link","tw-link",function(t){var n=e(this),r=n.closest("tw-expression"),a=n.closest("tw-expression, tw-hook"),o=a.data("clickEvent"),s=a.data("section");if(!(s&&s.stackTop&&s.stackTop.blocked)){if(o){if(n.find("tw-error").length>0)return;return t.stopPropagation(),void o(n)}var c=r.data("linkPassageName"),u=Object.assign({},r.data("passageT8n")||{});return r.find("tw-enchantment").each(function(t,n){Object.assign(u,e(n).data("passageT8n")||{})}),c?(t.stopPropagation(),void i.goToPassage(c,{transition:u})):n.is("[undo]")?(t.stopPropagation(),void i.goBack({transition:u})):n.is("[fullscreen]")?(t.stopPropagation(),void i.toggleFullscreen()):void 0}}),e(document).on("fullscreenchange",function(){e("tw-link[fullscreen]",n.storyElement).each(function(t,n){(e(n).closest("tw-expression, tw-hook").data("fullscreenEvent")||Object)(n)})})}),[["link","link-replace"],["link-reveal"],["link-repeat"],["link-rerun"]].forEach(function(e){return t.addChanger(e,function(t,n,r){if(!n)return l.create("datatype",y[0]);if(r){var a=r.summary();if(["newTargets","target","appendSource","functions"].some(function(e){return a.includes(e)}))return l.create("datatype","The changer given to ("+e[0]+":) can't include a revision or enchantment changer like (replace:) or (click:).")}return o.create(e[0],[n].concat(r||[]))},function(t,n,r){var a=e[0],i=t.section&&t.section.stackTop?t.section.stackTop.tempVariables:Object.create(null),o=s.create({source:"<tw-link tabindex=0>"+n+"</tw-link>",target:function(){return t.target},append:"replace",data:{section:t.section,clickEvent:function(e){t.enablers=t.enablers.filter(function(e){return e.descriptor!==o}),"link-reveal"===a&&e.contents().unwrap();var n=e.parentsUntil(":not(tw-enchantment)").parent();if(n.length||(n=e.parent()),"link-rerun"===a){var r=e.parentsUntil(":not(tw-enchantment)");e.detach(),r.remove()}"link"!==a&&"link-rerun"!==a||n.empty(),t.section.renderInto("",null,t,i),"link-rerun"===a&&n.prepend(e)}}});return t.enablers=(t.enablers||[]).concat({descriptor:o,changer:r}),t},[String,f(o)])}),t.addCommand("link-goto",function(e){if(!e)return l.create.apply(l,["datatype"].concat(y))},function(e,t,i,o){var s,c=g(t,i,o);if(i=c.text,o=c.passage,s=c.error)return s;if(e.transition){var u="transition";return l.create("datatype","Please attach ("+u+"-depart:) or ("+u+"-arrive:) to a passage link, not ("+u+":).")}var p=void 0;return a.hasValid(o)||(p='<tw-broken-link passage-name="'+n.escape(o)+'">'+i+"</tw-broken-link>"),p=p||"<tw-link tabindex=0 "+(r.passageNameVisited(o)>0?'class="visited" ':"")+">"+i+"</tw-link>",e.data.linkPassageName=o,e.data.section=t,m(e,{source:p,transitionDeferred:!0})},[String,f(String)])("link-storylet",function(){var e,t=(e=1===arguments.length||"string"!=typeof(arguments.length<=0?void 0:arguments[0])?0:1,arguments.length<=e?void 0:arguments[e]);if(!t||"string"==typeof t)return l.create("datatype","(link-storylet:) should be given one index number or one 'where' lambda, after the optional link text string.")},function(e,t){var n,i,o,s=(n=2+(1==(arguments.length<=2?0:arguments.length-2)?0:3==(arguments.length<=2?0:arguments.length-2)||"string"==typeof(arguments.length<=2?void 0:arguments[2])?1:2),arguments.length<=n?void 0:arguments[n]),c="string"==typeof(arguments.length<=2?void 0:arguments[2])&&(arguments.length<=2?void 0:arguments[2]),p=(i=(arguments.length<=2?0:arguments.length-2)-1+2,(arguments.length<=i?void 0:arguments[i])!==s&&(o=(arguments.length<=2?0:arguments.length-2)-1+2,arguments.length<=o?void 0:arguments[o]));if(e.transition){var f="transition";return l.create("datatype","Please attach ("+f+"-depart:) or ("+f+"-arrive:) to (link-storylet:), not ("+f+":).")}var d=u.isPrototypeOf(s),h=a.getStorylets(t,d&&s),y=l.containsError(h);if(y)return y;var g=h[d?0:s<0?h.length+s:s-1],v=void 0;if(g)g=g.get("name"),c=c||g,v=v||"<tw-link tabindex=0 "+(r.passageNameVisited(g)>0?'class="visited" ':"")+">"+c+"</tw-link>",e.data.linkPassageName=g,e.data.section=t;else{if(!p)return e;v=p}return m(e,{source:v,transitionDeferred:!0})},[h(parseInt,String,u.TypeSignature("where")),f(h(parseInt,String,u.TypeSignature("where"))),f(String)])("link-undo",function(e){if(!e)return l.create("datatype",y[0])},function(e,t,n){return r.pastLength<1?l.create("macrocall","I can't use (link-undo:) on the first turn."):(e.data.section=t,m(e,{source:"<tw-link tabindex=0 undo>"+n+"</tw-link>",transitionDeferred:!0}))},[String])("link-show",function(e){if(!e)return l.create("datatype",y[0])},function(t,n,r){for(var a=arguments.length,i=Array(a>3?a-3:0),o=3;o<a;o++)i[o-3]=arguments[o];return t.data.section=n,t.data.clickEvent=function(r){r.contents().unwrap(),i.forEach(function(r){return r.forEach(n,function(r){var a=r.data("originalSource")||"",i=r.data("hidden");if(i)if(r.removeData("hidden"),i instanceof e)r.empty().append(i);else{var o=r.data("tempVariables");n.renderInto("",null,m({},t,{source:a,target:r,transitionDeferred:!1}),o&&Object.create(o))}})})},m(t,{source:"<tw-link tabindex=0>"+r+"</tw-link>",transitionDeferred:!0})},[String,d(c)])("link-fullscreen",function(e,t){if(!e||!t)return l.create("datatype",y[0])},function(e,t,n,r){var a=function(){return document.fullscreenEnabled||document.msFullscreenEnabled?"<tw-link tabindex=0 fullscreen>"+(document.fullscreenElement||document.msFullscreenElement?r:n)+"</tw-link>":r?"<tw-broken-link>"+r+"</tw-broken-link>":""},i=t.stackTop.tempVariables;return e.data.section=t,e.data.fullscreenEvent=function(){(document.fullscreenEnabled||document.msFullscreenEnabled)&&e.data.section.whenUnblocked(function(){var t=m({},e,{append:"replace",source:a(),transitionDeferred:!1});e.section.renderInto("",null,t,i)})},m(e,{source:a(),transitionDeferred:!0})},[String,String,f(String)]),t.addChanger(["link-reveal-goto"],function(e,t,n,r){if(!t)return l.create.apply(l,["datatype"].concat(y));if(o.isPrototypeOf(n)){if(o.isPrototypeOf(r))return l.create("datatype","You mustn't give two changers to (link-reveal-goto:)");r=n,n=void 0}if(r){var a=r.summary();if(["newTargets","target","appendSource","functions"].some(function(e){return a.includes(e)}))return l.create("datatype","The changer given to (link-reveal-goto:) can't include a revision or enchantment changer like (replace:) or (click:).")}var i=g(e,t,n);return t=i.text,n=i.passage,i.error||o.create("link-reveal-goto",[t,n,r].filter(function(e){return void 0!==e}))},function(e,t,o,c){if(a.hasValid(o)){var u=r.passageNameVisited(o),l=e.section&&e.section.stackTop?e.section.stackTop.tempVariables:Object.create(null),p=s.create({source:"<tw-link tabindex=0 "+(u>0?'class="visited" ':"")+">"+t+"</tw-link>",target:e.target,append:"replace",data:{section:e.section,append:"replace",clickEvent:function(t){e.enablers=e.enablers.filter(function(e){return e.descriptor!==p}),t.contents().unwrap(),e.section.renderInto("",null,e,l),e.section.whenUnblocked(function(){return i.goToPassage(o,{transition:e.data.passageT8n})})}}});return e.enablers=(e.enablers||[]).concat({descriptor:p,changer:c}),e}e.source='<tw-broken-link passage-name="'+n.escape(o)+'">'+t+"</tw-broken-link>"},[String,f(h(o,String)),f(o)])}),define("macrolib/custommacros",["utils","macros","state","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/codehook","datatypes/typedvar","internaltypes/twineerror"],function(e,t,n,r,a,i,o,s,c){var u=t.add,l=t.addChanger,p=t.addCommand,f=t.TypeSignature,d=f.rest,h=f.either,y=f.Any,m=r.objectName;u("macro",function(t){for(var r=arguments.length,a=Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];var u=void 0,l=[];for(u=0;u<a.length;u+=1){var p=u===a.length-1;if(s.isPrototypeOf(a[u])===p)return c.create("datatype","The "+(p?"":e.nth(a.length-u+1)+"-")+"last value given to (macro:) should be a "+(p?"code hook":"datatyped variable")+", not "+m(a[u]));if(!p){var f="A custom macro";if(a[u].varRef.object===n.variables)return c.create("datatype",f+"'s typed variables must be temp variables (with a '_'), not global variables (with a '$').","Write them with a _ symbol at the start instead of a $ symbol.");if(a[u].varRef.propertyChain.length>1)return c.create("datatype",f+"'s typed variables can't be properties inside a data structure.");if(a[u].datatype.rest&&u!==a.length-2)return c.create("datatype",f+" can only have one spread variable, and it must be its last variable.");var d=a[u].varRef.propertyChain[0];if(l.includes(d))return c.create("datatype",f+"'s typed variables can't both be named '"+d+"'.");l.push(d)}}return i.create(a.slice(0,-1),a[a.length-1])},[d(h(s,o))]);var g=function(e,t,n){if(!t.some(function(e){if("function"==typeof e.output)return e.output(n),!0}))return c.create("macrocall","("+e+":) should only be used inside a code hook passed to (macro:).")};p(["output-data","out-data"],function(){},function(e,t){var n=e.stack;return g("output-data",n,t)||"blocked"},[y],!1),l(["output","out"],function(e){return Object.assign(a.create("output",[e]))},function(e,t){var n=t.stack,r=t.stackTop;return e.loopVars=Object.keys(r.tempVariables).reduce(function(e,t){return e[t]=[r.tempVariables[t]],e},{}),g("output",n,e),r.blocked=!0,e},[]),p("error",function(e){if(!e)return c.create("datatype","This (error:) macro was given an empty string.")},function(e,t){var n=e.stack;return g("error",n,c.create("user",t))||"blocked"},[String],!1)}),define("repl",["utils","engine","markup","twinescript/compiler","twinescript/environ"],function(e,t,n,r,a){e.onStartup(function(){return setTimeout(function(){t.options.debug&&(window.REPL=function(e){var t=r(n.lex("(print:"+e+")"));console.log(t);var i=a({}).eval(t);return i.TwineScript_Run?i.TwineScript_Run().source:i},window.LEX=function(e){var t=n.lex(e);return 1===t.length?t[0]:t})})})}),require.config({paths:{jquery:"../node_modules/jquery/dist/jquery",almond:"../node_modules/almond/almond","es6-shim":"../node_modules/es6-shim/es6-shim",jqueryplugins:"utils/jqueryplugins",markup:"./markup/markup",lexer:"./markup/lexer",patterns:"./markup/patterns"},deps:["es6-shim","jqueryplugins"]}),require(["jquery","debugmode/mode","renderer","state","section","engine","passages","utils","utils/renderutils","internaltypes/varscope","internaltypes/twineerror","macros","macrolib/values","macrolib/commands","macrolib/datastructures","macrolib/stylechangers","macrolib/enchantments","macrolib/metadata","macrolib/patterns","macrolib/links","macrolib/custommacros","repl"],function($,DebugMode,Renderer,State,Section,Engine,Passages,Utils,_ref118,VarScope,TwineError){var dialog=_ref118.dialog;function __HarloweEval(text){return eval(text+"")}var _installHandlers=function(){$(document.documentElement).on("keydown",function(e){13===e.which&&"0"===e.target.getAttribute("tabindex")&&$(e.target).trigger("click")}),Engine.options.debug?DebugMode():TwineError.on("error",function(e,t){return!$("tw-debugger").length&&DebugMode(e,t)}),_installHandlers=null},oldOnError;function printJSError(e){var t=e.name+": "+e.message;if(e.stack){var n=e.stack.split("\n"),r=n.findIndex(function(e){return e.includes("__HarloweEval")});t+="\n"+n.slice(0,r).join("\n").replace(/\([^\)]+\)/g,"")}return"<div style='font-family:monospace;overflow-y:scroll;max-height:30vh'>```"+t+"```</div>"}oldOnError=window.onerror,window.onerror=function(e,t,n,r,a){window.onerror=oldOnError,Utils.storyElement.parent().append(dialog({message:"Sorry to interrupt, but this page's code has got itself in a mess.\n\n"+printJSError(a)+"\n(This is probably due to a bug in the Harlowe game engine.)"})),"function"==typeof oldOnError&&oldOnError.apply(void 0,arguments)},Utils.onStartup(function(){var e=$("tw-storydata");if(0!==e.length){var t=e.attr("options");t&&t.split(/\s/).forEach(function(e){Renderer.options[e]=Engine.options[e]=!0});var n=e.attr("startnode");Renderer.options.ifid=Engine.options.ifid=e.attr("ifid"),n||(n=[].reduce.call($("tw-passagedata"),function(e,t){var n=t.getAttribute("pid");return n<e?n:e},1/0)),n=$("tw-passagedata[pid="+n+"]").attr("name"),_installHandlers();var r=!1;$("[role=script]").each(function(e){try{__HarloweEval($(this).html())}catch(t){r||(r=!0,dialog({parent:Utils.storyElement.parent(),message:"There is a problem with this story's "+Utils.nth(e+1)+" script:\n\n"+printJSError(t)}))}}),$("[role=stylesheet]").each(function(e){$(document.head).append('<style data-title="Story stylesheet '+(e+1)+'">'+$(this).html())});var a=Section.create();a.stack=[{tempVariables:Object.create(VarScope)}];var i=Passages.loadMetadata(a);if(i.length){var o=dialog({parent:Utils.storyElement.parent(),message:"These errors occurred when running the `(metadata:)` macro calls in this story's passages:<p></p>"});i.forEach(function(e){return o.find("p").append(e.render(""))})}var s=!Engine.options.debug&&State.hasSessionStorage&&sessionStorage.getItem("Saved Session");s&&!0===State.deserialise(a,s)?Engine.showPassage(State.passage,!1):Engine.goToPassage(n)}})}),define("harlowe",function(){}),require(["harlowe"])}();
</script>

</body>
</html>
