<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Masks of Mayhem</title>
<style title="Twine CSS">@keyframes appear{0%{opacity:0}to{opacity:1}}@keyframes fade-in-out{0%,to{opacity:0}50%{opacity:1}}@keyframes rumble{25%{top:-0.1em}75%{top:.1em}0%,to{top:0px}}@keyframes shudder{25%{left:.1em}75%{left:-0.1em}0%,to{left:0px}}@keyframes buoy{25%{top:.25em}75%{top:-0.25em}0%,to{top:0px}}@keyframes sway{25%{left:.25em}75%{left:-0.25em}0%,to{left:0px}}@keyframes pulse{0%{transform:scale(0, 0)}20%{transform:scale(1.2, 1.2)}40%{transform:scale(0.9, 0.9)}60%{transform:scale(1.05, 1.05)}80%{transform:scale(0.925, 0.925)}to{transform:scale(1, 1)}}@keyframes zoom-in{0%{transform:scale(0, 0)}to{transform:scale(1, 1)}}@keyframes shudder-in{0%,to{transform:translateX(0em)}5%,25%,45%{transform:translateX(-1em)}15%,35%,55%{transform:translateX(1em)}65%{transform:translateX(-0.6em)}75%{transform:translateX(0.6em)}85%{transform:translateX(-0.2em)}95%{transform:translateX(0.2em)}}@keyframes rumble-in{0%,to{transform:translateY(0em)}5%,25%,45%{transform:translateY(-1em)}15%,35%,55%{transform:translateY(1em)}65%{transform:translateY(-0.6em)}75%{transform:translateY(0.6em)}85%{transform:translateY(-0.2em)}95%{transform:translateY(0.2em)}}@keyframes fidget{0%,8.1%,82.1%,31.1%,38.1%,44.1%,40.1%,47.1%,74.1%,16.1%,27.1%,72.1%,24.1%,95.1%,6.1%,36.1%,20.1%,4.1%,91.1%,14.1%,87.1%,to{left:0px;top:0px}8%,82%,31%,38%,44%{left:-1px}40%,47%,74%,16%,27%{left:1px}72%,24%,95%,6%,36%{top:-1px}20%,4%,91%,14%,87%{top:1px}}@keyframes slide-right{0%{transform:translateX(-100vw)}}@keyframes slide-left{0%{transform:translateX(100vw)}}@keyframes slide-up{0%{transform:translateY(100vh)}}@keyframes slide-down{0%{transform:translateY(-100vh)}}@keyframes fade-right{0%{opacity:0;transform:translateX(-1em)}to{opacity:1}}@keyframes fade-left{0%{opacity:0;transform:translateX(1em)}to{opacity:1}}@keyframes fade-up{0%{opacity:0;transform:translateY(1em)}to{opacity:1}}@keyframes fade-down{0%{opacity:0;transform:translateY(-1em)}to{opacity:1}}@keyframes flicker{0%,29%,31%,63%,65%,77%,79%,86%,88%,91%,93%{opacity:0}30%{opacity:.2}64%{opacity:.4}78%{opacity:.6}87%{opacity:.8}92%,to{opacity:1}}@keyframes blur{0%{filter:blur(2rem);opacity:0}25%{opacity:1}to{filter:blur(0rem);opacity:1}}.dom-debug-mode tw-story,.dom-debug-mode tw-passage,.dom-debug-mode tw-sidebar,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{outline:1px solid #f5a3da;min-height:32px;display:block !important}.dom-debug-mode tw-story::before,.dom-debug-mode tw-passage::before,.dom-debug-mode tw-sidebar::before,.dom-debug-mode tw-include::before,.dom-debug-mode tw-hook::before,.dom-debug-mode tw-expression::before,.dom-debug-mode tw-link::before,.dom-debug-mode tw-dialog::before,.dom-debug-mode tw-columns::before,.dom-debug-mode tw-column::before,.dom-debug-mode tw-align::before{position:absolute;top:0;left:0;height:16px;background-color:#f5a3da;color:#000;font-size:16px;font-weight:normal;font-style:normal;font-family:monospace;display:inline-block;line-height:100%;white-space:pre;z-index:999997}.dom-debug-mode tw-story:hover,.dom-debug-mode tw-passage:hover,.dom-debug-mode tw-sidebar:hover,.dom-debug-mode tw-include:hover,.dom-debug-mode tw-hook:hover,.dom-debug-mode tw-expression:hover,.dom-debug-mode tw-link:hover,.dom-debug-mode tw-dialog:hover,.dom-debug-mode tw-columns:hover,.dom-debug-mode tw-column:hover,.dom-debug-mode tw-align:hover{outline:1px solid #fc9}.dom-debug-mode tw-story:hover::before,.dom-debug-mode tw-passage:hover::before,.dom-debug-mode tw-sidebar:hover::before,.dom-debug-mode tw-include:hover::before,.dom-debug-mode tw-hook:hover::before,.dom-debug-mode tw-expression:hover::before,.dom-debug-mode tw-link:hover::before,.dom-debug-mode tw-dialog:hover::before,.dom-debug-mode tw-columns:hover::before,.dom-debug-mode tw-column:hover::before,.dom-debug-mode tw-align:hover::before{background-color:#fc9;transition:background-color 1s}.dom-debug-mode tw-passage,.dom-debug-mode tw-include,.dom-debug-mode tw-hook,.dom-debug-mode tw-expression,.dom-debug-mode tw-link,.dom-debug-mode tw-dialog,.dom-debug-mode tw-columns,.dom-debug-mode tw-column,.dom-debug-mode tw-align{padding:1em;margin:0}.dom-debug-mode tw-story::before{content:'<tw-story tags="' attr(tags) '">'}.dom-debug-mode tw-passage::before{top:-16px;content:'<tw-passage tags="' attr(tags) '">'}.dom-debug-mode tw-sidebar::before{top:-16px;content:"<tw-sidebar>"}.dom-debug-mode tw-hook::before{content:'<tw-hook name="' attr(name) '">'}.dom-debug-mode tw-expression::before{content:'<tw-expression name="' attr(name) '">'}.dom-debug-mode tw-link::before{content:'<tw-link name="' attr(name) '">'}.dom-debug-mode tw-dialog::before{content:"<tw-dialog>"}.dom-debug-mode tw-columns::before{content:"<tw-columns>"}.dom-debug-mode tw-column::before{content:"<tw-column>"}.dom-debug-mode tw-align::before{content:"<tw-align>"}.dom-debug-mode tw-include::before{content:'<tw-include type="' attr(type) '" name="' attr(name) '">'}tw-open-button[goto]{display:none}.debug-mode tw-open-button[replay],.debug-mode tw-open-button[goto]{display:inline}.debug-mode tw-expression{display:inline-block !important}.debug-mode tw-expression[type=variable]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"$" attr(name)}.debug-mode tw-expression[type=tempVariable]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"_" attr(name)}.debug-mode tw-expression[return=boolean]{background-color:rgba(179,179,179,.2)}.debug-mode tw-expression[return=array]{background-color:rgba(255,102,102,.2)}.debug-mode tw-expression[return=dataset]{background-color:rgba(255,128,0,.2)}.debug-mode tw-expression[return=number]{background-color:rgba(255,179,102,.2)}.debug-mode tw-expression[return=datamap]{background-color:rgba(255,255,102,.2)}.debug-mode tw-expression[return=changer]{background-color:rgba(179,255,102,.2)}.debug-mode tw-expression[return=lambda]{background-color:rgba(102,255,102,.2)}.debug-mode tw-expression[return=hookname]{background-color:rgba(102,255,204,.2)}.debug-mode tw-expression[return=string]{background-color:rgba(102,255,255,.2)}.debug-mode tw-expression[return=datatype]{background-color:rgba(102,153,255,.2)}.debug-mode tw-expression[return=gradient],.debug-mode tw-expression[return=colour]{background-color:rgba(204,102,255,.2)}.debug-mode tw-expression[return=instant],.debug-mode tw-expression[return=macro]{background-color:rgba(240,117,199,.2)}.debug-mode tw-expression[return=command]{background-color:rgba(153,153,255,.2)}.debug-mode tw-expression.false{background-color:rgba(255,0,0,.2) !important}.debug-mode tw-expression[type=macro]::before{content:"(" attr(name) ":)";padding:0 .5rem;font-size:1rem;vertical-align:middle;line-height:normal;background-color:inherit;border:1px solid rgba(255,255,255,.5)}.debug-mode tw-expression[title]:not([title=""]){cursor:help}.debug-mode tw-hook{background-color:rgba(0,85,255,.1) !important}.debug-mode tw-hook::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"["}.debug-mode tw-hook::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"]"}.debug-mode tw-hook[name]::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"]<" attr(name) "|"}.debug-mode tw-pseudo-hook{background-color:rgba(255,170,0,.1) !important}.debug-mode tw-collapsed::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"{"}.debug-mode tw-collapsed::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"}"}.debug-mode tw-verbatim::before,.debug-mode tw-verbatim::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:"`"}.debug-mode tw-align[style*="text-align: center"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0) 0%, hsla(14, 100%, 87%, 0.25) 50%, hsla(14, 100%, 87%, 0) 100%)}.debug-mode tw-align[style*="text-align: left"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0.25) 0%, hsla(14, 100%, 87%, 0) 100%)}.debug-mode tw-align[style*="text-align: right"]{background:linear-gradient(to right, hsla(14, 100%, 87%, 0) 0%, hsla(14, 100%, 87%, 0.25) 100%)}.debug-mode tw-column{background-color:rgba(189,228,255,.2)}.debug-mode tw-enchantment{animation:enchantment .5s infinite;border:1px solid}.debug-mode tw-link::after,.debug-mode tw-broken-link::after{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:attr(passage-name)}.debug-mode tw-include{background-color:rgba(204,128,51,.1)}.debug-mode tw-include::before{font-size:.8rem;padding-left:.2rem;padding-right:.2rem;vertical-align:top;content:attr(type) ' "' attr(name) '"'}.debug-dialogs tw-backdrop:not(.eval-replay):not(.harlowe-crash){pointer-events:none;opacity:.1}tw-eval-replay tw-eval-code,tw-eval-replay tw-eval-explanation{max-height:20vh;overflow:auto;margin:10px auto}tw-eval-replay tw-eval-code{display:block;font-family:monospace;padding-bottom:1ex;border-bottom:2px solid gray}tw-eval-replay tw-eval-explanation{display:block;text-align:center}tw-eval-replay tw-eval-explanation>code{white-space:pre-wrap}tw-eval-replay tw-eval-explanation>code.from-block{width:40%;display:inline-block;text-align:left;max-height:4em;overflow-wrap:anywhere;overflow-y:scroll}tw-eval-replay tw-eval-explanation>code.from-block~.to-desc{width:calc(40% - 2em);margin-left:2em;display:inline-block}tw-eval-replay tw-eval-explanation>code.from-block+span::after{content:"..."}tw-eval-replay tw-eval-explanation>code.from-inline{text-align:right}tw-eval-replay tw-eval-explanation>:nth-child(2){white-space:pre}tw-eval-replay tw-eval-explanation>.to-desc{text-align:left}tw-eval-replay tw-eval-explanation>table{width:100%;margin-top:1em}tw-eval-replay tw-eval-explanation>table td{white-space:pre-wrap !important;word-wrap:anywhere}tw-eval-replay tw-eval-reason{text-align:center;font-size:80%;font-style:italic;display:block}tw-eval-replay tw-eval-it{text-align:center;font-size:80%;display:block}tw-eval-replay tw-dialog-links{display:-ms-flexbox;display:flex;-ms-flex-pack:distribute;justify-content:space-around}@keyframes enchantment{0%,to{border-color:#ffb366}50%{border-color:#6fc}}tw-debugger{position:fixed;box-sizing:border-box;bottom:0;right:0;z-index:999999;min-width:14em;min-height:1em;padding:0em .5em .5em 1em;font-size:1.25em;font-family:sans-serif;color:#262626;background-color:#fff;border-left:solid #262626 2px;border-top:solid #262626 2px;border-top-left-radius:.5em;opacity:1}tw-debugger.fade-panel:not(:hover){opacity:.33}tw-debugger.theme-dark{color:#d9d9d9;background-color:#000}tw-debugger.theme-dark{border-color:#d9d9d9 rgba(0,0,0,0) rgba(0,0,0,0) #d9d9d9}tw-debugger select{margin-right:1em;width:12em}tw-debugger button,tw-debugger tw-link{border-radius:3px;border:solid #999 1px;margin:auto 4px;color:#262626;background-color:#fff;cursor:pointer}tw-debugger button.enabled,tw-debugger tw-link.enabled{color:#000;background-color:#d9d9d9;box-shadow:inset #999 3px 5px .5em}tw-debugger.theme-dark button,tw-debugger.theme-dark tw-link{color:#d9d9d9;background-color:#000;border-color:#666}tw-debugger.theme-dark button.enabled,tw-debugger.theme-dark tw-link.enabled{color:#e6e6e6;background-color:#424242;box-shadow:inset #666 3px 5px .5em}tw-debugger button{font-size:1em;overflow-x:hidden;text-overflow:ellipsis;white-space:pre}tw-debugger tw-link{font-size:1.25em;border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block}tw-debugger tw-link:hover{border-color:#262626;color:#262626}tw-debugger.theme-dark tw-link:hover{border-color:#d9d9d9;color:#d9d9d9}tw-debugger tw-dialog{background-color:#fff;color:#000;font-size:1.25em}tw-debugger.theme-dark tw-dialog{background-color:#000;color:#e6e6e6}tw-debugger .panel{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;position:absolute;bottom:100%;left:-2px;right:0;padding:1em;overflow-y:scroll;overflow-x:hidden;border:inherit;box-sizing:content-box;background-color:#fff;border-bottom:solid #999 2px;border-top-left-radius:.5em;border-bottom-left-radius:.5em;font-size:.8em}tw-debugger .panel:empty,tw-debugger .panel[hidden]{display:none}tw-debugger.theme-dark .panel{background-color:#000;border-bottom-color:#666}tw-debugger .panel-source .panel-row-buttons{width:2rem}tw-debugger .panel-source .source-tags{width:20%;font-style:italic}tw-debugger .panel-row-source td{font-family:monospace;font-size:1rem;white-space:pre-wrap;overflow-wrap:anywhere;max-height:8rem;padding:1rem}tw-debugger .panel-rows{width:100%;overflow-x:scroll}tw-debugger .panel-rows>*{display:table-row}tw-debugger .panel-rows>div:nth-of-type(2n){background-color:#e6e6e6}tw-debugger .panel-tools .panel-rows>*,tw-debugger .panel-options .panel-rows>*{margin-top:.4rem;display:block}tw-debugger.theme-dark .panel-rows>div:nth-of-type(2n){background-color:#212121}tw-debugger .panel-row-buttons{text-align:right}tw-debugger .panel-variables .panel-rows:empty::before{content:"~ No variables ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-enchantments .panel-rows:empty::before{content:"~ No enchantments ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-errors .panel-rows:empty::before{content:"~ No errors... for now. ~";font-style:italic;color:#575757;text-align:center}tw-debugger .panel-errors .panel-rows:empty+.panel-errors-bottom{display:none}tw-debugger.theme-dark .panel-variables .panel-rows:empty::before,tw-debugger.theme-dark .panel-enchantments .panel-rows:empty::before,tw-debugger.theme-dark .panel-errors .panel-rows:empty::before{color:#a8a8a8}tw-debugger .panel-rows:empty+.panel-variables-bottom{display:none}tw-debugger th[data-col]{text-decoration:underline;cursor:pointer}tw-debugger th[data-col][data-order=asc]::after{content:"↓"}tw-debugger th[data-col][data-order=desc]::after{content:"↑"}tw-debugger .panel-storylets:not(.panel-exclusive) .storylet-exclusive,tw-debugger .panel-storylets:not(.panel-urgent) .storylet-urgent{display:none}tw-debugger .storylet-exclusive,tw-debugger .storylet-urgent,tw-debugger .storylet-open{text-align:center}tw-debugger .panel-variables-bottom{padding-top:5px}tw-debugger .enchantment-row{min-height:1.5em}tw-debugger .variable-path{opacity:.4}tw-debugger .temporary-variable-scope,tw-debugger .enchantment-local{font-family:sans-serif;font-weight:normal;opacity:.8;font-size:.75em}tw-debugger .temporary-variable-scope:not(:empty)::before,tw-debugger .enchantment-local:not(:empty)::before{content:" in "}tw-debugger .variable-name,tw-debugger .enchantment-name{font-family:monospace;font-weight:bold}tw-debugger .variable-type{color:#575757;font-weight:normal;text-overflow:ellipsis;overflow:hidden;max-width:10em}tw-debugger.theme-dark .variable-type{color:#a8a8a8}tw-debugger .error-row{display:table-row;background-color:rgba(230,101,204,.3)}tw-debugger .error-row:nth-of-type(2n){background-color:rgba(237,145,219,.3)}tw-debugger .error-row>*{display:table-cell;padding:.25em .5em}tw-debugger .error-row .error-message[title]:not([title=""]){cursor:help}tw-debugger .error-row .error-passage{color:#575757}tw-debugger.theme-dark .error-row .error-passage{color:#a8a8a8}tw-debugger .storylet-row{background-color:rgba(193,240,225,.3)}tw-debugger .storylet-row:nth-child(2n){background-color:rgba(152,231,204,.3)}tw-debugger .storylet-row.storylet-closed{font-style:italic;background-color:#fff}tw-debugger .storylet-row.storylet-closed:nth-child(2n){background-color:#e6e6e6}tw-debugger .storylet-row.storylet-closed>:not(.storylet-lambda){opacity:.6}.storylet-error tw-debugger .storylet-row{background-color:rgba(230,101,204,.3)}.storylet-error tw-debugger .storylet-row:nth-child(2n){background-color:rgba(237,145,219,.3)}tw-debugger .storylet-row .storylet-name,tw-debugger .storylet-row .storylet-value{display:inline-block;width:50%}tw-debugger .storylet-row .storylet-lambda{font-family:monospace;font-size:1rem;white-space:pre-wrap;overflow-wrap:anywhere}tw-debugger.theme-dark .storylet-row.storylet-closed{background-color:#000}tw-debugger.theme-dark .storylet-row.storylet-closed:nth-child(2n){background-color:#212121}tw-debugger .tabs{padding-bottom:.5em}tw-debugger .tab{border-radius:0px 0px .5em .5em;border-top:none;top:-2px}tw-debugger .resizer-h{position:absolute;height:14em;border-left:2px solid #999;border-right:2px solid #999;top:10px;left:4px;width:8px;cursor:ew-resize}tw-debugger.theme-dark .resizer-h{border-color:rgba(0,0,0,0) #666}tw-debugger .resizer-v{position:absolute;height:8px;border-top:2px solid #999;border-bottom:2px solid #999;margin-bottom:4px;top:4px;left:10px;width:95%;cursor:ns-resize;box-sizing:border-box}tw-debugger.theme-dark .resizer-v{border-color:#666 rgba(0,0,0,0)}tw-debugger mark{color:inherit;background-color:rgba(101,230,230,.3) !important}tw-dialog{z-index:999997;border:#fff solid 2px;padding:2em;color:#fff;background-color:#000;display:block}@media(min-width: 576px){tw-dialog{max-width:50vw}}tw-dialog input[type=text]{font-size:inherit;width:100%;border:solid #fff !important}tw-dialog-links{text-align:right;display:-ms-flexbox;display:flex;-ms-flex-pack:end;justify-content:flex-end}tw-backdrop{z-index:999996;position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.8);display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center}tw-backdrop~tw-backdrop{display:none}tw-link,.enchantment-link{cursor:pointer;color:#4169e1;font-weight:bold;text-decoration:none;transition:color .2s ease-in-out}tw-passage [style^=color] tw-link:not(:hover),tw-passage [style*=" color"] tw-link:not(:hover),tw-passage [style^=color][hover=true] tw-link:hover,tw-passage [style*=" color"][hover=true] tw-link:hover,tw-passage [style^=color] .enchantment-link:not(:hover),tw-passage [style*=" color"] .enchantment-link:not(:hover),tw-passage [style^=color][hover=true] .enchantment-link:hover,tw-passage [style*=" color"][hover=true] .enchantment-link:hover{color:inherit}tw-link:hover,.enchantment-link:hover{color:#00bfff}tw-link:active,.enchantment-link:active{color:#dd4b39}.visited{color:#6941e1}tw-passage [style^=color] .visited:not(:hover),tw-passage [style*=" color"] .visited:not(:hover),tw-passage [style^=color][hover=true] .visited:hover,tw-passage [style*=" color"][hover=true] .visited:hover{color:inherit}.visited:hover{color:#e3e}tw-broken-link{color:#933;border-bottom:2px solid #933;cursor:not-allowed}tw-passage [style^=color] tw-broken-link:not(:hover),tw-passage [style*=" color"] tw-broken-link:not(:hover),tw-passage [style^=color][hover=true] tw-broken-link:hover,tw-passage [style*=" color"][hover=true] tw-broken-link:hover{color:inherit}tw-link.enchantment-mouseover,.link.enchantment-mouseover,tw-expression.enchantment-mouseover>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;border-bottom:2px dashed #999}tw-link.enchantment-mouseover:hover,tw-link.enchantment-mouseover:active,.link.enchantment-mouseover:hover,.link.enchantment-mouseover:active,tw-expression.enchantment-mouseover>tw-link:hover,tw-expression.enchantment-mouseover>tw-link:active{color:inherit}tw-link.enchantment-mouseover.enchantment-button,.link.enchantment-mouseover.enchantment-button,tw-expression.enchantment-mouseover>tw-link.enchantment-button{border-style:dashed}tw-link.enchantment-mouseout,.link.enchantment-mouseout,tw-expression.enchantment-mouseout>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;border:rgba(64,149,191,.6) 1px solid;border-radius:.2em}tw-link.enchantment-mouseout:hover,tw-link.enchantment-mouseout:active,.link.enchantment-mouseout:hover,.link.enchantment-mouseout:active,tw-expression.enchantment-mouseout>tw-link:hover,tw-expression.enchantment-mouseout>tw-link:active{color:inherit}tw-link.enchantment-mouseout:hover,.link.enchantment-mouseout:hover,tw-expression.enchantment-mouseout>tw-link:hover{background-color:rgba(175,197,207,.75);border:rgba(0,0,0,0) 1px solid}tw-link.enchantment-dblclick,.link.enchantment-dblclick,tw-expression.enchantment-dblclick>tw-link{color:inherit;font-weight:inherit;transition:none;cursor:inherit;cursor:pointer;border:2px solid #999;border-radius:0}tw-link.enchantment-dblclick:hover,tw-link.enchantment-dblclick:active,.link.enchantment-dblclick:hover,.link.enchantment-dblclick:active,tw-expression.enchantment-dblclick>tw-link:hover,tw-expression.enchantment-dblclick>tw-link:active{color:inherit}tw-link.enchantment-dblclick:active,.link.enchantment-dblclick:active,tw-expression.enchantment-dblclick>tw-link:active{background-color:#999}tw-link.enchantment-button,.link.enchantment-button,.enchantment-button:not(.link) tw-link,.enchantment-button:not(.link) .link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block}.enchantment-button{display:block}.enchantment-clickblock{cursor:pointer;width:100%;height:100%;display:block}.enchantment-clickblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;color:rgba(65,105,225,.5);transition:color .2s ease-in-out}.enchantment-clickblock>:not(tw-enchantment):hover::after{color:rgba(0,191,255,.5)}.enchantment-clickblock>:not(tw-enchantment):active::after{color:rgba(222,78,59,.5)}.enchantment-clickblock>:not(tw-enchantment)::after{box-shadow:inset 0 0 0 .5vmax}.enchantment-clickblock>tw-passage::after,.enchantment-clickblock>tw-sidebar::after{box-shadow:0 0 0 .5vmax}.enchantment-mouseoverblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:2px dashed #999}.enchantment-mouseoutblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;border:rgba(64,149,191,.6) 2px solid}.enchantment-mouseoutblock:hover>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;background-color:rgba(175,197,207,.75);border:rgba(0,0,0,0) 2px solid;border-radius:.2em}.enchantment-dblclickblock>:not(tw-enchantment)::after{content:"";width:100%;height:100%;top:0;left:0;display:block;box-sizing:border-box;position:absolute;pointer-events:none;cursor:pointer;border:2px solid #999}tw-dialog-links{padding-top:1.5em}tw-dialog-links tw-link{border-radius:16px;border-style:solid;border-width:2px;text-align:center;padding:0px 8px;display:block;display:inline-block}html{margin:0;height:100%;overflow-x:hidden}*,:before,:after{position:relative;box-sizing:inherit}body{margin:0;height:100%}tw-storydata{display:none}tw-story{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column;font:100% Georgia,serif;box-sizing:border-box;width:100%;min-height:100%;font-size:1.5em;line-height:1.5em;padding:5% 5%;overflow:hidden;background-color:#000;color:#fff}tw-story [style*=content-box] *{box-sizing:border-box}@media(min-width: 576px){tw-story{padding:5% 20%}}tw-story tw-consecutive-br{display:block;height:1.6ex;visibility:hidden}tw-story select{background-color:rgba(0,0,0,0);font:inherit;border-style:solid;padding:2px}tw-story select:not([disabled]){color:inherit}tw-story textarea{resize:none;background-color:rgba(0,0,0,0);font:inherit;color:inherit;border-style:none;padding:2px}tw-story input[type=text]{background-color:rgba(0,0,0,0);font:inherit;color:inherit;border-style:none}tw-story input[type=checkbox]{transform:scale(1.5);margin:0 .5em .5em .5em;vertical-align:middle}tw-story tw-noscript{animation:appear .8s}tw-passage{display:block}tw-sidebar{text-align:center;display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between}@media(min-width: 576px){tw-sidebar{left:-5em;width:3em;position:absolute;-ms-flex-direction:column;flex-direction:column}tw-enchantment[style*=width]>tw-sidebar{width:inherit}}tw-icon{display:inline-block;margin:.5em 0;font-size:66px;font-family:"Verdana",sans-serif}tw-icon[alt]{opacity:.2;cursor:pointer}tw-icon[alt]:hover{opacity:.4}tw-icon[data-label]::after{font-weight:bold;content:attr(data-label);font-size:20px;bottom:-20px;left:-50%;white-space:nowrap}tw-meter{display:block}tw-hook:empty,tw-expression:empty{display:none}tw-error{display:inline-block;border-radius:.2em;padding:.2em;font-size:1rem;cursor:help;white-space:pre-wrap}tw-error.error{background-color:rgba(223,58,190,.6);color:#fff}tw-error.warning{background-color:rgba(223,140,58,.6);color:#fff;display:none}.debug-mode tw-error.warning{display:inline}tw-error-explanation{display:block;font-size:.8rem;line-height:1rem}tw-open-button,tw-folddown{cursor:pointer;line-height:0em;border-radius:4px;border:1px solid rgba(255,255,255,.5);font-size:.8rem;margin:0 .2rem;padding:3px;white-space:pre}tw-folddown::after{content:"▶"}tw-folddown.open::after{content:"▼"}tw-open-button[replay]{display:none}tw-error tw-open-button,tw-eval-replay tw-open-button{display:inline !important}tw-open-button::after{content:attr(label)}tw-notifier{border-radius:.2em;padding:.2em;font-size:1rem;background-color:rgba(223,182,58,.4);display:none}.debug-mode tw-notifier{display:inline}tw-notifier::before{content:attr(message)}tw-colour{border:1px solid #000;display:inline-block;width:1em;height:1em}tw-enchantment:empty{display:none}h1{font-size:3em}h2{font-size:2.25em}h3{font-size:1.75em}h1,h2,h3,h4,h5,h6{line-height:1em;margin:.3em 0 .6em 0}pre{font-size:1rem;line-height:initial}small{font-size:70%}big{font-size:120%}mark{color:rgba(0,0,0,.6);background-color:#ff9}ins{color:rgba(0,0,0,.6);background-color:rgba(255,242,204,.5);border-radius:.5em;box-shadow:0em 0em .2em #ffe699;text-decoration:none}center{text-align:center;margin:0 auto;width:60%}blink{text-decoration:none;animation:fade-in-out 1s steps(1, end) infinite alternate}tw-align{display:block}tw-columns{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;-ms-flex-pack:justify;justify-content:space-between}.transition-in{animation:appear 0ms step-start}.transition-out{animation:appear 0ms step-end}[data-t8n^=dissolve].transition-in,[data-t8n=fade].transition-in{animation:appear .8s}[data-t8n^=dissolve].transition-out,[data-t8n=fade].transition-out{animation:appear .8s reverse}[data-t8n^=shudder].transition-in{display:inline-block !important;animation:shudder-in .8s}[data-t8n^=shudder].transition-out{display:inline-block !important;animation:shudder-in .8s reverse}[data-t8n^=rumble].transition-in{display:inline-block !important;animation:rumble-in .8s}[data-t8n^=rumble].transition-out{display:inline-block !important;animation:rumble-in .8s reverse}[data-t8n^=pulse].transition-in{animation:pulse .8s;display:inline-block !important}[data-t8n^=pulse].transition-out{animation:pulse .8s reverse;display:inline-block !important}[data-t8n^=zoom].transition-in{animation:zoom-in .8s;display:inline-block !important}[data-t8n^=zoom].transition-out{animation:zoom-in .8s reverse;display:inline-block !important}[data-t8n^=blur].transition-in{animation:blur .8s;display:inline-block !important}[data-t8n^=blur].transition-out{animation:blur .8s reverse;display:inline-block !important}[data-t8n^=slideleft].transition-in{animation:slide-left .8s;display:inline-block !important}[data-t8n^=slideleft].transition-out{animation:slide-right .8s reverse;display:inline-block !important}[data-t8n^=slideright].transition-in{animation:slide-right .8s;display:inline-block !important}[data-t8n^=slideright].transition-out{animation:slide-left .8s reverse;display:inline-block !important}[data-t8n^=slideup].transition-in{animation:slide-up .8s;display:inline-block !important}[data-t8n^=slideup].transition-out{animation:slide-down .8s reverse;display:inline-block !important}[data-t8n^=slidedown].transition-in{animation:slide-down .8s;display:inline-block !important}[data-t8n^=slidedown].transition-out{animation:slide-up .8s reverse;display:inline-block !important}[data-t8n^=fadeleft].transition-in{animation:fade-left .8s;display:inline-block !important}[data-t8n^=fadeleft].transition-out{animation:fade-right .8s reverse;display:inline-block !important}[data-t8n^=faderight].transition-in{animation:fade-right .8s;display:inline-block !important}[data-t8n^=faderight].transition-out{animation:fade-left .8s reverse;display:inline-block !important}[data-t8n^=fadeup].transition-in{animation:fade-up .8s;display:inline-block !important}[data-t8n^=fadeup].transition-out{animation:fade-down .8s reverse;display:inline-block !important}[data-t8n^=fadedown].transition-in{animation:fade-down .8s;display:inline-block !important}[data-t8n^=fadedown].transition-out{animation:fade-up .8s reverse;display:inline-block !important}[data-t8n^=flicker].transition-in{animation:flicker .8s}[data-t8n^=flicker].transition-out{animation:flicker .8s reverse}
</style>
</head>
<body>
<tw-story><noscript><tw-noscript>JavaScript needs to be enabled to play Masks of Mayhem.</tw-noscript></noscript></tw-story>
<tw-storydata name="Masks of Mayhem" startnode="3" creator="Twine" creator-version="2.10.0" format="Harlowe" format-version="3.3.9" ifid="B4FE8691-3167-49ED-BC0D-F79E9FFD2AC3" options="" tags="" zoom="1" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">body, tw-story, tw-sidebar {
  font-family: Palatino, "Palatino LT STD", "Palatino Linotype", "Book Antiqua", Georgia, serif;
}

tw-sidebar {
    display: flex;
    left: -15em;
    width: 12.5em;
    text-align: left;
}

tw-sidebar [name="meter"]+br {
    display: none;
}

tw-story {
	padding: 5% 15% 5% 30%;
}

tw-story br { content: ""; display: block; margin: 1rem 0; }
tw-sidebar br { content: none; margin: 0; }

tw-link, .enchantment-link {
    color: #fff;
    border-bottom: 1px dotted #ddd;
}

tw-include[type="startup"] {
  display: none;
}

.visited {
  color: white;
}
.visited:hover {
  color: #00bfff;
}

tw-include[title="MOBILE TOGGLE"] {
  display: none;
}
span.ellipsis {
    white-space: nowrap;
}

a {
	color: #fff;
	font-weight: bold;
}
a:hover {
    color: #00bfff;
}
@media only screen and (max-width: 1023px) {
  body, tw-story, tw-sidebar {
	font-size: 1.2rem;
	line-height: 1.4;
  }
  tw-sidebar {
    position: fixed;
    left: -100vh;
    top: 0;
    width: 85vw;
    height: 100vh;
    z-index: 2;
    background-color: #222;
    transition: left 0.3s;
	padding: 60px 15px;
  }
  tw-sidebar.open {
	left: 0;
  }
  tw-include[title="MOBILE TOGGLE"] {
	  position: fixed;
	  z-index: 10;
	  display: block;
	  text-align: center;
	  line-height: 50px;
	  font-size: 30px;
	  right: 15px;
	  bottom: 15px;
	  width: 60px;
	  height: 60px;
	  background-color: #aaa;
	  border: 1px solid #fff;
	  border-radius: 100%;
 	  cursor: pointer;
  }
  tw-story {
	padding: 60px 15px 120px;
  }
}	
@media only screen and (min-width: 1024px) {
	tw-sidebar {
  		height: 80vh;
		overflow-y: auto;
	}
}

tw-sidebar .inventory {
  border-top: 1px solid #404040;
  border-bottom: 1px solid #404040;
  padding: 1em 0;
  margin: 1em 0;
}


/* Hunt the Tiger */

table.tiger-moves td:first-child {
	width: 4%;
}

table.tiger-moves td:nth-child(2) {
	width: 54%;
}
table.tiger-moves td:nth-child(3) {
	width: 42%;
}


.tiger-grid tw-hook {
  font-size: 1em;
  line-height: 1;
}

.tiger-cell {
  height: 40px;
  width: 40px;
  display: inline-block;
  text-align: center;
  border: 1px solid white;
}

.tiger-cell.tiger-location {
  background: orange;
}

.tiger-cell.player-location {
  background: green;
}</style><script role="script" id="twine-user-script" type="text/twine-javascript"></script><tw-tag name="death" color="red"></tw-tag><tw-tag name="combat" color="orange"></tw-tag><tw-tag name="item" color="yellow"></tw-tag><tw-tag name="key" color="green"></tw-tag><tw-tag name="to-do" color="green"></tw-tag><tw-passagedata pid="1" name="Combat Container" tags="" position="100,475" size="100,100">[{
    (if: $combat&#39;s opponents is not an empty)[
        (set: $combat&#39;s round to 0)
        (if: $combat&#39;s opponents&#39;s 1st contains &#39;special_precombat&#39;)[(display: $combat&#39;s opponents&#39;s 1st&#39;s special_precombat)]
        (display: $combat&#39;s loop)
    ]
}]&lt;combat_container|</tw-passagedata><tw-passagedata pid="2" name="Startup" tags="startup" position="600,200" size="100,100">{[
	(set: $game to (dm: &quot;page&quot;, 1))
  
  	(set: $combat to (dm:))
    (set: $combat&#39;s loop to &quot;Sequential Combat Loop&quot;)
    (set: $combat&#39;s round to 0)
    (set: $combat&#39;s opponents to (a:))
  
    (set: $player to (dm:))
    
    (set: $player&#39;s damage to 2)
    ($ROLL:)
    (set: $player&#39;s initial_skill to 6 + $die1)
    (set: $player&#39;s initial_luck to 6 + $die2)
    ($ROLL:)
    (set: $player&#39;s initial_stamina to 12 + $die1 + $die2)

    (set: $player&#39;s skill to $player&#39;s initial_skill)
    (set: $player&#39;s stamina to $player&#39;s initial_stamina)
    (set: $player&#39;s luck to $player&#39;s initial_luck)
    
    (set: $player&#39;s inventory to (ds:))
    (set: $player&#39;s gold to 0)
    (set: $player&#39;s provisions to 10)
    (set: $player&#39;s provision_strength to 4)
    (set: $player&#39;s has_eaten to false)

	(set: $PAGE to (macro: int-type _page, str-type _label,  [{
		(output:)[(link-reveal: _label)[(set: $game&#39;s page to _page)(rerun:?main_loop)]]
    }]))
]}</tw-passagedata><tw-passagedata pid="3" name="Page 1" tags="" position="2150,200" size="200,200">Before setting off, you enter the armoury.  Kevin Truehand, your trusted but now aged armourer, has been honing your sword and burnishing your helmet, with its strangely simple device.  This helmet has been handed from generation to generation of rulers of Arion, and legend has it that if it were ever to fall into the wrong hands, chaos would stalk the streets of your city.($add_item: &quot;Helmet of Arion&quot;)

As you put on your helmet and buckle your sword to your belt, Truehand whispers to you, as if afraid that someone might hear: &#39;Majesty, seek first the castle of Hever, lord of Fallow Dale.  For you are bound for Krill Garnash, where evil dwells, and Hever has a horn which strikes terror into any evil heart.  Therefore I say: seek the halls of Hever, and win from him, however you can, this precious horn.&#39;

With that he turns aside, and you set out, through the paved streets of Arion and out of the northern gateway - the [[Gate of Skulls-&gt;Page 53]].</tw-passagedata><tw-passagedata pid="4" name="Page 43" tags="combat" position="3100,7025" size="100,100">You meet the alligator head on.  It is not evil, so the Horn of Hever will have no effect on it, and you must reduce your skill by one point for this fight, because the water hampers your movements. ($SKILL: -1){==
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Alligator&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
        &quot;alignment&quot;, &quot;neutral&quot;,
	)
))(display: &quot;Combat Container&quot;)
|victory)[($SKILL: 1)If you win, you [[swim across-&gt;Page 393]] to the northern shore.]</tw-passagedata><tw-passagedata pid="5" name="Sequential Combat Loop" tags="" position="100,600" size="100,100">{==
|before_combat&gt;[]
|combat_loop&gt;[
	[(display: &quot;List Opponents Sequentially&quot;)]&lt;list_opponents_container|
	[(display: &quot;Combat Action&quot;)]&lt;combat_action_container|
	[(display: &quot;Combat Results&quot;)]&lt;combat_results_container|
	[(display: &quot;Combat Next&quot;)]&lt;combat_next_container|
]
|after_combat&gt;[]</tw-passagedata><tw-passagedata pid="6" name="List Opponents Sequentially" tags="" position="225,600" size="100,100">|opponents&gt;[{&lt;ol&gt;
	(for: each _i, ...(range:1, $combat&#39;s opponents&#39;s length))[
		(set: _monster to $combat&#39;s opponents&#39;s _i)
        (set: _prefix to _monster&#39;s prefix)
        (set: _name to _monster&#39;s name)
        (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
		&lt;li class=&quot;monster&quot;&gt;
			&lt;span&gt;(print: _prefixed_name):&lt;/span&gt;
			|monster_stats&gt;[&lt;span&gt;SKILL (print: _monster&#39;s skill)&lt;/span&gt;
			&lt;span&gt;STAMINA (print: _monster&#39;s stamina)&lt;/span&gt;]
            
			(if: _i is 1)[
				(link: &quot;Attack!&quot;)[{
					(set: $targeted_monster to _i)
					(rerun: ?combat_action)(show: ?combat_action)
				}]&lt;attack_action|
			]
		&lt;/li&gt;
	]
&lt;/ol&gt;}]</tw-passagedata><tw-passagedata pid="7" name="Combat Results" tags="" position="475,600" size="100,100">|combat_results)[{
	(set: _damage to 2)
    (if: $player&#39;s attack_strength is $target&#39;s attack_strength)[
    	You dodge each other&#39;s blows.
        (rerun: ?combat_on_dodge)(show: ?combat_on_dodge)
    ](else-if: $player&#39;s attack_strength &gt; $target&#39;s attack_strength)[
        (if: $player contains &quot;damage&quot;)[(set: _damage to $player&#39;s damage)]
    	You hit it for (print: _damage) damage!
        (set: $target&#39;s stamina to it - _damage)
        (if: $target&#39;s stamina &gt; 0)[{
            (link-replace:&quot;Test your luck?&quot;)[($TEST_YOUR_LUCK:)(rerun: ?combat_next)]
            |lucky)[Lucky! Deal +1 damage!(set: $target&#39;s stamina to it - 1)]
            |unlucky)[Unlucky! Deal -1 damage!(set: $target&#39;s stamina to it + 1)]
        }](else:)[
        	The blow is fatal!
        ]
        (rerun: ?combat_on_target_hit)(show: ?combat_on_target_hit)
    ](else:)[
        (if: $target contains &quot;damage&quot;)[(set: _damage to $target&#39;s damage)]
        It wounds you - deduct (print: _damage) STAMINA!
        (set: $player&#39;s stamina to it - _damage)
        (link-replace:&quot;Test your luck?&quot;)[($TEST_YOUR_LUCK:)(rerun: ?combat_next)]
        |lucky)[Lucky! Take -1 damage!(set: $player&#39;s stamina to it + 1)]
        |unlucky)[Unlucky! Take +1 damage!(set: $player&#39;s stamina to it - 1)]
        (rerun: ?combat_on_player_hit)(show: ?combat_on_player_hit)
    ]
	(show: ?combat_next)
}]</tw-passagedata><tw-passagedata pid="8" name="Combat Action" tags="" position="350,600" size="100,100">|combat_action)[{
    (set: $target to $combat&#39;s opponents&#39;s $targeted_monster)

    (set: _article to $target&#39;s article)
    (set: _prefix to $target&#39;s prefix)
    (set: _name to $target&#39;s name)
    (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
    (set: _the_monster to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _article, _prefixed_name)))

	&lt;span class=&quot;attack&quot;&gt;You attack (print: _the_monster).&lt;/span&gt;

    (set: $player&#39;s attack_strength to $player&#39;s skill + ($ROLL2:))
    |==
    &lt;p&gt;Rolling for Attack Strength: $die1 + $die2 = (print: $die1 + $die2).&lt;br/&gt;
    Your Attack Strength is (print: $player&#39;s attack_strength).&lt;/p&gt;
    (set: $target&#39;s attack_strength to $target&#39;s skill + ($ROLL2:))
    ==|
    &lt;p&gt;(uppercase: $target&#39;s name)&#39;s Attack Strength: $die1 + $die2 = (print: $die1 + $die2).&lt;br/&gt;
    (uppercase: $target&#39;s name)&#39;s Attack Strength is (print: $target&#39;s attack_strength).&lt;/p&gt;

    (if: $target contains &quot;special_attack&quot;)[(display: $target&#39;s special_attack)]
	|==|
    (show: ?combat_results)
}]</tw-passagedata><tw-passagedata pid="9" name="Combat Next" tags="" position="600,600" size="100,100">|combat_next)[{
    (set: _article to $target&#39;s article)
    (set: _prefix to $target&#39;s prefix)
    (set: _name to $target&#39;s name)
    (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
    (if: $player&#39;s stamina &lt;= 0)[
        Your wounds are fatal.  Your adventure ends here.
    ](else-if: $target&#39;s stamina &lt;= 0)[
    	&lt;p&gt;(print: _prefixed_name) is defeated!&lt;/p&gt;
        (set: _update to $combat&#39;s opponents - (a: $combat&#39;s opponents&#39;s $targeted_monster))
        (set: $combat&#39;s opponents to _update)
        (if: _update is not an empty)[
        	(if: _update&#39;s 1st contains &quot;special_precombat&quot;)[(display: _update&#39;s 1st&#39;s special_precombat)]
        ]
    ](else:)[
        (set: $combat&#39;s opponents&#39;s ($targeted_monster) to $target)
    ]
    (if: $player&#39;s stamina &gt; 0)[
      (if: $combat&#39;s opponents is not an empty)[
          &lt;p&gt;(link-reveal:&quot;Combat continues... &quot;)[(set: $combat&#39;s round to it + 1)(rerun: ?combat_loop)]&lt;/p&gt;
      ](else:)[
          (show: ?victory)
      ]
    ]
	(rerun: ?post_combat_next)(show: ?post_combat_next)
}]</tw-passagedata><tw-passagedata pid="10" name="Page 53" tags="" position="2200,425" size="100,100">Truehand&#39;s advice seems sound.  Not far north of Arion is the vast Lake Nekros; just north of the lake lies Fallow Dale.  From there you could head north and slightly east over Pikestaff Plain, leaving Marsh Vile to the west, and through the foothills and mountains, until you came to Krill Garnash itself, with its five ice-capped peaks lost in the clouds.

After a few days of easy travel, with springs and game so plentiful that you still have all your Provisions, you reach the southern shore of Lake Nekros, and the end of civilization as you know it.  Beyond this, the ways are unknown to the people of Arion.

Within memory Lake Nekros has never been crossed.  People speak of unfathomable depths spawning hideous monsters, and of strange and mysterious winds and currents which turn the chill, still waters into whirlpools and ungovernable waves.  Nevertheless, your most direct route is across it.  Will you, bold hero that you are, [[build a raft-&gt;Page 109]] and embark across the lake, or strike out around its [[eastern edge-&gt;Page 245]], through rolling hills, or around its [[western edge-&gt;Page 21]], through Affen Forest?</tw-passagedata><tw-passagedata pid="11" name="Page 109" tags="death" position="2200,550" size="100,100">Night has fallen by the time you have completed your raft.  Strangely, when you launch it, no ripples disturb the surface of the lake; and the gibbous moon is not reflected in its dark depths.  You have paddled no more than a hundred metres when five thick tentacles pull you for ever under the water.</tw-passagedata><tw-passagedata pid="12" name="Page 245" tags="" position="2900,550" size="100,100">You set off through the hills on the first stage of your hazardous journey.  Tiny animals disturb the grass and sorrel; the few trees have been bent into grotesque shapes by decades of wind.  You can put some (link-reveal:&quot;sorrel&quot;)[($add_item: &quot;Sorrel&quot;)] in your pack, if you want.

The sun sinks gradually below the forest-shrouded hills on the far side of the lake as you continue northwards.  Will you [[camp here-&gt;Page 230]] by the lakeside, or [[carry on-&gt;Page 303]] through the deepening dusk?</tw-passagedata><tw-passagedata pid="13" name="Page 21" tags="" position="1400,550" size="100,100">(set: $player&#39;s has_eaten to false)Before long, you reach the first trees.  As you walk through the forest, keeping the lake in sight on your right hand, the evergreen trees get older and taller: their branches form a dark canopy above your head, through which only the occasional beam of sunlight breaks.  Even these welcome shafts die out as you continue northwards on the first leg of your hazardous journey -- but only because night is beginning to fall.  Will you [[camp here-&gt;Page 316]] by the lakeside, or [[carry on-&gt;Page 242]] through the deepening dusk?</tw-passagedata><tw-passagedata pid="14" name="SIDEBAR" tags="header" position="100,200" size="100,100">(replace: ?sidebar)[{
	[(display: &quot;STATS&quot;)]&lt;sidebar_stats|
	[(display: &quot;INVENTORY&quot;)]&lt;sidebar_inventory|
	(if: (history:)&#39;s length &gt; 0)[{(link: &quot;RESTART&quot;)[(restart:)]&lt;br/&gt;}]
	(if: $savemode is true)[(display: &quot;SAVE&quot;)]
}]&lt;my_sidebar|</tw-passagedata><tw-passagedata pid="15" name="STATS" tags="" position="225,200" size="100,100">(meter: bind $player&#39;s skill, 12, &quot;X&quot;, &quot; SKILL: (str:$player&#39;s skill) / (str:$player&#39;s initial_skill)&quot;, #d0b000)
(meter: bind $player&#39;s stamina, 24, &quot;X&quot;, &quot; STAMINA: (str:$player&#39;s stamina) / (str:$player&#39;s initial_stamina)&quot;, #00b000)
(meter: bind $player&#39;s luck, 12, &quot;X&quot;, &quot; LUCK: (str:$player&#39;s luck) / (str:$player&#39;s initial_luck)&quot;, blue)</tw-passagedata><tw-passagedata pid="16" name="INVENTORY" tags="" position="350,200" size="100,100">{==
|inventory&gt;[&lt;div class=&quot;inventory&quot;&gt;INVENTORY
&lt;ul&gt;(for: each _item, ...$player&#39;s inventory)[{
(if: _item is &quot;Potion of Skill&quot;)[(display: &quot;POTION OF SKILL&quot;)]
(elseif: _item is &quot;Potion of Strength&quot;)[(display: &quot;POTION OF STRENGTH&quot;)]
(elseif: _item is &quot;Potion of Fortune&quot;)[(display: &quot;POTION OF FORTUNE&quot;)]
(elseif: _item is &quot;Horn of Hever&quot;)[(display: &quot;HORN OF HEVER&quot;)]
(else:)[&lt;li&gt;(print: _item)&lt;/li&gt;]
}]
(if: $player&#39;s gold &gt; 0)[{&lt;li&gt;(plural: $player&#39;s gold, &quot;Gold Piece&quot;)&lt;/li&gt;}]
|sidebar_provisions&gt;[(if: $player&#39;s provisions &gt; 0)[(display: &quot;PROVISIONS&quot;)]]
&lt;/ul&gt;&lt;/div&gt;]</tw-passagedata><tw-passagedata pid="17" name="FUNCTIONS" tags="startup" position="100,325" size="100,100">(set: $ROLL to (macro: [(output:)[{
    (set: $die1 to (random: 1, 6))(set: $die2 to (random: 1, 6))(set: $total to $die1 + $die2)
}]]))
(set: $ROLL1 to (macro:[{($ROLL:)(output-data:$die1)}]))
(set: $ROLL2 to (macro:[{($ROLL:)(output-data:$die1 + $die2)}]))

(set: $TEST_YOUR_LUCK to (macro:[{
	(set: _roll to ($ROLL2:))
	(set: _lucky to _roll &lt;= $player&#39;s luck)
	(set: $player&#39;s luck to (max: 0, it - 1))
	(set: _label to (cond: _lucky, &quot;Lucky!&quot;, &quot;Unlucky!&quot;))
	(output:)[{
		(dialog: [You roll (print: $die1) + (print: $die2)], _label)(if: _lucky)[(show: ?lucky)](if: not _lucky)[(show:?unlucky)]
	}]
}]))
(set: $test_your_luck to (macro:[{
    (output:)[(link-reveal:&#39;&lt;i class=&quot;testyourluck&quot;&gt;Test your Luck&lt;/i&gt;&#39;)[($TEST_YOUR_LUCK:)]]
}]))
(set: $STAMINA to (macro: num-type _amount, [ \
	(set: $player&#39;s stamina to (min: it + _amount, $player&#39;s initial_stamina))(output:)[(if: $player&#39;s stamina &lt;= 0)[(go-to: &quot;INSTADEATH&quot;)](rerun:?sidebar_stats)]]))
(set: $SKILL to (macro: num-type _amount, [ \
	(set: $player&#39;s skill to (min: it + _amount, $player&#39;s initial_skill))(output:)[(rerun:?sidebar_stats)]]))
(set: $LUCK to (macro: num-type _amount, [ \
	(set: $player&#39;s luck to (max: 0, (min: it + _amount, $player&#39;s initial_luck)))(output:)[(rerun:?sidebar_stats)]]))
(set: $GOLD to (macro: num-type _amount, [ \
	(set: $player&#39;s gold to (max: 0, it + _amount))(output:)[(rerun:?sidebar_inventory)]]))
(set: $PROVISIONS to (macro: num-type _amount, [ \
	(set: $player&#39;s provisions to (max: 0, it + _amount))(output:)[(rerun:?sidebar_inventory)]]))
(set: $dotdotdot to (macro: str-type _text, [ \
	(output:)[&lt;span class=&quot;ellipsis&quot;&gt;_text . . .&lt;/span&gt;]]))
(set: $add_item to (macro: str-type _item, [{
	(set: $player&#39;s inventory to it + (ds: _item))
	(output:)[]
}]))
(set: $add_item to (macro: str-type _item, [{
	(set: $player&#39;s inventory to it + (ds: _item))
	(output:)[(rerun:?inventory)]
}]))
(set: $remove_item to (macro: str-type _item, [{
	(set: $player&#39;s inventory to it - (ds: _item))
	(output:)[(rerun:?inventory)]
}]))
</tw-passagedata><tw-passagedata pid="18" name="INSTADEATH" tags="" position="225,325" size="100,100">&lt;p&gt;Your STAMINA has fallen to zero: your journey is at an end.&lt;/p&gt;
[==</tw-passagedata><tw-passagedata pid="19" name="Page 316" tags="" position="1275,675" size="100,100">There is plenty of dry wood around to start a fire with your flints and tinder, and soon you have a merry blaze going.  You chew on some nuts and drink some water from your flask.  Will you [[refill your flask-&gt;Page 67]] with water from the lake, or [[settle down to sleep-&gt;Page 226]] straight away?</tw-passagedata><tw-passagedata pid="20" name="Page 242" tags="" position="1525,675" size="100,100">Will you [[keep close to the lake-&gt;Page 79]], where the trees are thinner and the bank offers a crude path, or [[turn slightly west-&gt;Page 171]] into the depths of the forest?</tw-passagedata><tw-passagedata pid="21" name="PROVISIONS" tags="" position="350,325" size="100,100">&lt;li&gt;(print: $player&#39;s provisions) x (link-rerun:&quot;Provisions&quot;)[{
	(if: $player&#39;s stamina &lt;= 0)[
		(dialog: &quot;You can&#39;t eat provisions now: you&#39;re dead!&quot;)
	](else-if: $player&#39;s stamina &gt;= $player&#39;s initial_stamina)[
		(dialog: &quot;You&#39;re already at full STAMINA.&quot;)
	](else-if: $combat&#39;s opponents is not an empty)[
		(dialog: &quot;You can&#39;t stop to eat provisions in combat!&quot;)
	]
    (else:)[
		($STAMINA: $player&#39;s provision_strength)
		($PROVISIONS: -1)
        (set: $player&#39;s has_eaten to true)
		(rerun:?inventory)
	]
}]&lt;/li&gt;</tw-passagedata><tw-passagedata pid="22" name="Page 230" tags="" position="2775,675" size="100,100">There is little wood around to make a fire, even though you&#39;ve got flints and tinder.  You chew on some harsh berries and wash the taste out of your mouth with water from your flask.  Will you [[refill your flask-&gt;Page 39]] with water from the lake, or [[settle down to sleep-&gt;Page 76]] straight away?</tw-passagedata><tw-passagedata pid="23" name="Page 303" tags="" position="3025,675" size="100,100">Night has well and truly fallen, and a gibbous moon is in the mid-heaven.  When you reach the top of one low mound, you see in the dell not far below you a camp-fire, burning bright and welcoming.  You see two humanoid shapes by the fire, but cannot quite make out to which race they belong.  Will you [[go down towards the fire-&gt;Page 89]] for a closer look, or [[skirt the region-&gt;Page 186]] and continue your journey?</tw-passagedata><tw-passagedata pid="24" name="Page 67" tags="" position="1150,800" size="100,100">You lie down on the bank and dip your flask into the water of a small inlet.  All seems fine at first, but when you next come to drink from your flask, you will find that the foul lake water has rotted it and made it useless.  Until you find another flask, your Provisions will restore only 3 STAMINA points instead of the usual 4.  You [[settle down to sleep-&gt;Page 226]], in blissful ignorance of your misfortune.
(set: $player&#39;s provision_strength to 3)</tw-passagedata><tw-passagedata pid="25" name="Page 226" tags="" position="1275,800" size="100,100">You sleep as deeply as if you had no cares in the world.  But in the small hours of the morning, something disturbs the quiet surface of the lake.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 257&quot;)]
|unlucky)[Unlucky &gt; (go-to: &quot;Page 280&quot;)]
|1)[==
[[Page 257]]
[[Page 280]]</tw-passagedata><tw-passagedata pid="26" name="Page 79" tags="" position="1525,800" size="100,100">The bank becomes increasingly boggy.  Will you now [[head left-&gt;Page 171]] through the forest, or [[continue-&gt;Page 97]] along the bank?</tw-passagedata><tw-passagedata pid="27" name="Page 171" tags="combat" position="1775,1175" size="100,100">You twist and turn your way through the undergrowth, but it does not seriously hinder you.  Then, with no forewarning, lights blaze from several trees.  You have stumbled into the camp of a band of Spriggans - you recognize them immediately from your childhood nurse&#39;s descriptions and warnings.  They are a grotesquely ugly branch of the fairy folk, who have not inherited the sweet disposition of their cousins.  They are cowardly thieves, who prefer to rob old women, but with their ability to bloat themselves to several times their normal diminutive size, they will make formidable foes even for you.  There are six of them, but if you defeat the first two, the others will run away.  The cowards approach one at a time. {==
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Spriggan&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Spriggan&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
	)
))(display: &quot;Combat Container&quot;) |victory)[If you win, your journey [[continues-&gt;Page 106]].]</tw-passagedata><tw-passagedata pid="28" name="Page 39" tags="" position="2650,800" size="100,100">You lie down on the bank and dip your flask into the water of a small inlet.  All seems fine at first, but when you next come to drink from your flask, you will find that the foul water of the lake has rotted it and made it useless.  Until you find another flask, your Provisions will restore only 3 STAMINA points, instead of the usual 4.  You [[settle down to sleep-&gt;Page 76]], in blissful ignorance of your misfortune.
(set: $player&#39;s provision_strength to 3)</tw-passagedata><tw-passagedata pid="29" name="Page 76" tags="" position="2775,800" size="100,100">You sleep as deeply as if you had no cares in the world.  But in the small hours of the morning, something disturbs the quiet surface of the lake.  ($test_your_luck:)
|lucky)[(go-to: &quot;Page 135&quot;)]
|unlucky)[Unlucky &gt; (go-to: &quot;Page 280&quot;)]
|1)[==
[[Page 135]]
[[Page 280]]</tw-passagedata><tw-passagedata pid="30" name="Page 89" tags="" position="3025,800" size="100,100">You trip over a rock on the way down, and tumble down the slope, landing on your feet in the circle of [[firelight-&gt;Page 254]].</tw-passagedata><tw-passagedata pid="31" name="Page 186" tags="" position="3150,800" size="100,100">As you turn to leave, you step into a rabbit hole, sprain your ankle (lose 1 SKILL point) and fall to the ground.($SKILL:-1)($STAMINA:-6) The butt of your sword clatters against a stone.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 31&quot;)]
|unlucky)[Unlucky &gt; (go-to: &quot;Page 340&quot;)]
|1)[==
[[Page 31]]
[[Page 340]]</tw-passagedata><tw-passagedata pid="32" name="Page 257" tags="" position="1275,925" size="100,100">Your dreams abruptly change, and you suddenly wake up, crying, &#39;Kevin! No!&#39; -- only to find something more horrible than your worst nightmare.  The five slimy tentacles of a Kraken are reaching out of the lake towards you.  You repulse the nearest one with a brand snatched from the fire, which gives you time either to [[run-&gt;Page 361]], or seize your sword and [[face the Kraken-&gt;Page 322]].</tw-passagedata><tw-passagedata pid="33" name="Page 280" tags="death" position="2200,675" size="100,100">You do not wake up until five slimy tentacles wrap themselves firmly around your body and draw you into the cavernous mouth of a Kraken.  Your adventure is over.</tw-passagedata><tw-passagedata pid="34" name="Page 97" tags="" position="1525,925" size="100,100">The effort of wading through the clinging mire costs you 2 STAMINA points. ($STAMINA: -2) But the boggy area does not last too long.  Will you now [[rest-&gt;Page 316]] for the remainder of the night, or [[carry on-&gt;Page 234]] along the bank?</tw-passagedata><tw-passagedata pid="35" name="Page 106" tags="item" position="1900,1175" size="100,100">The fleeing Spriggans did not gather up all their belongings.  You find 10 Gold Pieces($GOLD: 10) and a large garnet ring($add_item: &quot;Garnet Ring&quot;), but nothing else of value.  The Spriggans had evidently been a thieving party.  You decide to spend what remains of the night in the welcome light of the Spriggans&#39; magical lamps, which will disappear at full light, but until then, you reckon, will keep any further hostile creatures at bay.  In fact, the time does pass quietly.  In the morning, with mist from the lake drifting between the trees, you discover two paths, both leading roughly north.  Will you take the [[north-west path-&gt;Page 115]] or the [[north-east path-&gt;Page 398]]?</tw-passagedata><tw-passagedata pid="36" name="Page 135" tags="" position="2775,925" size="100,100">Your dreams abruptly change, and you suddenly sit bolt upright, crying, &#39;Kevin! No!&#39;  But the memory of your nightmare evaporates when you see, by the moonlight, that the slimy tentacles of a Kraken are sliding out of the lake towards you.  You can [[run-&gt;Page 183]] or [[fight-&gt;Page 307]].</tw-passagedata><tw-passagedata pid="37" name="Page 254" tags="combat" position="2900,925" size="100,100">You have stumbled into the encampment of two Blackheart hunters.  Blackhearts are an evil race, a cross between Orcs and Dark Elves.  You had thought them quite extinct, eliminated in the Great War of your ancestor, Brendan Bloodaxe.  But here are two of them, presumably from a village not too far away, looking quite as evil and dangerous as legend paints their forebears.  They quickly recover from their surprise at your intrusion, pick up jagged scimitars and cautiously approach, one to either side of you.

You will have to fight them simultaneously.  Choose one as an opponent and conduct the fight as normal against him.  But also roll for the Attack Strength of the other: if it is higher than your Attack Strength, he wounds you; if it is lower or equal, you have merely blocked his assault (in other words, you cannot wound him.){==
(set: $combat&#39;s loop to &quot;Simultaneous Combat Loop&quot;)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Blackheart&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Blackheart&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
	)
))(display: &quot;Combat Container&quot;)|victory)[If you defeat both Blackhearts, will you [[use their camp-&gt;Page 269]] as your own for the night, or quickly [[make your way out-&gt;Page 367]] of the area?
(set: $combat&#39;s loop to &quot;Sequential Combat Loop&quot;)]
</tw-passagedata><tw-passagedata pid="38" name="Page 31" tags="" position="3250,925" size="100,100">You start back from the lip, just as the ground gives way beneath your feet.  You land heavily on your bottom, but do not fall into the water.  You pick yourself up, head in the opposite direction, and soon pick up the trail again.  Will you turn [[left-&gt;Page 263]] or [[right-&gt;Page 156]]?</tw-passagedata><tw-passagedata pid="39" name="Page 340" tags="" position="3375,925" size="100,100">You start back from the lip, but the bank gives way beneath your feet, and you slide on your back down into the lake.  The noxious water causes you 2 STAMINA points of burns, and ruins &lt;i&gt;all&lt;/i&gt; your remaining Provisions (and any sorrel you may have.)($STAMINA: -2)  You clamber, cursing, back to solid ground and head in the opposite direction.  Will you turn [[left-&gt;Page 263]] or [[right-&gt;Page 156]]?
(set: $player&#39;s provisions to 0)
($remove_item: &quot;sorrel&quot;)</tw-passagedata><tw-passagedata pid="40" name="Page 361" tags="" position="1275,1050" size="100,100">In your haste, you drop some Provisions out of your pack.  (link-reveal: &quot;Roll one die.&quot;)[== (dialog: [You roll: ($ROLL1:)])($PROVISIONS:-$die1) This many lots of Provisions are lost.  The moon sets and you wander in the pitch-dark forest, no longer certain of your direction, until a slight lightening of the gloom and the mist rolling in from the lake herald dawn.  Will you slump down against a tree to [[rest-&gt;Page 398]], or [[press on-&gt;Page 171]]?</tw-passagedata><tw-passagedata pid="41" name="Page 322" tags="" position="1150,1050" size="100,100">The Kraken&#39;s ghastly head, with its huge beaked mouth snapping, appears out of the water behind the tentacles.  But it is obviously afraid of the fire, and it stays well out of reach: you will have to deal with the tentacles, rather than going for a killing stroke to the beast itself.  Will you fight the tentacles with [[sword alone-&gt;Page 379]], or try to snatch [[burning branches-&gt;Page 207]] from the fire to use in combination with your sword?</tw-passagedata><tw-passagedata pid="42" name="Page 234" tags="" position="1525,1050" size="100,100">The eastern sky is just beginning to lighten, and mist is rolling in off the lake, signalling that dawn is not too far away.  Lose 2 STAMINA points for lack of sleep. ($STAMINA: -2)You come to a creek, which flows into the lake.  You cannot see how wide it is, as the mist and darkness allow you to see only a few metres, and it is wider than that; but it is not too fast-flowing and it is not too deep either, as far as you can see.  Will you [[cross it-&gt;Page 274]], or [[follow it upstream-&gt;Page 294]], hoping to cross where it is narrower?</tw-passagedata><tw-passagedata pid="43" name="Page 115" tags="" position="2325,1925" size="100,100">(link-reveal:&quot;Have you eaten&quot;)[(show: ?1)] while in the forest? |1)[==(dialog:[(if: $player&#39;s has_eaten)[You have eaten.](else:)[You have not eaten.]]) (if: not $player&#39;s has_eaten)[($STAMINA: -2)]If not, reduce your STAMINA by 2 points.  The route you are taking shortly offers you a choice between two paths.  Will you take the one which disappears into the trees to the [[north-west-&gt;Page 263]], or the one which winds between the trees in a [[north-easterly-&gt;Page 82]] direction?(set: $player&#39;s has_eaten to false)</tw-passagedata><tw-passagedata pid="44" name="Page 398" tags="" position="1750,1400" size="100,100">(link-reveal:&quot;Have you eaten&quot;)[(show: ?1)] during the night? |1)[== (dialog:[(if: $player&#39;s has_eaten)[You have eaten.](else:)[You have not eaten.]]) (if: not $player&#39;s has_eaten)[($STAMINA: -2)]If not, reduce your STAMINA by 2 points.  When you resume your interrupted journey, wisps of mist are still drifting between the trunks of the tall evergreen trees ($dotdotdot:&quot;and&quot;) what was that?  Was it just a patch of mist at the edge of your vision?  Or was it some living creature?  An arrow thudding into a tree-trunk centimetres from your head soon answers these questions.  Will you [[remain motionless-&gt;Page 334]], or [[duck down-&gt;Page 251]] into the undergrowth?</tw-passagedata><tw-passagedata pid="45" name="Page 183" tags="" position="2775,1050" size="100,100">In your haste, you drop some Provisions out of your pack.  (link-reveal: &quot;Roll one die.&quot;)[== (dialog: [You roll: ($ROLL1:)])($PROVISIONS:-$die1) This many lots of Provisions are lost.  The moon sets and you wander in darkness through the night, no longer certain of your direction.  At dawn, mist rolls in from the lake and makes your situation [[even worse-&gt;Page 108]].  Lose 1 STAMINA point for lack of sleep.  ($STAMINA: -1)</tw-passagedata><tw-passagedata pid="46" name="Page 307" tags="" position="2650,1050" size="100,100">The Kraken&#39;s ghastly head, with its huge beaked mouth snapping, appears out of the water behind its five tentacles.  Will you [[move in close-&gt;Page 157]], thus exposing yourself to the tentacles, but hoping for an opportunity to finish the horror off with one blow to its head, or will you [[slash at the tentacles-&gt;Page 330]] themselves?</tw-passagedata><tw-passagedata pid="47" name="Simultaneous Combat Loop" tags="" position="100,725" size="100,100">{==
|before_combat&gt;[]
|combat_loop&gt;[
	[(display: &quot;List Opponents Simultaneously&quot;)]&lt;list_opponents_container|
	[(display: &quot;Simultaneous Combat Action&quot;)]&lt;combat_action_container|
	[(display: &quot;Simultaneous Combat Results&quot;)]&lt;combat_results_container|
	[(display: &quot;Simultaneous Combat Next&quot;)]&lt;combat_next_container|
]
|after_combat&gt;[]</tw-passagedata><tw-passagedata pid="48" name="List Opponents Simultaneously" tags="" position="225,725" size="100,100">|opponents&gt;[{&lt;ol&gt;
    (for: each _i, ...(range:1, $combat&#39;s opponents&#39;s length))[
        (set: _monster to $combat&#39;s opponents&#39;s _i)
        (set: _prefix to _monster&#39;s prefix)
        (set: _name to _monster&#39;s name)
        (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
        &lt;li class=&quot;monster&quot;&gt;
            &lt;span&gt;(print: _prefixed_name):&lt;/span&gt;
            |monster_stats&gt;[&lt;span&gt;SKILL (print: _monster&#39;s skill)&lt;/span&gt;
            &lt;span&gt;STAMINA (print: _monster&#39;s stamina)&lt;/span&gt;]
            
            (link: &quot;Attack!&quot;)[{
            	(hide: ?attack_action)
                (set: $targeted_monster to _i)
                (rerun: ?combat_action)(show: ?combat_action)
            }]&lt;attack_action|
        &lt;/li&gt;
    ]
&lt;/ol&gt;}]</tw-passagedata><tw-passagedata pid="49" name="Simultaneous Combat Action" tags="" position="350,725" size="100,100">|combat_action)[{
    (set: $target to $combat&#39;s opponents&#39;s $targeted_monster)

    (set: _article to $target&#39;s article)
    (set: _prefix to $target&#39;s prefix)
    (set: _name to $target&#39;s name)
    (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
    (set: _the_monster to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _article, _prefixed_name)))

	&lt;span class=&quot;attack&quot;&gt;You attack (print: _the_monster).&lt;/span&gt;

    |==
    (set: $player&#39;s attack_strength to $player&#39;s skill + ($ROLL2:))
    &lt;p&gt;Rolling for Attack Strength: $die1 + $die2 = (print: $die1 + $die2).&lt;br/&gt;
    Your Attack Strength is (print: $player&#39;s attack_strength).&lt;/p&gt;
    ==|
    &lt;p&gt;
        (for: each _i, ...(range: 1, $combat&#39;s opponents&#39;s length))[
            (set: _m to (_i) of $combat&#39;s opponents)
            (set: _article to _m&#39;s article)
            (set: _prefix to _m&#39;s prefix)
            (set: _name to _m&#39;s name)
            (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
            (set: _attack_strength to _m&#39;s skill + ($ROLL2:))
            (set: $combat&#39;s opponents&#39;s _i&#39;s attack_strength to _attack_strength)

			(print: _prefixed_name)&#39;s Attack Strength is (print: _m&#39;s skill) + $die1 + $die2 = (print: _attack_strength).&lt;br/&gt;
            (if: _m contains &quot;special_attack&quot;)[(display: _m&#39;s special_attack)]
        ]
    &lt;/p&gt;
    |==|
    (show: ?combat_results)
}]</tw-passagedata><tw-passagedata pid="50" name="Simultaneous Combat Results" tags="" position="475,725" size="100,100">|combat_results)[{
    (set: _TEST_YOUR_LUCK to (macro: num-type _index, [{
        (set: _roll to ($ROLL2:))
        (set: _lucky to _roll &lt;= $player&#39;s luck)
        (set: $player&#39;s luck to (max: 0, it - 1))
        (set: _label to (cond: _lucky, &quot;Lucky!&quot;, &quot;Unlucky!&quot;))
        (output:)[{
            (dialog: [You roll (print: $die1) + (print: $die2)], _label)(if: _lucky)[(show: ?lucky&#39;s _index)](if: not _lucky)[(show: ?unlucky&#39;s _index)]
        }]
    }]))
    &lt;p&gt;
        (for: each _i, ...(range: 1, $combat&#39;s opponents&#39;s length))[
            (set: _m to (_i) of $combat&#39;s opponents)
            (set: _article to _m&#39;s article)
            (set: _prefix to _m&#39;s prefix)
            (set: _name to _m&#39;s name)
            (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))
            (set: _damage to 2)
            
            (if: $targeted_monster is _i)[
                (if: $player&#39;s attack_strength is _m&#39;s attack_strength)[
                    You dodge (print: _prefixed_name)&#39;s blows.
                    &lt;br/&gt;
                    (rerun: ?combat_on_dodge)(show: ?combat_on_dodge)
                ](else-if: $player&#39;s attack_strength &gt; _m&#39;s attack_strength)[
                    (if: $player contains &quot;damage&quot;)[(set: _damage to $player&#39;s damage)]
                    You hit (print: _prefixed_name) for (print: _damage)!
                    (set: $combat&#39;s opponents&#39;s _i&#39;s stamina to it - _damage)
                    (if: $combat&#39;s opponents&#39;s _i&#39;s stamina &gt; 0)[{
                        (link-replace:&quot;&lt;i&gt;Test your Luck?&lt;/i&gt;&quot;)[(_TEST_YOUR_LUCK: _i)(rerun: ?combat_next)]
                        |lucky)[Lucky! Deal +1 damage!(set: $combat&#39;s opponents&#39;s _i&#39;s stamina to it - 1)]
                        |unlucky)[Unlucky! Deal -1 damage!(set: $combat&#39;s opponents&#39;s _i&#39;s stamina to it + 1)]
                    }](else:)[
                        The blow is fatal!
                    ]
                    &lt;br/&gt;
                    (rerun: ?combat_on_target_hit)(show: ?combat_on_target_hit)
                ](else:)[
                    (if: _m contains &quot;damage&quot;)[(set: _damage to _m&#39;s damage)]
                    (print: _prefixed_name) hits you - deduct (print: _damage) STAMINA!
                    (set: $player&#39;s stamina to it - _damage)
                    (link-replace:&quot;&lt;i&gt;Test your Luck?&lt;/i&gt;&quot;)[(_TEST_YOUR_LUCK: _i)(rerun: ?combat_next)]
                    |lucky)[Lucky! Take -1 damage!(set: $player&#39;s stamina to it + 1)]
                    |unlucky)[Unlucky! Take +1 damage!(set: $player&#39;s stamina to it - 1)]
                    &lt;br/&gt;
                    (rerun: ?combat_on_player_hit)(show: ?combat_on_player_hit)
                ]
            ](else:)[
                (if: _m&#39;s attack_strength &gt; $player&#39;s attack_strength)[
                    (print: _prefixed_name) hits you - deduct (print:_damage) STAMINA!
                    (set: $player&#39;s stamina to it - _damage)
                    (link-replace:&quot;&lt;i&gt;Test your luck?&lt;/i&gt;&quot;)[(_TEST_YOUR_LUCK: _i)(rerun: ?combat_next)]
                    |lucky)[Lucky! Take -1 damage!(set: $player&#39;s stamina to it + 1)]
                    |unlucky)[Unlucky! Take +1 damage!(set: $player&#39;s stamina to it - 1)]
                    &lt;br/&gt;
                ](else:)[
                	|lucky&gt;[] |unlucky&gt;[] &lt;!-- stub lucky/unlucky placeholders for consistent indexing! --&gt;
                ]
            ]
        ]
    &lt;/p&gt;    
    
    (show: ?combat_next)
}]</tw-passagedata><tw-passagedata pid="51" name="Simultaneous Combat Next" tags="" position="600,725" size="100,100">|combat_next)[{
    (if: $player&#39;s stamina &lt;= 0)[
        Your wounds are fatal.  Your adventure ends here.
    ](else:)[
        (set: _update to $combat&#39;s opponents)
        (for: each _i, ...(range: 1, $combat&#39;s opponents&#39;s length))[
            (set: _m to _i of $combat&#39;s opponents)
            (set: _article to _m&#39;s article)
            (set: _prefix to _m&#39;s prefix)
            (set: _name to _m&#39;s name)
            (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))

            (if: _m&#39;s stamina &lt;= 0)[
                &lt;p&gt;(print: _prefixed_name) is defeated!&lt;/p&gt;
                (set: _update to it - (a: _m))
            ]
            
        ]
        (set: $combat&#39;s opponents to _update)
    ]

    (if: $combat&#39;s opponents is not an empty)[
        &lt;p&gt;(link-reveal:&quot;Combat continues... &quot;)[(rerun: ?combat_loop)]&lt;/p&gt;
    ](else:)[
        (show: ?victory)
    ]
	(rerun: ?post_combat_next)(show: ?post_combat_next)
}]</tw-passagedata><tw-passagedata pid="52" name="Page 269" tags="" position="3025,1050" size="100,100">The night passes peacefully, and you wake up at dawn.  Mist, rolling in from the lake, is already obscuring the surrounding hills, and crows are approaching, eyeing the corpses of the hunters.  In the morning light, you spot the Blackhearts&#39; packs, half hidden under a gorse bush.  In them you find a length of stout rope and two bearskins.  You decide to leave the pelts, since they would weigh you down, but you take the rope.($add_item: &quot;Rope&quot;)  Then you continue on your journey.  The density of the mist soon makes you [[hopelessly lost-&gt;Page 108]].</tw-passagedata><tw-passagedata pid="53" name="Page 367" tags="" position="2900,1050" size="100,100">A sudden noise from some nearby undergrowth startles you and you [[rush away-&gt;Page 183]], imagining a whole host of Blackheart warriors.</tw-passagedata><tw-passagedata pid="54" name="Page 263" tags="death" position="2225,1025" size="100,100">You walk off through the mist, which closes behind your back.  You are never seen again, by man or monster, on this earth.</tw-passagedata><tw-passagedata pid="55" name="Page 156" tags="combat" position="3250,1050" size="100,100">Whatever animals made the track were clearly not interested in travelling in staight lines.  Even with your limited vision and muddled sense of direction, you can tell that your course is meandering all over the place.  Still, you stick to the track, and it eventually takes you to the top of a hill, where ancient monoliths jut like pitted teeth through the swirling mist.

The wind picks up and howls eerily across the hilltop.  Then a hollow voice sounds from all around you: &#39;Who is this who dares disturb the sacred place of the Wights?  No matter - the penalty is fixed.&#39;  The mist in the centre of the stones solidifies into a figure.  On its head is a crown of pale fire, and in its hand a glittering sword.  Wherever you run, it seems to block your way.  You must stand and fight. {== (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Wight&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)
|victory)[If you win, you take the Wight&#39;s sword, which turns out to be of ancient and noble design -- obviously the property of some long-dead king, slain in times past by this evil Wight.  Add 1 to your SKILL score, even if this takes you over your &lt;i&gt;Initial&lt;/i&gt; score.(set: $player&#39;s skill to it + 1)(rerun: ?sidebar_stats)  Will you now [[stay where you are-&gt;Page 362]] until the mist clears, or [[continue on your way-&gt;Page 3]]?]</tw-passagedata><tw-passagedata pid="56" name="Page 379" tags="combat" position="1025,1175" size="100,100">With your back to the tree and the camp-fire in front of you, you can fight the tentacles one at a time.  They try to wrap themselves around you and pull you in to the gaping mouth of the Kraken.  {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Third&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fourth&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fifth&quot;,
	)
))}(display: &quot;Combat Container&quot;)|escape&gt;[You can (link-reveal:&quot;escape&quot;)[(set: $combat&#39;s opponents to (a:))($STAMINA: -2)(go-to:&quot;Page 361&quot;) [[Page 361]] ] at any time, though the tentacles will cause you 2 further STAMINA points of injury as you gather up your belongings and flee.]  |victory)[(hide:?escape)If you win the battle, your journey [[continues-&gt;Page 346]].]</tw-passagedata><tw-passagedata pid="57" name="Page 207" tags="combat" position="1150,1175" size="100,100">With your back to the tree and the camp-fire in front of you, you can fight the tentacles one at a time.  Before you fight each tentacle, you reach for a (link-reveal:&quot;burning brand&quot;)[(show: ?1)] from the fire. |1)[==

(display: &quot;TENTACLE FIRE&quot;)
{
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
        &quot;special_precombat&quot;, &quot;TENTACLE FIRE&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Third&quot;,
        &quot;special_precombat&quot;, &quot;TENTACLE FIRE&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fourth&quot;,
        &quot;special_precombat&quot;, &quot;TENTACLE FIRE&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fifth&quot;,
        &quot;special_precombat&quot;, &quot;TENTACLE FIRE&quot;
	)
))}(display: &quot;Combat Container&quot;)|escape&gt;[You can (link-reveal:&quot;escape&quot;)[(set: $player&#39;s damage to 2)(set: $combat&#39;s opponents to (a:))($STAMINA: -2)(go-to:&quot;Page 361&quot;) [[Page 361]] ] at any time, though the tentacles will cause you 2 further STAMINA points of injury as you gather up your belongings and flee.]  |victory)[(set: $player&#39;s damage to 2)(hide: ?escape)If you win the battle, your journey [[continues-&gt;Page 346]].]</tw-passagedata><tw-passagedata pid="58" name="Page 274" tags="" position="1575,1175" size="100,100">When you are halfway across, the spirits of the water rise up against you.  It all happens in an instant: one moment you are on your feet, the next moment you are flailing about underwater in a confusion of muddy-brown figures, with spray for hair and river-bed rocks for fists.  (link: &quot;Roll one die.&quot;)[== (dialog: [You roll: ($ROLL1:)])Roll one die, and reduce your STAMINA by that many points.($STAMINA:-$die1)  It is clear that the creek could kill you if it chose to; but instead it ejects you back on to its southern bank, where you started.  You decide to head [[into the forest-&gt;Page 171]], away from anything remotely resembling water, even though the forest is still as black as midnight and untouched by the approaching dawn.</tw-passagedata><tw-passagedata pid="59" name="Page 294" tags="" position="1450,1175" size="100,100">Dense undergrowth forces you some way from the creek.  The going is very hard, especially after your night-time exertions, and after a while you stop to [[rest-&gt;Page 398]].</tw-passagedata><tw-passagedata pid="60" name="Page 82" tags="" position="2450,1925" size="100,100">The remainder of the journey to Fallow Dale is uneventful, apart from the occasional skirmish with a wild beast.  At one point you are convinced that you see a Sabre-toothed Tiger slinking through the trees, but by luck -- or because the beast was not hungry -- it does not come near you.  You keep getting lost in the forest and the journey takes longer than it should: you run out of Provisions a day before breaking out of the forest and finding [[Fallow Dale-&gt;Page 178]] spread out before you.  Reduce your STAMINA score by 3 points for weakness before you continue.($STAMINA: -3)(set: $player&#39;s provisions to 0)(rerun: ?sidebar_inventory)</tw-passagedata><tw-passagedata pid="61" name="Page 334" tags="" position="1700,1525" size="100,100">Six Wood Elves step up to you, with a mixture of curiosity and caution, and then politely but firmly lead you away.  Will you [[make a break-&gt;Page 130]] for it, or [[let yourself be taken-&gt;Page 28]] wherever you are going?</tw-passagedata><tw-passagedata pid="62" name="Page 251" tags="" position="1825,1525" size="100,100">Peeping between the branches of the bramble which you are using as cover, you can see Wood Elves flitting noiselessly from tree-trunk to tree-trunk, and in this zigzag fashion getting closer to the spot where you are lying.  While Wood Elves are decidely not friendly towards human beings, they are not usually hostile, unless their beloved woods have, in their opinion, been interfered with.  Will you [[stand up-&gt;Page 334]] and extend friendly greetings towards the Elves, or, since you cannot see any Elves behind you, try to [[back out-&gt;Page 195]] of this confrontation?</tw-passagedata><tw-passagedata pid="63" name="Page 108" tags="" position="2900,1175" size="100,100">Will you [[stay where you are-&gt;Page 27]] until the mist clears, or [[press on-&gt;Page 138]] regardless?</tw-passagedata><tw-passagedata pid="64" name="Page 157" tags="" position="2525,1175" size="100,100">(link: &quot;Roll two dice.&quot;)[== (set: _roll to ($ROLL2:))(dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)])Roll two dice.  (if: $total &gt; $player&#39;s skill)[If the total if greater than your SKILL score, [[continue here-&gt;Page 216]].](else:)[If the total is less than or equal to your SKILL score, [[continue here-&gt;Page 12]].]</tw-passagedata><tw-passagedata pid="65" name="Page 330" tags="combat" position="2650,1175" size="100,100">In your exposed position, the tentacles can lash at you two at a time.  Thus every time you determine your Attack Strength for normal combat with the first tentacle, you must also determine the Attack Strength of the second tentacle: if its Attack Strength is higher than yours, it wounds you; if it is lower or equal, you have merely avoided it (you cannot wound it).  When you have finished with the first tentacle, you turn to deal with the second directly, and the third gets free attacks at you; and so on, until you have finished them ($dotdotdot:&quot;all&quot;) if you get that far! {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
        &quot;special_attack&quot;, &quot;TENTACLE SPECIAL&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
        &quot;special_attack&quot;, &quot;TENTACLE SPECIAL&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Third&quot;,
        &quot;special_attack&quot;, &quot;TENTACLE SPECIAL&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fourth&quot;,
        &quot;special_attack&quot;, &quot;TENTACLE SPECIAL&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Tentacle&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Fifth&quot;,
	)
))}(display: &quot;Combat Container&quot;) |escape&gt;[You can (link-reveal:&quot;escape&quot;)[(set: $opponents to (a:))($STAMINA: -2)(go-to:&quot;Page 183&quot;) [[Page 183]] ] at any time, though the tentacles will cause you 2 further STAMINA points of injury as you gather up your belongings and flee.]  |victory)[(hide:?escape)If you win the battle, your journey [[continues-&gt;Page 85]].]</tw-passagedata><tw-passagedata pid="66" name="Page 362" tags="" position="3250,1175" size="100,100">As the mist begins to clear, you can see buildings in the shallow valley below you.  You duck down behind a stone.  When you dare to peek around the stone, you find that the buildings are in fact the dilapidated remains of a mine of some kind.  They are obviously uninhabited -- at any rate, by their former inhabitants.  Will you have a [[look around-&gt;Page 181]], or [[skirt the area-&gt;Page 343]]?</tw-passagedata><tw-passagedata pid="67" name="Page 3" tags="" position="3725,1175" size="100,100">(set: $player&#39;s has_eaten to false)The mist begins to clear as you follow the trail, which carries on down the other side of the hill.  However, it is still thick in the valleys.  At one point you look up to assess how much longer the mist will last: the sun is a hazy yellow-orange ball behind the clouds.  So you fail to see what it right in front of your feet, and you plummet down a gaping hole in the ground. (link: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:))(dialog: [You roll: (print: $die1)])(show: ?1)] and deduct that many STAMINA points.

|1)[==($STAMINA: -$die1) When you regain consciousness, you look around.  The light streaming in from above reveals a well-shaped tunnel.  It looks as though you have landed in an old mine.  You cannot chimney your way up the shaft, since the entrance is too high above your head, and the sides are too sheer.  So will you go [[west-&gt;Page 394]] or [[east-&gt;Page 144]]?</tw-passagedata><tw-passagedata pid="68" name="Page 178" tags="" position="2525,2125" size="200,200">As you descend into Fallow Dale, you recall what you know about the place.  Several villages are located there, and the population is a mixture of human and other intelligent species.  The villages are bound into a loose federation under a single overlord, who occupies a fortified castle in the middle of the Dale.  Hever is the present lord of Fallow Dale, and his proud boast is that the fortifications of his castle are purely for external enemies: his villages live at peace with one another and with him.

Apart from this, you have little reliable knowledge: the people of Arion never travel far from their familiar world, and certainly not as far as Fallow Dale; and few traders have passed from Hever&#39;s land to yours.  You can see the castle a few kilometres away.  Your route could take you [[through a village-&gt;Page 305]], or you could bypass the village by crossing a large [[ploughed field-&gt;Page 396]].</tw-passagedata><tw-passagedata pid="69" name="Page 130" tags="" position="1700,1650" size="100,100">($test_your_luck:).  |lucky)[(go-to: &quot;Page 297&quot;) [[Page 297]] ] |unlucky)[If you are Unlucky you [[fail to escape-&gt;Page 358]].]</tw-passagedata><tw-passagedata pid="70" name="Page 28" tags="" position="1725,1900" size="100,100">The Wood Elves eventually stop in an empty clearing, speak some words in an arcane, liquid language -- and immediately their village is visible in the clearing!  Of course: Wood Elves&#39; villages are often protected by magic.  You are taken to the largest hut, which is set well apart from the others at the far end of the village.  Inside, the chief Elf and his shaman are gazing seriously into a crystal mirror and muttering darkly to each other.  They look up when you enter, and astonishment spreads over their faces.  They dismiss your guards, and then the chief addresses you.  &#39;Stranger,&#39; he says, &#39;what is it that you want?  What are you doing here?&#39;  Will you [[tell them of your quest-&gt;Page 218]], make up [[some other reason-&gt;Page 5]] for being in the forest, or try to [[look in the mirror-&gt;Page 87]]?</tw-passagedata><tw-passagedata pid="71" name="Page 195" tags="" position="1950,1525" size="100,100">This will be difficult.  You are pitting your skill at concealment against that of the wood-wise Elves.  (link: &quot;Roll one die.&quot;)[== (set: _roll to ($ROLL1:))(dialog: [You roll: (print: $die1)])  (if: _roll &lt;= 4)[On 1-4, [[continue here-&gt;Page 391]].](else:)[On 5 or 6, [[continue here-&gt;Page 95]].]</tw-passagedata><tw-passagedata pid="72" name="Page 216" tags="death" position="2450,1300" size="100,100">Your efforts only enrage the monster, and it swipes you with one of its tentacles.  Your sword flies out of your grasp, and before you can recover it, you are drawn into the Kraken&#39;s mouth.  The acidic waters of the lake will dissolve even your bones.</tw-passagedata><tw-passagedata pid="73" name="Page 12" tags="" position="2575,1300" size="100,100">You succeed in plunging your sword through the horny outer skin of the Kraken, and through to its pulpy insides.  The Kraken retreats, mortally wounded, but its tentacles thrash in agony and knock you [[off your feet-&gt;Page 85]].  Lose 2 STAMINA points.($STAMINA: -2)</tw-passagedata><tw-passagedata pid="74" name="Page 346" tags="key" position="1300,1400" size="100,100">You sit down to rest after your exertions.  Then to your amazement a spectral army glides across the surface of the lake.  There are at least forty of them, and most are dressed in the battered remnants of armour of bygone days.  You jump to your feet in alarm.  You can see through them, but you also have no doubt that they are substantial enough to make their presence felt in this earthly realm.

While you are wondering what to do, one of them steps forward on to the bank.  He was once a man in the prime of life, long-haired and with noble and stern features.  &#39;Fear not,&#39; his ghostly voice whispers.  &#39;You have done us great service.  With the death of the Kraken we, it&#39;s victims, are released from our bondage to this spectral form.  But we repay our debts.  Before we go to our final rest in the underworld, we will assist you once in the course of your quest -- but my advice would be not to call us except in the direst need.  You can summon us by my name: it is Galrin.&#39;  With that, the leader and his host of followers vanish.  ($LUCK: 2)[[Add 2 LUCK points-&gt;Page 385]].(set: $player&#39;s galrin to true)</tw-passagedata><tw-passagedata pid="75" name="Page 85" tags="key" position="2725,1300" size="100,100">You sit down to rest after your labours.  Then to your amazement a spectral army glides across the surface of the lake.  There are at least forty of them, and most are dressed in the battered remnants of armour of bygone days.  You jump to your feet in alarm.  You can see through them, but you also have no doubt that they are substantial enough to make their presence felt in this earthly realm.

While you are wondering what to do, one of them steps forward on to the bank.  He was once a man in the prime of life, long-haired and with noble and stern features.  &#39;Fear not,&#39; his ghostly voice whispers.  &#39;You have done us great service.  With the death of the Kraken we, it&#39;s victims, are released from our bondage to this spectral form.  But we repay our debts.  Before we go to our final rest in the underworld, we will assist you once in the course of your quest -- but my advice would be not to call us except in the direst need.  You can summon us by my name: it is Galrin.&#39;  With that, the leader and his host of followers vanish.  ($LUCK: 2)Add 2 LUCK points.  You decide not to spend any more time by the lake shore: you head north and slightly east, through rolling hills.  A heavy mist descends at dawn, and you are soon [[hopelessly lost-&gt;Page 108]].(set: $player&#39;s galrin to true)</tw-passagedata><tw-passagedata pid="76" name="TENTACLE FIRE" tags="" position="1275,1175" size="100,100">(set: $player&#39;s damage to 2)(if: $combat&#39;s round &gt; 1)[You reach for another brand from the fire. ]Rolling one die: ($ROLL1:)! (if: $die1 &lt;= 2)[On a roll of 1 or 2, you succeed, in your haste, merely in burning yourself: lose 1 STAMINA point.($STAMINA: -1)](if: $die1 &gt; 2 and $die1 &lt;= 4)[On 3 or 4, the branch you seize sputters and dies before you have a chance to use it.](if: $die1 &gt; 4)[On 5 or 6, you succeed in getting hold of a securely flaming brand, and every time you win an Attack Round, you inflict 3, rather than the usual 2 STAMINA points of injury.(set: $player&#39;s damage to 3)]</tw-passagedata><tw-passagedata pid="77" name="TENTACLE SPECIAL" tags="" position="2775,1175" size="100,100">{==
(if: $combat&#39;s opponents&#39;s length &gt; 1)[
	(set: _t to $combat&#39;s opponents&#39;s 2nd)
    (set: _attack to ($ROLL2:) + _t&#39;s skill)
	Special attack: (print: _t&#39;s prefix) (uppercase: _t&#39;s name)&#39;s Attack Strength is (print: _attack)
	(if: $player&#39;s attack_strength &lt; _attack)[
    	($STAMINA: -2)
    	&lt;br/&gt;It hits you for 2 damage.  (link-reveal: &quot;&lt;i&gt;Test your Luck?&lt;/i&gt;&quot;)[
            (set: _roll to ($ROLL2:))
            (set: _lucky to _roll &lt;= $player&#39;s luck)
            (set: _label to (cond: _lucky, &quot;Lucky!&quot;, &quot;Unlucky!&quot;))
            (dialog: [Your roll: (print: $die1) + (print: $die2) = (print: _roll)], _label)
            (print: _label)
            (cond: _lucky, [+1 STAMINA. ($STAMINA: 1)], [-1 STAMINA. ($STAMINA: -1)])
            (set: $player&#39;s luck to it - 1)
        ]
    ](else:)[ - miss!]
]</tw-passagedata><tw-passagedata pid="78" name="Page 27" tags="" position="3025,1175" size="100,100">The chill mist seeps into your bones.  You slap yourself and jump up and down to keep warm, but you still [[lose 2 STAMINA points-&gt;Page 362]].($STAMINA: -2)</tw-passagedata><tw-passagedata pid="79" name="Page 138" tags="" position="2850,1300" size="100,100">You can see only a few metres ahead of you, so you are pleasantly surprised when you come across a trail, made by animals of some kind, running to your left and right.  Will you turn [[left-&gt;Page 156]], [[right-&gt;Page 263]], or [[continue-&gt;Page 189]] through the trackless hills?</tw-passagedata><tw-passagedata pid="80" name="Page 181" tags="" position="3250,1300" size="100,100">Will you investigate the [[main shaft-&gt;Page 36]], the [[outhouse-&gt;Page 212]] whose roof has collapsed, or the [[hut-&gt;Page 107]] which looks fairly intact?</tw-passagedata><tw-passagedata pid="81" name="Page 343" tags="" position="2650,1700" size="100,100">You set your course by the sun for Fallow Dale.  Do you have (link-reveal:&quot;two or fewer&quot;)[(show:?1)] lots of Provisions left? |1)[(dialog: [(if: $player&#39;s provisions &lt;= 2)[You have only (print:$player&#39;s provisions).](else:)[You have more food than that.]]) (if: $player&#39;s provisions &lt;= 2)[(go-to:&quot;Page 376&quot;) [[Page 376]]](else:)[(go-to: &quot;Page 200&quot;) [[Page 200]] ] ]</tw-passagedata><tw-passagedata pid="82" name="Page 394" tags="" position="3600,1300" size="100,100">As you walk along, you notice that there are many evenly-spaced shafts, drilled through to the ground above.  These afford light and air, but are out of reach, and just as unclimbable as the one you fell down.  You conclude that the mine was once worked by slaves, who needed to breathe and see, but also had to be prevented from escaping.

It turns out that this was a copper mine; the vein is worked out, but you find a nugget of greenish ore, which you keep.($add_item: &quot;Copper Nugget&quot;)  You soon come to what is obviously the main shaft, but any hopes you had of escaping are quickly dashed when you see that the ladder has rotted away, and the entrance is too wide to chimney up.  You sit down and complain to yourself for a while, but then determine to find some other way out.  Will you now continue [[west-&gt;Page 355]], or turn [[east-&gt;Page 388]]?</tw-passagedata><tw-passagedata pid="83" name="Page 144" tags="" position="3850,1300" size="100,100">As you walk along, you notice that there are many evenly-spaced shafts, drilled through to the ground above.  These afford light and air, but are out of reach and just as unclimbable as the one you fell down.  You conclude that the mine was once worked by slaves, who needed to breathe and see, but also had to be prevented from escaping.

It turns out that this was a copper mine; the vein is worked out, but you find a nugget of greenish ore, which you keep.($add_item: &quot;Copper Nugget&quot;)  Soon a side-passage, from which a remarkably horrid stench is issuing, opens up to your right.  Will you [[take it-&gt;Page 325]], or continue along the [[main tunnel-&gt;Page 370]]?</tw-passagedata><tw-passagedata pid="84" name="Page 385" tags="" position="1500,1400" size="100,100">You decide not to spend any more time by the lake shore, and strike off north and slightly west, through the dark forest, until you are no longer certain how far you have come or where you are.  A slight lightening of the gloom and mist rolling in from the lake herald dawn.  Will you slump down against a tree to [[rest-&gt;Page 398]], or [[press on-&gt;Page 171]]?</tw-passagedata><tw-passagedata pid="85" name="Page 297" tags="" position="2125,1775" size="100,100">With arrows whistling about your ears, you sprint, crouch and zigzag away from the Elves.  They do not seem particularly interested in pursuing you.  When you judge that the coast is clear, you head north towards [[Fallow Dale-&gt;Page 115]].</tw-passagedata><tw-passagedata pid="86" name="Page 358" tags="" position="1850,1775" size="100,100">The Elves tie your hands behind your back and keep a close watch on you as they march you off towards their [[village-&gt;Page 28]].  (set: $player&#39;s tied to true)</tw-passagedata><tw-passagedata pid="87" name="Page 218" tags="" position="1650,2025" size="100,100">&#39;We have seen something of this in the mirror,&#39; says the chief, when you have finished explaining about your quest. (link-reveal:&quot;Are your hands tied&quot;)[(show:?1)]? |1)[(dialog: [(if: $player contains &#39;tied&#39;)[Yes, your hands are tied.](else:)[No, your hands are not tied.]]) (if: $player contains &#39;tied&#39;)[(go-to:&quot;Page 319&quot;) [[Page 319]]](else:)[(go-to: &quot;Page 154&quot;) [[Page 154]] ] ]</tw-passagedata><tw-passagedata pid="88" name="Page 5" tags="" position="2000,1400" size="100,100">You stutter to a halt in the middle of some feeble story about hunting and getting lost.  The shaman curtly tells the chief that you are lying, but not evil.  Then he begins to mutter a spell.  The village starts to dissolve and you feel yourself floating.  After a while you find yourself in mist-shrouded hills.  Your hands (if they were tied) are free, but you have been deprived of all your remaining Provisions.  The position of the sun, dimly perceived behind the mist, tells you that you have been transported to the eastern side of the lake.  Will you [[stay where you are-&gt;Page 27]] until the mist clears, or [[press on-&gt;Page 138]] regardless?</tw-passagedata><tw-passagedata pid="89" name="Page 87" tags="" position="1775,2025" size="100,100">(link-reveal:&quot;Are your hands tied&quot;)[(show:?1)]? |1)[(dialog: [(if: $player contains &#39;tied&#39;)[Yes, your hands are tied.](else:)[No, your hands are not tied.]]) (if: $player contains &#39;tied&#39;)[(go-to:&quot;Page 192&quot;) [[Page 192]]](else:)[(go-to: &quot;Page 150&quot;) [[Page 150]] ] ]</tw-passagedata><tw-passagedata pid="90" name="Page 391" tags="" position="1825,1650" size="100,100">You are almost immediately spotted and [[surrounded-&gt;Page 358]].</tw-passagedata><tw-passagedata pid="91" name="Page 95" tags="" position="2000,1650" size="100,100">You succeed in reaching another place of hiding, behind a tree-trunk.  The Elves (there are six of them) have meanwhile surrounded your former hiding-place.  Will you make a [[run for it-&gt;Page 297]], while they are otherwise occupied, or continue to [[creep away-&gt;Page 158]]?</tw-passagedata><tw-passagedata pid="92" name="Page 158" tags="" position="2000,1775" size="100,100">Two possible next places of refuge present themselves.  You could try the [[hollow trunk-&gt;Page 9]] of a vast and ancient tree, once blasted by lightning, or a slight [[dip in the ground-&gt;Page 48]] whose sides are covered with ivy and tall bracken.</tw-passagedata><tw-passagedata pid="93" name="Page 189" tags="" position="3000,1300" size="100,100">As you walk through prickly grass and tiny yellow orchids, you suddenly find yourself on the lip of a bank, with the surface of the lake a couple of metres below.  ($test_your_luck:)
|lucky)[ (go-to: &quot;Page 31&quot;) [[Page 31]] ]
|unlucky)[ (go-to: &quot;Page 340&quot;) [[Page 340]] ]</tw-passagedata><tw-passagedata pid="94" name="Page 32" tags="" position="3050,10150" size="100,100">The door creaks open on rusty hinges, but no immediate danger confronts you.  You hear the click of rats&#39; claws as you advance up the tunnel, but you ignore them.  There is only one way for you now -- forward -- and everything else is a distraction.  However, the tunnel forks like a serpent&#39;s tongue.  Will you go [[left-&gt;Page 19]] or [[right-&gt;Page 224]]?</tw-passagedata><tw-passagedata pid="95" name="Page 212" tags="combat" position="3250,1425" size="100,100">Not only has the roof collapsed, but, as soon as you step inside the hut, the floor collapses too, rotted away by years of damp and deathwatch beetle.  And creatures worse than beetles occupy the cellar into which you have fallen.  Rats and gigantic millipedes scuttle and writhe when you land with a crash on the ground.  Then they are all over you, before you can get to your feet.  You brush them off, but will have to fight to make enough space to reach the joists and haul yourself back up.  Treat them as a single opponent. {== (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Vermin&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)|victory)[(append: ?after_combat)[If you win, you pull yourself out of this hell-hole, but a rat bites your dangling ankle for 1 STAMINA point of injury.($STAMINA: -1)  Will you now [[investigate the main shaft-&gt;Page 36]](if: (history:) does not contain &quot;Page 107&quot;)[ or the more solid [[hut-&gt;Page 107]]], or will you [[leave the site-&gt;Page 343]] altogether?]
]</tw-passagedata><tw-passagedata pid="96" name="Page 107" tags="" position="3375,1425" size="100,100">It takes your eyes a few moments to adjust to the gloom after the bright sunshine outside.  Then you see that, although the ceiling is festooned with cobwebs, the floor is fairly free of dust.  There is a table with a wooden bowl and spoon on it, and a crudely-made stool tucked underneath.  Will you [[leave-&gt;Page 231]] before the occupant of the hut appears, or [[look around-&gt;Page 279]]?</tw-passagedata><tw-passagedata pid="97" name="Page 376" tags="" position="2575,1925" size="100,100">The remainder of the journey to [[Fallow Dale-&gt;Page 178]] is uneventful, but you soon run out of Provisions.  Reduce your STAMINA score by 6 points for two days of hard walking with no food or water.($STAMINA: 6)(set: $player&#39;s provisions to 0)</tw-passagedata><tw-passagedata pid="98" name="Page 200" tags="" position="2700,1925" size="100,100">The remainder of the journey to [[Fallow Dale-&gt;Page 178]] is uneventful, apart from the occasional skirmish with a wild beast.</tw-passagedata><tw-passagedata pid="99" name="Page 355" tags="" position="3575,1425" size="100,100">Later, a side-passage opens up on your left.  Will you [[take it-&gt;Page 283]], or [[continue-&gt;Page 364]] along the main tunnel?</tw-passagedata><tw-passagedata pid="100" name="Page 388" tags="" position="3775,1550" size="100,100">About half a kilometre beyong the main shaft, a side-passage opens up to your right; a truly horrible smell is issuing from it.  Will you [[take it-&gt;Page 325]], or [[continue-&gt;Page 370]] along the main tunnel?</tw-passagedata><tw-passagedata pid="101" name="Page 325" tags="combat" position="3825,1675" size="100,100">The smell gets worse, and then you lose your footing in the accumulated sludge of generations of bats, whose colony you have entered.  Before you can get to your feet, they are flapping all around you, confusing you with their squeaks and scratching you with tiny teeth and claws.  You will have to hack your way out.  Reduce your SKILL by 1 point for this fight because of your disorientation.($SKILL: -1)  Treat the many bats as a single opponent. {== (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Bats&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)|victory)[($SKILL: 1)If you win, you rejoin the main tunnel and [continue east]&lt;continue_link|.  But when you slipped over, you lost one item or one lot of Provisions from your pack.  |item_list&gt;[Choose what to remove before continuing:

{&lt;ul&gt;
	(for: each _i, ...$player&#39;s inventory)[
    	&lt;li&gt;(link-reveal: _i)[($remove_item: _i)(hide: ?item_list)(replace: ?continue_link)[[[continue east-&gt;Page 370]]]]&lt;/li&gt;
    ]
    (if: $player&#39;s provisions &gt; 0)[
    	&lt;li&gt;(link-reveal: &quot;Provisions&quot;)[($PROVISIONS: -1)(hide: ?item_list)(replace: ?continue_link)[[[continue east-&gt;Page 370]]]]&lt;/li&gt;
    ]
&lt;/ul&gt;}]
]</tw-passagedata><tw-passagedata pid="102" name="Page 370" tags="" position="3950,1675" size="100,100">Shortly, you reach a spot where the floor has subsided, and a pool of stagnant water has formed, which is about a metre deep and three metres wide.  Will you try to [[jump over-&gt;Page 239]] the pool, or [[wade through-&gt;Page 151]] it?</tw-passagedata><tw-passagedata pid="103" name="Page 319" tags="" position="1275,2150" size="100,100">(set: _yes to $player&#39;s inventory contains &quot;Garnet ring&quot;)&#39;It would indeed by tragic,&#39; continues the chief, &#39;if Morgana were to unleash her Golems upon the land.  Therefore we will aid you, if we can.  But first we require some proof that you are not hostile towards our forest.&#39;  The shaman rummages through your pack.  Can he find a (link-reveal:&quot;garnet ring&quot;)[(show:?1)]? |1)[(dialog: [(if: _yes)[Yes, you have a garnet ring.](else:)[No, you do not have a garnet ring.]]) (if: _yes)[(go-to:&quot;Page 270&quot;) [[Page 270]]](else:)[(go-to: &quot;Page 45&quot;) [[Page 45]] ] ]</tw-passagedata><tw-passagedata pid="104" name="Page 154" tags="" position="1650,2150" size="100,100">&#39;You may ask one question of us, to aid you in your quest,&#39; says the chief.  Will you ask:
{==&lt;ul&gt;
(if: $player contains &quot;galrin&quot;)[&lt;li&gt;About [[Galrin-&gt;Page 248]]?&lt;/li&gt;]
&lt;li&gt;What they have seen in the [[mirror-&gt;Page 169]]?&lt;/li&gt;
&lt;li&gt;For [[free passage-&gt;Page 69]] through the forest?&lt;/li&gt;
&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="105" name="Page 192" tags="death" position="1775,2150" size="100,100">The Elves make no move to prevent you from looking in the mirror.  But the mirror forms a vortex, which sucks you in, and you are lost for ever.</tw-passagedata><tw-passagedata pid="106" name="Page 150" tags="combat item" position="1900,2150" size="100,100">The shaman raises his hands to cast a spell, and the chief draws his sword.  With one swift movement, you draw your own sword, laughing inwardly that these stupid, trusting Elves did not disarm you, and kill the shaman.  Then you face the Elf chief.
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Wood Elf Chief&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
	),
))(display: &quot;Combat Container&quot;)|victory)[If you win, you seize your prize, the mirror.($add_item:&quot;Crystal Mirror&quot;)  Will you [[look in it-&gt;Page 209]] straight away, or [[keep it-&gt;Page 351]] for later?]</tw-passagedata><tw-passagedata pid="107" name="Page 9" tags="" position="2050,1900" size="100,100">You slip undetected inside the tree-trunk.  So far, so good.  But through a knot-hole you see that the Elves are moving roughly in your direction.  If you leave the tree-trunk, you will immediately be spotted.  Will you [[stay-&gt;Page 211]] exactly where you are, or [[climb up-&gt;Page 73]] the inside of the tree?</tw-passagedata><tw-passagedata pid="108" name="Page 48" tags="" position="1925,1900" size="100,100">You make your way at a crouch to the dip and roll expertly down the side -- and disturb a couple of pheasants, which rise noisily into the air.  Apart from the fact that the suddenness of the noise nearly have you a heart attack, the next time you look up the dell is [[ringed by Elves-&gt;Page 358]], arrows ready on taut bowstring.</tw-passagedata><tw-passagedata pid="109" name="Page 211" tags="" position="2175,2025" size="100,100">The Elves pass you by.  Later, when you judge that the coast is clear, you continue north towards [[Fallow Dale-&gt;Page 115]].</tw-passagedata><tw-passagedata pid="110" name="Page 73" tags="" position="2050,2025" size="100,100">The tree has been truncated, so it is no long or difficult climb.  From your vantage point at the top, you can see the Elves passing below you.  Will you [[keep quiet-&gt;Page 211]] and let them pass, or [[drop down-&gt;Page 286]] on the last one, who has fallen a little way behind the others?</tw-passagedata><tw-passagedata pid="111" name="Page 19" tags="" position="2925,10275" size="100,100">Do you have the (link-reveal: &quot;Horn of Hever&quot;)[(show: ?horn)]?
|horn)[{
    (if: $player&#39;s inventory contains &quot;Horn of Hever&quot;)[
        (dialog: &quot;Yes, you carry Hever&#39;s Horn.&quot;)
        (go-to: &quot;Page 335&quot;) [[Page 335]]
    ]
    (dialog: &quot;No, Hever did not give you his horn.&quot;)
    (go-to: &quot;Page 72&quot;) [[Page 72]]
}]
</tw-passagedata><tw-passagedata pid="112" name="Page 224" tags="" position="3050,10275" size="100,100">The torches on the walls are spaced further apart, and then cease altogether, as you walk on down the tunnel.  You go back and get a torch to light your way, but a strong and unnatural wind blows it out straight away, and then dies down.  Will you [[continue down this branch-&gt;Page 49]], or return and take the [[other branch-&gt;Page 19]]?</tw-passagedata><tw-passagedata pid="113" name="Page 36" tags="" position="3125,1425" size="100,100">When you peer down the shaft, you can see a series of wooden rungs set into the smooth stone side and disappearing into darkness.  A stale smell from the depths of the mine assails your nostrils.  Will you go down or not?  If not, you [[leave the area-&gt;Page 343]].  If you go down, you can either trust to the [[ladder-&gt;Page 289]] or, if you have a rope, you can tie it to a sturdy-looking beam and (link-reveal:&quot;let yourself down&quot;)[(if: $player&#39;s inventory contains &quot;Rope&quot;)[(go-to: &quot;Page 225&quot;) [[Page 225]] ](else:)[(dialog:&quot;But you don&#39;t have any rope!&quot;)]].</tw-passagedata><tw-passagedata pid="114" name="Page 289" tags="" position="3000,1550" size="100,100">The rungs of the ladder remain secure for quite a way down.  By this time, you can hear dripping below you, and the dank smell is strong, so you must be getting close to the bottom.  But the increased dampness, you find, has rotted the rungs: they get more and more wobbly, and then end altogether.  You look down and see the bottom, but cannot judge exactly how far it is; and the shaft is too wide for you to chimney out again, so once you&#39;re down there will be no exit unless you can find one in the mine itself.  Will you [[climb back-&gt;Page 175]] out, or [[let yourself go-&gt;Page 54]] into space?</tw-passagedata><tw-passagedata pid="115" name="Page 225" tags="" position="3125,1550" size="100,100">(set: $player&#39;s has_eaten to false)Just as you reach the bottom, the beam snaps, and the rope lands on top of you.  This means that you cannot use it to climb back out again.  Still, you have your rope again, and you got down in one piece.  When you look up, you notice that the last steps of the ladder are missing, and that the shaft is too wide and sheer to chimney up.  So there is no way out unless you find an exit somewhere down the tunnels.  There is a dank feel to the air; mosses and lichens have sprouted on the floor and walls of the well-made tunnel you are in, and moisture drips and forms puddles on the ground.  Will you go [[west-&gt;Page 237]] or [[east-&gt;Page 213]]?</tw-passagedata><tw-passagedata pid="116" name="Page 231" tags="" position="3250,1550" size="100,100">Will you now investigate the [[main shaft-&gt;Page 36]](if: (history:) does not contain &quot;Page 212&quot;)[ or, if you haven&#39;t already done so, the [[collapsed hut-&gt;Page 212]]]?  Or will you [[leave the area-&gt;Page 343]] altogether?</tw-passagedata><tw-passagedata pid="117" name="Page 279" tags="" position="3375,1550" size="100,100">When you move further into the hut, a shape detaches itself from the deep shadows of one of the corners and shuffles towards you.  At that moment, a beam of light, which is pouring through a small hole in the roof, illuminates your helmet.  Immediately the shape stops its shuffling, and you can now see that it is a human hermit or beggar of some kind, and he appears to be fascinated by your helmet.

The next instant, the hermit drops to the floor and grovels at your feet, like an abject servant before his master or mistress.  &#39;They told me,&#39; he whimpers, half in ecstasy, half in fear.  &#39;They told me you would come.&#39;  This is a bit alarming.  &#39;Who told you?&#39; you ask.  &#39;The voices, the voices,&#39; is all the reply you get.

The poor man is obviously crazy.  Will you [[leave-&gt;Page 231]] before the owners of &#39;the voices&#39; find you there, or [[question the hermit-&gt;Page 92]] further?</tw-passagedata><tw-passagedata pid="118" name="Page 283" tags="item" position="3525,1550" size="100,100">The passage does not extend very far, and shows signs of having been one of the more recent faces of the mine.  You find an old (link-reveal:&quot;pick-axe&quot;)[($add_item:&quot;Pick-axe Head&quot;)]: the handle has rotted away, but the head, though rusty, is sound.  You can take it, if you want, before returning to the main tunnel.  Will you [[continue west-&gt;Page 364]], or return past the main shaft and [[travel east-&gt;Page 388]]?</tw-passagedata><tw-passagedata pid="119" name="Page 364" tags="" position="3650,1550" size="100,100">Directly underneath one of the air-shafts, you find a litter of small skeletons -- presumably of animals that have fallen down -- which are partially concealing a small fissure, no more than three centimetres wide.  Will you [[investigate-&gt;Page 328]] or [[carry on-&gt;Page 57]]?</tw-passagedata><tw-passagedata pid="120" name="Page 270" tags="" position="1150,2275" size="100,100">The shaman finds the ring and goes into a trance over it.  When he returns from wherever he&#39;s been, he describes to the chief, with astonishing accuracy, your encounter with the Spriggans.  &#39;Good,&#39; declares the chief, as he [[unties your hands-&gt;Page 154]].  &#39;The Spriggans are no friends of the forest.&#39;(set: $player&#39;s tied to false)</tw-passagedata><tw-passagedata pid="121" name="Page 45" tags="" position="1275,2275" size="100,100">The shaman finds nothing which can convince him of your good intentions towards the Elves&#39; precious forest.  &#39;Well,&#39; says the chief, after some consideration, &#39;we do not wish to hinder you, but we do not want you in our forest any more.&#39;  He whispers something to the shaman, who nods and begins to mutter a spell, while the chief unties your hands.(set: $player&#39;s tied to false)  The village starts to dissolve and you feel yourself [[floating-&gt;Page 382]].</tw-passagedata><tw-passagedata pid="122" name="Page 248" tags="item" position="1775,2275" size="100,100">No sooner do you mention Galrin&#39;s name than he appears with his spectral army, and in no time at all they have razed the Elves&#39; village to the ground.  Galrin comes up to you.  &#39;Idiot!&#39; he wheezes hoarsely.  &#39;Why summon us when there was no need?&#39;  He and his army vanish, and you may not call on them again in this adventure.(set: _null to (dm:))(move: $player&#39;s galrin into _null)  Still, the pickings from the village are rich: apart from the crystal mirror, you find treasure worth 30 Gold Pieces, and a magical bow, with a quiver of arrows, that will add 1 to your SKILL score, even if that takes it over its &lt;i&gt;Initial&lt;/i&gt; level.  Will you [[look in the mirror-&gt;Page 209]] or stow it away in your pack and [[continue on your way-&gt;Page 115]]?($GOLD: 30)($add_item: &quot;Crystal Mirror&quot;)($add_item: &quot;Magical Bow&quot;)(set: $player&#39;s skill to it + 1)</tw-passagedata><tw-passagedata pid="123" name="Page 169" tags="" position="1475,2275" size="100,100">&#39;Take a look for yourself,&#39; says the chief, and hands you the mirror.  At first, when you look in it, it is cloudy; but presently a brief image of startling clarity and potency emerges.  You see yourself standing between two majestic oaks; your arms are raised into the air, and each hand is holding an object.  But the image is instantaneous, and you have time only to see that one of the objects is long, before the mirror returns to its former cloudy state.  Still, there is no doubt that you will remember this if you ever find yourself in such a spot.  Add 1 LUCK point.($LUCK: 1)

You hand the mirror back to the chief.  He and the shaman smile at you knowingly.  &#39;There is more that we have seen,&#39; says the shaman, &#39;but to tell you would deprive you of free choice, which is what determines a hero.  There are riddles for the hearing and sigils for the seeing, and danger at every turn.  But now you must continue your quest elsewhere.&#39;  He mutters a spell: the village begins to dissolve and you feel yourself [[floating-&gt;Page 382]].(set: $player&#39;s vision to true)</tw-passagedata><tw-passagedata pid="124" name="Page 69" tags="" position="1600,2400" size="100,100">&#39;Easily done,&#39; says the chief.  He whispers something to the shaman, who nods and begins to cast a spell.  The village starts to dissolve and you feel yourself [[floating-&gt;Page 382]].</tw-passagedata><tw-passagedata pid="125" name="Page 209" tags="death" position="1900,2275" size="100,100">The mirror forms a vortex, which sucks you in, and you are lost for ever.</tw-passagedata><tw-passagedata pid="126" name="Page 351" tags="" position="2025,2275" size="100,100">You sneak out of the chief&#39;s hut, which is easy because it is set apart from the other huts, and continue towards [[Fallow Dale-&gt;Page 115]].</tw-passagedata><tw-passagedata pid="127" name="Page 286" tags="" position="1925,2025" size="100,100">You let yourself fall, simultaneously aiming the butt of your sword at the Elf&#39;s head.  He crumples unconscious to the ground.  But inevitably the other sharp-eared Elves hear what is going on, and you are quickly surrounded and marched away through the forest.  Will you make a [[break for it-&gt;Page 130]], or [[let yourself be taken-&gt;Page 358]] wherever you are going?</tw-passagedata><tw-passagedata pid="128" name="Page 175" tags="" position="2875,1675" size="100,100">On emerging, you see a number of horsemen lining the ridge to the south.  You decide [[not to linger-&gt;Page 343]] in the area.</tw-passagedata><tw-passagedata pid="129" name="Page 54" tags="" position="3000,1675" size="100,100">($test_your_luck:)
|lucky)[(go-to: &quot;Page 124&quot;) [[Page 124]] ]
|unlucky)[(go-to: &quot;Page 18&quot;) [[Page 18]] ]</tw-passagedata><tw-passagedata pid="130" name="Page 237" tags="" position="3125,1675" size="100,100">As you proceed west, you notice that there are evenly spaced shafts, smaller than the one you came down, drilled through to the ground above.  These afford light and air, but are out of reach and unclimbable.  You conclude that the mine was once worked by slaves, who needed to breathe and see, but also had to be prevented from escaping.

It turns out that this was a copper mine; the vein is worked out, but you find a nugget of greenish ore, and keep it.($add_item: &quot;Copper Nugget&quot;)  Later, a side-passage opens up to your left.  Will you [[take it-&gt;Page 283]], or continue along the [[main tunnel-&gt;Page 364]]?</tw-passagedata><tw-passagedata pid="131" name="Page 213" tags="" position="3250,1675" size="100,100">As you proceed east, you notice that there are evenly spaced shafts, smaller than the one you came down, drilled through to the ground above.  These afford light and air, but are out of reach and unclimbable.  You conclude that the mine was once worked by slaves, who needed to breathe and see, but also had to be prevented from escaping.

It turns out that this was a copper mine; the vein is worked out, but you find a nugget of greenish ore, and keep it.($add_item: &quot;Copper Nugget&quot;)  Later, a side-passage opens up to your right; a truly horrible smell is issuing from it.  Will you [[take it-&gt;Page 325]], or continue along the [[main tunnel-&gt;Page 370]]?</tw-passagedata><tw-passagedata pid="132" name="Page 92" tags="item key" position="3375,1675" size="100,100">You can get nothing more out of him, but while you question him, he sidles off to the side of the room and, cringing, brings back a bundle of rags, which he offers to you.  When you unwrap them, you discover a magnificent sceptre.  It is made only of iron, but is clearly of great age and has an aura of regal authority.  You want to ask the old man about it, but he has collapsed unconscious on the floor.  As you are stowing the sceptre safely in your pack, you notice that it is inscribed with runes, which you translate as &#39;There should be just one ruler.&#39;  Then you [[leave-&gt;Page 231]].($add_item: &quot;Iron Sceptre&quot;)</tw-passagedata><tw-passagedata pid="133" name="Page 328" tags="death" position="3525,1675" size="100,100">While you delay to investigate the crack, you make an easy target for a Blackheart hunter who happens to looks down the shaft from above.  Purely out of malice, he fires a black-feathered arrow down the shaft and into your back.  A somewhat larger skeleton will join the others.</tw-passagedata><tw-passagedata pid="134" name="Page 57" tags="" position="3650,1675" size="100,100">The tunnel begins to slope upwards, which makes you hopeful of finding a way out soon.  But then the shaft comes to an end, and the way ahead is pitch-black and the air gets foul.  At first you wonder why the shafts should end; but then you reckon that you may be under the lake.  Will you [[plod on-&gt;Page 352]] through the darkness, or [[retrace-&gt;Page 388]] the kilometre or so you have already travelled, back past the main shaft, in an easterly direction?</tw-passagedata><tw-passagedata pid="135" name="Page 239" tags="" position="3950,1800" size="100,100">You pace back along the tunnel to make a running jump.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 160&quot;) [[Page 160]] ]
|unlucky)[(go-to: &quot;Page 260&quot;) [[Page 260]] ]</tw-passagedata><tw-passagedata pid="136" name="Page 151" tags="" position="4125,1800" size="100,100">When you are about halfway across, the Water Snake which inhabits the pool coils itself around your legs.  This really makes it very difficult to walk.  Will you [[poke at the Water Snake-&gt;Page 127]] with your sword, or [[carry on-&gt;Page 104]] struggling through?</tw-passagedata><tw-passagedata pid="137" name="Page 382" tags="" position="1475,2400" size="100,100">You find yourself among mist-shrouded hills. The position of the sun, dimly perceived behind the mist, tells you that you have been transported to the eastern side of the lake, well away from the Elves&#39; forest.  Will you [[stay where you are-&gt;Page 27]] until the mist clears, or [[press on-&gt;Page 138]] regardless?</tw-passagedata><tw-passagedata pid="138" name="Page 124" tags="" position="3025,1800" size="100,100">[[You land safely-&gt;Page 313]].</tw-passagedata><tw-passagedata pid="139" name="Page 18" tags="" position="2925,1925" size="100,100">You land awkwardly (lose 2 STAMINA points), but basically [[unharmed-&gt;Page 313]].($STAMINA: -2)</tw-passagedata><tw-passagedata pid="140" name="Page 352" tags="" position="3525,1800" size="100,100">($test_your_luck:)
|lucky)[(go-to: &quot;Page 373&quot;) [[Page 373]] ]
|unlucky)[(go-to: &quot;Page 163&quot;) [[Page 163]] ]</tw-passagedata><tw-passagedata pid="141" name="Page 313" tags="" position="3175,1925" size="100,100">(set: $player&#39;s has_eaten to false)You pick yourself up and look around.  Mosses and lichen have sprouted on the floor and the well-made walls, and moisture drips and forms puddles.  The tunnel extends in both directions.  Will you go [[west-&gt;Page 237]] or [[east-&gt;Page 213]]?</tw-passagedata><tw-passagedata pid="142" name="Page 373" tags="" position="3525,1925" size="100,100">You walk on and on, unaware that you have fortunately crossed a narrow span of stone over a chasm.  Much later, the tunnel narrows, and you keep pressed to the wall to avoid bumping into the sides all the time.  Will you keep to the [[right-hand wall-&gt;Page 61]] or the [[left-hand wall-&gt;Page 309]]?</tw-passagedata><tw-passagedata pid="143" name="Page 163" tags="death" position="3275,2050" size="100,100">You step into thin air.  Your adventure ends at the bottom of a chasm.</tw-passagedata><tw-passagedata pid="144" name="Page 160" tags="" position="3875,1925" size="100,100">($test_your_luck:) again.
|lucky)[(go-to: &quot;Page 219&quot;) [[Page 219]] ]
|unlucky)[(go-to: &quot;Page 349&quot;) [[Page 349]] ]</tw-passagedata><tw-passagedata pid="145" name="Page 260" tags="death" position="4000,1925" size="100,100">Your final step, which is intended to launch you over the pool, lands you squarely on a clump of slippery lichen.  You fall heavily on your back and bang your head, and your momentum carries you into the pool, where a Water Snake completes your doom.  Your adventure is over.</tw-passagedata><tw-passagedata pid="146" name="Page 127" tags="" position="4250,1925" size="100,100">(link-reveal: &quot;Roll two dice&quot;)[{
	(set: _roll to ($ROLL2:))
    (set: _yes to _roll &lt; $player&#39;s skill)
    (set: _label to (cond: _yes, &quot;Less than your SKILL&quot;, &quot;Greater than or equal to your SKILL&quot;))
    (dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)], _label)
    (if: _yes)[(go-to: &quot;Page 228&quot;) [[Page 228]] ](else:)[(go-to: &quot;Page 203&quot; [[Page 203]] ]
}] and compare the total to your SKILL score.
</tw-passagedata><tw-passagedata pid="147" name="Page 104" tags="" position="4125,2050" size="100,100">Is your STAMINA (link-reveal:&quot;less than 12&quot;)[{
    (set: _yes to $player&#39;s stamina &lt; 12)
    (set: _label to (cond: _yes, &quot;Less than 12&quot;, &quot;Greater than or equal to 12&quot;))
    (dialog: [Your STAMINA is (print: $player&#39;s stamina)], _label)
    (if: _yes)[(go-to: &quot;Page 197&quot;) [[Page 197]] ](else:)[(go-to: &quot;Page 15&quot;) [[Page 15]] ]

}]?
(hide: ?sidebar_provisions)</tw-passagedata><tw-passagedata pid="148" name="Page 61" tags="" position="3400,2050" size="100,100">Soon you are crawling on hands and knees; then the tunnel ends.  You turn around.  On the way back, will you keep pressed to the [[right-hand wall-&gt;Page 309]] or the [[left-hand wall-&gt;Page 141]]?</tw-passagedata><tw-passagedata pid="149" name="Page 309" tags="combat" position="3525,2050" size="100,100">After a while the wall abruptly comes to an end.  You lose your balance and fall into a room hollowed out of the rock.  There are confused scuffles, and then a lamp is lit.  Perhaps this was once a guard-room for whatever beings were in charge of the mine, but now it is occupied by a family of Doragars!  Doragars are an immensely strong race, a cross between Orcs and Trolls, and were often used for hard physical labour like mining.  It may be that this family is descended from the very slaves who once worked the mine.  But you have no time to ask this lot about their ancestry.  The male Doragar is attacking, wielding an axe, while the female picks up the two young ones and runs screaming down the tunnel to the west. {== (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Doragar&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)|victory)[If you win, you [[search the room-&gt;Page 172]].  Doragars are famous for hoarding trinkets.] </tw-passagedata><tw-passagedata pid="150" name="Page 219" tags="" position="3875,2050" size="100,100">You clear the pool and land safely.  You carry on for several more kilometres.  If you have not stopped to rest and eat Provisions so far during your underground journey, you must reduce your STAMINA by two points.(if: $player&#39;s has_eaten is false)[($STAMINA: -2)]  The monotonous single tunnel eventually comes to a fork.  Will you take the [[left branch-&gt;Page 399]] or the [[right branch-&gt;Page 276]]?</tw-passagedata><tw-passagedata pid="151" name="Page 349" tags="death" position="3750,1925" size="100,100">You just clear the pool, but land on a clump of slippery lichen, and fall over backwards into the water.  A Water Snake coils itself around your neck and holds you under until you drown.</tw-passagedata><tw-passagedata pid="152" name="Page 228" tags="" position="4375,2050" size="100,100">You succeed in wounding the Snake without also injuring yourself.  The Snake remains coiled around your legs, but it is now easier for you to [[wade through the water-&gt;Page 15]].</tw-passagedata><tw-passagedata pid="153" name="Page 203" tags="" position="4250,2050" size="100,100">You misjudge your stroke, and jab yourself in the leg.  Lose 2 STAMINA points.  ($STAMINA: -2)You decide to [[push through the pool-&gt;Page 104]] by sheer strength.</tw-passagedata><tw-passagedata pid="154" name="Page 197" tags="death" position="4000,2050" size="100,100">It is no good. The Water Snake trips you up and keeps you under the water until you drown.</tw-passagedata><tw-passagedata pid="155" name="Page 15" tags="" position="4250,2175" size="100,100">You struggle to the other side of the pool, where it is easy to dispatch the Snake with your sword.  Thanking your lucky stars that it was not poisonous as well, you carry on for several more kilometres.  If you have not stopped to rest and eat Provisions so far during your underground journey, you must reduce your STAMINA by 2 points.(if: $player&#39;s has_eaten is false)[($STAMINA: -2)]

The monotonous single tunnel eventually comes to a fork.  Will you take the [[left branch-&gt;Page 399]] or the [[right branch-&gt;Page 276]]?</tw-passagedata><tw-passagedata pid="156" name="Page 141" tags="" position="3400,2175" size="100,100">($test_your_luck:).
|lucky)[(go-to: &quot;Page 86&quot;) [[Page 86]] ]
|unlucky)[(go-to: &quot;Page 163&quot;) [[Page 163]] ]</tw-passagedata><tw-passagedata pid="157" name="Page 172" tags="" position="3525,2175" size="100,100">{==
(set:_count to 4)
There is quite a collection of stuff, mostly worthless.  You don&#39;t have time to make a thorough search, in case the female returns and sees what you&#39;ve done to her husband; but you have time to grab &lt;i&gt;three&lt;/i&gt; of the following items:
a (link-reveal:&quot;plain brass ear-ring&quot;)[($add_item:&quot;Brass Ear-ring&quot;)(rerun:?countdown)]&lt;list_item||plaintext)[plain brass ear-ring];
a (link-reveal:&quot;Snattacat&#39;s tusk&quot;)[($add_item:&quot;Snattacat&#39;s Tusk&quot;)(rerun:?countdown)]&lt;list_item||plaintext)[Snattacat&#39;s tusk], which has been engraved with delicate interweaving patterns;
a (link-reveal:&quot;leather pouch&quot;)[($add_item:&quot;Leather Pouch&quot;)(rerun:?countdown)]&lt;list_item||plaintext)[leather pouch], which is tightly closed with a drawstring;
(link-reveal:&quot;5 Gold Pieces&quot;)[($GOLD: 5)(rerun:?countdown)]&lt;list_item||plaintext)[5 Gold Pieces];
a (link-reveal:&quot;stone statuette&quot;)[($add_item:&quot;Stone Statuette&quot;)(rerun:?countdown)]&lt;list_item||plaintext)[stone statuette] of some goddess;
an empty (link-reveal:&quot;water-flask&quot;)[($add_item:&quot;Water Flask&quot;)(set: $player&#39;s provision_strength to 4)(rerun:?countdown)]&lt;list_item||plaintext)[water-flask].  Choose what to take, then, since you don&#39;t want to meet the rest of the Doragar family, turn [[east-&gt;Page 141]].
|countdown&gt;[(set: _count to it - 1)(if: _count is 0)[(hide: ?list_item)(show:?plaintext)]]</tw-passagedata><tw-passagedata pid="158" name="Page 399" tags="" position="3875,2300" size="100,100">As you trudge down this seemingly endless tunnel, the light fades from the shafts: it is night.  But eventually you hear ahead of you the chuckling of a spring, and, to judge by the lack of echo, it is not enclosed but out in the open.  The tunnel is coming to an exit!  However you also start to hear the shuffling of a large creature of some kind.  It is impossible to tell in the darkness how far ahead it might be.  Will you [[press on-&gt;Page 51]] stealthily, or risk a [[sprint-&gt;Page 147]] for the open air?</tw-passagedata><tw-passagedata pid="159" name="Page 276" tags="" position="4125,2300" size="100,100">(set: _yes to $player&#39;s inventory contains &quot;Pick-axe Head&quot;)After a couple of hundred metres, you reach a recent cave-in.  Although it is pretty solid, you can smell fresh air seeping through the cracks, and faintly hear birds singing from the other side.  You could try to clear the rock-fall [[with your hands-&gt;Page 118]] or a (link-reveal:&quot;pick-axe head&quot;)[(show:?1)], if you have one; or you could despondently [[return to the fork-&gt;Page 399]] and try the other branch, hoping that this too leads towards the outside.
|1)[(if: _yes)[ (go-to:&quot;Page 292&quot;) [[Page 292]] ](else:)[(dialog:&quot;You do not have a pick-axe head.&quot;)] ]</tw-passagedata><tw-passagedata pid="160" name="Page 86" tags="" position="3650,2175" size="100,100">Again you safely cross the chasm in the darkness.  The gods must be smiling on you.  Regain 1 LUCK point.  ($LUCK: 1)If you have not stopped to eat Provisions so far during your underground journey, lose 2 STAMINA points.(if: $player&#39;s has_eaten is false)[($STAMINA: -2)]  Your journey is long, but nothing happens.  You pass the spot where the main shaft enters the mine and [[carry on-&gt;Page 388]] eastwards.</tw-passagedata><tw-passagedata pid="161" name="Page 51" tags="" position="3875,2425" size="100,100">You find that the tunnel curves.  You peep around the corner and see a monstrous silhouette against a star-spangled night sky, visible through the tunnel mouth.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 33&quot;) [[Page 33]] ]
|unlucky)[(go-to: &quot;Page 6&quot;) [[Page 6]] ]</tw-passagedata><tw-passagedata pid="162" name="Page 147" tags="" position="3750,2425" size="100,100">The tunnel curves, but you are unaware of this in the darkness, and you run [[straight into the side-&gt;Page 101]].  Reduce your STAMINA by 1 point.($STAMINA: -1)</tw-passagedata><tw-passagedata pid="163" name="Page 118" tags="" position="4000,2425" size="100,100">This gets you nowhere, but your increasingly frantic and frustrated scrabbling loses you 3 STAMINA points.  ($STAMINA: -3)Eventually you give up and return to try the [[other branch-&gt;Page 399]] of the tunnel.</tw-passagedata><tw-passagedata pid="164" name="Page 292" tags="death" position="4125,2425" size="100,100">You manage to clear a few smaller rocks, but then struggle with a larger one, which is thoroughly wedged.  But by using the pick-axe as a crowbar, you get enough leverage to dislodge it -- and cause the whole roof to crash on top of you.  Your adventure is over.</tw-passagedata><tw-passagedata pid="165" name="Page 33" tags="" position="3875,2550" size="100,100">(link-reveal: &quot;Roll two dice&quot;)[{
	(set: _roll to ($ROLL2:))
    (set: _yes to _roll &lt; $player&#39;s skill)
    (set: _label to (cond: _yes, &quot;Less than your SKILL&quot;, &quot;Greater than or equal to your SKILL&quot;))
    (dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)], _label)
    (if: _yes)[(go-to: &quot;Page 64&quot;) [[Page 64]] ](else:)[(go-to: &quot;Page 6&quot;) [[Page 6]] ]
}] and compare the total to your SKILL score.
</tw-passagedata><tw-passagedata pid="166" name="Page 6" tags="" position="3750,2550" size="100,100">You tread on something, probably a bone, since that is what it [[sounds like-&gt;Page 101]].</tw-passagedata><tw-passagedata pid="167" name="Page 101" tags="combat" position="3625,2550" size="100,100">The noise you made has alerted the creature, and you hear it lumbering towards you.  An easily-recognizable grunt soon lets you know what you are up against -- a Nandibear.  It must have been using the entrance to the mine as its den.  Then it is upon you.  Reduce your SKILL by 1 point for this fight, because of the darkness. ($SKILL: -1)
{== (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Nandibear&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 11,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)|victory)[(set: $player&#39;s skill to it + 1)If you win, you may [[continue-&gt;Page 222]] towards the surface.]</tw-passagedata><tw-passagedata pid="168" name="Page 64" tags="combat" position="3750,2675" size="100,100">You use your head, and grope for something on the floor -- it turns out, by the feel of it, to be a small skull.  You toss this so that it lands in the tunnel mouth, and the creature lumbers over there.  This enables you to see your opponent clearly.  It is a Nandibear, which must have been using the entrance to the mine as its den.

You will have to fight it, but you are able to creep up behind it and wound it first ((link-reveal:&quot;Roll one die&quot;)[(show:?1)] and reduce its STAMINA by that much), and also to fight it in the tunnel mouth where your SKILL will not be impaired by darkness.  |1)[{
	(set: _roll to ($ROLL1:))
    (dialog: [You roll: (print: _roll)])
	(set: _stamina to 11 - _roll)
    (set: $combat&#39;s opponents to (a:
	    (dm:
            &quot;name&quot;, &quot;Nandibear&quot;,
            &quot;skill&quot;, 9,
            &quot;stamina&quot;, _stamina,
            &quot;article&quot;, &quot;the&quot;,
            &quot;prefix&quot;, &quot;&quot;
	    )
    ))
} (display: &quot;Combat Container&quot;)] |victory)[If you win, you may [[continue-&gt;Page 222]] towards the surface.]</tw-passagedata><tw-passagedata pid="169" name="Page 222" tags="" position="3625,2675" size="100,100">(set: _yes to (history:) contains &quot;Page 309&quot;)You decide to spend the night in the Nandibear&#39;s cave.  You use your flints and tinder to start a fire out of sticks and logs which you find in and around the cave, and make yourself comfortable.  Did you meet the (link-reveal:&quot;Doragar family&quot;)[(show: ?1)] in the mine?
|1)[(if: _yes)[ (dialog: &quot;Yes, you met the Doragars&quot;)(go-to:&quot;Page 112&quot;) [[Page 112]] ](else:)[(dialog:&quot;You did not encounter the Doragars&quot;)(go-to: &quot;Page 121&quot;) [[Page 121]] ] ]</tw-passagedata><tw-passagedata pid="170" name="Page 112" tags="" position="3750,2800" size="100,100">{==
(if: $items_of_interest is 0)[
    (set: $items_of_interest to (a:
        (dm: &quot;name&quot;, &quot;Snattacat&#39;s Tusk&quot;, &quot;page&quot;, &quot;Page 301&quot;),
        (dm: &quot;name&quot;, &quot;Leather Pouch&quot;, &quot;page&quot;, &quot;Page 331&quot;),
        (dm: &quot;name&quot;, &quot;Stone Statuette&quot;, &quot;page&quot;, &quot;Page 30&quot;)
    ))
]
You decide to inspect the items you acquired in the Doragars&#39; lair.  You soon find that some of them are just what they seem.  But do you have:
&lt;ul&gt;
    (for: each _item, ...$items_of_interest)[
        (if: $player&#39;s inventory contains _item&#39;s name)[
            &lt;li&gt;A (link-reveal: _item&#39;s name)[(set: $items_of_interest to it - (a: _item))(go-to: _item&#39;s page)]?&lt;/li&gt;
        ](else:)[
            &lt;li&gt;A (link-reveal: _item&#39;s name)[(dialog: [You do not have the (print: _item&#39;s name)])]?&lt;/li&gt;
        ]
    ]
    &lt;li&gt;[[None of these-&gt;Page 121]]?&lt;/li&gt;
&lt;/ul&gt;

|hiddenlinks)[
  &lt;ul&gt;
      &lt;li&gt;A [[Snattacat&#39;s tusk-&gt;Page 301]]?&lt;/li&gt;
      &lt;li&gt;A [[leather pouch-&gt;Page 331]]?&lt;/li&gt;
      &lt;li&gt;A [[statuette-&gt;Page 30]]?&lt;/li&gt;
      &lt;li&gt;[[None of these-&gt;Page 121]]?&lt;/li&gt;
  &lt;/ul&gt;
]
</tw-passagedata><tw-passagedata pid="171" name="Page 121" tags="" position="3500,2800" size="100,100">{==You rest, eat Provisions, and drink fresh water from the nearby spring.
(if: $player&#39;s provisions &gt; 0)[
    ($STAMINA: 4)
    ($PROVISIONS: -1)
](else:) [
    ($STAMINA: 2)
]
If you have no Provisions, restore only 2 STAMINA points for the rest and drink; otherwise, restore the full 4 STAMINA points.  In either case, you may add 2 LUCK points ($LUCK:2) for surviving the deadly mine.  In the morning, you reluctantly [[leave-&gt;Page 343]] this haven.</tw-passagedata><tw-passagedata pid="172" name="Page 331" tags="death" position="3625,2925" size="100,100">When you pick up the pouch and loosen the drawstring, you release the tiny Flame Asp which was nestling inside.  It bites you on the hand.  The poison takes five seconds to paralyse you, and ten to kill you.</tw-passagedata><tw-passagedata pid="173" name="Page 301" tags="" position="3750,2925" size="100,100">On close inspection, the tusk turns out to have eleven tiny dragons intricately engraved on it; it also has a lid, which you screw off.  Inside you find eight identical seeds -- they look like apple pips to you.  Somebody has gone to a lot of trouble over them, so you decide to hang on to them.  Now return and [[choose again-&gt;Page 112]].</tw-passagedata><tw-passagedata pid="174" name="Page 30" tags="" position="3500,2925" size="100,100">On the base of the statue are runes which give the goddess&#39;s name as Cholumbara, a minor agricultural deity of Khul.($remove_item: &quot;Stone Statuette&quot;)($add_item:&quot;Cholumbara&quot;)  Now return and [[choose again-&gt;Page 112]].</tw-passagedata><tw-passagedata pid="175" name="Page 305" tags="" position="2400,2350" size="100,100">There are few people out in the street.  An old woman weaving baskets outside her front door eyes you curiously, and the blacksmith, a hulking man with at least a few pints of Troll blood in his veins, stops working while you pass.  Will you go into the [[village inn-&gt;Page 99]], or are you so badly hurt and wounded that you ask the blacksmith for the way to the [[local healer-&gt;Page 152]]?</tw-passagedata><tw-passagedata pid="176" name="Page 396" tags="" position="2750,2350" size="100,100">{==
When you reach the far side of the field, you stop to remove the mud which has stuck to your boots and is weighing them down.  When you look up from your task, you find the farmer glowering at you.  By his side are two snarling Kalagarian Ridgebacks -- half dog, half wolf, highly intelligent killers.  No doubt you could take all three of them on, but you don&#39;t want to offend Hever by harming any of his people, so when the farmer rages at you from trampling over his newly seeded field, you offer to pay for any damage you may have caused.  Will you offer:

&lt;ul&gt;
&lt;li&gt;(link-reveal:&quot;2 Gold Pieces&quot;)[(if: $player&#39;s gold &gt; 2)[(go-to: &quot;Page 299&quot;) [[Page 299]] ](else:)[(dialog: &quot;You do not have 2 Gold Pieces&quot;)]]?&lt;/li&gt;
&lt;li&gt;(link-reveal:&quot;Cholumbara&quot;)[(if: $player&#39;s inventory contains &quot;Cholumbara&quot;)[(go-to: &quot;Page 66&quot;) [[Page 66]]](else:)[(dialog: &quot;You do not have Cholumbara&quot;)]]?&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;copper nugget&quot;)[(if: $player&#39;s inventory contains &quot;Copper Nugget&quot;)[(go-to: &quot;Page 205&quot;) [[Page 205]]](else:)[(dialog: &quot;You do not have a copper nugget&quot;)]]?&lt;/li&gt;
&lt;/ul&gt;

(if: $player&#39;s gold &lt; 2 and $player&#39;s inventory does not contain &quot;Cholumbara&quot;)[&lt;p&gt;If you have none of these, you will have to make [[other arrangements-&gt;Page 266]].]</tw-passagedata><tw-passagedata pid="177" name="Page 99" tags="" position="2275,2475" size="100,100">For 1 Gold Piece you can (link-reveal:&quot;buy food and drink&quot;)[(show:?buy)] that will restore 2 STAMINA points.  Do so, if you can and want to, then you [[leave the village-&gt;Page 24]].
|buy)[(if: $player&#39;s gold &gt; 0)[($STAMINA: 2)($GOLD: -1)](else:)[(dialog: &quot;You don&#39;t have 1 Gold Piece.&quot;)]]</tw-passagedata><tw-passagedata pid="178" name="Page 152" tags="" position="2400,2475" size="100,100">When you reach the healer&#39;s house, she explains that she needs sorrel to (link-reveal:&quot;make a lotion&quot;)[(show: ?heal)] strong enough to help you.  If you have some sorrel, the lotion will restore 4 STAMINA points.  Otherwise, you [[leave the village-&gt;Page 24]], reckoning that Hever&#39;s hospitality will do you some good.
|heal)[(if: $player&#39;s inventory contains &quot;Sorrel&quot;)[($remove_item: &quot;Sorrel&quot;)($STAMINA: 4)](else:)[(dialog: &quot;You do not have any sorrel.&quot;)]]</tw-passagedata><tw-passagedata pid="179" name="Page 66" tags="" position="2875,2475" size="100,100">($remove_item: &quot;Cholumbara&quot;)The farmer is overjoyed at your gift.  &#39;This will more than compensate,&#39; he says.  &#39;Cholumbara&#39;s presence will increase my crops for sure.&#39;  You are pleased to have got out of an ugly situation so easily (and also to have shed the weight of the statuette.)  Add 1 LUCK point. ($LUCK: 1) You make your way now to the [[castle gates-&gt;Page 78]].</tw-passagedata><tw-passagedata pid="180" name="Page 299" tags="" position="2750,2475" size="100,100">($GOLD: -2)The farmer grumbles a bit, but accepts the money and lets you cross his land.  You make your way to the [[castle gates-&gt;Page 78]].</tw-passagedata><tw-passagedata pid="181" name="Page 205" tags="" position="3000,2475" size="100,100">($remove_item: &quot;Copper Nugget&quot;)The farmer laughs out loud. &#39;What would I be wanting with this lump of rubbish?&#39; he asks, tossing it into a hedge.  You will have to [[choose again-&gt;Page 396]].</tw-passagedata><tw-passagedata pid="182" name="Page 266" tags="" position="3125,2475" size="100,100">You offer to pay him by the sweat of your brow.  The farmer agrees, and puts you to work cleaning out his pig-sties, which (as he explains) should have been done years ago.  Lose 2 STAMINA points for the work, and 1 LUCK point for the ignominy.  ($STAMINA: -2)($LUCK: -1) When you have finished, you make your way to the [[castle gates-&gt;Page 78]].</tw-passagedata><tw-passagedata pid="183" name="Page 78" tags="" position="2750,2600" size="200,100">It is evening when you reach the gates.  Two Dwarf guards ask your business, then show you inside to a sparsely furnished waiting-room.  One of them returns before long.  &#39;My Lord Hever is dining,&#39; he says, &#39;and asks whether you will join him.&#39;  Will you accept and go [[straight away-&gt;Page 42]], or ask to be [[shown to your room-&gt;Page 120]] first?(set: $player&#39;s going_alone to true)</tw-passagedata><tw-passagedata pid="184" name="Page 24" tags="" position="2400,2600" size="100,100">Will you [[continue-&gt;Page 312]] along the road, or turn to cross the [[ploughed field-&gt;Page 396]] you saw earlier?</tw-passagedata><tw-passagedata pid="185" name="Page 312" tags="" position="2525,2600" size="100,100">(set: _count to 4)A couple of villagers catch you up.  They are somewhat the worse for drink (the local medlar wine is pretty potent.)  They take up positions, one to either side of you, and then talk as if you weren&#39;t there at all.  &#39;A stranger.&#39;  &#39;Yes, I don&#39;t hold with strangers.&#39;  &#39;Nor me.&#39;  &#39;Let&#39;s roll this one.&#39;

You have no wish to offend Hever by seriously hurting any of his people, but you will have to defend yourself against these two thugs.  You lay aside your weapons, roll up your sleeves, and use the noble art of fisticuffs.  [(link-repeat:&quot;Roll one die&quot;)[{
    (show: ?battle_wrapper)
    (append: ?battle)[&lt;li&gt;
    	(set: _roll to ($ROLL1:))
        You roll: (print: _roll).  
        (if: _roll &lt;= 2)[If you roll 1 or 2, they have managed to hit you, and you must reduce your STAMINA by 1 point.($STAMINA: -1)]
        (else-if: _roll &lt;= 4)[If you roll 3 or 4, you dodge their blows, but they block yours.]
        (else:)[If you roll 5 or 6, you have succeeded in landing a blow.(rerun: ?countdown)]
    &lt;/li&gt;]
}].]&lt;action| Once you have hit them three times, they will run away|escape)[, and you can make your way to the [[castle gates-&gt;Page 78]]].

|battle_wrapper)[{&lt;ol&gt;
    []&lt;battle|
    [&lt;li&gt;Once you have hit them three times, they will run away, and you can make your way to the [[castle gates-&gt;Page 78]].&lt;/li&gt;](escape|
&lt;/ol&gt;}]

|countdown&gt;[(set: _count to it - 1)(if: _count is 0)[(hide: ?action)(show: ?escape)]]</tw-passagedata><tw-passagedata pid="186" name="Page 120" tags="combat" position="2875,2725" size="100,100">You are shown to a room in the north-east tower, whose slit window overlooks Fallow Dale and as far as the beginning of Pikestaff Plain.  The guard waits outside while you shed your pack and helmet (but retain your sword), and repair your appearance as much as possible.  You are just finishing, when there is a commotion in the corridor outside.  You open the door to see a Pygmy Orc withdrawing a dagger from the guard&#39;s body.  You draw your sword and challenge the Orc.  Your opponent may be small, but he is nimble: he ducks your thrusts and is hard to wound.{ (set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Pygmy Orc&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))
|combat_loop&gt;[
	(if: $combat&#39;s round is 2)[
    	(set: $combat&#39;s opponents to (a:))
        (rerun: ?combat_container)
        (show: ?escape)
    ]
]
}(display: &quot;Combat Container&quot;)

|escape)[After two Attack Rounds, you both hear more soldiers approaching at a run.  The Orc darts away around a corner.  Will you [[follow-&gt;Page 8]], or [[wait-&gt;Page 111]] for these reinforcements?]</tw-passagedata><tw-passagedata pid="187" name="Page 42" tags="" position="2725,2725" size="100,100">You enter the feast-room.  Seated at the tables is a strange assortment of creatures.  Humans rub shoulders with Elves; Bird Men are talking with Dwarf warriors; there is even a friendly Giant, tucking into half a roasted ox.  But over them all, lord of his own domain, sits Hever, to whom anger and merriment are equally pleasing.  You are led to the high table, where the place of honour at Hever&#39;s right hand has been kept free for you.  &#39;You are welcome, cousin,&#39; booms Hever.  &#39;For so I think I may address you.  Be seated, and forget your tiresome journey for the hours that you pass here.  Why don&#39;t I have your things taken up to your room?&#39;  If you [[accept-&gt;Page 71]], you retain your sword, but your other belongings are taken away by the guard who ushered you into the great hall.  Or do you [[decline-&gt;Page 389]]?</tw-passagedata><tw-passagedata pid="188" name="Page 71" tags="" position="2725,2850" size="100,100">($remove_item: &quot;Helmet of Arion&quot;)The meal is well in progress (restore 4 STAMINA points)($STAMINA: 4) when the guard returns with a worrying tale.  He was attacked by some Pygmy Orcs inside your room, and knocked unconscious.  When he came to, your helmet had gone and there was no sign of the thieves.  You immediately ask to be directed to your room, while Hever is busy organizing a search-party.  When you get there, you soon find a rope dangling out of the window to the ground below, which is outside the castle walls.  Will you grab your belongings and [[go alone-&gt;Page 166]] down the rope in pursuit of the thieves, or [[wait for Hever-&gt;Page 137]]?</tw-passagedata><tw-passagedata pid="189" name="Page 389" tags="" position="2475,2850" size="100,100">&#39;No matter, no matter,&#39; laughs Hever, &#39;if that&#39;s how you want to sit at the table.&#39;  You talk about your respective cultures during the feast, although at the back of your mind is the matter of Hever&#39;s horn and how to ask him about it.  When the meal is over (restore 4 STAMINA points)($STAMINA: 4), Hever invites you to join him in his Privy Chamber to listen to the castle bard.  The wine you drank at the feast is already making your limbs feel like lead.  Refreshing sleep seems not just desirable, but necessary.  Will you [[politely refuse-&gt;Page 26]] Hever&#39;s invitation and ask to be shown to your room, or will you [[go with him-&gt;Page 184]]?</tw-passagedata><tw-passagedata pid="190" name="Page 8" tags="" position="3000,2850" size="100,100">The Orc is nowhere to be seen.  You soon realize that you could easily get lost among the corridors and staircases of the castle, so you [[return to your room-&gt;Page 111]], and find several other guards, some bending over their comrade, others looking around warily.</tw-passagedata><tw-passagedata pid="191" name="Page 111" tags="" position="2875,2850" size="100,100">($remove_item: &quot;Helmet of Arion&quot;)The soldiers don&#39;t know you, of course, and there you are with your sword drawn, and there is their friend&#39;s corpse: it all looks very suspicious.  They push you into your room and post guards outside, while others go off to report the incident.  When you look around your room you see that your helmet is missing, and you soon find a rope dangling out of the window to the ground below.  The thief or thieves, who were presumably in league with the Orc, must have escaped that way.  Will you grab your things and [[go down the rope-&gt;Page 166]] yourself in pursuit, [[call for help-&gt;Page 377]], or [[await developments-&gt;Page 342]]?</tw-passagedata><tw-passagedata pid="192" name="Page 166" tags="" position="2725,2975" size="100,100">{==
(set: _yes to false)(if: $player contains &quot;going_alone&quot;)[(set: _yes to not $player&#39;s going_alone)]

It is difficult for you to pick up the trail of the thieves during the night-time, even with the moon out.  But some progress is made.  By morning, you are on the margins of Pikestaff Plain, heading north, and the tall grass of the plain makes it easy to track the thieves: the bent and crushed stems are clearly visible.  Soon the thieves themselves come into view, heads and shoulders bobbing above the grass.  Do you have (link-reveal:&quot;companions&quot;)[(show: ?1)] with you?
|1)[
    (if: _yes)[
        (dialog: &quot;Yes, you have formed a search-party.&quot;)
        (go-to: &quot;Page 14&quot;) [[Page 14]]
    ](else:)[
        (dialog: &quot;No, you are alone.&quot;)
        (go-to: &quot;Page 356&quot;) [[Page 356]]
    ]
]</tw-passagedata><tw-passagedata pid="193" name="Page 137" tags="" position="2600,2975" size="100,100">Hever comes into the room and you show him the rope.  He says that a search-party of five of his soldiers is waiting for you in the courtyard.  &#39;I know how important that helmet is to your family,&#39; he adds.  &#39;Ifor Tynin sent a message by eagle of your coming, and mentioned the helmet as the sure way to recognize you.&#39;  You [[join the soldiers-&gt;Page 166]] and set out in pursuit of the thieves.(set: $player&#39;s going_alone to false)</tw-passagedata><tw-passagedata pid="194" name="Page 26" tags="" position="2275,3225" size="100,100">You sleep long and well (restore 2 STAMINA points)($STAMINA:2), and wake up in the morning refreshed and determined to ask Hever immediately about his horn.  You find him in the Privy Chamber.  He has shown himself to be both friendly and trustworthy, so you tell him about your quest and explain how useful his fabled horn would be.  Hever is quiet for a while after you have finished talking.  Then he says, &#39;It is clear that your mission is so dangerous that, were you to take my horn, I might never see it again; and yet it is a bulwark of my reign.  If I give it to you I must have in return something of great value.  Do you have a (link-reveal:&quot;magic crystal mirror&quot;)[(show:?1)]?
|1)[{
    (if: $player&#39;s inventory contains &quot;Crystal Mirror&quot;)[
        (dialog: &quot;Yes, you have the Crystal Mirror&quot;)
        (go-to:&quot;Page 58&quot;) [[Page 58]]
    ](else:)[
        (dialog: &quot;No, you do not have the Crystal Mirror&quot;)
        (go-to:&quot;Page 149&quot;) [[Page 149]]
    ]
}]</tw-passagedata><tw-passagedata pid="195" name="Page 184" tags="" position="2475,2975" size="100,100">You and Hever continue the small talk of the table for a while, until you are joined by the bard.  He is a young man, branded on the forehead with the traditional mark of his kind, so that wherever he may roam in civilized lands, he will be treated as a sacred guest.

As he tells a few traditional tales, you are struck by the fact that he is not very good!  You glance curiously at Hever, and he whispers the reason to you: &#39;This lad was the apprentice of my former bard, who was the best in the land.  But he was abducted a few months ago, and has not been heard of since.  Still, this lad is improving: he is learning to weave a song around any tale you want him to.

This, of course, is the traditional bardic skill.  As his guest, Hever tells you, you can ask the bard to sing something.  It would be impolite to turn down the invitation.  Will you ask him to sing about the old story of [[Pyke and the Firefox-&gt;Page 296]], or to [[make up a song-&gt;Page 232]] about your own visit to Fallow Dale?</tw-passagedata><tw-passagedata pid="196" name="Page 377" tags="" position="3000,2975" size="100,100">The guards are still inclined to think that anything you do may be a trick, so they simply knock you unconscious to keep you quiet.  Lose 3 STAMINA points.($STAMINA: -3)  Shortly, you [[come to-&gt;Page 342]] again.</tw-passagedata><tw-passagedata pid="197" name="Page 342" tags="" position="2875,2975" size="100,100">Before long, Hever himself enters the room, surrounded by guards ready for the slightest suspicious move from you.  He is a huge, black-bearded man, quick to anger and quick to laughter.  You tell him what has happened and point out that, as ruler of Arion, you are not used to such treatment.  Hever quietly asks you to describe the missing helmet.  When you have done so, he smiles with relief and steps forward to embrace you.  &#39;You are welcome, cousin,&#39; he booms.  &#39;Ifor Tynin sent word by eagle of your coming.  Now, how may we help?&#39;  You show him the rope.  Hever arranges for a search-party (six in all, including yourself) to [[go in pursuit-&gt;Page 166]] of the thieves.(set: $player&#39;s going_alone to false)</tw-passagedata><tw-passagedata pid="198" name="Page 58" tags="" position="2150,3225" size="100,100">You hand over the crystal mirror to Hever.  He takes it, frowns in recognition of it and the foolish or evil deed you must have done to get hold of it, and [[turns it towards you-&gt;Page 209]].</tw-passagedata><tw-passagedata pid="199" name="Page 149" tags="" position="2275,3350" size="100,100">&#39;I have nothing of value to offer you except myself,&#39; you say simply. Hever thinks for a moment.  &#39;All right,&#39; he says finally, &#39;there is something you could do for me.  There is an exceptionally large Sabre-toothed Tiger, which has its lair in Affen Forest, but occasionally emerges and roams my lands, killing my people and their flocks.  If you can free my land from this beast, I will give you my horn.  But it will not be easy: the Tiger is hard to get close to, and extremely dangerous when cornered.&#39;  Will you [[accept-&gt;Page 240]] the test or [[not-&gt;Page 83]]?</tw-passagedata><tw-passagedata pid="200" name="Page 296" tags="" position="2400,3100" size="100,100">The bard complies with your request quite skilfully, but misses out the bit where Pyke battles the Wyvern of Wailing Island, and has him changing into a buzzard, not an eagle, at the end.  Afterwards, you [[go to bed-&gt;Page 26]].</tw-passagedata><tw-passagedata pid="201" name="Page 232" tags="" position="2275,2975" size="100,100">The bard stumbles and hesitates a bit, but manages to concoct a short epic, consisting mainly of entirely fanciful episodes, about your trip to Fallow Dale from Arion.  The end result is quite pleasing, and certainly flattering: he keeps going on about the power of a sceptre and orb when wielded by a true ruler, until you almost feel that you could complete the rest of your quest, if only you had a sceptre and an orb.  Add 1 LUCK point.($LUCK: 1) Afterwards, you [[go to bed-&gt;Page 26]].</tw-passagedata><tw-passagedata pid="202" name="Page 14" tags="combat" position="2650,3100" size="100,100">It is no hard task to halt the thieves.  There are six Pygmy Orcs, specially bred for burglary.  They look at you with venom.  &#39;Curse you for bringing others,&#39; the leader hisses.  &#39;It is you we want, not your paltry helmet.&#39;  He draws a wicked-looking dagger and lunges for you, while the other Orcs engage your companions. {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Pygmy Orc&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))
|combat_loop&gt;[
	(if: $combat&#39;s round is 5)[
    	(go-to: &quot;Page 129&quot;) [[Page 129]]
    ]
]
}(display: &quot;Combat Container&quot;)|victory)[If you win within five Attack Rounds, [[click here-&gt;Page 268]].]</tw-passagedata><tw-passagedata pid="203" name="Page 356" tags="" position="2800,3100" size="100,100">Why, you wonder, have the thieves made it so easy for you to follow them?  The rope, the easy trail - it&#39;s as if they want you to catch them up.  Do you have a (link-reveal:&quot;bow and arrows&quot;)[(show: ?1)]?
|1)[{
    (set: _yes to $player&#39;s inventory contains &quot;Magical Bow&quot;)
    (if: _yes)[
        (dialog: &quot;Yes, you have a bow and arrows&quot;)
        (go-to:&quot;Page 220&quot;) [[Page 220]]
    ](else:)[
        (dialog: &quot;No, you do not have a bow and arrows&quot;)
        (go-to:&quot;Page 252&quot;) [[Page 252]]
    ]
}]</tw-passagedata><tw-passagedata pid="204" name="Page 240" tags="to-do" position="2150,3475" size="100,100">&lt;!-- Hunt the Tiger Minigame --&gt;
{==
&lt;p&gt;Hever equips you with a hunting-spear and a pack of hounds, and himself leads you to the part of Affen Forest in which the Tiger is known to be hiding at the moment.&lt;/p&gt;

&lt;p&gt;You and your hounds enter the forest at E12; the Tiger is hidden in its lair at E4.  Each turn, roll one die for your hounds, and then one for the Tiger.  These rolls are not simultaneous: your hounds may catch up with the Tiger after one of their rolls and before the Tiger has its roll.  The effect of the rolls is shown in the following table:&lt;/p&gt;

&lt;table class=&quot;tiger-moves&quot;&gt;
&lt;tr&gt;
	&lt;td&gt;&lt;/td&gt;
	&lt;td&gt;&lt;center&gt;HOUNDS&lt;/center&gt;&lt;/td&gt;
    &lt;td&gt;&lt;center&gt;TIGER&lt;/center&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;1&lt;/td&gt;
	&lt;td&gt;Your hounds have caught the scent.  Move one square closer to the Tiger in any direction.&lt;/td&gt;
	&lt;td&gt;Move one square south.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;2&lt;/td&gt;
	&lt;td&gt;Move one square east.&lt;/td&gt;
	&lt;td&gt;Move one square north.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;3&lt;/td&gt;
	&lt;td&gt;Move two squares north.&lt;/td&gt;
	&lt;td&gt;Move one square west.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;4&lt;/td&gt;
	&lt;td&gt;Your hounds are well on the trial.  Move two squares closer to the Tiger in any direction, or any two directions.&lt;/td&gt;
	&lt;td&gt;Move one square east.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;5&lt;/td&gt;
	&lt;td&gt;Move one square west.&lt;/td&gt;
	&lt;td&gt;The Tiger stops to investigate a tree, and does not move this turn.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
	&lt;td&gt;6&lt;/td&gt;
	&lt;td&gt;Your hounds lose the scent, and do not move this turn.&lt;/td&gt;
	&lt;td&gt;Move one square north.&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;You have eight die rolls to catch up with the Tiger.  If you have not done so in eight rolls, or if the Tiger moves off this grid map, then it has [[escaped-&gt;Page 177]].  If within eight rolls your hounds reach any of the eight squares surrounding the one where the Tiger is currently located, then you will engage it in [[battle-&gt;Page 371]].  If you ever land on C9, [[click here-&gt;Page 262]].&lt;/p&gt;

|tmp)[==

(set: _x_axis to (range: 1, 8))
(set: _y_axis to (range: 1, 12))

(set: _tiger_x to 5)
(set: _tiger_y to 4)

(set: _player_x to 5)
(set: _player_y to 12)

(set: _counter to 1)

|yourmove)[
    (if: $die1 is 1)[(show: ?steer1)(rerun:?steer1)]
    (if: $die1 is 2)[(set: _player_x to it + 1)(rerun:?rolltiger)(show:?rolltiger)]
    (if: $die1 is 3)[(set: _player_y to it - 2)(rerun:?rolltiger)(show:?rolltiger)]
    (if: $die1 is 4)[(show: ?steer2)(rerun:?steer2)]
    (if: $die1 is 5)[(set: _player_x to it - 1)(rerun:?rolltiger)(show:?rolltiger)]
    (if: $die1 is 6)[(rerun:?rolltiger)(show:?rolltiger)]
    (rerun:?yourpos)
]

|tigermove)[
    (if: $die1 is 1)[(set: _tiger_y to it + 1)]
    (if: $die1 is 2)[(set: _tiger_y to it - 1)]
    (if: $die1 is 3)[(set: _tiger_x to it - 1)]
    (if: $die1 is 4)[(set: _tiger_x to it + 1)]
    (if: $die1 is 5)[]
    (if: $die1 is 6)[(set: _tiger_y to it - 1)]
    (rerun:?tigerpos)(rerun:?youroll)
]

|turn_counter&gt;[
	Turn: (print: _counter)&lt;br/&gt;
]
|positions&gt;[
Your position: |yourpos&gt;[(hide: ?steer1)((str: _player_x, &quot;, &quot;, _player_y))]
|youroll&gt;[(link-reveal:&quot;Roll your move&quot;)[: ($ROLL1:)! (rerun:?yourmove)(show:?yourmove)]]

|steer1)[&lt;br/&gt;Choose a direction:
	(link-reveal:&quot;North&quot;)[(set: _player_y to it - 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)] / 
	(link-reveal:&quot;East&quot;)[(set: _player_x to it + 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)] / 
	(link-reveal:&quot;South&quot;)[(set: _player_y to it + 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)] / 
	(link-reveal:&quot;West&quot;)[(set: _player_x to it - 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)]
]

|steer2)[&lt;br/&gt;Choose a direction (first move):
	(link-reveal:&quot;North&quot;)[(set: _player_y to it - 1)(rerun:?yourpos)(show: ?steer3)(rerun:?steer3)] / 
	(link-reveal:&quot;East&quot;)[(set: _player_x to it + 1)(rerun:?yourpos)(show: ?steer3)(rerun:?steer3)] / 
	(link-reveal:&quot;South&quot;)[(set: _player_y to it + 1)(rerun:?yourpos)(show: ?steer3)(rerun:?steer3)] / 
	(link-reveal:&quot;West&quot;)[(set: _player_x to it - 1)(rerun:?yourpos)(show: ?steer3)(rerun:?steer3)]
]

|steer3)[&lt;br/&gt;Choose a direction (second move): (hide:?steer2)
	(link-reveal:&quot;North&quot;)[(set: _player_y to it - 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)(hide: ?steer3)] / 
	(link-reveal:&quot;East&quot;)[(set: _player_x to it + 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)(hide: ?steer3)] / 
	(link-reveal:&quot;South&quot;)[(set: _player_y to it + 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)(hide: ?steer3)] / 
	(link-reveal:&quot;West&quot;)[(set: _player_x to it - 1)(rerun:?yourpos)(rerun:?rolltiger)(show:?rolltiger)(hide: ?steer3)]
]

&lt;br/&gt;
Tiger&#39;s position: |tigerpos&gt;[((str: _tiger_x, &quot;, &quot;, _tiger_y))]
|rolltiger)[(link-reveal:&quot;Roll Tiger&#39;s move&quot;)[: ($ROLL1:)! (rerun:?tigermove)(show:?tigermove)]]

]
</tw-passagedata><tw-passagedata pid="205" name="Page 83" tags="" position="2275,3475" size="100,100">Lose 2 LUCK points for cowardice.($LUCK: 2)  You have no choice now but to [[leave Fallow Dale-&gt;Page 384]].</tw-passagedata><tw-passagedata pid="206" name="Page 129" tags="combat" position="2475,3225" size="100,100">{==(set: $combat&#39;s loop to &quot;Simultaneous Combat Loop&quot;)
(set: $combat&#39;s opponents&#39;s 1st&#39;s prefix to &quot;First&quot;)
(set: $combat&#39;s opponents to it + (a:
	(dm:
		&quot;name&quot;, &quot;Pygmy Orc&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;
	)
))
One of the other Orcs has defeated his opponent and now joins in the fight against you.  You will have to fight them both simultaneously.

(display: &quot;Combat Container&quot;)

|victory)[If you win, [[click here-&gt;Page 268]].]</tw-passagedata><tw-passagedata pid="207" name="Page 268" tags="" position="2650,3225" size="100,100">($add_item: &quot;Helmet of Arion&quot;)There are three of your companions left -- but no Orcs.  You recover your helmet, and the four of you begin the long trek back to [[Fallow Dale-&gt;Page 321]], resting frequently on the way.</tw-passagedata><tw-passagedata pid="208" name="Page 220" tags="combat" position="2800,3225" size="100,100">Some accurate shooting reduces the number of your Pygmy Orc opponents from six to two, but empties your quiver (you will be able to recover the arrows later.)  You must face the last two with your sword, but they have been separated from each other in the long grass, and you can approach them one at a time.  The first one draws his dagger, snarling, &#39;Good!  It is you we want, not your paltry helmet!&#39;{
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Pygmy Orc&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Pygmy Orc&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;
	),
))(display: &quot;Combat Container&quot;)|victory)[($remove_item: &quot;Helmet of Arion&quot;)If you win, you recover your helmet, and you may either begin the trek back to [[Fallow Dale-&gt;Page 321]] or forget about Hever&#39;s horn and carry on north towards [[Krill Garnash-&gt;Page 20]].]
}
</tw-passagedata><tw-passagedata pid="209" name="Page 252" tags="death" position="2925,3225" size="100,100">You are no match for the six Pygmy Orcs you have been following.  They allow you to catch up, surround you and then their vicious blades flash in the morning sun.  Your adventure is over.</tw-passagedata><tw-passagedata pid="210" name="Page 177" tags="" position="2150,3600" size="100,100">You return in shame to where Hever is waiting with his village headmen at the edge of the forest.  The blue sky, the pennants fluttering in a gentle breeze and the sound of skylarks high above are strangely at odds with your sense of failure.  Hever is a man of his word: he does not give you his horn.  He escorts you back to the castle.  As you are [[preparing to leave-&gt;Page 384]], Hever has food brought to you from the kitchens.  Restore 2 STAMINA points.($STAMINA: 2)</tw-passagedata><tw-passagedata pid="211" name="Page 371" tags="combat" position="2025,3600" size="100,100">(set: _roll to ($ROLL1:))The massive Sabre-toothed Tiger bursts out of cover, slavering at the mouth, and sets about the pack of hounds with its huge paws.  You must fight it with your spear.  First, (link-reveal:&quot;roll one die&quot;)[(dialog:(str: &quot;You roll: &quot;, _roll))(show: ?1)]: your hounds manage to injure the beast for this amount of STAMINA damage before you call them off and engage it yourself.  If they cause it 5 or 6 points of STAMINA injury, you may also decrease its SKILL score by 1 point.|1)[== {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Sabre-toothed Tiger&quot;,
		&quot;skill&quot;, (cond: _roll &gt;= 5, 10, 11),
		&quot;stamina&quot;, 12 - _roll,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;)
|escape&gt;[If your STAMINA is getting dangerously low, you may decide that the Horn of Hever is not worth it, and [[break off-&gt;Page 177]] from the fight.]
|combat_loop&gt;[
	(if: $combat&#39;s round is 4)[
    	(go-to: &quot;Page 348&quot;) [[Page 348]]
    ]
]
|victory)[(hide: ?escape)If you win, [[click here-&gt;Page 333]].]
}
</tw-passagedata><tw-passagedata pid="212" name="Page 262" tags="death" position="2025,3475" size="100,100">One of Hever&#39;s hunters dug a trap here last week.  Your hounds instinctively avoid it (as the Tiger has done), but you blunder in and are impaled on the sharpened spikes at the bottom.  Your adventure ends here.</tw-passagedata><tw-passagedata pid="213" name="Page 384" tags="" position="2275,3725" size="100,100">As you are taking your leave of Hever, a bruised and bleeding figure thrusts his way past the guards into the courtyard and collapses face down at your feet.  You gently turn him over and have difficulty at first in recognizing Kevin Truehand, your armourer from Arion.  He is barely alive.  He speaks through cracked lips with a great effort, as if resisting the approach of death or of something worse:  &#39;Majesty, I ($dotdotdot:&quot;tried&quot;) black ($dotdotdot:&quot;magic&quot;) must not give ($dotdotdot: &quot;in&quot;)&#39;  Then he chokes and breathes his last.  You jump to your feet.  Will you go over to discuss this matter with [[Hever-&gt;Page 93]], or stay thinking about it [[yourself-&gt;Page 281]]?</tw-passagedata><tw-passagedata pid="214" name="Page 321" tags="" position="2600,3375" size="100,100">When you get back to Fallow Dale and appear before Hever with your helmet, he can see you are whom you claim to be -- the ruler of Arion.  At the back of your mind now is the question of Hever&#39;s horn and how to ask him about it, but you spend the time discussing more pressing questions.  How did the thieves know you were here?  How did a message get through to them, and from whom?  Eventually Hever suggests that some tales from his bard might take your mind off your worries, if you are not too tired.  Will you [[accept-&gt;Page 184]] or [[go to bed-&gt;Page 26]]?</tw-passagedata><tw-passagedata pid="215" name="Page 20" tags="" position="2825,3450" size="200,200">After half a day&#39;s travel through the chest-high grass of Pikestaff Plain, nothing more exciting has happened than pollen causing you to sneeze once in a while.  The landscape is featureless -- just the same grass all around.  However, you do come across a tiny trail.  It is no more than fifteen centimetres wide, and therefore hard to spot among the stems, but it is a definite trail, running dead straight from south-west to north-east.  Will you ignore it and [[carry on-&gt;Page 140]] more or less due north, or [[wait by it-&gt;Page 202]]?</tw-passagedata><tw-passagedata pid="216" name="Page 348" tags="" position="2025,3725" size="100,100">With a lucky strike of its paws, the Tiger splinters your spear as though it were made of straw.  Now you will have to fight it at close quarters, with your sword.  Continue the fight, but every time the Tiger&#39;s claws rake you it will inflict 4 instead of the usual 2 points of STAMINA damage.{ (set: $combat&#39;s opponents&#39;s 1st&#39;s damage to 4)

(display: &quot;Combat Container&quot;)

|escape&gt;[If your STAMINA is getting dangerously low, you may decide that the Horn of Hever is not worth it, and [[break off-&gt;Page 177]] from the fight.]  |victory)[(hide: ?escape)If you win, [[click here-&gt;Page 333]].]
}
</tw-passagedata><tw-passagedata pid="217" name="Page 333" tags="item" position="2150,3725" size="100,100">You decide to take a set of the Tiger&#39;s claws as a memento of this epic battle.($add_item: &quot;Tiger Claws&quot;)  Then you return to where Hever is waiting with his village headmen at the edge of the forest.  The blue sky, the pennants fluttering in a gentle breeze and the sound of skylarks high above well match your elation at your success.  &#39;You have proven yourself worthy to carry the Horn of Hever,&#39; he says.  &#39;Let us return to the castle to celebrate.&#39;  Add 2 LUCK points. ($LUCK: 2)

The celebrations continue well into the next day.  The mead and medlar wine flow freely.  You have to put up with a long procession of local dignitaries, wach of whom wants to hear your story and thank you.  Still, you gain 3 STAMINA points.($STAMINA: 3)  As you prepare to leave the castle, Hever presents you with the horn.($add_item: &quot;Horn of Hever&quot;)  It looks just like an ordinary ram&#39;s horn, but it came from a Yachar, a Horned Demon, and hence has power over demonic as well as mortal evil.  You hang is ecurely around your neck, so that it is as available to you as your sword.  If you sound the horn, you may reduce any opponent&#39;s skill by 1, unless the book tells you otherwise.

[[Continue-&gt;Page 384]].</tw-passagedata><tw-passagedata pid="218" name="Page 93" tags="combat" position="2275,3850" size="100,100">With death, Kevin&#39;s heroic resistance snaps once and for all, and the evil spirit implanted in his body is able to take control.  It too jumps to its feet -- that is, Kevin&#39;s feet -- and it hurls an impenetrable magical barrier around itself and you.  But because you have moved closer to Hever, he is caught inside the barrier and helps you in the fight.  The spirit, cackling with glee and cracking a fiery nine-tailed whip, has eyes only for you, but every time you win an Attack Round, you may assume that Hever has been successful too, and reduce the fiend&#39;s STAMINA by 3 instead of 2.  You cannot kill this demon, but if you win the fight, it will return to the nether regions, leaving Kevin in peace at last. {
(set: $player&#39;s damage to 3)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Hellfire Spirit&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;) |victory)[(set: $player&#39;s damage to 2)[If you both win, the barrier [[dissolves-&gt;Page 132]].]
}
</tw-passagedata><tw-passagedata pid="219" name="Page 281" tags="combat" position="2150,3850" size="100,100">With death, Kevin&#39;s heroic resistance snaps once and for all, and the evil spirit implanted in his body is able to take control.  It too jumps to its feet -- that is, Kevin&#39;s feet -- and it hurls an impenetrable magical barrier around itself and you, so that Hever and his soldiers cannot approach.  Cackling with glee, it cracks its fiery nine-tailed whip towards you.  You cannot kill this demon, but if you win the fight, it will return to the nether regions, leaving Kevin in peace at last. {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Hellfire Spirit&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))}(display: &quot;Combat Container&quot;) |victory)[(set: $player&#39;s damage to 2)If you win, the barrier [[dissolves-&gt;Page 132]].]</tw-passagedata><tw-passagedata pid="220" name="HORN OF HEVER" tags="" position="600,325" size="100,100">&lt;li&gt;(link-reveal:&quot;Horn of Hever&quot;)[{
    (if: $combat&#39;s opponents is an empty)[
        (dialog: &quot;You must be in combat!&quot;)
    ]
    (if: $combat&#39;s opponents is not an empty)[
        (set: _immune to (a:))
        (for: each _i, ...(range: 1, $combat&#39;s opponents&#39;s length))[
            (set: _m to _i of $combat&#39;s opponents)
            (if: _m contains &quot;alignment&quot;) [
                (if: _m&#39;s alignment is not &quot;neutral&quot;)[
                    (set: $combat&#39;s opponents&#39;s _i&#39;s skill to it - 1)
                ]
                (if: _m&#39;s alignment is &quot;neutral&quot;)[
                    (set: _immune to it + (a: _m&#39;s name))
                ]
            ]
            (if: _m does not contain &quot;alignment&quot;) [
                (set: $combat&#39;s opponents&#39;s _i&#39;s skill to it - 1)
            ]
        ]
        (if: _immune is an empty)[
            (dialog: [You sound the Horn of Hever: all enemies&#39; SKILL reduced by 1 point.(rerun: ?monster_stats)])
        ]
        (if: _immune&#39;s length is 1)[
            (dialog: &quot;This creature is not evil, so the Horn of Hever has no effect.&quot;)
        ]
        (if: _immune&#39;s length &gt; 1)[
            (dialog: &quot;These creatures are not evil, so the Horn of Hever has no effect.&quot;)
        ]
    ]
    (rerun: ?monster_stats)
}]&lt;/li&gt;</tw-passagedata><tw-passagedata pid="221" name="Page 132" tags="" position="2275,3975" size="100,100">You answer Hever&#39;s inevitable questions, but you can only guess what treachery lies behind this incident.  Then you [[leave Fallow Dale-&gt;Page 20]].  Hever has restocked you with the full amount of 10 lots of Provisions, and given you a new pack and water-flask.(set: $player&#39;s provisions to 10)(set: $player&#39;s provision_strength to 4)</tw-passagedata><tw-passagedata pid="222" name="Page 140" tags="" position="2825,4050" size="100,100">By nightfall there is still no end to the grass.  Will you flatten some of it and [[bed down-&gt;Page 2]] for the night, or [[press on-&gt;Page 34]]?</tw-passagedata><tw-passagedata pid="223" name="Page 202" tags="" position="2950,3675" size="100,100">You don&#39;t have to wait long before a large red ant passes by.  Soon you have seen over a dozen of them.  You recognize them as Treasure Ants -- so called because they line their nests with any trinkets they can carry.  They are quite large (you have already seen four of them dragging a dead field mouse along), and their bites can be painful.  These ants are passing you by in both directions, but the ones travelling south-west are usually carrying some titbit or other, so obviously their nest is somewhere in that direction.  You are tempted to find the nest, to see if they have hoarded anything valuable, but Treasure Ants are known to travel many kilometres, and south-west is out of your way.  Will you [[head south-west-&gt;Page 105]] along the trail, [[wait where you are-&gt;Page 91]] for a while, in case an ant passes by with something valuable, or [[ignore them-&gt;Page 140]] and press on northwards?</tw-passagedata><tw-passagedata pid="224" name="Page 2" tags="" position="2700,4175" size="100,100">During the night, field mice burrow into your pack and eat 2 lots of your Provisions.($PROVISIONS: -2)  At daybreak you carry on northwards, and another day&#39;s travel brings you to the end of the grass.  The landscape facing you is moorland, dotted with rocks and shrubs, and crisscrossed by numerous streams and rivers.  After another night&#39;s rest, you [[carry on-&gt;Page 68]].</tw-passagedata><tw-passagedata pid="225" name="Page 34" tags="" position="2825,4175" size="100,100">You must eat 1 lot of Provisions just to keep your strength up.($PROVISIONS: -1)  A full night&#39;s travel brings you to the end of the grass.  The landscape facing you is moorland, dotted with rocks and shrubs, and crisscrossed by numerous streams and rivers, which reflect the dawn sun.  You rest for a while and then [[carry on-&gt;Page 68]].</tw-passagedata><tw-passagedata pid="226" name="Page 105" tags="" position="2950,3800" size="100,100">After a couple of hours, the ant-traffic has not noticeably increased, and you have seen no sign of the nest or anything being carried along that is more valuable than a rusty nail.  Will you [[carry on-&gt;Page 304]] along the trail, or [[turn north-&gt;Page 140]] again?</tw-passagedata><tw-passagedata pid="227" name="Page 91" tags="" position="3075,3800" size="100,100">While you are waiting, you are so intent on watching the ants that you fail to notice a large poisonous snake rustling the grass as it slithers up behind you, until it is almost too late.  You whirl around, but it is a Spit Viper, and it spits acid at your eyes.  ($test_your_luck:).
|lucky)[(go-to:&quot;Page 255&quot;) [[Page 255]]]
|unlucky)[(go-to: &quot;Page 41&quot;) [[Page 41]]]</tw-passagedata><tw-passagedata pid="228" name="Page 68" tags="" position="2700,4300" size="100,100">(set: _yes to (history:) contains &quot;Page 105&quot;)Did you follow the (link-reveal:&quot;ant-trail&quot;)[(show: ?1)] at all?

|1)[(dialog: [(if: _yes)[Yes, you followed the ant trail.](else:)[No, you did not follow the ant trail.]]) (if: _yes)[(go-to:&quot;Page 291&quot;) [[Page 291]]](else:)[(go-to: &quot;Page 350&quot;) [[Page 350]] ] ]</tw-passagedata><tw-passagedata pid="229" name="Page 304" tags="item" position="2950,3925" size="100,100">Your perseverance is rewarded.  You come across an open area in the grass, where hard mud is pitted with holes, each of which is about the size of your fist and serves as entrance and exit for countless ants.  You dig in the earth with your sword, but while you do so, ants have the opportunity to climb all over you and nip you.  You can gain treasure up to 10 Gold Pieces, but at a loss of 1 STAMINA point for every 2 Gold Pieces.

|button&gt;[{
&lt;center&gt;
    (input: bind _treasure, &quot;=X=&quot;)(link:&quot;Confirm&quot;)[
        (if: all of _treasure is a digit)[
    	    (set: _treasure to (num: _treasure))
            (print: _treasure)
            (if: _treasure &lt; 1 or _treasure &gt; 10) [
                (dialog:&quot;Please enter a number from 1 - 10&quot;)
                (rerun: ?button)
            ](else:)[
                (set: _damage to (round: _treasure / 2 - 0.1))
                ($GOLD: _treasure)
                ($STAMINA: -_damage)
                (hide:?button)
            ]
        ](else:)[
            (dialog:&quot;Please enter a number from 1 - 10&quot;)
            (rerun: ?button)
        ]
    ]&lt;input|
	&lt;/center&gt;
}]
When you have finished, you [[head north-&gt;Page 140]] again.</tw-passagedata><tw-passagedata pid="230" name="Page 255" tags="combat" position="3075,3925" size="100,100">Only a few drops of the acid splash into your eyes.  Reduce your SKILL by 2 points for this fight only. {
(set: $player&#39;s skill to it - 2)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Spit Viper&quot;,
		&quot;skill&quot;, 4,
		&quot;stamina&quot;, 4,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
)) (display: &quot;Combat Container&quot;) |victory)[(set: $player&#39;s skill to it + 2)If you win, will you [[stay waiting-&gt;Page 277]] by the ant-trail, or [[carry on-&gt;Page 140]] north?]
}
</tw-passagedata><tw-passagedata pid="231" name="Page 41" tags="combat" position="3200,3925" size="100,100">Your eyes receive the full force of the acid, and you are temporarily blinded.  Reduce your SKILL by 5 points for this fight. {
(set: $player&#39;s skill to it - 5)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Spit Viper&quot;,
		&quot;skill&quot;, 4,
		&quot;stamina&quot;, 4,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))(display: &quot;Combat Container&quot;) |victory)[(set: $player&#39;s skill to it + 4)If you win, you wait until the worst of the effects have worn off, but you must reduce your SKILL permanently by 1 point.  Will you now [[stay waiting-&gt;Page 277]] by the ant trail, or [[carry on-&gt;Page 140]] north?]
}
</tw-passagedata><tw-passagedata pid="232" name="Page 277" tags="" position="3075,4050" size="100,100">You wait until the sun is getting low and red, but no ant passes carrying anything more valuable than a rusty nail.  Lose 1 LUCK point.($LUCK: -1)  You decide to end this pointless exercise, and [[carry on-&gt;Page 140]] north.</tw-passagedata><tw-passagedata pid="233" name="Page 291" tags="" position="2700,4425" size="100,100">The most direct route to Krill Garnash now lies somewhat to the north-east.  Will you head [[north-east-&gt;Page 55]], or continue [[north-&gt;Page 243]]?</tw-passagedata><tw-passagedata pid="234" name="Page 350" tags="" position="2825,4425" size="100,100">Will you head [[north-&gt;Page 236]], which is the most direct route to Krill Garnash from where you are, or slightly [[north-west-&gt;Page 55]]?</tw-passagedata><tw-passagedata pid="235" name="Page 55" tags="combat" position="2700,4550" size="100,100">As you walk along, your attention is for some reason drawn to your shadow, which bobs up and down on the boulders you pass, or gets smudged by the shrubs.  Suddenly, to your astonishment and amazement, it bulges and changes shape.  This cannot be your shadow any more: for a start, you don&#39;t have horns on your head.  Sheer terror makes the hairs on the back of your neck stand up, when the Shadow Monster detaches itself from your shadow, and launches itself at you, brandishing a trident. {

(set: $player&#39;s damage to 1)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Shadow Monster&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;
	)
))

(display: &quot;Combat Container&quot;)} |note&gt;[This lesser demon is solid enough to injure you as normal, but you can cause it only 1 STAMINA point of injury every time you win an Attack Round.]  |victory)[(hide:?note)(set: $player&#39;s damage to 2)If you win, you think about changing direction.  Will you head [[north-east-&gt;Page 323]] or [[north-&gt;Page 336]]?]
</tw-passagedata><tw-passagedata pid="236" name="Page 243" tags="" position="2450,4550" size="100,100">You come to a ruined village.  Crows and buzzards rise lazily from crumbling stone walls; the scene is desolate and more than a little ominous. Some evil has been done here, and not too long ago, for the ruins are not yet overgrown with weeds.  Will you [[walk through-&gt;Page 386]] the village, or [[bypass it-&gt;Page 285]]?</tw-passagedata><tw-passagedata pid="237" name="Page 236" tags="" position="3200,4925" size="100,100">No serious obstacles present themselves for a while: the streams are either shallow enough to wade or narrow enough to jump over; the land is covered with heather or bilberry shrubs, which often make the going awkward, but by no means impossible.

Before long, a strange sight greets you.  A gaily painted caravan is being drawn by a water buffalo in a westerly direction.  A robust old man is sitting on the seat of the caravan; the reins hang limply in his hands, and he doesn&#39;t seem very concerned about where the caravan goes.  The pots and pans strung up around the caravan clash and clang as it passed over the uneven terrain.  A sign on the side reads: &#39;Canches - Alchemist &amp; Trader&#39;.

You call out, and Canches stops the caravan; the buffalo immediately begins to tug at some coarse grass.  Canches offers to sell you some of his [[home-made wares-&gt;Page 80]].  Otherwise you can either pass the time of day and then [[continue north-&gt;Page 397]], or [[attack the alchemist-&gt;Page 185]] to try to steal his goods.</tw-passagedata><tw-passagedata pid="238" name="Page 386" tags="combat" position="2325,4675" size="100,100">Two animated skeletons emerge, jerking like puppets, from behind a devastated house.  They attack you simultaneously with their cutlasses, but fortunately they are rather uncoordinated.  Choose one to attack, and use the normal combat rules against it.  The other may wound you, but you may not wound it: roll for its Attack Strength too, and if it is higher than yours, it wounds you; if it is lower or equal, you have dodged its spasmodic assault.
{(set: $combat&#39;s loop to &quot;Simultaneous Combat Loop&quot;)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Skeleton&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Skeleton&quot;,
		&quot;skill&quot;, 5,
		&quot;stamina&quot;, 7,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;
	)
))}(display: &quot;Combat Container&quot;) |victory)[(set: $combat&#39;s loop to &quot;Sequential Combat Loop&quot;)If you win, you may take a (link-reveal:&quot;bejewelled choker&quot;)[($add_item:&quot;Bejewelled Choker&quot;)] which one of the Skeletons was wearing.  Will you then [[continue north-&gt;Page 84]] through the village, or [[weave through the village-&gt;Page 214]] in a north-easterly direction, in order to get away from it as soon as possible?]</tw-passagedata><tw-passagedata pid="239" name="Page 285" tags="" position="2450,4675" size="100,100">Will you keep well clear of the village by heading due [[east-&gt;Page 55]] for a while, or just skirt it by heading [[north-east-&gt;Page 214]]?</tw-passagedata><tw-passagedata pid="240" name="Page 323" tags="" position="2950,4925" size="100,100">No serious obstacles present themselves for quite a while: the streams are either shallow enough to wade or narrow enough to jump over; the land is covered with heather or bilberry shrubs, which often make the going awkward, but by no means impossible (and provide some food.)

In the mid-afternoon of the second day after leaving the grass, you come across a strange sight in such surroundings.  A gaily painted caravan is being drawn by a water buffalo, heading west.  A robust old man is sitting on the seat of the caravan; the reins hang limply in his hands, and he doesn&#39;t seem very concerned about where the caravan goes.  The pots and pans strung up around the caravan clash and clang as it passes over the uneven ground.  A sign on the side reads: &#39;Canches - Alchemist &amp; Trader&#39;.

You call out and Canches stops the caravan; the buffalo immediately begins to tug at some coarse grass.  Canches offers to sell you some of his [[home-made wares-&gt;Page 80]].  Otherwise you can either pass the time of day and then [[continue north-east-&gt;Page 375]], or [[attack the alchemist-&gt;Page 185]] to try to steal his goods.</tw-passagedata><tw-passagedata pid="241" name="Page 336" tags="" position="3075,4925" size="100,100">No serious obstacles present themselves for quite a while: the streams are either small enough to jump or shallow enough to wade; the land is covered with heather or bilberry shrubs, which often make the going awkward, but by no means impossible (and provide some food.)

In the later afternoon of the second day after leaving the grass, you come across a strange sight in such surroundings.  A gaily painted caravan is being drawn by a water buffalo, heading west.  A robust old man is sitting on the seat of the caravan; the reins hang limply in his hands, and he doesn&#39;t seem very concerned about where the caravan goes.  The pots and pans strung up around the caravan clash and clang as it passes over the uneven ground.  A sign on the side reads: &#39;Canches - Alchemist &amp; Trader&#39;.

You call out and Canches stops the caravan; the buffalo immediately begins to tug at some coarse grass.  Canches offers to sell you some of his [[home-made wares-&gt;Page 80]].  Otherwise you can either pass the time of day and then [[continue north-&gt;Page 13]], or [[attack the alchemist-&gt;Page 185]] to try to steal his goods.</tw-passagedata><tw-passagedata pid="242" name="Page 397" tags="" position="3325,4925" size="100,100">One evening, just as you are thinking about finding somewhere to rest for the night, you come across a large rock, which the wind has hollowed out until it is like an arch.  Will you spend the night in the shelter of the [[arch-&gt;Page 179]] or [[elsewhere-&gt;Page 77]]?</tw-passagedata><tw-passagedata pid="243" name="Page 80" tags="item" position="2625,4750" size="200,200">($GOLD: 20)(set: _shop to (a:
	(dm: &quot;name&quot;, &quot;Potion of Luck&quot;,                  &quot;cost&quot;,  3, &quot;item_name&quot;, &quot;Potion of Luck&quot;),
	(dm: &quot;name&quot;, &quot;Potion of Healing&quot;,               &quot;cost&quot;,  5, &quot;item_name&quot;, &quot;Potion of Healing&quot;),
	(dm: &quot;name&quot;, &quot;Cloak of Temporary Invisibility&quot;, &quot;cost&quot;, 10, &quot;item_name&quot;, &quot;Invisibility Cloak&quot;),
	(dm: &quot;name&quot;, &quot;Antifreeze Potion&quot;,               &quot;cost&quot;,  5, &quot;item_name&quot;, &quot;Antifreeze Potion&quot;),
	(dm: &quot;name&quot;, &quot;Boots of Agility&quot;,                &quot;cost&quot;,  6, &quot;item_name&quot;, &quot;Boots of Agility&quot;),
))Some of the alchemist&#39;s wares are of interest to you: a Potion of Luck, for 3 Gold Pieces, which will restore your Luck to its &lt;i&gt;Initial&lt;/i&gt; level; a Potion of Healing, for 5 Gold Pieces, which will restore up to 6 STAMINA points (you can use it now or save it for later); a Cloak of Temporary Invisibility, for 10 Gold Pieces; an Antifreeze Potion, which will protect you against cold, for 5 Gold Pieces; and, for 6 Gold Pieces, Boots of Agility.  Buy what you want and can afford, and then (link-reveal:&quot;continue on your way&quot;)[(go-to: (history:)&#39;s last)].

{
&lt;ul&gt;
	(for: each _item, ..._shop)[
    	&lt;li&gt;(link-reveal: (str: _item&#39;s name))[
        	(if: $player&#39;s inventory does not contain _item&#39;s item_name and $player&#39;s gold &gt;= _item&#39;s cost)[
                ($add_item: _item&#39;s item_name)
                ($GOLD: -_item&#39;s cost)
            ](else:)[
                (if: $player&#39;s gold &lt; _item&#39;s cost)[
            	    (dialog: (str: &quot;You don&#39;t have &quot;, _item&#39;s cost, &quot; Gold Pieces!&quot;))
                ]
                (if: $player&#39;s inventory contains _item&#39;s item_name)[
                    (dialog: (str: &quot;You already have the &quot;, _item&#39;s name, &quot;!&quot;))
                ]
            ]
        ] ((print: _item&#39;s cost) Gold Pieces)&lt;/li&gt;
    ]
&lt;/ul&gt;
}</tw-passagedata><tw-passagedata pid="244" name="Page 185" tags="death" position="3225,4750" size="100,100">How do you think the alchemist survives in these dangerous lands?  As soon as your aggressive intentions are clear, he blasts you into oblivion.  The buffalo looks on with little interest.</tw-passagedata><tw-passagedata pid="245" name="Page 84" tags="" position="2200,4800" size="100,100">As you walk on down the main street, you notice other skeletons -- but genuinely lifeless ones.  The whole village has obviously been wiped out in a fairly recent raid.  Will you [[poke around-&gt;Page 315]] in any of the houses or [[not-&gt;Page 56]]?</tw-passagedata><tw-passagedata pid="246" name="Page 214" tags="" position="2325,4800" size="100,100">Once you are well out of the district of the village, will you continue [[north-east-&gt;Page 323]] or turn back on to a [[northerly-&gt;Page 336]] route?</tw-passagedata><tw-passagedata pid="247" name="Page 375" tags="combat" position="2950,5050" size="100,100">(set: $player&#39;s infected to false)The following night, your camp-fire attracts some unwelcome visitors.  A couple of Mordidas as patrolling their territory and resent your intrusion.  Mordidas are scavengers -- they are rather like huge hyenas -- and are usually too cowardly to approach anything which might fight back.  But to judge by the state of these two, they have not had anything to eat for quite a while and are desperate.  If you have the Cload of Temporary Invisibility, it will do you no good here, as the Mordidas&#39; powerful sense of smell is just as effective as their sight.  They adopt the method of their attack peculiar to their kind, and each attacks you in alternate Attack Rounds.{

(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Mordida&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;
	),
	(dm:
		&quot;name&quot;, &quot;Mordida&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;
	)
))

(display: &quot;Combat Container&quot;)

|post_combat_next)[(set: $combat&#39;s opponents to (rotated: -1, ...$combat&#39;s opponents))]
|combat_on_player_hit)[(if: $target&#39;s prefix is &quot;First&quot;)[(set: $player&#39;s infected to true)]]
} |victory)[(if: $player&#39;s infected)[The first Mordida is weakened by disease, and has become rabid.  If it wins any Attack Rounds against you, you will have to (link-reveal:&quot;cut the poison out&quot;)[($STAMINA: -2)(set: $player&#39;s infected to false)(rerun:?victory)] of the wound it has inflicted: this will cause you 2 further STAMINA points of injury.  But you can only do this after you survive the battle, of course.](else:)[If you survive, you may [[continue-&gt;Page 13]].]]</tw-passagedata><tw-passagedata pid="248" name="Page 13" tags="" position="3075,5050" size="100,100">Several days later (reduce your Provisions by 2)($PROVISIONS: -2) you are faced with your most dangerous situation yet.  A bush-fire starts in the south and is racing in your direction, driven by the wind.  The front of the fire is many kilometres long: at any rate, even from a distance you cannot see the ends of it.  The dry weather and shrubs are excellent kindling for it, and it leaps the streams and small rivers with no apparent pause.  It is still a long way away, but you know the speed at which such fires travel.  Will you:

&lt;ul&gt;{
	&lt;li&gt;[[Stay where you are-&gt;Page 148]]?&lt;/li&gt;
	&lt;li&gt;[[Race north-&gt;Page 47]] away from the fire?&lt;/li&gt;
	&lt;li&gt;Try to find the fire&#39;s [[western limit-&gt;Page 332]]?&lt;/li&gt;
	&lt;li&gt;Try to find the fire&#39;s [[eastern limit-&gt;Page 62]]?&lt;/li&gt;
	&lt;li&gt;Move [[towards the fire-&gt;Page 221]]?&lt;/li&gt;
}&lt;/ul&gt;</tw-passagedata><tw-passagedata pid="249" name="Page 179" tags="" position="3325,5050" size="100,100">That night, Morgana appears to you in a dream.  &#39;Excellent!&#39; she says.  &#39;Glad to see you&#39;re on your way.  Our little plan is working well.  Don&#39;t worry: I won&#39;t kill ($dotdotdot:&quot;you&quot;) yet!  But here is a foretaste of my power.&#39;  The vision raises her hands and curses you (lose 2 LUCK points).($LUCK:-2)(set: $player&#39;s cursed to true)  You wake up with a start and, even with your eyes open, you seem to see her, floating away in the distance, [[laughing evilly-&gt;Page 77]].</tw-passagedata><tw-passagedata pid="250" name="Page 77" tags="combat" position="3200,5050" size="100,100">In the morning, you set off north again, and travel for a couple of days through the barren landscape.  Your uneventful journey, however, makes you less cautious than usual, and when you are walking past some large boulders, you fail to notice the Wildcat basking on top of one.  The tip of its tail flicks from side to side as you approach, and then it leaps on to you, immediately inflicting 2 STAMINA points of injury to you.($STAMINA: -2)  You toss it off your shoulders onto the ground, and just have time to notice that it is a pretty large specimen, before it springs into the attack again.  Wildcats are not evil, just wild, so the Horn of Hever will have no effect, and you have no time to get anything from you pack.{

(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Wildcat&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
        &quot;alignment&quot;, &quot;neutral&quot;
	)
))}(display: &quot;Combat Container&quot;) |note&gt;[If you win within four Attack Rounds, the cat&#39;s pelt is undamaged enough to be worth keeping.]  |victory)[{
	(hide: ?note)
	Did you win within four (link-reveal:&quot;Attack Rounds&quot;)[(set: _yes to $combat&#39;s round &lt; 4)(show:?1)]?
    |1)[(dialog: [(if: _yes)[Yes, you won within four Attack Rounds](else:)[No, you took more than four Attack Rounds]])
    (if: _yes)[($add_item:&quot;Wildcat&#39;s Pelt&quot;)If so, the cat&#39;s pelt is undamaged enough to be worth [[keeping-&gt;Page 13]].](else:)[If not, the cat&#39;s pelt is too damaged to be worth [[keeping-&gt;Page 13]].]]
}]</tw-passagedata><tw-passagedata pid="251" name="Page 56" tags="" position="2200,4925" size="100,100">A little way beyond the village you come to the ruins of what was once a farmhouse and its barns.  Sitting in front of the farmhouse is an old woman, threading bones on to a length of twine.  She is mumbling to herself, and hasn&#39;t noticed you yet.  Will you [[approach her-&gt;Page 23]], or make your way [[around the farmhouse-&gt;Page 336]] under cover?</tw-passagedata><tw-passagedata pid="252" name="Page 315" tags="" position="2075,4925" size="100,100">You find nothing of interest, except that right in the middle of the garden of the largest house a black-shafted spear is stuck into the ground.  A blood-red &#39;M&#39; is sewn on to the black flag which flutters from the end of the spear.  This is clearly some kind of challenge from Morgana.  Will you [[grasp the spear-&gt;Page 11]] to pluck it out of the ground, or leave it and carry on, either [[north-&gt;Page 56]] through the village or [[north-east-&gt;Page 323]] away from it?</tw-passagedata><tw-passagedata pid="253" name="Page 148" tags="" position="2950,5175" size="100,100">(link-reveal: &quot;Roll two dice&quot;)[{
	(set: _roll to ($ROLL2:))
    (set: _yes to _roll &lt;= $player&#39;s skill)
    (set: _label to (cond: _yes, &quot;Less than or equal to your SKILL&quot;, &quot;Greater than your SKILL&quot;))
    (dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)], _label)
    (if: _yes)[(go-to: &quot;Page 206&quot;) [[Page 206]] ](else:)[(go-to: &quot;Page 134&quot;) [[Page 134]] ]
}] and compare the total to your SKILL score.
</tw-passagedata><tw-passagedata pid="254" name="Page 47" tags="" position="3075,5175" size="100,100">Only a few kilometres north you find an impassable canyon.  There is no bridge here across its span of several hundred metres, and the sides are too steep to climb.  Animals, fleeing the fire, are jumping over, or being pushed by other beasts, to their deaths in the shallow river at the bottom of the gorge, about half a kilometre below.  If you have rope, it will not reach the bottom, of course, but you could tie one end to a boulder and (link-reveal:&quot;let yourself down&quot;)[(show: ?rope)] until the fire burns itself out at this natural fire-break.  Alternatively, you could run along the edge of the cliff to the [[west-&gt;Page 278]] or [[east-&gt;Page 134]], hoping to find some way down or across; or you could race away from the cliff and [[towards the fire-&gt;Page 359]].
|rope)[{
	(set: _yes to $player&#39;s inventory contains &quot;Rope&quot;)
    (if: _yes)[ (go-to: &quot;Page 90&quot;) [[Page 90]] ]
    (dialog: &quot;But you don&#39;t have any rope!&quot;)
}]</tw-passagedata><tw-passagedata pid="255" name="Page 332" tags="" position="2825,5175" size="100,100">After a while, you think you can see the end of the fire, but it is too far away for you to reach before the line reaches you.  You must think again.  There is no point in running in the opposite direction to try to find the other limit of the fire, so will you run [[north-&gt;Page 47]] away from the fire or [[south-&gt;Page 221]] towards the fire?</tw-passagedata><tw-passagedata pid="256" name="Page 62" tags="" position="3200,5175" size="100,100">(go-to: &quot;Page 332&quot;)[[Page 332]]</tw-passagedata><tw-passagedata pid="257" name="Page 221" tags="" position="3325,5175" size="100,100">Almost immediately you begin to come across countless animals, large and small, fleeing north away from the fire.  ($test_your_luck:)
|lucky)[(go-to: &quot;Page 7&quot;) [[Page 7]] ]
|unlucky)[(go-to: &quot;Page 191&quot; [[Page 191]] ]</tw-passagedata><tw-passagedata pid="258" name="Page 11" tags="key" position="2075,5050" size="100,100">As soon as you take hold of the spear, your hand is stuck to it.  A vision materializes beside you, of Morgana herself!  &#39;Excellent!&#39; she cries.  &#39;Glad to see you&#39;re on your way.  Our little plan is working well.  Don&#39;t worry: I won&#39;t kill ($dotdotdot:&quot;you&quot;) yet!  But here&#39;s a foretaste of my power.&#39;  The vision raises her hands and curses you (lose 2 LUCK points).($LUCK:-2)(set: $player&#39;s cursed to true)  Then Morgana disappears and you can remove your hand from the spear.  You break the spear across your thigh.  Will you now carry on [[north-&gt;Page 56]] through the village, or [[leave the village-&gt;Page 323]] and travel north-east?</tw-passagedata><tw-passagedata pid="259" name="Page 23" tags="" position="2200,5050" size="100,100">The old woman looks up when you approach her.  A look of fear flits over her face, then she begins to laugh hysterically.  She is obviously crazy.  Will you [[slap her face-&gt;Page 164]] to shock her out of the hysteria, or [[sadly leave her-&gt;Page 336]] in her torment?</tw-passagedata><tw-passagedata pid="260" name="Page 164" tags="" position="2325,5050" size="100,100">Your slaps change hysterical laughter into uncontrolled sobbing, which eventually subsides.  The old woman looks up at you again.  &#39;Give me something precious,&#39; she says slyly, &#39;and I&#39;ll tell you something precious.&#39;  You&#39;re not convinced that anything she has to say will not be dangerously misleading.  Will you [[offer her something-&gt;Page 326]], or leave her and [[continue on your way-&gt;Page 336]]?</tw-passagedata><tw-passagedata pid="261" name="Page 326" tags="" position="2450,5050" size="100,100">Will you give her:
{&lt;ul&gt;
	&lt;li&gt;(link-reveal:&quot;3 Gold Pieces&quot;)[(show: ?1)]?&lt;/li&gt;
    &lt;li&gt;A (link-reveal:&quot;jewelled neck-band&quot;)[(show: ?2)]?&lt;/li&gt;
    &lt;li&gt;A (link-reveal:&quot;garnet ring&quot;)[(show: ?3)]?&lt;/li&gt;
    &lt;li&gt;(link-reveal:&quot;Cholumbara&quot;)[(show: ?4)]?&lt;/li&gt;
&lt;/ul&gt;

}If you don&#39;t want to (or can&#39;t) give her anything, you will have to [[leave the village-&gt;Page 336]].

{
|1)[(if: $player&#39;s gold &gt;= 3)[($GOLD: -3)(go-to: &quot;Page 223&quot;) [[Page 223]] ] (dialog:&quot;You don&#39;t have 3 Gold Pieces&quot;)]
|2)[(if: $player&#39;s inventory contains (a: &quot;Bejewelled Choker&quot;))[($remove_item: &quot;Bejewelled Choker&quot;)(go-to: &quot;Page 110&quot;) [[Page 110]] ] (dialog:&quot;You don&#39;t have a jewelled neck-band&quot;)]
|3)[(if: $player&#39;s inventory contains (a: &quot;Garnet Ring&quot;))[($remove_item: &quot;Garnet Ring&quot;)(go-to: &quot;Page 44&quot;) [[Page 44]] ] (dialog:&quot;You don&#39;t have a garnet ring&quot;)]
|4)[(if: $player&#39;s inventory contains (a: &quot;Cholumbara&quot;))[($remove_item: &quot;Cholumbara&quot;)(go-to: &quot;Page 196&quot;) [[Page 196]] ] (dialog:&quot;You don&#39;t have Cholumbara&quot;)]
}</tw-passagedata><tw-passagedata pid="262" name="Page 223" tags="" position="2200,5175" size="100,100">&#39;That&#39;ll do nicely,&#39; she cackles.  &#39;Now listen carefully.  Seek the Juja.  The Juja knows more than I do.&#39;  Then she breaks out again into peals of hysterical laughter, and you can get nothing more out of her.  Will you now continue [[north-&gt;Page 336]] or [[north-east-&gt;Page 323]]?</tw-passagedata><tw-passagedata pid="263" name="Page 110" tags="" position="2325,5175" size="100,100">The old woman greedily snatches the lovely choker and puts it on.  The choker promptly lives up to its name and strangles her.  You should have known better than to trust anything found on the servants of evil.  Lose 1 LUCK point.($LUCK:-1)  You quickly make you way out of the area.  Will you go [[north-&gt;Page 336]] or [[north-east-&gt;Page 323]]?</tw-passagedata><tw-passagedata pid="264" name="Page 44" tags="" position="2075,5175" size="100,100">This quietens her down immediately.  &#39;The ring of my sisters&#39; coven in Affen Forest,&#39; she says in amazement.  &#39;How did ($dotdotdot:&quot;you&quot;)?  Never mind: it&#39;s good to have it back.  Now, what was it I had to tell you?  Oh, yes.  Seek the Juja.  I don&#39;t know where he lives, but there&#39;s supposed to be a clue in a riddle: &quot;I am not earth, but I can support; I am not water, but I can yield; I am not air, but I can belch; I am not fire, but I can explode.  What am I?&quot;  And that&#39;s really all I can tell you; I hope it&#39;s helpful.&#39;  This is most puzzling.  Will you thank her and walk on [[north-&gt;Page 336]] or [[north-east-&gt;Page 323]]?  Or will you first [[ask her what happened-&gt;Page 249]] to the village?</tw-passagedata><tw-passagedata pid="265" name="Page 196" tags="" position="2450,5175" size="100,100">(go-to: &quot;Page 223&quot;) [[Page 223]]</tw-passagedata><tw-passagedata pid="266" name="Page 249" tags="" position="2075,5300" size="100,100">Your question triggers another attack of hysteria.  All you can gather is that &#39;She ($dotdotdot:&quot;came&quot;) the ($dotdotdot:&quot;she-devil&quot;) took my ($dotdotdot:&quot;husband&quot;) he was the farmer.&#39;  Then you leave her, hoping she will find peace.   Will you head [[north-&gt;Page 336]] or [[north-east-&gt;Page 323]]?</tw-passagedata><tw-passagedata pid="267" name="Page 134" tags="death" position="2825,5300" size="100,100">In the hour or so which it takes for the fire to reach you, you have found no way out of your predicament.  You die a quick and agonizing death.</tw-passagedata><tw-passagedata pid="268" name="Page 206" tags="" position="2700,5300" size="100,100">You realize that there is little point in running, and that your only hope is to create a fre-break between yourself and the bush-fire.  The only means you have of making such a fire-break is to start your own fire, which will burn up the shrubs and leave the bush-fire nothing to catch on.  Will you start a fire to the [[south of where you stand-&gt;Page 102]], between yourself and the bush-fire, or [[north of where you stand-&gt;Page 168]]?</tw-passagedata><tw-passagedata pid="269" name="Page 278" tags="" position="2950,5300" size="100,100">(go-to: &quot;Page 134&quot;)[[Page 134]]</tw-passagedata><tw-passagedata pid="270" name="Page 359" tags="" position="3075,5300" size="100,100">Half a kilometre away from the cliff, you pause for thought.  (link-reveal: &quot;Roll two dice&quot;)[{
	(set: _roll to ($ROLL2:))
    (set: _yes to _roll &lt;= $player&#39;s skill)
    (set: _label to (cond: _yes, &quot;Less than or equal to your SKILL&quot;, &quot;Greater than your SKILL&quot;))
    (dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)], _label)
    (if: _yes)[(go-to: &quot;Page 365&quot;) [[Page 365]] ](else:)[(go-to: &quot;Page 134&quot; [[Page 134]] ]
}] and compare the total to your SKILL score.
</tw-passagedata><tw-passagedata pid="271" name="Page 7" tags="" position="3325,5300" size="100,100">You are bowled over in the rush, and narrowly miss knocking your head against a rock.  Will you now [[carry on south-&gt;Page 288]] towards the fire, or [[go north-&gt;Page 47]] with the animals?</tw-passagedata><tw-passagedata pid="272" name="Page 191" tags="death" position="3450,5300" size="100,100">You are bowled over in the rush, and knock yourself unconscious against a rock.  Only the agony of the fire consuming your body rouses you for a brief instant.  Your adventure is over.</tw-passagedata><tw-passagedata pid="273" name="Page 102" tags="death" position="2825,5425" size="100,100">You start a small fire and move away north to wait until your fire has, as you hope, created a fire-break between you and the bush-fire.  It does nothing of the sort.  Your own fire is driven before the wind towards you and even if you can run around it, there will be no time to escape the bush-fire now.  Your adventure is over.</tw-passagedata><tw-passagedata pid="274" name="Page 168" tags="" position="2950,5425" size="100,100">This is the only possible solution.  Your fire will make a desolate area, which you can enter and wait for the bush-fire to burn itself out.  But have you enough time for this area to be consumed and cool down, before the bush-fire is upon you?  (link-reveal: &quot;Roll one die&quot;)[{
	(set: _roll to ($ROLL1:))
    (dialog: (str: &quot;You roll: &quot;, _roll))
    (if: _roll &lt;= 2)[(go-to: &quot;Page 52&quot;) [[Page 52]] ]
    (if: _roll &lt;= 4)[(go-to: &quot;Page 17&quot;) [[Page 17]] ]
    (if: _roll &lt;= 6)[(go-to: &quot;Page 114&quot;) [[Page 114]] ]
}].</tw-passagedata><tw-passagedata pid="275" name="Page 288" tags="death" position="3325,5425" size="100,100">The heat soon becomes unbearable.  You realize that you will never break through this wall of flame, and now it is too late to do anything else.  Your adventure is over.</tw-passagedata><tw-passagedata pid="276" name="Page 52" tags="" position="2950,5550" size="100,100">By the time you have no choice except to enter your fire-break, it is still very hot, and causes you 4 STAMINA points of burns.  But at least you are [[safe-&gt;Page 114]].</tw-passagedata><tw-passagedata pid="277" name="Page 114" tags="" position="3075,5550" size="100,100">You are safe within your fire-break, and you follow it north, to keep well away from the suffocating heat of the bush-fire.  After a few kilometres, you find that your fire has burned itself out at the edge of a [[huge canyon-&gt;Page 10]].  The sides are too steep to climb and there is no bridge here.</tw-passagedata><tw-passagedata pid="278" name="Page 17" tags="death" position="2825,5550" size="100,100">Unfortunately, by the time the bush-fire reaches you, your own fire has not formed a large enough area for you to escape the suffocating heat.  Your adventure is over.</tw-passagedata><tw-passagedata pid="279" name="Page 10" tags="" position="3075,5675" size="100,100">Add 1 LUCK point for surviving the bush-fire.($LUCK: 1)  You now face a lengthy journey along the edge of the canyon, until you can find some way across or down it.  At least there will be plenty of roast meat, from animals which died in the fire, to keep you going on the way; and the streams, though oily and blackened from the fire, still provide water which is refreshing enough.  Will you head [[east-&gt;Page 98]] or [[west-&gt;Page 70]] along the cliff?</tw-passagedata><tw-passagedata pid="280" name="Page 90" tags="death" position="3200,5300" size="100,100">You let yourself down on to a ledge where you can comfortably wait for the fire to end.  The fire does eventually die out, but not before it has burned through the end of your rope which is tied to the boulder.  You are marooned on your ledge, until starvation or birds of prey finish you off.</tw-passagedata><tw-passagedata pid="281" name="Page 365" tags="" position="3075,5425" size="100,100">You realize that you need to create a fire-break between yourself and the bush-fire, but you have left yourself little time.  The only means you have of making such a fire-break is to start your own fire, which will burn up the shrubs and leave the bush-fire nothing to catch on.  Will you start a fire to the [[south of where you stand-&gt;Page 102]], between yourself and the bush-fire, or [[north of where you stand-&gt;Page 168]], between yourself and the cliff?</tw-passagedata><tw-passagedata pid="282" name="Page 98" tags="combat" position="3075,5800" size="100,100">For several days you trudge east.  The canyon varies in width and depth, but it is never feasible to attempt a crossing, and the sides remain absolutely sheer.  Early one morning you encounter a hostile Hill Giant, who has been roaming the burned wilderness to see what tasty or profitable pickings the bush-fire left in its wake.  One look at you convinces him that you could be both tasty and profitable!  He lumbers into the attack, wielding a massive club.  If you have the (link-reveal: &quot;Cloak of Temporary Invisibility&quot;)[(show: ?cloak)] and wish to use it, it will be easy to avoid this fight, but its magic will only work once.  Otherwise, fight your vast opponent.{
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Hill Giant&quot;,
		&quot;skill&quot;, 9,
		&quot;stamina&quot;, 11,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
	)
))(display: &quot;Combat Container&quot;)

|victory)[
	If you win, you look through the Giant&#39;s pack to see what he has found.  You find only 3 Gold Pieces($GOLD: 3) and a badly dented, but otherwise plain helmet.  Will you [[try on the helmet-&gt;Page 311]], or leave it and [[continue on your way-&gt;Page 180]]?
]

|cloak)[
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        ($remove_item: &quot;Invisibility Cloak&quot;)
        (go-to: &quot;Page 180&quot;) [[Page 180]]
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
]
}</tw-passagedata><tw-passagedata pid="283" name="Page 70" tags="" position="3200,5800" size="100,100">For several days you trudge west.  The canyon varies in width and depth, but it is never feasible to attempt a crossing.  The sides remain absolutely sheer.  The plentiful carrion has attracted many birds: apart from crows and normal birds of prey, you occasionally sight larger winged creatures some way off.  Eventually one of them decides to see if this thing that moves in the burned wilderness is also edible, and you are attacked by a Giant Bloodhawk.  This huge creature swoops out of the sky with its four-metre wingspan, talons outstretched to grip you and allow the cruel beak to do its work.  If you have the (link-reveal:&quot;Cloak of Temporary Invisibility&quot;)[(show:?cloak)] you may use it, otherwise you will have to [[do combat-&gt;Page 327]].

{
|cloak)[
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        ($remove_item: &quot;Invisibility Cloak&quot;)
        (go-to: &quot;Page 103&quot;) [[Page 103]]
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
]
}</tw-passagedata><tw-passagedata pid="284" name="Page 180" tags="" position="2950,5925" size="100,100">Early the next day you at last reach a place where the gorge can be crossed.  A landslide in the distant past shifted the earth so that there is a rough trail down to the bottom, and you think you can discern a similar trail back up the other side.  The gorge is not too deep here either.  No doubt because this was the popular place to cross, a rope bridge has also been slung across the chasm, to make the crossing quicker.  The rope bridge looks as secure as any such bridges are, and the trail looks precarious but usable.  Will you [[cross the bridge-&gt;Page 247]], or go [[down the trail-&gt;Page 117]]?</tw-passagedata><tw-passagedata pid="285" name="Page 311" tags="" position="3075,5925" size="100,100">You quickly discover why the helmet is so dented.  As soon as you put it on, it presses down on you like a ton of stone; you topple to the ground and bang your head.  You manage to prise it off, but must lose 1 STAMINA point for slight concussion.($STAMINA: -1)  Then you continue on your way [[east-&gt;Page 180]].</tw-passagedata><tw-passagedata pid="286" name="Page 327" tags="combat" position="3325,5925" size="100,100">There is no escaping the Bloodhawk&#39;s piercing gaze. {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Giant Bloodhawk&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
        &quot;alignment&quot;, &quot;neutral&quot;
	)
))(display: &quot;Combat Container&quot;) |note&gt;[The Bloodhawk is not evil, so the Horn of Hever will have no effect on it.]

|victory)[(hide: ?note)
	If you win, you can [[continue on your way-&gt;Page 201]].
]}</tw-passagedata><tw-passagedata pid="287" name="Page 103" tags="" position="3200,5925" size="100,100">($remove_item: &quot;Invisibility Cloak&quot;)You put on the Cloak.  The Bloodhawk squawks in dismay at your disappearance -- but then, with the cunning of a natural predator, simply gains enough height to watch and wait.  The Cloak&#39;s powers will wear off pretty soon: you have merely delayed the [[battle-&gt;Page 327]].</tw-passagedata><tw-passagedata pid="288" name="Page 247" tags="" position="2825,5925" size="100,100">You have gone about fifty metres across the bridge, when a Chimera materializes in front of you and demands to know the password.  You don&#39;t know it, of course; in fact, there probably isn&#39;t one, but the Chimera just wants an excuse for a fight.  The Chimera has a lion&#39;s head, a goat&#39;s body and a serpent&#39;s tail; its weapon is the deadly fire it breathes.  outstretched to grip you and allow the cruel beak to do its work.  If you have the (link-reveal:&quot;Cloak of Temporary Invisibility&quot;)[(show:?cloak)] you may wish to use it, otherwise you will have to [[do combat-&gt;Page 145]]!

{
|cloak)[
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        (go-to: &quot;Page 190&quot;) [[Page 190]]
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
]
}</tw-passagedata><tw-passagedata pid="289" name="Page 117" tags="" position="3075,6050" size="100,100">When you reach the bottom, you find that the river, which flows from east to west, is faster and wider than it looked from up on the cliff.  The movement of the water makes it impossible to tell how deep it is.  You are on a kind of small beach, but the river runs full up to the sheer cliffs on either side of the beach.  There are some quite large logs and tree-trunks cast up on the beach, among smaller driftwood.  There is a similar beach straight across the river.  Will you [[wade or swim-&gt;Page 235]] across, or [[paddle yourself-&gt;Page 368]] across on a log?</tw-passagedata><tw-passagedata pid="290" name="Page 201" tags="" position="3325,6675" size="100,100">Early the next day, you notice that the cliffs are getting lower.  You contemplate jumping into the river from this height, but then you notice that the river is flowing extremely fast, and soon you hear the boom of a large waterfall ahead.  Before long you come to the lip of the falls.  The river is flowing between ordinary banks now, and the fine spray from the falls seems to hover in the air, scintillating with rainbow colours.  There is [[no way across-&gt;Page 293]] the river at this point.</tw-passagedata><tw-passagedata pid="291" name="Page 145" tags="combat" position="2700,6050" size="100,100">On the narrow rope bridge, you have no chance of avoiding the Chimera&#39;s fiery breath.  Every time it wins an Attack Round, it will cause 3 STAMINA points of injury; and even when it loses an Attack Round, it will cause you 1 STAMINA point of injury.  So you are fighting a desperate battle.  {
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Chimera&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 6,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
        &quot;damage&quot;, 3,
	)
))(display: &quot;Combat Container&quot;)
|combat_on_target_hit)[($STAMINA: -1) (append: ?combat_action)[&lt;p&gt;Fiery breath deals 1 damage!&lt;/p&gt;] ]
|combat_on_dodge)[($STAMINA: -1) (append: ?combat_action)[&lt;p&gt;Fiery breath deals 1 damage!&lt;/p&gt;] ]
|victory)[During the fight, the Chimera&#39;s breath gradually burns through the rope bridge.  If you win, you must choose whether to [[continue-&gt;Page 63]] across the now weakened bridge or [[retreat back-&gt;Page 272]] towards the cliff.]
}</tw-passagedata><tw-passagedata pid="292" name="Page 190" tags="" position="2825,6050" size="100,100">($remove_item: &quot;Invisibility Cloak&quot;)You put on the Cloak (its powers work once only, so remove it from your Inventory), and retreat back towards the cliff, since you cannot squeeze past the Chimera.  But the Chimera merely changes tactics: it breathes fire at the rope bridge instead of at you.  The bridge is soon in danger of [[collapsing-&gt;Page 272]].</tw-passagedata><tw-passagedata pid="293" name="Page 235" tags="" position="3200,6175" size="100,100">(set: _yes to $player&#39;s skill &gt;= 8 and $player&#39;s stamina &gt;= 12)The river is deeper than you thought, and the current is so strong that you are swept off your feet and downstream.  The river is now surrounded by sheer cliffs, with no beaches or other possible landing-places.  The constriction of the cliffs makes the water even more rough.  If your SKILL is 8 or over and your STAMINA is 12 or over, (link-reveal:&quot;you survive&quot;)[(show:?1)]|dead)[; otherwise you drown].  |1)[== {
	(show: ?dead)
    (set: _label to (cond: _yes, &quot;You survive&quot;, &quot;You drown&quot;))
	(dialog: [
    	(if: _yes)[Your SKILL is above 8 and your STAMINA is above 12](else:)[You are not strong enough to survive the water.]
    ], _label)
    (if: _yes)[If you survive, the river eventually widens again.  It is calmer and safer, but the cliffs are just as sheer.  You are swept downstream for kilometre upon kilometre (lose 2 STAMINA points).($STAMINA:-2)  However, you are able to haul yourself over a log, which helps.  Day turns into night, and then [[day again-&gt;Page 38]].
    ]
}</tw-passagedata><tw-passagedata pid="294" name="Page 368" tags="" position="3075,6175" size="100,100">You launch yourself into the river.  The force of the current immediately sweeps you downstream, well out of the way of the beach.  The sheer cliffs now press in on either side of the river, and the water becomes even more rough.  There are no beaches or other possible landing-places.  However, you manage to cling on to your log, as you are swept along for kilometre upon kilometre.  The river eventually widens again.  It is calmer and safer, but the cliffs are just as sheer.  Day turns into night, and then [[day again-&gt;Page 38]].</tw-passagedata><tw-passagedata pid="295" name="Page 293" tags="" position="3100,6900" size="100,100">There is a steep path down the cliff from the top of the waterfall to the large pool which has formed in the canyon below.  The cliffs here are craggier and less sheer, and you hope that, if you can cross the pool, you may be able to climb the northern cliff.  As you swim across the deep pool, you see that the northern cliff &lt;i&gt;is&lt;/i&gt; climbable -- but you also see a rather large Alligator waddle from the northern shore into the water, where its snout cuts a furrow in the water towards you.  If you have the Cloak of Temporary Invisibility, you cannot use it here: it would be too awkward and time-consuming to get it out of your pack.  Will you [[tread water-&gt;Page 43]] to meet the Alligator&#39;s onslaught in as stable a position as possible, or will you [[dive underwater-&gt;Page 380]] in an attempt to get at the creature&#39;s underbelly?</tw-passagedata><tw-passagedata pid="296" name="Page 63" tags="death" position="2575,6175" size="100,100">You are about halfway across when the bridge snaps.  You scrabble for a handhold, but find none, and plunge to your death in the canyon below.</tw-passagedata><tw-passagedata pid="297" name="Page 272" tags="" position="2700,6175" size="100,100">You gingerly creep back along the bridge towards the cliff, but the bridge snaps, and the short bit you are on swings towards the face of the cliff.  You scrabble for a handhold.  ($test_your_luck:).  If you are wearing Boots of Agility, they will do you no good here, since your arms, not your feet, are doing the work.
|lucky)[(go-to: &quot;Page 199&quot;) [[Page 199]] ]
|unlucky)[(go-to: &quot;Page 162&quot;) [[Page 162]] ]</tw-passagedata><tw-passagedata pid="298" name="Page 199" tags="" position="2825,6175" size="100,100">You manage to hang on, and then haul yourself up to the edge of the cliff.  You lie panting with exertion (lose 1 STAMINA point).($STAMINA: -1)  When you have recovered, you pick your way down the [[trail-&gt;Page 117]].</tw-passagedata><tw-passagedata pid="299" name="Page 162" tags="to-do" position="2700,6300" size="100,100">($remove_item: &quot;Helmet of Arion&quot;)You fail to find a handhold, and slide down the remaining bit of bridge and into space.  You prepare yourself for death, but land on the trail after only a few metres.  Your helmet (if you still have it) falls off your head and is lost in the chasm below. ($test_your_luck:) again.
|lucky)[(go-to: &quot;Page 259&quot;) [[Page 259]] ]
|unlucky)[(go-to: &quot;Page 139&quot;) [[Page 139]] ]</tw-passagedata><tw-passagedata pid="300" name="Page 38" tags="" position="3075,6300" size="100,100">The current grows stronger again, and soon you are alarmed to hear the ominous boom of a large waterfall ahead.  Although the cliffs gradually get lower, until the river is bounded on both sides by ordinary banks, the current is now far too strong for you to steer your log over to the side.  Before long you can see the lip of the waterfall; fine spray forms a mist which seems to hang above it, scintillating with rainbow colours.  But you don&#39;t have time to appreciate the beauty of the scene: more practical features claim your attention.  The lip of the waterfall is partially lined with rocks, which jut out of the water at intervals.  If you have a rope you could try to (link-reveal:&quot;lasso one of the rocks&quot;)[(show:?rope)].  Alternatively, you could try to [[turn the log-&gt;Page 217]] so that it wedges against two of the rocks.
|rope)[{
	(set: _yes to $player&#39;s inventory contains &quot;Rope&quot;)
    (if: _yes)[(go-to: &quot;Page 302&quot;) [[Page 302]] ]
    (dialog: &quot;But you don&#39;t have any rope.&quot;)
}]</tw-passagedata><tw-passagedata pid="301" name="Page 380" tags="" position="3225,6900" size="100,100">You manage to wound the Alligator before it too dives to meet you.  The battle is on, sometimes under water, sometimes on the surface.  The Alligator is not evil, so the Horn of Hever will have no effect on it, and you must reduce your skill by one point for this fight, because the water hampers your movements. ($SKILL: -1){==
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Alligator&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 8,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
        &quot;alignment&quot;, &quot;neutral&quot;,
	)
))(display: &quot;Combat Container&quot;)
|victory)[{
    ($SKILL: 1)
    If you win, (link-reveal:&quot;roll two dice&quot;)[
        (set: _roll to ($ROLL2:))
        (dialog: (str: &quot;You roll: &quot;, _roll))
    ].
    (if: _roll &gt;= 4 and _roll &lt;= 10)[(go-to: &quot;Page 393&quot;) [[Page 393]] ]
    (else:)[(go-to: &quot;Page 122&quot;) [[Page 122]]]
}]</tw-passagedata><tw-passagedata pid="302" name="Page 393" tags="" position="3100,7150" size="100,100">You reach the northern shore and dry off.  The climb up the cliff is fairly easy.  Once at the top, you pause to estimate your position.  You think that you have come so far west that the dreaded Marsh Vile now lies to the north, and the foothills to the mountain range of Krill Garnash to the north-east.  You know you should avoid Marsh Vile if you possibly can, but will you [[head north-&gt;Page 357]] for a while or [[north-east-&gt;Page 374]]?</tw-passagedata><tw-passagedata pid="303" name="Page 122" tags="" position="3350,6900" size="100,100">When you dived below the water, you saw something extraordinary on the bottom of the pool.  A human skeleton was sitting on a throne of weeds.  Will you [[dive down again-&gt;Page 261]] to investigate this remarkable, but possibly dangerous phenomenon, or will you [[swim over-&gt;Page 393]] to the northern shore?</tw-passagedata><tw-passagedata pid="304" name="Page 259" tags="" position="2825,6300" size="100,100">The trail is narrow, but you manage to stay on it.  You have, however, sustained 2 STAMINA points of cuts and bruises in your fall.($STAMINA: -2) You dust yourself off, and pick your way [[down the trail-&gt;Page 117]].</tw-passagedata><tw-passagedata pid="305" name="Page 139" tags="death" position="2700,6425" size="100,100">You land with such a thump on the trail that it supports you for no more than an instant before crumbling and plunging you to your death in the chasm below.</tw-passagedata><tw-passagedata pid="306" name="Page 217" tags="" position="2950,6425" size="100,100">($test_your_luck:).
|lucky)[(go-to: &quot;Page 133&quot;) [[Page 133]] ]
|unlucky)[(go-to: &quot;Page 116&quot;) [[Page 116]] ]</tw-passagedata><tw-passagedata pid="307" name="Page 302" tags="" position="3075,6425" size="100,100">(link-reveal: &quot;Roll two dice&quot;)[{
	(set: _roll to ($ROLL2:))
    (set: _yes to _roll &lt;= $player&#39;s skill)
    (set: _label to (cond: _yes, &quot;Less than or equal to your SKILL&quot;, &quot;Greater than your SKILL&quot;))
    (dialog: [You roll: (print: $die1) + (print: $die2) = (print: $total)], _label)
    (if: _yes)[(go-to: &quot;Page 75&quot;) [[Page 75]] ](else:)[(go-to: &quot;Page 116&quot;) [[Page 116]] ]
}] and compare the total to your SKILL score.
</tw-passagedata><tw-passagedata pid="308" name="Page 133" tags="" position="2825,6550" size="100,100">The plan works.  You pull yourself on to a rock and look around.  There are not enough rocks to form a causeway to the north bank, but you could try to make it to the south bank.  Do you have the (link-reveal:&quot;Boots of Agility&quot;)[(show:?boots)], or a (link-reveal:&quot;rope&quot;)[(show:?rope)]?  Otherwise, you have a choice of two extremely risky manoeuvres: you could use the slippery rocks as [[stepping-stones-&gt;Page 159]], or you could get back into the water and try to [[push your log-&gt;Page 324]] from one pair of rocks to the next, so that you can move along by stages.
|boots)[{
	(set: _yes to $player&#39;s inventory contains &quot;Boots of Agility&quot;)
    (if: _yes)[(go-to: &quot;Page 372&quot;) [[Page 372]] ]
    (dialog: &quot;But you don&#39;t have the Boots of Agility.&quot;)
}]
|rope)[{
	(set: _yes to $player&#39;s inventory contains &quot;Rope&quot;)
    (if: _yes)[(go-to: &quot;Page 188&quot;) [[Page 188]] ]
    (dialog: &quot;But you don&#39;t have any rope.&quot;)
}]</tw-passagedata><tw-passagedata pid="309" name="Page 116" tags="death" position="2950,6550" size="100,100">Your plan fails.  You are dashed to your death on the sharp rocks at the foot of the waterfall.</tw-passagedata><tw-passagedata pid="310" name="Page 75" tags="" position="3075,6550" size="100,100">Your plan works (restore 1 LUCK point.)($LUCK: 1)  for one awful moment your legs are swept over the edge, following the log, but you hang on and haul yourself on to the rock.  Do you have the (link-reveal:&quot;Boots of Agility&quot;)[(show:?boots)].
|boots)[{
	(set: _yes to $player&#39;s inventory contains &quot;Boots of Agility&quot;)
    (if: _yes)[(dialog: &quot;Yes, you have the Boots of Agility.&quot;)(go-to: &quot;Page 372&quot;) [[Page 372]] ]
    (dialog: &quot;No, you don&#39;t have the Boots of Agility.&quot;)
    (go-to: &quot;Page 188&quot;)[[Page 188]]
    
}]</tw-passagedata><tw-passagedata pid="311" name="Page 357" tags="" position="3225,7275" size="100,100">As you continue north, you soon begin to see, some way ahead, the pall of vapour which continually covers Marsh Vile.  Among the many streams and rivulets which crosscross this part of the plain, you come across one which has been reduced to a mere trickle; the exposed mud is still damp.  Will you [[follow it upstream-&gt;Page 25]] to find out what is blocking it or [[continue north-&gt;Page 125]]?</tw-passagedata><tw-passagedata pid="312" name="Page 374" tags="" position="2775,7675" size="200,200">You travel by easy stages to the foothills of the northern mountain range.  There is quite a but of game, so you use up only 1 lot of Provisions.($PROVISIONS: -1)  One night, you camp by a copse.  In the morning, will you [[walk through-&gt;Page 113]] the copse or [[around it-&gt;Page 126]]?</tw-passagedata><tw-passagedata pid="313" name="Page 261" tags="" position="3475,6900" size="100,100">Closer inspection reveals two things: that the throne of weeds is actually a real throne which has simply become overgrown with weeds (though the skeleton is clean); and that the skeleton is holding an orb in its right hand and wearing a crown on its head.  Will you try to take the [[orb-&gt;Page 320]] or the [[crown-&gt;Page 74]], or will you [[return to the surface-&gt;Page 393]] and swim over to the northern shore?</tw-passagedata><tw-passagedata pid="314" name="Page 159" tags="" position="2950,6675" size="100,100">(set: _roll to 0)There are three rocks to cross.  Roll one die three times.  If you ever roll 1, you fall in and are swept over the falls to your death.  If you ever roll 2, you slip and your helmet (if you still have it) falls off your head and is lost, but you cling on to the rock.

|rocks&gt;[
	Rock 1: |rock1&gt;[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(show:?rock2)(rerun:?helmet)].]
	Rock 2: |rock2)[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(show:?rock3)(rerun:?helmet)].]
	Rock 3: |rock3)[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(show:?shore)(rerun:?helmet)].]
]
|helmet&gt;[{
	(if: _roll is 1)[You fall into the water and are swept away. Your adventure is over.  (hide:?shore)(hide:?rocks&#39;s links)]
	(if: _roll is 2)[You slip and lose your helmet! ($remove_item: &quot;Helmet of Arion&quot;)]
}]

|shore)[Eventually, you reach the [[south bank-&gt;Page 293]].]</tw-passagedata><tw-passagedata pid="315" name="Page 324" tags="death" position="3075,6675" size="100,100">This is doomed to failure.  As soon as you start to push the log out of its secure position, you and it are swept over the falls.  The log survives fairly intact, but you don&#39;t.  Your adventure is over.</tw-passagedata><tw-passagedata pid="316" name="Page 188" tags="" position="2825,6675" size="100,100">(set: _roll to 0)You decide that the best bet is to lasso each successive rock and hold on to the rope while you step from rock to slippery rock, just in case you fall in.  There are four rocks to pass over.  Roll one die four times.  If you ever roll 1, you fall in, and though your rope holds and you haul yourself back up, your helmet (if you still have it) falls off your head and is lost.

Rock 1: |rock1&gt;[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(rerun:?helmet)(show:?rock2)].]
Rock 2: |rock2)[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(rerun:?helmet)(show:?rock3)].]
Rock 3: |rock3)[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(rerun:?helmet)(show:?rock4)].]
Rock 4: |rock4)[(link-reveal: &quot;Roll one die&quot;)[(set: _roll to ($ROLL1:)) -- (print: _roll)(rerun:?helmet)(show:?shore)].]
|helmet&gt;[(if: _roll is 1)[You fall into the water and lose your helmet! ($remove_item: &quot;Helmet of Arion&quot;)]]

|shore)[Eventually, you reach the [[south bank-&gt;Page 293]].]</tw-passagedata><tw-passagedata pid="317" name="Page 372" tags="" position="2700,6675" size="100,100">You step safely from rock to slippery rock, until you reach the [[south bank-&gt;Page 293]].</tw-passagedata><tw-passagedata pid="318" name="Page 25" tags="" position="3350,7275" size="100,100">Not far upstream you come across the prostrate body of a hill-tribe warrior.  It is this that is blocking the stream.  Several arrows are protruding from her, but she is just alive.  If you bought a Healing Potion from the alchemist, and have not used it on yourself, you can (link-reveal:&quot;use it on her&quot;)[(show: ?potion)], if you want. Otherwise there is [[nothing you can do-&gt;Page 300]].
|potion)[{
	(if: $player&#39;s inventory contains &quot;Potion of Healing&quot;)[
        ($remove_item: &quot;Potion of Healing&quot;)
        (go-to: &quot;Page 338&quot;) [[Page 338]]
    ]
    (dialog: &quot;But you don&#39;t have the Potion of Healing.&quot;)
}]
</tw-passagedata><tw-passagedata pid="319" name="Page 125" tags="" position="2775,7550" size="100,100">You camp for the night on the borders of Marsh Vile.  All night long, within the mists and vapours which shroud this ill-famed region, lightning flashes, and the bubbles of marsh gas which form on the surface of the bubbling pools pop and explode.  In the morning will you at last turn to the [[north-east-&gt;Page 374]], or will you [[explore Marsh Vile-&gt;Page 345]]?</tw-passagedata><tw-passagedata pid="320" name="Page 126" tags="" position="2700,7900" size="100,100">You leave the copse behind you and continue up towards the mountains, which now loom large and forbidding in the near distance.  The hills grow more steep and bleak, so it is strange to see, crowning one hill, two large and flourishing oak trees, like a portal to the sunset beyond.  Will you [[climb the hill-&gt;Page 387]] and investigate the trees, or [[carry determinedly on-&gt;Page 37]] with your journey?</tw-passagedata><tw-passagedata pid="321" name="Page 113" tags="combat" position="2825,7900" size="100,100">The easy journey of the past few days has made you careless.  As you walk whistling down the path through the trees, you are set upon by a Giant Bloodsucking Spider.  This vile beast, already bloated with the blood of woodland creatures, is delighted to find larger prey, and drops in front of you from a tree.  Sheer repulsion at the sight freezes you for an instant, but then your sword is out and ready.  You have no time to get anything out of your pack.{==
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Giant Bloodsucking Spider&quot;,
		&quot;skill&quot;, 6,
		&quot;stamina&quot;, 14,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;&quot;,
	)
))(display: &quot;Combat Container&quot;)
|escape&gt;[The Spider is too heavy to move very fast: you could try to [[escape-&gt;Page 273]], if you want to.]  |victory)[(hide:?escape)If you stay put and win the fight, you [[continue cautiously-&gt;Page 126]] through the copse.]</tw-passagedata><tw-passagedata pid="322" name="Page 320" tags="to-do" position="3475,7025" size="100,100">(set: _yes to $player&#39;s inventory contains &quot;Helmet of Arion&quot;)Do you still have (link-reveal:&quot;your helmet&quot;)[(show:?helmet)]?

|helmet)[{
	(dialog: (cond: _yes, &quot;Yes, you still have your helmet&quot;, &quot;No, you have lost your helmet&quot;))
    (if: _yes)[ (go-to: &quot;Page 161&quot;) [[Page 161]] ]
    (go-to: &quot;Page 74&quot;) [[Page 74]]
}]</tw-passagedata><tw-passagedata pid="323" name="Page 74" tags="death" position="3350,7025" size="100,100">The skeleton&#39;s empty eye sockets blaze into chill life and transfix you with a deadly beam.  Your adventure is over.</tw-passagedata><tw-passagedata pid="324" name="Page 161" tags="item" position="3475,7150" size="100,100">The skeleton&#39;s empty eye sockets blaze into chill life, but it offers no resistance.  You take the orb and swim over to the northern shore.  When you clean the mud off the orb, you discover the following legend: &#39;Twenty-one is the number of the ruler&#39;s sway.&#39;  You stow the orb safely into your pack and climb up the cliff.  Once at the top you estimate your position.  You think that you have come so far west that the dreaded Marsh Vile now lies to the north, and the foothills to the mountain range of Krill Garnash to the north-east.  You know you should avoid Marsh Vile if you possibly can, but will you [[head north-&gt;Page 357]] for a while or [[north-east-&gt;Page 374]]?  ($add_item: &quot;Ruler&#39;s Orb&quot;)</tw-passagedata><tw-passagedata pid="325" name="Page 300" tags="" position="3225,7400" size="100,100">The warrior dies.  Will you [[continue north-&gt;Page 125]] or [[turn north-east-&gt;Page 374]]?</tw-passagedata><tw-passagedata pid="326" name="Page 338" tags="" position="3350,7400" size="100,100">The warrior&#39;s eyes flicker and open, and she looks up at you blankly.  As you prop her up against a rock, she mutters something about &#39;the Juja.&#39;  Her death is close, but you may be able to ask her one question first.  Will you ask her about this [[Juja-&gt;Page 353]], or if she knows how to get into [[Morgana&#39;s lair-&gt;Page 238]]?</tw-passagedata><tw-passagedata pid="327" name="Page 345" tags="" position="3475,7650" size="100,100">Boggy ground soon turns to pools with no more than occasional mounds of earth to support you.  There is nothing of interest to be seen.  Will you turn back and then [[head north-east-&gt;Page 374]] towards Krill Garnash?  Or will you jump from mound to mound, deeper into the marsh, to the [[left-&gt;Page 187]], [[right-&gt;Page 229]], or [[straight on-&gt;Page 165]]?</tw-passagedata><tw-passagedata pid="328" name="Page 273" tags="death" position="2950,7900" size="100,100">As soon as you turn tail, you give the Spider the chance to shoot out a mass of sticky web and hold you fast.  Her poisonous fangs sink into your flesh.  Your adventure is over.</tw-passagedata><tw-passagedata pid="329" name="Page 387" tags="" position="2575,7900" size="100,100">(set: _input to &quot;&quot;)If you can guess what you are supposed to do here, add together the numbers of the items involved, and enter it below.

|button&gt;[&lt;center&gt;(input: bind _input, &#39;=X=&#39;)(link-repeat: &quot;Check&quot;)[(rerun: ?check)(show: ?check)]&lt;/center&gt;]
Otherwise the trees shimmer mysteriously, but nothing happens to make you stay there.  You [[carry on-&gt;Page 37]] with your journey.

|check)[
    (if: _input is an empty or any of _input is not a digit)[
        (dialog:&quot;Please enter a number&quot;)
        (rerun: ?button)
    ]
]
|check)[
    (if: _input is not an empty and all of _input is a digit)[
        (set: _input to (num: _input))
        (if: $player&#39;s inventory contains &quot;Iron Sceptre&quot; and $player&#39;s inventory contains &quot;Ruler&#39;s Orb&quot; and _input is 22) [
            (go-to: &quot;Page 22&quot;) [[Page 22]]
        ]
        (dialog: &quot;You do not have the required items, or that is not the right number.&quot;)
    ]
]
</tw-passagedata><tw-passagedata pid="330" name="Page 37" tags="" position="2700,8025" size="100,100">(set: _yes to $player&#39;s inventory contains any of (a: &quot;Antifreeze Potion&quot;, &quot;Wildcat&#39;s Pelt&quot;))You camp on the northern side of the hill.  During the night, the first snow falls.  Do you have a (link-reveal:&quot;Wildcat&#39;s Pelt or an Antifreeze Potion&quot;)[(show: ?items)]?

|items)[
	(if: _yes)[
    	(go-to: &quot;Page 344&quot;) [[Page 344]]
    ]
    (dialog: &quot;No, you don&#39;t have either of these.&quot;)
    (go-to: &quot;Page 227&quot;) [[Page 227]]
]</tw-passagedata><tw-passagedata pid="331" name="Page 353" tags="" position="3475,7525" size="100,100">&#39;I was searching for him,&#39; she says, though the effort of speaking visibly weaken her.  &#39;He is close.  I don&#39;t know exactly where; I only know a rhyme: &quot;Do not wander, do not stray; always take the middle way.&quot;&#39;  But these are her last words.  You bury her and carry on, either [[north-&gt;Page 125]] or [[north-east-&gt;Page 374]].</tw-passagedata><tw-passagedata pid="332" name="Page 238" tags="" position="3350,7525" size="100,100">At the mention of Morgana&#39;s name, a shudder seizes her body and she grows visibly weaker.  But she has time to help you.  &#39;You will find three doors,&#39; she gasps.  &#39;You must take the wooden one.&#39;  But these are her last words.  You bury her and carry on, either [[north-&gt;Page 125]] or [[north-east-&gt;Page 374]].</tw-passagedata><tw-passagedata pid="333" name="Page 187" tags="death" position="3600,7775" size="100,100">One mound turns out to be the head of a huge Slime Sucker.  It shrugs you off into the surrounding mire, where you stick fast, so that it can devour you at its leisure.  Your adventure is over.</tw-passagedata><tw-passagedata pid="334" name="Page 229" tags="death" position="3475,7775" size="100,100">A large bubble of marsh gas bursts close by.  You are overcome by the poisonous fumes and slump unconscious into the surrounding waters, where unnameable creatures gobble you up.  Your adventure is over.</tw-passagedata><tw-passagedata pid="335" name="Page 165" tags="" position="3350,7650" size="100,100">After a spell of this tiring way of moving along, more solid ground appears to your right and left.  Will you turn [[left-&gt;Page 381]] or [[right-&gt;Page 263]], or continue jumping from mound to mound [[straight ahead-&gt;Page 193]]?</tw-passagedata><tw-passagedata pid="336" name="Page 22" tags="" position="2575,8025" size="100,100">(set: _input to &quot;&quot;)When you raise the sceptre and the orb, a shimmering screen appears between the oaks, and you step through.  You immediately come face to face with Vashti the ageless.  She nods gravely in recognition of you and the importance of your quest.  &#39;It is good that you have come here,&#39; she says.  &#39;There are still perils for you to overcome, but it is certain that you could not complete your mission without seeing me.  But I could not come to you, though I wanted to.  For once -- it would be a dozen centuries ago by your mortal reckoning -- I left this timeless land, but was set upon by countless Greater Demons.  During the battle, I lost the means of leaving my land again.  I wonder if you know what I mean?&#39;  If you do know, you will know the page of the book which gave you the clue.  Enter it below.

|button&gt;[&lt;center&gt;(input: bind _input, &#39;=X=&#39;)(link-repeat: &quot;Check&quot;)[(rerun: ?check)(show: ?check)]&lt;/center&gt;]

|check)[
    (if: _input is an empty or any of _input is not a digit)[
        (dialog: [Please enter a number, or [[continue-&gt;Page 329]]])
        (rerun: ?button)
    ]
]
|check)[
    (if: _input is not an empty and all of _input is a digit)[
        (set: _input to (num: _input))
        (if: _input is 208) [
            (go-to: &quot;Page 208&quot;) [[Page 208]]
        ]
        (dialog: [That is not the right number.  Try again, or [[continue-&gt;Page 329]]])
    ]
]
</tw-passagedata><tw-passagedata pid="337" name="Page 344" tags="" position="2825,8150" size="100,100">Either of these will keep the cold of the northern mountains from sapping your strength.  From now on, as you progress towards and into [[the mountains-&gt;Page 128]], the snow gets deeper and icy winds moan.</tw-passagedata><tw-passagedata pid="338" name="Page 227" tags="" position="2950,8150" size="100,100">From now on, as you progress towards and into [[the mountains-&gt;Page 128]], the snow gets deeper and icy winds moan.  Because you have little protection against the cold, your Provisions will restore only 3 STAMINA instead of the usual 4.(set: $player&#39;s provision_strength to 3)</tw-passagedata><tw-passagedata pid="339" name="Page 381" tags="death" position="3225,7775" size="100,100">A bolt of the lightning which constantly plays in this marsh strikes you dead.  Your adventure is over.</tw-passagedata><tw-passagedata pid="340" name="Page 193" tags="" position="3350,7775" size="100,100">The mounds become fewer.  Will you go [[left-&gt;Page 229]], [[half-left-&gt;Page 264]] or [[straight on-&gt;Page 187]]?</tw-passagedata><tw-passagedata pid="341" name="Page 208" tags="" position="2575,8150" size="100,100">(set: _input to &quot;&quot;)&#39;So, the Juja is alive, is he?&#39; she says.  &#39;Well, that&#39;s good to hear.  What fun we used to have when the world was young!  But knowing how to leave my domain, and actually being able to do so, are two different things, aren&#39;t they?  Do you have the seeds?&#39;  If you do, multiply the number of seeds by the number of dragons depicted on the container, and enter that number below.

(if: $player&#39;s inventory contains &quot;Snattacat&#39;s Tusk&quot;)[{

|button&gt;[&lt;center&gt;(input: bind _input, &#39;=X=&#39;)(link-repeat: &quot;Check&quot;)[(rerun: ?check)(show: ?check)]&lt;/center&gt;]

}](else:)[ [[You do not have the seeds-&gt;Page 329]].]

|check)[
    (if: _input is an empty or any of _input is not a digit)[
        (dialog: [Please enter a number, or [[continue-&gt;Page 329]]])
        (rerun: ?button)
    ]
]
|check)[
    (if: _input is not an empty and all of _input is a digit)[
        (set: _input to (num: _input))
        (if: $player&#39;s inventory contains &quot;Snattacat&#39;s Tusk&quot; and _input is 88) [
            (go-to: &quot;Page 88&quot;) [[Page 88]]
        ]
        (dialog: [That is not the right number.  Try again, or [[continue-&gt;Page 329]]])
    ]
]
</tw-passagedata><tw-passagedata pid="342" name="Page 264" tags="" position="3350,7900" size="100,100">The mist becomes thicker and more menacing.  Strange lights flicker and fade.  You can see nothing but water ahead, but there are mounds to the right and left.  Will you go [[right-&gt;Page 229]], [[left-&gt;Page 381]], or [[straight on-&gt;Page 215]]?</tw-passagedata><tw-passagedata pid="343" name="Page 215" tags="" position="3350,8025" size="100,100">As you step out, a magical causeway solidifies out of the mist, and you follow it to the home of the Juja.  No person and no legend knows his real name, only that this wizard retired here when the world became evil, long ago.  His body sits in a (link-reveal:&quot;shack&quot;)[(show:?1)], surrounded by old books and alchemical apparatus, but his mind journeys far and wide.

|1)[==When you enter his shack, he greets you and gives you a meal (restore 4 STAMINA points).($STAMINA: 4)  During the meal, you tell him of your quest.  ($dotdotdot:&quot;&#39;Hmm&quot;) well,&#39; he replies.  &#39;You&#39;d better see Vashti in Maiden&#39;s Vale.  She knows more than I do about this business.&#39;  You ask him how to get to Maiden&#39;s Vale.  &#39;Oh, I don&#39;t know how to get into it.  You should know already.  But I did find in one of my books a clue about how to get out, which is just as important, you know.&#39;  He gets a tome down from a shelf.  &#39;Yes, here it is, on page 208: &quot;The land of no time -- oak for in and apple for out.&quot;  I hope that will help you.  Is there anything else you&#39;d like me to do?&#39;  Gain 2 LUCK points for this vital information.($LUCK: 2)  Will you ask him to [[restore any of your faculties-&gt;Page 308]], or how to get into [[Morgana&#39;s lair-&gt;Page 167]]?</tw-passagedata><tw-passagedata pid="344" name="Page 308" tags="" position="3225,7900" size="100,100">Whichever of your |stats&gt;[(link-reveal:&quot;LUCK&quot;)[(set: $player&#39;s luck to (max: $player&#39;s luck, $player&#39;s initial_luck))(show:?switch)], (link-reveal:&quot;STAMINA&quot;)[(set: $player&#39;s stamina to (max: $player&#39;s stamina, $player&#39;s initial_stamina))(show:?switch)] or (link-reveal:&quot;SKILL&quot;)[(set: $player&#39;s skill to (max: $player&#39;s skill, $player&#39;s initial_skill))](show:?switch)] you choose is restored to its &lt;i&gt;Initial&lt;/i&gt; level.  Then he guides you back to Pikestaff Plain and points you in the direction of the [[foothills-&gt;Page 374]].

|switch)[(replace: ?stats)[LUCK, STAMINA or SKILL]]</tw-passagedata><tw-passagedata pid="345" name="Page 167" tags="" position="3225,8025" size="100,100">&#39;You will come to three doors,&#39; he says.  &#39;Be sure to take the wooden one.&#39;  Then he guides you back to Pikestaff Plain and points you in the direction of the [[foothills-&gt;Page 374]].</tw-passagedata><tw-passagedata pid="346" name="TITLE" tags="" position="1025,200" size="200,200">&lt;center&gt;
&lt;h1&gt;Masks of Mayhem&lt;/h1&gt;&lt;h2&gt;Robin Waterfield&lt;/h2&gt;
[[Read the Instructions-&gt;Instructions]]
(link-repeat:&quot;Begin&quot;)[(set: $show_intro to 1)(goto: &quot;Starting Equipment&quot;)] / (link-repeat:&quot;Skip Intro and Begin&quot;)[(set: $show_intro to 0)(goto: &quot;Starting Equipment&quot;)]
(link-repeat:&quot;Re-roll Stats&quot;)[(display: &quot;REROLL&quot;)]
Save Mode: (if: $savemode is true)[(link-repeat:&quot;On&quot;)[(set: $savemode to false)(goto:&quot;TITLE&quot;)]](else:)[(link-repeat:&quot;Off&quot;)[(set: $savemode to true)(goto:&quot;TITLE&quot;)]]
[[Version History-&gt;VERSIONS]]

&lt;h3&gt;&lt;code&gt;WORK IN PROGRESS, NOT FOR RELEASE&lt;/code&gt;&lt;/h3&gt;
&lt;/center&gt;</tw-passagedata><tw-passagedata pid="347" name="Instructions" tags="" position="1012.5,425" size="100,100"></tw-passagedata><tw-passagedata pid="348" name="VERSIONS" tags="" position="1137.5,425" size="100,100"></tw-passagedata><tw-passagedata pid="349" name="REROLL" tags="" position="875,200" size="100,100">{== ($ROLL:)
(set: $player&#39;s initial_skill to 6 + $die1)
(set: $player&#39;s initial_luck to 6 + $die2)
($ROLL:)
(set: $player&#39;s initial_stamina to 12 + $die1 + $die2)

(set: $player&#39;s skill to $player&#39;s initial_skill)
(set: $player&#39;s stamina to $player&#39;s initial_stamina)
(set: $player&#39;s luck to $player&#39;s initial_luck)
</tw-passagedata><tw-passagedata pid="350" name="Starting Equipment" tags="" position="1325,200" size="200,200">&lt;h3&gt;EQUIPMENT AND POTIONS&lt;/h3&gt;
You will start your adventure with a bare minimum of equipment, but you may find or buy other items during your travels.  You are armed with a sword and are dressed in leather armour. You have a backpack to hold your Provisions and any treasures you may come across.

In addition, you may take one bottle of a magical potion which will aid you on your quest. You may choose to take a bottle of any of the following: |menu&gt;[{&lt;ul&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Skill&quot;)[($add_item:&quot;Potion of Skill&quot;)(show:?continue)[]] - restores SKILL points&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Strength&quot;)[($add_item:&quot;Potion of Strength&quot;)(show:?continue)[]] - restores STAMINA points&lt;/li&gt;
&lt;li&gt;A (link-reveal:&quot;Potion of Fortune&quot;)[($add_item:&quot;Potion of Fortune&quot;)(show:?continue)[]] - restores LUCK points and adds 1 to Initial LUCK&lt;/li&gt;
&lt;/ul&gt;

}]These potions may be taken at any time during your adventure (except when engaged in a battle). Taking a measure of potion wìll restore SKILL, STAMINA or LUCK scores to their &lt;i&gt;Initial&lt;/i&gt; level (and the Potion of Fortune will add 1 point to your &lt;i&gt;Initial&lt;/i&gt; LUCK score before LUCK is restored).

Each bottle of potion contains enough for &lt;i&gt;one&lt;/i&gt; measure, i.e. the characteristic may be restored once during an adventure.

Remember also that you may only choose &lt;i&gt;one&lt;/i&gt; of the three potions to take on your trip, so choose wisely!

|continue)[(if: $show_intro is 1)[(goto: &quot;Intro 1&quot;)](else:)[(goto: &quot;Page 1&quot;)]]</tw-passagedata><tw-passagedata pid="351" name="Page 128" tags="" position="2825,8275" size="100,100">(set: $player&#39;s companions to 0)(set: $player&#39;s tied to false)You can see the five peaks of Krill Garnash in the distance ahead, even though you are not yet in the mountain range itself, but on the borders.  One morning, you see some extraordinarily large, sliding footprints in the snow.  Images of Yeti or Bigfeet enter your mind, but you soon know better.  You are confronted by two hill tribesmen, wearing snowshoes.  They are dressed in skins and look rather formidable, especially with their short but sturdy thrusting-spears.  If you have the Cloak of Temporary Invisibility, do you wish to (link-reveal:&quot;use it&quot;)[(show: ?cloak)]?  Or will you [[approach the tribesmen-&gt;Page 383]] peacefully, or [[attack-&gt;Page 282]]?

|cloak)[{
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        (go-to: &quot;Page 390&quot;) [[Page 390]]
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
}]
</tw-passagedata><tw-passagedata pid="352" name="Page 329" tags="death" position="2450,8150" size="100,100">&#39;Oh dear,&#39; says Vashti calmly.  &#39;That means you&#39;re stuck here with me.  Never mind: maybe another traveller will enter this domain, in another few centuries.&#39;  Until then, your adventure is over.</tw-passagedata><tw-passagedata pid="353" name="Page 88" tags="" position="2700,8150" size="100,100">&#39;Excellent!&#39; she exclaims.  &#39;We&#39;re all set, then, aren&#39;t we?  You know about the sigils, the keys of power for which Morgana lusts.  But do you know how they are portrayed?  If you place six equally-spaced marks around a circle and join them in any order, returning to the mark you began with, you will find that there are twelve possible patterns.  Now, people -- those who are types of people -- obey the laws of the sigils.  Morgana has been seizing such people, dead or alive, and turning them into her Golems.  You proably know that she&#39;s got the bard and the farmer, at any rate, and you&#39;ll now realize that the bard&#39;s brand, for instance, is a sigil.  Now look at your helmet.&#39;  You do so, and gasp with astonishment: &#39;It&#39;s one of the sigils!&#39;  &#39;Precisely,&#39; continues Vashti.  &#39;It is the one we call the ruler, which is what you are, after all; it is the one which binds together all the sigils, and confirms their power; and it is the one which Morgana is missing.&#39;

The implications of this are enormous.  &#39;But that means I&#39;m walking into a trap!&#39; you cry.  &#39;She wants me there, to turn me into a Golem too!&#39;  &#39;That is true,&#39; says Vashti, &#39;but it is also true that you are the one to prevent this evil plot.  You must continue with your mission.&#39;  You are fired with grim resolution, and immediately take your leave of Vashti.  She plants two of the seeds you have given her, and they spring up as full-blossomed apple trees.  You walk between them back into the world of time, and find yourself right by the oak trees, as if you had just stepped between them.  The sun is exactly where it was when you entered [[Vashti&#39;s realm-&gt;Page 37]].</tw-passagedata><tw-passagedata pid="354" name="Page 383" tags="" position="2825,8400" size="100,100">This may be a mistake.  The tribe to which these men belong has long been under the rule of Morgana.  They pay her tribute, because they fear her; but they would rather be free.  When you approach them with your sword still in its sheath, they seize you roughly and tie you to a tree.  They search through your pack.  Do they find a set of (link-reveal:&quot;Sabre-toothed Tiger&#39;s claws&quot;)[(show: ?claws)]?

|claws)[{
    (set: _message to &quot;No, they do not find a Tiger&#39;s claws&quot;)
    (set: _destination to &quot;Page 194&quot;)
	(if: $player&#39;s inventory contains &quot;Tiger Claws&quot;) [
    	(set: _message to &quot;Yes, they find the claws in your pack&quot;)
        (set: _destination to &quot;Page 155&quot;)
    ]
    (dialog: _message)
    (go-to: _destination)
    
    [[Page 155]] [[Page 194]]
}]</tw-passagedata><tw-passagedata pid="355" name="Page 282" tags="combat" position="3075,8525" size="100,100">You draw your sword and advance.  Their snow-shoes, while making long journeys less tiring, also make them less nimble in battle.  They will fight you simultaneously, but every time you win an Attack Round against one, he will be out of the fight for the next Attack Round, and you can simply conduct a normal attack round against the other.  When they are both attacking you at once, however, you must choose which one of them to conduct a normal attack round against, and also roll for the Attack Strength of the other: whether or not you win the Attack Round against your chosen opponent, if the other&#39;s Attack Strength is higher than yours, he wounds you, but if it is lower or equal, you have not wounded him but merely blocked his attack.

[{
(set: $tribesman_out_of_action to (dm:))
(set: $combat&#39;s loop to &quot;Tribesman Combat Loop&quot;)
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Tribesman&quot;,
		&quot;skill&quot;, 8,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
        &quot;hit&quot;, false,
	),
	(dm:
		&quot;name&quot;, &quot;Tribesman&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
        &quot;hit&quot;, false
	),
))
}](display: &quot;Combat Container&quot;) |victory)[{
(set: $combat&#39;s loop to &quot;Sequential Combat Loop&quot;)
If you win, you can take a pair of (link-reveal:&quot;snow-shoes&quot;)[($add_item: &quot;Snow-Shoes&quot;)], if you want, and [[carry on-&gt;Page 173]].}]

|combat_on_target_hit)[{
	(set: $combat&#39;s opponents&#39;s $targeted_monster&#39;s hit to true)
}]</tw-passagedata><tw-passagedata pid="356" name="Page 390" tags="" position="2700,8400" size="100,100">The look on their faces when you vanish is so comical that you almost give yourself away by laughing out loud.  But your footsteps in the snow are more of a problem.  Will you try to [[run away-&gt;Page 94]], or simply use your invisibility to [[fight them-&gt;Page 318]] with a clear advantage?</tw-passagedata><tw-passagedata pid="357" name="Page 94" tags="" position="2575,8525" size="100,100">They can see from your footprints where you are, and can guess where to aim their spears.  One of them throws a spear after you as you flee.  (link-reveal: &quot;Roll one die&quot;)[{
	(set: _roll to ($ROLL1:))
    (set: _yes to _roll &lt;= 3)
    (set: _label to (cond: _yes, &quot;I rolled 1-3&quot;, &quot;I rolled 4-6&quot;))
    (dialog: [You roll: (print: _roll)], _label)
    (if: _yes)[(go-to: &quot;Page 244&quot;) [[Page 244]] ](else:)[(go-to: &quot;Page 174&quot;) [[Page 174]] ]
}]</tw-passagedata><tw-passagedata pid="358" name="Page 318" tags="combat" position="2700,8525" size="100,100">With this advantage, you can fight them one at a time.
[{
(set: $combat&#39;s opponents to (a:
	(dm:
		&quot;name&quot;, &quot;Tribesman&quot;,
		&quot;skill&quot;, 8,
		&quot;stamina&quot;, 10,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;First&quot;,
        &quot;hit&quot;, false,
	),
	(dm:
		&quot;name&quot;, &quot;Tribesman&quot;,
		&quot;skill&quot;, 7,
		&quot;stamina&quot;, 12,
        &quot;article&quot;, &quot;the&quot;,
        &quot;prefix&quot;, &quot;Second&quot;,
        &quot;hit&quot;, false
	),
))
}](display: &quot;Combat Container&quot;) |victory)[{
($remove_item: &quot;Invisibility Cloak&quot;)
If you win, you can take a pair of (link-reveal:&quot;snow-shoes&quot;)[($add_item: &quot;Snow-Shoes&quot;)], if you want. The powers of the Cloak wear off after [[a while-&gt;Page 173]].}]
</tw-passagedata><tw-passagedata pid="359" name="Page 155" tags="" position="2825,8525" size="100,100">This find convinces them that you are a great warrior, and for the first time they speak to you, asking why you are trespassing on their land.  Will you tell them you have come to [[kill Morgana-&gt;Page 314]], or that you are [[a hunter-&gt;Page 194]]?</tw-passagedata><tw-passagedata pid="360" name="Page 194" tags="" position="2950,8525" size="100,100">(set: $player&#39;s companions to 2)(set: $player&#39;s tied to true)They talk between themselves for a while, arguing whether or not to take you as their prisoner to Morgana, to gain her favour.  They decide to do so.  You are released from the tree, your hands are tied behind your back and you are taken at spear-point north towards [[Krill Garnash-&gt;Page 173]].</tw-passagedata><tw-passagedata pid="361" name="Tribesman Combat Loop" tags="" position="3200,8525" size="100,100">{==
|before_combat&gt;[]
|combat_loop&gt;[
	[(display: &quot;List Opponents Simultaneously&quot;)]&lt;list_opponents_container|
	[(display: &quot;Simultaneous Combat Action&quot;)]&lt;combat_action_container|
	[(display: &quot;Simultaneous Combat Results&quot;)]&lt;combat_results_container|
	[(display: &quot;Tribesman Combat Next&quot;)]&lt;combat_next_container|
]
|after_combat&gt;[]</tw-passagedata><tw-passagedata pid="362" name="Tribesman Combat Next" tags="" position="3325,8525" size="100,100">|combat_next)[{
    (if: $player&#39;s stamina &lt;= 0)[
        Your wounds are fatal.  Your adventure ends here.
    ](else:)[
        (if: $tribesman_out_of_action is not an empty)[
        	(set: $combat&#39;s opponents to it + (a: $tribesman_out_of_action))
            (set: $tribesman_out_of_action to (dm:))
        ]
        (set: _update to $combat&#39;s opponents)
        (for: each _i, ...(range: 1, $combat&#39;s opponents&#39;s length))[
            (set: _m to _i of $combat&#39;s opponents)
            (set: _article to _m&#39;s article)
            (set: _prefix to _m&#39;s prefix)
            (set: _name to _m&#39;s name)
            (set: _prefixed_name to (joined: &quot; &quot;,  ...(find: _s where _s is not empty, _prefix, (uppercase: _name))))

            (if: _m&#39;s stamina &lt;= 0)[
                &lt;p&gt;(print: _prefixed_name) is defeated!&lt;/p&gt;
                (set: _update to it - (a: _m))
            ](else-if: $combat&#39;s opponents&#39;s length &gt; 1 and _m contains &quot;hit&quot; and _m&#39;s hit is true)[
                (set: $tribesman_out_of_action to _update&#39;s _i)
                (set: _update to it - (a: _m))
                (set: $tribesman_out_of_action&#39;s hit to false)
            ]
            
        ]
        (set: $combat&#39;s opponents to _update)
    ]

    (if: $combat&#39;s opponents is not an empty)[
        &lt;p&gt;(link-reveal:&quot;Combat continues... &quot;)[(rerun: ?combat_loop)]&lt;/p&gt;
    ](else:)[
        (show: ?victory)
    ]
	(rerun: ?post_combat_next)(show: ?post_combat_next)
}]</tw-passagedata><tw-passagedata pid="363" name="Page 173" tags="" position="2825,8775" size="100,100">You travel deep into the mountains.  The slopes are quite thickly covered with pine trees; occasionally, as the days pass, you hear low, ominous rumblings from the mountains on either side.  One afternoon you see a figure ahead of you, black against the white glare of the snow.  Are you alone, or do you have (link-reveal:&quot;companions&quot;)[(show:?companions)]?

|companions)[{
    (set: _label to (cond:
        $player&#39;s companions is 2, &quot;You have two companions.&quot;,
        $player&#39;s companions is 1, &quot;You have a single companion&quot;,
        &quot;You have no companions.&quot;
    ))
    (dialog: _label)
    (go-to: (cond:
        $player&#39;s companions is 2, &quot;Page 176&quot;,
        $player&#39;s companions is 1, &quot;Page 210&quot;,
        &quot;Page 287&quot;
    ))
    [[Page 176]] [[Page 210]] [[Page 287]]
}]
</tw-passagedata><tw-passagedata pid="364" name="Page 244" tags="" position="2575,8650" size="100,100">($remove_item: &quot;Invisibility Cloak&quot;)The spear misses and you make good your escape.  The effects of the Cloak wear off after [[a while-&gt;Page 173]].</tw-passagedata><tw-passagedata pid="365" name="Page 174" tags="death" position="2450,8650" size="100,100">The spear catches you right between the shoulder-blades.  Your adventure is over.</tw-passagedata><tw-passagedata pid="366" name="Page 314" tags="" position="3075,8650" size="100,100">One of them wants to take you as their prisoner to Morgana; the other wants to free you.  They argue, and harsh words soon turn to blows, and then a fight to the death.  ($test_your_luck:).
|lucky)[ (go-to: &quot;Page 271&quot;) [[Page 271]] ]
|unlucky)[ (go-to: &quot;Page 50&quot;) [[Page 50]] ]</tw-passagedata><tw-passagedata pid="367" name="Page 176" tags="" position="2700,8900" size="100,100">The tribesmen, if they have spotted the distant figure, seem unconcerned.  Perhaps their sharp eyes can tell what yours cannot -- whether the figure is moving towards you or away from you.  Your voice will carry well in the crisp, clear mountain air, and you decide to call out to the distant figure.  ($test_your_luck:).
|lucky)[ (go-to: &quot;Page 378&quot;) [[Page 378]] ]
|unlucky)[ (go-to: &quot;Page 360&quot;) [[Page 360]] ]</tw-passagedata><tw-passagedata pid="368" name="Page 210" tags="" position="2825,8900" size="100,100">The tribesman, if he has spotted the distant figure, seems unconcerned.  Perhaps his sharp eyes can tell what yours cannot -- whether the figure is moving towards you or away from you.  Your voice will carry well in the crisp, clear mountain air. You decide to call out to the distant figure.  ($test_your_luck:).
|lucky)[ (go-to: &quot;Page 275&quot;) [[Page 275]] ]
|unlucky)[ (go-to: &quot;Page 360&quot;) [[Page 360]] ]</tw-passagedata><tw-passagedata pid="369" name="Page 287" tags="" position="2950,8900" size="100,100">Your voice will carry well in the crisp, clear mountain air.  Will you [[call out-&gt;Page 143]] to the distant figure, or [[carry on-&gt;Page 341]] trudging through the snow?</tw-passagedata><tw-passagedata pid="370" name="Page 271" tags="" position="2950,8775" size="100,100">The winner is the one who approves of your mission.  He releases you and lets you [[carry on-&gt;Page 173]] with your journey.</tw-passagedata><tw-passagedata pid="371" name="Page 50" tags="" position="3200,8650" size="100,100">(set: $player&#39;s companions to 1)(set: $player&#39;s tied to true)($add_item: &quot;Snow-Shoes&quot;)The winner is the one who wanted to take you to Morgana.  He draws a dagger and holds it to your throat, while he unties you from the tree, disarms you and ties your hands behind your back.  Then he puts his dead companion&#39;s snow-shoes on you and takes you at spear-point north towards [[Krill Garnash-&gt;Page 29]].</tw-passagedata><tw-passagedata pid="372" name="Page 29" tags="" position="3075,8775" size="100,100">It is very awkward to manage the snow-shoes with your hands tied.  They require a half-walking, half-sliding motion, and it would help if you could swing your arms.  You try to persuade your captor to untie you.  ($test_your_luck:).  |lucky)[(set: $player&#39;s tied to false)If you are Lucky, he [[unties you-&gt;Page 173]] because you are slowing him down.] |unlucky)[He remains [[unconvinced-&gt;Page 173]].]</tw-passagedata><tw-passagedata pid="373" name="Page 378" tags="" position="2575,9025" size="100,100">Your companions turn to quieten you, but it is too late.  The noise starts an avalanche: distant rumbling soon becomes terrifyingly loud, and tons of snow, rocks and tree-trunks are hurtling down the mountainside towards you.  Fortunately, you are all close to the opposite slope, and you are able to run out of reach of the avalanche, though in the panic you become separated from your captors.  You fall into a snow-drift, which hides you from view. (link-reveal: &quot;Roll one die&quot;)[{
	(set: _roll to ($ROLL1:))
    (set: _yes to _roll &lt;= 3)
    (set: _label to (cond: _yes, &quot;I rolled 1-3&quot;, &quot;I rolled 4-6&quot;))
    (dialog: [You roll: (print: _roll)], _label)
    (if: _yes)[(go-to: &quot;Page 146&quot;) [[Page 146]] ](else:)[(go-to: &quot;Page 233&quot;) [[Page 233]] ]
}]</tw-passagedata><tw-passagedata pid="374" name="Page 360" tags="death" position="2700,9025" size="100,100">Your shouts have no effect on the distant figure -- but dramatic effects otherwise.  The noise starts an avalanche, and you are soon crushed under tons of snow, rocks and tree-trunks.</tw-passagedata><tw-passagedata pid="375" name="Page 275" tags="" position="2825,9025" size="100,100">Your companion turns to quieten you, but it is too late.  The noise starts an avalanche: distant rumbling soon becomes terrifyingly loud, and tons of snow, rocks and tree-trunks are hurtling down the mountainside towards you.  You both run frantically for the opposite slope, to try to gain height. (link-reveal: &quot;Are your hands tied&quot;)[(show:?tied)]?

|tied)[{
    (set: _yes to $player contains &quot;tied&quot; and $player&#39;s tied is true)
    (set: _label to (cond: _yes, &quot;Yes, your hands are tied&quot;, &quot;No, your hands are not tied&quot;))
    (dialog: (str: _label))
    (if: _yes)[(go-to: &quot;Page 317&quot;) [[Page 317]] ](else:)[(go-to: &quot;Page 246&quot;) [[Page 246]] ]

}]</tw-passagedata><tw-passagedata pid="376" name="Page 143" tags="" position="2950,9025" size="100,100">You cannot tell at this distance whether or not the figure is moving towards you, or whether your shouts have been heard.  Will you [[call out-&gt;Page 360]] again, or give up and [[carry on-&gt;Page 341]]?</tw-passagedata><tw-passagedata pid="377" name="Page 341" tags="" position="3075,9025" size="100,100">The figure shortly disappears from sight, and you see no living creature, human or otherwise, for two days -- though at night the howling of wolves is often too close for comfort.  The peaks of Krill Garnash are now so close that they seem to hang over you, like some vast primeval monster.  There are two passes.  Will you take the one which heads [[towards the west-&gt;Page 284]] of Krill Garnash, or the one which heads [[towards the east-&gt;Page 142]]?</tw-passagedata><tw-passagedata pid="378" name="Page 146" tags="death" position="2450,9150" size="100,100">Your captors soon find you.  They have obviously decided that you are more trouble than you&#39;re worth, because they waste no time in dispatching you with their spears.  Your adventure is over.</tw-passagedata><tw-passagedata pid="379" name="Page 233" tags="" position="2575,9150" size="100,100">From your hiding-place you can hear your captors searching for you, but they fail to find you.  Meanwhile, you rub the rope which binds your hands against the sharp edge of a rock in the gully in which you have landed.  Eventually it breaks.  When you judge that the coast is clear, you emerge from the gully.  Reduce your STAMINA by 3 for lying so long in the [[freezing snow-&gt;Page 250]]. ($STAMINA: -3)</tw-passagedata><tw-passagedata pid="380" name="Page 317" tags="death" position="2825,9150" size="100,100">You fail to gain enough height.  Scavenging Snow Wolves find your corpse later that night.</tw-passagedata><tw-passagedata pid="381" name="Page 246" tags="" position="2700,9150" size="100,100">You just make it (at a cost of 2 STAMINA points of exertion) but your companion is not so lucky.($STAMINA: -2)  You find his body crushed under a boulder.  You recover your weapons and continue north towards [[Krill Garnash-&gt;Page 250]].</tw-passagedata><tw-passagedata pid="382" name="Page 284" tags="" position="2925,9275" size="100,100">The western pass is narrow and choked with snow.  If you are not wearing snow-shoes, you may decide to retrace your steps and try the [[eastern pass-&gt;Page 142]], or remain in the [[western pass-&gt;Page 123]]</tw-passagedata><tw-passagedata pid="383" name="Page 142" tags="combat" position="3050,9275" size="100,100">As you are walking through the pass,  you see a large snowball rolling down the eastern slope, and getting larger all the time.  The snowball comes to a halt at the foot of the mountain, in front of you.  Then, to your surprise, the snowball disintegrates, and out steps an Ice Hulk.  These moronic creatures are mutant Yetis (the mutation consisting mainly in the disappearance of the Yeti&#39;s already tiny brain).  This one probably tripped over its own feet and tumbled down the mountainside!  It stares at you uncertainly for a few moments, and then obviously decides that you are edible.  You will have to defend yourself, unless you have the (link-reveal:&quot;Cloak of Temporary Invisibility&quot;)[(show:?cloak)], in which case you can avoid this encounter, if you want to (but the Cloak&#39;s powers only work once).  Since the Ice Hulk is not evil, just stupid, the Horn of Hever has no power over it.
[{
    (if: $combat&#39;s opponents is an empty)[
        (set: $combat&#39;s opponents to (a:
            (dm:
                &quot;name&quot;, &quot;Ice Hulk&quot;,
                &quot;skill&quot;, 6,
                &quot;stamina&quot;, 12,
                &quot;article&quot;, &quot;the&quot;,
                &quot;prefix&quot;, &quot;&quot;,
                &quot;alignment&quot;, &quot;neutral&quot;,
                &quot;hit&quot;, 0,
            ),
        ))
    ]
}](display: &quot;Combat Container&quot;) |victory)[{
    If you win, you [[continue onwards-&gt;Page 267]].
}]|combat_on_target_hit)[{
    (set: $target&#39;s hit to it + 1)
}]
|post_combat_next)[{
	(if: $combat&#39;s opponents is not an empty) [
        (if: $combat&#39;s opponents&#39;s 1st&#39;s hit is 1) [
            (set: $combat&#39;s opponents&#39;s 1st&#39;s hit to it + 1)
            (hide: ?combat_next)
        
            &lt;p&gt;The first time you win an Attack Round, [[click here-&gt;Page 392]].&lt;/p&gt;
        ]
    ]
}]

|cloak)[{
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        (go-to: &quot;Page 267&quot;)
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
}]
</tw-passagedata><tw-passagedata pid="384" name="Page 250" tags="" position="2700,9275" size="100,100">When you restart your journey towards Krill Garnash, there is no sign of the distant figure who, without knowing it, secured your freedom.  Within two days the peaks of Krill Garnash, half hidden in lowering grey cloud, are so close that they seem to hang over you like some vast primeval monster.  There are two passes.  Will you take the one which heads [[towards the west-&gt;Page 284]] of Krill Garnash, or the one which heads [[towards the east-&gt;Page 142]]?</tw-passagedata><tw-passagedata pid="385" name="Page 123" tags="" position="2925,9400" size="100,100">When you are three quarters of the way through the pass, the snow all around you starts to move round and round, like a semi-solid whirlpool.  You have obviously disturbed the rest of a Chion, deep beneath the snow, and it is now spiralling its way towards the surface.  This is how these gigantic, worm-like creatures trap their prey.  The snow collapses into the gap they make when they leave their resting-place, and the terrified victim falls into the gaping hole.  Are you wearing (link-reveal:&quot;snow-shoes or the Boots of Agility&quot;)[(show:?check)]?
|check)[{
	(if: $player&#39;s inventory contains any of (a: &quot;Snow-Shoes&quot;, &quot;Boots of Agility&quot;)) [
        (dialog: &quot;Yes, you are wearing suitable footwear.&quot;)
        (go-to: &quot;Page 198&quot;) [[Page 198]]
    ]
    (dialog: &quot;No, you are not wearing these items.&quot;)
    (go-to: &quot;Page 363&quot;) [[Page 363]]
    
}]</tw-passagedata><tw-passagedata pid="386" name="Page 392" tags="" position="3175,9150" size="100,100">Since the Ice Hulk has no brain to speak of, it takes quite a time for the creature to register the pain of the wound you have inflicted on it.  You withdraw your sword from its side, expecting at least to slow the beast down, and are therefore unprepared for it to continue coming at you, swinging its paws like great claw-tipped mallets.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 182&quot;) [[Page 182]] ]
|unlucky)[(go-to: &quot;Page 60&quot;) [[Page 60]] ]</tw-passagedata><tw-passagedata pid="387" name="Page 182" tags="" position="3300,9150" size="100,100">Fortunately, snow falling from a nearby tree distracts the creature at the last moment.  Its claws merely graze you for the loss of 1 STAMINA point.($STAMINA: -1)  Return and [[continue the fight-&gt;Page 142]].</tw-passagedata><tw-passagedata pid="388" name="Page 60" tags="" position="3300,9275" size="100,100">The creature&#39;s paw slams into your arm.  Lose 1 SKILL and 2 STAMINA points, then return and [[continue the fight-&gt;Page 142]].($SKILL: -1)($STAMINA: -2)</tw-passagedata><tw-passagedata pid="389" name="Page 267" tags="" position="3050,9525" size="100,100">The pass you have taken veers until it joins the other one; Morgana allows only one way to and from her stronghold.  As you begin to climb the slopes of Krill Garnash itself, you feel certain that the way is defended.  You&#39;re not wrong.  An Ice Dragon thunders out of its cave and swoops down on you, blasting ice from its nostrils.  If you have a (link-reveal:&quot;Cloak of Temporary Invisibility&quot;)[(show: ?cloak)], you may wish to use it.  Otherwise, you must [[face the beast-&gt;Page 241]] without.

|cloak)[{
    (if: $player&#39;s inventory contains &quot;Invisibility Cloak&quot;)[
        (go-to: &quot;Page 46&quot;) [[Page 46]]
    ]
    (dialog: &quot;You do not have the Cloak of Temporary Invisibility.&quot;)
}]
</tw-passagedata><tw-passagedata pid="390" name="Page 198" tags="combat" position="2925,9525" size="100,100">You make it to the outside of the snowy whirlpool, just as the Chion&#39;s head, with jaws apart and showing two rows of needle-like teeth, bursts through the snow.  It spots uot immediately, and squirms into the attack.  You have no time to get anything from your pack.  [{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;Chion&quot;,
            &quot;skill&quot;, 7,
            &quot;stamina&quot;, 13,
            &quot;article&quot;, &quot;the&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
}](display: &quot;Combat Container&quot;) |victory)[{
    If you win, you [[continue onwards-&gt;Page 267]].
}]</tw-passagedata><tw-passagedata pid="391" name="Page 363" tags="death" position="2800,9525" size="100,100">You fall into the Chion&#39;s trap, and it is impossible to climb up the sides of crumbling snow.  The Chion makes short work of swallowing you.  Your adventure is over.</tw-passagedata><tw-passagedata pid="392" name="Page 241" tags="combat" position="3050,9650" size="100,100">You face a truly formidable foe.  [{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;Ice Dragon&quot;,
            &quot;skill&quot;, 10,
            &quot;stamina&quot;, 14,
            &quot;article&quot;, &quot;the&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
}](display: &quot;Combat Container&quot;) |victory)[{
    If you win, will you [[search its cave-&gt;Page 204]], or push straight on for [[Krill Garnash-&gt;Page 298]].
}]</tw-passagedata><tw-passagedata pid="393" name="Page 46" tags="combat" position="3175,9650" size="100,100">You quickly don the Cloak.  It will not keep you invisible long enough to escape from the Dragon altogether, so you simply use it to attack the Dragon more effectively.  However, after you have wounded it twice, for 4 STAMINA points of injury, your body warms up as a result of your efforts; this makes mist form around you in the cold air, and the Dragon will be able to see where you are from now on.  Still, you now fight it with more chance of success.[{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;Ice Dragon&quot;,
            &quot;skill&quot;, 10,
            &quot;stamina&quot;, 14,
            &quot;article&quot;, &quot;the&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
}](display: &quot;Combat Container&quot;) |victory)[{
    By the time you win (if you do), the Cloak will have lost its powers.  ($remove_item: &quot;Invisibility Cloak&quot;)Will you [[search the Dragon&#39;s cave-&gt;Page 204]], or push straight on for [[Krill Garnash-&gt;Page 298]].
}]</tw-passagedata><tw-passagedata pid="394" name="Page 204" tags="" position="3050,9775" size="100,100">When you reach the Dragon&#39;s cave, you find that it does not extend very far.  After all, what need does an Ice Dragon have for protection against cold?  At the back, it narrows into a slit.  You go through the slit and find yourself on a ledge, which runs along the mountainside.  The ledge is wide enough for you to pass safely along it, until it ends at the mouth to a [[tunnel-&gt;Page 256]].</tw-passagedata><tw-passagedata pid="395" name="Page 298" tags="" position="3175,9775" size="100,100">Some of Morgana&#39;s defences are formed by the mountain itself.  The direct way you are following to Krill Garnash leads to a long glacier, which is steep enough to make walking -- or rather, crawling -- up it very hazardous.  Do you have a (link-reveal:&quot;pick-axe head&quot;)[(show:?check)]?

|check)[{
    (if: $player&#39;s inventory contains &quot;Pick-Axe Head&quot;)[
	    (dialog: &quot;Yes, you have a pick-axe head.&quot;)
        (go-to: &quot;Page 395&quot;) [[Page 395]]
    ]
    (dialog: &quot;No, you do not have a pick-axe head.&quot;)
    (go-to: &quot;Page 96&quot;) [[Page 96]]
}]</tw-passagedata><tw-passagedata pid="396" name="Page 256" tags="" position="3050,10025" size="100,100">This must be the entrance to Morgana&#39;s domain.  Guttering torches line the walls, which stretch away in a straight line into the gloom ahead.  You summon up all your courage and step into the tunnel.  The torches do little to dispel the freezing cold and even though you can see your way, you cannot shake off a sense of blackness.  For here Morgana rules, and her heart is cold and black.  The tunnel ends with a choice of three doors, next to one another on the northern wall of a small cavern.  Will you take the [[wooden door-&gt;Page 32]] in the middle, the [[stone door-&gt;Page 119]] or the [[iron door-&gt;Page 290]]?</tw-passagedata><tw-passagedata pid="397" name="Page 96" tags="" position="3300,9900" size="100,100">When you are some way up the glacier, you slip and slide out of control back down the slope.  ($test_your_luck:).
|lucky)[(go-to: &quot;Page 339&quot;) [[Page 339]] ]
|unlucky)[(go-to: &quot;Page 35&quot;) [[Page 35]] ]</tw-passagedata><tw-passagedata pid="398" name="Page 395" tags="" position="3175,9900" size="100,100">You can use this to get a better grip on the ice.  You make it safely to the end of the glacier, and climb up to the entrance of a [[tunnel-&gt;Page 256]].</tw-passagedata><tw-passagedata pid="399" name="Page 119" tags="death" position="3175,10150" size="100,100">The door swings open onto your destruction.  It is so swift that you cannot even identify its source, but your adventure is over.</tw-passagedata><tw-passagedata pid="400" name="Page 290" tags="" position="3300,10150" size="100,100">As soon as you touch the door, long spikes spring out of it and the door slams open towards you.  (link-reveal:&quot;Roll one die&quot;)[(show:?1)].  |1)[{
    (set: _roll to ($ROLL1:))
    (dialog: (str: &quot;You roll &quot;, _roll, &quot;.&quot;))

    (if: _roll &lt;= 4)[
        On 1-4, [[click here-&gt;Page 65]].
    ](else:)[
        On 5-6, [[click here-&gt;Page 366]].
    ]

}]

</tw-passagedata><tw-passagedata pid="401" name="Page 339" tags="" position="3175,10025" size="100,100">You manage to get enough of a grip on the ice to slow your rate of descent.  Lose 2 STAMINA points.($STAMINA: -2)  You decide to explore the [[Dragon&#39;s cave-&gt;Page 204]] instead of attempting the glacier again.</tw-passagedata><tw-passagedata pid="402" name="Page 35" tags="" position="3300,10025" size="100,100">The fall hurts you badly.  (link-reveal:&quot;Roll one die&quot;)[(show:?1)] and add 1: you lose this many STAMINA points.  |1)[{
    (set: _roll to ($ROLL1:))
    (dialog: (str: &quot;You roll &quot;, _roll, &quot; and lose &quot;, _roll + 1, &quot; STAMINA.&quot;))
    (set: _roll to it + 1)
    ($STAMINA: -_roll)
}If you are still alive, you decide to explore the [[Dragon&#39;s cave-&gt;Page 204]] instead of attempting the glacier again.]

</tw-passagedata><tw-passagedata pid="403" name="Page 65" tags="death" position="3425,10150" size="100,100">You are impaled between the spiked door and the wall of the cavern.  Your adventure is over.</tw-passagedata><tw-passagedata pid="404" name="Page 366" tags="" position="3300,10275" size="100,100">You leap back in time to avoid the door.  Will you [[go through it-&gt;Page 131]] into a dark tunnel, or try the [[stone door-&gt;Page 119]] or the [[wooden door-&gt;Page 32]]?</tw-passagedata><tw-passagedata pid="405" name="Page 335" tags="combat" position="2800,10400" size="100,100">Skeletal arms, some with rotten flesh still hanging from them, emerge from the walls; bony fingers reach for the horn, which you still have hanging around your neck, while others try to trip you up.  You will have to hack your way through this horrible gauntlet.  [{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;Hands&quot;,
            &quot;skill&quot;, 7,
            &quot;stamina&quot;, 8,
            &quot;article&quot;, &quot;the&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
}](display: &quot;Combat Container&quot;) |victory)[{
    If you win, you continue along the [[corridor-&gt;Page 72]].
}]</tw-passagedata><tw-passagedata pid="406" name="Page 72" tags="" position="2925,10400" size="100,100">A side-passage opens up to your right.  Will you [[take it-&gt;Page 369]] or carry [[straight on-&gt;Page 170]]?</tw-passagedata><tw-passagedata pid="407" name="Page 49" tags="" position="3050,10400" size="100,100">You can tell by a slight draught when you pass a a side-passage on your left.  Will you [[take the side-passage-&gt;Page 306]] or [[carry on-&gt;Page 16]]?</tw-passagedata><tw-passagedata pid="408" name="Page 131" tags="" position="3300,10400" size="100,100">Is your STAMINA score 10 or less?  (if: $player&#39;s stamina &lt;= 10)[If so, [[continue here-&gt;Page 153]].](else:)[If it is 11 or more, [[continue here-&gt;Page 354]].]</tw-passagedata><tw-passagedata pid="409" name="Page 369" tags="" position="2800,10525" size="100,100">The passage is not long, and ends at a T-junction.  You know that turning right would take you away from your goal, so you [[turn left-&gt;Page 16]].</tw-passagedata><tw-passagedata pid="410" name="Page 170" tags="death" position="2925,10525" size="100,100">You have faced death in many forms to get this far, but Morgana&#39;s defences are a cut above the rest.  Iron grilles slam down in front of and behind you, and seven deadly serpents slither out of cracks in the walls.  Your adventure is over.</tw-passagedata><tw-passagedata pid="411" name="Page 306" tags="" position="3050,10525" size="100,100">The passage is not long and ends at a T-junction.  You know that turning left would take you away from your goal, so you [[turn right-&gt;Page 170]].</tw-passagedata><tw-passagedata pid="412" name="Page 16" tags="" position="3175,10525" size="100,100">You come to a large cavern, which is not lit by torches.  Will you [[enter the cavern-&gt;Page 59]], or [[turn back-&gt;Page 306]] and take the side passage?</tw-passagedata><tw-passagedata pid="413" name="Page 153" tags="death" position="3425,10400" size="100,100">In your weakened state, you cannot think clearly, and just plunge into the darkness.  As a result, you cannot see that the floor and walls are lined with jagged rocks tipped with poison.  You do not fail to step on one.  Your adventure is over.</tw-passagedata><tw-passagedata pid="414" name="Page 354" tags="" position="3175,10275" size="100,100">You are still able to think clearly, so you seize a torch from a wall-bracket to light your way.  This is just as well, because you soon see that the floor and walls are lined with jagged rocks.  The litter of animal skeletons shows that they are poisoned.  There is no way through here.  Will you try the [[stone door-&gt;Page 119]] or the [[wooden door-&gt;Page 32]]?</tw-passagedata><tw-passagedata pid="415" name="Page 59" tags="" position="3175,10650" size="100,100">Eleven vast shapes loom out of the darkness.  One of them lights a torch, and then you can see that the eleven Golems are surrounding you.  There is no time to get anything from your pack.  If you can call on (link-reveal:&quot;Galrin&quot;)[(show: ?galrin)], you will know where to turn; otherwise, your body is mangled and your adventure is over.

|galrin)[{
    (set: _yes to $player contains &quot;galrin&quot;)
    (dialog: (cond: _yes, &quot;You call upon Galrin for aid&quot;, &quot;You have not encountered Galrin on your adventure.&quot;))
    (if: _yes)[
        (go-to: &quot;Page 100&quot;) [[Page 100]]
    ]
}]</tw-passagedata><tw-passagedata pid="416" name="Page 100" tags="" position="3175,10775" size="100,100">The spectral army appears and you stand back to let them do their work.  It does not take long.  Galrin salutes you, and then he and his followers vanish for ever.  You are free to continue -- and it soon turns out that the Golems&#39; cavern was the ante-chamber to Morgana&#39;s throne-room.  You enter a vast cavern.  Morgana herself is seated on a black throne in the centre.  She shrieks at you: &#39;So you think you have destroyed my pets, do you?  You fool!  I can always make more!&#39;  You [[leap towards her throne-&gt;Page 295]], to stop her foul mouth for ever.</tw-passagedata><tw-passagedata pid="417" name="Page 295" tags="combat" position="3175,10900" size="100,100">Now you confront Morgana herself.  She is so confident of victory that she allows herself to gloat over you.  &#39;By all the dark forces,&#39; she cries, &#39;this is perfect!  I&#39;ve got you just where we wanted.&#39;  Then she leaps of her throne and at you.  Her body is frail, but her magical powers more than compensate for lack of strength.  You will be able to inflict only 1 STAMINA point of injury every time you wound her (or 2 if you use LUCK successfully).  The Cloak of Temporary Invisibility (if you have it) will not protect you in the slightest from anyone with magic powers. [{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;Morgana&quot;,
            &quot;skill&quot;, 11,
            &quot;stamina&quot;, 6,
            &quot;article&quot;, &quot;&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
    (set: $player&#39;s damage to 1)
}](display: &quot;Combat Container&quot;) |victory)[{
    (set: $player&#39;s damage to 2)
    If you win, did Morgana (link-reveal:&quot;curse you&quot;)[(show:?curse)] on Pikestaff Plain?
}]
|curse)[{
	(set: _yes to $player contains &quot;cursed&quot;)
    (dialog: (cond: _yes, &quot;Yes, Morgana cursed you on the plains&quot;, &quot;No, Morgana did not lay a curse on you.&quot;))
    (if: _yes)[
        (go-to: &quot;Page 4&quot;) [[Page 4]]
    ]
    (go-to: &quot;Page 81&quot;) [[Page 81]]
}]</tw-passagedata><tw-passagedata pid="418" name="Page 81" tags="" position="3175,11025" size="100,100">Did you talk to (link-reveal:&quot;Vashti&quot;)[(show:?vashti)]?
|vashti)[{
	(set: _yes to (history:) contains &quot;Page 22&quot;)
    (dialog: (cond: _yes, &quot;Yes, you entered Vashti&#39;s realm&quot;, &quot;No, you did not meet with Vashti on your journey.&quot;))
    (if: _yes)[
        (go-to: &quot;Page 258&quot;) [[Page 258]]
    ]
    (go-to: &quot;Page 347&quot;) [[Page 347]]
}]</tw-passagedata><tw-passagedata pid="419" name="Page 4" tags="" position="3050,11025" size="100,100">Did you talk to (link-reveal:&quot;Vashti&quot;)[(show:?vashti)]?
|vashti)[{
	(set: _yes to (history:) contains &quot;Page 22&quot;)
    (dialog: (cond: _yes, &quot;Yes, you entered Vashti&#39;s realm&quot;, &quot;No, you did not meet with Vashti on your journey.&quot;))
    (if: _yes)[
        (go-to: &quot;Page 258&quot;) [[Page 258]]
    ]
    (go-to: &quot;Page 136&quot;) [[Page 136]]
}]</tw-passagedata><tw-passagedata pid="420" name="Page 258" tags="" position="3050,11150" size="100,100">(set: _input to &quot;&quot;)Everything begins to fall into place -- the realization that your mission was a trap; Morgana describing the plan as if it were not just hers alone; Kevin treacherously slain.  You have been puzzling over all this for some time.  If your suspicions have fallen on a particular person, you should be able to work out which number to enter here.  Otherwise, [[continue here-&gt;Page 347]].

|button&gt;[&lt;center&gt;(input: bind _input, &#39;=X=&#39;)(link-repeat: &quot;Check&quot;)[(rerun: ?check)(show: ?check)]&lt;/center&gt;]

|check)[
    (if: _input is an empty or any of _input is not a digit)[
        (dialog:&quot;Please enter a number&quot;)
        (rerun: ?button)
    ]
]
|check)[
    (if: _input is not an empty and all of _input is a digit)[
        (set: _input to (num: _input))
        (if: _input is 40) [
            (go-to: &quot;Page 40&quot;) [[Page 40]]
        ](else-if: _input is 49)[
            (dialog: &quot;Yes, that&#39;s close enough...&quot;)
            (go-to: &quot;Page 40&quot;)
        ]
        (dialog: [That is not the right number.  Try again, or meet your [[destiny-&gt;Page 347]].])
    ]
]
</tw-passagedata><tw-passagedata pid="421" name="Page 136" tags="death" position="2925,11150" size="100,100">When you met Morgana before, she said &#39;our little plan.&#39;  You have been puzzling about this ever since, and just now she said &#39;I&#39;ve got you where &lt;i&gt;we&lt;/i&gt; wanted.&#39;  While you are pondering this mystery, an unseen enemy stabs you in the back.  Your adventure is over!</tw-passagedata><tw-passagedata pid="422" name="Page 347" tags="death" position="3175,11150" size="100,100">No sooner has Morgana slumped to the ground than an unseen enemy stabs you in the back.  You die, with a puzzled expression frozen on your face.  Your adventure is over.</tw-passagedata><tw-passagedata pid="423" name="Page 40" tags="combat" position="3050,11275" size="100,100">As soon as the sorceress has slumped to the ground, you whirl around -- and find just who you expected, with his dagger raised to strike you in the back.  He curses you for your cleverness, and lunges at you.

[{
    (set: $combat&#39;s opponents to (a:
        (dm:
            &quot;name&quot;, &quot;The Traitor&quot;,
            &quot;skill&quot;, 8,
            &quot;stamina&quot;, 10,
            &quot;article&quot;, &quot;&quot;,
            &quot;prefix&quot;, &quot;&quot;,
        ),
    ))
}](display: &quot;Combat Container&quot;) |victory)[{
    If you win, [[turn to &lt;b&gt;400&lt;/b&gt;-&gt;Page 400]]
}]</tw-passagedata><tw-passagedata pid="424" name="Page 400" tags="" position="3000,11400" size="200,200">Victory is yours!  The Masks of Mayhem will not be released upon the land -- at any rate, not in your ($dotdotdot:&quot;lifetime&quot;)</tw-passagedata></tw-storydata>
<script title="Twine engine code" data-main="harlowe">(function(){"use strict";
var require,define;!function(){var e={},r={};require=function(i){var n=e[i];return n&&(r[i]=n[1].apply(void 0,n[0].map(require)),e[i]=void 0),r[i]},(define=function(r,i,n){if("function"==typeof r)return r();e[r]=[i,n]}).amd=!0}();/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.3/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.join);var A=Function.call.bind(Array.prototype.shift);var _=Math.max;var R=Math.min;var k=Math.floor;var L=Math.abs;var F=Math.exp;var D=Math.log;var z=Math.sqrt;var q=Function.call.bind(Object.prototype.hasOwnProperty);var W;var G=function(){};var H=S.Map;var V=H&&H.prototype["delete"];var B=H&&H.prototype.get;var U=H&&H.prototype.has;var $=H&&H.prototype.set;var J=S.Symbol||{};var X=J.species||"@@species";var K=Number.isNaN||function isNaN(e){return e!==e};var Z=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Y=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(K(t)){return t}return t<0?-1:1};var Q=function log1p(e){var t=Number(e);if(t<-1||K(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(D(1+t)/(1+t-1))};var ee=function isArguments(e){return g(e)==="[object Arguments]"};var te=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var re=ee(arguments)?ee:te;var ne={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var oe=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var ie=typeof J==="function"&&typeof J["for"]==="function"&&ne.symbol(J());var ae=ne.symbol(J.iterator)?J.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ae="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ue=S.Reflect;var fe=String;var se=typeof document==="undefined"||!document?null:document.all;var ce=se==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==se};var le={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!le.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(ce(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===se},ToObject:function(e,t){return Object(le.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return le.IsCallable(e)},ToInt32:function(e){return le.ToNumber(e)>>0},ToUint32:function(e){return le.ToNumber(e)>>>0},ToNumber:function(e){if(ie&&g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=le.ToNumber(e);if(K(t)){return 0}if(t===0||!Z(t)){return t}return(t>0?1:-1)*k(L(t))},ToLength:function(e){var t=le.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return K(e)&&K(t)},SameValueZero:function(e,t){return e===t||K(e)&&K(t)},GetIterator:function(e){if(re(e)){return new W(e,"value")}var t=le.GetMethod(e,ae);if(!le.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=le.Call(t,e);if(!le.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=le.ToObject(e)[t];if(ce(r)){return void 0}if(!le.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=le.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=le.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!le.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!le.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=le.IteratorNext(e);var r=le.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ue.construct){return ue.construct(e,t,o)}var i=o.prototype;if(!le.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=le.Call(e,a,t);return le.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!le.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[X];if(ce(n)){return t}if(!le.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=le.ToString(e);var i="<"+t;if(r!==""){var a=le.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!le.TypeIsObject(e)){return false}var t=e[J.match];if(typeof t!=="undefined"){return!!t}return ne.regex(e)},ToString:function ToString(e){if(ie&&g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return fe(e)}};if(s&&ie){var pe=function defineWellKnownSymbol(e){if(ne.symbol(J[e])){return J[e]}var t=J["for"]("Symbol."+e);Object.defineProperty(J,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!ne.symbol(J.search)){var ve=pe("search");var ye=String.prototype.search;h(RegExp.prototype,ve,function search(e){return le.Call(ye,e,[this])});var he=function search(e){var t=le.RequireObjectCoercible(this);if(!ce(e)){var r=le.GetMethod(e,ve);if(typeof r!=="undefined"){return le.Call(r,e,[t])}}return le.Call(ye,t,[le.ToString(e)])};oe(String.prototype,"search",he)}if(!ne.symbol(J.replace)){var be=pe("replace");var ge=String.prototype.replace;h(RegExp.prototype,be,function replace(e,t){return le.Call(ge,e,[this,t])});var de=function replace(e,t){var r=le.RequireObjectCoercible(this);if(!ce(e)){var n=le.GetMethod(e,be);if(typeof n!=="undefined"){return le.Call(n,e,[r,t])}}return le.Call(ge,r,[le.ToString(e),t])};oe(String.prototype,"replace",de)}if(!ne.symbol(J.split)){var me=pe("split");var Oe=String.prototype.split;h(RegExp.prototype,me,function split(e,t){return le.Call(Oe,e,[this,t])});var we=function split(e,t){var r=le.RequireObjectCoercible(this);if(!ce(e)){var n=le.GetMethod(e,me);if(typeof n!=="undefined"){return le.Call(n,e,[r,t])}}return le.Call(Oe,r,[le.ToString(e),t])};oe(String.prototype,"split",we)}var je=ne.symbol(J.match);var Se=je&&function(){var e={};e[J.match]=function(){return 42};return"a".match(e)!==42}();if(!je||Se){var Te=pe("match");var Ie=String.prototype.match;h(RegExp.prototype,Te,function match(e){return le.Call(Ie,e,[this])});var Ee=function match(e){var t=le.RequireObjectCoercible(this);if(!ce(e)){var r=le.GetMethod(e,Te);if(typeof r!=="undefined"){return le.Call(r,e,[t])}}return le.Call(Ie,t,[le.ToString(e)])};oe(String.prototype,"match",Ee)}}var Pe=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in G||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in G||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Ce=function(){return this};var Me=function(e){if(s&&!q(e,X)){m.getter(e,X,Ce)}};var xe=function(e,t){var r=t||function iterator(){return this};h(e,ae,r);if(!e[ae]&&ne.symbol(ae)){e[ae]=r}};var Ne=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ae=function createDataPropertyOrThrow(e,t,r){Ne(e,t,r);if(!le.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var _e=function(e,t,r,n){if(!le.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!le.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(q(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;oe(String,"fromCodePoint",function fromCodePoint(e){return le.Call(Re,this,arguments)})}var ke={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!le.SameValue(r,le.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return N(t,"")},raw:function raw(e){var t=arguments.length-1;var r=le.ToObject(e,"bad template");var raw=le.ToObject(r.raw,"bad raw value");var n=raw.length;var o=le.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=le.ToString(a);s=le.ToString(raw[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=le.ToString(f);M(i,c);a+=1}return N(i,"")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){oe(String,"raw",ke.raw)}b(String,ke);var Le=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Fe=Infinity;var De={repeat:function repeat(e){var t=le.ToString(le.RequireObjectCoercible(this));var r=le.ToInteger(e);if(r<0||r>=Fe){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return Le(t,r)},startsWith:function startsWith(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=le.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=_(le.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=le.ToString(le.RequireObjectCoercible(this));if(le.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=le.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:le.ToInteger(o);var a=R(_(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(le.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=le.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=le.ToString(le.RequireObjectCoercible(this));var r=le.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){oe(String.prototype,"includes",De.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var ze=i(function(){return"/a/".startsWith(/a/)});var qe=a(function(){return"abc".startsWith("a",Infinity)===false});if(!ze||!qe){oe(String.prototype,"startsWith",De.startsWith);oe(String.prototype,"endsWith",De.endsWith)}}if(ie){var We=a(function(){var e=/a/;e[J.match]=false;return"/a/".startsWith(e)});if(!We){oe(String.prototype,"startsWith",De.startsWith)}var Ge=a(function(){var e=/a/;e[J.match]=false;return"/a/".endsWith(e)});if(!Ge){oe(String.prototype,"endsWith",De.endsWith)}var He=a(function(){var e=/a/;e[J.match]=false;return"/a/".includes(e)});if(!He){oe(String.prototype,"includes",De.includes)}}b(String.prototype,De);var Ve=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Be=new RegExp("(^["+Ve+"]+)|(["+Ve+"]+$)","g");var Ue=function trim(){return le.ToString(le.RequireObjectCoercible(this)).replace(Be,"")};var $e=["\x85","\u200b","\ufffe"].join("");var Je=new RegExp("["+$e+"]","g");var Xe=/^[-+]0x[0-9a-f]+$/i;var Ke=$e.trim().length!==$e.length;h(String.prototype,"trim",Ue,Ke);var Ze=function(e){return{value:e,done:arguments.length===0}};var Ye=function(e){le.RequireObjectCoercible(e);h(this,"_s",le.ToString(e));h(this,"_i",0)};Ye.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ze()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ze(e.substr(t,o))};xe(Ye.prototype);xe(String.prototype,function(){return new Ye(this)});var Qe={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!le.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(re(e)||le.GetMethod(e,ae))!=="undefined";var u,f,s;if(a){f=le.IsConstructor(r)?Object(new r):[];var c=le.GetIterator(e);var l,p;s=0;while(true){l=le.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){le.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=le.ToObject(e);u=le.ToLength(y.length);f=le.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ae(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!le.IsCallable(t)?new Array(e):le.Construct(t,[e]);for(var o=0;o<e;++o){Ae(n,o,arguments[o])}n.length=e;return n}};b(Array,Qe);Me(Array);W=function(e,t){h(this,"i",0);h(this,"array",e);h(this,"kind",t)};b(W.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof W)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=le.ToLength(t.length);if(e<r){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ze(o)}}this.array=void 0;return Ze()}});xe(W.prototype);var et=Array.of===Qe.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!et){oe(Array,"of",Qe.of)}var tt={copyWithin:function copyWithin(e,t){var r=le.ToObject(this);var n=le.ToLength(r.length);var o=le.ToInteger(e);var i=le.ToInteger(t);var a=o<0?_(n+o,0):R(o,n);var u=i<0?_(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:le.ToInteger(f);var c=s<0?_(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=le.ToObject(this);var o=le.ToLength(n.length);t=le.ToInteger(typeof t==="undefined"?0:t);r=le.ToInteger(typeof r==="undefined"?o:r);var i=t<0?_(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=le.ToObject(this);var n=le.ToLength(r.length);if(!le.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=le.ToObject(this);var n=le.ToLength(r.length);if(!le.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new W(this,"key")},values:function values(){return new W(this,"value")},entries:function entries(){return new W(this,"entry")}};if(Array.prototype.keys&&!le.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!le.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ae]){b(Array.prototype,{values:Array.prototype[ae]});if(ne.symbol(J.unscopables)){Array.prototype[J.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var rt=Array.prototype.values;oe(Array.prototype,"values",function values(){return le.Call(rt,this,arguments)});h(Array.prototype,ae,Array.prototype.values,true)}b(Array.prototype,tt);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}xe(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){var nt=Object.getPrototypeOf([].values());if(nt){xe(nt)}}var ot=function(){return a(function(){return Array.from({length:-1}).length===0})}();var it=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!ot||!it){oe(Array,"from",Qe.from)}var at=function(){return a(function(){return Array.from([0],void 0)})}();if(!at){var ut=Array.from;oe(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return le.Call(ut,this,arguments)}return t(ut,this,e)})}var ft=-(Math.pow(2,32)-1);var st=function(e,r){var n={length:ft};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!st(Array.prototype.forEach)){var ct=Array.prototype.forEach;oe(Array.prototype,"forEach",function forEach(e){return le.Call(ct,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.map)){var lt=Array.prototype.map;oe(Array.prototype,"map",function map(e){return le.Call(lt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.filter)){var pt=Array.prototype.filter;oe(Array.prototype,"filter",function filter(e){return le.Call(pt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.some)){var vt=Array.prototype.some;oe(Array.prototype,"some",function some(e){return le.Call(vt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.every)){var yt=Array.prototype.every;oe(Array.prototype,"every",function every(e){return le.Call(yt,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.reduce)){var ht=Array.prototype.reduce;oe(Array.prototype,"reduce",function reduce(e){return le.Call(ht,this.length>=0?this:[],arguments)})}if(!st(Array.prototype.reduceRight,true)){var bt=Array.prototype.reduceRight;oe(Array.prototype,"reduceRight",function reduceRight(e){return le.Call(bt,this.length>=0?this:[],arguments)})}var gt=Number("0o10")!==8;var dt=Number("0b10")!==2;var mt=y($e,function(e){return Number(e+0+e)===0});if(gt||dt||mt){var Ot=Number;var wt=/^0b[01]+$/i;var jt=/^0o[0-7]+$/i;var St=wt.test.bind(wt);var Tt=jt.test.bind(jt);var It=function(e,t){var r;if(typeof e.valueOf==="function"){r=e.valueOf();if(ne.primitive(r)){return r}}if(typeof e.toString==="function"){r=e.toString();if(ne.primitive(r)){return r}}throw new TypeError("No default value")};var Et=Je.test.bind(Je);var Pt=Xe.test.bind(Xe);var Ct=function(){var e=function Number(t){var r;if(arguments.length>0){r=ne.primitive(t)?t:It(t,"number")}else{r=0}if(typeof r==="string"){r=le.Call(Ue,r);if(St(r)){r=parseInt(C(r,2),2)}else if(Tt(r)){r=parseInt(C(r,2),8)}else if(Et(r)||Pt(r)){r=NaN}}var n=this;var o=a(function(){Ot.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new Ot(r)}return Ot(r)};return e}();Pe(Ot,Ct,{});b(Ct,{NaN:Ot.NaN,MAX_VALUE:Ot.MAX_VALUE,MIN_VALUE:Ot.MIN_VALUE,NEGATIVE_INFINITY:Ot.NEGATIVE_INFINITY,POSITIVE_INFINITY:Ot.POSITIVE_INFINITY});Number=Ct;m.redefine(S,"Number",Ct)}var Mt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Mt,MIN_SAFE_INTEGER:-Mt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:Z,isInteger:function isInteger(e){return Z(e)&&le.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&L(e)<=Number.MAX_SAFE_INTEGER},isNaN:K});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){oe(Array.prototype,"find",tt.find)}if([,1].findIndex(function(){return true})!==0){oe(Array.prototype,"findIndex",tt.findIndex)}var xt=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Nt=function ensureEnumerable(e,t){if(s&&xt(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var At=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var _t=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var Rt=function(e,t){var r=n(Object(t));var o;if(le.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),xt(t))}return p(P(r,o||[]),_t(t),e)};var kt={assign:function(e,t){var r=le.ToObject(e,"Cannot convert undefined or null to object");return p(le.Call(At,1,arguments),Rt,r)},is:function is(e,t){return le.SameValue(e,t)}};var Lt=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(Lt){oe(Object,"assign",kt.assign)}b(Object,kt);if(s){var Ft={setPrototypeOf:function(e){var r;var n=function(e,t){if(!le.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||le.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var o=function(e,o){n(e,o);t(r,e,o);return e};try{r=e.getOwnPropertyDescriptor(e.prototype,"__proto__").set;t(r,{},null)}catch(i){if(e.prototype!=={}.__proto__){return}r=function(e){this.__proto__=e};o.polyfill=o(o({},null),e.prototype)instanceof e}return o}(Object)};b(Object,Ft)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Dt=!i(function(){return Object.keys("foo")});if(!Dt){var zt=Object.keys;oe(Object,"keys",function keys(e){return zt(le.ToObject(e))});n=Object.keys}var qt=i(function(){return Object.keys(/a/g)});if(qt){var Wt=Object.keys;oe(Object,"keys",function keys(e){if(ne.regex(e)){var t=[];for(var r in e){if(q(e,r)){M(t,r)}}return t}return Wt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var Gt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!Gt){var Ht=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Vt=Object.getOwnPropertyNames;oe(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=le.ToObject(e);if(g(t)==="[object Window]"){try{return Vt(t)}catch(r){return P([],Ht)}}return Vt(t)})}}if(Object.getOwnPropertyDescriptor){var Bt=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Bt){var Ut=Object.getOwnPropertyDescriptor;oe(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Ut(le.ToObject(e),t)})}}if(Object.seal){var $t=!i(function(){return Object.seal("foo")});if(!$t){var Jt=Object.seal;oe(Object,"seal",function seal(e){if(!le.TypeIsObject(e)){return e}return Jt(e)})}}if(Object.isSealed){var Xt=!i(function(){return Object.isSealed("foo")});if(!Xt){var Kt=Object.isSealed;oe(Object,"isSealed",function isSealed(e){if(!le.TypeIsObject(e)){return true}return Kt(e)})}}if(Object.freeze){var Zt=!i(function(){return Object.freeze("foo")});if(!Zt){var Yt=Object.freeze;oe(Object,"freeze",function freeze(e){if(!le.TypeIsObject(e)){return e}return Yt(e)})}}if(Object.isFrozen){var Qt=!i(function(){return Object.isFrozen("foo")});if(!Qt){var er=Object.isFrozen;oe(Object,"isFrozen",function isFrozen(e){if(!le.TypeIsObject(e)){return true}return er(e)})}}if(Object.preventExtensions){var tr=!i(function(){return Object.preventExtensions("foo")});if(!tr){var rr=Object.preventExtensions;oe(Object,"preventExtensions",function preventExtensions(e){if(!le.TypeIsObject(e)){return e}return rr(e)})}}if(Object.isExtensible){var nr=!i(function(){return Object.isExtensible("foo")});if(!nr){var or=Object.isExtensible;oe(Object,"isExtensible",function isExtensible(e){if(!le.TypeIsObject(e)){return false}return or(e)})}}if(Object.getPrototypeOf){var ir=!i(function(){return Object.getPrototypeOf("foo")});if(!ir){var ar=Object.getPrototypeOf;oe(Object,"getPrototypeOf",function getPrototypeOf(e){return ar(le.ToObject(e))})}}var ur=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&le.IsCallable(e.get)}();if(s&&!ur){var fr=function flags(){if(!le.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",fr)}var sr=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var cr=ie&&s&&function(){var e=/./;e[J.match]=false;return RegExp(e)===e}();var lr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var pr=lr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!lr||!pr){var vr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=le.RequireObjectCoercible(this);if(ne.regex(e)){return t(vr,e)}var r=fe(e.source);var n=fe(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,vr);RegExp.prototype.toString.prototype=void 0}if(s&&(!sr||cr)){var yr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var hr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var br=function(){return this.source};var gr=le.IsCallable(hr.get)?hr.get:br;var dr=RegExp;var mr=function(){return function RegExp(e,t){var r=le.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(ne.regex(e)){o=le.Call(gr,e);i=typeof t==="undefined"?le.Call(yr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new dr(e,t)}}();Pe(dr,mr,{$input:true});RegExp=mr;m.redefine(S,"RegExp",mr)}if(s){var Or={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(Or),function(e){if(e in RegExp&&!(Or[e]in RegExp)){m.getter(RegExp,Or[e],function get(){return RegExp[e]})}})}Me(RegExp);var wr=1/Number.EPSILON;var jr=function roundTiesToEven(e){return e+wr-wr};var Sr=Math.pow(2,-23);var Tr=Math.pow(2,127)*(2-Sr);var Ir=Math.pow(2,-126);var Er=Math.E;var Pr=Math.LOG2E;var Cr=Math.LOG10E;var Mr=Number.prototype.clz;delete Number.prototype.clz;var xr={acosh:function acosh(e){var t=Number(e);if(K(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Q(t-1+z(1-r)*t)}var n=t/2;return Q(n+z(1-r)*n-1)+1/Pr},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=L(t);var n=r*r;var o=Y(t);if(r<1){return o*Q(r+n/(z(n+1)+1))}return o*(Q(r/2+z(1+1/n)*r/2-1)+1/Pr)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(K(t)||t<-1||t>1){return NaN}var r=L(t);return Y(t)*Q(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=F(D(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=le.ToUint32(t);if(r===0){return 32}return Mr?le.Call(Mr,r):31-k(D(r+.5)*Pr)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(K(t)){return NaN}if(!T(t)){return Infinity}var r=F(L(t)-1);return(r+1/(r*Er*Er))*(Er/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(L(t)>.5){return F(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=L(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*z(r)},log2:function log2(e){return D(e)*Pr},log10:function log10(e){return D(e)*Cr},log1p:Q,sign:Y,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=L(t);if(r<1){var n=Math.expm1(r);return Y(t)*n*(1+1/(n+1))/2}var o=F(r-1);return Y(t)*(o-1/(o*Er*Er))*(Er/2)},tanh:function tanh(e){var t=Number(e);if(K(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(F(t)+F(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-k(-t):k(t)},imul:function imul(e,t){var r=le.ToUint32(e);var n=le.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||K(t)){return t}var r=Y(t);var n=L(t);if(n<Ir){return r*jr(n/Ir/Sr)*Ir*Sr}var o=(1+Sr/Number.EPSILON)*n;var i=o-(o-n);if(i>Tr||K(i)){return r*Infinity}return r*i}};var Nr=function withinULPDistance(e,t,r){return L(1-e/t)/Number.EPSILON<(r||8)};b(Math,xr);h(Math,"sinh",xr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",xr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",xr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",xr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));
h(Math,"asinh",xr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",xr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",xr.tanh,Math.tanh(-2e-17)!==-2e-17);h(Math,"acosh",xr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",xr.acosh,!Nr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",xr.cbrt,!Nr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",xr.sinh,Math.sinh(-2e-17)!==-2e-17);var Ar=Math.expm1(10);h(Math,"expm1",xr.expm1,Ar>22025.465794806718||Ar<22025.465794806718);h(Math,"hypot",xr.hypot,Math.hypot(Infinity,NaN)!==Infinity);var _r=Math.round;var Rr=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var kr=wr+1;var Lr=2*wr-1;var Fr=[kr,Lr].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=k(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Rr||!Fr);m.preserveToString(Math.round,_r);var Dr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=xr.imul;m.preserveToString(Math.imul,Dr)}if(Math.imul.length!==2){oe(Math,"imul",function imul(e,t){return le.Call(Dr,Math,arguments)})}var zr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}le.IsPromise=function(e){if(!le.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!le.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(le.IsCallable(t.resolve)&&le.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&le.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=A(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=le.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(le.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!le.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!le.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!le.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=_e(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=le.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=le.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=le.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{le.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=le.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{le.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!le.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(le.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!le.IsPromise(n)){throw new TypeError("not a promise")}var o=le.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=le.IsCallable(e)?e:a;var d=le.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof zr==="function"){b(S,{Promise:zr});var qr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var Wr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,G)});var Gr=i(function(){return S.Promise.call(3,G)});var Hr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,G).then(null,G)}catch(n){return true}return t===r}(S.Promise);var Vr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Br=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Br.prototype=Promise.prototype;Br.all=Promise.all;var Ur=a(function(){return!!Br.all([1,2])});if(!qr||!Wr||!Gr||Hr||!Vr||Ur){Promise=zr;oe(S,"Promise",zr)}if(Promise.all.length!==1){var $r=Promise.all;oe(Promise,"all",function all(e){return le.Call($r,this,arguments)})}if(Promise.race.length!==1){var Jr=Promise.race;oe(Promise,"race",function race(e){return le.Call(Jr,this,arguments)})}if(Promise.resolve.length!==1){var Xr=Promise.resolve;oe(Promise,"resolve",function resolve(e){return le.Call(Xr,this,arguments)})}if(Promise.reject.length!==1){var Kr=Promise.reject;oe(Promise,"reject",function reject(e){return le.Call(Kr,this,arguments)})}Nt(Promise,"all");Nt(Promise,"race");Nt(Promise,"resolve");Nt(Promise,"reject");Me(Promise)}var Zr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Yr=Zr(["z","a","bb"]);var Qr=Zr(["z",1,"a","3",2]);if(s){var en=function fastkey(e,t){if(!t&&!Yr){return null}if(ce(e)){return"^"+le.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Qr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var tn=function emptyObject(){return Object.create?Object.create(null):{}};var rn=function addIterableToMap(e,n,o){if(r(o)||ne.string(o)){l(o,function(e){if(!le.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!ce(o)){a=n.set;if(!le.IsCallable(a)){throw new TypeError("bad map")}i=le.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=le.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!le.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){le.IteratorClose(i,true);throw s}}}}};var nn=function addIterableToSet(e,n,o){if(r(o)||ne.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!ce(o)){a=n.add;if(!le.IsCallable(a)){throw new TypeError("bad set")}i=le.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=le.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){le.IteratorClose(i,true);throw s}}}}};var on={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!le.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+le.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");h(this,"head",e._head);h(this,"i",this.head);h(this,"kind",t)};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ze()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ze(n)}}this.i=void 0;return Ze()}};xe(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=_e(this,Map,a,{_es6map:true,_head:null,_map:H?new H:null,_size:0,_storage:tn()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){rn(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=en(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}return}if(this._map){t=B.call(this._map,e);if(t){return t.value}return}var n=this._head;var i=n;while((i=i.next)!==n){if(le.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=en(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return U.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(le.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=en(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}a=this._storage[u]=new r(e,t);i=n.prev}else if(this._map){if(U.call(this._map,e)){B.call(this._map,e).value=t}else{a=new r(e,t);$.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(le.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(le.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=en(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!U.call(this._map,t)){return false}n=B.call(this._map,t).prev;V.call(this._map,t)}while((n=n.next)!==r){if(le.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=H?new H:null;this._size=0;this._storage=tn();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});xe(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!le.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+le.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=_e(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:tn()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){nn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new on.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=en(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=en(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=en(e))!==null){var n=q(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=tn()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);xe(i.prototype,i.prototype.values);var f=function SetIterator(e){h(this,"it",e)};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};xe(f.prototype);return i}()};var an=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(an){S.Set=on.Set}if(S.Map||S.Set){var un=a(function(){return new Map([[1,2]]).get(1)===2});if(!un){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new H;if(arguments.length>0){rn(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(H.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,H)}var fn=new Map;var sn=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var cn=fn.set(1,2)===fn;if(!sn||!cn){oe(Map.prototype,"set",function set(e,r){t($,this,e===0?0:e,r);return this})}if(!sn){b(Map.prototype,{get:function get(e){return t(B,this,e===0?0:e)},has:function has(e){return t(U,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,B);m.preserveToString(Map.prototype.has,U)}var ln=new Set;var pn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(ln);var vn=ln.add(1)===ln;if(!pn||!vn){var yn=Set.prototype.add;Set.prototype.add=function add(e){t(yn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,yn)}if(!pn){var hn=Set.prototype.has;Set.prototype.has=function has(e){return t(hn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,hn);var bn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(bn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],bn)}var gn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var dn=Object.setPrototypeOf&&!gn;var mn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||dn||!mn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new H;if(arguments.length>0){rn(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=H.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,H)}var On=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var wn=Object.setPrototypeOf&&!On;var jn=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||wn||!jn){var Sn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new Sn;if(arguments.length>0){nn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=Sn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,Sn)}var Tn=new S.Map;var In=!a(function(){return Tn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||Tn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof Tn.keys().next!=="function"||In||!gn){b(S,{Map:on.Map,Set:on.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}xe(Object.getPrototypeOf((new S.Map).keys()));xe(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var En=S.Set.prototype.has;oe(S.Set.prototype,"has",function has(e){return t(En,this,e)})}}b(S,on);Me(S.Map);Me(S.Set)}var Pn=function throwUnlessTargetIsObject(e){if(!le.TypeIsObject(e)){throw new TypeError("target must be an object")}};var Cn={apply:function apply(){return le.Call(le.Call,null,arguments)},construct:function construct(e,t){if(!le.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!le.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return le.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){Pn(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){Pn(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(Cn,{ownKeys:function ownKeys(e){Pn(e);var t=Object.getOwnPropertyNames(e);if(le.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Mn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(Cn,{isExtensible:function isExtensible(e){Pn(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){Pn(e);return Mn(function(){return Object.preventExtensions(e)})}})}if(s){var xn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return xn(o,t,r)}if("value"in n){return n.value}if(n.get){return le.Call(n.get,r)}return void 0};var Nn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Nn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!le.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ue.defineProperty(o,r,{value:n})}return ue.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}if(i.set){t(i.set,o,n);return true}return false};Object.assign(Cn,{defineProperty:function defineProperty(e,t,r){Pn(e);return Mn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){Pn(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){Pn(e);var r=arguments.length>2?arguments[2]:e;return xn(e,t,r)},set:function set(e,t,r){Pn(e);var n=arguments.length>3?arguments[3]:e;return Nn(e,t,r,n)}})}if(Object.getPrototypeOf){var An=Object.getPrototypeOf;Cn.getPrototypeOf=function getPrototypeOf(e){Pn(e);return An(e)}}if(Object.setPrototypeOf&&Cn.getPrototypeOf){var _n=function(e,t){var r=t;while(r){if(e===r){return true}r=Cn.getPrototypeOf(r)}return false};Object.assign(Cn,{setPrototypeOf:function setPrototypeOf(e,t){Pn(e);if(t!==null&&!le.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ue.getPrototypeOf(e)){return true}if(ue.isExtensible&&!ue.isExtensible(e)){return false}if(_n(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var Rn=function(e,t){if(!le.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){oe(S.Reflect,e,t)}}};Object.keys(Cn).forEach(function(e){Rn(e,Cn[e])});var kn=S.Reflect.getPrototypeOf;if(c&&kn&&kn.name!=="getPrototypeOf"){oe(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(kn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){oe(S.Reflect,"setPrototypeOf",Cn.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){oe(S.Reflect,"defineProperty",Cn.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){oe(S.Reflect,"construct",Cn.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var Ln=Date.prototype.toString;var Fn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return le.Call(Ln,this)};oe(Date.prototype,"toString",Fn)}var Dn={anchor:function anchor(e){return le.CreateHTML(this,"a","name",e)},big:function big(){return le.CreateHTML(this,"big","","")},blink:function blink(){return le.CreateHTML(this,"blink","","")},bold:function bold(){return le.CreateHTML(this,"b","","")},fixed:function fixed(){return le.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return le.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return le.CreateHTML(this,"font","size",e)},italics:function italics(){return le.CreateHTML(this,"i","","")},link:function link(e){return le.CreateHTML(this,"a","href",e)},small:function small(){return le.CreateHTML(this,"small","","")},strike:function strike(){return le.CreateHTML(this,"strike","","")},sub:function sub(){return le.CreateHTML(this,"sub","","")},sup:function sub(){return le.CreateHTML(this,"sup","","")}};l(Object.keys(Dn),function(e){var r=String.prototype[e];var n=false;if(le.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){oe(String.prototype,e,Dn[e])}});var zn=function(){if(!ie){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e(J())!=="undefined"){return true}if(e([J()])!=="[null]"){return true}var t={a:J()};t[J()]=true;if(e(t)!=="{}"){return true}return false}();var qn=a(function(){if(!ie){return true}return JSON.stringify(Object(J()))==="{}"&&JSON.stringify([Object(J())])==="[{}]"});if(zn||!qn){var Wn=JSON.stringify;oe(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=le.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(ne.symbol(n)){return _t({})(n)}return n}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return Wn.apply(this,o)})}return S});
//# sourceMappingURL=es6-shim.map
/*! jQuery v3.7.1 | (c) OpenJS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(ie,e){"use strict";var oe=[],r=Object.getPrototypeOf,ae=oe.slice,g=oe.flat?function(e){return oe.flat.call(e)}:function(e){return oe.concat.apply([],e)},s=oe.push,se=oe.indexOf,n={},i=n.toString,ue=n.hasOwnProperty,o=ue.toString,a=o.call(Object),le={},v=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},y=function(e){return null!=e&&e===e.window},C=ie.document,u={type:!0,src:!0,nonce:!0,noModule:!0};function m(e,t,n){var r,i,o=(n=n||C).createElement("script");if(o.text=e,t)for(r in u)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function x(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[i.call(e)]||"object":typeof e}var t="3.7.1",l=/HTML$/i,ce=function(e,t){return new ce.fn.init(e,t)};function c(e){var t=!!e&&"length"in e&&e.length,n=x(e);return!v(e)&&!y(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}function fe(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}ce.fn=ce.prototype={jquery:t,constructor:ce,length:0,toArray:function(){return ae.call(this)},get:function(e){return null==e?ae.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=ce.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return ce.each(this,e)},map:function(n){return this.pushStack(ce.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(ae.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(ce.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(ce.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:oe.sort,splice:oe.splice},ce.extend=ce.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||v(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(ce.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||ce.isPlainObject(n)?n:{},i=!1,a[t]=ce.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},ce.extend({expando:"jQuery"+(t+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=r(e))||"function"==typeof(n=ue.call(t,"constructor")&&t.constructor)&&o.call(n)===a)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){m(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(c(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},text:function(e){var t,n="",r=0,i=e.nodeType;if(!i)while(t=e[r++])n+=ce.text(t);return 1===i||11===i?e.textContent:9===i?e.documentElement.textContent:3===i||4===i?e.nodeValue:n},makeArray:function(e,t){var n=t||[];return null!=e&&(c(Object(e))?ce.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:se.call(t,e,n)},isXMLDoc:function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!l.test(t||n&&n.nodeName||"HTML")},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(c(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:le}),"function"==typeof Symbol&&(ce.fn[Symbol.iterator]=oe[Symbol.iterator]),ce.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var pe=oe.pop,de=oe.sort,he=oe.splice,ge="[\\x20\\t\\r\\n\\f]",ve=new RegExp("^"+ge+"+|((?:^|[^\\\\])(?:\\\\.)*)"+ge+"+$","g");ce.contains=function(e,t){var n=t&&t.parentNode;return e===n||!(!n||1!==n.nodeType||!(e.contains?e.contains(n):e.compareDocumentPosition&&16&e.compareDocumentPosition(n)))};var f=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function p(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e}ce.escapeSelector=function(e){return(e+"").replace(f,p)};var ye=C,me=s;!function(){var e,b,w,o,a,T,r,C,d,i,k=me,S=ce.expando,E=0,n=0,s=W(),c=W(),u=W(),h=W(),l=function(e,t){return e===t&&(a=!0),0},f="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",t="(?:\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",p="\\["+ge+"*("+t+")(?:"+ge+"*([*^$|!~]?=)"+ge+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+t+"))|)"+ge+"*\\]",g=":("+t+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+p+")*)|.*)\\)|)",v=new RegExp(ge+"+","g"),y=new RegExp("^"+ge+"*,"+ge+"*"),m=new RegExp("^"+ge+"*([>+~]|"+ge+")"+ge+"*"),x=new RegExp(ge+"|>"),j=new RegExp(g),A=new RegExp("^"+t+"$"),D={ID:new RegExp("^#("+t+")"),CLASS:new RegExp("^\\.("+t+")"),TAG:new RegExp("^("+t+"|[*])"),ATTR:new RegExp("^"+p),PSEUDO:new RegExp("^"+g),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+ge+"*(even|odd|(([+-]|)(\\d*)n|)"+ge+"*(?:([+-]|)"+ge+"*(\\d+)|))"+ge+"*\\)|)","i"),bool:new RegExp("^(?:"+f+")$","i"),needsContext:new RegExp("^"+ge+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+ge+"*((?:-\\d)?\\d*)"+ge+"*\\)|)(?=[^-]|$)","i")},N=/^(?:input|select|textarea|button)$/i,q=/^h\d$/i,L=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,H=/[+~]/,O=new RegExp("\\\\[\\da-fA-F]{1,6}"+ge+"?|\\\\([^\\r\\n\\f])","g"),P=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},M=function(){V()},R=J(function(e){return!0===e.disabled&&fe(e,"fieldset")},{dir:"parentNode",next:"legend"});try{k.apply(oe=ae.call(ye.childNodes),ye.childNodes),oe[ye.childNodes.length].nodeType}catch(e){k={apply:function(e,t){me.apply(e,ae.call(t))},call:function(e){me.apply(e,ae.call(arguments,1))}}}function I(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(V(e),e=e||T,C)){if(11!==p&&(u=L.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return k.call(n,a),n}else if(f&&(a=f.getElementById(i))&&I.contains(e,a)&&a.id===i)return k.call(n,a),n}else{if(u[2])return k.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&e.getElementsByClassName)return k.apply(n,e.getElementsByClassName(i)),n}if(!(h[t+" "]||d&&d.test(t))){if(c=t,f=e,1===p&&(x.test(t)||m.test(t))){(f=H.test(t)&&U(e.parentNode)||e)==e&&le.scope||((s=e.getAttribute("id"))?s=ce.escapeSelector(s):e.setAttribute("id",s=S)),o=(l=Y(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+Q(l[o]);c=l.join(",")}try{return k.apply(n,f.querySelectorAll(c)),n}catch(e){h(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return re(t.replace(ve,"$1"),e,n,r)}function W(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function F(e){return e[S]=!0,e}function $(e){var t=T.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function B(t){return function(e){return fe(e,"input")&&e.type===t}}function _(t){return function(e){return(fe(e,"input")||fe(e,"button"))&&e.type===t}}function z(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&R(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function X(a){return F(function(o){return o=+o,F(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function U(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function V(e){var t,n=e?e.ownerDocument||e:ye;return n!=T&&9===n.nodeType&&n.documentElement&&(r=(T=n).documentElement,C=!ce.isXMLDoc(T),i=r.matches||r.webkitMatchesSelector||r.msMatchesSelector,r.msMatchesSelector&&ye!=T&&(t=T.defaultView)&&t.top!==t&&t.addEventListener("unload",M),le.getById=$(function(e){return r.appendChild(e).id=ce.expando,!T.getElementsByName||!T.getElementsByName(ce.expando).length}),le.disconnectedMatch=$(function(e){return i.call(e,"*")}),le.scope=$(function(){return T.querySelectorAll(":scope")}),le.cssHas=$(function(){try{return T.querySelector(":has(*,:jqfake)"),!1}catch(e){return!0}}),le.getById?(b.filter.ID=function(e){var t=e.replace(O,P);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(O,P);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&C){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):t.querySelectorAll(e)},b.find.CLASS=function(e,t){if("undefined"!=typeof t.getElementsByClassName&&C)return t.getElementsByClassName(e)},d=[],$(function(e){var t;r.appendChild(e).innerHTML="<a id='"+S+"' href='' disabled='disabled'></a><select id='"+S+"-\r\\' disabled='disabled'><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+ge+"*(?:value|"+f+")"),e.querySelectorAll("[id~="+S+"-]").length||d.push("~="),e.querySelectorAll("a#"+S+"+*").length||d.push(".#.+[+~]"),e.querySelectorAll(":checked").length||d.push(":checked"),(t=T.createElement("input")).setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),r.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&d.push(":enabled",":disabled"),(t=T.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||d.push("\\["+ge+"*name"+ge+"*="+ge+"*(?:''|\"\")")}),le.cssHas||d.push(":has"),d=d.length&&new RegExp(d.join("|")),l=function(e,t){if(e===t)return a=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!le.sortDetached&&t.compareDocumentPosition(e)===n?e===T||e.ownerDocument==ye&&I.contains(ye,e)?-1:t===T||t.ownerDocument==ye&&I.contains(ye,t)?1:o?se.call(o,e)-se.call(o,t):0:4&n?-1:1)}),T}for(e in I.matches=function(e,t){return I(e,null,null,t)},I.matchesSelector=function(e,t){if(V(e),C&&!h[t+" "]&&(!d||!d.test(t)))try{var n=i.call(e,t);if(n||le.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){h(t,!0)}return 0<I(t,T,null,[e]).length},I.contains=function(e,t){return(e.ownerDocument||e)!=T&&V(e),ce.contains(e,t)},I.attr=function(e,t){(e.ownerDocument||e)!=T&&V(e);var n=b.attrHandle[t.toLowerCase()],r=n&&ue.call(b.attrHandle,t.toLowerCase())?n(e,t,!C):void 0;return void 0!==r?r:e.getAttribute(t)},I.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},ce.uniqueSort=function(e){var t,n=[],r=0,i=0;if(a=!le.sortStable,o=!le.sortStable&&ae.call(e,0),de.call(e,l),a){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)he.call(e,n[r],1)}return o=null,e},ce.fn.uniqueSort=function(){return this.pushStack(ce.uniqueSort(ae.apply(this)))},(b=ce.expr={cacheLength:50,createPseudo:F,match:D,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(O,P),e[3]=(e[3]||e[4]||e[5]||"").replace(O,P),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||I.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&I.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return D.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&j.test(n)&&(t=Y(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(O,P).toLowerCase();return"*"===e?function(){return!0}:function(e){return fe(e,t)}},CLASS:function(e){var t=s[e+" "];return t||(t=new RegExp("(^|"+ge+")"+e+"("+ge+"|$)"))&&s(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=I.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(v," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(d,e,t,h,g){var v="nth"!==d.slice(0,3),y="last"!==d.slice(-4),m="of-type"===e;return 1===h&&0===g?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u=v!==y?"nextSibling":"previousSibling",l=e.parentNode,c=m&&e.nodeName.toLowerCase(),f=!n&&!m,p=!1;if(l){if(v){while(u){o=e;while(o=o[u])if(m?fe(o,c):1===o.nodeType)return!1;s=u="only"===d&&!s&&"nextSibling"}return!0}if(s=[y?l.firstChild:l.lastChild],y&&f){p=(a=(r=(i=l[S]||(l[S]={}))[d]||[])[0]===E&&r[1])&&r[2],o=a&&l.childNodes[a];while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if(1===o.nodeType&&++p&&o===e){i[d]=[E,a,p];break}}else if(f&&(p=a=(r=(i=e[S]||(e[S]={}))[d]||[])[0]===E&&r[1]),!1===p)while(o=++a&&o&&o[u]||(p=a=0)||s.pop())if((m?fe(o,c):1===o.nodeType)&&++p&&(f&&((i=o[S]||(o[S]={}))[d]=[E,p]),o===e))break;return(p-=g)===h||p%h==0&&0<=p/h}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||I.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?F(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=se.call(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:F(function(e){var r=[],i=[],s=ne(e.replace(ve,"$1"));return s[S]?F(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:F(function(t){return function(e){return 0<I(t,e).length}}),contains:F(function(t){return t=t.replace(O,P),function(e){return-1<(e.textContent||ce.text(e)).indexOf(t)}}),lang:F(function(n){return A.test(n||"")||I.error("unsupported lang: "+n),n=n.replace(O,P).toLowerCase(),function(e){var t;do{if(t=C?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=ie.location&&ie.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===r},focus:function(e){return e===function(){try{return T.activeElement}catch(e){}}()&&T.hasFocus()&&!!(e.type||e.href||~e.tabIndex)},enabled:z(!1),disabled:z(!0),checked:function(e){return fe(e,"input")&&!!e.checked||fe(e,"option")&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return q.test(e.nodeName)},input:function(e){return N.test(e.nodeName)},button:function(e){return fe(e,"input")&&"button"===e.type||fe(e,"button")},text:function(e){var t;return fe(e,"input")&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:X(function(){return[0]}),last:X(function(e,t){return[t-1]}),eq:X(function(e,t,n){return[n<0?n+t:n]}),even:X(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:X(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:X(function(e,t,n){var r;for(r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:X(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=B(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=_(e);function G(){}function Y(e,t){var n,r,i,o,a,s,u,l=c[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=y.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=m.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(ve," ")}),a=a.slice(n.length)),b.filter)!(r=D[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?I.error(e):c(e,s).slice(0)}function Q(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function J(a,e,t){var s=e.dir,u=e.next,l=u||s,c=t&&"parentNode"===l,f=n++;return e.first?function(e,t,n){while(e=e[s])if(1===e.nodeType||c)return a(e,t,n);return!1}:function(e,t,n){var r,i,o=[E,f];if(n){while(e=e[s])if((1===e.nodeType||c)&&a(e,t,n))return!0}else while(e=e[s])if(1===e.nodeType||c)if(i=e[S]||(e[S]={}),u&&fe(e,u))e=e[s]||e;else{if((r=i[l])&&r[0]===E&&r[1]===f)return o[2]=r[2];if((i[l]=o)[2]=a(e,t,n))return!0}return!1}}function K(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Z(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function ee(d,h,g,v,y,e){return v&&!v[S]&&(v=ee(v)),y&&!y[S]&&(y=ee(y,e)),F(function(e,t,n,r){var i,o,a,s,u=[],l=[],c=t.length,f=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)I(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),p=!d||!e&&h?f:Z(f,u,d,n,r);if(g?g(p,s=y||(e?d:c||v)?[]:t,n,r):s=p,v){i=Z(s,l),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(s[l[o]]=!(p[l[o]]=a))}if(e){if(y||d){if(y){i=[],o=s.length;while(o--)(a=s[o])&&i.push(p[o]=a);y(null,s=[],i,r)}o=s.length;while(o--)(a=s[o])&&-1<(i=y?se.call(e,a):u[o])&&(e[i]=!(t[i]=a))}}else s=Z(s===t?s.splice(c,s.length):s),y?y(null,t,s,r):k.apply(t,s)})}function te(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=J(function(e){return e===i},a,!0),l=J(function(e){return-1<se.call(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!=w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[J(K(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return ee(1<s&&K(c),1<s&&Q(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(ve,"$1"),t,s<n&&te(e.slice(s,n)),n<r&&te(e=e.slice(n)),n<r&&Q(e))}c.push(t)}return K(c)}function ne(e,t){var n,v,y,m,x,r,i=[],o=[],a=u[e+" "];if(!a){t||(t=Y(e)),n=t.length;while(n--)(a=te(t[n]))[S]?i.push(a):o.push(a);(a=u(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=E+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==T||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==T||(V(o),n=!C);while(s=v[a++])if(s(o,t||T,n)){k.call(r,o);break}i&&(E=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=pe.call(r));f=Z(f)}k.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&ce.uniqueSort(r)}return i&&(E=h,w=p),c},m?F(r):r))).selector=e}return a}function re(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&Y(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&C&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(O,P),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=D.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(O,P),H.test(o[0].type)&&U(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&Q(o)))return k.apply(n,r),n;break}}}return(l||ne(e,c))(r,t,!C,n,!t||H.test(e)&&U(t.parentNode)||t),n}G.prototype=b.filters=b.pseudos,b.setFilters=new G,le.sortStable=S.split("").sort(l).join("")===S,V(),le.sortDetached=$(function(e){return 1&e.compareDocumentPosition(T.createElement("fieldset"))}),ce.find=I,ce.expr[":"]=ce.expr.pseudos,ce.unique=ce.uniqueSort,I.compile=ne,I.select=re,I.setDocument=V,I.tokenize=Y,I.escape=ce.escapeSelector,I.getText=ce.text,I.isXML=ce.isXMLDoc,I.selectors=ce.expr,I.support=ce.support,I.uniqueSort=ce.uniqueSort}();var d=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&ce(e).is(n))break;r.push(e)}return r},h=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},b=ce.expr.match.needsContext,w=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function T(e,n,r){return v(n)?ce.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?ce.grep(e,function(e){return e===n!==r}):"string"!=typeof n?ce.grep(e,function(e){return-1<se.call(n,e)!==r}):ce.filter(n,e,r)}ce.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?ce.find.matchesSelector(r,e)?[r]:[]:ce.find.matches(e,ce.grep(t,function(e){return 1===e.nodeType}))},ce.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(ce(e).filter(function(){for(t=0;t<r;t++)if(ce.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)ce.find(e,i[t],n);return 1<r?ce.uniqueSort(n):n},filter:function(e){return this.pushStack(T(this,e||[],!1))},not:function(e){return this.pushStack(T(this,e||[],!0))},is:function(e){return!!T(this,"string"==typeof e&&b.test(e)?ce(e):e||[],!1).length}});var k,S=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(ce.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||k,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:S.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof ce?t[0]:t,ce.merge(this,ce.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:C,!0)),w.test(r[1])&&ce.isPlainObject(t))for(r in t)v(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=C.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):v(e)?void 0!==n.ready?n.ready(e):e(ce):ce.makeArray(e,this)}).prototype=ce.fn,k=ce(C);var E=/^(?:parents|prev(?:Until|All))/,j={children:!0,contents:!0,next:!0,prev:!0};function A(e,t){while((e=e[t])&&1!==e.nodeType);return e}ce.fn.extend({has:function(e){var t=ce(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(ce.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&ce(e);if(!b.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&ce.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?ce.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?se.call(ce(e),this[0]):se.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(ce.uniqueSort(ce.merge(this.get(),ce(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),ce.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return d(e,"parentNode")},parentsUntil:function(e,t,n){return d(e,"parentNode",n)},next:function(e){return A(e,"nextSibling")},prev:function(e){return A(e,"previousSibling")},nextAll:function(e){return d(e,"nextSibling")},prevAll:function(e){return d(e,"previousSibling")},nextUntil:function(e,t,n){return d(e,"nextSibling",n)},prevUntil:function(e,t,n){return d(e,"previousSibling",n)},siblings:function(e){return h((e.parentNode||{}).firstChild,e)},children:function(e){return h(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(fe(e,"template")&&(e=e.content||e),ce.merge([],e.childNodes))}},function(r,i){ce.fn[r]=function(e,t){var n=ce.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=ce.filter(t,n)),1<this.length&&(j[r]||ce.uniqueSort(n),E.test(r)&&n.reverse()),this.pushStack(n)}});var D=/[^\x20\t\r\n\f]+/g;function N(e){return e}function q(e){throw e}function L(e,t,n,r){var i;try{e&&v(i=e.promise)?i.call(e).done(t).fail(n):e&&v(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}ce.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},ce.each(e.match(D)||[],function(e,t){n[t]=!0}),n):ce.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){ce.each(e,function(e,t){v(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==x(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return ce.each(arguments,function(e,t){var n;while(-1<(n=ce.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<ce.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},ce.extend({Deferred:function(e){var o=[["notify","progress",ce.Callbacks("memory"),ce.Callbacks("memory"),2],["resolve","done",ce.Callbacks("once memory"),ce.Callbacks("once memory"),0,"resolved"],["reject","fail",ce.Callbacks("once memory"),ce.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return ce.Deferred(function(r){ce.each(o,function(e,t){var n=v(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&v(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,v(t)?s?t.call(e,l(u,o,N,s),l(u,o,q,s)):(u++,t.call(e,l(u,o,N,s),l(u,o,q,s),l(u,o,N,o.notifyWith))):(a!==N&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){ce.Deferred.exceptionHook&&ce.Deferred.exceptionHook(e,t.error),u<=i+1&&(a!==q&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(ce.Deferred.getErrorHook?t.error=ce.Deferred.getErrorHook():ce.Deferred.getStackHook&&(t.error=ce.Deferred.getStackHook()),ie.setTimeout(t))}}return ce.Deferred(function(e){o[0][3].add(l(0,e,v(r)?r:N,e.notifyWith)),o[1][3].add(l(0,e,v(t)?t:N)),o[2][3].add(l(0,e,v(n)?n:q))}).promise()},promise:function(e){return null!=e?ce.extend(e,a):a}},s={};return ce.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=ae.call(arguments),o=ce.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?ae.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(L(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||v(i[t]&&i[t].then)))return o.then();while(t--)L(i[t],a(t),o.reject);return o.promise()}});var H=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;ce.Deferred.exceptionHook=function(e,t){ie.console&&ie.console.warn&&e&&H.test(e.name)&&ie.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},ce.readyException=function(e){ie.setTimeout(function(){throw e})};var O=ce.Deferred();function P(){C.removeEventListener("DOMContentLoaded",P),ie.removeEventListener("load",P),ce.ready()}ce.fn.ready=function(e){return O.then(e)["catch"](function(e){ce.readyException(e)}),this},ce.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--ce.readyWait:ce.isReady)||(ce.isReady=!0)!==e&&0<--ce.readyWait||O.resolveWith(C,[ce])}}),ce.ready.then=O.then,"complete"===C.readyState||"loading"!==C.readyState&&!C.documentElement.doScroll?ie.setTimeout(ce.ready):(C.addEventListener("DOMContentLoaded",P),ie.addEventListener("load",P));var M=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===x(n))for(s in i=!0,n)M(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,v(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(ce(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},R=/^-ms-/,I=/-([a-z])/g;function W(e,t){return t.toUpperCase()}function F(e){return e.replace(R,"ms-").replace(I,W)}var $=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function B(){this.expando=ce.expando+B.uid++}B.uid=1,B.prototype={cache:function(e){var t=e[this.expando];return t||(t={},$(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[F(t)]=n;else for(r in t)i[F(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][F(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(F):(t=F(t))in r?[t]:t.match(D)||[]).length;while(n--)delete r[t[n]]}(void 0===t||ce.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!ce.isEmptyObject(t)}};var _=new B,z=new B,X=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,U=/[A-Z]/g;function V(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(U,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:X.test(i)?JSON.parse(i):i)}catch(e){}z.set(e,t,n)}else n=void 0;return n}ce.extend({hasData:function(e){return z.hasData(e)||_.hasData(e)},data:function(e,t,n){return z.access(e,t,n)},removeData:function(e,t){z.remove(e,t)},_data:function(e,t,n){return _.access(e,t,n)},_removeData:function(e,t){_.remove(e,t)}}),ce.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=z.get(o),1===o.nodeType&&!_.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=F(r.slice(5)),V(o,r,i[r]));_.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){z.set(this,n)}):M(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=z.get(o,n))?t:void 0!==(t=V(o,n))?t:void 0;this.each(function(){z.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){z.remove(this,e)})}}),ce.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=_.get(e,t),n&&(!r||Array.isArray(n)?r=_.access(e,t,ce.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=ce.queue(e,t),r=n.length,i=n.shift(),o=ce._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){ce.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return _.get(e,n)||_.access(e,n,{empty:ce.Callbacks("once memory").add(function(){_.remove(e,[t+"queue",n])})})}}),ce.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?ce.queue(this[0],t):void 0===n?this:this.each(function(){var e=ce.queue(this,t,n);ce._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&ce.dequeue(this,t)})},dequeue:function(e){return this.each(function(){ce.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=ce.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=_.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var G=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Y=new RegExp("^(?:([+-])=|)("+G+")([a-z%]*)$","i"),Q=["Top","Right","Bottom","Left"],J=C.documentElement,K=function(e){return ce.contains(e.ownerDocument,e)},Z={composed:!0};J.getRootNode&&(K=function(e){return ce.contains(e.ownerDocument,e)||e.getRootNode(Z)===e.ownerDocument});var ee=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&K(e)&&"none"===ce.css(e,"display")};function te(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return ce.css(e,t,"")},u=s(),l=n&&n[3]||(ce.cssNumber[t]?"":"px"),c=e.nodeType&&(ce.cssNumber[t]||"px"!==l&&+u)&&Y.exec(ce.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)ce.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,ce.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ne={};function re(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=_.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ee(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ne[s])||(o=a.body.appendChild(a.createElement(s)),u=ce.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ne[s]=u)))):"none"!==n&&(l[c]="none",_.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}ce.fn.extend({show:function(){return re(this,!0)},hide:function(){return re(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ee(this)?ce(this).show():ce(this).hide()})}});var xe,be,we=/^(?:checkbox|radio)$/i,Te=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,Ce=/^$|^module$|\/(?:java|ecma)script/i;xe=C.createDocumentFragment().appendChild(C.createElement("div")),(be=C.createElement("input")).setAttribute("type","radio"),be.setAttribute("checked","checked"),be.setAttribute("name","t"),xe.appendChild(be),le.checkClone=xe.cloneNode(!0).cloneNode(!0).lastChild.checked,xe.innerHTML="<textarea>x</textarea>",le.noCloneChecked=!!xe.cloneNode(!0).lastChild.defaultValue,xe.innerHTML="<option></option>",le.option=!!xe.lastChild;var ke={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function Se(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&fe(e,t)?ce.merge([e],n):n}function Ee(e,t){for(var n=0,r=e.length;n<r;n++)_.set(e[n],"globalEval",!t||_.get(t[n],"globalEval"))}ke.tbody=ke.tfoot=ke.colgroup=ke.caption=ke.thead,ke.th=ke.td,le.option||(ke.optgroup=ke.option=[1,"<select multiple='multiple'>","</select>"]);var je=/<|&#?\w+;/;function Ae(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===x(o))ce.merge(p,o.nodeType?[o]:o);else if(je.test(o)){a=a||f.appendChild(t.createElement("div")),s=(Te.exec(o)||["",""])[1].toLowerCase(),u=ke[s]||ke._default,a.innerHTML=u[1]+ce.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;ce.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<ce.inArray(o,r))i&&i.push(o);else if(l=K(o),a=Se(f.appendChild(o),"script"),l&&Ee(a),n){c=0;while(o=a[c++])Ce.test(o.type||"")&&n.push(o)}return f}var De=/^([^.]*)(?:\.(.+)|)/;function Ne(){return!0}function qe(){return!1}function Le(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Le(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=qe;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return ce().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=ce.guid++)),e.each(function(){ce.event.add(this,t,i,r,n)})}function He(e,r,t){t?(_.set(e,r,!1),ce.event.add(e,r,{namespace:!1,handler:function(e){var t,n=_.get(this,r);if(1&e.isTrigger&&this[r]){if(n)(ce.event.special[r]||{}).delegateType&&e.stopPropagation();else if(n=ae.call(arguments),_.set(this,r,n),this[r](),t=_.get(this,r),_.set(this,r,!1),n!==t)return e.stopImmediatePropagation(),e.preventDefault(),t}else n&&(_.set(this,r,ce.event.trigger(n[0],n.slice(1),this)),e.stopPropagation(),e.isImmediatePropagationStopped=Ne)}})):void 0===_.get(e,r)&&ce.event.add(e,r,Ne)}ce.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.get(t);if($(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&ce.find.matchesSelector(J,i),n.guid||(n.guid=ce.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof ce&&ce.event.triggered!==e.type?ce.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(D)||[""]).length;while(l--)d=g=(s=De.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=ce.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=ce.event.special[d]||{},c=ce.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&ce.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),ce.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=_.hasData(e)&&_.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(D)||[""]).length;while(l--)if(d=g=(s=De.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=ce.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||ce.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)ce.event.remove(e,d+t[l],n,r,!0);ce.isEmptyObject(u)&&_.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=ce.event.fix(e),l=(_.get(this,"events")||Object.create(null))[u.type]||[],c=ce.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=ce.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((ce.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<ce(i,this).index(l):ce.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(ce.Event.prototype,t,{enumerable:!0,configurable:!0,get:v(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[ce.expando]?e:new ce.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click",!0),!1},trigger:function(e){var t=this||e;return we.test(t.type)&&t.click&&fe(t,"input")&&He(t,"click"),!0},_default:function(e){var t=e.target;return we.test(t.type)&&t.click&&fe(t,"input")&&_.get(t,"click")||fe(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},ce.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},ce.Event=function(e,t){if(!(this instanceof ce.Event))return new ce.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?Ne:qe,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&ce.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[ce.expando]=!0},ce.Event.prototype={constructor:ce.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=Ne,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=Ne,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=Ne,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},ce.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},ce.event.addProp),ce.each({focus:"focusin",blur:"focusout"},function(r,i){function o(e){if(C.documentMode){var t=_.get(this,"handle"),n=ce.event.fix(e);n.type="focusin"===e.type?"focus":"blur",n.isSimulated=!0,t(e),n.target===n.currentTarget&&t(n)}else ce.event.simulate(i,e.target,ce.event.fix(e))}ce.event.special[r]={setup:function(){var e;if(He(this,r,!0),!C.documentMode)return!1;(e=_.get(this,i))||this.addEventListener(i,o),_.set(this,i,(e||0)+1)},trigger:function(){return He(this,r),!0},teardown:function(){var e;if(!C.documentMode)return!1;(e=_.get(this,i)-1)?_.set(this,i,e):(this.removeEventListener(i,o),_.remove(this,i))},_default:function(e){return _.get(e.target,r)},delegateType:i},ce.event.special[i]={setup:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i);n||(C.documentMode?this.addEventListener(i,o):e.addEventListener(r,o,!0)),_.set(t,i,(n||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=C.documentMode?this:e,n=_.get(t,i)-1;n?_.set(t,i,n):(C.documentMode?this.removeEventListener(i,o):e.removeEventListener(r,o,!0),_.remove(t,i))}}}),ce.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){ce.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||ce.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),ce.fn.extend({on:function(e,t,n,r){return Le(this,e,t,n,r)},one:function(e,t,n,r){return Le(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,ce(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=qe),this.each(function(){ce.event.remove(this,e,n,t)})}});var Oe=/<script|<style|<link/i,Pe=/checked\s*(?:[^=]|=\s*.checked.)/i,Me=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function Re(e,t){return fe(e,"table")&&fe(11!==t.nodeType?t:t.firstChild,"tr")&&ce(e).children("tbody")[0]||e}function Ie(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function We(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Fe(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(_.hasData(e)&&(s=_.get(e).events))for(i in _.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)ce.event.add(t,i,s[i][n]);z.hasData(e)&&(o=z.access(e),a=ce.extend({},o),z.set(t,a))}}function $e(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=v(d);if(h||1<f&&"string"==typeof d&&!le.checkClone&&Pe.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),$e(t,r,i,o)});if(f&&(t=(e=Ae(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=ce.map(Se(e,"script"),Ie)).length;c<f;c++)u=e,c!==p&&(u=ce.clone(u,!0,!0),s&&ce.merge(a,Se(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,ce.map(a,We),c=0;c<s;c++)u=a[c],Ce.test(u.type||"")&&!_.access(u,"globalEval")&&ce.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?ce._evalUrl&&!u.noModule&&ce._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):m(u.textContent.replace(Me,""),u,l))}return n}function Be(e,t,n){for(var r,i=t?ce.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||ce.cleanData(Se(r)),r.parentNode&&(n&&K(r)&&Ee(Se(r,"script")),r.parentNode.removeChild(r));return e}ce.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=K(e);if(!(le.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||ce.isXMLDoc(e)))for(a=Se(c),r=0,i=(o=Se(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&we.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||Se(e),a=a||Se(c),r=0,i=o.length;r<i;r++)Fe(o[r],a[r]);else Fe(e,c);return 0<(a=Se(c,"script")).length&&Ee(a,!f&&Se(e,"script")),c},cleanData:function(e){for(var t,n,r,i=ce.event.special,o=0;void 0!==(n=e[o]);o++)if($(n)){if(t=n[_.expando]){if(t.events)for(r in t.events)i[r]?ce.event.remove(n,r):ce.removeEvent(n,r,t.handle);n[_.expando]=void 0}n[z.expando]&&(n[z.expando]=void 0)}}}),ce.fn.extend({detach:function(e){return Be(this,e,!0)},remove:function(e){return Be(this,e)},text:function(e){return M(this,function(e){return void 0===e?ce.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return $e(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Re(this,e).appendChild(e)})},prepend:function(){return $e(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Re(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return $e(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(ce.cleanData(Se(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return ce.clone(this,e,t)})},html:function(e){return M(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!Oe.test(e)&&!ke[(Te.exec(e)||["",""])[1].toLowerCase()]){e=ce.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(ce.cleanData(Se(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return $e(this,arguments,function(e){var t=this.parentNode;ce.inArray(this,n)<0&&(ce.cleanData(Se(this)),t&&t.replaceChild(e,this))},n)}}),ce.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){ce.fn[e]=function(e){for(var t,n=[],r=ce(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),ce(r[o])[a](t),s.apply(n,t.get());return this.pushStack(n)}});var _e=new RegExp("^("+G+")(?!px)[a-z%]+$","i"),ze=/^--/,Xe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=ie),t.getComputedStyle(e)},Ue=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ve=new RegExp(Q.join("|"),"i");function Ge(e,t,n){var r,i,o,a,s=ze.test(t),u=e.style;return(n=n||Xe(e))&&(a=n.getPropertyValue(t)||n[t],s&&a&&(a=a.replace(ve,"$1")||void 0),""!==a||K(e)||(a=ce.style(e,t)),!le.pixelBoxStyles()&&_e.test(a)&&Ve.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function Ye(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",J.appendChild(u).appendChild(l);var e=ie.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),J.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=C.createElement("div"),l=C.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",le.clearCloneStyle="content-box"===l.style.backgroundClip,ce.extend(le,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=C.createElement("table"),t=C.createElement("tr"),n=C.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="box-sizing:content-box;border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",J.appendChild(e).appendChild(t).appendChild(n),r=ie.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,J.removeChild(e)),a}}))}();var Qe=["Webkit","Moz","ms"],Je=C.createElement("div").style,Ke={};function Ze(e){var t=ce.cssProps[e]||Ke[e];return t||(e in Je?e:Ke[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Qe.length;while(n--)if((e=Qe[n]+t)in Je)return e}(e)||e)}var et=/^(none|table(?!-c[ea]).+)/,tt={position:"absolute",visibility:"hidden",display:"block"},nt={letterSpacing:"0",fontWeight:"400"};function rt(e,t,n){var r=Y.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function it(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0,l=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(l+=ce.css(e,n+Q[a],!0,i)),r?("content"===n&&(u-=ce.css(e,"padding"+Q[a],!0,i)),"margin"!==n&&(u-=ce.css(e,"border"+Q[a]+"Width",!0,i))):(u+=ce.css(e,"padding"+Q[a],!0,i),"padding"!==n?u+=ce.css(e,"border"+Q[a]+"Width",!0,i):s+=ce.css(e,"border"+Q[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u+l}function ot(e,t,n){var r=Xe(e),i=(!le.boxSizingReliable()||n)&&"border-box"===ce.css(e,"boxSizing",!1,r),o=i,a=Ge(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(_e.test(a)){if(!n)return a;a="auto"}return(!le.boxSizingReliable()&&i||!le.reliableTrDimensions()&&fe(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===ce.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===ce.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+it(e,t,n||(i?"border":"content"),o,r,a)+"px"}function at(e,t,n,r,i){return new at.prototype.init(e,t,n,r,i)}ce.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ge(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=F(t),u=ze.test(t),l=e.style;if(u||(t=Ze(s)),a=ce.cssHooks[t]||ce.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=Y.exec(n))&&i[1]&&(n=te(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(ce.cssNumber[s]?"":"px")),le.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=F(t);return ze.test(t)||(t=Ze(s)),(a=ce.cssHooks[t]||ce.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ge(e,t,r)),"normal"===i&&t in nt&&(i=nt[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),ce.each(["height","width"],function(e,u){ce.cssHooks[u]={get:function(e,t,n){if(t)return!et.test(ce.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ot(e,u,n):Ue(e,tt,function(){return ot(e,u,n)})},set:function(e,t,n){var r,i=Xe(e),o=!le.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===ce.css(e,"boxSizing",!1,i),s=n?it(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-it(e,u,"border",!1,i)-.5)),s&&(r=Y.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=ce.css(e,u)),rt(0,t,s)}}}),ce.cssHooks.marginLeft=Ye(le.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ge(e,"marginLeft"))||e.getBoundingClientRect().left-Ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),ce.each({margin:"",padding:"",border:"Width"},function(i,o){ce.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+Q[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(ce.cssHooks[i+o].set=rt)}),ce.fn.extend({css:function(e,t){return M(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Xe(e),i=t.length;a<i;a++)o[t[a]]=ce.css(e,t[a],!1,r);return o}return void 0!==n?ce.style(e,t,n):ce.css(e,t)},e,t,1<arguments.length)}}),((ce.Tween=at).prototype={constructor:at,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||ce.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(ce.cssNumber[n]?"":"px")},cur:function(){var e=at.propHooks[this.prop];return e&&e.get?e.get(this):at.propHooks._default.get(this)},run:function(e){var t,n=at.propHooks[this.prop];return this.options.duration?this.pos=t=ce.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):at.propHooks._default.set(this),this}}).init.prototype=at.prototype,(at.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=ce.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){ce.fx.step[e.prop]?ce.fx.step[e.prop](e):1!==e.elem.nodeType||!ce.cssHooks[e.prop]&&null==e.elem.style[Ze(e.prop)]?e.elem[e.prop]=e.now:ce.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=at.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},ce.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},ce.fx=at.prototype.init,ce.fx.step={};var st,ut,lt,ct,ft=/^(?:toggle|show|hide)$/,pt=/queueHooks$/;function dt(){ut&&(!1===C.hidden&&ie.requestAnimationFrame?ie.requestAnimationFrame(dt):ie.setTimeout(dt,ce.fx.interval),ce.fx.tick())}function ht(){return ie.setTimeout(function(){st=void 0}),st=Date.now()}function gt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=Q[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function vt(e,t,n){for(var r,i=(yt.tweeners[t]||[]).concat(yt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function yt(o,e,t){var n,a,r=0,i=yt.prefilters.length,s=ce.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=st||ht(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:ce.extend({},e),opts:ce.extend(!0,{specialEasing:{},easing:ce.easing._default},t),originalProperties:e,originalOptions:t,startTime:st||ht(),duration:t.duration,tweens:[],createTween:function(e,t){var n=ce.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=F(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=ce.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=yt.prefilters[r].call(l,o,c,l.opts))return v(n.stop)&&(ce._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return ce.map(c,vt,l),v(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),ce.fx.timer(ce.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}ce.Animation=ce.extend(yt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return te(n.elem,e,Y.exec(t),n),n}]},tweener:function(e,t){v(e)?(t=e,e=["*"]):e=e.match(D);for(var n,r=0,i=e.length;r<i;r++)n=e[r],yt.tweeners[n]=yt.tweeners[n]||[],yt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ee(e),v=_.get(e,"fxshow");for(r in n.queue||(null==(a=ce._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,ce.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ft.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||ce.style(e,r)}if((u=!ce.isEmptyObject(t))||!ce.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=_.get(e,"display")),"none"===(c=ce.css(e,"display"))&&(l?c=l:(re([e],!0),l=e.style.display||l,c=ce.css(e,"display"),re([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===ce.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=_.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&re([e],!0),p.done(function(){for(r in g||re([e]),_.remove(e,"fxshow"),d)ce.style(e,r,d[r])})),u=vt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?yt.prefilters.unshift(e):yt.prefilters.push(e)}}),ce.speed=function(e,t,n){var r=e&&"object"==typeof e?ce.extend({},e):{complete:n||!n&&t||v(e)&&e,duration:e,easing:n&&t||t&&!v(t)&&t};return ce.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in ce.fx.speeds?r.duration=ce.fx.speeds[r.duration]:r.duration=ce.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){v(r.old)&&r.old.call(this),r.queue&&ce.dequeue(this,r.queue)},r},ce.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ee).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=ce.isEmptyObject(t),o=ce.speed(e,n,r),a=function(){var e=yt(this,ce.extend({},t),o);(i||_.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=ce.timers,r=_.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&pt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||ce.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=_.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=ce.timers,o=n?n.length:0;for(t.finish=!0,ce.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),ce.each(["toggle","show","hide"],function(e,r){var i=ce.fn[r];ce.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(gt(r,!0),e,t,n)}}),ce.each({slideDown:gt("show"),slideUp:gt("hide"),slideToggle:gt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){ce.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),ce.timers=[],ce.fx.tick=function(){var e,t=0,n=ce.timers;for(st=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||ce.fx.stop(),st=void 0},ce.fx.timer=function(e){ce.timers.push(e),ce.fx.start()},ce.fx.interval=13,ce.fx.start=function(){ut||(ut=!0,dt())},ce.fx.stop=function(){ut=null},ce.fx.speeds={slow:600,fast:200,_default:400},ce.fn.delay=function(r,e){return r=ce.fx&&ce.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=ie.setTimeout(e,r);t.stop=function(){ie.clearTimeout(n)}})},lt=C.createElement("input"),ct=C.createElement("select").appendChild(C.createElement("option")),lt.type="checkbox",le.checkOn=""!==lt.value,le.optSelected=ct.selected,(lt=C.createElement("input")).value="t",lt.type="radio",le.radioValue="t"===lt.value;var mt,xt=ce.expr.attrHandle;ce.fn.extend({attr:function(e,t){return M(this,ce.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){ce.removeAttr(this,e)})}}),ce.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?ce.prop(e,t,n):(1===o&&ce.isXMLDoc(e)||(i=ce.attrHooks[t.toLowerCase()]||(ce.expr.match.bool.test(t)?mt:void 0)),void 0!==n?null===n?void ce.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=ce.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!le.radioValue&&"radio"===t&&fe(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(D);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),mt={set:function(e,t,n){return!1===t?ce.removeAttr(e,n):e.setAttribute(n,n),n}},ce.each(ce.expr.match.bool.source.match(/\w+/g),function(e,t){var a=xt[t]||ce.find.attr;xt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=xt[o],xt[o]=r,r=null!=a(e,t,n)?o:null,xt[o]=i),r}});var bt=/^(?:input|select|textarea|button)$/i,wt=/^(?:a|area)$/i;function Tt(e){return(e.match(D)||[]).join(" ")}function Ct(e){return e.getAttribute&&e.getAttribute("class")||""}function kt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(D)||[]}ce.fn.extend({prop:function(e,t){return M(this,ce.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[ce.propFix[e]||e]})}}),ce.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&ce.isXMLDoc(e)||(t=ce.propFix[t]||t,i=ce.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=ce.find.attr(e,"tabindex");return t?parseInt(t,10):bt.test(e.nodeName)||wt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),le.optSelected||(ce.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),ce.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){ce.propFix[this.toLowerCase()]=this}),ce.fn.extend({addClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).addClass(t.call(this,e,Ct(this)))}):(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return v(t)?this.each(function(e){ce(this).removeClass(t.call(this,e,Ct(this)))}):arguments.length?(e=kt(t)).length?this.each(function(){if(r=Ct(this),n=1===this.nodeType&&" "+Tt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=Tt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return v(t)?this.each(function(e){ce(this).toggleClass(t.call(this,e,Ct(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=kt(t),this.each(function(){if(s)for(o=ce(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=Ct(this))&&_.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":_.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+Tt(Ct(n))+" ").indexOf(t))return!0;return!1}});var St=/\r/g;ce.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=v(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,ce(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=ce.map(t,function(e){return null==e?"":e+""})),(r=ce.valHooks[this.type]||ce.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=ce.valHooks[t.type]||ce.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(St,""):null==e?"":e:void 0}}),ce.extend({valHooks:{option:{get:function(e){var t=ce.find.attr(e,"value");return null!=t?t:Tt(ce.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!fe(n.parentNode,"optgroup"))){if(t=ce(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=ce.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<ce.inArray(ce.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),ce.each(["radio","checkbox"],function(){ce.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<ce.inArray(ce(e).val(),t)}},le.checkOn||(ce.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Et=ie.location,jt={guid:Date.now()},At=/\?/;ce.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new ie.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||ce.error("Invalid XML: "+(n?ce.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Dt=/^(?:focusinfocus|focusoutblur)$/,Nt=function(e){e.stopPropagation()};ce.extend(ce.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||C],d=ue.call(e,"type")?e.type:e,h=ue.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||C,3!==n.nodeType&&8!==n.nodeType&&!Dt.test(d+ce.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[ce.expando]?e:new ce.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:ce.makeArray(t,[e]),c=ce.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!y(n)){for(s=c.delegateType||d,Dt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||C)&&p.push(a.defaultView||a.parentWindow||ie)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(_.get(o,"events")||Object.create(null))[e.type]&&_.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&$(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!$(n)||u&&v(n[d])&&!y(n)&&((a=n[u])&&(n[u]=null),ce.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Nt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Nt),ce.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=ce.extend(new ce.Event,n,{type:e,isSimulated:!0});ce.event.trigger(r,null,t)}}),ce.fn.extend({trigger:function(e,t){return this.each(function(){ce.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return ce.event.trigger(e,t,n,!0)}});var qt=/\[\]$/,Lt=/\r?\n/g,Ht=/^(?:submit|button|image|reset|file)$/i,Ot=/^(?:input|select|textarea|keygen)/i;function Pt(n,e,r,i){var t;if(Array.isArray(e))ce.each(e,function(e,t){r||qt.test(n)?i(n,t):Pt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==x(e))i(n,e);else for(t in e)Pt(n+"["+t+"]",e[t],r,i)}ce.param=function(e,t){var n,r=[],i=function(e,t){var n=v(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!ce.isPlainObject(e))ce.each(e,function(){i(this.name,this.value)});else for(n in e)Pt(n,e[n],t,i);return r.join("&")},ce.fn.extend({serialize:function(){return ce.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=ce.prop(this,"elements");return e?ce.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!ce(this).is(":disabled")&&Ot.test(this.nodeName)&&!Ht.test(e)&&(this.checked||!we.test(e))}).map(function(e,t){var n=ce(this).val();return null==n?null:Array.isArray(n)?ce.map(n,function(e){return{name:t.name,value:e.replace(Lt,"\r\n")}}):{name:t.name,value:n.replace(Lt,"\r\n")}}).get()}});var Mt=/%20/g,Rt=/#.*$/,It=/([?&])_=[^&]*/,Wt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ft=/^(?:GET|HEAD)$/,$t=/^\/\//,Bt={},_t={},zt="*/".concat("*"),Xt=C.createElement("a");function Ut(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(D)||[];if(v(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Vt(t,i,o,a){var s={},u=t===_t;function l(e){var r;return s[e]=!0,ce.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Gt(e,t){var n,r,i=ce.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&ce.extend(!0,e,r),e}Xt.href=Et.href,ce.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":zt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":ce.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Gt(Gt(e,ce.ajaxSettings),t):Gt(ce.ajaxSettings,e)},ajaxPrefilter:Ut(Bt),ajaxTransport:Ut(_t),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=ce.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?ce(y):ce.event,x=ce.Deferred(),b=ce.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Wt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace($t,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(D)||[""],null==v.crossDomain){r=C.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Xt.protocol+"//"+Xt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=ce.param(v.data,v.traditional)),Vt(Bt,v,t,T),h)return T;for(i in(g=ce.event&&v.global)&&0==ce.active++&&ce.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Ft.test(v.type),f=v.url.replace(Rt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Mt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(At.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(It,"$1"),o=(At.test(f)?"&":"?")+"_="+jt.guid+++o),v.url=f+o),v.ifModified&&(ce.lastModified[f]&&T.setRequestHeader("If-Modified-Since",ce.lastModified[f]),ce.etag[f]&&T.setRequestHeader("If-None-Match",ce.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+zt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Vt(_t,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=ie.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&ie.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<ce.inArray("script",v.dataTypes)&&ce.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(ce.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(ce.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--ce.active||ce.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return ce.get(e,t,n,"json")},getScript:function(e,t){return ce.get(e,void 0,t,"script")}}),ce.each(["get","post"],function(e,i){ce[i]=function(e,t,n,r){return v(t)&&(r=r||n,n=t,t=void 0),ce.ajax(ce.extend({url:e,type:i,dataType:r,data:t,success:n},ce.isPlainObject(e)&&e))}}),ce.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),ce._evalUrl=function(e,t,n){return ce.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){ce.globalEval(e,t,n)}})},ce.fn.extend({wrapAll:function(e){var t;return this[0]&&(v(e)&&(e=e.call(this[0])),t=ce(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return v(n)?this.each(function(e){ce(this).wrapInner(n.call(this,e))}):this.each(function(){var e=ce(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=v(t);return this.each(function(e){ce(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){ce(this).replaceWith(this.childNodes)}),this}}),ce.expr.pseudos.hidden=function(e){return!ce.expr.pseudos.visible(e)},ce.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},ce.ajaxSettings.xhr=function(){try{return new ie.XMLHttpRequest}catch(e){}};var Yt={0:200,1223:204},Qt=ce.ajaxSettings.xhr();le.cors=!!Qt&&"withCredentials"in Qt,le.ajax=Qt=!!Qt,ce.ajaxTransport(function(i){var o,a;if(le.cors||Qt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Yt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&ie.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),ce.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),ce.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return ce.globalEval(e),e}}}),ce.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),ce.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=ce("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),C.head.appendChild(r[0])},abort:function(){i&&i()}}});var Jt,Kt=[],Zt=/(=)\?(?=&|$)|\?\?/;ce.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Kt.pop()||ce.expando+"_"+jt.guid++;return this[e]=!0,e}}),ce.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Zt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Zt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=v(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Zt,"$1"+r):!1!==e.jsonp&&(e.url+=(At.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||ce.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=ie[r],ie[r]=function(){o=arguments},n.always(function(){void 0===i?ce(ie).removeProp(r):ie[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Kt.push(r)),o&&v(i)&&i(o[0]),o=i=void 0}),"script"}),le.createHTMLDocument=((Jt=C.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Jt.childNodes.length),ce.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(le.createHTMLDocument?((r=(t=C.implementation.createHTMLDocument("")).createElement("base")).href=C.location.href,t.head.appendChild(r)):t=C),o=!n&&[],(i=w.exec(e))?[t.createElement(i[1])]:(i=Ae([e],t,o),o&&o.length&&ce(o).remove(),ce.merge([],i.childNodes)));var r,i,o},ce.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Tt(e.slice(s)),e=e.slice(0,s)),v(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&ce.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?ce("<div>").append(ce.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},ce.expr.pseudos.animated=function(t){return ce.grep(ce.timers,function(e){return t===e.elem}).length},ce.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=ce.css(e,"position"),c=ce(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=ce.css(e,"top"),u=ce.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),v(t)&&(t=t.call(e,n,ce.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},ce.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){ce.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===ce.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===ce.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=ce(e).offset()).top+=ce.css(e,"borderTopWidth",!0),i.left+=ce.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-ce.css(r,"marginTop",!0),left:t.left-i.left-ce.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===ce.css(e,"position"))e=e.offsetParent;return e||J})}}),ce.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;ce.fn[t]=function(e){return M(this,function(e,t,n){var r;if(y(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),ce.each(["top","left"],function(e,n){ce.cssHooks[n]=Ye(le.pixelPosition,function(e,t){if(t)return t=Ge(e,n),_e.test(t)?ce(e).position()[n]+"px":t})}),ce.each({Height:"height",Width:"width"},function(a,s){ce.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){ce.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return M(this,function(e,t,n){var r;return y(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?ce.css(e,t,i):ce.style(e,t,n,i)},s,n?e:void 0,n)}})}),ce.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){ce.fn[t]=function(e){return this.on(t,e)}}),ce.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.on("mouseenter",e).on("mouseleave",t||e)}}),ce.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){ce.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var en=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;ce.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),v(e))return r=ae.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(ae.call(arguments)))}).guid=e.guid=e.guid||ce.guid++,i},ce.holdReady=function(e){e?ce.readyWait++:ce.ready(!0)},ce.isArray=Array.isArray,ce.parseJSON=JSON.parse,ce.nodeName=fe,ce.isFunction=v,ce.isWindow=y,ce.camelCase=F,ce.type=x,ce.now=Date.now,ce.isNumeric=function(e){var t=ce.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},ce.trim=function(e){return null==e?"":(e+"").replace(en,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return ce});var tn=ie.jQuery,nn=ie.$;return ce.noConflict=function(e){return ie.$===ce&&(ie.$=nn),e&&ie.jQuery===ce&&(ie.jQuery=tn),ce},"undefined"==typeof e&&(ie.jQuery=ie.$=ce),ce});
"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,o,i,s=[],c=!0,l=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw a}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:String(e)}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);n=n.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var n,r,a,o,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return r=!(n=!0),{s:function(){i=i.call(e)},n:function(){var e=i.next();return n=e.done,e},e:function(e){r=!0,a=e},f:function(){try{n||null==i.return||i.return()}finally{if(r)throw a}}};if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}define("engine",["jquery","utils","state","section","passages"],function(N,j,P,R,I){var t,V=j.impossible,M=j.passageSelector,D=j.transitionOut,F=j.options;function L(e,t,n){var r,a,o;if(n?(n=n.get("name"),(a=I.getTree(n)).children.length&&(r={type:"include",tag:t,name:n,children:a.children,text:a.text})):r=I.getTree(t),r){for(;(o=e[e.length-1])&&("root"===o.type||"include"===o.type)&&o.children.some(function(e){return e.type.startsWith("unclosed")});)e[e.length-1]=Object.create(o),e=e[e.length-1].children=o.children.slice();e.push(r)}}function n(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=n.loadedGame,a=I.get(e),o=j.storyElement,i=o.parent(),s=n.stretch,n=n.transition,n=void 0===n?{}:n,c=n.depart,c=void 0===c?"instant":c,l=n.arrive,l=void 0===l?"dissolve":l,u=n.departOrigin,p=n.arriveOrigin,n=n.time,d=(i.findAndFilter("tw-enchantment").each(function(e,t){var n=(t=N(t)).data("enchantedProperties");n&&o.css(n.reduce(function(e,t){return e[t]="",e},{})),t[0]===i[0]&&(i=o.unwrap().parent())}),I.hasValid(e)||V("Engine.showPassage","There's no passage with the name \""+e+'"!'),o.children(M).not(".transition-out, .transition-out *")),a=(a.get("tags")||[]).join(" "),f=(t=N("<tw-passage><tw-sidebar>"),f=t.children("tw-sidebar"),h=N('<tw-icon tabindex=0 alt="Undo" title="Undo">&#8630;</tw-icon>'),g=N('<tw-icon tabindex=0 alt="Redo" title="Redo">&#8631;</tw-icon>'),P.pastLength<=0&&h.css("visibility","hidden"),P.futureLength<=0&&g.css("visibility","hidden"),f.append(h,g),t),h=("function"==typeof u&&(u=u.call(d)),"function"==typeof p&&(p=p.call(f)),!s&&c),m=h&&d.css("width"),g=(j.detachStoryElement(),f.appendTo(o).attr({tags:a}),h&&(D(d,c,n,0,0,0,u),d.css({position:"absolute",width:function(){return"0px"!==m?m:"100%"}})),o.attr({tags:a}),R.create(f)),y=(r&&(g.loadedGame=!0),[]);if(P.pastLength<=0&&1===P.turns){var b,v=_createForOfIteratorHelper(I.getTagged("startup"));try{for(v.s();!(b=v.n()).done;)L(y,"startup",b.value)}catch(e){v.e(e)}finally{v.f()}if(F.debug){var w,k=_createForOfIteratorHelper(I.getTagged("debug-startup"));try{for(k.s();!(w=k.n()).done;)L(y,"debug-startup",w.value)}catch(e){k.e(e)}finally{k.f()}}}var S,T=_createForOfIteratorHelper(I.getTagged("header"));try{for(T.s();!(S=T.n()).done;)L(y,"header",S.value)}catch(e){T.e(e)}finally{T.f()}if(F.debug){var _,x=_createForOfIteratorHelper(I.getTagged("debug-header"));try{for(x.s();!(_=x.n()).done;)L(y,"debug-header",_.value)}catch(e){x.e(e)}finally{x.f()}}L(y,e);var O,A=_createForOfIteratorHelper(I.getTagged("footer"));try{for(A.s();!(O=A.n()).done;)L(y,"footer",O.value)}catch(e){A.e(e)}finally{A.f()}if(F.debug){var C,E=_createForOfIteratorHelper(I.getTagged("debug-footer"));try{for(E.s();!(C=E.n()).done;)L(y,"debug-footer",C.value)}catch(e){E.e(e)}finally{E.f()}}g.renderInto(y,f,{transition:l,transitionTime:n,transitionOrigin:p}),g.loadedGame=!1,j.reattachStoryElement(),scroll(0,s?f.offset().top-.05*N(window).height():o[0].getBoundingClientRect().top+document.body.scrollTop)}return Object.freeze({goBack:function(e){P.rewind()&&n(P.passage,e)},goForward:function(e){P.fastForward()&&n(P.passage,e)},goToPassage:function(e,t){P.play(e),n(e,t)},redirect:function(e,t){P.redirect(e),n(e,t)},toggleFullscreen:function(){var e=document.documentElement;document.fullscreenElement?document.exitFullscreen():document.msFullscreenElement?document.msExitFullscreen():(e.msRequestFullscreen||e.requestFullscreen).call(e)},showPassage:n,enableDebugMode:function(){t&&t()},registerDebugMode:function(e){t=t||e}})}),define("harlowe",["jquery","debugmode/mode","renderer","state","section","engine","passages","utils","utils/renderutils","internaltypes/varscope","internaltypes/twineerror","macros","macrolib/values","macrolib/commands","macrolib/datastructures","macrolib/stylechangers","macrolib/enchantments","macrolib/metadata","macrolib/patterns","macrolib/links","macrolib/custommacros","utils/jqueryplugins","repl"],function($,DebugMode,Renderer,State,Section,Engine,Passages,Utils,_ref,VarScope){var dialog=_ref.dialog;function __HarloweEval(text){eval(text+"")}function printJSError(e){var t,n="".concat(e.name,": ").concat(e.message);return e.stack&&(t=(e=e.stack.split("\n")).findIndex(function(e){return e.includes("__HarloweEval")}),n+="\n".concat(e.slice(0,t).join("\n").replace(/\([^)]+\)/g,""))),"<div style='font-family:monospace;overflow-y:scroll;max-height:30vh'>```"+n+"```</div>"}!function(o){window.onerror=function(e,t,n,r,a){window.onerror=o,Utils.storyElement.parent().append(dialog({message:"Sorry to interrupt, but this page's code has got itself in a mess.\n\n".concat(printJSError(a),"\n(This is probably due to a bug in the Harlowe game engine.)")}).addClass("harlowe-crash")),"function"==typeof o&&o.apply(void 0,arguments)}}(window.onerror),Utils.onStartup(function(){var n,e,t,r,a=$("tw-storydata");0!==a.length&&(Utils.options.ifid=a.attr("ifid"),(a.attr("tags")||"").split(/\s/).forEach(function(e){"uncompressed-pure-values"!==e&&"uncompressed-saves"!==e||(Utils.options.uncompressedPureValues=!0),"uncompressed-structures"!==e&&"uncompressed-saves"!==e||(Utils.options.uncompressedStructures=!0)}),(a.attr("options")||"").split(/\s/).forEach(function(e){e&&(Utils.options[e]=!0),"debug"===e&&DebugMode()}),a=(a=a.attr("startnode"))||[].reduce.call($("tw-passagedata"),function(e,t){t=t.getAttribute("pid");return t<e?t:e},1/0),a=$("tw-passagedata[pid='"+a+"']").attr("name"),$(document.documentElement).on("keydown",function(e){13===e.which&&"0"===e.target.getAttribute("tabindex")&&$(e.target).trigger("click")}),n=!1,$("[role=script]").each(function(t){try{__HarloweEval($(this).html())}catch(e){n||(n=!0,dialog({parent:Utils.storyElement.parent(),message:"There is a problem with this story's "+Utils.nth(t+1)+" script:\n\n"+printJSError(e)}))}}),$("[role=stylesheet]").each(function(e,t){$(document.head).append("<style data-title=\"Story stylesheet '".concat(e+1,"'\">").concat($(t).html()))}),(e=Section.create()).stack=[{tempVariables:Object.create(VarScope)}],(r=Passages.loadMetadata(e)).length&&(t=dialog({parent:Utils.storyElement.parent(),message:"These errors occurred when running the `(metadata:)` macro calls in this story's passages:<p></p>"}),r.forEach(function(e){return t.find("p").append(e.render())})),(r=!Utils.options.debug&&State.hasSessionStorage&&sessionStorage.getItem("Saved Session"))&&!0===State.deserialise(e,r)?Engine.showPassage(State.passage):Engine.goToPassage(a))})}),define("macros",["utils/naturalsort","utils","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/lambda","datatypes/codehook","internaltypes/changedescriptor","internaltypes/twineerror"],function(g,e,t,o,r,y,b,p,v){var w=e.insensitiveName,k=e.nth,S=e.andList,T=t.objectName,_=t.typeName,d=t.toSource,x=Array.isArray,i={};function O(e){return e===s.TypeSignature.Any||(x(e.innerType)?e.innerType.some(O):!!e.innerType&&O(e.innerType))}function a(e,t,n,r){var a,o,i,s,c,l,u,p,d=t.fn,f=t.typeSignature,h=t.returnType,m=(r=function(e){for(var t,n,r,a=[],o=0;o<e.length;o+=1)o in e&&(!0===(null==(t=e[o])?void 0:t.spreader)?(n=t.value,(r=v.containsError(n))?a.push(r):x(n)||"string"==typeof n?a.push.apply(a,_toConsumableArray(n)):n instanceof Set?a.push.apply(a,_toConsumableArray(Array.from(n).sort(g("en")))):a.push(v.create("operation","I can't spread out "+T(n)+", because it is not a string, dataset, or array."))):a.push(t));return a}(r),"string"!=typeof e&&(a=e,e=""),a?"":"("+(x(e)&&1<e.length?e[0]:e)+":)");for(e=a?a.TwineScript_KnownName?"the custom macro, ".concat(a.TwineScript_KnownName):"an unnamed custom macro":"the ".concat(m," macro"),o=0<f.length?1===f.length&&O(f[0])?1===r.length?"That value can't be given to macros as-is.":"Give only a single value to this macro.":e+" must only be given "+S(f.map(_))+(1<f.length?", in that order":"."):e+" must not be given any data."+(a?"":" Just write "+m),s=0,c=Math.max(r.length,f.length);s<c;s+=1){if(p=f[s],l=r[s],v.containsError(l))return l;if(s>=f.length&&!i)return v.create("datatype",r.length-f.length+" too many values were given to "+e+".",o);if(!(p=p||i).innerType||"rest"!==p.pattern&&"zero or more"!==p.pattern||(i=p.innerType,"rest"===p.pattern&&(p=p.innerType)),!function e(t,n){if(null===n)return void 0===t;var r=_typeof(t);if("function"!=typeof n&&n.pattern){if("optional"===n.pattern||"zero or more"===n.pattern)return void 0===t||e(t,n.innerType);if("either"===n.pattern){for(var a=0;a<n.innerType.length;a+=1)if(e(t,n.innerType[a]))return!0;return!1}if("lambda"===n.pattern&&e(t,n.innerType))return n.clauses.includes("where")===("where"in t||"each"in t)&&n.clauses.includes("making")==="making"in t&&n.clauses.includes("via")==="via"in t&&n.clauses.includes("with")==="with"in t;if("insensitive set"===n.pattern)return n.innerType.includes(w(t));if("range"===n.pattern)return n.range(t);if("wrapped"===n.pattern)return e(t,n.innerType)}return(void 0===n||void 0!==t)&&("anything"===n.TwineScript_TypeName&&void 0!==t&&!t.TwineScript_Unstorable||"everything"===n.TwineScript_TypeName&&void 0!==t||(n===String?"string"===r:n===Boolean?"boolean"===r:n===parseInt?"number"===r&&!Number.isNaN(t)&&!(t+"").includes("."):n===Number?"number"===r&&!Number.isNaN(t):n===Array?x(t):n===Map||n===Set?t instanceof n:Object.isPrototypeOf.call(n,t)))}(l,p))return void 0===l?(u=f.filter(function(e){return!("optional"===e.pattern||"zero or more"===e.pattern)}).length,v.create("datatype","".concat(e," was given ").concat(r.length?S(r.map(T)):"nothing",", but needs ").concat(u-s," more value").concat(1<u-s?"s":"","."),o)):null!=(u=l)&&u.TwineScript_Unstorable&&O(p)?v.create("datatype",e+"'s "+k(s+1)+" value, "+T(l)+", is not valid data for this macro.",o):b.isPrototypeOf(l)&&"Changer"===h?v.create("syntax","Please put this hook outside the parentheses of "+e+", not inside it.","Hooks should appear after a macro"+(a?".":": "+m+"[Some text]")):l&&y.isPrototypeOf(l)&&"lambda"===p.pattern?v.create("datatype",e+"'s "+k(s+1)+" value (a lambda) should have "+S(["where","when","making","via","with"].filter(function(e){return p.clauses.includes(e)}).map(function(e){return"a '"+e+"' clause"}))+", not "+S(["where","when","making","via","with"].filter(function(e){return e in l}).map(function(e){return"a '"+e+"' clause"}))+"."):"insensitive set"===p.pattern?v.create("datatype",T(l)+" is not a valid name string for "+e+".","Only the following names are recognised (capitalisation and hyphens ignored): "+S(p.innerType)+"."):v.create("datatype","".concat(e,"'s ").concat(k(s+1)," value is ").concat(T(l),", but should be ").concat(_(p),"."),p.message||o)}return d.apply(null,[n].concat(r))}function f(e,t,n,r){var a={fn:n,typeSignature:r=[].concat(r||[]),returnType:t};Object.freeze(a),[].concat(e).forEach(function(e){return Object.defineProperty(i,w(e),{value:a})})}var s={has:function(e){return e=w(e),hasOwnProperty.call(i,e)},get:function(e){return e=w(e),hasOwnProperty.call(i,e)&&i[e]},add:function e(t,n,r,a){return f(t,n,r,a),e},addChanger:function e(t,n,r,a){return f(t,"Changer",n,a),o.register(x(t)?t[0]:t,r),e},addCommand:function e(t,n,r,a){var s,c,l,u,o=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],i=[].concat(t)[0];return f(t,"Command",(s=i,c=n,l=r,u=o,function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a,o,i=c.apply(void 0,n);return i||(a=p.create(),o=_objectSpread({TwineScript_TypeID:"command",TwineScript_ObjectName:"a (".concat(s,":) command"),TwineScript_TypeName:"a (".concat(s,":) command"),TwineScript_Print:function(){return"`[A (".concat(s,":) command]`")},TwineScript_ToSource:function(){return"(".concat(s,":").concat(n.map(d),")")},TwineScript_is:function(e){return d(this)===d(e)}},u?{TwineScript_Attach:function(e,t){return a.section=e,t.run(a),o},TwineScript_Run:function(e){e=l.apply(void 0,[a,e].concat(n));return a=p.create(),e}}:{TwineScript_Run:function(e){return l.apply(void 0,[e].concat(n))}}))}),a),e},TypeSignature:{optional:function(e){return{pattern:"optional",innerType:e}},zeroOrMore:function(e){return{pattern:"zero or more",innerType:e}},either:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"either",innerType:t}},rest:function(e){return{pattern:"rest",innerType:e}},insensitiveSet:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"insensitive set",innerType:t}},numberRange:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1/0;return{pattern:"range",min:t,max:n,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&t<=e&&e<=n}}},nonNegativeInteger:{pattern:"range",integer:!0,min:0,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&0<=e&&!(e+"").includes(".")}},positiveInteger:{pattern:"range",integer:!0,min:1,max:1/0,range:function(e){return"number"==typeof e&&!Number.isNaN(e)&&1<=e&&!(e+"").includes(".")}},wrapped:function(e,t){return{pattern:"wrapped",innerType:e,message:t}},Any:{TwineScript_TypeName:"anything"},Everything:{TwineScript_TypeName:"everything"}},run:function(e,t,n){return s.has(e)?a(e,s.get(e),t,n):v.create("macrocall","I can't run the macro '"+e+"' because it doesn't exist.","Did you mean to run a macro? If you have a word written like (this:), it is regarded as a macro name.")},runCustom:function(e,t,n){return r.isPrototypeOf(e)?a(e,e,t,n):v.containsError(e)?e:v.create("macrocall","I can't call ".concat(T(e)," because it isn't a custom macro."))}};return Object.assign(s.TypeSignature,{positiveNumber:s.TypeSignature.numberRange(Math.pow(2,-52),1/0),nonNegativeNumber:s.TypeSignature.numberRange(0,1/0),percent:s.TypeSignature.numberRange(0,1)}),Object.freeze(s)}),define("passages",["jquery","utils/naturalsort","utils","markup","internaltypes/twineerror"],function(t,s,e,c,l){var u=e.insensitiveName,p=e.unescape,n=e.onStartup,o=e.impossible,d=Object.assign,f=RegExp(c.Patterns.macroFront+c.Patterns.macroName,"ig");function r(e){var t,r,a,o,n=e.attr("name"),i=p(e.html()),s=(t=n,o=["metadata","storylet","exclusivity","urgency"],((s=i).match(f)||[]).some(function(t){return o.some(function(e){return u(t.slice(1,-1))===e})})?(r=!1,a={},c.lex(s,t).children.forEach(function e(t){if("macro"===t.type){var n=u(t.name);if(o.some(function(e){return n===e})){if(l.isPrototypeOf(a[n]))return;if(r)return void(a[n]=l.create("syntax","The (".concat(t.name,":) macro can't appear after non-metadata macros.")));if(a[n])return void(a[n]=l.create("syntax","There is more than one (".concat(t.name,":) macro.")));a[n]=t}else r=!0;t.children.forEach(function e(t){var n=u(t.name);"macro"===t.type&&o.some(function(e){return n===e})?a[n]=l.create("syntax","The (".concat(t.name,":) macro can't be inside another macro.")):t.children.forEach(e)})}else t.children.forEach(e)}),a):{});return d(new Map([["source",i],["tags",(e.attr("tags")||"").split(/\s/)||[]],["name",n]]),{TwineScript_TypeName:"a passage datamap",TwineScript_ObjectName:"a passage datamap",metadata:s,tree:null})}var a=Object.create(null),i=[],h=null,m=d(new Map,{TwineScript_ObjectName:"the Passages datamap",getTagged:function(n){var e,r;return a[n]||(e=s("en",function(e){return e.get("name")}),r=[],this.forEach(function(e){var t=e instanceof Map&&e.get("tags");Array.isArray(t)&&t.includes(n)&&r.push(e)}),r.sort(e),a[n]=r)},clearTagCache:function(){a=Object.create(null)},clear:function(){Map.prototype.clear.call(this),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},delete:function(){var e;(e=Map.prototype.delete).call.apply(e,[this].concat(Array.prototype.slice.call(arguments))),this.clearTagCache(),this.clearTreeCache(),this.clearStoryletCache()},getTree:function(e){if(!this.has(e))return o("Passages.getTree","No passage name?"),[];var t=this.get(e),n=t.get("tags");if(n.includes("header")||n.includes("footer")||n.includes("debug-header")||n.includes("debug-footer"))return t.tree||(t.tree=c.lex(t.get("source"),e)),t.tree;for(var r,a=0;a<i.length;a+=1)if(i[a]&&i[a].place===e)return r=i.splice(a,1)[0],i.unshift(r),r;n=c.lex(t.get("source"),e);return i.unshift(n),16<i.length&&i.pop(),n},clearTreeCache:function(){i=[]},getStorylets:function(r,e){var a,o,i,e=e?e.filter(r,_toConsumableArray(m.values())):_toConsumableArray(m.values());return l.containsError(e)?e:(a=[],o=-1/0,e.reduce(function(e,t){if(e)return e;e=t.get("storylet");if(e){var n=r.speculate(e,t.get("name"),"a (storylet:) macro");if(l.containsError(n))return n.message="There's an error in the storylet passage \""+t.get("name")+'":\n'+n.message,n.source=e.TwineScript_ToSource(),n;n&&(e=t.get("exclusivity"),o=Math.max(o,"number"==typeof e?e:0),a.push(t))}},void 0)||(i=s("en"),a.filter(function(e){e=e.get("exclusivity");return("number"==typeof e?e:0)===o}).sort(function(e,t){var n=e.get("urgency"),r=t.get("urgency");return(n="number"==typeof n?n:0)!==(r="number"==typeof r?r:0)?r-n:i(e.get("name"),t.get("name"))})))},allStorylets:function(){return h=h||_toConsumableArray(m.values()).filter(function(e){return e.get("storylet")})},clearStoryletCache:function(){h=null},loadMetadata:function(i){var s=[];return m.forEach(function(o){o.metadata&&Object.keys(o.metadata).forEach(function(e){var t,n,r;function a(e,t){o.has(e)?s.push(l.create("syntax","This passage's datamap already has a '"+JSON.stringify(e)+"' data name.")):o.set(e,t)}l.containsError(o.metadata[e])?s.push(o.metadata[e]):(t=o.metadata[e],n=i.speculate(t,o.get("name"),"a ("+e+":) macro"),r='In "'+o.get("name")+'":\n',l.containsError(n)?(n.message=r+n.message,n.source=t.text,s.push(n)):n instanceof Map?n.forEach(function(e,t){return a(t,e)}):a(e,n))}),o.metadata=void 0}),s},hasValid:function(e){e=this.get(e);return e&&e instanceof Map&&e.has("source")},create:r});return n(function(){t("tw-storydata > tw-passagedata").get().forEach(function(e){e=t(e),m.set(e.attr("name"),new r(e))})}),m}),define("renderer",["jquery","utils","markup","internaltypes/twineerror"],function(a,e,S,T){var _=e.escape,x=e.insensitiveName,O=e.options;function A(e,t,n){n=2<arguments.length&&void 0!==n?n:"";return"<"+t+(n?" "+n:"")+">"+e+"</"+t+">"}var C="text-align: center; max-width:50%; ";function E(m,g){function y(e,t,n){e=E(e.children,g);return e&&A(e,t,n)}var b="",v=[];if(m)for(var e,w=(m=Array.isArray(m)?m:[m]).length,k=0;k<w;k+=1)if(e=function(e){var n=m[e];switch(n.type){case"include":b+=y(n,"tw-"+n.type,'type="'.concat(n.tag,'" name="').concat(n.name,'"'));break;case"error":b+=T.create("syntax",n.message,n.explanation).render(_(n.text))[0].outerHTML;break;case"numbered":case"bulleted":for(var t="numbered"===n.type?"ol":"ul",r=(b+="<"+t+">",1);e<w&&m[e];){if("br"===m[e].type){if(b+="</li>",!m[e+1]||m[e+1].type!==n.type)break}else m[e].type===n.type?(b=(b+=("<"+t+">").repeat(Math.max(0,m[e].depth-r)))+("</"+t+">").repeat(Math.max(0,r-m[e].depth))+"<li>",r=m[e].depth):b+=E([m[e]],g);e+=1}b+=("</"+t+">").repeat(r+1);break;case"align":for(;n&&"align"===n.type;){var a=n.align,o=e+=1;if("left"===a){--e;break}for(;e<w&&m[e]&&"align"!==m[e].type;)e+=1;var o=E(m.slice(o,e),g),i="";switch(a){case"center":i+=C+"margin-left: auto; margin-right: auto;";break;case"justify":case"right":i+="text-align: "+a+";";break;default:+a&&(i+=C+"margin-left: "+a+"%;")}b+="<tw-align "+(i?'style="'+i+'"':"")+">"+o+"</tw-align>\n",n=m[e]}break;case"column":for(var s,c=[];n&&"column"===n.type;){var l=n.column,u=e+=1;if("none"===l){--e;break}for(;e<w&&m[e]&&"column"!==m[e].type;)e+=1;c.push({text:n.text,type:l,body:E(m.slice(u,e),g),width:n.width,marginLeft:n.marginLeft,marginRight:n.marginRight}),n=m[e]}c.length&&(s=c.reduce(function(e,t){return e+t.width},0),b+="<tw-columns>"+c.map(function(e){return"<tw-column type=".concat(e.type," ",' style="width:').concat(e.width/s*100,"%; margin-left: ").concat(e.marginLeft,"em; margin-right: ").concat(e.marginRight,'em;">').concat(e.body,"</tw-column>\n")}).join("")+"</tw-columns>");break;case"heading":for(b+="<h"+n.depth+">";++e<w&&m[e];){if("br"===m[e].type){b+="</h"+n.depth+">";break}b+=E([m[e]],g)}break;case"br":if(!v.length||/td|th/.test(v[0])){b+="<br>";for(var p=m[e+1];p&&("br"===p.type||"tag"===p.type&&/^<br\b/i.test(p.text));)b+="<tw-consecutive-br"+("tag"===p.type?" data-raw":"")+"></tw-consecutive-br>",p=m[(e+=1)+1]}break;case"hr":b+="<hr>";break;case"escapedLine":case"comment":break;case"inlineUrl":b+='<a class="link" href="'+_(n.text)+'">'+n.text+"</a>";break;case"scriptStyleTag":case"tag":var d=n.text.toLowerCase();/^<\/?(?:table|thead|tbody|tr|tfoot|td|th|svg)\b/.test(d)&&!n.text.endsWith("/>")&&v[n.text.startsWith("</")?"shift":"unshift"](d),b+=n.text.startsWith("</")?n.text:n.text.replace(/(\/)?>$/,function(e,t){return" data-raw".concat(t?"></".concat(n.text.match(/[\w-]+/)):"",">")});break;case"sub":case"sup":case"strong":case"em":b+=y(n,n.type);break;case"strike":b+=y(n,"s");break;case"bold":b+=y(n,"b");break;case"italic":b+=y(n,"i");break;case"twineLink":d=_slicedToArray(S.lex("(link-goto:"+JSON.stringify(n.innerText)+","+JSON.stringify(n.passage)+")").children,1)[0];b+='<tw-expression type="macro" name="link-goto"'+(O.debug?' title="'+_(n.text)+'"':"")+' code="'+g.code.length+'"></tw-expression>',g.code.push(d);break;case"hook":b+="<tw-hook "+(n.hidden?"hidden ":"")+(n.name?'name="'+x(n.name)+'"':"")+(O.debug&&n.name?' title="Hook: ?'+n.name+'"':"")+' source="'+g.source.length+'"></tw-hook>',g.source.push(n.children);break;case"unclosedHook":return b+="<tw-hook "+(n.hidden?"hidden ":"")+(n.name?'name="'+x(n.name)+'"':"")+'source="'+g.source.length+'"></tw-hook>',g.source.push(m.slice(e+1,w)),{v:b};case"verbatim":b+=A(_(n.innerText).replace(/\n/g,"<br>"),"tw-verbatim");break;case"collapsed":b+=y(n,"tw-collapsed");break;case"unclosedCollapsed":return{v:b+="<tw-collapsed>"+E(m.slice(e+1,w),g)+"</tw-collapsed>"};case"variable":case"tempVariable":case"macro":var f=[],h=[];if("macro"===n.type&&!function e(t){"string"!==t.type&&"hook"!==t.type&&t.children.every(e);var n=x(t.name);if("macro"!==t.type||"prompt"!==n&&"confirm"!==n){if("hook"===t.type&&!t.everyLeaf(function(e){return"error"!==e.type||(h.push(e),!1)}))return!1}else f.push(t);return!0}(n),h.length)return{v:T.create("syntax","This code hook's markup contained "+h.length+" error"+(h.length?"s":"")+":<br>\u2014"+h.map(function(e){return e.message}).join("<br>\u2014")).render(_(n.text))[0].outerHTML};d=f.map(function(e){return e.blockerTree=g.blockers.length,g.blockers.push(e),e.blockerTree});b+='<tw-expression type="'+n.type+'" name="'+_(n.name||n.text)+'"'+(O.debug?' title="'+_(n.text)+'"':"")+(d.length?' blockers="'+d+'"':"")+' code="'+g.code.length+'"></tw-expression>',g.code.push(n);break;default:b+=n.children&&n.children.length?E(n.children,g):n.text}k=e}(k))return e.v;return b}return Object.freeze({exec:function(e){var r={code:[],blockers:[],source:[]},e=E(e="string"==typeof e?S.lex(e).children:e,r),e=a(a.parseHTML(e,document,!0));return e.findAndFilter("script:not([src])").each(function(e,t){var n=t.getAttribute("type");n&&"text/javascript"!==n.toLowerCase()||t.setAttribute("type","application/x-harlowe")}),r.blockers=r.blockers.map(function(e){e.blockedValue=!0;e=Object.create(e);return e.blockedValue=!1,e}),e.findAndFilter("tw-expression[code]:not([data-raw]), tw-expression[blockers]:not([data-raw]), tw-hook[source]:not([data-raw])").each(function(e,t){var n;(t=a(t)).attr("blockers")&&(n=t.popAttr("blockers").split(",").map(function(e){return r.blockers[e]}),t.data("blockers",n)),t.attr("source")&&t.data("source",r.source[t.popAttr("source")]),t.attr("code")&&t.data("code",r.code[t.popAttr("code")])}),e}})}),define("repl",["utils","markup","section"],function(e,t,n){e.onStartup(function(){return setTimeout(function(){e.options.debug&&(window.REPL=function(e){e=n.create().eval(t.lex("(print:"+e+")"));return e.TwineScript_Run?e.TwineScript_Run().source:e},window.LEX=function(e){e=t.lex(e);return 1===e.length?e[0]:e})})})}),define("section",["jquery","utils","twinescript/runner","twinescript/operations","state","utils/operationutils","utils/renderutils","utils/scripttag","datatypes/changercommand","datatypes/colour","datatypes/lambda","datatypes/codehook","internaltypes/changedescriptor","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(p,f,a,u,r,e,t,i,d,h,o,m,g,y,b,v){var w=e.printBuiltinValue,k=e.objectName,S=e.typeID,T=e.isObject,s=t.collapse,_=Object.assign,x=Object.create,O=Object.keys;function A(e,t,n){if(t&&"object"===_typeof(t)&&d.isPrototypeOf(t)){var r=n.popData("source")||(null==(r=n[0].cachedData)?void 0:r.source),a=(null!=(a=n[0])&&a.cachedData&&(n[0].cachedData.source=void 0),n.data("originalSource",r),g.create({target:n,source:r,section:this,append:"append"})),o=t.run(a);if(b.containsError(o)&&e.replaceWith(o.render(e.attr("title"))),!this.renderInto(r,null,a))return o=f.insensitiveName(e.attr("name")),["if","elseif","unless","else","testfalse"].includes(o)&&(e.addClass("false"),"elseif"!==o)&&(this.stackTop.lastHookShown=!1),n.data("live")&&function(t,n,r){function a(e){p&&(d-=(e-p)*(f.options.debug&&void 0!==f.options.speedMultiplier?f.options.speedMultiplier:1)),p=e,0<d?requestAnimationFrame(a):(d=s,o())}var o,i=this,e=r.data("live"),s=e.delay,c=e.event,l=((n=_objectSpread(_objectSpread({},n),{},{append:"replace",transitionDeferred:!1,enabled:!0})).data=_objectSpread(_objectSpread({},n.data),{},{live:void 0}),r.data("originalSource")||""),u=this.stackTop.tempVariables,p=null,d=s;o=this.whenUnblocked.bind(this,function(){var e;i.inDOM()&&(e=null==c?void 0:c.filter(i,[!0],u),b.containsError(e)?e.render(i,t.attr("title")).replaceAll(t):c&&!e[0]?requestAnimationFrame(a):(i.renderInto(l,r,n,u),e||r.find("tw-expression[name='stop']").length||i.inDOM()&&requestAnimationFrame(a)))}),requestAnimationFrame(a)}.call(this,e,a,n),!0}else{if(!1===t)return o=n.popData("source")||(null==(r=n[0].cachedData)?void 0:r.source),null!=(a=n[0])&&a.cachedData&&(n[0].cachedData.source=void 0),o&&(n.cachedData&&(n.cachedData.source=void 0),n.data("originalSource",o),n.data("hidden",!0)),e.addClass("false"),!(this.stackTop.lastHookShown=!1);if(!0!==t)return!1}return this.stackTop.lastHookShown=!0}function C(e){var t,n,e=(e instanceof p?e[0]:e).nextSibling;return e&&(e instanceof Text&&!e.textContent.trim()||["br","tw-consecutive-br"].includes((e.tagName||"").toLowerCase()))?(t=(n=C(e)).whitespace,n=n.nextElem,{whitespace:p(e).add(t),nextElem:n}):{whitespace:p(),nextElem:p(e)}}function E(e){if(null!=e&&e.length)return p("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",e)}function c(e,t){var n=this.eval(t);e.append(E(this.evalReplay)),e.append(function(e,t){if(/a \((go-to|undo|redirect|restart):\) command/.exec(null==t?void 0:t.TwineScript_TypeName))return p("<tw-open-button goto label='GO'>").data("goto",{section:e,command:t})}(this,n)),this.stackTop.evaluateOnly&&n&&(d.isPrototypeOf(n)||"function"==typeof n.TwineScript_Run)&&(n=b.create("syntax","I can't work out what ".concat(this.stackTop.evaluateOnly," should evaluate to, because it contains a ").concat(d.isPrototypeOf(n)?"changer.":"command."),"Please rewrite this without putting changers or commands here."));var r=p();for(i=e;d.isPrototypeOf(n);){var a=C(i),o=a.whitespace;if((i=a.nextElem)[0]&&i[0].nodeType===Node.TEXT_NODE&&"+"===i[0].textContent.trim()){var i,a=i,s=C(a),c=s.whitespace;if((i=s.nextElem).is("tw-expression")){var s=i.popData("code")||(null==(s=i[0])||null==(s=s.cachedData)?void 0:s.code),l=(null!=(l=i[0])&&l.cachedData&&(i[0].cachedData.code=void 0),this.eval(s));if(b.containsError(l)){n=l;break}s=u["+"](n,l);p(o).add(a).add(c).remove(),n=b.containsError(s)?b.create("operation","I can't combine "+k(n)+" with "+k(l)+".","function"==typeof l.TwineScript_Run?"If you want to attach this changer to ".concat(k(l),", remove the + between them."):"Changers can only be added to other changers."):s;continue}}if(i.is("tw-expression")){c=i.popData("code")||(null==(a=i[0])||null==(a=a.cachedData)?void 0:a.code),s=(null!=(l=i[0])&&l.cachedData&&(i[0].cachedData.code=void 0),this.eval(c));if(i.append(E(this.evalReplay)),b.containsError(s)){n=s;break}if(s&&"object"===_typeof(s)&&"function"==typeof s.TwineScript_Attach){n=s.TwineScript_Attach(this,n);break}return d.isPrototypeOf(s)?void e.replaceWith(b.create("operation","Changers like (".concat(n.macroName,":) need to be combined using + between them."),"Place the + between the changer macros, or the variables holding them. The + is absent only between a changer and its attached hook or command.").render(e.attr("title"))):void e.replaceWith(b.create("operation","".concat(k(s)," can't have changers like (").concat(n.macroName,":) attached."),"Changers placed just before hooks, links and commands will attempt to attach, but in this case it didn't work.").render(e.attr("title")))}if(i.is("tw-hook")){o.remove(),r=i;break}n.macroName||f.impossible("Section.runExpression","changer has no macroName");a=e.attr("title")||"("+n.macroName+": ...)";return void e.replaceWith(b.create("syntax","The (".concat(n.macroName,":) changer should be stored in a variable or attached to a hook."),"Macros like this should appear before a hook: ".concat(a,"[Some text]")).render(e.attr("title")))}e.attr("return",S(n)),r=r.length?r:C(e).nextElem.filter("tw-hook"),(t=b.containsError(n))?e.replaceWith(t.render(e.attr("title")).append(E(this.evalReplay))):v.isPrototypeOf(n)?e.append(n.render()):n&&"function"==typeof n.TwineScript_Run?(n=n.TwineScript_Run(this),b.containsError(n)?e.replaceWith(n.render(e.attr("title"))):g.isPrototypeOf(n)?null!=(t=n.data)&&t.live?e.replaceWith(b.create("unimplemented","I currently can't attach (live:) or (event:) macros to commands - only hooks.").render(e.attr("title"))):(n.section=this,n.target=i,this.renderInto("",i,n)):T(n)&&n.blocked?(this.stackTop.blocked=n.blocked,e.data("code",{type:"macro",blockedValue:!0,text:e.attr("title")||"",start:0,end:(e.attr("title")||"").length})):n&&f.impossible("Section.runExpression","TwineScript_Run() returned a non-ChangeDescriptor ".concat(_typeof(n),': "').concat(n,'"'))):r.length&&A.call(this,e,n,r)||("string"==typeof n||"number"==typeof n||n instanceof Map||n instanceof Set||Array.isArray(n)||h.isPrototypeOf(n)||m.isPrototypeOf(n)||n&&"function"==typeof n.TwineScript_Print&&!d.isPrototypeOf(n)?(n=w(n),b.containsError(n)?e.replaceWith(n.render(e.attr("title"))):"string"==typeof n||Array.isArray(n)?this.renderInto(n,e):f.impossible("printBuiltinValue() produced a non-string non-array ".concat(_typeof(n)))):d.isPrototypeOf(n)||"boolean"==typeof n||f.impossible("Section.runExpression","The expression evaluated to an unknown value: ".concat(n)))}var l={add:[],remove:[]};return Object.preventExtensions({create:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:f.storyElement,n=_(x(this),{timestamp:Date.now(),dom:e,stack:[],enchantments:[],unblockCallbacks:[],freeVariables:null,evalReplay:null,loadedGame:!1,Identifiers:{TwineScript_Identifiers:!0,it:0,get time(){var e;return null!=(e=n.stackTop)&&e.evaluateOnly?b.create("operation","'time' can't be used in ".concat(n.stackTop.evaluateOnly,".")):(Date.now()-n.timestamp)*(f.options.debug&&void 0!==f.options.speedMultiplier?f.options.speedMultiplier:1)},get turns(){return r.turns},get turn(){return r.turns},get visits(){var t=n.stackTop.speculativePassage;return r.history().filter(function(e){return e===(t||r.passage)}).length+(!t||t===r.passage)},get visit(){return n.Identifiers.visits},get exits(){var e;return null!=(e=n.stackTop)&&e.evaluateOnly?b.create("operation","'exit' and 'exits' can't be used in ".concat(n.stackTop.evaluateOnly,".")):n.dom.find("tw-enchantment, tw-link").filter(function(e,t){return(t=p(t)).data("enchantmentEvent")||t.parent().data("linkPassageName")||t.parent().data("clickEvent")}).length},get exit(){return n.Identifiers.exits},get pos(){return n.stackTop&&!n.stackTop.evaluateOnly&&n.stackTop.lambdaPos?+n.stackTop.lambdaPos||1:b.create("operation","'pos' can only be used in lambdas that aren't 'when' lambdas.")}}});return n},eval:function(t){var e,n;f.options.debug&&f.options.evalReplay&&(n=Array.isArray(t)?t.reduce(function(e,t){return e+t.text},""):t.text||"",this.evalReplay=[{code:n,fromCode:n,basis:(Array.isArray(t)?t[0]:t).start,start:0,end:n.length,diff:0}]);try{e=a(this,t)}catch(e){return null!=(n=window.console)&&n.error(e),this.evalReplay=null,b.create("","An internal error occurred while trying to run ".concat([].concat(t).map(function(e){return e.text}).join(""),"."),'The error was "'.concat(e.message,'".\nIf this is the latest version of Harlowe, please consider reporting a bug (see the documentation).'))}return this.evalReplay&&2===this.evalReplay.length&&this.evalReplay.shift(),e},get stackTop(){return this.stack[0]},inDOM:function(){return 0<f.storyElement.find(this.dom).length},evaluateTwineMarkup:function(e,t){var n=p("<p>");return this.stack.unshift({desc:g.create({target:n,source:e,section:this,append:"append"}),tempVariables:this.stackTop.tempVariables,evaluateOnly:t,finalIter:!0}),this.execute(),0<(e=n.find("tw-error")).length?e:n},speculate:function(e,t,n){this.stack.unshift({evaluateOnly:n,finalIter:!0,tempVariables:_(x(y),{TwineScript_VariableStore:{type:"temp",name:n}}),speculativePassage:t});var r,n=this.evalReplay;return this.evalReplay=null,o.isPrototypeOf(e)?r=e.apply(this,{fail:!1,pass:!0}):e&&(r=a(this,e)),this.stack.shift(),this.evalReplay=n,r},renderInto:function(e,a,t){var o=this,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,i=g.create({target:a,source:e,section:this,append:"append"});if(t)if(d.isPrototypeOf(t)){var e=t.run(i);if(b.containsError(e))return e.render(a.attr("title")).replaceAll(a),!1}else _(i,t);if((a=i.target,50<=this.stack.length)&&50<=this.stack.reduce(function(e,t){return e+!!t.finalIter},0))return b.create("infinite","Printing this expression may have trapped me in an infinite loop.").render(a.attr("title")).replaceAll(a),!1;var s=function(e,t,n){var r=a instanceof p&&a.is("tw-hook")&&0<a.parents("tw-collapsed,[collapsing=true]").length;o.stack.unshift({desc:e,finalIter:n,tempVariables:t,collapses:r,evaluateOnly:o.stackTop&&o.stackTop.evaluateOnly})},r=r||x(this.stack.length?this.stackTop.tempVariables:y),t=(hasOwnProperty.call(r,"TwineScript_VariableStore")||(t=null==(e=a)?void 0:e.tag(),r.TwineScript_VariableStore={type:"temp",name:"tw-hook"===t?a.attr("name")?"?"+a.attr("name"):"an unnamed hook":"tw-expression"===t?"a "+a.attr("type")+" expression":"tw-passage"===t?"this passage":"an unknown scope"}),null==(e=this.stackTop)?void 0:e.blocked);if(O(i.loopVars).length){var c=_objectSpread({},i.loopVars),l=Math.min.apply(Math,_toConsumableArray(O(c).map(function(e){return c[e].length})));if(v.create(l+" loop"+(1!==l?"s":"")).render().prependTo(a),l){for(var n=l-1;0<=n;--n)!function(n){s(i,O(c).reduce(function(e,t){return e[t]=c[t][n],e},x(r),n===l-1))}(n);for(var u=l-1;0<=u&&!this.stackTop.blocked;--u)this.execute()}}else s(i,r,!0),this.execute();return(0===this.stack.length||!t&&null!=(e=this.stackTop)&&e.blocked)&&this.updateEnchantments(),i.enabled},execute:function(){var a=this,e=this.stackTop,t=e.desc,n=e.dom,r=e.collapses,o=e.evaluateOnly;t&&!n&&(n=t.render(),this.stackTop.dom=n,this.stackTop.desc=void 0),n.findAndFilter('tw-hook,tw-expression,script[type="application/x-harlowe"]').each(function(e,t){var n=p(t).data();t.cachedData={blockers:n.blockers,code:n.code,source:n.source}}).each(function(e,t){if(a.stackTop.blocked)return!1;var n=t.cachedData;switch(n&&(t.cachedData=void 0),(t=p(t)).tag()){case"tw-hook":var r=t.popData("source")||(null==n?void 0:n.source);(r&&t.data("originalSource",r),t.data("tempVariables",a.stackTop.tempVariables),t.popAttr("hidden"))?t.data("hidden",!0):r&&a.renderInto(r,t);break;case"tw-expression":var r=t.data("blockers")||(null==n?void 0:n.blockers);if(r){if(o)return void t.removeData("blockers").removeData("code").replaceWith(b.create("syntax","I can't use a macro like (prompt:) or (confirm:) in ".concat(o,"."),"Please rewrite this without putting such macros here.").render(t.attr("title"),t));if(r.length)return a.stackTop.blocked=!0,r=a.eval(r.shift()),b.containsError(r)&&(a.stackTop.blocked=!1,t.removeData("blockers").replaceWith(r.render(t.attr("title"),t))),!1;t.removeData("blockers")}r=t.popData("code")||(null==n?void 0:n.code);r&&c.call(a,t,r);break;case"script":if(f.reattachStoryElement(),t.text())try{i(t.text(),a.stackTop.tempVariables)}catch(e){b.isPrototypeOf(e)?t.replaceWith(e.render(t.text(),t)):(null!=(r=window.console)&&r.error(e),t.replaceWith(b.create("","A Javascript error occurred while running this <script> element.",'The error was "'.concat(e,'". Check the browser console for more details.')).render(t.text(),t)))}}}),this.stackTop.blocked||(n.length&&r&&s(n),n.findAndFilter("tw-collapsed,[collapsing=true]").each(function(){s(p(this))}),setTimeout(function(){return n.find("input, textarea").first().focus()},100),this.stack.shift())},updateEnchantments:function(){this.enchantments.forEach(function(e){e.disenchant(),e.enchantScope()})},on:function(e,t){return l[e].push(t),this},addEnchantment:function(t){var n=this;this.enchantments.push(t),l.add.forEach(function(e){return e(n,t)})},removeEnchantment:function(t){var n=this,e=this.enchantments.indexOf(t);this.enchantments.splice(e,1),t.disenchant(),l.remove.forEach(function(e){return e(n,t)})},unblock:function(e){for(this.stack.length||f.impossible("Section.unblock","stack is empty"),this.stackTop.blocked=!1,void 0!==e&&(this.stackTop.blockedValues=(this.stackTop.blockedValues||[]).concat(e));this.stack.length&&!this.stackTop.blocked;)this.execute();if(!this.stack.length)for(;0<this.unblockCallbacks.length;){var t;if(this.unblockCallbacks.shift()(),null!=(t=this.stackTop)&&t.blocked)return}},whenUnblocked:function(e,t){this.stack.length&&this.stackTop.blocked?this.unblockCallbacks=this.unblockCallbacks.concat(e):(t||e)()},blockedValue:function(){var e=this.stackTop;return e?e.blockedValues&&e.blockedValues.length?e.blockedValues.shift():(f.impossible("Section.blockedValue","blockedValues is missing or empty"),0):(f.impossible("Section.blockedValue","stack is empty"),0)}})}),define("state",["jquery","utils","passages","datatypes/customcommand","utils/operationutils","markup"],function(n,y,b,v,e,t){var i,w,C=e.toSource,E=e.is,k=t.lex,o=Object.assign,h=Object.create,e=Object.defineProperty,N=Array.isArray,s=Math.imul,t=(e(Map.prototype,"toJSON",{value:void 0}),e(Set.prototype,"toJSON",{value:void 0}),["localStorage","sessionStorage"].map(function(e){try{return!!window[e]&&(window[e].setItem("test","1"),window[e].removeItem("test"),!0)}catch(e){return!1}}));function S(e,t){var n=0<arguments.length&&void 0!==e?e:String.fromCodePoint(Date.now()%1114112),e=1<arguments.length&&void 0!==t?t:0;i.seedIter=e,i.seed=n;for(var r,a=0,o=2166136261;a<n.length;a+=1)r=s(n.charCodeAt(a),3432918353),o^=s(r<<15|r>>>17,461845907),o=s(o=o<<13|o>>>19,5)+3864292196|0;return o^=n.length,o=s(o^=o>>>16,2246822507),o=s(o^=o>>>13,3266489909),o=((o^=o>>>16)>>>0)+1831565813*e,function(){i.seedIter+=1;var e=o+=1831565813,e=s(e^e>>>15,1|e);return(((e^=e+s(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296}}function r(e,t){for(var n,r=t.variables,a=h(null),o=e.length-1;0<=o;--o){for(var i,s,c=e[o],l=0,u=["mockVisits","mockTurns","seed","seedIter"];l<u.length;l++){var p=u[l];hasOwnProperty.call(c,p)&&!hasOwnProperty.call(t,p)&&(t[p]=c[p])}for(i in c.forgetVisits&&(t.forgetVisits=Math.max(t.forgetVisits||0,c.forgetVisits)),void 0!==c.turns&&(t.turns=(t.turns||0)+c.turns),t.pastVisits||(t.pastVisits=[]),o!==e.length-1&&(void 0!==e[o+1].visits&&Array.isArray(t.pastVisits[0])?t.pastVisits[0]:t.pastVisits).unshift(c.passage),void 0!==c.pastVisits&&t.pastVisits.unshift(c.pastVisits),void 0!==c.visits&&t.pastVisits.unshift(c.visits),c.variables)if("TwineScript_TypeDefs"===i)for(var d in r[i]||(r[i]=h(null)),c.variables[i])r[i][d]||(r[i][d]=c.variables[i][d]);else i.startsWith("TwineScript_")||i in r||(null===c.variables[i]&&(a[i]=!0),a[i])||(r[i]=c.variables[i],!(s=c.valueRefs[i]))||"via"in s||t.valueRefs[i]||(t.valueRefs[i]=s)}for(n in t.valueRefs){var f=t.valueRefs[n];f&&"via"in f&&delete t.valueRefs[n]}}var a,c={passage:"",variables:h(null),visits:void 0,turns:void 0,seed:void 0,seedIter:void 0,mockVisits:void 0,mockTurns:void 0,forgetVisits:void 0,create:function(e){var t=h(c);return t.passage=e||"",t.variables=h(null),t.valueRefs=h(null),t}},l={forward:[],back:[],load:[],beforeForward:[],beforeBack:[],beforeLoad:[],forgetUndos:[]},u=[],p=-1,d=c.create(),f="";function m(){i.history=i.pastVisits.slice(i.forgetVisits).reduce(function(e,t){return e.concat(t)},[]),i.mockVisits&&(i.history=i.mockVisits.concat(i.history))}function g(){var e=c.create();e.pastVisits=[],o(e.variables,{TwineScript_ObjectName:"this story's variables",TwineScript_TypeDefs:h(null),TwineScript_VariableStore:{type:"global",name:"this story's variables"},TwineScript_Delete:function(e){delete this[e],d.variables[e]=null,delete d.valueRefs[e]},TwineScript_Set:function(e,t,n){if(this[e]=t,d.variables[e]=t,n)d.valueRefs[e]=n;else if((N(t)||t instanceof Map||t instanceof Set||"string"==typeof t)&&!y.options.uncompressedStructures)for(var r=p;0<=r;--r){var a=u[r].variables[e];if(void 0!==a){a=function e(t,n,r){var a="it"===r?"its":r+"'s",o="";if(N(n)&&N(t)&&n.length){for(var i=n.length===t.length,o="(a:",s=0;s<n.length;s+=1){var c,l,u,p=n[s];E(p,t[s])?(c=C(p),l="".concat(a," ").concat(s+1,"th"),o+=(c.length<l.length?c:l)+","):(i=!1,-1<(c=t.indexOf(p))?(l=C(p),u="".concat(a," ").concat(c+1,"th"),o+=(l.length<u.length?l:u)+","):o+=e(t[s],p,"".concat(a," ").concat(s+1,"th"))+",")}o=i?r:o.slice(0,-1)+")"}else if(n instanceof Map&&t instanceof Map&&n.size){var d,f=n.size===t.size,h=(o="(dm:",_createForOfIteratorHelper(n.entries()));try{for(h.s();!(d=h.n()).done;){var m,g,y=_slicedToArray(d.value,2),b=y[0],v=y[1];o+="".concat(C(b),","),E(v,t.get(b))?(m=C(v),g="".concat(a," (").concat(C(b),")"),o+=(m.length<g.length?m:g)+","):(f=!1,o+=e(t.get(b),v,"".concat(a," (").concat(C(b),")"))+",")}}catch(e){h.e(e)}finally{h.f()}o=f?r:o.slice(0,-1)+")"}else if(n instanceof Set&&t instanceof Set&&n.size){var w,k=new Set,S=new Set,T=_createForOfIteratorHelper(t);try{for(T.s();!(w=T.n()).done;){var _=w.value;n.has(_)||k.add(_)}}catch(e){T.e(e)}finally{T.f()}var x,O=_createForOfIteratorHelper(n);try{for(O.s();!(x=O.n()).done;){var A=x.value;t.has(A)||S.add(A)}}catch(e){O.e(e)}finally{O.f()}k.size||S.size||(o=r),o=k.size+S.size>n.size?C(n):r+(S.size?"+"+C(S):"")+(k.size?"-"+C(k):"")}else"string"==typeof n&&"string"==typeof t&&n&&(n.startsWith(t)?o=r+"+"+C(n.slice(t.length)):n.endsWith(t)&&(o=C(n.slice(0,n.length-t.length))+"+"+r));return o?"it"===r?{via:o}:o:"it"===r?void 0:C(n)}(a,t,"it");a&&("it"===a.via?delete d.variables[e]:d.valueRefs[e]=a);break}}},TwineScript_GetProperty:function(e){return this[e]},TwineScript_DefineType:function(e,t){this.TwineScript_TypeDefs[e]=t,hasOwnProperty.call(d.variables,"TwineScript_TypeDefs")||(d.variables.TwineScript_TypeDefs=h(null)),d.variables.TwineScript_TypeDefs[e]=t}}),r(u.slice(0,p+1),e),i=e,m(),w=S(e.seed,e.seedIter)}function T(e){d=c.create(e);e=a.serialise(!0),f=e.past,e=e.pastAndPresent;if(a.hasSessionStorage&&"string"==typeof e)try{sessionStorage.setItem("Saved Session",e)}catch(e){}}function _(e,t,n,r){for(var a in r)if(hasOwnProperty.call(r,a)&&!a.startsWith("TwineScript_"))if("object"===_typeof(r[a]))if(hasOwnProperty.call(r[a],"at")){n.valueRefs[a]=r[a];var o=r[a],i=o.at,s=o.from,c=o.to,l=o.hash,u=o.seed,p=o.seedIter,o=o.blockedValues;if(!b.has(i))throw Error('The data refers to a passage named `"'.concat(n.passage,"\"`, but it isn't in this story."));var d=b.get(i).get("source"),f=d.slice(s,c);if(void 0!==l)for(var h=0,m=c-s;y.hash(f).toString(16)!==l;){if(h+m>=d.length)throw Error("The value (or type) of the variable `$".concat(a,"` couldn't be found in the passage `\"").concat(i,'"`.'));(h+=1)===s&&(h+=1),f=d.slice(h,h+m)}c=k(f,"","macro");void 0!==u&&void 0!==p&&(w=S(u,p)),void 0!==o&&(e.stackTop.blockedValues=o,c.forEach(function e(t){var n;"string"!==t.type&&"hook"!==t.type&&t.children.every(e),"macro"!==t.type||"prompt"!==(n=y.insensitiveName(t.name))&&"confirm"!==n||(t.blockedValue=!0)})),r[a]=e.eval(c)}else if(hasOwnProperty.call(r[a],"via")){for(var g=t.length-1;0<=g;--g)if(hasOwnProperty.call(t[g].variables,a)){e.Identifiers.it=t[g].variables[a];break}r[a]=e.eval(k(r[a].via,"","macro")),e.Identifiers.it=0}else hasOwnProperty.call(r[a],"changer")&&(r[a].changer=e.eval(k(r[a].changer,"","macro")),r[a].hook=e.eval(k(r[a].hook,"","macro")),_(e,t,n,r[a].variables),r[a]=v.create(r[a]));else r[a]=e.eval(k(r[a],"","macro"));else"TwineScript_MockVisits"===a&&(n.mockVisits=r[a])}return g(),d.seed=i.seed,d.seedIter=0,(a={get passage(){return d.passage},get variables(){return i.variables},get pastLength(){return p},get turns(){return p+1+(i.turns||0)+(i.mockTurns||0)},get futureLength(){return u.length-1-p},get mockVisits(){return i.mockVisits||[]},set mockVisits(e){i.mockVisits=e,d.mockVisits=e,m()},get mockTurns(){return i.mockTurns||0},set mockTurns(e){i.mockTurns=e,d.mockTurns=e},history:function(){return i.history},forgetUndos:function(e){e<0&&(e=u.length+e);var t,e=u.splice(0,Math.min(u.length-1,e));e.length&&(p=u.length-1,t=u[0],r(e,t),t.pastVisits.push(e[e.length-1].passage),t.turns=(t.turns||0)+e.length,i.turns=(i.turns||0)+e.length,t.forgetVisits&&(t.pastVisits=t.pastVisits.slice(t.forgetVisits-t.turns),t.forgetVisits-=t.turns),f="",0===p&&n("tw-link[undo], tw-icon[alt='Undo']",y.storyElement).each(function(e,t){(n(t).closest("tw-expression, tw-hook").data("forgetUndosEvent")||Object)(t)}),l.forgetUndos.forEach(function(e){return e()}))},forgetVisits:function(e){(e=e<0?u.length+e:e)>p+i.turns&&(e=p+i.turns),d.forgetVisits=i.forgetVisits=Math.max(i.forgetVisits||0,e),m()},passageNameVisited:function(e){var t=0;if(!b.get(e))return 0;for(var n=0;n<i.history.length;n++)t+=+(e===i.history[n]);return t},get timeline(){return u},play:function(t){var e;d||y.impossible("State.play","present is undefined!"),l.beforeForward.forEach(function(e){return e()}),d.passage&&((null!=(e=d.visits)&&e.length&&Array.isArray(i.pastVisits[i.pastVisits.length-1])?i.pastVisits[i.pastVisits.length-1]:i.pastVisits).push(d.passage),i.history.push(d.passage)),d.passage=t,u=u.slice(0,p+1).concat(d),p+=1,T(t),l.forward.forEach(function(e){return e(t)})},redirect:function(e){var t;d||y.impossible("State.redirect","present is undefined!"),d.passage&&(null!=(t=d.visits)&&t.length&&Array.isArray(i.pastVisits[i.pastVisits.length-1])?i.pastVisits[i.pastVisits.length-1].push(d.passage):i.pastVisits.push([d.passage]),i.history.push(d.passage)),d.visits=(d.visits||[]).concat(e),d.passage=e},rewind:function(e){for(var t=void 0!==e?e:1,n=!1;0<t&&0<p;t--)n=!0,--p;return n&&(l.beforeBack.forEach(function(e){return e()}),f="",T(u[p].passage),g(),l.back.forEach(function(e){return e()})),n},fastForward:function(e){var t=1,n=!1;for("number"==typeof e&&(t=e);0<t&&0<u.length;t--)n=!0,p+=1;return n&&(l.beforeForward.forEach(function(e){return e()}),T(u[p].passage),g(),l.forward.forEach(function(e){return e(u[p].passage,"fastForward")})),n},on:function(e,t){if(e in l)return"function"!=typeof t||l[e].includes(t)||l[e].push(t),a;y.impossible("State.on","invalid event name")},reset:function(){l.beforeLoad.forEach(function(e){return e()}),u=[],p=-1,g(),(d=c.create()).seed=i.seed,d.seedIter=0,f="",w=S(),l.load.forEach(function(e){return e(u)})},hasStorage:t[0],hasSessionStorage:t[1],setSeed:function(e){w=S(e),d.seed=i.seed,d.seedIter=0},get seed(){return i.seed},get seedIter(){return i.seedIter},random:function(){var e=w();return d.seedIter=i.seedIter,e},shuffled:function(){for(var a=this,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.reduce(function(e,t,n){var r=a.random()*(n+1)|0;return r===n?e.push(t):(e.push(e[r]),e[r]=t),e},[]);return d.seedIter=i.seedIter,r}}).serialise=function(e){function o(e,t){if("TwineScript_TypeDefs"===t){var n,r={};for(n in e[t])r[n]=C(e[t][n]);return r}var a;return null===e[t]?null:e[t]&&hasOwnProperty.call(e[t],"TwineScript_CustomCommand")?(a=e[t].TwineScript_CustomCommand(),{changer:C(a.changer),toSource:a.toSource,hook:C(a.hook),variables:Object.keys(a.variables).reduce(function(e,t){return e[t]=o(a.variables,t),e},{})}):C(e[t])}function t(e,t){if(c.isPrototypeOf(t)&&void 0===t.visits&&void 0===t.turns&&void 0===t.mockVisits&&void 0===t.forgetVisits&&void 0===t.pastVisits&&void 0===t.mockTurns&&void 0===t.seed&&void 0===t.seedIter&&Object.keys(t.variables).every(function(e){return e.startsWith("TwineScript_")}))return t.passage;if(!c.isPrototypeOf(this)||"valueRefs"!==e){if(c.isPrototypeOf(this)&&"variables"===e){var n,r={};for(n in this.variables)this.valueRefs[n]?r[n]=this.valueRefs[n]:r[n]=o(this.variables,n);return r}return t}}var e=u.slice(f?e?p-1:p:0,p+1),n=e.slice(0,-1),r=f;try{return{past:r=n.length?(r?r.slice(0,-1)+",":"[")+JSON.stringify(n,t).slice(1):r,pastAndPresent:r.slice(0,-1)+(r?",":"[")+JSON.stringify(e.slice(-1),t).slice(1)}}catch(e){return{past:!1,pastAndPresent:!1}}},a.deserialise=function(e,t){var n;try{n=JSON.parse(t)}catch(e){return Error("The save data is unintelligible.")}if(!N(n))return Error("The save data isn't a sequence of past turns.");for(var r=0;r<n.length;r+=1){var a=n[r];if("string"==typeof a)a={passage:a,variables:{}};else if("object"!==_typeof(a)||!hasOwnProperty.call(a,"variables")){n.splice(r--,1);continue}if(a.valueRefs=h(null),a.variables=o(h(null),a.variables),!b.hasValid(a.passage))return Error('The data refers to a passage named `"'.concat(a.passage,"\"`, but it isn't in this story."));if(hasOwnProperty.call(a.variables,"TwineScript_TypeDefs"))try{_(e,n.slice(0,r),a,a.variables.TwineScript_TypeDefs)}catch(e){return Error("The variable types on turn ".concat(r+1," couldn't be reconstructed.").concat(e.message?" (".concat(e.message,")"):""))}try{_(e,n.slice(0,r),a,a.variables)}catch(e){return Error("The variables on turn ".concat(r+1," couldn't be reconstructed.").concat(e.message?" (".concat(e.message,")"):""))}n[r]=o(h(c),a)}return p=(u=n).length-1,l.load.forEach(function(e){return e(u)}),f="",g(),T(u[p].passage),!0},Object.seal(c),Object.freeze(a)}),define("utils",["jquery","markup","utils/polyfills"],function(d){var r=String.fromCharCode,n="audio,blockquote,canvas,div,h1,h2,h3,h4,h5,hr,ol,p,pre,table,ul,video,tw-align,tw-story,tw-passage,tw-sidebar,tw-columns,tw-column,tw-meter".split(","),a="a,b,i,em,strong,sup,sub,abbr,acronym,s,strike,del,big,small,script,img,button,input,tw-link,tw-broken-link,tw-verbatim,tw-collapsed,tw-error,tw-colour,tw-icon".split(","),f=["audio"],e=_slicedToArray([function(e){return r(e)!==r(e).toLowerCase()},function(e){return r(e)!==r(e).toUpperCase()},function(e){return r(e).toLowerCase()!==r(e).toUpperCase()}].map(function(e){return"["+Array.from(Array(57343)).map(function(e,t){return t}).filter(e).map(function(e,t,n){return e===n[t-1]+1&&e===n[t+1]-1?"-":r(e)}).join("").replace(/-+/g,"-")+"]"}),3),t=e[0],o=e[1],e=e[2];function s(e){return"instant"===e?0:800}var i,c,l=[],u={},p=0,h={},m=0,g={};function y(n,r,e,a,o){var i=null,s=0,c=r+e;function l(e){var t;1&n[0].compareDocumentPosition(document)&&(c=0),i&&(c-=t=e-i),i=e,0<a&&0<p+m&&n.data("expediteAnim")(a),c<=r&&(s+=t||0,"paused"===n.css("animation-play-state"))&&n.css({visibility:"","animation-play-state":"running"}),c<=0?(n.removeData("expediteAnim"),o()):requestAnimationFrame(l)}n.data("expediteAnim",function(e){var t;c-=e=void 0===e?s:e,"running"===n.css("animation-play-state")&&n.css("animation-delay",(("ms"===(t=(t=n.css("animation-delay")).toLowerCase()).slice(-2)?+t.slice(0,-2)||0:"s"===t.slice(-1)&&1e3*+t.slice(0,-1)||0)||0)-e+"ms")}),c?requestAnimationFrame(l):l()}d(document.documentElement).on("keydown keyup mousedown mouseup",function(e){var t=e.key,n=e.button,e=e.type.includes("down"),r=t?u:h,n=t&&v.insensitiveName(t)||n;r[n]&&!e?t?p=Math.max(p-1,0):m=Math.max(m-1,0):!r[n]&&e&&(t?p+=1:m+=1),r[n]=e}).on("mousemove",function(e){var t=e.pageX,e=e.pageY;g.x=t,g.y=e});var b=/-|_/g,v={hash:function(e){for(var t=9,n=e.length;0<n;)--n,t=Math.imul(t^e.charCodeAt(n),Math.pow(9,9));return(t^t>>>9)>>>0},permutations:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r,a,o=t.length,i=[[].concat(t)],s=Array(o).fill(0),c=1;c<o;)s[c]<c?(r=c%2&&s[c],a=t[c],t[c]=t[r],t[r]=a,++s[c],c=1,i.push([].concat(t))):(s[c]=0,++c);return i},nth:function(e){var t=+e+"";return e+("1"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"2"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"3"!==t[t.length-1]||1!==t.length&&"1"===t[t.length-2]?"th":"rd":"nd":"st")},plural:function(e,t,n){return e+" "+(1!==Math.abs(e)?n||t+"s":t)},andList:function(e){return e.length<=1?e[0]:e.slice(0,-1).join(", ")+" and "+e[e.length-1]},realWhitespace:"[ \\n\\r\\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]",anyRealLetter:"[\\dA-Za-z\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",anyUppercase:t,anyLowercase:o,anyCasedLetter:e,anyNewline:"(?:\\n|\\r|\\r\\n)",unescape:function(e){return e.replace(/&(?:amp|lt|gt|quot|nbsp|zwnj|#39|#96);/g,function(e){return{"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"',"&#39;":"'","&nbsp;":String.fromCharCode(160),"&zwnj;":String.fromCharCode(8204)}[e]})},escape:function(e){return e.replace(/[&><"']/g,function(e){return{"&":"&amp;",">":"&gt;","<":"&lt;",'"':"&quot;","'":"&#39;"}[e]})},insensitiveName:function(e){return(e+"").toLowerCase().replace(b,"")},allKeysDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return u[e]})},someKeysDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function(e){return u[e]})},buttonsDown:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.every(function(e){return h[e]})},anyInputDown:function(){return 0<p+m},mouseCoords:g,parentColours:function(e){for(var t,n={colour:null,backgroundColour:null},r=/^\w+a\(.+?,\s*0\s*\)$|^transparent$/;e.length&&e[0]!==document;e=e.parent())if(n.backgroundColour||(t=e.css("background-color")).match(r)||(n.backgroundColour=t),n.colour||(t=e.css("color")).match(r)||(n.colour=t),n.colour&&n.backgroundColour)return n;return{colour:"#fff",backgroundColour:"#000"}},childrenProbablyInline:function(e){var t=[];return[].every.call(e.findAndFilter("*"),function(e){if(!(e.hidden||/none|inline/.test(e.style.display)||/display: (none|inline)/.test(e.getAttribute("style")))){if(n.includes(e.tagName.toLowerCase())||/display: (?!none|inline|inherit|unset)/.test(e.getAttribute("style")))return!1;a.includes(e.tagName.toLowerCase())||t.push(e)}return!0})&&t.every(function(e){return/inline|none/.test(window.getComputedStyle(e).display)})},transitionOut:function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,o=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,i=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;0!==e.length&&(n=n||s(t),!(1<e.length)&&v.childrenProbablyInline(e)&&["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(e.tag())||(e=e.wrapAll("<tw-transition-container>").parent()),i&&e.css("transform-origin",i),e.attr("data-t8n",t).addClass("transition-out").css({"animation-duration":"".concat(n,"ms"),"animation-delay":"".concat(-o,"ms"),"animation-play-state":"paused"}),requestAnimationFrame(function(){v.childrenProbablyInline(e)?e.css("display","inline"):e.parent().is("tw-backdrop,tw-story")||e[0].setAttribute("style",e[0].getAttribute("style")+"display:block !important;width:100%")}),y(e,n,r-o,a,function(){e.remove()}))},transitionIn:function(u,e,t){var p,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:void 0;0!==u.length&&(t=t||s(e),(p=1<u.length||!v.childrenProbablyInline(u)||!["tw-hook","tw-passage","tw-sidebar","tw-expression"].includes(u.tag()))&&(u=u.wrapAll("<tw-transition-container>").parent()),o&&u.css("transform-origin",o),u.attr("data-t8n",e).addClass("transition-in").css(_objectSpread({"animation-duration":"".concat(t,"ms"),"animation-delay":"".concat(-a,"ms")},n-a?{visibility:"hidden","animation-play-state":"paused"}:{})),requestAnimationFrame(function(){v.childrenProbablyInline(u)?u.css("display","inline"):u.parent().is("tw-backdrop,tw-story")||u[0].setAttribute("style",u[0].getAttribute("style")+"display:block !important;width:100%")}),y(u,t,n-a,r,function(){var e=0===u.filter(f.join(",")).length;if(p&&e){u.find("tw-transition-container, .transition-in, .transition-out").each(function(e,t){((t=d(t)).data("expediteAnim")||Object)()});for(var t=[],n=u.find("*"),r=0;r<n.length;r+=1){var a=n[r];0===a.scrollTop&&0===a.scrollLeft||t.push([a,a.scrollLeft,a.scrollTop])}e=u.find(document.activeElement);u.contents().unwrap();for(var o=0,i=t;o<i.length;o++){var s=_slicedToArray(i[o],3),c=s[0],l=s[1],s=s[2];c.scrollLeft=l,c.scrollTop=s}e.length&&e[0].focus()}else u.removeClass("transition-in").removeAttr("data-t8n")}))},debounce:function(e){function t(){300<Date.now()-l||s<=u?(u=n=0,p=!i,o?(e(c),c=[]):e.apply(void 0,_toConsumableArray(c)),p=!1):n=requestAnimationFrame(t)}var n,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=r.batch,o=void 0!==a&&a,a=r.recur,i=void 0!==a&&a,a=r.maxWait,s=void 0===a?1/0:a,c=[],l=0,u=0,p=!1;return function(){var e;p||(e=Date.now(),u+=e-l,l=e,o?c.push(arguments):c=arguments,n&&cancelAnimationFrame(n),n=requestAnimationFrame(t))}},impossible:function(e,t){window.console&&console.error(e+"(): "+t)},onStartup:function(e){l?l.push(e):e()},get storyElement(){return i},detachStoryElement:function(){document.documentElement.contains(i[0])&&(c=i.parent(),i.detach())},reattachStoryElement:function(){document.documentElement.contains(i[0])||(c||d(document.body)).append(i.parents().length?i.parents().last():i)},options:{speedMultiplier:1}};return d(function(){i=d("tw-story"),l.forEach(function(e){return e()}),l=null}),Object.freeze(v)}),define("datatypes/assignmentrequest",["utils/operationutils","datatypes/typedvar","datatypes/datatype","internaltypes/varref","internaltypes/twineerror"],function(e,y,b,v,w){var k=e.objectName,S=e.matches,t=e.toSource;return Object.freeze({assignmentRequest:!0,TwineScript_TypeName:"a VariableToValue (a 'to' or 'into' expression)",TwineScript_ObjectName:"a VariableToValue (a 'to' or 'into' expression)",TwineScript_ToSource:function(){return"into"===this.operator?"".concat(t(this.src)," ").concat(this.operator," ").concat(t(this.dest)):"".concat(t(this.dest)," ").concat(this.operator," ").concat(t(this.src))},TwineScript_Unstorable:!0,set:function(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],n=[],r=function e(t,n,r){var a=!(2<arguments.length&&void 0!==r)||r,o=[],i=n&&v.isPrototypeOf(n)?n.get():n;if(w.containsError(i))return i;if(Array.isArray(i)&&Array.isArray(t)){for(var s=0,c=0;s<t.length&&c<i.length;){var l=t[s],u=i[c];if(y.isPrototypeOf(l)&&l.datatype.rest||b.isPrototypeOf(l)&&l.rest){for(var p=c;c<i.length&&S(l,u);)u=i[c+=1];y.isPrototypeOf(l)?l.datatype=[l.datatype]:b.isPrototypeOf(l)&&(l=b.create("array")),o=o.concat(e(l,v.isPrototypeOf(n)?v.create(n,{first:p+1,last:c+1}):i.slice(p,c)))}else o=o.concat(e(l,v.isPrototypeOf(n)?v.create(n,c+1):u)),c+=1;s+=1}return s<t.length?a&&w.create("operation","I can't unpack this array because it needs ".concat(t.length-s," more value").concat(0<t.length-s?"s":"",".")):o}if(t instanceof Map&&i instanceof Map){var d,f=_createForOfIteratorHelper(t.entries());try{for(f.s();!(d=f.n()).done;){var h=_slicedToArray(d.value,2),m=h[0],g=h[1];if(!i.has(m))return a&&w.create("operation","I can't unpack this datamap because it needs a '"+m+"' data name.");o=o.concat(e(g,v.isPrototypeOf(n)?v.create(n,m):i.get(m)))}}catch(e){f.e(e)}finally{f.f()}return o}if(y.isPrototypeOf(t)){if("function"==typeof t.datatype.destructure)return[{dest:t,value:i,src:n}].concat(t.datatype.destructure(i));if(!S(i,t.datatype))return a&&w.create("operation","I can't put ".concat(k(i)," into ").concat(t.varRef.TwineScript_ToSource()," because it doesn't match ").concat(t.varRef.TwineScript_ToSource(),"'s datatype, ").concat(k(t.datatype),"."));o=o.concat(e(t.datatype,i))}return v.isPrototypeOf(t)||y.isPrototypeOf(t)?o.concat({dest:t,value:i,src:n}):"function"==typeof t.destructure?o.concat(t.destructure(i)):S(i,t)?o:a&&w.create("operation","I tried to unpack, but "+k(t)+" in the pattern didn't match "+k(i)+".")}(this.dest,this.src);if(e=w.containsError(r))return e;if(!r.length)return w.create("operation","I can't store a new value inside "+k(this.dest)+" that isn't in a variable.","You need a variable, or a data structure containing variables at certain positions, to store the value.");var a,o=_createForOfIteratorHelper(r.reverse());try{for(o.s();!(a=o.n()).done;){var i=a.value,s=i.dest,c=i.value,l=i.src;if(y.isPrototypeOf(s)){if(e=w.containsError(s.defineType()))return e;s=s.varRef}if(e=s.set(c,this.srcRef),w.isPrototypeOf(e))return e;t&&l&&l.delete(),n.shift(k(s)+" is now "+k(c))}}catch(e){o.e(e)}finally{o.f()}return n.join("; ")},create:function(e,t,n,r){return w.containsError(e)?e:w.containsError(t)?t:Object.assign(Object.create(this),{dest:e,src:t,operator:n,srcRef:r})}})}),define("datatypes/changercommand",["utils","utils/operationutils","internaltypes/changedescriptor","internaltypes/twineerror"],function(e,t,n,r){var i=e.plural,a=e.impossible,o=t.is,s=t.toSource,c={},l={TwineScript_TypeID:"changer",TwineScript_TypeName:"a changer",TwineScript_Print:function(){return"`[A ("+this.macroName+":) changer]`"},TwineScript_ToSource:function(){return"("+this.macroName+":"+("else"===this.name?"":this.params.map(s))+")"+(this.next?"+"+this.next.TwineScript_ToSource():"")},get TwineScript_ObjectName(){1===this.params.length&&36<(e=s(this.params[0])).length&&(e=void 0);for(var e,t="a (".concat(this.macroName,":").concat(e||"",") changer"),n=this.next,r=(n&&(t+=" combined with "),0);n&&t.length<48;){var a="(".concat(n.macroName,":)");t+=(0<r&&!n.next?" and ":"")+a+(n.next?", ":""),n=n.next,r+=1}for(var o=0;n&&o<99;)n=n.next,o+=1;return 0<o&&(t+="".concat(0<r?" and ":"").concat(i(o,"other changer"))),t},summary:function(){var e=n.create();return this.run(e),e.summary()},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];return Array.isArray(t)||a("ChangerCommand.create","params was not an array but "+t),Object.assign(Object.create(this),{macroName:e,params:t,next:n,canEnchant:r})},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t.canEnchant=this.canEnchant&&e.canEnchant,t},TwineScript_is:function(e){if(l.isPrototypeOf(e))return this.macroName===e.macroName&&o(this.params,e.params)&&o(this.next,e.next)},TwineScript_Clone:function(){for(var e=l.create(this.macroName,this.params,this.next),t=e;t.next;)t=t.next=t.next.TwineScript_Clone();return e.canEnchant=this.canEnchant,e},run:function(e,t){var n="output"===this.macroName?[t||this]:this.params,n=c[this.macroName].apply(c,[e].concat(_toConsumableArray(n)));if(r.containsError(n))return n;this.next&&this.next.run(e,t||this)},register:function(e,t){c[e]=t}};return Object.freeze(l)}),define("datatypes/codehook",[],function(){var t=Object.freeze({TwineScript_TypeName:"a code hook",TwineScript_ObjectName:"a code hook",TwineScript_ToSource:function(){return this.source},TwineScript_Print:function(){return this.code},TwineScript_toString:function(){return this.source},TwineScript_is:function(e){return t.isPrototypeOf(e)&&this.source===e.source},TwineScript_Clone:function(){return t.create(this.code,this.source)},create:function(e,t){return Object.assign(Object.create(this),{code:e,source:t})}});return t}),define("datatypes/colour",["jquery"],function(c){var l=Math.max,u=Math.min,a=Math.sin,o=Math.cos,i=Math.pow,p=Math.round,d=Math.floor,s=Math.atan2,f=Math.cbrt,h=Math.sqrt,m=Math.PI,g=Object.assign,y=Object.create,b=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,t=/^([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,v=y(null);function w(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];if(0<r.length)return w.apply(void 0,[w(e,t)].concat(r));if(!t)return e;for(var o=[],i=0;i<e.length;i++){o[i]=[];for(var s=0;s<t[0].length;s++){for(var c=0,l=0;l<e[0].length;l++)c+=e[i][l]*t[l][s];o[i][s]=c}}return o}function n(e){var t,n=e.r,r=e.g,a=e.b,e=e.a,o=l(n/=255,r/=255,a/=255),i=u(n,r,a),s=(o+i)/2,c=o-i;if(o===i)return{h:0,s:0,l:s};switch(o){case n:t=(r-a)/c+(r<a?6:0);break;case r:t=(a-n)/c+2;break;case a:t=(n-r)/c+4}return{h:t=p(60*t),s:.5<s?c/(2-o-i):c/(o+i),l:s,a:e}}var k=[.9642956764295677,1,.8251046025104602],S=24389/27,T=216/24389,_=function(e){return e.map(function(e){return[e]})},x=function(e){return e.map(function(e){return e[0]})};function O(e){var t=e.l,n=e.c,r=e.h,e=e.a,n=[t*=100,n*o(r*m/180),n*a(r*m/180)],r=[];r[1]=(n[0]+16)/116,r[0]=n[1]/500+r[1],r[2]=r[1]-n[2]/200;n=[i(r[0],3)>T?i(r[0],3):(116*r[0]-16)/S,S*T<t?i((16+t)/116,3):t/S,i(r[2],3)>T?i(r[2],3):(116*r[2]-16)/S].map(function(e,t){return e*k[t]}),t=_slicedToArray(x(w([[3.2409699419045226,-1.537383177570094,-.4986107602930034],[-.9692436362808796,1.8759675015077202,.04155505740717559],[.05563007969699366,-.20397695888897652,1.0569715142428786]],w([[.9554734527042182,-.023098536874261423,.0632593086610217],[-.028369706963208136,1.0099954580058226,.021041398966943008],[.012314001688319899,-.020507696433477912,1.3303659366080753]],_(n)))).map(function(e){return u(255,l(0,255*(.0031308<(e=e)?1.055*i(e,1/2.4)-.055:12.92*e)))}),3);return{r:t[0],g:t[1],b:t[2],a:e}}function e(e){function t(e){return 1e-5<=n[e]&&n[e]<=255-1e-5}var n=O(e);if(Object.keys(n).every(t))return n;var r=(e=_objectSpread({},e)).c,a=0;for(e.c/=2;1e-5<r-a;)n=O(e),Object.keys(n).every(t)?a=e.c:r=e.c,e.c=(r+a)/2;return O(e)}var A=Object.freeze({TwineScript_TypeID:"colour",TwineScript_TypeName:"a colour",TwineScript_ObjectName:"a colour",TwineScript_DebugName:function(){return"a colour "+this.TwineScript_Print()},"TwineScript_+":function(e){var t=this.toRGBA(),e=e.toRGBA();return A.create({r:u(p(.6*(t.r+e.r)),255),g:u(p(.6*(t.g+e.g)),255),b:u(p(.6*(t.b+e.b)),255),a:(t.a+e.a)/2})},TwineScript_Print:function(){var e=this.toRGBA();return"<tw-colour style='background-color:rgba("+[e.r,e.g,e.b,e.a]+");'></tw-colour>"},TwineScript_is:function(e){var t;return!!A.isPrototypeOf(e)&&(e.lcha&&this.lcha?e.lcha.l===this.lcha.l&&e.lcha.c===this.lcha.c&&e.lcha.h===this.lcha.h&&e.a===this.a:(t=this.toRGBA(),(e=e.toRGBA()).r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a))},TwineScript_Clone:function(){return A.create(this)},toRGBAString:function(){var e=this.toRGBA(),t=e.r,n=e.g,r=e.b,e=e.a;return"rgba(".concat(t,", ").concat(n,", ").concat(r,", ").concat(e,")")},toHSLA:function(){return n(this.toRGBA())},toRGBA:function(){return this.lch?e(_objectSpread({a:this.a},this.lch)):this},toLCHA:function(){return this.lch?_objectSpread({a:this.a},this.lch):(t=(e=this).r,n=e.g,r=e.b,e=e.a,n=[116*(t=x(w([[1.0479298208405488,.022946793341019088,-.05019222954313557],[.029627815688159344,.990434484573249,-.01707382502938514],[-.009243058152591178,.015055144896577895,.7518742899580008]],w([[.41239079926595934,.357584339383878,.1804807884018343],[.21263900587151027,.715168678767756,.07219231536073371],[.01933081871559182,.11919477979462598,.9505321522496607]],_([t/255,n/255,r/255].map(function(e){return e<.04045?e/12.92:i((e+.055)/1.055,2.4)}))))).map(function(e,t){return e/k[t]}).map(function(e){return T<e?f(e):(S*e+16)/116}))[1]-16,500*(t[0]-t[1]),200*(t[1]-t[2])],r=180*s(n[2],n[1])/m,{l:n[0]/100,c:h(i(n[1],2)+i(n[2],2)),h:0<=r?r:360+r,a:e});var e,t,n,r},LCHRotate:function(e){e<0&&(e=360+e);var t=this.toLCHA();return t.h=(t.h+e)%360,A.create(t)},TwineScript_GetProperty:function(e){var t;return"lch"===e?(t=this.toLCHA(),new Map([["l",t.l],["c",t.c],["h",t.h]])):(t=this.toRGBA(),"h"===e||"s"===e||"l"===e?n(t)[e]:"r"===e||"g"===e||"b"===e||"a"===e?t[e]:void 0)},TwineScript_Properties:["h","s","l","r","g","b","a","lch"],TwineScript_ToSource:function(){if(0===this.a)return"transparent";var e=!this.lch&&n(this);if(1===e.l&&!e.h&&!e.s)return"white";if(0===e.l&&!e.h&&!e.s)return"black";if(.5<=e.l&&e.l<.5334&&0===e.s)return"gray";if(.5===e.l&&.8<=e.s&&e.s<.804){var t={0:"red",30:"orange",60:"yellow",90:"lime",120:"green",180:"cyan",210:"blue",240:"navy",270:"purple",300:"magenta"}[e.h];if(t)return t}return"(".concat(this.lch?"lch":"hsl",":").concat(this.lch?[this.lch.l,this.lch.c,this.lch.h]:[e.h,e.s,e.l]).concat(1!==this.a?","+this.a:"",")")},create:function(e){var t,n,r,a,o,i;return"string"==typeof e?this.create((A.isHexString(e)?function(e){return"string"!=typeof e?e:(e=(e=e.replace("#","")).replace(b,"$1$1$2$2$3$3"),{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)})}:function(e){var t;return e in v?v[e]:(t="transparent"===(t=c("<p>").css("background-color",e).css("background-color"))?{r:0,g:0,b:0,a:0}:t.startsWith("rgb")?t.match(/\d+/g).reduce(function(e,t,n){return e["rgb"[n]]=+t,e},{}):{r:192,g:192,b:192},v[e]=t)})(e)):!("h"in e&&"s"in e&&"l"in e)||"r"in e||"g"in e||"b"in e?("a"in e&&"number"==typeof e.a||(e.a=1),"h"in e&&"c"in e&&!("s"in e)&&"l"in e?g(y(this),{a:e.a,lch:{l:e.l,c:e.c,h:e.h}}):g(y(this),e)):this.create((a=(t=e).h,o=e.s,i=e.l,t=e.a,0===o?{r:e=d(255*i),g:e,b:e}:(r=2*i-(n=i<.5?i*(1+o):i+o-i*o),{r:d(255*s((a/=360)+1/3)),g:d(255*s(a)),b:d(255*s(a-1/3)),a:t})));function s(e){return e<0&&(e+=1),1<e&&--e,e<1/6?r+6*(n-r)*e:e<.5?n:e<2/3?r+(n-r)*(2/3-e)*6:r}},isHexString:function(e){return"string"==typeof e&&"#"===e[0]&&(e.slice(1).match(b)||e.slice(1).match(t))},isCSS3Function:function(e){return"string"==typeof e&&/^(?:rgb|hsl)a?\(\s*\d+(?:\.\d+)?\s*,\s*\d+(?:\.\d+)?%?\s*,\s*\d+(?:\.\d+)?%?(?:,\s*\d+(?:\.\d+)?\s*)?\)$/.test(e)}});return A}),define("datatypes/customcommand",["internaltypes/changedescriptor","internaltypes/twineerror"],function(l,u){var p=Object.assign,d=Object.create;return Object.seal({TwineScript_TypeID:"command",TwineScript_ObjectName:"a custom command",TwineScript_TypeName:"a custom command",TwineScript_Print:function(){return"`[a custom command]`"},create:function(e){var t,n=e.toSource,r=e.changer,a=e.hook,o=e.variables,i={};for(t in o)i[t]=[o[t]];var s,c=l.create({source:a,loopVars:i},r);return u.containsError(c)?c:s=p(d(this),{TwineScript_Attach:function(e,t){c.section=e;e=t.run(c);return u.containsError(e)?e:s},TwineScript_Run:function(e){c.section=e;e=c;return c=l.create({source:a,loopVars:i},r),e},TwineScript_ToSource:function(){return n},TwineScript_CustomCommand:function(){return e}})}})}),define("datatypes/custommacro",["jquery","utils","renderer","utils/operationutils","datatypes/customcommand","internaltypes/varref","internaltypes/varscope","internaltypes/twineerror","internaltypes/twinenotifier"],function(w,e,k,t,S,T,_,x,O){function n(v){return function(e){v.called+=1;for(var t=v.varNames,n=v.params,r=v.body,a=E(N(_),{TwineScript_VariableStore:{type:"temp",name:v.TwineScript_ObjectName+" call #"+v.called},TwineScript_TypeDefs:N(null)}),o=[],i=0,s=!1,c=arguments.length,l=new Array(1<c?c-1:0),u=1;u<c;u++)l[u-1]=arguments[u];for(var p=0;p<l.length;p+=1){var d=l[p],f=t[i],h=(a.TwineScript_TypeDefs[f]=n[i].datatype.rest?n[i].datatype.create("array"):n[i].datatype,T.create(a,f));if(x.containsError(h))return h;if(n[i].datatype.rest){var s=!0,m=(a[f]||[]).concat([d]);if(p<l.length-1){a[f]=m;continue}h.set(m)}else h.set(d),i+=1;o.push(O.create(A(h)+" is now "+A(a[f])))}if(!s&&null!=(g=n[i])&&g.datatype.rest){var g=T.create(a,t[i]);if(x.containsError(g))return g;g.set([]),a.TwineScript_TypeDefs[name]=n[i].datatype.create("array")}var y,g=w("<p>").append(k.exec(r.code)),b=e.stack.length,r=(e.stack.unshift({tempVariables:a,dom:g,output:function(e){y=e}}),e.evalReplay);for(e.evalReplay=null,e.execute();e.stack.length>b;)e.stack.shift();e.evalReplay=r;r=g.find("tw-error");return r.length?(g.prepend(o.map(function(e){return e.render()}),"<br>"),x.create("propagated","".concat(r.length," error").concat(1<r.length?"s":""," occurred when running ").concat(v.TwineScript_ObjectName,"."),void 0,g)):void 0===y?x.create("custommacro","".concat(v.TwineScript_ObjectName," didn't output any data or hooks using (output:) or (output-data:).")):"object"===_typeof(y)&&"changer"in y?S.create(E(y,{toSource:"(".concat(v.TwineScript_KnownName||"unnamed",":").concat(l.map(C),")")})):y}}var r=e.andList,A=t.objectName,a=t.typeName,o=t.matches,C=t.toSource,E=Object.assign,N=Object.create,i=Object.seal({TwineScript_TypeID:"macro",TwineScript_TypeName:"a custom macro",TwineScript_GetProperty:function(e){if("params"===e)return _toConsumableArray(this.params)},TwineScript_Properties:["params"],TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},TwineScript_Clone:function(){var e=E(N(i),this);return e.fn=n(e),e},TwineScript_ToSource:function(){return"(macro:"+this.params.map(function(e){return e.TwineScript_ToSource()}).concat("")+this.body.TwineScript_ToSource()+")"},createFromFn:function(e,t,n,r){return E(N(i),{params:[],fn:e,typeSignature:r,TwineScript_ObjectName:t,TwineScript_ToSource:n,TwineScript_KnownName:""})},create:function(e,t){t=E(N(i),{params:e,called:0,varNames:e.map(function(e){return e.varRef.propertyChain[0]}),typeSignature:e.map(function(t){var e=t.datatype.toTypeSignatureObject?t.datatype.toTypeSignatureObject({rest:t.rest}):{pattern:"range",range:function(e){return o(t.datatype,e)},name:a(t.datatype)};return t.rest?{pattern:"zero or more",innerType:e}:e}),body:t,TwineScript_KnownName:"",TwineScript_ObjectName:"a custom macro (with ".concat(e.length?r(e.map(C)):"no params",")")});return t.fn=n(t),t}});return i}),define("datatypes/datatype",["utils","utils/operationutils","datatypes/changercommand","datatypes/colour","datatypes/gradient","datatypes/lambda","datatypes/custommacro","datatypes/codehook","internaltypes/twineerror"],function(e,t,n,r,a,o,i,s,c){var l=e.realWhitespace,u=e.anyRealLetter,p=e.anyCasedLetter,d=e.anyNewline,f=t.objectName,e=Object.seal,h=Object.keys,m=Math.floor,g=Math.abs,y={TwineScript_TypeID:"datatype",TwineScript_TypeName:"a datatype",TwineScript_Print:function(){return"`["+this.TwineScript_ObjectName+"]`"},get TwineScript_ObjectName(){return"the "+(this.rest?"...":"")+this.name+" datatype"},TwineScript_is:function(e){return y.isPrototypeOf(e)&&e.name===this.name},TwineScript_Clone:function(){return this.rest?this:Object.create(this)},TwineScript_ToSource:function(){return(this.rest?"...":"")+this.name},TwineScript_IsTypeOf:function(e){var t=this.name,n=this.rest;return!!v[t]&&v[t](e,n)},toTypeSignatureObject:function(){var e=this.name,e={pattern:"range",range:v[e],name:"a "+("dm"===e?"datamap":"ds"===e?"dataset":"num"===e?e+"ber":"str"===e?e+"ing":"color"===e?"colour":"bool"===e?e+"ean":"alnum"===e?"alphanumeric character":"int"===e?e+"eger":"even"===e||"odd"===e?e+" number":e.endsWith("case")||"whitespace"===e?e+" character":"empty"===e?e+" value":e)};return this.rest?{pattern:"zero or more",innerType:e}:e},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=(e="datamap"===e?"dm":"dataset"===e?"ds":"number"===e?"num":"string"===e?"str":"color"===e?"colour":"boolean"===e?"bool":"alphanumeric"===e?"alnum":"integer"===e?"int":"newline"===e?"linebreak":e,Object.create(this));return n.name=e,n.rest=t,n},from:function(t){var e=h(b).find(function(e){return b[e](t)});return e?y.create(e):c.create("datatype",f(t)+" doesn't correspond to a datatype value.")}},b={array:Array.isArray,dm:function(e){return e instanceof Map},ds:function(e){return e instanceof Set},datatype:function(e){return y.isPrototypeOf(e)},changer:function(e){return n.isPrototypeOf(e)},colour:function(e){return r.isPrototypeOf(e)},gradient:function(e){return a.isPrototypeOf(e)},lambda:function(e){return o.isPrototypeOf(e)},macro:function(e){return i.isPrototypeOf(e)},codehook:function(e){return s.isPrototypeOf(e)},command:function(e){return e&&"command"===e.TwineScript_TypeID},str:function(e){return"string"==typeof e},num:function(e){return"number"==typeof e},bool:function(e){return"boolean"==typeof e}},v=_objectSpread(_objectSpread({},b),{},{even:function(e){return!isNaN(e)&&m(g(e))%2==0},odd:function(e){return!isNaN(e)&&m(g(e))%2==1},empty:function(e){return e instanceof Map||e instanceof Set?!e.size:!(!Array.isArray(e)&&"string"!=typeof e||e.length)},int:function(e){return"number"==typeof e&&e===(0|e)},uppercase:function(e){return"string"==typeof e&&1===_toConsumableArray(e).length&&_toConsumableArray(e).every(function(e){return e!==e.toLowerCase()})},lowercase:function(e){return"string"==typeof e&&1===_toConsumableArray(e).length&&_toConsumableArray(e).every(function(e){return e!==e.toUpperCase()})},whitespace:function(e){return"string"==typeof e&&!!e.match("^"+l+"$")},digit:function(e){return"string"==typeof e&&!!e.match("^\\d$")},alnum:function(e){return"string"==typeof e&&!!e.match("^"+u+"$")},anycase:function(e){return"string"==typeof e&&!!e.match("^"+p+"$")},linebreak:function(e){return"string"==typeof e&&!!e.match("^"+d+"$")},any:function(){return!0},const:function(){return!0}});return e(y)}),define("datatypes/gradient",["utils/operationutils"],function(e){var t=e.toSource,n=Object.freeze({TwineScript_TypeID:"gradient",TwineScript_TypeName:"a gradient",TwineScript_ObjectName:"a gradient",TwineScript_DebugName:function(){return"a gradient "+this.TwineScript_Print()},TwineScript_GetProperty:function(e){var t=this;return"angle"===e?this.angle:"stops"===e?this.stops.map(function(e){return new Map([[t.repeating?"pixels":"percent",e.stop],["colour",e.colour.TwineScript_Clone()]])}):void 0},TwineScript_Properties:["angle","stops"],TwineScript_ToSource:function(){return"(gradient:"+this.angle+","+this.stops.map(function(e){return t(e.stop)+","+t(e.colour)})+")"},TwineScript_is:function(e){var r=this;return e.angle===this.angle&&e.stops.length===this.stops.length&&e.stops.every(function(e,t){var n=e.colour,e=e.stop;return r.stops[t].stop===e&&r.stops[t].colour.TwineScript_is(n)})},TwineScript_Clone:function(){return n.create(this.angle,_toConsumableArray(this.stops))},TwineScript_Print:function(){return"<tw-colour style='background:"+this.toLinearGradientString()+"'></tw-colour>"},create:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return Object.assign(Object.create(this),{angle:e,stops:t.sort(function(e,t){return e.stop-t.stop}),repeating:n})},multiply:function(t){return n.create(this.angle,this.stops.map(function(e){return{colour:e.colour,stop:e.stop*t}}))},toLinearGradientString:function(){var r=this;return(this.repeating?"repeating-":"")+"linear-gradient(".concat(this.angle,"deg, ").concat(this.stops.reduce(function(e,t){var n=t.colour,t=t.stop;return e+n.toRGBAString()+" "+t*(r.repeating?1:100)+(r.repeating?"px,":"%,")},"").slice(0,-1),")")}});return n}),define("datatypes/hookset",["jquery","utils","utils/renderutils","utils/operationutils"],function(g,s,e,t){var y=e.textNodeToChars,b=e.realWhitespace,c=e.findTextInNodes,r=t.toSource;function l(e){function t(n,e){if(Array.isArray(e))return e.reduce(function(e,t){return e.add(n.get(t))},g());if(e&&"object"===_typeof(e)&&"first"in e&&"last"in e){for(var t=e.first,r=e.last,a=n.length,o=(t<0&&(t+=a),r<0&&(r+=a),[n.get(t)]);t!==r;)t+=Math.sign(r-t),o.push(n.get(t));return g(o)}if("string"==typeof e){if("chars"===e){var i,s=[],c=_createForOfIteratorHelper(n.textNodes(m));try{for(c.s();!(i=c.n()).done;){var l,u=i.value,p=_createForOfIteratorHelper(y(u));try{for(p.s();!(l=p.n()).done;){var d=l.value;d.textContent.match(b)||s.push(d)}}catch(e){p.e(e)}finally{p.f()}}}catch(e){c.e(e)}finally{c.f()}return g(s)}if("links"===e)return n.findAndFilter("tw-link, .enchantment-link");if("visited"===e)return n.findAndFilter("tw-link.visited");var f,h;if("lines"===e)return f=n.findAndFilter("br:not(tw-sidebar *),tw-consecutive-br:not(tw-sidebar *)").get(),h=[[]],n.contents().each(function e(t,n){var r=(n.tagName||"").toLowerCase();if("tw-sidebar"!==r)if("tw-passage"===r||"tw-transition-container"===r)g(n).contents().each(e);else{if(f.length){if(n===f[0])return f.shift(),void h.push([]);if(16&n.compareDocumentPosition(f[0]))return h.push([]),g(n).contents().each(e),void h.push([])}h[h.length-1].push(n)}}),g(h.map(function(e){return!!e.length&&g(e).wrapAll("<tw-pseudo-hook>").parent()[0]}).filter(Boolean))}return g(n.get(e))}var n,r,a=e.dom,m=":not(tw-error, tw-error *)",o=g();this.next&&(o=o.add(l.call(this.next,e)));if(this.selector){if("string"===this.selector.type)i=this.selector.data,n=c((n=a).textNodes(),i),r=g(),n.forEach(function(e){r=r.add(g(e).wrapAll("<tw-pseudo-hook>").parent())}),i=r;else{if("base"===this.selector.type)return o.add(t(l.call(this.selector.data,e),this.property));n=this.selector.data,e='tw-hook[name="'+(n=s.insensitiveName(n).replace(/"/g,"&quot;"))+'"],tw-enchantment[name="'+n+'"]';var e=e+={page:", tw-story",passage:", tw-passage",sidebar:", tw-sidebar",link:", tw-link, .enchantment-link"}[n]||"",i=a.findAndFilter(e).add(a.parentsUntil(s.storyElement.parent())).filter(e)}o=this.property?o.add(t(i,this.property)):o.add(i)}return o=o.get().reduce(function(e,t){return t=g(t),e.add(t.is("tw-enchantment")&&t.contents().length<=1?t.contents():t)},g())}function a(e){var t,n;return e?(t=e.selector,n=e.property,e=e.next,[JSON.stringify(["base"===t.type?a(t.data):s.insensitiveName(t.data),n])].concat(_toConsumableArray(a(e))).sort()):[]}var o=Object.freeze({forEach:function(e,n){var t=l.call(this,e).each(function(e,t){return n(g(t),e)});return e.dom.findAndFilter("tw-pseudo-hook").contents().unwrap(),t},hooks:function(e){return l.call(this,e)},get TwineScript_ObjectName(){return"the hook name ".concat(this.TwineScript_ToSource())},TwineScript_TypeID:"hookName",TwineScript_TypeName:"a hook name (like ?this)",TwineScript_Unstorable:!0,TwineScript_ToSource:function(){var e="",t=this.selector,n=t.type,t=t.data;return"name"===n?t.match(RegExp("^"+s.anyRealLetter+"+$"))?e+="?"+t:e+="(hooks-named:"+JSON.stringify(t)+")":"string"===n?e+=JSON.stringify(t):"base"===n&&(e+=t.TwineScript_ToSource()+"'s "+r(this.property,"property")),this.next&&(e+=" + "+this.next.TwineScript_ToSource()),e},"TwineScript_+":function(e){for(var t=this.TwineScript_Clone(),n=t;n.next;)n=n.next;return n.next=e,t},TwineScript_is:function(e){return a(this)+""==a(e)+""},TwineScript_GetProperty:function(e){return o.create({type:"base",data:this},e,void 0)},TwineScript_Properties:["chars","links","lines","visited"],TwineScript_Clone:function(){return o.create(this.selector,this.property,this.next)},create:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0;return Object.assign(Object.create(this||o),{selector:Object.freeze(e),property:t,next:n})},from:function(e){return o.isPrototypeOf(e)||"string"==typeof e||s.impossible("HookSet.from() was given a non-HookSet non-string."),o.isPrototypeOf(e)?e:o.create({type:"string",data:e})}});return o}),define("datatypes/lambda",["utils/operationutils","internaltypes/varscope","internaltypes/varref","internaltypes/twineerror"],function(e,h,s,m){var g=e.objectName;var c=Object.freeze({TwineScript_TypeID:"lambda",TwineScript_TypeName:"a lambda",get TwineScript_ObjectName(){return'a "'+("making"in this?"making ... ":"")+("each"in this?"each ... ":"")+("where"in this?"where ... ":"")+("when"in this?"when ... ":"")+("via"in this?"via ... ":"")+'" lambda'},TwineScript_Print:function(){return"`[A lambda]`"},TwineScript_is:function(e){return e===this},TwineScript_ToSource:function(){return this.source},TypeSignature:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{pattern:"lambda",innerType:c,clauses:t,typeName:'a "'+t.concat("").join(" ...")+'" lambda'}},TwineScript_Clone:function(){return Object.assign(Object.create(c),this)},create:function(e,t,n,r){var a,o="temp variable, or typed temp variable";function i(e){e=e&&e.varRef?e.varRef:e;return void 0===e||e&&s.isPrototypeOf(e)&&h.isPrototypeOf(e.object)&&1===e.propertyChain.length}if(m.containsError(n))return n;if("making"===t&&!i(n))return m.create("syntax","I need a "+o+", to the right of '"+t+"', not "+g(n)+".");if(m.containsError(e))return e;if(c.isPrototypeOf(e)){if("when"===t||"when"in e)return m.create("syntax","A 'when' lambda cannot have any other clauses, such as '"+t+"'.");if(t in e)return m.create("syntax","This lambda has two '"+t+"' clauses.");a=e}else{if("when"===t&&void 0!==e)return m.create("syntax","A 'when' lambda shouldn't begin with a temp variable (just use 'when' followed by the condition).");if(!i(e))return m.create("syntax","This lambda needs to start with a single "+o+", not "+g(e)+".");(a=Object.create(this)).loop=e||""}return a.source=r.trim(),a[t]=n,a.making&&a.making.getName()===(a.loop&&a.loop.getName())?m.create("syntax","This lambda has two variables named '"+a.loop.getName()+"'.","Lambdas should have all-unique parameter names."):a},apply:function(e,t){var n=t.loop,r=t.pos,a=t.making,o=t.ignoreVia;function i(e,t){if(e){var n,r;if("datatype"in e&&"varRef"in e)return n=e.varRef.create(s,e.varRef.propertyChain),m.containsError(n)?n:(r=n.defineType(e.datatype),m.containsError(r)||(r=n.set(t),m.containsError(r))?r:void 0);s[e.getName()]=t}}var s=(s=t.tempVariables)||Object.create(e.stack.length?e.stackTop.tempVariables:h),t=i(this.loop,n)||i(this.making,a);if(m.containsError(t))return t;e.stack.unshift(Object.assign(Object.create(e.stackTop||null),{tempVariables:s,lambdaPos:this.when?void 0:r})),!n||this.making||this.when?e.Identifiers.it=m.create("operation","I can't use 'it', or an implied 'it', in "+this.TwineScript_ObjectName):e.Identifiers.it=n;var c,l,u,p,d,t=!o&&this.via,o="where"in this||"when"in this,f=e.evalReplay;return e.evalReplay=f?[]:null,o?(c=e.eval(this.where||this.when),l=e.evalReplay,e.evalReplay=l&&t?[]:null,!n||this.making||this.when||(e.Identifiers.it=n),u=c,p=!t||e.eval(t),d=null,u=m.containsError(u)||("boolean"!=typeof u?m.create("operation","This lambda's 'where' clause must evaluate to true or false, not "+g(u)+"."):u?p:d)):c=u=!t||e.eval(t),p=t?e.evalReplay:null,e.stack.shift(),(e.evalReplay=f)&&(o||t)&&(((d=f[f.length-1])||{}).lambda&&d.lambda.obj===this||((d={lambda:{obj:this,loops:[]},code:(f[f.length-1]||{}).code||""}).fromCode=d.code,f.push(d)),d.lambda.loops.push(_objectSpread(_objectSpread(_objectSpread({it:n,pos:r},void 0!==a&&{making:a}),t&&{viaReplay:p,viaResult:u}),o&&{whereReplay:l,whereResult:null!==c&&c}))),u},filter:function(r,e){var a,o=this,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return e.reduce(function(e,t,n){return a||(n=o.apply(r,{loop:t,pos:n+1,ignoreVia:!0,tempVariables:i}),a=m.containsError(n))||e.concat(n?[t]:[])},[])}});return c}),define("datatypes/typedvar",["utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(e,a,o){var i=e.typeName,t=e.matches,n=e.toSource,s=e.unstorableValue,e=Object.freeze,c=Object.assign,l=Object.create,u=e({TwineScript_TypeName:"a TypedVar (typed variable name)",get TwineScript_ObjectName(){var e=n(this.datatype);return"the ".concat(e.length<24?e+"-":"","typed variable name, ").concat(this.varRef.TwineScript_ToSource())},TwineScript_Print:function(){return"`[A typed variable name]`"},TwineScript_Unstorable:!0,TwineScript_Clone:function(){return c(l(u),{datatype:this.datatype.TwineScript_Clone(),varRef:this.varRef})},TwineScript_ToSource:function(){return n(this.datatype)+"-type "+this.varRef.TwineScript_ToSource()},TwineScript_GetProperty:function(e){return"name"===e?this.getName():this[e]},TwineScript_Properties:["datatype","name"],TwineScript_IsTypeOf:function(e){return t(this.datatype,e)},get:function(){var e;return(e=this.varRef).get.apply(e,arguments)},getName:function(){return this.varRef.getName()},defineType:function(){if("any"!==this.datatype.name)return this.varRef.defineType(this.datatype)},create:function(e,t){var n,r;return(n=o.containsError(t)||o.containsError(e)||t.error)||(a.isPrototypeOf(t)?(n=t.object,r=t.compiledPropertyChain,n&&n.TwineScript_VariableStore&&1===r.length&&n.TwineScript_TypeDefs?(r=s(e))&&!u.isPrototypeOf(r)?o.create("syntax","The -type syntax can't have "+i(r)+" to its left."):c(l(this),{datatype:e,varRef:t}):o.create("unimplemented","I can only restrict the datatypes of variables, not data names or anything else.")):o.create("syntax","The -type syntax must have a variable to its right."))}});return u}),define("datatypes/varbind",["jquery","utils","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(o,e,t,n,r){var a=t.objectName;return n.on("set",function(r,a){r.TwineScript_VariableStore&&e.storyElement.find("[data-2bind]").each(function(e,t){var n=(t=o(t)).data("twoWayBindEvent");"function"==typeof n&&n(t,r,a)})}),Object.freeze({TwineScript_TypeName:"a VarBind (bound variable name)",get TwineScript_ObjectName(){return"a ".concat(this.bind," bind to ").concat(this.varRef.TwineScript_ToSource())},TwineScript_Print:function(){return"`[A bound variable name]`"},TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return("two way"===this.bind?"2":"")+"bind "+this.varRef.TwineScript_ToSource()},set:function(e){var e=this.varRef.set(e);if(e=r.containsError(e))return e},create:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"one way";return r.containsError(e)?e:n.isPrototypeOf(e)?e.error||Object.assign(Object.create(this),{varRef:e,bind:t}):r.create("operation","I can only 'bind' a variable, not "+a(e)+".")}})}),define("debugmode/highlight",["jquery","utils","utils/typecolours","macros","lexer"],function(u,e,t,p,n){var d=e.insensitiveName,f=t.versionClass,h=n.lex;return function(e,t,n,r){if(9999<e.length)return[u("<span>").text(e)];for(var a=h(e,"",t||"macro"),o=[],i="",s=a,c=a.start;c<a.end;c+=1){var l=a.pathAt(c);l[0]!==s[0]&&(o.length&&(o[o.length-1].textContent=i),i="",s=l,o.push(u("<".concat(r&&n<=c&&c<r?"mark":"span",' class="').concat(function(e){for(var t={},n="",r=0;r<e.length;r+=1){var a=e[r],o=a.type,i=a.text,s=("verbatim"!==o&&"comment"!==o||(n=""),f+o);switch(t[s]=(t[s]||0)+1,1<t[s]&&(s+="-"+t[s]),o){case"text":i.trim()&&e.slice(r+1).reduce(function(e,t){return void 0===e?"macro"===t.type||"hook"!==t.type&&e:e},void 0)&&(s+=" ".concat(f,"error"));break;case"macroName":var c,l=e[r].text[0];"_"!==l&&"$"!==l?(c=d(e[r].text.slice(0,-1)),p.has(c)?s+="-"+p.get(c).returnType.toLowerCase():s+=" ".concat(f,"error")):s+=" ".concat(f,"customMacro ").concat(f+("_"===l?"tempV":"v"),"ariable")}n+=s+" "}return n}(s),'">'))[0])),i+=a.text[c-a.start]}return o.length&&(o[o.length-1].textContent=i),o}}),define("debugmode/mode",["jquery","utils","utils/naturalsort","state","engine","internaltypes/varref","internaltypes/twineerror","utils/operationutils","utils/renderutils","passages","section","debugmode/panel","debugmode/highlight","utils/typecolours"],function(I,V,M,D,F,L,H,e,t,z,q,W,B,n){var U=e.objectName,$=e.isObject,G=e.toSource,Y=e.typeID,J=t.dialog,X=n.CSS,K=function(e,t){var f=V.escape,i=V.nth,n=V.debounce,r=I(document.documentElement),a=M(),o={darkMode:!0,fadePanel:!0,evalReplay:!0,width:null,maxHeight:400};if(D.hasStorage)try{var s=localStorage.getItem("(Debug Options "+V.options.ifid+")");s&&(o=JSON.parse(s))}catch(e){}function c(){if(D.hasStorage)try{localStorage.setItem("(Debug Options "+V.options.ifid+")",JSON.stringify(o))}catch(e){}}W.defaultMaxHeight=o.maxHeight;function l(e){return n(function(){if(V.options.debug)return e.apply(this,arguments)},{maxWait:2e3})}var h=I('<tw-debugger class="'.concat([o.darkMode?"theme-dark":"",o.fadePanel?"fade-panel":""].join(" "),'" style="').concat(o.width?"width:"+o.width+"px":"","\">\n<div class='panel panel-errors' hidden><table></table></div>\n<div class='tabs'></div>\n<label style='user-select:none'>Turns: </label><select class='turns' disabled></select>\n<button class='show-invisibles'>\ud83d\udd0d Debug View</button>\n<button class='show-dom'><span style=\"vertical-align:text-top\">&lt;</span><span style=\"vertical-align:text-bottom\">&gt;</span> DOM View</button>\n<button class='close'>\u2716</button>\n<div class='resizer-h'>\n</tw-debugger>")),s=h.find(".tabs"),u=h.find(".show-dom"),p=h.find(".show-invisibles"),d=h.find(".close"),m=h.find(".turns");I(document.documentElement).on("click","tw-expression, tw-error, tw-eval-explanation",n(function(e){var r,a,o,i,l,u,p,d,t=I(e.target).data("evalReplay");function n(){var e,s,c=r[a],t=o.find("tw-eval-explanation").empty(),n=o.find("tw-eval-code");c.toCode||c.toDesc||c.error||c.lambda?(o.find("tw-eval-code").empty().append(B(c.code,"macro",0<a&&c.start,0<a&&c.end+c.diff)),t.append(c.lambda?"":"<code class='".concat(56<c.fromCode.length?"from-block":"from-inline","'></code>"),c.error?"<span> caused an error: </span>":c.lambda?"<span>The lambda <code class='to-lambda'></code> was run, producing these results.</span>":"<span> became".concat(c.ToDesc?"\u2026":""," </span>").concat(c.toDesc?"<span class='to-desc'>".concat(f(c.toDesc),".</span>"):"<code class='to-code'></code>")),c.error?t.append(c.error):c.lambda?(s=function(e,t){return I("<".concat(e,"><code></").concat(e,">")).find("code").append(B(t,"macro")).end()},t.find(".to-lambda").append(B(c.lambda.obj.source,"macro")).end().append((e=I("<table>")).append.apply(e,[I("<tr>").append(s("th","pos"),c.lambda.obj.loop?s("th","_"+c.lambda.obj.loop.getName()).append(" / ",I("<code>").append(B("it","macro"))):s("th","it"),c.lambda.obj.making&&s("th","_"+c.lambda.obj.making.getName()),c.lambda.obj.where&&s("th","where").append(" result"),c.lambda.obj.via&&s("th","via").append(" result"))].concat(_toConsumableArray(c.lambda.loops.map(function(e){var t=e.it,n=e.pos,r=e.making,a=e.whereResult,o=e.whereReplay,i=e.viaResult,e=e.viaReplay;return I("<tr>").append(s("td",G(n)),s("td",G(t)),void 0!==r&&s("td",G(r)),null!=a&&(H.containsError(a)?I("<td>").append(a.render(c.lambda.obj.source,!0)):s("td",G(a))).append(o&&I("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",o)),null!=i&&(H.containsError(i)?I("<td>").append(i.render(c.lambda.obj.source,!0)):s("td",G(i))).append(e&&I("<tw-open-button replay label='\ud83d\udd0d'>").data("evalReplay",e)))})))))):c.toDesc||t.find(".to-code").append(B(c.toCode,"macro")),t.next().html(c.itIdentifier?'(The <code class="cm-harlowe-3-identifier">it</code> identifier now refers to '.concat(f(c.itIdentifier),".)"):"").next().text(c.reason||"")):(n.html(B(c.code,"macro")),t.html("<center>First, there was <code></code>.</center>").next().empty().next().empty()),c.lambda||t.find("code").first().append(B(c.fromCode,"macro")),o.find("mark").each(function(e,t){t.scrollIntoView()}),i.css("visibility",a<=9?"hidden":"visible"),l.css("visibility",a<=0?"hidden":"visible"),p.css("visibility",a>=r.length-1?"hidden":"visible"),d.css("visibility",a>=r.length-10?"hidden":"visible"),u.html("( ".concat(a+1,"/").concat(r.length," )"))}t&&(r=t,t=J({buttons:[{name:"Understood",confirm:!(a=0),callback:function(){return!h.find("tw-backdrop").length&&h.removeClass("show-dialog")}}]}).addClass("eval-replay"),o=I("<tw-eval-replay>".concat(1===r.length?"":"<tw-eval-code></tw-eval-code>","<tw-eval-explanation></tw-eval-explanation><tw-eval-it></tw-eval-it><tw-eval-reason></tw-eval-reason>").concat(1===r.length?"":"<tw-dialog-links><tw-link style='visibility:hidden'>\u2190 10</tw-link><tw-link style='visibility:hidden'>\u2190 \u2190</tw-link><b></b><tw-link>\u2192 \u2192</tw-link><tw-link>10 \u2192</tw-link></tw-dialog-links>","</tw-eval-replay>")),t.find("tw-dialog").css({width:"75vw","max-width":"75vw"}).prepend(o),i=o.find("tw-link:first-of-type"),l=i.next(),u=l.next(),p=u.next(),d=p.next(),n(),i.on("click",function(){a=Math.max(0,a-10),n()}),l.on("click",function(){a=Math.max(0,a-1),n()}),p.on("click",function(){a=Math.min(r.length-1,a+1),n()}),d.on("click",function(){a=Math.min(r.length-1,a+10),n()}),h.find("tw-backdrop").length?h.find("tw-backdrop").before(t):h.addClass("show-dialog").append(t));var s,t=I(e.target).data("goto");t&&(s=V.options.ignoreGotos,V.options.ignoreGotos=!1,t.command.TwineScript_Run(t.section),V.options.ignoreGotos=s),e.stopPropagation()})),h.find(".resizer-h").mousedown(function(e){if(1!==e.which)return!0;e.stopPropagation();var t=e.pageX,n=h.width();r.on("mousemove.debugger-resizer-h",function(e){e=e.pageX;h.width("".concat(n+t-e|0,"px"))}).on("mouseup.debugger-resizer-h",function(){r.off(".debugger-resizer-h"),o.width=h.width(),c()})}),h.on("mousedown",".resizer-v",function(e){if(1!==e.which)return!0;e.stopPropagation();var t=e.pageY,n=I(e.target.parentNode).height();r.on("mousemove.debugger-resizer-v",function(e){e=e.pageY;h.find(".panel").css("maxHeight","".concat(n+t-(0|e),"px"))}).on("mouseup.debugger-resizer-v",function(){r.off(".debugger-resizer-v"),o.maxHeight=h.find(".panel").css("maxHeight"),c()})}),p.click(function(){r.toggleClass("debug-mode").removeClass("dom-debug-mode"),p.toggleClass("enabled"),u.removeClass("enabled")}),u.click(function(){r.toggleClass("dom-debug-mode").removeClass("debug-mode"),u.toggleClass("enabled"),p.removeClass("enabled")}),d.click(function(){r.removeClass("debug-mode dom-debug-mode"),h.detach(),Object.assign(V.options,{debug:!1,speedMultiplier:1,ignoreClickEvents:!1,ignoreGotos:!1})});function g(e){(e=e.parents(".variable-row, .enchantment-row, .source-row")).next(".panel-row-source").find("td").empty().append(B(e.data("value")||G(e.data("enchantment").changer),e.is("source-row")?"markup":"macro"))}function y(){return k=new Set}function b(){I(document.body).append(h),V.options.debug=!0,V.options.evalReplay=o.evalReplay,V.options.speedMultiplier=1,V.options.ignoreClickEvents=!1,V.options.ignoreGotos=!1,R()}var v,w=l(function(){var r=m.children().get(),e=D.timeline,a=0;e.forEach(function(e,t){var n=e.turns,e=e.passage,n=(a+=1+(void 0===n?0:n))+": "+e;r[t]?r[t].textContent=n:m.append("<option value='".concat(t,"'>").concat(n,"</option>"))}),e.length<r.length&&I(r.slice(e.length)).remove(),m[1<=e.length?"removeAttr":"attr"]("disabled"),m.val(D.pastLength)}),k=(m.change(function(e){e=e.target.value-D.pastLength;0!=e&&(D[e<0?"rewind":"fastForward"](Math.abs(e)),F.showPassage(D.passage))}),w(),D.on("forward",w).on("load",w).on("forgetUndos",function(){return w}).on("back",function(){D.pastLength<=1&&m.attr("disabled"),m.find("[selected]").removeAttr("selected"),m.val(D.pastLength)}),new Set),S=W.create({className:"variables",tabName:"Variable",rowWrite:function(e,t){var n,r=e.name,a=e.dataset,o=e.path,i=e.value,s=e.tempScope,e=e.type,c=i&&48<i.length&&!i.TwineScript_DebugName,l=$(i)&&i.TwineScript_DebugName?i.TwineScript_DebugName():f(U(i)),u="",a=(o.length&&(u=o.reduce(function(e,t){return e+t+"'s "},"")),a&&(r="???"),e?G(e):""),e="object"===_typeof(i)||c;return t?(t[0].firstChild.innerHTML=a||"",u&&I(t[0].firstChild).children(".variable-path").html((s?"_":"$")+f(u)),t[0].childNodes[1].lastChild.textContent=(u?"":s?"_":"$")+f(r+""),t[0].childNodes[2].textContent=s||"",t[0].childNodes[3].innerHTML=l,n=(c=I(t[0].lastChild.firstChild)).is(".open"),c[e?"show":"hide"](),c=t.next(".panel-row-source"),n&&c.find("td").empty().append(B(G(i))),t.data("value",G(i)),t.add(c)):I('<div class="variable-row">').attr("data-name",r).attr("data-path",o+"").attr("data-scope",s||"").css("padding-left",Math.min(5,o.length)+"em").append("<td class='variable-type'>".concat(a||"","</td>"),"<td class='variable-name cm-harlowe-3-"+(s?"tempV":"v")+"ariable'><span class='variable-path'>"+(u?(s?"_":"$")+f(u):"")+"</span> "+(u?"":s?"_":"$")+f(r+"")+"</td>","<td class='temporary-variable-scope'>".concat(s||"","</td>"),"<td class='variable-value cm-harlowe-3-macroName-"+Y(i)+"'>"+l+"</td><td class='panel-row-buttons'><tw-folddown tabindex=0 style='display:"+(e?"visible":"none")+"'>(source:) </tw-folddown></td>").data("value",G(i)).find("tw-folddown").data("folddown",g).end().add("<tr class='variable-row panel-row-source' style='display:none'><td colspan='5'></td></tr>")},rowCheck:function(e,t){var n=e.name,r=e.path,e=e.tempScope;return t[0]&&t[0].getAttribute("data-name")===n&&t[0].getAttribute("data-path")===r+""&&t[0].getAttribute("data-scope")===e},columnHead:function(){return'<tr class="panel-head"><th data-col="variable-type">Type</th><th data-col="variable-name">Name</th><th data-col="temporary-variable-scope">Scope</th><th data-col="variable-value">Value</th></tr>'},rowSort:function(e,t,n){if("variable-value"===e)return a(t.attr("class"),n.attr("class"))||a(t.parent().data("value"),n.parent().data("value"))}}),T=l(function(){var e,t,o=[],n=D.variables,r=o.length;for(e in n)e.startsWith("TwineScript")||(r+=1,function n(e){var r,t,a;500<o.length||(o.push(e),r=e.path.concat(e.name),t=e.value,a=e.tempScope,r.length<=4&&(Array.isArray(t)?t.forEach(function(e,t){return n({name:i(t+1),path:r,value:e,tempScope:a})}):t instanceof Map?_toConsumableArray(t).forEach(function(e){var t=(e=_slicedToArray(e,2))[0],e=e[1];return n({name:t,path:r,value:e,tempScope:a})}):t instanceof Set&&_toConsumableArray(t).forEach(function(e,t){return n({name:t,dataset:!0,path:r,value:e,tempScope:a})})))}({name:e,path:[],value:n[e],tempScope:"",type:null==(t=n.TwineScript_TypeDefs)?void 0:t[e]}));o.push.apply(o,_toConsumableArray(k)),r+=k.size,S.update(o,r),0===r!==S.panel[0].classList.contains("panel-variables-empty")&&S.panel.toggleClass("panel-variables-empty")}),_=(L.on("set",function(e,t,n){var r,a;e===D.variables||"temp"!==(null==(a=e.TwineScript_VariableStore)?void 0:a.type)||null!=(a=e.TwineScript_VariableStore)&&a.name.match(/#\d+$/)||(r=null==(a=e.TwineScript_VariableStore)?void 0:a.name,e=null==(a=e.TwineScript_TypeDefs)?void 0:a[t],(a=_toConsumableArray(k).find(function(e){return e.name===t&&e.tempScope===r}))?a.value=n:k.add({name:t,path:[],value:n,tempScope:r,type:e})),T(),v()}).on("delete",function(){T(),v()}),S.panel.append("<div class='panel-variables-bottom'>\n\t\t\t<button class='panel-variables-copy'>Copy $ variables as (set:) call</button>\n\t\t\t<input class='clipboard' type=\"text\" style='opacity:0;pointer-events:none;position:absolute;'></input>\n\t\t</div>").removeAttr("hidden"),S.tab.addClass("enabled"),S.panel.find(".clipboard")),x=(r.on("click",".panel-variables-copy",function(){var e,t=[];for(e in D.variables)e.startsWith("TwineScript")||t.push("$"+e+" to "+G(D.variables[e]));_.val("(set:"+t+")")[0].select(),document.execCommand("copy")}),W.create({className:"enchantments",tabName:"Enchantment",rowWrite:function(e,t){var n=e.scope,r=e.changer,a=e.lambda,o=e.name,i=e.localHook,a=r?f(U(r)):a?f(G(a)):"<em>enchanted with ("+o+":)</em>";return t||I('<div class="enchantment-row">').data("enchantment",e).append("<td><span class='enchantment-name'>"+G(n)+(i?"</span><span class='enchantment-local cm-harlowe-3-hookName'>"+("function"==typeof i.TwineScript_ToSource?i.TwineScript_ToSource():i.attr("name")?"?"+i.attr("name"):"an unnamed hook"):"")+"</span></td><td class='enchantment-value cm-harlowe-3-macroName-"+(r?"changer":"command")+" '>"+a+"</td>"+(r?"<td class='panel-row-buttons'><tw-folddown tabindex=0>(source:)</tw-folddown></td>":"")).find("tw-folddown").data("folddown",g).end().add(r?I("<tr class='panel-row-source' style='display:none'><td colspan='3'></td></tr>"):"")},rowCheck:function(e,t){return t.data("enchantment")===e},columnHead:function(){return'<tr class="panel-head"><th data-col="enchantment-name">Scope</th><th data-col="enchantment-value">Value</th></div>'}})),d=l(function(e){x.update(e.enchantments,e.enchantments.length)}),O=(q.on("add",d).on("remove",d),q.create()),A=W.create({className:"storylets",tabName:"Storylet",rowWrite:function(e,t){var n=e.name,r=e.active,a=e.storyletSource,o=e.exclusive,e=e.urgent;return t?(t.toggleClass("storylet-closed",!r),t[0].firstChild.textContent=r?"\u2713":""):(t=I('<tr class="storylet-row '.concat(r?"":"storylet-closed",'">')).attr("data-name",n).append("<td class='storylet-open'>"+(r?"\u2713":"")+"</td><td class='storylet-name'>"+n+"</td><td class='storylet-lambda'></td><td class='storylet-exclusive'>"+o+"</td><td class='storylet-urgent'>"+e+"</td>")).find(".storylet-lambda").append(B(a.replace(/^when\s+/i,""))),t},rowCheck:function(e,t){e=e.name;return t[0].getAttribute("data-name")===f(e+"")},columnHead:function(){return'<tr class="panel-head"><th data-col="storylet-open" data-order="desc">Open</th><th data-col="storylet-name">Name</th><th data-col="storylet-lambda">Condition</th><th data-col="storylet-exclusive" class=\'storylet-exclusive\'>Exclusivity</th><th data-col="storylet-urgent" class=\'storylet-urgent\'>Urgency</th></tr>'}}),C=(A.tab.hide(),v=l(function(){var r,a,o=z.getStorylets(O),i=H.containsError(o),e=z.allStorylets();A.update(e.map(function(t){var e="number"==typeof t.get("exclusivity")?t.get("exclusivity"):0,n="number"==typeof t.get("urgency")?t.get("urgency"):0;return r=r||e,a=a||e,{name:t.get("name"),storyletSource:t.get("storylet").TwineScript_ToSource(),active:!i&&o.some(function(e){return e.get("name")===t.get("name")}),exclusive:e,urgent:n}}),i?0:o.length),A.panel.toggleClass("storylet-error",i),A.panel.toggleClass("panel-exclusive",r),A.panel.toggleClass("panel-urgent",a),e.length&&A.tab.show()}),W.create({className:"source",tabName:"Source",tabNameCounter:!1,rowWrite:function(e,t){var n=e.name,e=e.tag;return t?t.add(t.next(".panel-row-source")):(t=z.get(n).get("source"),I('<div class="source-row" data-tag="'.concat(e,'">')).data("value",t).append('<td class="source-name">'.concat(n,'</td><td class="source-tags">').concat(e,"</td><td class='panel-row-buttons'><tw-folddown class='").concat(e?"":"open","' tabindex=0></tw-folddown></td>")).find("tw-folddown").data("folddown",g).end().add(I("<tr class='panel-row-source' style='".concat(e?"display:none":"","'><td colspan='3'></td></tr>")).find("td").append(!e&&B(t,"markup")).end()))},rowCheck:function(e,t){e=e.name;return t[0].firstChild.textContent===f(e+"")},tabUpdate:I.noop,columnHead:I.noop})),E=["debug-startup","startup","header","debug-header","footer","debug-footer"].reduce(function(e,t){return e.concat(z.getTagged(t).map(function(e){return{name:e.get("name"),tag:t}}))},[]),N=W.create({className:"errors",tabName:"Error",rowWrite:I.noop,rowCheck:I.noop,columnHead:I.noop,tabUpdate:function(e){return N.tab.css({background:e?"rgba(230,101,204,0.3)":""}).text("".concat(e," Error").concat(1!==e?"s":""))}}),d=n(function(e){var t;V.options.debug&&(N.panelRows.append(e.reduce(function(e,t){var t=_slicedToArray(t,2),n=t[0],t=t[1];return"propagated"===n.type?e:e+'<tr class="error-row"><td class="error-passage">'+D.passage+'</td><td class="error-message" title="'+f(t)+'">'+n.message+"</td></tr>"},"")),500<(t=(e=N.panelRows.children()).length)&&I(Array.prototype.slice.call(N.panelRows[0].childNodes,0,t-500)).remove(),N.tabUpdate(Math.min(500,e.length)))},{batch:!0}),j=(H.on(d),N.panel.append("<div class='panel-errors-bottom'>\n\t\t\t<button class='panel-errors-clean'>\ud83e\uddf9 Clear this panel</button>\n\t\t</div>"),r.on("click",".panel-errors-clean",function(){N.panelRows.empty(),N.tabUpdate(0)}),W.create({className:"tools",tabName:"Tools",tabNameCounter:!1,rowWrite:function(e,t){var n=e.id,r=e.type,a=e.label,o=e.dropdownItems,i=e.dropdownValue;return"checkbox"===r?t?t.find("input").prop("checked",!1):I('<span><input id="debug-'.concat(n,'" type="checkbox"></input><label for="debug-').concat(n,'">').concat(a,"</label></span>")):"dropdown"===r?t?t.find("input").prop("checked",!1):I("<span>".concat(a,'<select style="width:3em" data-default="').concat(i,'" id="debug-').concat(n,'"></span>')).find("select").append(o.map(function(e){return"<option value='".concat(e,"' ").concat(e===i?"selected":"",">").concat(e,"x</option>")})).end():void 0},rowCheck:I.noop,columnHead:I.noop,tabUpdate:function(e){return j.tab.css({background:e?"hsla(210, 72%, 65%, .3)":""})}})),P=(r.on("click, change",'.panel-tools [type="checkbox"], .panel-tools select',function(e){var e=e.target,t=(e=I(e)).attr("id"),n=e.is(":checked")||e.is("select")&&e.val()!==+e.attr("data-default");"debug-peekBehindDialogs"===t&&r.toggleClass("debug-dialogs",n),"debug-ignoreClickEvents"===t&&(V.options.ignoreClickEvents=n),"debug-ignoreGotos"===t&&(V.options.ignoreGotos=n),"debug-speedMultiplier"===t&&(V.options.speedMultiplier=+e.val()),j.tabUpdate(n)}),j.update([{id:"peekBehindDialogs",type:"checkbox",label:"See through and click through <code>(dialog:)</code> boxes"},{id:"ignoreClickEvents",type:"checkbox",label:"Stop links, <code>(click:)</code> and <code>(hover-style:)</code> from activating"},{id:"ignoreGotos",type:"checkbox",label:"Stop <code>(go-to:)</code>, <code>(undo:)</code>, <code>(redirect:)</code> and <code>(restart:)</code> from activating<br><small>(Click 'GO' buttons in Debug View to activate later)</small>"},{id:"speedMultiplier",label:"Speed of timed events (<code>time</code>, <code>(live:)</code>, <code>(after:)</code>): ",type:"dropdown",dropdownValue:1,dropdownItems:[.25,.5,.75,1,1.25,1.5,1.75,2,3,5,10]}]),W.create({className:"options",tabName:"\u2699\ufe0f",tabNameCounter:!1,rowWrite:function(e,t){var n=e.name,e=e.label,r={darkMode:o.darkMode,fadePanel:o.fadePanel,evalReplay:o.evalReplay}[n];return t?t.find("input").prop("checked",r):I('<span><input id="debug-'.concat(n,'" type="checkbox" ').concat(r?"checked":"",'></input><label for="debug-').concat(n,'">').concat(e,"</label></span>"))},rowCheck:I.noop,tabUpdate:I.noop,columnHead:I.noop})),R=(r.on("click",'.panel-options [type="checkbox"]',function(e){var e=e.target,t=(e=I(e)).attr("id"),e=e.is(":checked");"debug-darkMode"===t&&(o.darkMode=e,h.toggleClass("theme-dark",e)),"debug-fadePanel"===t&&(o.fadePanel=e,h.toggleClass("fade-panel",e)),"debug-evalReplay"===t&&(V.options.evalReplay=o.evalReplay=e),c()}),P.update([{name:"darkMode",label:"Debug panel is dark"},{name:"fadePanel",label:"Debug panel is transparent unless the cursor is over it"},{name:"evalReplay",label:"Record expression replays (viewable via \ud83d\udd0d buttons in Debug View; slower)"}]),h.prepend(S.panel,x.panel,N.panel,A.panel,C.panel,j.panel,P.panel),s.prepend(S.tab,x.tab,N.tab,A.tab,C.tab,j.tab,P.tab),D.on("beforeForward",y).on("beforeBack",y).on("beforeLoad",y),l(function(){T(),v(),x.panelRows.empty(),x.tabUpdate(0),D.passage&&z.get(D.passage)&&(C.update(E.concat({name:D.passage,tag:""})),C.panel.find('[data-tag=""], [data-tag=""] + .panel-row-source').insertBefore(C.panel.find('[data-tag="footer"]').first()))}));D.on("forward",R).on("back",R).on("load",R);K=b,I(document.head).append(I("<style>").html(X)),b(),e&&d(e,t)};return F.registerDebugMode(function(e,t){return!V.options.debug&&K(e,t)}),K}),define("debugmode/panel",["jquery","utils/naturalsort"],function(d,e){var i=e();return Object.seal({create:function(e){var n,t=e.className,r=e.rowWrite,a=e.rowCheck,o=e.rowSort,i=e.columnHead,s=e.tabName,c=e.tabNameCounter,l=void 0===c||c,c=e.tabUpdate,u=d("<div class='panel panel-".concat(t,"' style='").concat(this.defaultMaxHeight?"max-height:"+this.defaultMaxHeight+"px":"","' hidden><div class=\"resizer-v\"></div><table class='panel-rows'></table></div>")),p=d("<button class='tab tab-".concat(t,"'>").concat(l?"0 ".concat(s,"s"):s,"</button>"));return p.click(function(){p.toggleClass("enabled"),p.parent().siblings(".panel").attr("hidden",""),p.is(".enabled")&&(p.siblings(".tab:not(.tab-"+t+")").removeClass("enabled"),u.removeAttr("hidden"))}),u.on("click","th",function(e){var e=e.target,t="desc"===(e=d(e)).attr("data-order")?"asc":"desc";n.sort(e.attr("data-col"),t),u.find("th[data-order]").removeAttr("data-order"),e.attr("data-order",t)}),c=c||function(e){return p.text(l?"".concat(e," ").concat(s).concat(1!==e?"s":""):s)},n=Object.assign(Object.create(this),{tabName:s,tab:p,panel:u,panelRows:u.find(".panel-rows"),rowWrite:r,rowSort:o,rowCheck:a,columnHead:i,tabUpdate:c})},sort:function(r,a){var o=this;this.panelRows.children(":not(.panel-head, .panel-row-source)").get().sort(function(e,t){var n;return"desc"===a&&(e=(n=[t,e])[0],t=n[1]),e=e.querySelector("."+r),t=t.querySelector("."+r),o.rowSort&&o.rowSort(r,d(e),d(t))||i(e.textContent,t.textContent)}).forEach(function(e){var t=d(e).next(".panel-row-source").get();o.panelRows.append(e,t)})},update:function(e,t){var r=this.rowCheck,a=this.rowWrite,o=this.panelRows,n=this.columnHead,i=this.panel,s=[],c=o.children(),e=(e.forEach(function(t){var e=c.get().filter(function(e){return r(t,d(e))}),n=a(t,e.length&&d(e));e.length||o.append(n),s.push.apply(s,_toConsumableArray(n.get()))}),c.filter(function(e,t){return!s.includes(t)&&!t.className.includes("panel-head")}).remove(),this.tabUpdate(t),0<t&&!o.find(".panel-head").length?o.prepend(n()):0===t&&o.find(".panel-head").remove(),i.find("th[data-order]"));e.length&&this.sort(e.attr("data-col"),e.attr("data-order"))},defaultMaxHeight:300})}),define("internaltypes/changedescriptor",["jquery","utils","renderer","datatypes/hookset","internaltypes/twineerror"],function(b,e,t,v,n){function w(e){return("string"==typeof e?e:e.map(function(e){return e.text}).join("")).split(/\n/g).reduce(function(e,t,n,r){r=r.length;return e.concat(document.createTextNode(t),n!==r-1&&document.createElement(t.length?"br":"tw-consecutive-br"))},[])}var k=e.impossible,S=e.transitionIn,T=t.exec,r=Object.assign,p=Object.keys,a=Object.create,e=Object.seal,_=Array.isArray,x={source:"",appendSource:null,enabled:!0,enablers:null,verbatim:!1,target:null,append:"",newTargets:null,transition:"",transitionTime:null,transitionDeferred:!1,transitionDelay:0,transitionSkip:0,transitionOrigin:null,loopVars:null,styles:null,attr:null,data:null,innerEnchantments:null,section:null,timestamp:0,output:!1,summary:function(){var t=this;return["source","appendSource","enabled","verbatim","target","append","newTargets","transition","transitionTime","transitionDeferred","transitionDelay","transitionSkip","transitionOrigin","innerEnchantments","enablers","output"].filter(function(e){return hasOwnProperty.call(t,e)}).concat([this.attr.length&&"attr",this.styles.length&&"styles",p(this.loopVars).length&&"loopVars",p(this.data).length&&"data"].filter(Boolean))},create:function(e,t){e=r(a(this),{attr:this.attr?this.attr.slice():[],styles:this.styles?this.styles.slice():[],loopVars:this.loopVars||{},data:this.data||{}},e);if(t){t=t.run(e);if(n.containsError(t))return t}return e},update:function(){function e(t){var e,n,r;_(a.styles)&&0<a.styles.length&&(n=(e=_slicedToArray(a.styles.reduce(function(n,r){return p(r).forEach(function(e){var t=r[e];n[+("function"==typeof t)].push(_defineProperty({},e,t))}),n},[[],[]]),2))[0],r=e[1],n.forEach(function(e){return t.css(e)}),setTimeout(function(){r.forEach(function(e){return t.css(e)})})),a.attr&&a.attr.forEach(function(e){return t.attr(e)}),a.data&&t.data(a.data)}var a=this,t=this.section,n=this.newTargets,r=this.transition,o=this.transitionDeferred,i=this.append,s=this.target;"function"==typeof s&&(s=s());if(_(n)&&n.length&&(s=n.map(function(e){return e.target})),_(s))for(var c=0;c<s.length;c+=1)v.isPrototypeOf(s[c])?s[c].forEach(t,e):e(s[c]);else v.isPrototypeOf(s)?s.forEach(t,e):e(s);if(r&&!o&&!i){for(var l,u=s;(l=u.data("timestamp"))||(u=u.parent()),!l&&u.length;);S(s,r,this.transitionTime,this.transitionDelay,this.transitionSkip,l?Date.now()-l:0,this.transitionOrigin)}},render:function(){var e,r=this,t=this.source,n=this.transition,a=this.transitionTime,o=this.transitionDeferred,i=this.enabled,s=this.enablers,c=this.data,l=this.section,u=this.newTargets,p=this.innerEnchantments,d=this.appendSource,f=this.output,h=this.target,m=this.target,g=this.append;if("function"==typeof h&&(h=h()),!g)return k("ChangeDescriptor.render","This doesn't have an 'append' method chosen."),b();if(f)return b();if(null!=s&&s.length)return s=(f=s[0]).descriptor,f=f.changer,s=s.render(),f&&(e=x.create({section:l,target:s}),f.run(e),e.update()),s;if(!i||void 0!==h.attr("hidden"))return x.create({target:h,attr:this.attr.filter(function(e){return!("style"in e)}),data:_objectSpread(_objectSpread({},c),{},{originalSource:t,hidden:!0})}).update(),b();if(!(h=_(u)&&u.length?u:h))return k("ChangeDescriptor.render","ChangeDescriptor has source but not a target!"),b();var y=b();if([].concat(h).filter(function(e){return!e.jquery}).map(function(e){var t,n,r=g;return e.target&&e.append&&(r=(t=e).append,n=t.before,e=e.target),{elements:e.hooks(l,m).filter(function(){return!(n&&1&this.compareDocumentPosition(document)&&2&this.compareDocumentPosition(m[0]))}),append:r}},[]).forEach(function(e){var t=e.elements,n=e.append;t.each(function(e,t){t=b(t),y=y.add(r.create({target:t,append:n,newTargets:null}).render()),t.filter("tw-pseudo-hook").contents().unwrap()})}),!(y.length||_(h)||v.isPrototypeOf(h))){f=g;if(!(f in h)){if("replace"!==f)return k("ChangeDescriptor.render","The target doesn't have a '"+f+"' method."),b();f=h[0]instanceof Text?"replaceWith":(h.empty(),"append")}h[0]instanceof Text&&"prepend"===(f="append"===f?"after":f)&&(f="before"),y=b(t&&(this.verbatim?w:T)(t)),_(d)&&d.forEach(function(e){var t=e.source,e=e.append,t=b((r.verbatim?w:T)(t));y="append"===e?y.add(t):"prepend"===e?t.add(y):t}),h[f](y.length?y:void 0),h.data("timestamp",Date.now()),this.update(),n&&!o&&S("replace"===g?h:y,n,a,this.transitionDelay,this.transitionSkip,this.expedite,this.transitionOrigin),p&&p.map(function(e){return e(h)}).forEach(function(e){return l.addEnchantment(e)})}return y}};return e(x)}),define("internaltypes/enchantment",["jquery","utils","internaltypes/changedescriptor","datatypes/changercommand","utils/operationutils","internaltypes/twineerror","utils/renderutils"],function(g,y,b,v,e,w,t){var k=e.objectName,S=e.toSource,T=t.collapse;return Object.freeze({create:function(e){return Object.assign(Object.create(this),{enchantments:g()},e)},enchantScope:function(){var i=this,s=this.attr,c=this.data,l=this.functions,u=this.section,p=this.scope,d=this.localHook,f=this.lambda,h=[],m=0;p.forEach(u,function(e,t){if(d){d=d.jquery?d:d.hooks(u);var n=e.find(d);if(n.length)e=n;else if(!d.has(e[0]).length)return}var r,a,o;(!e.is(":empty")||e.data("source")&&e.data("source").length)&&(m+=1,f?(o=f.apply(u,{loop:p.TwineScript_GetProperty(t),pos:m}),w.containsError(o)?(e.replaceWith(o.render()),f=o=null):v.isPrototypeOf(o)?o.canEnchant||(e.replaceWith(w.create("macrocall",'The lambda "'.concat(S(f),"\" can't be or include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).")).render()),f=o=null):(e.replaceWith(w.create("macrocall",'The lambda "'.concat(S(f),'" must return a changer, not ').concat(k(o),".")).render()),f=o=null)):o=i.changer,n=!s&&!c&&(!o||o.summary().every(function(e){return e.startsWith("transition")})),r=n?e:e.wrap("<tw-enchantment>").parent(),s&&r.attr(s),c&&r.data(c),l&&l.forEach(function(e){return e(r)}),o&&(t=b.create({section:u,target:r}),o.run(t),t.update(),e.is(y.storyElement)?(a=Object.keys(Object.assign.apply(Object,[{}].concat(_toConsumableArray(t.styles)))),e.css(a.reduce(function(e,t){return"background-color"===t||"background-image"===t?(e["background-color"]="transparent",e["background-image"]="none",a.push("background-".concat("background-color"===t?"image":"color"))):e[t]="inherit",e},{})),r.data({enchantedProperties:a})):e.is("tw-passage")&&t.styles.some(function(e){return"margin-left"in e||"margin"in e||"margin-right"in e})&&(o="padding-right",y.storyElement.css(t="padding-left","0px").css(o,"0px"),r.data({enchantedProperties:[t,o]}))),e.is(y.storyElement)&&r.css({"min-width":"100%","min-height":"100%"}),"true"===r.attr("collapsing")&&(r.find("[collapsing=false]").each(function(){g(this).removeAttr("collapsing")}),T(r)),n||h.push(r))}),this.enchantments=g(h)},disenchant:function(){this.enchantments.each(function(e,t){(t=g(t)).contents().unwrap();t=t.data("enchantedProperties");t&&y.storyElement.css(t.reduce(function(e,t){return e[t]="",e},{}))})}})}),define("internaltypes/twineerror",["jquery","utils"],function(i,s){var a=s.impossible,c=s.escape,l=(i(document.documentElement).on("click","tw-folddown",function(e){var t=e.target,e=((t=i(t)).toggleClass("open"),t.popData("folddown"));for("function"==typeof e&&e(t);t&&!t.next().length;)t=t.parent();null!=(e=t)&&e.next().toggle()}),{syntax:"The markup seems to contain a mistake.",saving:"I tried to save or load the game, but I couldn't do it.",operation:"I tried to perform an operation on some data, but the data's type was incorrect.",macrocall:"I tried to use a macro, but its call wasn't written correctly.",datatype:"I tried to use a macro, but was given the wrong type of data to it.",custommacro:"I tried to use a custom macro, but its code hook had a mistake in it.",infinite:"I almost ended up doing the same thing over and over, forever.",property:"I tried to access a value in a string/array/datamap, but I couldn't find it.",unimplemented:"I currently don't have this particular feature. I'm sorry.",propagated:"Click the 'Open' button to see the code hook as it was executed.",user:"This is a custom error created by (error:). It usually means you used a custom macro incorrectly.",assertion:"This command exists to provide a helpful error if a certain important condition wasn't true.",debugonly:"This macro is not meant to be used outside of debugging your story."}),u=[],n={TwineError:!0,create:function(e,t,n,r){return t&&"string"==typeof t||a("TwineError.create","has a bad message string"),n||e in l||a("TwineError.create","no error explanation given"),"user"!==e&&(t=t[0].toUpperCase()+t.slice(1)),Object.assign(Object.create(this),{type:e,message:t,explanation:n,source:void 0,innerDOM:r,appendTitleText:!1})},containsError:function(){for(var e=0;e<arguments.length;e+=1){var t=arguments[e];if(n.isPrototypeOf(t))return t;if(Array.isArray(t)){t=n.containsError.apply(n,t);if(t)return t}}return!1},createWarning:function(e,t){return Object.assign(this.create(e,t),{warning:!0})},render:function(t){var n=this,e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=(t="string"==typeof t?t:this.source||"",i("<tw-error class='"+(this.warning?"warning":"error")+"' title='"+c(t)+"'>"+c(this.message+(this.appendTitleText?" "+t:""))+"</tw-error>")),a=i("<tw-error-explanation>").text(this.explanation||l[this.type]).hide(),o=i("<tw-folddown tabindex=0>");return this.innerDOM&&i("<tw-open-button label='Open'>").on("click",function(){var e=i("<tw-backdrop><tw-dialog></tw-backdrop>");e.find("tw-dialog").prepend(n.innerDOM,i("<tw-link tabindex=0>OK</tw-link>").on("click",function(){n.innerDOM.detach(),e.remove()}).wrap("<tw-dialog-links>").parent()),s.storyElement.prepend(e)}).appendTo(r),r.append(o).append(a),r.data("TwineError",this),e||u.forEach(function(e){return e(n,t)}),r},on:function(e){return"function"!=typeof e||u.includes(e)||u.push(e),n}};return Object.preventExtensions(n)}),define("internaltypes/twinenotifier",["jquery","utils"],function(e,t){var n=t.impossible,r={create:function(e){return e||n("TwineNotifier.create","called with only 1 string."),Object.assign(Object.create(r),{message:e})},render:function(){return e("<tw-notifier>").attr("message",this.message)}};return Object.preventExtensions(r)}),define("internaltypes/varref",["state","internaltypes/twineerror","utils","utils/operationutils","datatypes/hookset"],function(u,p,e,t,i){var c,n=e.impossible,s=e.andList,r=e.nth,o=t.is,d=t.isObject,f=t.toSource,h=t.isSequential,m=t.objectName,l=t.typeName,g=t.clone,y=t.isValidDatamapName,b=t.subset,v=t.collectionType,w=t.unstorableValue,a=t.matches,k=Array.isArray,S={set:[],delete:[]},T="You can only access position strings/numbers ('4th', 'last', '2ndlast', (2), etc.), slices ('1stTo2ndlast', '3rdTo5th'), ",_="You can't access the '0th' or '0thlast' position of ";function x(e,t){if(p.containsError(t))return n;if(e instanceof Map&&(n=p.containsError(y(e,t))))return n;if(h(e))if("number"==typeof t){if(0===t)return p.create("property","You can't access elements at position 0 of ".concat(m(e),"."),"Only positive and negative position values exist.");0<t&&--t}else if("string"==typeof t&&(r=/^(\d+)(?:st|[nr]d|th)last$/i.exec(t))){if("0"===r[1])return p.create("property",_+m(e)+".");t=-r[1]}else if("string"==typeof t&&(r=/^(\d+)(?:st|[nr]d|th)$/i.exec(t))){if("0"===r[1])return p.create("property",_+m(e)+".");t=r[1]-1}else if("string"==typeof t&&(r=/^(?:(\d+)(?:st|[nr]d|th)(last)?|last)to(?:(\d+)(?:st|[nr]d|th)(last)?|last)$/i.exec(t))){var n=_slicedToArray(r,5),r=n[1],r=void 0===r?0:r,a=n[2],o=n[3],o=void 0===o?0:o;t={last:n[4]?-o:o-1,first:a?-r:r-1}}else if("last"===t)t=-1;else if("random"===t){if(!e.length)return p.create("property","I can't get a random value from ".concat(m(e),", because it's empty."));t=u.random()*Array.from(e).length|0}else{if(i.isPrototypeOf(e)&&!i.TwineScript_Properties.includes(t))return p.create("property","".concat(T+s(i.TwineScript_Properties.map(function(e){return"'"+e+"'"}))," of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."));if(!["length","some","any","all","start","end","random"].includes(t)&&!i.isPrototypeOf(e))return p.create("property","".concat(T,"'length', 'some', 'any', 'all', 'start', 'end', and 'random' of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."))}else if(e instanceof Set){if(!["length","some","any","all"].includes(t))return p.create("property","".concat(T,"'length', 'some', 'any', and 'all' of ").concat(m(e),"."),"You can't access specific individual data values from datasets.");"length"===t&&(t="size")}else{if(k(e.TwineScript_Properties)&&!e.TwineScript_Properties.includes(t))return p.create("property","You can only get the ".concat(s(e.TwineScript_Properties.map(function(e){return"'"+e+"'"}))," of ").concat(m(e),", not ").concat(("string"==typeof t?f:m)(t),"."));if("number"==typeof e||"boolean"==typeof e)return p.create("property","You can't get any data values, let alone ".concat(m(t),", from ").concat(m(e)))}return t}function O(e,t){return+t<0&&Math.abs(t)<=e.length?e.length+ +t:t}var A=/[^\uD801-\uDFFF]/,C=new Map;function E(e,t){var n,r,a;return void 0===e?e:e instanceof Map?e.get(t):"some"!==t&&"any"!==t&&"all"!==t&&"start"!==t&&"end"!==t||e.TwineScript_VariableStore?("string"==typeof e&&(C.has(e)?e=C.get(e):A.test(e)?(a=_toConsumableArray(e),C.set(e,a),e=a):C.set(e,e)),h(e)&&Number.isFinite(t)&&(t=O(e,t)),e.TwineScript_GetProperty?e.TwineScript_GetProperty(t):"function"!=typeof(a=e[t])?a:void 0):(n=e,r=t,a='"'.concat(r," value").concat("any"===r?"":"s",'" of '),{determiner:r,determined:n,array:_toConsumableArray(n),string:"string"==typeof n&&n,TwineScript_ObjectName:a+m(n),TwineScript_ToSource:function(){return"".concat(r," of ").concat(f(n))},TwineScript_TypeName:a+"a data structure",TwineScript_Unstorable:!0,TwineScript_Print:function(){return"`["+this.TwineScript_TypeName+"]`"}})}function N(e){var t;return e.computed?(t=e.value,"string"==typeof(t=c.isPrototypeOf(t)?t.get():t)?"('"+t+"')":"("+t+")"):"number"==typeof e?r(e):"'"+e+"'"}function j(t,e,n){if(t.TwineScript_VariableStore){if(t.TwineScript_TypeDefs&&e in t.TwineScript_TypeDefs){var r=t.TwineScript_TypeDefs[e];if("const"===r.name){if(void 0!==t[e])return p.create("operation","I can't alter ".concat(t===u.variables?"$":"_").concat(e," because it's been restricted to a constant value."),"This variable can't be changed for the rest of the story.")}else if(!a(r,n))return p.create("operation","I can't set ".concat(t===u.variables?"$":"_").concat(e," to ").concat(l(n)," because it's been restricted to ").concat(f(r),"-type data."),"You can restrict a variable or data name by giving a typed variable to (set:) or (put:).")}return!0}return k(e)?e.map(function(e){return j(t,e)}):t instanceof Map?"string"==typeof e||p.create("operation","".concat(m(t)," can only have string data names, not ").concat(m(e),".")):h(t)?["length","random","some","any","all","start","end"].includes(e)?p.create("operation","I can't forcibly alter the '"+e+"' of "+m(t)+".","start"===e||"end"===e?"Alter the values at actual positions, like 1st or 2ndlast, rather than just the '"+e+"'.":void 0):+e==(0|e)||p.create("property",m(t)+" can only have position keys ('3rd', '1st', (5), etc.), not "+N(e)+"."):t.TwineScript_Identifiers&&e in t?p.create("keyword","I can't alter the value of the '"+e+"' identifier.","You can only alter data in variables, not fixed identifiers."):p.create("operation","I can't modify "+m(t),t instanceof Set?"You should use an (array:) if you need to modify the data inside this dataset.":i.isPrototypeOf(t)?"You should alter hooks indirectly using macros like (replace:) or (enchant:).":void 0)}function P(t,e,n,r){var a=e;t instanceof Map?t.set(e,n):(h(t)&&(e=O(t,e)),t.TwineScript_Set?t.TwineScript_Set(e,n,r):t[e]=n),S.set.forEach(function(e){return e(t,a,n)})}function R(t,e){var n=e;h(t)&&(e=O(t,e)),k(t)&&/^(?:[1-9]\d*|0)$/.exec(e)?t.splice(e,1):t instanceof Map||t instanceof Set?t.delete(e):t.TwineScript_Delete?t.TwineScript_Delete(e):delete t[e],S.delete.forEach(function(e){return e(t,n)})}function I(t,e){var n,r,a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:e,o=3<arguments.length&&void 0!==arguments[3]&&arguments[3];return e&&"object"===_typeof(e)&&"last"in e&&"first"in e?i.isPrototypeOf(t)?t.TwineScript_GetProperty(e):(n=e.first,r=e.last,b(t,n+(0<=n),r+(0<=r))):k(e)?i.isPrototypeOf(t)?t.TwineScript_GetProperty(e):e.map(function(e){return I(t,e,e)})["string"==typeof t?"join":"valueOf"](""):void 0!==(n=E(t,e))||o?n:t===u.variables?0:"temp"===(null==(r=t.TwineScript_VariableStore)?void 0:r.type)?p.create("property","There isn't a temp variable named _".concat(a," in this place."),"Temp variables only exist inside the same passage, hook, or lambda in which they're created."):k(t)&&"number"==typeof e?p.create("property","This array of ".concat(t.length," elements doesn't have a ").concat(N(a+("number"==typeof a?1:""))," element."),t.length?"It contains: ".concat(s(t.map(m)),"."):"The array is empty."):(o=Array.from("function"==typeof t.keys&&t.keys()),p.create("property","I can't find a ".concat(N(a)," data name in ").concat(m(t)),t instanceof Map&&o.length?"Its names include: ".concat(s(o),"."):void 0))}function V(e,t){var r=this,e=this.compiledPropertyChain.reduce(function(e,t){var n=0===e.length?r.object:I.apply(void 0,_toConsumableArray(e[e.length-1]));return e.push([n,t])&&e},[]).reduceRight(e,t);return p.containsError(e)?e:void 0}return c=Object.freeze({get:function(){for(var e=this.object,t=0;t<this.compiledPropertyChain.length-1;t+=1)if(e=I(e,this.compiledPropertyChain[t]),p.containsError(e))return e;return I(e,this.compiledPropertyChain.slice(-1)[0],this.propertyChain.slice(-1)[0])},has:function(){for(var e=this.object,t=0;t<this.compiledPropertyChain.length-1;t+=1)if(void 0===(e=I(e,this.compiledPropertyChain[t],void 0,!0))||p.containsError(e))return!1;return void 0!==I(e,this.compiledPropertyChain.slice(-1)[0],void 0,!0)},set:function(e,c){var l=this;return!this.object||this.object.TwineScript_VariableStore||this.object.TwineScript_Identifiers?V.call(this,function(n,e,t){var e=_slicedToArray(e,2),r=e[0],a=e[1];if(e=p.containsError(n,r,a)||p.containsError(j(r,a,n)))return e;if(e=w(n))return p.create("operation","".concat(m(n)," can't be stored").concat(!n.TwineScript_Unstorable&&v(n)?" because it holds ".concat(m(e)):"","."));if(0<t)r=g(r);else if("temp"===(null==(e=r.TwineScript_VariableStore)?void 0:e.type)&&r!==u.variables){for(var o=r;"temp"===(null==(i=o.TwineScript_VariableStore)?void 0:i.type)&&!hasOwnProperty.call(o,a);)var i,o=Object.getPrototypeOf(o);"temp"===(null==(t=o.TwineScript_VariableStore)?void 0:t.type)&&(r=o)}if("string"==typeof r){if("string"!=typeof n)return p.create("datatype","I can't put this non-string value, ".concat(m(n),", in a string."));if(n.length!==(k(a)?a.length:1))return p.create("datatype","".concat(m(n),"is not the right length to fit into this string location."));var r=_toConsumableArray(r),s=_toConsumableArray(n);[].concat(a).forEach(function(e){0+e<0&&(e=r.length+(0+e)),r=[].concat(_toConsumableArray(r.slice(0,e)),[s.shift()],_toConsumableArray(r.slice(e+1)))}),r=r.join("")}else d(r)&&(void 0!==n.TwineScript_KnownName&&((n=""!==n.TwineScript_KnownName?g(n):n).TwineScript_KnownName=f(l)),k(a)&&h(n)?("string"==typeof n&&(n=_toConsumableArray(n)),a.map(function(e,t){return[e,n[t]]}).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return P(r,t,e,c)})):P(r,a,n,c));return r},e):p.create("macrocall","I can't (set:) ".concat(m(this),", if the ").concat((m(this.object).match(/ (.+$)/)||["","value"])[1]," isn't stored in a variable."),"Modifying data structures that aren't in variables won't change the game state at all.")},delete:function(){return V.call(this,function(e,t,n){var r,t=_slicedToArray(t,2),a=t[0],t=t[1];return(r=p.containsError(e,a,t)||p.containsError(j(a,t)))||(0<n&&(a=g(a)),null===e?((r="string"==typeof a)&&(a=_toConsumableArray(a)),k(t)?(h(a)&&(t=_toConsumableArray(new Set(t))).sort(function(e,t){return O(a,t)-O(a,e)}),t.forEach(function(e){return R(a,e)})):R(a,t),r&&(a=a.join(""))):P(a,t,e,!1),a)},null)},defineType:function(e){var t=this.object,n=this.compiledPropertyChain[0],r=(hasOwnProperty.call(t,"TwineScript_TypeDefs")||(t.TwineScript_TypeDefs=Object.create(t.TwineScript_TypeDefs||null)),t.TwineScript_TypeDefs),a=r[n];if(a&&!o(a,e))return p.create("operation","I can't redefine the type of "+m(this)+" to "+(e.TwineScript_ObjectName||l(e))+", as it is already "+(a.TwineScript_ObjectName||l(a))+".");t.TwineScript_DefineType?t.TwineScript_DefineType(n,e):r[n]=e,"const"===e.name&&(t[n]=void 0)},matches:function(e,t){return this.object===e&&this.compiledPropertyChain[0]===t},getName:function(){return this.compiledPropertyChain[0]},create:function(e,t){var n;if(n=p.containsError(e))return n;Array.isArray(t)||(t=[].concat(t)),c.isPrototypeOf(e)&&(t=e.propertyChain.concat(t),e=e.object);var r=function(e,t){for(var n,r=[],a=0;a<t.length;a+=1){var o=t[a];if(o.computed&&(o=o.value),c.isPrototypeOf(o)&&(o=o.get()),k(o)){for(var i=[],s=0;s<o.length;s+=1)i[s]=x(e,o[s]);o=i}else o=x(e,o);if(n=p.containsError(o))return n;a<t.length-1&&(e=I(e,o)),r.push(o)}return r}(e,t);return(n=p.containsError(r))||Object.assign(Object.create(c),{object:e,propertyChain:t,compiledPropertyChain:r})},TwineScript_ToSource:function(){function r(e,t){return!t&&n.object.TwineScript_VariableStore?e:N(e)}var e,n=this;return(this.object===u.variables?"$":"temp"===(null==(e=this.object.TwineScript_VariableStore)?void 0:e.type)?"_":f(this.object)+"'s ")+(1===this.propertyChain.length?r(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,n){return e+"'s "+r(t,n)}))},get TwineScript_ObjectName(){var e;return this.object.TwineScript_VariableStore?"the ".concat("temp"===(null==(e=this.object.TwineScript_VariableStore)?void 0:e.type)?"temp ":"","variable ").concat(this.TwineScript_ToSource()):m(this.object)+"'s "+(1===this.propertyChain.length?N(this.propertyChain[0]):this.propertyChain.reduce(function(e,t,n){return e+"'s "+N(t)}))},on:function(e,t){if(e in S)return"function"!=typeof t||S[e].includes(t)||S[e].push(t),c;n("VarRef.on","invalid event name")}})}),define("internaltypes/varscope",[],function(){return Object.seal({TwineScript_ObjectName:"the temporary variables",TwineScript_VariableStore:{type:"temp",name:"an unknown scope"},TwineScript_TypeDefs:Object.create(null)})}),define("macrolib/commands",["jquery","macros","utils","state","passages","engine","internaltypes/twineerror","internaltypes/twinenotifier","datatypes/assignmentrequest","datatypes/hookset","datatypes/codehook","datatypes/colour","datatypes/gradient","internaltypes/varref","datatypes/typedvar","datatypes/varbind","utils/operationutils","utils/renderutils"],function(u,n,b,c,l,a,y,M,e,o,t,p,d,i,s,v,r,f){var h=r.printBuiltinValue,m=r.objectName,g=r.clone,w=r.toSource,k=f.dialog,S=f.geomParse,D=f.geomStringRegExp,r=n.TypeSignature,f=r.Any,F=r.Everything,T=r.rest,_=r.either,x=r.optional,O=r.zeroOrMore,L=r.percent,H=r.nonNegativeInteger,A=r.positiveInteger,r=r.positiveNumber,C=Object.assign,E=Math.floor,N=Math.ceil,j=Math.abs,z=Math.max,q=Math.min,P=u.noop;function R(e){return"(".concat(e," ").concat(b.options.ifid,") ")}["set","put","unpack"].forEach(function(r){return n.add(r,"Instant",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=1){var n=t+1<1||arguments.length<=t+1?void 0:arguments[t+1];if("into"===n.operator&&"set"===r)return y.create("macrocall","Please say 'to' when using the (set:) macro.");if("to"===n.operator&&"set"!==r)return y.create("macrocall","Please say 'into' when using the (put:) or (unpack:) macro.");if((i.isPrototypeOf(n.dest)||s.isPrototypeOf(n.dest))===("unpack"===r))return y.create("macrocall","unpack"===r?"Please use the (unpack:) macro with arrays, datamaps or (p:) patterns containing variables to the right of 'into'.":"Please use the (".concat(r,":) macro with just single variables and typed variables to the ").concat("set"===r?"left of 'to'.":"right of 'into'."),"You may wish to change this to the (".concat("unpack"!==r?"unpack":"to"===n.operator?"set":"put",":) macro."));n=n.set();if(y.containsError(n))return n}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a (".concat(r,":) operation"),TwineScript_ObjectName:"a (".concat(r,":) operation"),TwineScript_Unstorable:!0,TwineScript_Print:function(){return b.options.debug,""}}},[T(e)])}),n.add("move","Instant",function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=1){var n=t+1<1||arguments.length<=t+1?void 0:arguments[t+1];if("into"!==n.operator)return y.create("macrocall","Please say 'into' when using the (move:) macro.");n=n.set(!0);if(y.containsError(n))return n}return{TwineScript_TypeID:"instant",TwineScript_TypeName:"a (move:) operation",TwineScript_ObjectName:"a (move:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return b.options.debug,""}}},[T(e)]),n.addCommand("display",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (display:) the passage '".concat(e,"' because it doesn't exist."))},function(e,t,n){return e.source=l.getTree(n),e},[String])("print",P,function(e,t,n){return C(e,{source:h(n)})},[f])(["verbatim-print","v6m-print"],P,function(e,t,n){return C(e,{verbatim:!0,source:h(n)})},[f])(["verbatim-source","v6m-source"],function(e){if("command"===(null==e?void 0:e.TwineScript_TypeID)&&!e.TwineScript_ToSource)return y.create("datatype","I can't construct the source code of a command created by a custom macro.")},function(e,t,n){return C(e,{verbatim:!0,source:h(w(n))})},[f])("go-to",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (go-to:) to the passage '".concat(e,"' because it doesn't exist."),"Check that you didn't mistype the passage name, or rename the passage to something else.")},function(e,t,n){if(!b.options.ignoreGotos)return requestAnimationFrame(function(){return a.goToPassage(n,{transition:e.data.passageT8n})}),{blocked:!0}},[String])("redirect",function(e){if(!l.hasValid(e))return y.create("macrocall","I can't (redirect:) to the passage '".concat(e,"' because it doesn't exist."),"Check that you didn't mistype the passage name, or rename the passage to something else.")},function(e,t,n){if(!b.options.ignoreGotos)return requestAnimationFrame(function(){return a.redirect(n,{transition:e.data.passageT8n})}),{blocked:!0}},[String])("undo",P,function(e,t,n){return c.pastLength<1?C(e,{source:n}):b.options.ignoreGotos?void 0:(requestAnimationFrame(function(){return a.goBack({transition:e.data.passageT8n})}),{blocked:!0})},[x(String)])("debug",P,a.enableDebugMode,[],!1),b.onStartup(function(){return b.storyElement.on("click.icon","tw-icon",function(e){var t=u(this),n=t.data("clickEvent"),r=t.attr("alt");n&&n(t),"Undo"===r&&(e.stopPropagation(),a.goBack()),"Redo"===r&&(e.stopPropagation(),a.goForward()),"Fullscreen"===r&&(e.stopPropagation(),a.toggleFullscreen()),"Restart"===r&&(c.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload())})}),[["Undo","&#8630;",function(){return 0<c.pastLength}],["Redo","&#8631;",function(){return 0<c.futureLength}],["Fullscreen","&#9974;",function(){return document.fullscreenEnabled||document.msFullscreenEnabled}],["Restart","&#10226;",Object]].forEach(function(e){var e=_slicedToArray(e,3),o=e[0],i=e[1],s=e[2];n.addCommand("icon-".concat(o.toLowerCase()),function(e,t){if("string"==typeof e&&"string"==typeof t)return e=_toConsumableArray(e).length,t=_toConsumableArray(t).length,1<e&&1<t?y.create("datatype","One of the two strings given to (icon-".concat(o.toLowerCase(),":) should be 1 character long, for its icon.")):1===e&&1===t?y.create("datatype","One of the two strings given to (icon-".concat(o.toLowerCase(),":) should be 2 or more characters long, for its label.")):void 0},function(t,e,n,r){var a;return("string"==typeof r&&1===_toConsumableArray(r).length||"string"==typeof n&&1<_toConsumableArray(n).length)&&(n=(a=[r,n])[0],r=a[1]),"Undo"===o&&(t.data.forgetUndosEvent=function(e){t.section.whenUnblocked(function(){return u(e).css("visibility","hidden")})}),C(t,{source:'<tw-icon tabindex=0 alt="'.concat(o,'" ').concat(r?'data-label="'.concat(r.replace('"',"&quot;"),'"'):"",' title="').concat(o,'" ').concat(s()?"":'style="visibility:hidden"',">").concat(n||i,"</tw-icon>")})},[x(String),x(String)])}),n.addCommand("icon-counter",function(e,t,n){var r=" label string given to (icon-counter:) can't be empty or only whitespace.";return t&&t.trim()?"string"!=typeof n||n.trim()?void 0:y.create("datatype","The 2nd "+r):y.create("datatype","The 1st "+r)},function(r,e,a,o,i){r.attr.push({"data-2bind":!0}),r.data.twoWayBindEvent=function(e,t,n){a.varRef.matches(t,n)&&"number"==typeof(t=a.varRef.get())&&r.target.children("tw-icon").text((0<t?E:N)(t)).attr("data-label",1!==j(t)&&void 0!==i?i:o)};var t=a.varRef.get();return"number"!=typeof t?y.create("datatype","(icon-counter:) can only be bound to a variable holding a number, not ".concat(m(t),".")):C(r,{source:'<tw-icon data-label="'.concat(b.escape(1!==j(t)&&void 0!==i?i:o),'">').concat((0<t?E:N)(t),"</tw-icon>")})},[v,String,x(String)]),n.addCommand("meter",function(e,t,n,r){return"two way"===e.bind?y.create("datatype","(meter:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".'):"string"!=typeof r||r.trim()?-1===n.search(D)||!n.includes("=")&&1<n.length?y.create("datatype",'The (meter:) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not '+JSON.stringify(n)+"."):void 0:y.create("datatype","The label string given to (meter:) can't be empty or only whitespace.")},function(r,e,a,n,t,o,i){o&&"string"!=typeof o&&(i=o,o=void 0),i=i||p.create({h:0,s:0,l:.5,a:.5}),p.isPrototypeOf(i)&&(i=d.create(90,[{colour:i,stop:0},{colour:i,stop:1}]));function s(e){var t=z(0,q(1,e/n)),e=i.repeating?i:i.multiply(n/e);return"height:100%;background-repeat:no-repeat;background-image:".concat((l?C(e,e.repeating?{}:{angle:270}).toLinearGradientString()+", ":"")+C(e,e.repeating?{}:{angle:l||0===c?90:270}).toLinearGradientString(),";background-size:").concat(l?Array(2).fill(50*t+"%"):100*t+"%",";background-position-x:").concat(l?-100/(2-t)+100+"%,"+100/(2-t)+"%":0===c?"left":"right",";text-align:").concat(l?"center":0===c?"left":"right")}var t=S(t),c=t.marginLeft,t=t.size,l=0<c&&Math.ceil(c+t)<100,u=(r.styles.push({"margin-left":c+"%",width:t+"%",height:"1.5em",display:"block"}),r.attr.push({"data-2bind":!0}),o&&e.stackTop.tempVariables),t=(r.data.twoWayBindEvent=function(e,t,n){a.varRef.matches(t,n)&&"number"==typeof(t=a.varRef.get())&&((n=r.target.children("tw-meter")).attr("style",s(t)),o)&&r.section.renderInto("",null,{source:o,target:n,append:"replace",transitionDeferred:!1},u)},a.varRef.get());return"number"!=typeof t?y.create("datatype","(meter:) can only be bound to a variable holding a number, not ".concat(m(t),".")):C(r,{source:'<tw-meter style="'.concat(s(t),'">').concat(o||"","</tw-meter>")})},[v,r,String,x(_(String,p,d)),x(_(p,d))]),[["cycling-link"],["seq-link","sequence-link"]].forEach(function(t,u){return n.addCommand(t,function(){var e;return""===(arguments.length<=0?void 0:arguments[0])?y.create("datatype","The first string in a ("+t[0]+":) can't be empty."):arguments.length<=(v.isPrototypeOf(arguments.length<=0?void 0:arguments[0])?2:1)?y.create("datatype","I need two or more strings to "+(u?"sequence":"cycle")+" through, not just '"+((e=arguments.length-1)<0||arguments.length<=e?void 0:arguments[e])+"'."):void 0},function(a,e){for(var o,t=arguments.length,i=new Array(2<t?t-2:0),n=2;n<t;n++)i[n-2]=arguments[n];v.isPrototypeOf(i[0])&&(o=i.shift());var s=0,c=("two way"===(null==(l=o)?void 0:l.bind)&&(a.attr.push({"data-2bind":!0}),-1<(l=i.indexOf(o.varRef.get())))&&(s=l),e.stackTop.tempVariables);function r(e,t){var n=s>=i.length-1&&u,r=""===i[s]?"":n?i[s]:"<tw-link>".concat(i[s],"</tw-link>");if(n&&(a.data.clickEvent=void 0),o&&!t){n=o.set(i[s]);if(y.containsError(n))return void e.replaceWith(n.render(i[s]))}t=_objectSpread(_objectSpread({},a),{},{source:r,transitionDeferred:!1});a.section.renderInto("",null,t,c)}i[s]&&(a.data.clickEvent=function(e){s=(s+1)%i.length,r(e,!1)},a.data.twoWayBindEvent=function(e,t,n){o.varRef.matches(t,n)&&(t=o.varRef.get(),-1<(n=i.indexOf(t)))&&n!==s&&(s=n,r(e,!0))});var l="<tw-link>".concat(i[s],"</tw-link>");if(o){e=o.set(i[s]);if(y.containsError(e))return e}return C(a,{source:l,append:"replace",transitionDeferred:!0})},[_(v,String),T(String)])}),b.onStartup(function(){return b.storyElement.on("change.dropdown-macro","select",function(){var e=u(this),t=e.closest("tw-expression, tw-hook").data("dropdownEvent");t&&t(e)})}),n.addCommand("dropdown",function(e){var t;return""===(arguments.length<=1?void 0:arguments[1])||""===((t=(arguments.length<=1?0:arguments.length-1)-1+1)<1||arguments.length<=t?void 0:arguments[t])?y.create("datatype","The first or last strings in a (dropdown:) can't be empty.","Because empty strings create separators within (dropdown:)s, having them at the start or end doesn't make sense."):(arguments.length<=1?0:arguments.length-1)<=1?y.create("datatype","I need two or more strings to create a (dropdown:) menu, not just "+(arguments.length<=1?0:arguments.length-1)+"."):void 0},function(e,t,r){for(var n=arguments.length,a=new Array(3<n?n-3:0),o=3;o<n;o++)a[o-3]=arguments[o];var i=0,s=("two way"===r.bind&&(e.attr.push({"data-2bind":!0}),-1<(c=a.indexOf(r.varRef.get())))&&(i=c),Math.max.apply(Math,_toConsumableArray(a.map(function(e){return _toConsumableArray(e).length})))),c="<select>"+a.map(function(e,t){return"<option".concat(t===i?" selected":"").concat(""===e?" disabled":"",">").concat(b.escape(e||"\u2500".repeat(s)),"</option>")}).join("\n")+"</select>",l=(e.data.dropdownEvent=function(e){var t=e.val(),n=r.set(t);y.containsError(n)&&e.replaceWith(n.render(t))},e.data.twoWayBindEvent=function(e,t,n){r.varRef.matches(t,n)&&(t=r.varRef.get(),-1<(n=a.indexOf(t)))&&n!==i&&(e.find("select").val(t),i=n)},e.styles.push({"background-color":function(){return b.parentColours(u(this)).backgroundColour}}),r.set(a[i]));return y.containsError(l)?l:C(e,{source:c,append:"replace"})},[v,String,T(String)]),b.onStartup(function(){return b.storyElement.on("input.checkbox-macro","input[type=checkbox]",function(){var e=u(this),t=e.closest("tw-expression").data("checkboxEvent");t&&t(e)})});function I(e){return["I can't use a dialog macro in "+e+".","Please rewrite this without putting such macros here."]}var V=1;n.addCommand("checkbox",function(){},function(e,t,r,n){var a=!1,o="checkbox-"+ ++V,i=("two way"===r.bind&&(e.attr.push({"data-2bind":!0}),"boolean"==typeof(i=r.varRef.get())&&(a=i),e.data.twoWayBindEvent=function(e,t,n){r.varRef.matches(t,n)&&"boolean"==typeof(t=r.varRef.get())&&e.children("input[type=checkbox]").prop("checked",t)}),e.data.checkboxEvent=function(e){var t=e.is(":checked"),t=r.set(t);y.containsError(t)&&e.replaceWith(t.render(""))},r.set(a));return y.containsError(i)?i:C(e,{source:'<input id="'.concat(o,'" type="checkbox" ').concat(a?"checked":"",'><label for="').concat(o,'">').concat(n,"</label>"),append:"replace"})},[v,String]),b.onStartup(function(){return u(document).on("fullscreenchange",function(){u("input[type=checkbox][id^=fullscreen]",b.storyElement).each(function(e,t){(u(t).closest("tw-expression").data("fullscreenEvent")||Object)(t)})})}),n.addCommand("checkbox-fullscreen",function(){},function(e,t,n){var r="fullscreenCheckbox-"+ ++V;return e.data.fullscreenEvent=function(e){return u(e).prop("checked",!(!document.fullscreenElement&&!document.msFullscreenElement))},e.data.checkboxEvent=function(){return a.toggleFullscreen()},C(e,{source:'<input id="'.concat(r,'" type="checkbox" ').concat(document.fullscreenEnabled||document.msFullscreenEnabled?" ":"disabled ").concat(document.fullscreenElement||document.msFullscreenElement?"checked":"",'><label for="').concat(r,'">').concat(n,"</label>"),append:"replace"})},[String]),b.onStartup(function(){return b.storyElement.on("input.input-box-macro","textarea, input[type=text]",function(){var e=u(this),t=e.closest("tw-expression").data("inputBoxEvent");t&&t(e)})}),["input","force-input","input-box","force-input-box"].forEach(function(g){return n.addCommand(g,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=g.endsWith("box"),a=v.isPrototypeOf(t[0]),o="string"==typeof t[+a],r=r&&"number"==typeof t[o+a],i=o?t[+a]:t[a+r],s=0<S(i).size,o=s?t[a+r+o]:i;return g.startsWith("force")&&"string"!=typeof o?y.create("datatype","The (".concat(g,":) macro requires a string of text to forcibly input.")):t.length>a+r+s+("string"==typeof o)?y.create("datatype","An incorrect combination of values was given to this (".concat(g,":) macro.")):void 0},function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o=g.startsWith("force"),i=g.endsWith("box"),s=v.isPrototypeOf(r[0]),c="string"==typeof r[+s],l=i&&"number"==typeof r[c+s],u=s&&r[0],p=l?r[1+s]:3,d=c?S(r[+s]):{},f=d.marginLeft,d=d.size,h=(d?r[s+l+c]:c&&r[+s])||"",l=o?"":h,c=!1;if("two way"===u.bind){e.attr.push({"data-2bind":!0});s=u.varRef.get();if("string"==typeof s){l=o?h.slice(0,s.length):s,s=u.set(l),c=!0;if(y.containsError(s))return s}e.data.twoWayBindEvent=function(e,t,n){u.varRef.matches(t,n)&&"string"==typeof(t=u.varRef.get())&&e.find(i?"textarea":"input").val(o?h.slice(0,t.length):t)}}if(u&&!c){s=u.set(o?"":h);if(y.containsError(s))return s}!o&&u&&(e.data.inputBoxEvent=function(e){var t=e.val(),t=u.set(t);y.containsError(t)&&e.replaceWith(t.render(""))});var m,c="<".concat(i?"textarea":"input type=text",' style="width:100%" ').concat(i?"rows=".concat(p,">"):'value="').concat(b.escape(l)).concat(i?"</textarea>":'">');return o&&(m=Array.from(h),e.data.inputBoxEvent=function(e){var t=e.val().length,t=m.slice(0,t).join("");return e.val(t),u&&(t=u.set(t),y.containsError(t))&&e.replaceWith(t.render("")),!0}),e.styles.push({display:"block","margin-left":d?f+"%":void 0,width:d?d+"%":"100%","border-style":function(){return this.style.borderStyle||"solid"}}),C(e,{source:c,append:"replace"})},g.endsWith("box")?[_(v,String),x(_(A,String)),x(_(A,String)),x(String)]:[x(_(v,String)),x(String),x(String)])}),["show","rerun"].forEach(function(s){return n.addCommand(s,function(){for(var r,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function e(t){var n=t.selector,t=t.next;return"name"===n.type&&"page"===n.data?(r=y.create("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||t&&e(t))||void 0}),r},function(o,i){for(var e=arguments.length,t=new Array(2<e?e-2:0),n=2;n<e;n++)t[n-2]=arguments[n];return t.forEach(function(e){return e.forEach(i,function(e){var t,n,r,a=e.data("hidden");void 0!==a!=("rerun"===s)&&(e.removeData("hidden"),a instanceof u?e.empty().append(a):(a=e.data("tempVariables"),n=(t="tw-passage"===e.tag())?l.getTree(c.passage):e.data("originalSource")||"",t&&(r=e.find("tw-sidebar").detach()),i.renderInto("",null,_objectSpread(_objectSpread({},o),{},{append:"replace",source:n,target:e}),a&&Object.create(a)),r&&e.prepend(r)))})}),o},[T(o)])});n.addCommand("hide",function(){for(var r,e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.some(function e(t){var n=t.selector,t=t.next;return"name"===n.type&&"page"===n.data?(r=y.create("macrocall","You can't (hide:) the ?page. Sorry."),!0):!!("base"===n.type&&e(n.data)||t&&e(t))||void 0}),r},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0,o=n;a<o.length;a++)o[a].forEach(e,function(e){e.data("hidden")||e.data("hidden",e.contents().detach())})},[T(o)],!1)("scroll",P,function(m,e,g){var y="number"==typeof g&&g;requestAnimationFrame(function(){e.forEach(m,function(e){if(!1!==y){var t,n,r=e[0];null!=(t=(n=r=r===b.storyElement[0]&&r.scrollHeight===r.clientHeight?getComputedStyle(document.body).overflow.includes(" scroll")?document.body:document.documentElement:r).scrollTo)&&t.call(n,0,(r.scrollHeight-r.clientHeight)*y)}else{var a,o=_createForOfIteratorHelper(g.hooks(m).get());try{for(o.s();!(a=o.n()).done;){var i=a.value;if(e.find(i)){for(var s=[],c=e[0];(c=c.parentNode)&&c!==document.body;)s.push([c,c.scrollLeft,c.scrollTop]);i.scrollIntoView();for(var l=0,u=s;l<u.length;l++){var p=_slicedToArray(u[l],3),d=p[0],f=p[1],h=p[2];d.scrollLeft=f,d.scrollTop=h}break}}}catch(e){o.e(e)}finally{o.f()}}})})},[o,_(L,o)],!1)("stop",P,P,[],!1)("load-game",P,function(e,t){var n,r;return e.loadedGame?y.create("infinite","I can't use (load-game:) immediately after loading a game."):(n=localStorage.getItem(R("Saved Game")+t))?(n=c.deserialise(e,n))instanceof Error?{blocked:r=k({message:"Sorry to interrupt... The story tried to load saved data, but there was a problem.\n"+n.message+"\n\nThat data might have been saved from a different version of this story. Should I delete it?\n(Type 'delete' and choose Yes to delete it.)\n\nEither way, the story will now continue without loading the data.",defaultValue:"",buttons:[{name:"Yes",confirm:!0,callback:function(){"delete"===r.find("input").last().val()&&localStorage.removeItem(R("Saved Game")+t),e.unblock("")}},{name:"No",cancel:!0,callback:function(){return e.unblock()}}]})}:void requestAnimationFrame(a.showPassage.bind(a,c.passage,{loadedGame:!0})):y.create("saving","I can't find a save slot named '"+t+"'!")},[String],!1)("forget-undos",P,function(e,t){c.futureLength||c.forgetUndos(t)},[parseInt],!1)("forget-visits",P,function(e,t){c.forgetVisits(t)},[parseInt],!1)("mock-visits",function(){if(!b.options.debug)return y.create("debugonly","(mock-visits:) cannot be used outside of debug mode.");for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t.find(function(e){return!l.hasValid(e)});return r?y.create("datatype","I can't mock-visit '"+r+"' because no passage with that name exists."):void 0},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];c.mockVisits=g(n)},[T(String)],!1)("mock-turns",function(){if(!b.options.debug)return y.create("debugonly","(mock-turns:) cannot be used outside of debug mode.")},function(e,t){c.mockTurns=t},[H],!1)("seed",P,function(e,t){c.setSeed(t)},[String],!1)(["dialog","alert"],function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];if(v.isPrototypeOf(e)){if("two way"===e.bind)return y.create("datatype","(dialog:) shouldn't be given two-way bound variables.",'Change the "2bind" keyword to just "bind".');if(void 0===t)return y.create("datatype","(dialog:) needs a message string or codehook to display.")}else void 0!==t&&r.unshift(t);e=r.findIndex(function(e){return""===e});if(-1<e)return y.create("datatype","(dialog:)'s ".concat(b.nth(e+1)," link text shouldn't be an empty string."))},function(e,n,r,t){for(var a=arguments.length,o=new Array(4<a?a-4:0),i=4;i<a;i++)o[i-4]=arguments[i];return v.isPrototypeOf(r)||(void 0!==t&&o.unshift(t),t=r,r=void 0),o.length||(o=["OK"]),{blocked:k({section:n,message:t,cd:e,buttons:o.map(function(t){return{name:t,callback:function(){var e;n.unblock((null==(e=r)?void 0:e.set(t))||"")}}})})}},[_(v,String,t),x(_(t,String)),O(String)])("open-url",P,function(e,t){window.open(t,"")},[String],!1)(["restart","reload"],P,function(){if(!b.options.ignoreGotos){if(c.turns<=1)return y.create("infinite","I mustn't (restart:) the story in the starting passage.");c.hasSessionStorage&&sessionStorage.removeItem("Saved Session"),window.location.reload()}},[],!1)("goto-url",P,function(e,t){window.location.assign(t)},[String],!1)("ignore",P,P,[O(F)])("assert-exists",function(e){if(""===e)return y.create("datatype","(assert-exists:) mustn't be given an empty string.")},function(e,t,n){var r=0;return("string"==typeof n?o.create({type:"string",data:n}):n).forEach(t,function(){++r}),r?e:y.create("assertion","I didn't see any ".concat("string"==typeof n?"text occurrences of":"hooks matching"," ").concat(w(n)," in this passage."))},[_(o,String)]),n.add("assert","Instant",function(e,t){return t?{TwineScript_TypeID:"instant",TwineScript_TypeName:"an (assert:) operation",TwineScript_ObjectName:"an (assert:) operation",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}:C(y.create("assertion","An assertion failed: "),{appendTitleText:!0})},[Boolean])("save-game","Boolean",function(e,t,n){if(n=n||"",!c.hasStorage)return!1;var r=c.serialise(!1).pastAndPresent;if(y.containsError(r))return r;if(!1===r)return!1;try{return localStorage.setItem(R("Saved Game")+t,r),localStorage.setItem(R("Saved Game Filename")+t,n),!0}catch(e){return!1}},[String,x(String)])("prompt","String",function(e,t,n,r,a){var o,i;return null!=(o=e.stackTop)&&o.evaluateOnly?y.create.apply(y,["macrocall"].concat(_toConsumableArray(I(e.stackTop.evaluateOnly)))):""===a?y.create("datatype","The text for (prompt:)'s confirm link can't be blank."):(i=k({section:e,message:t,defaultValue:n,buttons:[{name:a||"OK",confirm:!0,callback:function(){return e.unblock(i.find("input").last().val())}}].concat(""===r?[]:{name:r||"Cancel",cancel:!0,callback:function(){return e.unblock(n)}})}),e.stackTop.blocked=i,0)},[_(String,t),String,x(String),x(String)])("confirm","Boolean",function(e,t,n,r){var a;return null!=(a=e.stackTop)&&a.evaluateOnly?y.create.apply(y,["macrocall"].concat(_toConsumableArray(I(e.stackTop.evaluateOnly)))):""===r?y.create("datatype","The text for (confirm:)'s confirm link can't be blank."):(a=k({section:e,message:t,defaultValue:!1,buttons:[{name:r||"OK",confirm:!0,callback:function(){return e.unblock(!0)}}].concat(""===n?[]:{name:n||"Cancel",cancel:!0,callback:function(){return e.unblock(!1)}})}),e.stackTop.blocked=a,0)},[_(String,t),x(String),x(String)])("page-url","String",function(){return window.location.href},[])}),define("macrolib/custommacros",["utils","macros","state","utils/operationutils","datatypes/changercommand","datatypes/custommacro","datatypes/codehook","datatypes/typedvar","internaltypes/twineerror"],function(c,l,u,e,t,p,n,d,f){function s(e,t,n){if(!t.some(function(e){if("function"==typeof e.output)return e.output(n),!0}))return f.create("macrocall","("+e+":) should only be used inside a code hook passed to (macro:).")}var h=e.objectName,m=e.toSource,e=l.add,r=l.addChanger,a=l.addCommand,o=l.TypeSignature,i=o.rest,g=o.either,y=o.Any,b=o.Everything,o=o.zeroOrMore;e("macro","CustomMacro",function(e){for(var t,n=[],r=arguments.length,a=new Array(1<r?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(t=0;t<a.length;t+=1){var i=t===a.length-1;if(d.isPrototypeOf(a[t])===i)return f.create("datatype","The "+(i?"":c.nth(a.length-t+1)+"-")+"last value given to (macro:) should be a "+(i?"code hook":"datatyped variable")+", not "+h(a[t]));if(!i){i="A custom macro";if(a[t].varRef.object===u.variables)return f.create("datatype",i+"'s typed variables must be temp variables (with a '_'), not global variables (with a '$').","Write them with a _ symbol at the start instead of a $ symbol.");if(1<a[t].varRef.propertyChain.length)return f.create("datatype",i+"'s typed variables can't be properties inside a data structure.");if(a[t].datatype.rest&&t!==a.length-2)return f.create("datatype",i+" can only have one spread variable, and it must be its last variable.");var s=a[t].varRef.propertyChain[0];if(n.includes(s))return f.create("datatype",i+"'s typed variables can't both be named '"+s+"'.");n.push(s)}}return p.create(a.slice(0,-1),a[a.length-1])},[i(g(d,n))]);a(["output-data","out-data"],function(){},function(e,t){e=e.stack;return s("output-data",e,t)||{blocked:!0}},[y],!1),r(["output","out"],function(){return Object.assign(t.create("output",[]))},function(e,t){if(e.section){var n,r=e.section,a=r.stack,o=r.stackTop,i={};for(n in o.tempVariables)n.startsWith("TwineScript_")||(i[n]=o.tempVariables[n]);s("output",a,{changer:t,variables:i,hook:Array.isArray(e.source)?"["+e.source.map(function(e){return e.text}).join("")+"]":e.source}),e.output=!0,o.blocked=!0}},[]),a("error",function(e){if(!e)return f.create("datatype","This (error:) macro was given an empty string.")},function(e,t){e=e.stack;return s("error",e,f.create("user",t))||{blocked:!0}},[String],!1),e("partial","CustomMacro",function(e,a){for(var t=arguments.length,o=new Array(2<t?t-2:0),n=2;n<t;n++)o[n-2]=arguments[n];var r="string"!=typeof a&&a,i=!r&&a;if(!r){if(!l.has(i))return f.create("macrocall",'The macro name given to (partial:), "'.concat(a,"\", isn't the name of a built-in macro."));if("Metadata"===l.get(i).returnType)return f.create("macrocall","(partial:) can't be used with metadata macros such as (".concat(a,":)"))}var s="(partial:".concat(m(a),",").concat(o.map(function(e){return m(e)}),")"),c=p.createFromFn(function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];e=l["string"==typeof a?"run":"runCustom"](a,e,o.concat(n));return f.containsError(e)&&(e.message="An error occurred while running the (partial:)-created macro, ".concat(c.TwineScript_ObjectName,":\n")+e.message),e},"a (partial:) custom macro of ".concat(i||r.TwineScript_KnownName?"(".concat(i||r.TwineScript_KnownName,":").concat(o.map(function(e){return m(e)}),")"):"another unnamed custom macro"),function(){return s},(i?l.get(i):r).typeSignature.filter(function(e,t){return t>=o.length||"rest"===e.pattern||"zero or more"===e.pattern}));return c},[g(String,p),o(b)])}),define("macrolib/datastructures",["utils","utils/naturalsort","macros","utils/operationutils","state","engine","passages","datatypes/lambda","datatypes/typedvar","internaltypes/twineerror"],function(e,i,t,n,s,r,a,c,o,l){var u=e.permutations,p=e.options,d=n.objectName,f=n.subset,h=n.collectionType,m=n.isValidDatamapName,g=n.is,y=n.unique,b=n.clone,v=n.range,e=t.TypeSignature,n=e.optional,w=e.rest,k=e.either,S=e.zeroOrMore,T=e.Any,e=e.nonNegativeInteger,_=i("en");t.add(["a","array"],"Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n},S(k(o,T)))("range","Array",function(e,t,n){return v(t,n)},[parseInt,parseInt])("subarray","Array",function(e,t,n,r){return f(t,n,r)},[Array,parseInt,parseInt])("reversed","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reverse().map(b)},S(T))("shuffled","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return s.shuffled.apply(s,n).map(b)},[S(T)])("sorted","Array",function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];if(!c.isPrototypeOf(r[0]))return(t=r.filter(function(e){return"string"!=typeof e&&"number"!=typeof e}))&&t.length?1===t.length&&Array.isArray(t[0])?l.create("macrocall","Please give multiple numbers or strings to (sorted:), not a single array.","You can use the spread ... syntax to spread out the array's values into (sorted:)."):l.create("datatype","If (sorted:) isn't given a 'via' lambda, it must be given only numbers and strings, not ".concat(d(t[0]),".")):r.sort(_);var o=r.shift();if("making"in o||"where"in o||"when"in o||!("via"in o))return l.create("datatype","The optional lambda given to (sorted:) must be a 'via' lambda, not ".concat(d(o),"."));for(var i=0;i<r.length;i+=1){var s=o.apply(e,{loop:r[i],pos:i+1});if(l.containsError(s))return s;if("string"!=typeof s&&"number"!=typeof s)return l.create("datatype",'The "via" lambda given to (sorted:) couldn\'t convert '.concat(d(r[i])," into a string or number."));r[i]=[r[i],s]}return r.sort(function(e,t){return _(e[1],t[1])}).map(function(e){return e[0]})},[S(T)])("rotated","Array",function(e,t){if(0===t)return l.create("macrocall","I can't rotate these values by 0 positions.");for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=-1*(t=Math.abs(t)%r.length*Math.sign(t));return r.slice(t).concat(r.slice(0,t)).map(b)},[parseInt,S(T)])("rotated-to","Array",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)?t:t.length?(e=r.indexOf(t[0]),r.slice(e).concat(r.slice(0,e)).map(b)):l.create("macrocall","None of these "+r.length+" values matched the lambda, so I can't rotate them.")},[c.TypeSignature("where"),w(T)])("repeated","Array",function(e,t){for(var n=[],r=arguments.length,a=new Array(2<r?r-2:0),o=2;o<r;o++)a[o-2]=arguments[o];if(!a.length)return n;for(;0<t--;)n.push.apply(n,a);return n.map(b)},[e,w(T)])("interlaced","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=Math.min.apply(Math,_toConsumableArray(n.map(function(e){return e.length}))),o=[],i=0;i<a;i+=1)for(var s=0;s<n.length;s+=1)o.push(b(n[s][i]));return o},[Array,w(Array)])("permutations","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.length?u.apply(void 0,n):[]},[S(T)])("unique","Array",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.filter(y)},[S(T)])("altered","Array",function(n,r){for(var e=arguments.length,t=new Array(2<e?e-2:0),a=2;a<e;a++)t[a-2]=arguments[a];return t.map(function(e,t){t=r.apply(n,{loop:e,pos:t+1});return null===t?e:t})},[k(c.TypeSignature("via"),c.TypeSignature("where","via")),S(T)])("find","Array",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return t.filter(e,r)},[c.TypeSignature("where"),S(T)])(["all-pass","pass"],"Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||t.length===r.length},[c.TypeSignature("where"),S(T)])("some-pass","Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||0<t.length},[c.TypeSignature("where"),S(T)])("none-pass","Boolean",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t=t.filter(e,r);return l.containsError(t)||0===t.length},[c.TypeSignature("where"),S(T)])("folded","Any",function(r,a){for(var e=arguments.length,t=new Array(2<e?e-2:0),n=2;n<e;n++)t[n-2]=arguments[n];return"where"in a&&(t=[t[0]].concat(_toConsumableArray(a.filter(r,t.slice(1))))),l.containsError(t)||t.reduce(function(e,t,n){return a.apply(r,{making:e,loop:t,pos:n+1})})},[k(c.TypeSignature("where","via","making"),c.TypeSignature("via","making")),w(T)])(["dm-names","datamap-names","datanames"],"Array",function(e,t){return Array.from(t.keys()).sort(i("en"))},[Map])(["dm-values","datamap-values","datavalues"],"Array",function(e,t){return Array.from(t.entries()).sort(i("en",function(e){return String(e[0])})).map(function(e){return b(e[1])})},[Map])(["dm-entries","datamap-entries","dataentries"],"Array",function(e,t){return Array.from(t.entries()).sort(function(e,t){return[e[0],t[0]].sort(i("en"))[0]===e[0]?-1:1}).map(function(e){return new Map([["name",e[0]],["value",b(e[1])]])})},[Map])(["dm-altered","datamap-altered"],"Datamap",function(a,o,e){return Array.from(e.entries()).sort(function(e,t){return[e[0],t[0]].sort(i("en"))[0]===e[0]?-1:1}).reduce(function(e,t,n){if(!l.containsError(e)){var r=new Map([["name",t[0]],["value",b(t[1])]]),r=o.apply(a,{loop:r,pos:n+1});if(l.containsError(r))return r;e.set(t[0],null===r?t[1]:r)}return e},new Map)},[k(c.TypeSignature("via"),c.TypeSignature("where","via")),Map])("history","Array",function(e,t){var n=s.history();return t?(t=t.filter(e,n.map(function(e){return a.get(e)})),l.containsError(t)?t:t.map(function(e){return e.get("name")})):n},[n(c.TypeSignature("where"))])("visited","Boolean",function(e,t){var n;return"string"==typeof t?a.has(t)?0<s.passageNameVisited(t)||s.passage===t:l.create("macrocall","There's no passage named '"+t+"' in this story."):(n=s.history(),n=t.filter(e,n.concat(s.passage).map(function(e){return a.get(e)})),l.containsError(n)?n:0<n.length)},[k(String,c.TypeSignature("where"))])("passage","Datamap",function(e,t){return b(a.get(t||s.passage))||l.create("macrocall","There's no passage named '"+t+"' in this story.")},[n(String)])("passages","Array",function(e,t){var n=i("en"),r=_toConsumableArray(a.values()).map(function(e){return b(e)}),t=t?t.filter(e,r):r,e=l.containsError(t);return e||t.sort(function(e,t){return n(e.get("name"),t.get("name"))})},[n(c.TypeSignature("where"))])("open-storylets","Array",function(e,t){return e.stackTop.evaluateOnly?l.create("macrocall","(open-storylets:) can't be used in "+e.stackTop.evaluateOnly+"."):(e=a.getStorylets(e,t),l.containsError(e)||e.map(b))},[n(c.TypeSignature("where"))])("savedgames","Datamap",function(){function e(e){return"("+e+" "+p.ifid+") "}var t,n,r=0,a=new Map;do{if(!s.hasStorage)break;t=localStorage.key(r),r+=1;var o=e("Saved Game")}while(null!=(n=t)&&n.startsWith(o)&&(t=t.slice(o.length),a.set(t,localStorage.getItem(e("Saved Game Filename")+t))),t);return a},[])(["datamap","dm"],"Datamap",function(e){for(var r,a=new Map,t=arguments.length,n=new Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=n.reduce(function(e,t){var n;if(!l.containsError(e))if(void 0===r)r=t;else{if(n=l.containsError(m(a,r)))return n;if(a.has(r))return l.create("macrocall","You used the same data name ("+d(r)+") twice in the same (datamap:) call.");a.set(r,b(t)),r=void 0}return e},!0);return l.containsError(i)?i:void 0!==r?l.create("macrocall","This datamap has a data name without a value."):a},S(k(o,T)))(["dataset","ds"],"Dataset",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new Set(n.filter(y).map(b))},S(T))("count","Number",function t(n,r){for(var e,a=arguments.length,o=new Array(2<a?a-2:0),i=2;i<a;i++)o[i-2]=arguments[i];if(1<o.length)return e=o.map(function(e){return t(n,r,e)}),l.containsError(e)||e.reduce(function(e,t){return e+t},0);var s=o[0];switch(h(r)){case"dataset":case"datamap":return l.create("macrocall","(count:) shouldn't be given a datamap or dataset.","You should use the 'contains' operator instead. For instance, write: $variable contains 'value'.");case"string":return"string"!=typeof s?l.create("macrocall",d(r)+" can't contain  "+d(s)+" because it isn't also a string."):s?r.split(s).length-1:0;case"array":return r.reduce(function(e,t){return e+g(t,s)},0);default:return l.create("macrocall",d(r)+" can't contain values, let alone "+d(s)+".")}},[T,w(T)])}),define("macrolib/enchantments",["jquery","utils","utils/operationutils","engine","state","passages","macros","datatypes/hookset","datatypes/codehook","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/enchantment","internaltypes/twineerror"],function(c,r,e,l,s,n,u,p,a,d,t,i,f,h){var m=e.is,e=u.TypeSignature,g=e.either,y=e.rest,o=e.optional,b=Object.assign;function v(e,t){if(d.isPrototypeOf(t)&&!t.canEnchant)return h.create("datatype","The changer given to (".concat(e,":) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:)."))}["enchant","change"].forEach(function(o){u.addCommand(o,function(e,t){t=v(o,t);if(t)return t},function(t,n,e){n=p.from(n);var r,a=[];return d.isPrototypeOf(e)&&(r=i.create({section:t}),e.run(r),0<(r.innerEnchantments||[]).length)&&(r=r.innerEnchantments.map(function(e){return e(n)}),a.push.apply(a,_toConsumableArray(r))),a.push(f.create(_defineProperty(_defineProperty({scope:n},d.isPrototypeOf(e)?"changer":"lambda",e),"section",t))),a.forEach(function(e){"enchant"===o?(t.addEnchantment(e),t.updateEnchantments()):e.enchantScope()}),""},[g(p,String),g(d,t.TypeSignature("via"))],!1)}),u.addChanger("enchant-in",function(e,t,n){var r=v("enchant-in",n);return r||d.create("enchant-in",[t,n])},function(t,n,r){return t.innerEnchantments=(t.innerEnchantments||[]).concat(function(e){return f.create(_defineProperty(_defineProperty({scope:p.from(n),localHook:e},d.isPrototypeOf(r)?"changer":"lambda",r),"section",t.section))}),t},[g(p,String),g(d,t.TypeSignature("via"))]),[["link-style",p.create({type:"name",data:"link"})],["line-style",p.create({type:"base",data:p.create({type:"name",data:"page"})},"lines",void 0)],["char-style",p.create({type:"base",data:p.create({type:"name",data:"page"})},"chars",void 0)]].forEach(function(e){var e=_slicedToArray(e,2),r=e[0],a=e[1];u.addChanger(r,function(e,t){var n=v(r,t);return n||d.create(r,[t])},function(t,n){return t.innerEnchantments=(t.innerEnchantments||[]).concat(function(e){return f.create(_defineProperty(_defineProperty({scope:a,localHook:e},d.isPrototypeOf(n)?"changer":"lambda",n),"section",t.section))}),t},[g(d,t.TypeSignature("via"))])});e=["replace","append","prepend"];function w(i,s){return r.onStartup(function(){var e=i.classList.replace(/ /g,"."),t=i.blockClassList?i.blockClassList.replace(/ /g,"."):"",n="."+e+(t?",."+t:"");r.storyElement.on(i.event.map(function(e){return e+".enchantment"}).join(" "),n,function(){var e,t=c(this);r.options.debug&&r.options.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||t.is("tw-open-button")||(e=(t=c(Array.from(t.parents(n).add(this)).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0])).data("enchantmentEvent"))&&e(t)})}),[function(e,t,n){if(!t)return h.create("datatype","A string given to this ("+s+":) macro was empty.");if(n){var r=v(s,n);if(r)return r}return d.create(s,[p.from(t)].concat(n?[n]:[]))},function(t,e,n){t.enabled=!1,t.transitionDeferred=!0,i.rerender&&(t.newTargets=(t.newTargets||[]).concat({target:e,append:i.rerender}));var r,a=null!=(r=t.section)&&r.stackTop?t.section.stackTop.tempVariables:Object.create(null),o=f.create(_defineProperty({functions:[function(e){e.attr("class",e.children().is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(e.children().css("display"))?i.blockClassList:i.classList),e.attr({tabIndex:"0"})}],data:{enchantmentEvent:function(){var e;null!=(e=t.section.stackTop)&&e.blocked||(i.once&&t.section.removeEnchantment(o),i.goto?l.goToPassage(i.goto,{transition:i.transition}):i.undo?l.goBack({transition:i.transition}):t.section.renderInto(t.source,null,_objectSpread(_objectSpread({},t),{},{append:i.once?"append":"replace",enabled:!0,transitionDeferred:!1}),a))}},scope:e,section:t.section,name:s},d.isPrototypeOf(n)?"changer":"lambda",n));return t.section&&(t.section.addEnchantment(o),o.enchantScope()),t},[g(p,String),o(g(d,t.TypeSignature("via")))]]}e.forEach(function(o){u.addChanger(o,function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.every(Boolean)?d.create(o,n.map(p.from),null,!1):h.create("datatype","A string given to this (".concat(o,":) macro was empty."))},function(e){var t;0<c(e.target).parents().filter("tw-collapsed,[collapsing=true]").length||e.attr.some(function(e){return e.collapsing})||(e.attr=[].concat(_toConsumableArray(e.attr),[{collapsing:!1}])),e.newTargets=e.newTargets||[];for(var n=arguments.length,r=new Array(1<n?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return(t=e.newTargets).push.apply(t,_toConsumableArray(r.filter(function(n){return!e.newTargets.some(function(e){var t=e.target,e=e.append;return m(n,t)&&o===e})}).map(function(e){return{target:e,append:o,before:!0}}))),e},y(g(p,String)))(o+"-with",function(e,t){return d.create(o+"-with",[t],null,!1)},function(e,t){return a.isPrototypeOf(t)&&(t=t.code),e.appendSource=(e.appendSource||[]).concat({source:t,append:o}),e},g(a,String))});var k="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints,S=[{name:"click",enchantDesc:{event:["click"],once:!0,rerender:"",classList:"link enchantment-link",blockClassList:"enchantment-clickblock"}},{name:"mouseover",enchantDesc:{event:["mouseenter",k?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseover",blockClassList:"enchantment-mouseoverblock"}},{name:"mouseout",enchantDesc:{event:["mouseleave",k?"click":""].filter(Boolean),once:!0,rerender:"",classList:"link enchantment-mouseout",blockClassList:"enchantment-mouseoutblock"}},{name:"doubleclick",enchantDesc:{event:["dblclick"],once:!0,rerender:"",classList:"link enchantment-dblclick",blockClassList:"enchantment-dblclickblock"}}];S.forEach(function(e){"doubleclick"!==e.name&&(u.addChanger.apply(u,[e.name].concat(_toConsumableArray(w(e.enchantDesc,e.name)))),"click"===e.name)&&u.addChanger.apply(u,[e.name+"-rerun"].concat(_toConsumableArray(w(_objectSpread(_objectSpread({},e.enchantDesc),{},{once:!1}),e.name+"-rerun"))))}),r.onStartup(function(){S.forEach(function(e){var n=e.enchantDesc;n.blockClassList&&r.storyElement.on(n.event.map(function(e){return e+".enchantment"}).join(" "),function(){var e,t=c(this);r.options.debug&&r.options.ignoreClickEvents&&!t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||t.is("tw-open-button")||(e=(t=c(Array.from(t.parents("."+n.blockClassList.replace(/ /g,"."))).sort(function(e,t){return 8&e.compareDocumentPosition(t)?1:-1})[0])).data("enchantmentEvent"))&&e(t)})})}),e.forEach(function(n){S.forEach(function(e){var t;"doubleclick"!==e&&(t=_objectSpread(_objectSpread({},e.enchantDesc),{},{rerender:n}),e=e.name+"-"+n,u.addChanger.apply(u,[e].concat(_toConsumableArray(w(t,e)))))})}),S.forEach(function(i){"doubleclick"!==i&&["goto","undo"].forEach(function(a){var o=i.name+"-"+a;u.addCommand(o,function(e,t){return!e||!t&&"goto"===a?h.create("datatype","A string given to this ("+o+":) macro was empty."):"goto"!==a||n.hasValid(t)?void 0:h.create("macrocall","I can't ("+o+":) the passage '"+t+"' because it doesn't exist.")},function(e,t,n,r){return"undo"===a&&s.pastLength<1?h.create("macrocall","I can't (undo:) on the first turn."):((0,_slicedToArray(w(_objectSpread(_objectSpread({},i.enchantDesc),{},{transition:e.data.passageT8n},"undo"===a?{undo:!0}:{goto:r}),o),2)[1])({section:t},p.from(n)),b(e,{source:""}))},[g(p,String)].concat("undo"===a?[]:String))})})}),define("macrolib/links",["jquery","macros","utils","state","passages","engine","datatypes/changercommand","internaltypes/changedescriptor","datatypes/hookset","datatypes/lambda","internaltypes/twineerror"],function(i,e,c,l,u,p,a,d,t,f,h){var n=e.TypeSignature,r=n.optional,o=n.rest,n=n.either,m=["Links can't have empty strings for their displayed text.","In the link syntax, a link's displayed text is inside the [[ and ]], and on the non-pointy side of the -> or <- arrow if it's there."],g=Object.assign;function s(e,t,n){n=n||t;var r,a=u.hasValid(t)&&t===n,e=e.evaluateTwineMarkup(c.unescape(n),"a link's passage name");return a?t=(a=0<e.children().length?"`".repeat((n.match(/`+/)||[]).reduce(function(e,t){return Math.max(e,t.length+1)},1)):"")+"\0".repeat(!!a)+t+"\0".repeat(!!a)+a:(e.findAndFilter("tw-error").length&&(r=e.findAndFilter("tw-error").data("TwineError")),n=e.text()),{text:t,passage:n,error:r}}c.onStartup(function(){var e="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints;function t(e){var t=i(this),n=t.closest("tw-expression"),r=t.closest("tw-expression, tw-hook"),a=r.data("clickEvent"),r=r.data("section");if((!c.options.debug||!c.options.ignoreClickEvents||t.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *"))&&!t.is("tw-open-button")&&(null==r||!r.stackTop||!r.stackTop.blocked||r.stackTop.blocked instanceof i&&r.stackTop.blocked.find(t).length)){if(a)return 0<t.find("tw-error").length?void 0:(e.stopPropagation(),void a(t));var r=n.data("linkPassageName"),o=_objectSpread({},n.data("passageT8n")||{});n.find("tw-enchantment").each(function(e,t){Object.assign(o,i(t).data("passageT8n")||{})}),r?(e.stopPropagation(),p.goToPassage(r,{transition:o})):t.is("[undo]")?(e.stopPropagation(),p.goBack({transition:o})):t.is("[fullscreen]")&&(e.stopPropagation(),p.toggleFullscreen())}}c.storyElement.on("click.passage-link","tw-link"+(e?"":":not(.enchantment-mouseover):not(.enchantment-mouseout):not(.enchantment-dblclick)"),t).on("mouseover.passage-link","tw-link.enchantment-mouseover, tw-expression.enchantment-mouseover > tw-link",t).on("mouseout.passage-link","tw-link.enchantment-mouseout, tw-expression.enchantment-mouseout > tw-link",t).on("dblclick.passage-link","tw-link.enchantment-dblclick, tw-expression.enchantment-dblclick > tw-link",t),i(document).on("fullscreenchange",function(){i("tw-link[fullscreen]",c.storyElement).each(function(e,t){(i(t).closest("tw-expression, tw-hook").data("fullscreenEvent")||Object)(t)})})}),[["link","link-replace"],["link-reveal","link-append"],["link-repeat"],["link-rerun"]].forEach(function(s){return e.addChanger(s,function(e,t,n){return t?n&&!n.canEnchant?h.create("datatype","The changer given to (".concat(s[0],":) can't be (or include) a revision, enchantment, or interaction changer like (replace:), (click:), or (link:).")):a.create(s[0],[t].concat(n||[]),null,!0):h.create("datatype",m[0])},function(r,e,t){var n,a=s[0],o=null!=(n=r.section)&&n.stackTop?r.section.stackTop.tempVariables:Object.create(null),i=d.create({source:"<tw-link tabindex=0>"+e+"</tw-link>",target:function(){return r.target},append:"replace",data:{section:r.section,clickEvent:function(e){r.enablers=r.enablers.filter(function(e){return e.descriptor!==i}),"link-reveal"===a&&e.contents().unwrap();var t,n=e.parentsUntil(":not(tw-enchantment)").parent();n.length||(n=e.parent()),"link-rerun"===a&&(t=e.parentsUntil(":not(tw-enchantment)"),e.detach(),t.remove()),"link"!==a&&"link-rerun"!==a||n.empty(),r.section.renderInto("",null,r,o),"link-rerun"===a&&n.prepend(e)}}});return r.enablers=(r.enablers||[]).concat({descriptor:i,changer:t}),r},[String,r(a)])}),e.addCommand("link-goto",function(e){if(!e)return h.create.apply(h,["datatype"].concat(m))},function(e,t,n,r){var a,o=s(t,n,r);return n=o.text,r=o.passage,(o=o.error)||(e.transition?h.create("datatype","Please attach ("+(o="transition")+"-depart:) or ("+o+"-arrive:) to a passage link, not ("+o+":)."):(a=(a=u.hasValid(r)?a:'<tw-broken-link passage-name="'+c.escape(r)+'">'+n+"</tw-broken-link>")||"<tw-link tabindex=0 "+(0<l.passageNameVisited(r)?'class="visited" ':"")+">"+n+"</tw-link>",e.data.linkPassageName=r,e.data.section=t,g(e,{source:a,transitionDeferred:!0})))},[String,r(String)])("link-storylet",function(){var e=(e=1===arguments.length||"string"!=typeof(arguments.length<=0?void 0:arguments[0])?0:1)<0||arguments.length<=e?void 0:arguments[e];if(!e||"string"==typeof e)return h.create("datatype","(link-storylet:) should be given one index number or one 'where' lambda, after the optional link text string.")},function(e,t){var n=(n=2+("string"==typeof(arguments.length<=2?void 0:arguments[2])?1:0))<2||arguments.length<=n?void 0:arguments[n],r="string"==typeof(arguments.length<=2?void 0:arguments[2])&&(arguments.length<=2?void 0:arguments[2]),a=((a=(arguments.length<=2?0:arguments.length-2)-1+2)<2||arguments.length<=a?void 0:arguments[a])!==n&&((a=(arguments.length<=2?0:arguments.length-2)-1+2)<2||arguments.length<=a?void 0:arguments[a]);if(e.transition)return h.create("datatype","Please attach (".concat(o="transition","-depart:) or (").concat(o,"-arrive:) to (link-storylet:), not (").concat(o,":)."));var o=f.isPrototypeOf(n),i=u.getStorylets(t,o&&n),s=h.containsError(i);if(s)return s;var c,s=i[o?0:n<0?i.length+n:n-1];if(s)s=s.get("name"),r=r||s,c=c||"<tw-link tabindex=0 "+(0<l.passageNameVisited(s)?'class="visited" ':"")+">"+r+"</tw-link>",e.data.linkPassageName=s,e.data.section=t;else{if(!a)return e;c=a}return g(e,{source:c,transitionDeferred:!0})},[n(parseInt,String,f.TypeSignature("where")),r(n(parseInt,String,f.TypeSignature("where"))),r(String)])("link-undo",function(e){if(!e)return h.create("datatype",m[0])},function(t,e,n){var r,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"";return l.pastLength<1?g(t,{source:a}):(r=(t.data.section=e).stackTop.tempVariables,t.data.forgetUndosEvent=function(){return t.data.section.whenUnblocked(function(){var e=_objectSpread(_objectSpread({},t),{},{append:"replace",source:a,transitionDeferred:!1});t.section.renderInto("",null,e,r)})},g(t,{source:"<tw-link tabindex=0 undo>"+n+"</tw-link>",transitionDeferred:!0}))},[String,r(String)])("link-show",function(e){if(!e)return h.create("datatype",m[0])},function(r,a,e){for(var t=arguments.length,n=new Array(3<t?t-3:0),o=3;o<t;o++)n[o-3]=arguments[o];return r.data.section=a,r.data.clickEvent=function(e){e.contents().unwrap(),n.forEach(function(e){return e.forEach(a,function(e){var t=e.data("originalSource")||"",n=e.data("hidden");n&&(e.removeData("hidden"),n instanceof i?e.empty().append(n):(n=e.data("tempVariables"),a.renderInto("",null,_objectSpread(_objectSpread({},r),{},{source:t,target:e,transitionDeferred:!1}),n&&Object.create(n))))})})},g(r,{source:"<tw-link tabindex=0>"+e+"</tw-link>",transitionDeferred:!0})},[String,o(t)])("link-fullscreen",function(e,t){if(!e||!t)return h.create("datatype",m[0])},function(t,e,n,r){function a(){return document.fullscreenEnabled||document.msFullscreenEnabled?"<tw-link tabindex=0 fullscreen>"+(document.fullscreenElement||document.msFullscreenElement?r:n)+"</tw-link>":r?"<tw-broken-link>"+r+"</tw-broken-link>":""}var o=e.stackTop.tempVariables;return t.data.section=e,t.data.fullscreenEvent=function(){(document.fullscreenEnabled||document.msFullscreenEnabled)&&t.data.section.whenUnblocked(function(){var e=_objectSpread(_objectSpread({},t),{},{append:"replace",source:a(),transitionDeferred:!1});t.section.renderInto("",null,e,o)})},g(t,{source:a(),transitionDeferred:!0})},[String,String,r(String)]),e.addChanger(["link-reveal-goto"],function(e,t,n,r){if(!t)return h.create.apply(h,["datatype"].concat(m));if(a.isPrototypeOf(n)){if(a.isPrototypeOf(r))return h.create("datatype","You mustn't give two changers to (link-reveal-goto:)");r=n,n=void 0}return r&&!r.canEnchant?h.create("datatype","The changer given to (link-reveal-goto:) can't include a revision, enchantment, or interaction changer like (replace:), (click:), or (link:)."):(t=(e=s(e,t,n)).text,n=e.passage,e.error||a.create("link-reveal-goto",[t,n,r].filter(function(e){return void 0!==e}),null,!1))},function(t,e,n,r){var a,o,i,s;if(u.hasValid(n))return o=l.passageNameVisited(n),i=null!=(a=t.section)&&a.stackTop?t.section.stackTop.tempVariables:Object.create(null),s=d.create({source:"<tw-link tabindex=0 "+(0<o?'class="visited" ':"")+">"+e+"</tw-link>",target:t.target,append:"replace",data:{section:t.section,append:"replace",clickEvent:function(e){t.enablers=t.enablers.filter(function(e){return e.descriptor!==s}),e.contents().unwrap(),t.section.renderInto("",null,t,i),t.section.whenUnblocked(function(){return p.goToPassage(n,{transition:t.data.passageT8n})})}}}),t.enablers=(t.enablers||[]).concat({descriptor:s,changer:r}),t;t.source='<tw-broken-link passage-name="'+c.escape(n)+'">'+e+"</tw-broken-link>"},[String,r(n(a,String)),r(a)])}),define("macrolib/metadata",["macros","utils/operationutils","datatypes/lambda","internaltypes/twineerror"],function(t,e,n,s){function c(e){return{TwineScript_TypeName:"a ("+e+":) macro",TwineScript_ObjectName:"a ("+e+":) macro",TwineScript_Unstorable:!0,TwineScript_Print:function(){return""}}}var l=e.clone,u=e.objectName,p=e.isValidDatamapName,e=t.TypeSignature,r=e.zeroOrMore,e=e.Any;[["storylet",n.TypeSignature("when")],["urgency",Number],["exclusivity",Number]].forEach(function(e){var e=_slicedToArray(e,2),n=e[0],e=e[1];t.add(n,"Metadata",function(e,t){return e.stackTop.speculativePassage?t:c(n)},e)}),t.add("metadata","Metadata",function(e){for(var r,a=new Map,t=arguments.length,n=new Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=n.reduce(function(e,t){var n;if(!s.containsError(e))if(void 0===r)r=t;else{if(n=s.containsError(p(a,r)))return n;if(a.has(r))return s.create("macrocall","You used the same data name ("+u(r)+") twice in the same (metadata:) call.");a.set(r,l(t)),r=void 0}return e},!0);return s.containsError(i)?i:void 0!==r?s.create("macrocall","This (metadata:) macro has a data name without a value."):e.stackTop.speculativePassage?a:c("metadata")},r(e))}),define("macrolib/patterns",["macros","utils","utils/operationutils","datatypes/lambda","datatypes/datatype","datatypes/typedvar","internaltypes/twineerror","internaltypes/varscope"],function(e,t,n,y,b,h,v,w){function k(e){var r,t,a=e.name,n=e.fullArgs,o=e.args,i=e.makeRegExpString,s=void 0===i?function(e){return e.join("")}:i,c=void 0!==(i=e.insensitive)&&i,l=void 0===(i=e.canContainTypedVars)||i,u=void 0===(i=e.canBeUsedAlone)||i,p=void 0===(i=e.canContainTypedGlobals)||i,d=o||n,f=E(null),e=d.map(function e(t){if(h.isPrototypeOf(t)){var n=t.varRef;if(!l)return v.create("operation","Optional string patterns, like (".concat(a,":)").concat("p-many"===a?" with a minimum of 0 matches":"",", can't have typed variables inside them."));if(!p&&!w.isPrototypeOf(n.object))return v.create("operation","Only typed temp variables can be used in patterns given to (".concat(a,":)"));n=n.getName();if(n in f)return v.create("operation","There's already a typed temp variable named _".concat(n," inside this (").concat(a,":) call."));f[n]=!0;n=e(t.datatype);return v.containsError(n)?n:"("+n+")"}if(b.isPrototypeOf(t)){if(!(l&&p||"function"!=typeof t.typedVars)){n=t.typedVars();if(!l&&n.length)return v.create("operation","(".concat(a,":) can't have typed variables inside its pattern."));if(!p&&n.some(function(e){return!w.isPrototypeOf(e.varRef.object)}))return v.create("operation","Only typed temp variables can be used in patterns given to (".concat(a,":)"))}var r;return t.regExp?(t.rest?"(?:":"")+(c?t.insensitive():t).regExp+(t.rest?")*":""):(n=t.name,r=t.rest?"*":"","alnum"===n?m+r:"whitespace"===n?_+r:"uppercase"===n?(c?T:g)+r:"lowercase"===n?(c?T:S)+r:"anycase"===n?T+r:"digit"===n?"\\d"+r:"linebreak"===n?"(?:\\r|\\n|\\r\\n)"+r:"str"===n?".*?":["even","odd","int","num"].includes(n)?v.create("datatype","Please use string datatypes like 'digit' in (".concat(a,":) instead of number datatypes.")):v.create("datatype","The (".concat(a,":) macro must only be given string-related datatypes, not ").concat(O(t),".")))}return"string"==typeof t?(t=t.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"),c?t.replace(RegExp("(".concat(g,"|").concat(S,")"),"g"),function(e){return"["+e.toUpperCase()+e.toLowerCase()+"]"}):t):(x("createPattern","mapper() was given a non-string non-datatype "+t),"")});return(i=v.containsError(e))||(r=s(e),t=C(E(b),{name:a,regExp:r,insensitive:function(){return c?t:k({name:a,fullArgs:n,args:d.map(function(e){return b.isPrototypeOf(e)&&"function"==typeof e.insensitive?e.insensitive():e}),makeRegExpString:s,insensitive:!0,canContainTypedVars:l,canBeUsedAlone:u})},typedVars:function(){return d.reduce(function(e,t){return h.isPrototypeOf(t)&&(e=e.concat(c?h.create(k({name:"p-ins",fullArgs:[t.datatype],insensitive:!0}),t.varRef):t),t=t.datatype),e=b.isPrototypeOf(t)&&"function"==typeof t.typedVars?e.concat(t.typedVars()):e},[])},destructure:function(e){var n,t;return"string"!=typeof e?[v.create("operation","I can't put ".concat(O(e)," into ").concat(this.TwineScript_ToSource()," because it isn't a string."))]:(n=this.typedVars()).length?(t=(RegExp("^"+(this.rest?"(?:":"")+r+(this.rest?")*":"")+"$").exec(e)||[]).slice(1)).length?t.map(function(e,t){t=n[t];if(t)return t.datatype.rest&&!t.datatype.regExp&&((t=t.TwineScript_Clone()).datatype=k({name:"p",fullArgs:[t.datatype]})),{dest:t,value:e||"",src:void 0}}).filter(Boolean):[v.create("operation","I can't put ".concat(O(e)," because it doesn't match the pattern ").concat(this.TwineScript_ToSource(),"."))]:[]},TwineScript_IsTypeOf:function(e){return u?"string"==typeof e&&!!e.match("^"+(this.rest?"(?:":"")+r+(this.rest?")*":"")+"$"):v.create("operation","A (".concat(a,":) datatype must only be used with a (p:) macro."))},TwineScript_toTypeSignatureObject:function(){var t=this;return{pattern:"range",name:a,range:function(e){return t.TwineScript_IsTypeOf(e)}}},TwineScript_ToSource:function(){return(this.rest?"...":"")+"("+a+":"+n.map(A)+")"}}),Object.defineProperty(t,"TwineScript_ObjectName",{get:function(){return"a (".concat(a,":) datatype")}}),t)}var m=t.anyRealLetter,g=t.anyUppercase,S=t.anyLowercase,T=t.anyCasedLetter,_=t.realWhitespace,x=t.impossible,O=n.objectName,A=n.toSource,t=e.TypeSignature,n=t.rest,r=t.either,a=t.optional,t=t.nonNegativeInteger,C=Object.assign,E=Object.create,o=n(r(String,b,h));e.add(["p","pattern"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p",fullArgs:n})},o)(["p-either","pattern-either"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-either",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("|")+")"}})},o)(["p-opt","pattern-opt","p-optional","pattern-optional"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-opt",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?:"+e.join("")+")?"}})},o)(["p-not","pattern-not"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.find(function(e){return"string"==typeof e?1!==_toConsumableArray(e).length:e.rest||e.regExp||["str","empty"].includes(e.name)})?v.create("datatype","(p-not:) should only be given single characters, or datatypes that match single characters"):k({name:"p-not",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"[^"+e.map(function(e){return e.startsWith("[")&&e.endsWith("]")?e.slice(1,-1):e}).join("")+"]"}})},o)(["p-not-before","pattern-not-before"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-not-before",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?!"+e.join("")+")"}})},o)(["p-before","pattern-before"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-before",fullArgs:n,canContainTypedVars:!1,makeRegExpString:function(e){return"(?="+e.join("")+")"}})},o)(["p-start","pattern-start"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-start",fullArgs:n,makeRegExpString:function(e){return"^(?:"+e.join("")+")"}})},o)(["p-end","pattern-end"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-end",fullArgs:n,makeRegExpString:function(e){return"(?:"+e.join("")+")$"}})},o)(["p-many","pattern-many"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a,o,i,s=n.slice();return"number"==typeof n[0]&&(a=n.shift(),o="number"==typeof n[0]?n.shift():1/0),!(void 0!==o&&o<a)&&n.length?(i=n.find(function(e){return"string"!=typeof e&&!b.isPrototypeOf(e)&&!h.isPrototypeOf(e)}))?v.create("datatype","This (p-many:) macro can only be given a min and max number followed by datatypes or strings, but was also given "+O(i)+"."):k({name:"p-many",args:n,fullArgs:s,canContainTypedVars:0<a,makeRegExpString:function(e){return"(?:"+e.join("")+")"+(void 0!==a?"{"+a+(o===1/0?",":o!==a?","+o:"")+"}":"+")}}):v.create("datatype","The (p-many:) macro needs to be given string patterns, not just min and max numbers.")},[n(r(t,String,b,h))])(["p-ins","pattern-ins","p-insensitive","pattern-insensitive"],"Datatype",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return k({name:"p-ins",fullArgs:n,insensitive:!0})},o)(["split","splitted"],"Array",function(e,t,n){if(t=k({name:"split",fullArgs:[t],canContainTypedVars:!1}),v.containsError(t))return t;if(!n)return[""];if(!t.regExp)return _toConsumableArray(n);for(var r,a=RegExp(t.regExp),o=[];n&&(r=a.exec(n));){if(r.index+r[0].length===0)return o;o.push(n.slice(0,r.index)),n=n.slice(r.index+r[0].length)}return o.concat(n||[])},[r(String,b),String])("trimmed","String",function(e,t,n){return void 0===n||b.isPrototypeOf(t)&&"whitespace"===t.name?t.trim():(t=k({name:"trimmed",fullArgs:[t],canContainTypedVars:!1}),v.containsError(t)?t:t.regExp?n.replace(RegExp("^("+t.regExp+")*|("+t.regExp+")*$","g"),""):n)},[r(String,b),a(String)])(["str-find","string-find"],"String",function(e,t,n){if(t=k({name:"str-find",fullArgs:[t],canContainTypedGlobals:!1}),v.containsError(t))return t;for(var r,a=t.typedVars(),o=RegExp(t.regExp,"g"),i=[],s=o.lastIndex;(r=o.exec(n))&&s!==o.lastIndex;)if(s=o.lastIndex,a.length){for(var c=new Map,l=0;l<a.length;l+=1){if("match"===a[l].varRef.getName())return v.create("macrocall","There was a typed temp variable named _match in the pattern given to (str-find:)","The variable _match is reserved, and can't be used inside (str-find:)'s pattern.");c.set(a[l].varRef.getName(),r[l+1]),c.set("match",r[0])}i.push(c)}else i.push(r[0]);return i},[b,String])(["str-replaced","string-replaced","replaced"],"String",function(e,t,n,r,a){if("number"!=typeof t){if(void 0!==a)return v.create("macrocall","1 too many values were given to (str-replaced:).","If this is given 5 values, the first value must be a number of replacements.");a=r,r=n,n=t,t=1/0}else if(void 0===a)return v.create("macrocall","The (str-replaced:) macro needs 1 more value.","The final string seems to be missing.");if(b.isPrototypeOf(r))return v.create("datatype","The replacement value for (str-replaced:) must be a string or lambda, not ".concat(O(r)));if(y.isPrototypeOf(a)||y.isPrototypeOf(n))return v.create("datatype","The ".concat(y.isPrototypeOf(a)?"final string":"search pattern"," given to (str-replaced:) can't be a lambda."),"Only the replacement value (after the search pattern) can be a 'via' lambda.");if(n=k({name:"str-replaced",fullArgs:[n],canContainTypedGlobals:!1}),v.containsError(n))return n;if(!n.regExp)return a;for(var o,i=RegExp(n.regExp,"g"),s=y.isPrototypeOf(r)?n.typedVars():[],c=1,l=0,u="",p=i.lastIndex;a&&(o=i.exec(a))&&0<t&&p!==i.lastIndex;){for(var p=i.lastIndex,d=Object.create(e.stack.length?e.stackTop.tempVariables:w),f=0;f<s.length;f+=1){var h=s[f],m=h.varRef.create(d,h.varRef.propertyChain);if(v.containsError(m))return m;h=m.defineType(h.datatype);if(v.containsError(h))return h;m.set(o[f+1])}var g=y.isPrototypeOf(r)?r.apply(e,{loop:o[0],pos:c,tempVariables:d}):r;if(v.containsError(g))return g;if("string"!=typeof g)return v.create("datatype","(str-replaced:)'s lambda must produce a string, but it produced ".concat(O(g),' when given "').concat(o[0],'".'));u+=a.slice(l,o.index)+g,c+=1,--t,l=o.index+o[0].length}return u+=a.slice(l)},[r(t,String,b),r(b,String,y.TypeSignature("via")),r(String,y.TypeSignature("via")),a(String)])}),define("macrolib/stylechangers",["jquery","macros","utils","utils/renderutils","datatypes/colour","datatypes/hookset","datatypes/gradient","datatypes/changercommand","datatypes/lambda","internaltypes/changedescriptor","internaltypes/twineerror"],function(s,e,c,t,a,n,r,o,i,l,u){var p,d,f=t.geomParse,h=t.geomStringRegExp,m=Object.assign,t=e.TypeSignature,g=t.either,y=t.wrapped,b=t.optional,v=t.Any,w=t.Everything,k=t.zeroOrMore,S=t.rest,T=t.insensitiveSet,_=t.positiveNumber,x=t.positiveInteger,O=t.nonNegativeNumber,t=t.percent,y=[y(Boolean,'If you gave a number, you may instead want to check that the number is not 0. If you gave a string, you may instead want to check that the string is not "".')],A=(c.onStartup(function(){return c.storyElement.on("mouseenter.hover-macro","[hover=false]",function(){var e=s(this),t=e.data("hoverChanger");c.options.debug&&c.options.ignoreClickEvents&&!e.is("tw-backdrop.eval-replay *, tw-backdrop.harlowe-crash *")||(e.data({mouseoutStyle:e.attr("style")||""}),l.create({target:e},t).update(),e.attr("hover",!0))}).on("mouseleave.hover-macro","[hover=true]",function(){var e=s(this),t=e.data("mouseoutStyle");e.attr("style",t).removeData("mouseoutStyle").attr("hover",!1)})}),u.on(function(){s("tw-expression, tw-hook",c.storyElement).each(function(e,t){((t=s(t)).data("errorEvent")||Object)(t)})}),T("instant","dissolve","fade","rumble","shudder","pulse","zoom","flicker","slideleft","slideright","slideup","slidedown","fadeleft","faderight","fadeup","fadedown","blur")),C=T("dotted","dashed","solid","double","groove","ridge","inset","outset","none");e.addChanger("if",function(e,t){return o.create("if",[t])},function(e,t){return e.enabled=e.enabled&&t},y)("unless",function(e,t){return o.create("unless",[t])},function(e,t){return e.enabled=e.enabled&&!t},y)("elseif",function(e,t){return"lastHookShown"in e.stack[0]?o.create("elseif",[!1===e.stack[0].lastHookShown&&!!t]):u.create("macrocall","There's no (if:) or something else before this to do (else-if:) with.")},function(e,t){return e.enabled=e.enabled&&t},y)("else",function(e){return"lastHookShown"in e.stack[0]?o.create("else",[!1===e.stack[0].lastHookShown]):u.create("macrocall","There's nothing before this to do (else:) with.")},function(e,t){return e.enabled=e.enabled&&t},null)("hidden",function(){return o.create("hidden")},function(e){return e.enabled=!1},null)(["verbatim","v6m"],function(){return o.create("verbatim")},function(e){return e.verbatim=!0},null)("live",function(e,t){return o.create("live",t?[t]:[])},function(e,t){e.enabled=!1,e.transitionDeferred=!0,e.data.live={delay:t}},b(Number))("event",function(e,t){return o.create("event",[t])},function(e,t){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:t}},i.TypeSignature("when"))("more",function(){return o.create("more")},function(e){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:function(e){return 0!==e.Identifiers.exits?[]:[!0]}}}},null)("after",function(e,t,n){return o.create("after",[t].concat(void 0!==n?[n]:[]))},function(e,t,n){e.enabled=!1,e.transitionDeferred=!0,e.data.live={event:{when:!0,filter:function(e){return c.anyInputDown()&&n&&(t-=n),e.Identifiers.time>t?[!0]:[]}}}},[_,b(O)])("after-error",function(){return o.create("after-error",[])},function(n){n.enabled=!1,n.transitionDeferred=!0;var r=n.section.stackTop.tempVariables;n.data.errorEvent=function(e){e.removeData("errorEvent");var t=_objectSpread(_objectSpread({},n),{},{enabled:!0,transitionDeferred:!1});t.data&&(t.data.errorEvent=void 0),n.section.whenUnblocked(function(){return n.section.renderInto("",null,t,r)})}},[])("hook",function(e,t){var n;return t?(n=c.insensitiveName(t))?o.create("hook",[n]):u.create("datatype",'The string given to (hook:), "'.concat(t,'", contained only dashes and underscores.')):u.create("datatype","The string given to (hook:) was empty.")},function(e,t){return e.attr.push({name:t})},[String])(["for","loop"],function(e,t){if(!t.loop)return u.create("datatype","The lambda provided to (for:) must refer to a temp variable, not just 'it'.");for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return o.create("for",[t].concat(r))},function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o,i=t.filter(e.section,r);if(o=u.containsError(i))return o;e.loopVars[t.loop.getName()]=i||[]},[i.TypeSignature("where"),k(v)])(["transition","t8n"],function(e,t){return o.create("transition",[c.insensitiveName(t)])},function(e,t){return"zoom"===(e.transition=t)&&(e.transitionOrigin=function(){var e=s(this).offset(),t=e.left,e=e.top;return c.mouseCoords.x-t+"px "+(c.mouseCoords.y-e)+"px"}),e},[A])(["transition-time","t8n-time"],function(e,t){return o.create("transition-time",[t])},function(e,t){return e.transitionTime=t,e.data.passageT8n=m(e.data.passageT8n||{},{time:t}),e},[_])(["transition-delay","t8n-delay"],function(e,t){return o.create("transition-delay",[t])},function(e,t){return e.transitionDelay=t,e},[O])(["transition-skip","t8n-skip"],function(e,t){return o.create("transition-skip",[t])},function(e,t){return e.transitionSkip=t,e},[_])(["transition-depart","t8n-depart"],function(e,t){return o.create("transition-depart",[c.insensitiveName(t)])},function(e,t){return e.data.passageT8n=m(e.data.passageT8n||{},{depart:t}),"zoom"===t&&(e.data.passageT8n.departOrigin=function(){var e=s(this).offset(),t=e.left,e=e.top;return c.mouseCoords.x-t+"px "+(c.mouseCoords.y-e)+"px"}),e},[A])(["transition-arrive","t8n-arrive"],function(e,t){return o.create("transition-arrive",[c.insensitiveName(t)])},function(e,t){return e.data.passageT8n=m(e.data.passageT8n||{},{arrive:t}),"zoom"===t&&(e.data.passageT8n.arriveOrigin=function(){var e=s(this),t=e.offset(),n=t.left,t=t.top,r=e.height();return{"transform-origin":100*(c.mouseCoords.x-n)/e.width()+"% "+100*(c.mouseCoords.y-t)/r+"%",height:r+"px"}}),e},[A])("button",function(e,t){return void 0===t||f(t).size?o.create("button",t?[t]:[]):u.create("datatype",'The string given to (button:) should be a sizing line ("==X==", "==X", "=XXXX=" etc.), not '.concat(JSON.stringify(t),"."))},function(e,t){var t=f(t),n=t.marginLeft,t=t.size;return e.attr.push({class:function(){return this.className+(this.classList.contains("enchantment-button")?"":" ".repeat(0<this.className.length)+"enchantment-button")}}),e.styles.push({"margin-left":t?n+"%":void 0,width:t?t+"%":"100%"}),e},[b(String)]).apply(void 0,_toConsumableArray((d={click:{className:"enchantment-link",blockClassName:"enchantment-clickblock"},doubleclick:{className:"enchantment-dblclick",blockClassName:"enchantment-dblclickblock"},mouseover:{className:"enchantment-mouseover",blockClassName:"enchantment-mouseoverblock"},mouseout:{className:"enchantment-mouseout",blockClassName:"enchantment-mouseoutblock"}},["action",function(e,t){return o.create("action",[c.insensitiveName(t)])},function(e,t){return e.attr.push({class:function(){var e=function e(t){return(t=s(t)).is("tw-story, tw-sidebar, tw-passage")||["block","flex"].includes(t.css("display"))||t.children().get().some(e)}(this);return Array.from(this.classList).filter(function(t){return!Object.keys(d).some(function(e){return d[e].className===t||d[e].blockClassName===t})}).concat(d[t][e?"blockClassName":"className"]).join(" ")}}),e},[T.apply(void 0,_toConsumableArray(Object.keys(d)))]])))(["border","b4r"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border",n.map(c.insensitiveName))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({display:function(){var e=s(this).css("display");return n.every(function(e){return"none"===e})||!e.includes("inline")?e:"inline-block"},"border-style":n.join(" "),"border-width":function(){return this.style.borderWidth||"2px"}}),e},[C].concat(_toConsumableArray(Array(3).fill(b(C)))))(["border-size","b4r-size"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border-size",n)},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-width":n.map(function(e){return e+"px"}).join(" ")}),e},[O].concat(_toConsumableArray(Array(3).fill(b(O)))))("corner-radius",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("corner-radius",n)},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-radius":n.map(function(e){return e+"px"}).join(" "),padding:function(){return this.style.padding||n.map(function(e){return e+"px"}).join(" ")}}),e},[O].concat(_toConsumableArray(Array(3).fill(b(O)))))(["border-colour","b4r-colour","border-color","b4r-color"],function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("border-colour",n.map(function(e){return a.isPrototypeOf(e)?e.toRGBAString(e):e}))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return e.styles.push({"border-color":n.join(" ")}),e},[g(String,a)].concat(_toConsumableArray(Array(3).fill(b(g(String,a))))))("opacity",function(e,t){return o.create("opacity",[t])},function(e,t){return e.styles.push({opacity:t})},[t])("font",function(e,t){return o.create("font",[t])},function(e,t){return e.styles.push({"font-family":t}),e},[String])("align",function(e,t){var n=t.indexOf("><");return/^(==+>|<=+|=+><=+|<==+>)$/.test(t)?((n=~n?_objectSpread({"text-align":"center","max-width":"50%"},25===(n=Math.round(n/(t.length-2)*50))?{"margin-left":"auto","margin-right":"auto"}:{"margin-left":n+"%"}):"<"===t[0]&&">"===t.slice(-1)?{"text-align":"justify","max-width":"50%"}:t.includes(">")?{"text-align":"right"}:{"text-align":"left"}).display="block",o.create("align",[n])):u.create("datatype",'The (align:) macro requires an alignment arrow ("==>", "<==", "==><=" etc.) be provided, not "'+t+'"')},function(e,t){e.styles.push(t)},[String])(["text-colour","text-color","color","colour"],function(e,t){return o.create("text-colour",[t])},function(e,t){return a.isPrototypeOf(t)&&(t=t.toRGBAString(t)),e.styles.push({color:t}),e},[g(String,a)])(["text-size","size"],function(e,t){return o.create("text-size",[t])},function(e,t){return e.styles.push({"font-size":24*t+"px","line-height":36*t+"px"}),e},[O])("text-indent",function(e,t){return o.create("text-indent",[t])},function(e,t){return e.styles.push({"text-indent":t+"px",display:"inline-block"}),e},[O])(["text-rotate-z","text-rotate"],function(e,t){return o.create("text-rotate-z",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" rotate("+t+"deg)"}}),e},[Number])("text-rotate-y",function(e,t){return o.create("text-rotate-y",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" perspective(50vw) rotateY("+t+"deg)"}}),e},[Number])("text-rotate-x",function(e,t){return o.create("text-rotate-x",[t])},function(e,t){return e.styles.push({display:"inline-block",transform:function(){var e=s(this).css("transform")||"";return(e="none"===e?"":e)+" perspective(50vw) rotateX("+t+"deg)"}}),e},[Number])(["background","bg"],function(e,t){return o.create("background",[t])},function(e,t){return a.isPrototypeOf(t)?t=t.toRGBAString():r.isPrototypeOf(t)&&(t=t.toLinearGradientString()),t=a.isHexString(t)||a.isCSS3Function(t)?{"background-color":t}:t.startsWith("linear-gradient(")||t.startsWith("repeating-linear-gradient(")?{"background-image":t}:{"background-size":"cover","background-image":"url(".concat(t,")"),"background-attachment":"fixed"},e.styles.push(t,{display:function(){var e=s(this);return!e.children().length||c.childrenProbablyInline(e)?s(this).css("display"):"block"}}),e},[g(String,a,r)]).apply(void 0,_toConsumableArray((y={color:function(){return"transparent"}},p=m(Object.create(null),{none:{},bold:{"font-weight":"bold"},italic:{"font-style":"italic"},underline:{"text-decoration":"underline"},doubleunderline:{"text-decoration":"underline","text-decoration-style":"double"},wavyunderline:{"text-decoration":"underline","text-decoration-style":"wavy"},strike:{"text-decoration":"line-through"},doublestrike:{"text-decoration":"line-through","text-decoration-style":"double"},wavystrike:{"text-decoration":"line-through","text-decoration-style":"wavy"},superscript:{"vertical-align":"super","font-size":".83em"},subscript:{"vertical-align":"sub","font-size":".83em"},blink:{animation:"fade-in-out 1s steps(1,end) infinite alternate"},shudder:{animation:"shudder linear 0.1s 0s infinite"},mark:{"background-color":"hsla(60, 100%, 50%, 0.6)"},condense:{"letter-spacing":"-0.08em"},expand:{"letter-spacing":"0.1em"},outline:[{"text-shadow":function(){var e=s(this).css("color");return"-1px -1px 0 "+e+", 1px -1px 0 "+e+",-1px  1px 0 "+e+", 1px  1px 0 "+e}},{color:function(){return c.parentColours(s(this)).backgroundColour}}],shadow:{"text-shadow":function(){return"0.08em 0.08em 0.08em "+s(this).css("color")}},emboss:{"text-shadow":function(){return"0.04em 0.04em 0em "+s(this).css("color")}},smear:[{"text-shadow":function(){var e=s(this).css("color");return"0em   0em 0.02em "+e+",-0.2em 0em  0.5em "+e+", 0.2em 0em  0.5em "+e}},y],blur:[{"text-shadow":function(){return"0em 0em 0.08em "+s(this).css("color")}},y],blurrier:[{"text-shadow":function(){return"0em 0em 0.2em "+s(this).css("color")},"user-select":"none"},y],mirror:{display:"inline-block",transform:"scaleX(-1)"},upsidedown:{display:"inline-block",transform:"scaleY(-1)"},tall:{display:"inline-block",transform:"scaleY(1.5) translateY(-0.25ex)"},flat:{display:"inline-block",transform:"scaleY(0.5) translateY(0.25ex)"},fadeinout:{animation:"fade-in-out 2s ease-in-out infinite alternate"},rumble:{animation:"rumble linear 0.1s 0s infinite"},sway:{animation:"sway linear 2.5s 0s infinite"},buoy:{animation:"buoy linear 2.5s 0s infinite"},fidget:{animation:function(){return"fidget step-end 60s "+60*-Math.random()+"s infinite"+(Math.random()<.5?" reverse":"")}}}),["text-style",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return o.create("text-style",n.map(c.insensitiveName))},function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0;a<n.length;a+=1)"none"===n[a]?e.styles=[]:e.styles=e.styles.concat(p[n[a]]);return e},[S(T.apply(void 0,_toConsumableArray(Object.keys(p))))]])))("collapse",function(){return o.create("collapse")},function(e){return e.attr.push({collapsing:!0}),e},[])("hover-style",function(e,t){var n=l.create(),r=(t.run(n),n.summary());return r+""=="styles"||r.every(function(e){return"styles"===e||"attr"===e})&&n.attr.every(function(e){return Object.keys(e)+""=="style"})?o.create("hover-style",[t]):u.create("datatype","The changer given to (hover-style:) must only change the hook's style.")},function(e,t){return e.data.hoverChanger=t,e.attr.push({hover:function(e,t){return void 0!==t&&t}}),e},[o])("css",function(e,t){return t.trim().endsWith(";")||(t+=";"),o.create("css",[t])},function(e,t){return e.attr.push({style:function(){return(s(this).attr("style")||"")+t}}),e},[String])("test-true",function(){return o.create("test-true",[])},function(e){return e.enabled=!0},k(w))("test-false",function(){return o.create("test-false",[])},function(e){return e.enabled=!1},k(w)),e.addCommand("animate",s.noop,function(r,e,t,a,o){t.forEach(e,function(e){var t,n;"zoom"===name&&(n=(t=e.offset()).left,t=t.top,n=c.mouseCoords.x-n+"px "+(c.mouseCoords.y-t)+"px"),c.transitionIn(e,a,r.transitionTime||o,r.transitionDelay,r.transitionSkip,0,n)})},[S(n),T.apply(void 0,_toConsumableArray(A.innerType.filter(function(e){return"instant"!==e}))),b(_)]),["box","float-box"].forEach(function(i){return e.addChanger(i,function(e,t,n){var r=-1===t.search(h)||1<t.length&&!t.includes("="),a="float-box"===i&&(-1===n.search(h)||1<n.length&&!n.includes("="));return r||a?u.create("datatype","The ("+i+':) macro requires a sizing line("==X==", "==X", "=XXXX=" etc.) be provided, not "'+(r?t:n)+'".'):o.create(i,[t,n].filter(function(e){return void 0!==e}))},function(e,t,n){var r,t=f(t),a=t.marginLeft,t=t.size,o=("float-box"===i&&(r=(o=f(n)).marginLeft,n=o.size),"box"===i?"%":"vw"),t=_defineProperty(_defineProperty(_defineProperty({display:"block",width:t+o,"max-width":t+o},"box"===i?"margin-left":"left",a+o),"overflow-y","auto"),"padding",function(){var e=s(this).css("padding");return e&&"0px"!==e?e:"1em"});return void 0!==n&&(t.height="box"===i?1.5*n+2+"em":n+"vh"),"float-box"===i&&m(t,{position:"fixed",top:r+"vh","background-color":function(){return c.parentColours(s(this)).backgroundColour}}),e.styles.push(t),e},[String,"box"===i?b(x):String])})}),define("macrolib/values",["macros","state","utils","utils/operationutils","datatypes/colour","datatypes/gradient","datatypes/datatype","datatypes/hookset","datatypes/codehook","internaltypes/twineerror"],function(t,r,e,n,l,c,a,o,i,f){var s=e.realWhitespace,u=e.nth,p=e.anyRealLetter,d=e.plural,h=n.subset,m=n.objectName,g=n.clone,y=n.toSource,e=t.TypeSignature,n=e.rest,b=e.zeroOrMore,v=e.either,w=e.optional,k=e.insensitiveSet,S=e.numberRange,T=e.percent,_=e.nonNegativeInteger,x=e.positiveInteger,e=e.Any,O=Math.max,A=Math.min,C=Math.round,E=Math.floor,N=Math.ceil;function j(t){return function(){var e=t.apply(void 0,arguments);return"number"!=typeof e||isNaN(e)?f.create("macrocall","This mathematical expression doesn't compute!"):e}}t.add(["str","string","text"],"String",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.map(function(e){return i.isPrototypeOf(e)?e.source:e}).join("")},[b(t.TypeSignature.either(String,Number,Boolean,Array,i))])("source","String",function(e,t){return"command"!==(null==t?void 0:t.TwineScript_TypeID)||t.TwineScript_ToSource?y(t):f.create("datatype","I can't construct the source code of a command created by a custom macro.")},[e])("substring","String",function(e,t,n,r){return h(t,n,r)},[String,parseInt,parseInt])("lowercase","String",function(e,t){return t.toLowerCase()},[String])("uppercase","String",function(e,t){return t.toUpperCase()},[String])("lowerfirst","String",function(e,t){return t.replace(RegExp(p+"+"),function(e){return(e=Array.from(e))[0].toLowerCase()+e.slice(1).join("").toLowerCase()})},[String])("upperfirst","String",function(e,t){return t.replace(RegExp(p+"+"),function(e){return(e=Array.from(e))[0].toUpperCase()+e.slice(1).join("").toLowerCase()})},[String])("words","Array",function(e,t){return t.split(RegExp(s+"+")).filter(Boolean)},[String])(["str-repeated","string-repeated"],"String",function(e,t,n){return 0===n.length?f.create("macrocall","I can't repeat an empty string."):n.repeat(t)},[_,String])(["str-reversed","string-reversed"],"String",function(e,t){return _toConsumableArray(t).reverse().join("")},[String])("joined","String",function(e,t){for(var n=arguments.length,r=new Array(2<n?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];return r.join(t)},[n(String)])("plural","String",function(e,t,n,r){return n&&""!==r?d(t,n,r):f.create("macrocall","The (plural:) macro can't be given empty strings.")},[parseInt,String,w(String)])(["str-nth","string-nth"],"String",function(e,t){return u(t)},[parseInt])("digit-format","String",function(e,t,n){if(1e21<=Math.abs(n))return f.create("macrocall","The number given to (digit-format:) is too big.");for(var r=/([^#0])(?=[#0]*$)/g,a=(r.exec(t)||[])[1],o=(/^[#0]*([^#0])/g.exec(t)||[])[1],i=(t=_toConsumableArray(t)).length,s=(a&&(","!==a||o&&","!==o)&&(i=r.lastIndex-1),Math.abs(n).toFixed(16).replace(/(\.\d*?)0+$/,function(e,t){return t}).replace(/^0+/,"")),c=s.includes(".")?s.indexOf("."):s.length,l=0,u="",p=t.length-1;0<=p;--p){var d=t[p];"0"===d||"#"===d?u=(s[c-i+p+l]||("0"===d?"0":""))+u:p<t.length-1&&0<p&&(u=d+u,l+=p===i?0:1)}return(n<0?"-":"")+u},[String,Number])(["num","number"],"Number",function(e,t){return Number.isNaN(+t)?f.create("macrocall","I couldn't convert "+m(t)+" to a number."):+t},[String])("datatype","Datatype",function(e,t){return a.from(t)},[e])("datapattern","Any",function(e,t){return function n(e){var r;return Array.isArray(e)?r=e.map(n):e instanceof Map?(r=new Map,_toConsumableArray(e).forEach(function(e){var e=_slicedToArray(e,2),t=e[0],e=e[1];return r.set(t,n(e))})):r=a.from(e),(e=f.containsError(r))||r}(t)},[e])(["rgb","rgba"],"Colour",function(e){return l.create({r:arguments.length<=1?void 0:arguments[1],g:arguments.length<=2?void 0:arguments[2],b:arguments.length<=3?void 0:arguments[3],a:arguments.length<=4?void 0:arguments[4]})},[S(0,255),S(0,255),S(0,255),w(T)])(["hsl","hsla"],"Colour",function(e,t,n,r,a){return(t=C(t)%360)<0&&(t+=360),l.create({h:t,s:n,l:r,a:a})},[Number,T,T,w(T)])(["lch","lcha"],"Colour",function(e,t,n,r,a){return(r=C(r)%360)<0&&(r+=360),l.create({l:t,c:n,h:r,a:a})},[T,S(0,132),Number,w(T)])("complement","Colour",function(e,t){return t.LCHRotate(180)},[l])("mix","Colour",function(e,t,n,r,a){n=n.toLCHA(),a=a.toLCHA();var o=1,i=(t+r!==1&&(t+r<1&&(o=t+r),t=(i=[t/(t+r),r/(t+r)])[0],r=i[1]),n.c<2||n.l<.01||.99<n.l?n.h=a.h:(a.c<2||a.l<.01||.99<a.l)&&(a.h=n.h),n.l*=n.a,n.c*=n.a,a.l*=a.a,a.c*=a.a,180<a.h-n.h?n.h+=360:a.h-n.h<-180&&(a.h+=360),n.a*t+a.a*r),s=(n.l*t+a.l*r)/i,c=(n.c*t+a.c*r)/i,n=(n.h*t+a.h*r)/i;return l.create({l:s,c:c,h:n,a:i*o})},[T,l,T,l])("palette","Array",function(e,t,n){var r,a=n.toLCHA(),o=a.l,a={l:o<=.75?.75+o/3:.75-3*(1-o),c:80,h:a.h,a:1},i=l.create(a);return a.l+=o<=.75?-.1:.1,a.l<.5&&(a.l*=.5/a.l),r=l.create(a),a.l+=o<=.85?.15:-.15,o=l.create(a),"adjacent"===t?(r=(i=i.LCHRotate(-30)).LCHRotate(30),o=i.LCHRotate(60)):"triad"===t&&(o=i.LCHRotate(180),r=i.LCHRotate(140),i=i.LCHRotate(-140)),[n,i,r,o]},[k("mono","adjacent","triad"),l])("gradient","Gradient",function(e,t){(t=C(t)%360)<0&&(t+=360);for(var n,r,a,o=arguments.length,i=new Array(2<o?o-2:0),s=2;s<o;s++)i[s-2]=arguments[s];return i.length<4?f.create("datatype","(gradient:) must be given at least 2 colour-stop pairs of numbers and colours."):(r=[],a=i.reduce(function(e,t){if(!f.containsError(e))if(void 0===n)n=t;else{if("number"!=typeof n||!l.isPrototypeOf(t))return f.create("datatype","(gradient:) colour-stops should be pairs of numbers and colours, not colours and numbers.");r.push({stop:n,colour:g(t)}),n=void 0}return e},!0),f.containsError(a)?a:void 0!==n?f.create("macrocall","This gradient has a colour-stop percent without a colour."):c.create(t,r))},[Number,n(v(T,l))])("stripes","Gradient",function(e,t,n){(t=C(t)%360)<0&&(t+=360);for(var r=0,a=[],o=arguments.length,i=new Array(3<o?o-3:0),s=3;s<o;s++)i[s-3]=arguments[s];return i.forEach(function(e){a.push({stop:r,colour:g(e)}),r+=n,a.push({stop:r,colour:g(e)})}),c.create(t,a,!0)},[Number,x,l,n(l)])("hooks-named","HookName",function(e,t){return t?o.create({type:"name",data:t}):f.create("datatype","(hooks-named:) can't be given an empty string.")},[String])("cond","Any",function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0;a<n.length;a+=2){var o=n[a];if(a===n.length-1||f.containsError(o))return o;if("boolean"!=typeof o)return f.create("datatype","(cond:)'s "+u(a+1)+" value is "+m(o)+", but should be a boolean.");if(o)return n[a+1]}return f.create("macrocall","An odd number of values must be given to (cond:), not "+n.length,"(cond:) must be given one or more pairs of booleans and values, as well as one final value.")},[Boolean,e,n(e)]);({weekday:[function(){return["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"][(new Date).getDay()]+"day"},null],monthday:[function(){return(new Date).getDate()},null],currenttime:[function(){var e=new Date,t=e.getHours()<12;return(e.getHours()%12||12)+":"+((e.getMinutes()<10?"0":"")+e.getMinutes())+" "+(t?"A":"P")+"M"},null],currentdate:[function(){return(new Date).toDateString()},null],min:[A,n(Number)],max:[O,n(Number)],abs:[Math.abs,Number],sign:[Math.sign,Number],sin:[Math.sin,Number],cos:[Math.cos,Number],tan:[Math.tan,Number],floor:[E,Number],round:[C,Number],trunc:[function(e){return(0<e?E:N)(e)},Number],ceil:[N,Number],pow:[j(Math.pow),[Number,Number]],exp:[Math.exp,Number],sqrt:[j(Math.sqrt),Number],log:[j(Math.log),Number],log10:[j(Math.log10),Number],log2:[j(Math.log2),Number],random:[function(e,t){var n,t=t?(n=A(e,t),O(e,t)):(n=0,e);return t+=1,~~(r.random()*(t-n))+n},[parseInt,t.TypeSignature.optional(parseInt)]],"":function(){for(var e in this)e&&hasOwnProperty.call(this,e)&&t.add(e,"Number",function(a){return function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return a.apply(void 0,n)}}(this[e][0]),this[e][1])}})[""](),t.add("either","Any",function(e){var t=1+~~(r.random()*(arguments.length<=1?0:arguments.length-1));return t<1||arguments.length<=t?void 0:arguments[t]},n(e))("nth","Any",function(e,t){return t<=0?f.create("datatype","(nth:)'s first value should be a positive whole number, not "+t):(t=(t-1)%(arguments.length<=2?0:arguments.length-2)+2)<2||arguments.length<=t?void 0:arguments[t]},[parseInt,n(e)])}),!function(){var a,k={};function o(e){for(var t in e)this[t]=e[t]}function i(e,t){for(var n,r,a=e.innerText,o=null,i=0,s=i,c=a.length,l=null;i<c;){for(var u=a.slice(i),p=(o&&o.length?o[0]:e).innerMode,d=0,f=p.length;d<f;d+=1){var h=k[p[d]];if(!(h.constraint&&!h.constraint(l)||h.cannotFollowText&&("text"===(null==(w=l)?void 0:w.type)||s<i))&&(h.plainCompare?u.startsWith(h.pattern):h.pattern.test(u))){var m=h.fn(h.plainCompare?h.pattern:h.pattern.exec(u)),g=!1,y=0;if(m.matches){for(;o&&y<o.length;y+=1){var b=o[y],v=b.type,b=b.aka;if(v in m.matches){g=!0;break}b&&(v=b),-1<(null==(b=m.cannotCross)?void 0:b.indexOf(v))&&(y=o.length-1)}if((!o||y>=o.length)&&!m.isFront)continue}s<i&&e.addChild({type:"text",text:a.slice(s,i),innerMode:p});var s=i+=(l=e.addChild(m)).text.length,w=!1;g&&(t&&S(e,l,o[y]),o=o.slice(y+1),w=!0),!w&&l.isFront&&(o?o.unshift(l):o=[l]);break}}d===f&&(i+=1,null===l)&&(l={type:"text"})}for(s<i&&e.addChild({type:"text",text:a.slice(s,i),innerMode:(null!=(n=o)&&n.length?o[0]:e).innerMode});0<(null==(r=o)?void 0:r.length);)o.shift().demote();return e}function S(e,t,n){var r=e.children.indexOf(t),a=e.children.indexOf(n);t.children=e.children.splice(a+1,r-(a+1)),t.type=t.matches[n.type],t.innerText="";for(var o,i=0,s=t.children.length;i<s;i++)t.innerText+=t.children[i].text;for(o in t.start=n.start,t.text=n.text+t.innerText+t.text,n)hasOwnProperty.call(n,o)&&!hasOwnProperty.call(t,o)&&(t[o]=n[o]);t.isFront&&(t.isFront=!1),e.children.splice(a,1)}o.prototype={constructor:o,addChild:function(e){var t=this.lastChildEnd(),n=new o(e);return n.start=t,n.end=e.text&&t+e.text.length,n.place=this.place,n.children=[],n.innerText&&i(n),this.children.push(n),n},lastChildEnd:function(){var e=this.children&&this.children[this.children.length-1]||null;return e?e.end:this.start+Math.max(0,this.text.indexOf(this.innerText))},tokenAt:function(e){if(e<this.start||e>=this.end)return null;if(this.children.length)for(var t=0;t<this.children.length;t+=1)if(e>=this.children[t].start&&e<this.children[t].end){var n=this.children[t].tokenAt(e);if(n)return n}return this},pathAt:function(e){if(e<this.start||e>=this.end)return[];var t=[];if(this.children.length)for(var n=0;n<this.children.length;n+=1)if(e>=this.children[n].start&&e<this.children[n].end){var r=this.children[n].pathAt(e);if(r.length){t=t.concat(r);break}}return t.concat(this)},nearestTokenAt:function(n){return n<this.start||n>=this.end?null:this.children?this.children.reduce(function(e,t){return e||(n>=t.start&&n<t.end?t:null)},null):this},everyLeaf:function(n){return this.children&&0!==this.children.length?this.children.reduce(function(e,t){return e&&t.everyLeaf(n)},!0):!!n(this)},demote:function(){this.type="text"},error:function(e){this.type="error",this.message=e},toString:function(){var e=this.type+"("+this.start+"\u2192"+this.end+")";return this.children&&0<this.children.length&&(e+="["+this.children+"]"),e},copy:function(){var e=new o(this);return e.children=e.children.slice(),e},foldChildren:function(){for(var e=[],t=this.children.slice(),n=0;n<t.length;n+=1){var r=t[n],a=!1;if(r.matches)for(var o=0;o<e.length;o+=1)e[o].type in r.matches&&(S(this,r,e[o]),e=e.slice(o+1),a=!0);!a&&r.isFront&&e.unshift(r)}}},a={lex:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"start",r=3<arguments.length&&void 0!==arguments[3]&&arguments[3];return i(new o({type:"root",place:t,start:0,end:e.length,text:e,innerText:e,children:[],innerMode:a.modes[n]}),!r)},rules:k,modes:{}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=a:"function"==typeof define&&define.amd?define("lexer",[],function(){return a}):this&&null!=this&&this.loaded?(this.modules||(this.modules={}),this.modules.Lexer=a):this.Lexer=a}.call(eval("this")||("undefined"!=typeof global?global:window)),!function(){Object.assign=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,r=arguments[t];for(n in r)hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e};var m,g=Object.keys,y=Object.assign;function t(e){function t(n){return n=n||"innerText",function(e){var e=e.reduceRight(function(e,t,n){return e||(n?t:"")},""),t={};return t[n]=e,t}}function n(e,t){var n={};return n[e]=t,function(){return{isFront:!0,matches:n,cannotCross:["verbatimOpener"]}}}var r=Object.bind(0,null);function a(a,e){return Object.keys(e).forEach(function(n){var r=e[n].fn;e[n].fn=function(e){var t=r(e);return t.text||(t.text="string"==typeof e?e:e[0]),t.type||(t.type=n),t.innerMode||(t.innerMode=a),t}}),e}function o(e){switch(e&&e.type){case null:case"br":case"hr":case"bulleted":case"numbered":case"heading":case"align":case"column":case"escapedLine":return!0}return!1}var i=[],s=[],c=[],l=a(i,{hr:{fn:r},bulleted:{fn:function(e){return{depth:e[1].length}}},numbered:{fn:function(e){return{depth:e[1].length/2}}},heading:{fn:function(e){return{depth:e[1].length}}},align:{fn:function(e){var t,e=e[1],n=e.indexOf("><");return~n?25===(t=Math.round(n/(e.length-2)*50))&&(t="center"):"<"===e[0]&&">"===e.slice(-1)?t="justify":-1<e.indexOf(">")?t="right":-1<e.indexOf("<")&&(t="left"),{align:t}}},column:{fn:function(e){var t,e=e[1],n=e.indexOf("|");return n&&n<e.length-1?t="center":"|"===e[0]&&"|"===e.slice(-1)?t="none":n===e.length-1?t="right":n||(t="left"),{column:t,width:/\|+/.exec(e)[0].length,marginLeft:/^=*/.exec(e)[0].length,marginRight:/=*$/.exec(e)[0].length}}}}),u=(g(l).forEach(function(e){l[e].constraint=o,l[e].cannotFollowText=!0}),a(i,{twine1Macro:{fn:function(){return{type:"error",message:"Harlowe macros use a different syntax to Twine 1, SugarCube, and Yarn macros."}}},emBack:{fn:function(){return{matches:{emFront:"em"},cannotCross:["verbatimOpener"]}}},strongBack:{fn:function(){return{matches:{strongFront:"strong"},cannotCross:["verbatimOpener"]}}},strongFront:{fn:function(){return{isFront:!0}}},emFront:{fn:function(){return{isFront:!0}}},boldOpener:{fn:n("boldOpener","bold")},italicOpener:{fn:n("italicOpener","italic")},strikeOpener:{fn:n("strikeOpener","strike")},supOpener:{fn:n("supOpener","sup")},commentFront:{fn:function(){return{isFront:!0}}},commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},scriptStyleTag:{fn:r},tag:{fn:r},url:{fn:r},hookPrependedFront:{fn:function(e){return{name:e[1],hidden:")"===e[2],isFront:!0,tagPosition:"prepended"}}},hookFront:{fn:function(){return{isFront:!0}}},hookBack:{fn:function(){return{matches:{hookPrependedFront:"hook",hookFront:"hook"},cannotCross:["verbatimOpener"]}}},hookAppendedBack:{fn:function(e){return{name:e[2],hidden:"("===e[1],tagPosition:"appended",matches:{hookFront:"hook"},cannotCross:["verbatimOpener"]}}},unclosedHook:{fn:r},unclosedHookPrepended:{fn:function(e){return{type:"unclosedHook",name:e[1],hidden:")"===e[2]}}},verbatimOpener:{fn:function(e){var e=e[0].length,t={};return{type:(t["verbatim"+e]="verbatim")+e,isFront:!0,matches:t,aka:"verbatimOpener"}}},unclosedCollapsed:{fn:r},collapsedFront:{fn:function(){return{isFront:!0}}},collapsedBack:{fn:function(){return{matches:{collapsedFront:"collapsed"},cannotCross:["verbatimOpener"]}}},escapedLine:{fn:r},legacyLink:{fn:function(e){return{type:"twineLink",innerText:e[1],passage:e[2],innerMode:i}}},br:{fn:r}})),p=y(a(s,{macroFront:{fn:function(e){return{isFront:!0,name:e[1]}}},groupingBack:{fn:function(){return{matches:{groupingFront:"grouping",macroFront:"macro"},cannotCross:["singleStringOpener","doubleStringOpener","hookFront"]}}},passageLink:{fn:function(e){var t=e[1]||"",n=e[2]||"",e=e[3]||"";return{type:"twineLink",innerText:n?e:t,passage:t?e:n,innerMode:i}}},simpleLink:{fn:function(e){return{type:"twineLink",innerText:e[1]||"",passage:e[1]||"",innerMode:i}}},variable:{constraint:function(e){return!e||"macroFront"!==e.type},fn:t("name")},tempVariable:{constraint:function(e){return!e||"macroFront"!==e.type},fn:t("name")}}),{hookFront:u.hookFront,hookBack:u.hookBack}),d=a(s,_objectSpread(_objectSpread({commentBack:{fn:function(){return{matches:{commentFront:"comment"}}}},macroName:{constraint:function(e){return e&&"macroFront"===e.type},fn:t("name")},groupingFront:{fn:function(){return{isFront:!0}}},property:{fn:t("name"),constraint:function(e){if(e)switch(e.type){case"variable":case"hookName":case"property":case"tempVariable":case"colour":case"itsProperty":case"belongingItProperty":case"macro":case"grouping":case"string":case"datatype":case"hook":case"boolean":case"number":return!0}}},possessiveOperator:{fn:r},itsProperty:{cannotFollowText:!0,fn:t("name")},itsOperator:{cannotFollowText:!0,fn:r},belongingItProperty:{cannotFollowText:!0,fn:t("name")},belongingItOperator:{cannotFollowText:!0,fn:r},belongingProperty:{cannotFollowText:!0,fn:t("name")},belongingOperator:{cannotFollowText:!0,fn:r},escapedStringChar:{fn:function(){return{type:"text"}}},singleStringOpener:{fn:function(){return{isFront:!0,matches:{singleStringOpener:"string"},innerMode:c}}},doubleStringOpener:{fn:function(){return{isFront:!0,matches:{doubleStringOpener:"string"},innerMode:c}}},hookName:{fn:t("name")},cssTime:{fn:function(e){return{value:+e[1]*("s"===e[2].toLowerCase()?1e3:1)}}},datatype:{cannotFollowText:!0,fn:function(e){return{name:e[0].toLowerCase()}}},colour:{cannotFollowText:!0,fn:function(e){var e=e[0].toLowerCase(),t={red:"e61919",orange:"e68019",yellow:"e5e619",lime:"80e619",green:"19e619",cyan:"19e5e6",aqua:"19e5e6",blue:"197fe6",navy:"1919e6",purple:"7f19e6",fuchsia:"e619e5",magenta:"e619e5",white:"fff",black:"000",gray:"888",grey:"888"},t=hasOwnProperty.call(t,e)?"#"+t[e]:e;return{colour:t}}},number:{fn:function(e){return{value:parseFloat(e[0])}}},inequality:{fn:function(e){return{operator:e[2],negate:-1<e[1].indexOf("not")}}},augmentedAssign:{fn:function(e){return{operator:e[0][0]}}},identifier:{fn:t("name"),cannotFollowText:!0},whitespace:{fn:r,cannotFollowText:!0},incorrectOperator:{fn:function(e){var t={"=>":">=","=<":"<=",gte:">=",lte:"<=",gt:">",lt:"<",eq:"is",isnot:"is not",neq:"is not",isa:"is a",are:"is",x:"*","or a":"or"}[e[0].toLowerCase().replace(/\s+/g," ")];return{type:"error",message:"Please say "+(t?"'"+t+"'":"something else")+" instead of '"+e[0]+"'.",explanation:"In the interests of readability, I want certain operators to be in a specific form."}},cannotFollowText:!0}},["boolean","is","to","into","where","when","via","making","each","and","or","not","isNot","contains","doesNotContain","isIn","isA","isNotA","isNotIn","matches","doesNotMatch","bind"].reduce(function(e,t){return e[t]={fn:r,cannotFollowText:!0},e},{})),["comma","spread","typeSignature","addition","subtraction","multiplication","division"].reduce(function(e,t){return e[t]={fn:r},e},{}))),f=a(c,{singleStringCloser:d.singleStringOpener,doubleStringCloser:d.doubleStringOpener,escapedStringChar:d.escapedStringChar}),h=(i.push.apply(i,_toConsumableArray(g(l)).concat(_toConsumableArray(g(p)),_toConsumableArray(g(u)))),s.push.apply(s,_toConsumableArray(g(p)).concat(_toConsumableArray(g(d)))),c.push.apply(c,_toConsumableArray(g(f))),_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},l),u),p),d),f)),u=(g(h).forEach(function(e){m.PlainCompare[e]?(h[e].pattern=m.PlainCompare[e],h[e].plainCompare=!0):h[e].pattern=RegExp("^(?:"+m[e]+")","i")}),y(e.rules,h),e.modes);return u.start=u.markup=i,u.macro=s,u.string=c,e}function n(e){return Object.freeze({lex:t(e).lex,Patterns:m})}"object"===("undefined"==typeof module?"undefined":_typeof(module))?(m=require("./patterns"),module.exports=n(require("./lexer"))):"function"==typeof define&&define.amd?define("markup",["lexer","patterns"],function(e,t){return m=t,n(e)}):this&&this.loaded&&this.modules?(m=this.modules.Patterns,this.modules.Markup=n(this.modules.Lexer)):(m=this.Patterns,this.Markup=n(this.Lexer))}.call(eval("this")||("undefined"!=typeof global?global:window)),!function(){var e;function n(t){return t&&"object"===_typeof(t)?(Object.keys(t).forEach(function(e){t[e]=n(t[e])}),t):(t+"").replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&")}function t(e){return function(){return"("+e+Array.apply(0,arguments).join("|")+")"}}var r=t("?:"),a=t("?!"),o=t("?="),i="[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",s=i.replace("*","+"),c="\\b",l="[\\w\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171\\uD800-\\uDFFF]",u=l.replace("\\-",""),p=r("\\n","$"),d=i+"(\\*+)"+s,f=i+"((?:0\\.)+)"+s,h=i+"-{3,}"+i+p,m=i+"(==+>|<=+|=+><=+|<==+>)"+i+p,p=i+"(=+\\|+|\\|+=+|=+\\|+=+|\\|=+\\|)"+i+p,g={opener:"\\[\\[(?!\\[)",text:"("+function(){return"[^"+Array.apply(0,arguments).map(n).join("")+"]*"}("]")+")",rightSeparator:r("\\->","\\|"),leftSeparator:"<\\-",closer:"\\]\\]",legacySeparator:"\\|",legacyText:"("+r("[^\\|\\]]","\\]"+a("\\]"))+"+)"},y=u+"*"+u.replace("\\w","a-zA-Z")+u+"*",b="\\$("+y+")",v="_("+y+")",w="'s"+s+a("_")+"("+y+")",k="("+y+")"+s+"of"+c+a("it\\b"),S="'s"+s,T=r("it","time","turns?","visits?","exits?","pos")+c,_="its"+s+"("+y+")",x="("+y+")"+s+"of"+s+"it"+c,O="of"+s+"it"+c,A={opener:"\\(",name:"("+r("\\$","_")+"?"+l+"+):"+a("\\/"),closer:"\\)"},C=r("=<","=>","[gl]te?\\b","n?eq\\b","isnot\\b","are\\b","x\\b","isa\\b","or"+s+"a"+c),E="[a-zA-Z][\\w\\-]*",N="(?:\"[^\"]*\"|'[^']*'|[^'\">])*?",j="\\|("+l+"+)(>|\\))",P="(<|\\()("+l+"+)\\|",R="((?:\\b\\d+(?:\\.\\d+)?|\\.\\d+)(?:[eE][+\\-]?\\d+)?)"+a("m?s")+c;g.main=g.opener+r(g.text+g.rightSeparator,g.text.replace("*","*?")+g.leftSeparator)+g.text,e={upperLetter:"[A-Z\\u00c0-\\u00de\\u0150\\u0170]",lowerLetter:"[a-z0-9_\\-\\u00df-\\u00ff\\u0151\\u0171]",anyLetter:l,anyLetterStrict:u,whitespace:s.replace("[","[\\n\\r"),escapedLine:"\\\\\\n\\\\?|\\n\\\\",br:"\\n(?!\\\\)",tag:"<\\/?"+E+N+">",scriptStyleTag:"<("+r("script","style","textarea")+")"+N+">[^]*?<\\/\\1>",scriptStyleTagOpener:"<",url:"("+r("https?","mailto","javascript","ftp","data")+":\\/\\/[^\\s<]+[^<.,:;\"')\\]\\s])",bullet:"\\*",hr:h,heading:"[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*(#{1,6})[ \\f\\t\\v\\u00a0\\u2000-\\u200a\\u2028\\u2029\\u202f\\u205f\\u3000]*",align:m,column:p,bulleted:d,numbered:f,verbatimOpener:"`+",hookAppendedFront:"\\["+a("=+"),hookPrependedFront:j+"\\["+a("=+"),hookFront:"\\["+a("=+"),hookBack:"\\]"+a(P),hookAppendedBack:"\\]"+P,unclosedHook:"\\[=+",unclosedHookPrepended:j+"\\[=+",unclosedCollapsed:"\\{=+",passageLink:g.main+g.closer,legacyLink:g.opener+g.legacyText+g.legacySeparator+g.legacyText+g.closer,simpleLink:g.opener+g.legacyText+g.closer,macroFront:A.opener+o(A.name),macroName:A.name,groupingFront:"\\("+a(A.name),twine1Macro:"<<[^>\\s]+\\s*(?:\\\\.|'(?:[^'\\\\]*\\\\.)*[^'\\\\]*'|\"(?:[^\"\\\\]*\\\\.)*[^\"\\\\]*\"|[^'\"\\\\>]|>(?!>))*>>",validPropertyName:y,property:w,belongingProperty:k,possessiveOperator:S,belongingOperator:"of\\b",itsOperator:"its\\b",belongingItOperator:O,variable:b,tempVariable:v,hookName:"\\?("+l+"+)\\b",cssTime:"(\\d+\\.?\\d*|\\d*\\.?\\d+)(m?s)\\b",colour:r(r("Red","Orange","Yellow","Lime","Green","Cyan","Aqua","Blue","Navy","Purple","Fuchsia","Magenta","White","Gray","Grey","Black","Transparent"),"#[\\dA-Fa-f]{3}(?:[\\dA-Fa-f]{3})?"),datatype:r("alnum","alphanumeric","any(?:case)?","array","bool(?:ean)?","changer","codehook","colou?r","const","command","dm","data"+r("map","type","set"),"ds","digit","gradient","empty","even","int"+a("o")+"(?:eger)?","lambda","lowercase","macro","linebreak","newline","num(?:ber)?","odd","str(?:ing)?","uppercase","whitespace")+c,number:R,boolean:r("true","false")+c,identifier:T,itsProperty:_,belongingItProperty:x,escapedStringChar:"\\\\[^\\n]",singleStringOpener:"'",doubleStringOpener:'"',singleStringCloser:"'",doubleStringCloser:'"',is:"is"+a(s+"not"+c,s+"an?"+c,s+"in"+c,s+"<",s+">")+c,isNot:"is"+s+"not"+a(s+r("an?","in")+c)+c,isA:"is"+s+"an?"+c,isNotA:"is"+s+"not"+s+"an?"+c,matches:"matches\\b",doesNotMatch:"does"+s+"not"+s+"match"+c,and:"and\\b",or:"or\\b",not:"not\\b",inequality:"((?:is(?:"+s+"not)?"+i+")*)("+r("<(?!=)","<=",">(?!=)",">=")+")",isIn:"is"+s+"in"+c,contains:"contains\\b",doesNotContain:"does"+s+"not"+s+"contain"+c,isNotIn:"is"+s+"not"+s+"in"+c,addition:n("+")+a("="),subtraction:n("-")+a("=","type"),multiplication:n("*")+a("="),division:r("/","%")+a("="),spread:"\\.\\.\\."+a("\\."),to:r("to\\b","="),into:"into\\b",making:"making\\b",where:"where\\b",when:"when\\b",via:"via\\b",each:"each\\b",augmentedAssign:r("\\+","\\-","\\*","\\/","%")+"=",bind:"2?bind\\b",typeSignature:n("-type")+c,incorrectOperator:C,PlainCompare:{comma:",",commentFront:"\x3c!--",commentBack:"--\x3e",strikeOpener:"~~",italicOpener:"//",boldOpener:"''",supOpener:"^^",strongFront:"**",strongBack:"**",emFront:"*",emBack:"*",collapsedFront:"{",collapsedBack:"}",groupingBack:")"}},"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=e:"function"==typeof define&&define.amd?define("patterns",[],function(){return e}):this&&this.loaded?(this.modules||(this.modules={}),this.modules.Patterns=e):this.Patterns=e}.call(eval("this")||("undefined"!=typeof global?global:window)),define("twinescript/operations",["utils","utils/operationutils","datatypes/typedvar","datatypes/datatype","internaltypes/twineerror"],function(e,t,n,r,m){var a=e.plural,o=t.isObject,i=t.collectionType,s=t.is,c=t.isA,l=t.clone,u=t.unique,p=t.contains,e=t.matches,g=t.objectName,d=t.toSource;function f(r,a,o,i){return o=o||"do this to",function(e,t){var n;return 1===a.length&&(t=e),(n=m.containsError(e,t))||(_typeof(e)!==r||_typeof(t)!==r?m.create("operation","I can only ".concat(o," ").concat(r,"s, not ").concat(g(_typeof(e)!==r?e:t),"."),i):a(e,t))}}function h(a){return function(e,t){var n,r;return(n=m.containsError(e,t))||(_typeof(e)!==_typeof(t)||o(e)&&"TwineScript_TypeName"in e&&o(t)&&"TwineScript_TypeName"in t&&e.TwineScript_TypeName!==t.TwineScript_TypeName||i(e)!==i(t)?(n="".concat(g(e)," isn't the same type of data as ").concat(g(t)),_typeof(e)+_typeof(t)!=="stringnumber"&&_typeof(e)+_typeof(t)!=="numberstring"||(r="You might want to convert one side to a number using (num:), or to a string using (str:)."),m.create("operation",n[0].toUpperCase()+n.slice(1),r)):a(e,t))}}function y(d,f,e){var h=2<arguments.length&&void 0!==e&&e;return function r(a,o){var e;if(e=m.containsError(a,o))return e;var t=_slicedToArray(a.determiner?[a,o]:o.determiner?[o,a]:[],2),i=t[0],t=t[1];if(i){var n=i,s=n.determiner,n=n.determined;if("start"===s||"end"===s){if(f)return m.create("operation","I can't use '".concat(f,"' with the 'start' or 'end' of ").concat(g(n),"."));if(t.determiner){if("start"===t.determiner||"end"===t.determiner)return m.create("operation","I can't compare one value's 'start' or 'end' with another value's 'start' or 'end'.","Please change one of them to use an exact range, such as '1stto4th' or '2ndlasttolast'.");n=[t,i],i=n[0]}for(var c=i.string||i.array,l=0;l<c.length+1;l+=1){var u=l?"end"===s?c.slice(-l):c.slice(0,l):c.constructor(),u=i===a?r(u,o):r(a,u);if(e=m.containsError(u))return e;if(u!==h)return u}return h}var p="all"===s;return i.array.reduce(function(e,t){var n,t=i===a?r(t,o):r(a,t);return(n=m.containsError(e,t))||(p?e&&t:e||t)},p)}return d(a,o)}}function b(n,e){return y(function(e,t){e=n(e,t);return m.containsError(e)?e:!e},e,!0)}t="If one of these values is a number, you may want to write a check that it 'is not 0'. Also, if one is a string, you may want to write a check that it 'is not \"\" '.",t={and:f("boolean",h(function(e,t){return e&&t}),"use 'and' to join",t),or:f("boolean",h(function(e,t){return e||t}),"use 'or' to join",t),not:f("boolean",function(e){return!e},"use 'not' to invert",t),"+":h(function(e,t){var n;return Array.isArray(e)?[].concat(_toConsumableArray(e),_toConsumableArray(t)):e instanceof Map?(n=new Map(e),t.forEach(function(e,t){return n.set(t,e)}),n):e instanceof Set?new Set([].concat(_toConsumableArray(e),_toConsumableArray(t)).filter(u).map(l)):"function"==typeof e["TwineScript_+"]?e["TwineScript_+"](t):"string|number|boolean".includes(_typeof(e))?e+t:m.create("operation","I can't use + on ".concat(g(e),"."))}),"-":h(function(e,n){var r;return Array.isArray(e)?e.filter(function(t){return!n.some(function(e){return s(t,e)})}):e instanceof Set?(r=_toConsumableArray(n),new Set(_toConsumableArray(e).filter(function(t){return!r.some(function(e){return s(t,e)})}))):"string"==typeof e?e.split(n).join(""):"number"==typeof e?e-n:m.create("operation","I can't use - on ".concat(g(e),"."))}),"*":f("number",h(function(e,t){return e*t}),"multiply"),"/":f("number",h(function(e,t){return 0===t?m.create("operation","I can't divide ".concat(g(e)," by zero.")):e/t}),"divide"),"%":f("number",h(function(e,t){return 0===t?m.create("operation","I can't modulo ".concat(g(e)," by zero.")):e%t}),"modulus"),"<":y(f("number",h(function(e,t){return e<t}),"do < to"),"<"),">":y(f("number",h(function(e,t){return t<e}),"do > to"),">"),"<=":y(f("number",h(function(e,t){return e<=t}),"do <= to"),"<="),">=":y(f("number",h(function(e,t){return t<=e}),"do >= to"),">="),is:y(s),isNot:b(s),contains:y(p,"contains"),doesNotContain:b(p,"does not contain"),isIn:y(function(e,t){return p(t,e)},"is in"),isNotIn:b(function(e,t){return p(t,e)},"is not in"),isA:y(c,"is a"),isNotA:b(c,"is not a"),typifies:y(function(e,t){return c(t,e)}),untypifies:b(function(e,t){return c(t,e)}),matches:y(e),doesNotMatch:b(e),makeSpreader:function(e){var t;return m.containsError(e)?e:n.isPrototypeOf(e)||r.isPrototypeOf(e)?(t=l(e),(n.isPrototypeOf(e)?t.datatype:t).rest=!0,t):{value:e,spreader:!0,TwineScript_TypeName:"a spreaded '...' value",TwineScript_ObjectName:a("string"==typeof e||Array.isArray(e)?_toConsumableArray(e).length:1,"spreaded '...' value"),TwineScript_Unstorable:!0,TwineScript_ToSource:function(){return""+_toConsumableArray(e).map(d)}}}};return Object.freeze(t)}),define("twinescript/runner",["macros","state","utils","utils/operationutils","twinescript/operations","datatypes/colour","datatypes/hookset","datatypes/lambda","datatypes/datatype","datatypes/varbind","datatypes/codehook","datatypes/typedvar","datatypes/assignmentrequest","internaltypes/varref","internaltypes/twineerror"],function(Macros,State,Utils,_ref127,Operations,Colour,HookSet,Lambda,Datatype,VarBind,CodeHook,TypedVar,AssignmentRequest,VarRef,TwineError){var toSource=_ref127.toSource,typeName=_ref127.typeName,objectName=_ref127.objectName,insensitiveName=Utils.insensitiveName,impossible=Utils.impossible,hash=Utils.hash;function addFreeVariable(e,t){var n,r=e.freeVariables;"macro"===t.type?"current-time"===(n=insensitiveName(t.name))||"current-date"===n||"monthday"===n||"weekday"===n||"history"===n||"visited"===n||"passage"===n?e.freeVariables=!0:t.blockedValue&&!r.blockedValues?r.blockedValues=e.stackTop.blockedValues.concat():"random"!==n&&"either"!==n&&"shuffled"!==n||r.seed||(r.seed=State.seed,r.seedIter=State.seedIter):"identifier"===t.type?"time"!==(n=insensitiveName(t.text))&&"exits"!==n&&"it"!==n&&"visits"!==n&&"turns"!==n||(e.freeVariables=!0):"property"===t.type||"belongingProperty"===t.type?"random"!==insensitiveName(t.name)||r.seed||(r.seed=State.seed,r.seedIter=State.seedIter):"variable"!==t.type&&"tempVariable"!==t.type||(e.freeVariables=!0)}var precedenceTable=[["error","text"],["comma"],["to","into"],["where","when","via","making","each"],["typeSignature"],["augmentedAssign"],["and","or"],["is","isNot"],["contains","doesNotContain","isIn","isNotIn"],["isA","isNotA","matches","doesNotMatch"],["inequality"],["addition","subtraction"],["multiplication","division"],{rightAssociative:["spread","bind"]},{rightAssociative:["not","positive","negative"]},{rightAssociative:["belongingProperty","belongingItProperty","belongingOperator","belongingItOperator"]},["property","itsProperty","possessiveOperator","itsOperator"],["twineLink","macro","identifier","variable","tempVariable","hookName","number","cssTime","boolean","string","hook","colour","datatype","root"],["grouping"]];function precedentToken(e,t){var n,r,a,o=[];if(e.length)for("most"===t?(n=precedenceTable.length-1,r=a=-1):(n=0,r=precedenceTable.length,a=1);n!==r;n+=a){var i=precedenceTable[n],s=NaN;if(i.rightAssociative){for(var c=0;c<e.length;c+=1)if(i.rightAssociative.includes(e[c].type)){s=c;break}}else for(var l=e.length-1;0<=l;--l)if(i.includes(e[l].type)){s=l;break}if(!Number.isNaN(s)&&-1<s){o=[e[s],s];break}}return o}var comparisonOpTypes=["inequality","is","isNot","isIn","contains","doesNotContain","isNotIn","isA","typifies","isNotA","untypifies","matches","doesNotMatch"],inequalityNegator={">":"<=","<":">=",">=":"<","<=":">"};function compileComparisonOperator(e){return"inequality"===e.type?e.negate?inequalityNegator[e.operator]:e.operator:e.type}var comparisonReverser={">":"<","<":">",">=":"<=","<=":">=",contains:"isIn",doesNotContain:"isNotIn",isIn:"contains",isA:"typifies",typifies:"isA",isNotA:"untypifies",untypifies:"isNotA"};function reverseComparisonOperator(e){e=compileComparisonOperator(e);return comparisonReverser[e]||e}var tokenSides={error:"neither",identifier:"neither",variable:"neither",tempVariable:"neither",hookName:"neither",number:"neither",boolean:"neither",string:"neither",hook:"neither",colour:"neither",datatype:"neither",root:"neither",twineLink:"neither",macro:"neither",grouping:"neither",itsProperty:"neither",belongingItProperty:"neither",to:"both",into:"both",typeSignature:"both",augmentedAssign:"both",and:"both",or:"both",belongingOperator:"both",possessiveOperator:"both",multiplication:"both",division:"both",spread:"after",bind:"after",not:"after",belongingProperty:"after",each:"after",itsOperator:"after",positive:"after",negative:"after",belongingItOperator:"before",property:"before"};function missingSideError(e,t,n){return TwineError.create("syntax","I need usable code to be ".concat(e?"left ":"").concat(e&&t?"and ":"").concat(t?"right ":"","of ").concat(n.text,"."))}function wrongSideError(e,t,n){return TwineError.create("syntax","There can't be a ".concat(e&&t?e.map(function(e){return e.text}).join("")+" or "+t.map(function(e){return e.text}).join(""):(e||t).map(function(e){return e.text}).join("")," to the ").concat(e?"left ":"").concat(e&&t?"or ":"").concat(t?"right ":"","of ").concat(n.text,"."),"There could be a comma missing between them.")}function makeEvalReplayFrame(e,t){var n=t.val,r=t.fromCode,a=t.toCode,o=t.toDesc,i=t.reason,s=t.it,c=t.tokens,t=t.i;if(!(200<=e.length)){var l=c[t],u=c.slice(0,t),t=c.slice(t+1);if(1===c.length&&(u=t=!1,l=c[0]),!e[e.length-1].error){var p,d,c=TwineError.containsError(n),f=e[e.length-1].code,h=e[0].basis,m=(null!=(p=u)&&p.length&&null!=(p=t)&&p.length&&u[0].start>t[0].start&&(u=(p=[t,u])[0],t=p[1]),p=a||"".concat(null!=(p=u)&&p.length&&"whitespace"===u[u.length-1].type?" ":"").concat(c?" \ud83d\udc1e ":(n&&!n.TwineScript_ToSource&&n.TwineScript_Unstorable?objectName:toSource)(n)).concat(null==(p=t)||!p.length||"whitespace"!==t[0].type&&"addition"!==l.type&&"subtraction"!==l.type?"":" "),(u.length?u[0]:l).start-h),g=(t.length?t[t.length-1]:l).end-h,y=_createForOfIteratorHelper(e);try{for(y.s();!(d=y.n()).done;){var b=d.value;b.start<m?(m+=b.diff,g+=b.diff):b.start<g&&(g+=b.diff)}}catch(e){y.e(e)}finally{y.f()}!r&&(r=f.slice(m,g),a)&&a.trim()===r.trim()||(u=p.length-(g-m),e.push({code:f.slice(0,m)+p+f.slice(g),fromCode:r,toCode:!c&&a,toDesc:!c&&!a&&(o||objectName(n)),start:m,end:g,diff:u,reason:i,itIdentifier:void 0!==s&&objectName(s),error:c&&c.render(f.slice(m,g),!0)}))}}}function setIt(e,t){return(VarRef.isPrototypeOf(t)||TypedVar.isPrototypeOf(t))&&(e.Identifiers.it=t.get()),t}return function run(section,tokens){var isVarRef=2<arguments.length&&void 0!==arguments[2]&&arguments[2],isTypedVar=3<arguments.length&&void 0!==arguments[3]&&arguments[3],evalReplay=section.evalReplay,hasEvalReplay=null==evalReplay?void 0:evalReplay.length,evalReplayReason,evalReplaySkip=!1,evalReplayIt,ops=Operations,token,ret,i,before,after,_precedentToken,_precedentToken2,token,i,before,after;if(Array.isArray(tokens)||(tokens=[tokens]),!tokens.length||!tokens[0])return impossible("Runner.run","No tokens to run!"),0;1===tokens.length?token=tokens[0]:(_precedentToken=precedentToken(tokens,"least"),_precedentToken2=_slicedToArray(_precedentToken,2),token=_precedentToken2[0],i=_precedentToken2[1],before=tokens.slice(0,i),after=tokens.slice(i+1),before.length&&(1!==before.length||"whitespace"!==before[0].type)||(before=!1),after.length&&(1!==after.length||"whitespace"!==after[0].type)||(after=!1));var type=token.type;if(!type)return impossible("Runner.run","Token has no type!"),0;var sides=tokenSides[type]||"",VARREF=("both"!==sides||before&&after?"neither"===sides&&(before||after)?ret=wrongSideError(before,after,token):"before"===sides?before?after&&(ret=wrongSideError(null,after,token)):ret=missingSideError(!0,!1,token):"after"===sides&&(after?before&&(ret=wrongSideError(before,null,token)):ret=missingSideError(!1,!0,token)):ret=missingSideError(!before,!after,token),section.freeVariables&&"object"===_typeof(section.freeVariables)&&addFreeVariable(section,token),!0),TYPEDVAR=!0,_ret4,val,evalReplayReason,ret,source,_source4,_value4,msg;if(!ret){if("comma"===type)return impossible("Section.run","a comma token was run() somehow."),0;if("root"===type)ret=run(section,token.children);else if("identifier"===type)ret=isVarRef?VarRef.create(section.Identifiers,token.text.toLowerCase()):section.Identifiers[token.text.toLowerCase()];else if("variable"===type||"tempVariable"===type){ret=VarRef.create("tempVariable"===type?section.stackTop.tempVariables:State.variables,token.name),isTypedVar?(ret=TypedVar.create(Datatype.create("any"),ret),evalReplayReason=hasEvalReplay&&"Variables in 'to' or 'into' expressions with no -type to their left are considered to be 'any-type' variables that can store any storable value."):isVarRef||TwineError.containsError(ret)?evalReplaySkip=!0:(val=ret.get(),evalReplayReason=hasEvalReplay&&((null==(_ret4=ret)?void 0:_ret4.object)!==State.variables||hasOwnProperty.call(ret.object,ret.compiledPropertyChain[0])?"":"This variable didn't exist; for story-wide $ variables, a default value of 0 is used if they don't exist."),ret=val)}else if("hookName"===type)ret=HookSet.create({type:"name",data:token.name}),evalReplaySkip=!0;else if("number"===type||"cssTime"===type)ret=token.value,evalReplayReason=hasEvalReplay&&"cssTime"===type&&(token.text.endsWith("ms")?"The letters 'ms' at the end of numbers are ignored, so you can use them to indicate that a number represents milliseconds.":"The letter 's' at the end of numbers represents 'seconds'. Harlowe converts them to milliseconds (multiplies them by 1000)."),evalReplaySkip=!evalReplayReason;else if("boolean"===type)ret="true"===token.text.toLowerCase(),evalReplaySkip=!0;else if("string"===type){var t=token.text.replace(/(.?)\n/g,function(e,t){return("\\"===t?"\\\\":"\n"===t?"\\n":t)+"\\n"}).replace(/(\\*)\\0/g,function(e,t){return(t?"\\".repeat(2*t.length):"")+"0"});ret=eval(t),evalReplaySkip=!0}else if("hook"===type)ret=CodeHook.create(token.children,token.text),evalReplaySkip=!0;else if("colour"===type)ret=Colour.create(token.colour),evalReplaySkip=!0;else if("datatype"===type)ret=Datatype.create(token.name),evalReplaySkip=!0;else if("spread"===type)ret=ops.makeSpreader(run(section,after,!1,isTypedVar));else if("bind"===type)ret=VarBind.create(run(section,after,VARREF),token.text.startsWith("2")?"two way":""),evalReplaySkip=!0;else if("to"===type||"into"===type){var dest="to"===type?setIt(section,run(section,before,VARREF,TYPEDVAR)):run(section,after,VARREF,TYPEDVAR);if(TwineError.containsError(dest))ret=dest;else{(VarRef.isPrototypeOf(dest)&&dest.propertyChain.length<=1||TypedVar.isPrototypeOf(dest)&&dest.varRef.propertyChain.length<=1)&&(section.freeVariables=Object.create(null));var src="to"===type?run(section,after,VARREF):setIt(section,run(section,before,VARREF));if(TwineError.containsError(src))return src;var freeVariables=section.freeVariables,srcRef;section.freeVariables=null,token.place&&freeVariables&&"object"===_typeof(freeVariables)&&"boolean"!=typeof src&&"number"!=typeof src&&!Utils.options.uncompressedPureValues&&(srcRef=freeVariables,srcRef.at=token.place,srcRef.from=after[0].start,srcRef.to=after[after.length-1].end,srcRef.hash=hash(after.reduce(function(e,t){return e+t.text},"")).toString(16),JSON.stringify(srcRef).length>=toSource(src).length)&&(srcRef=void 0),ret=AssignmentRequest.create(dest,src,type,srcRef),evalReplaySkip=!0,evalReplayIt=section.Identifiers.it}}else if("typeSignature"===type){var datatype=run(section,before),free=section.freeVariables,variable=(section.freeVariables=null,run(section,after,VARREF));section.freeVariables=free,ret=TypedVar.create(datatype,variable),evalReplaySkip=!0}else if("where"===type||"when"===type||"via"===type){after?(source=tokens.map(function(e){return e.text}).join(""),ret=Lambda.create(before?run(section,before,VARREF):void 0,token.type,after,source),evalReplaySkip=!0):ret=missingSideError(!1,!0,token)}else if("making"===type||"each"===type){after?(_source4=[].concat(tokens).map(function(e){return e.text}).join(""),ret="each"===type?Lambda.create(run(section,after,VARREF),"each",null,_source4):Lambda.create(before?run(section,before,VARREF):void 0,token.type,run(section,after,VARREF),_source4),evalReplaySkip=!0):ret=missingSideError(!1,!0,token)}else if("augmentedAssign"===type)ret=ops.makeAssignmentRequest(run(section,before,VARREF),ops[token.operator](run(section,before),run(section,after)),token.operator),evalReplaySkip=!0;else if("and"===type||"or"===type){var isComparisonOp=function e(t){var n=_slicedToArray(precedentToken(t,"least"),2),r=n[0],n=n[1];if(r&&"whitespace"!==r.type)return comparisonOpTypes.includes(r.type)?r:r.type===type?e(t.slice(0,n))||e(t.slice(n+1)):void 0},leftIsComparison=isComparisonOp(before),rightIsComparison=isComparisonOp(after),ambiguityError=TwineError.create("operation",'This use of "is not" and "'.concat(type,'" is grammatically ambiguous.'),'Maybe try rewriting this as "__ is not __ '.concat(type,' __ is not __"')),operator,getElisionOperands=function e(t){var n,r=_slicedToArray(precedentToken(t,"least"),2),a=r[0],r=r[1];return a&&"whitespace"!==a.type?a.type===type?[].concat(_toConsumableArray(e(t.slice(0,r))),_toConsumableArray(e(t.slice(r+1)))):(a=run(section,t),hasEvalReplay&&"boolean"!=typeof a&&(n=operator.replace(/[A-Z]/g,function(e){return" "+e.toLowerCase()}),makeEvalReplayFrame(evalReplay,{toCode:" it ".concat(n," ").concat(toSource(a)," "),reason:"A missing 'it ".concat(n,"' was inferred to correct the '").concat(type,"' operation."),tokens:t,i:r}),makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(section.Identifiers.it)," ").concat(n," ").concat(toSource(a)," "),tokens:t,i:r})),[{val:a,tokens:t,i:r}]):[]},elidedComparisonOperator=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(function(e,t){var n=t.val,r=t.tokens,t=t.i;return"boolean"==typeof n?n:(e=Operations[token.type](e,Operations[operator](section.Identifiers.it,n)),hasEvalReplay&&makeEvalReplayFrame(evalReplay,{val:e,tokens:r,i:t}),e)},"and"===token.type)},leftSide,evalBefore,operator,rightSide,rightIndex,swappedSides,evalAfter;ret=leftIsComparison&&!rightIsComparison?(leftSide=leftIsComparison,operator=compileComparisonOperator(leftSide),"isNot"===leftSide.type||"isNotA"===leftSide.type||"untypifies"===leftSide.type?ambiguityError:(evalBefore=run(section,before),ops[type](evalBefore,elidedComparisonOperator.apply(void 0,_toConsumableArray(getElisionOperands(after)))))):!leftIsComparison&&rightIsComparison?(rightSide=rightIsComparison,rightIndex=tokens.indexOf(rightSide),operator=reverseComparisonOperator(rightSide),"isNot"===rightSide.type||"isNotA"===rightSide.type||"untypifies"===rightSide.type?ambiguityError:(swappedSides=[].concat(_toConsumableArray(tokens.slice(rightIndex+1)),[Object.assign(Object.create(rightSide),_defineProperty({},"inequality"===rightSide.type?"operator":"type",reverseComparisonOperator(rightSide)))],_toConsumableArray(tokens.slice(i+1,rightIndex))),evalAfter=run(section,swappedSides),ops[type](evalAfter,elidedComparisonOperator.apply(void 0,_toConsumableArray(getElisionOperands(before)))))):ops[type](run(section,before),run(section,after))}else if(comparisonOpTypes.includes(type)){after||missingSideError(!1,!0,token);var leftOp=before?run(section,before):section.Identifiers.it;ret=ops[compileComparisonOperator(token)](leftOp,run(section,after)),section.Identifiers.it=leftOp,evalReplayIt=leftOp,evalReplayReason=hasEvalReplay&&!before&&"A missing 'it' was inferred to complete the operation."}else if("addition"===type||"subtraction"===type){after||missingSideError(!1,!0,token);var convert=!before,_precedentToken7,_precedentToken8,previousPrecedentToken,_i10,_sides,pType,convert;before&&(_precedentToken7=precedentToken(before,"least"),_precedentToken8=_slicedToArray(_precedentToken7,2),previousPrecedentToken=_precedentToken8[0],_i10=_precedentToken8[1],_sides=tokenSides[previousPrecedentToken.type],pType=previousPrecedentToken.type,convert=("both"===_sides||"after"===_sides||"addition"===pType||"subtraction"===pType)&&(_i10===before.length-1||_i10===before.length-2&&"whitespace"===before[before.length-1].type)),convert?(token.type="addition"===type?"positive":"negative",ret=run(section,tokens),token.type=type,evalReplaySkip=!0):ret=ops[token.text](run(section,before),run(section,after))}else if("multiplication"===type||"division"===type)ret=ops[token.text](run(section,before),run(section,after));else if("positive"===type||"negative"===type)ret=ops["*"]("negative"===type?-1:1,run(section,after)),evalReplaySkip=!0;else if("not"===type)ret=ops.not(run(section,after));else if("belongingProperty"===type){var container=run(section,after,isVarRef),isRef=(ret=VarRef.create(container,token.name),isVarRef||TwineError.containsError(ret));ret=isRef?ret:ret.get(),isRef=isVarRef||TwineError.containsError(ret),hasEvalReplay&&!isRef?makeEvalReplayFrame(evalReplay,{toCode:" ".concat(token.name," of ").concat(toSource(VarRef.isPrototypeOf(container)?container.get():container)," "),tokens:tokens,i:i}):isRef||(evalReplayReason="The value to the right of 'of', ".concat(typeName(container),', had a "').concat(token.name,'" data name corresponding to that data value.'))}else if("belongingOperator"===type||"belongingItOperator"===type){var value=run(section,before);"random"===value&&section.freeVariables&&"object"===_typeof(section.freeVariables)&&!section.freeVariables.seed&&(section.freeVariables.seed=State.seed,section.freeVariables.seedIter=State.seedIter),ret=VarRef.create("belongingItOperator"===type?section.Identifiers.it:run(section,after,isVarRef),{computed:!0,value:value}),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),"belongingItOperator"===type&&hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(value)," of ").concat(toSource(section.Identifiers.it)," "),tokens:tokens,i:i})}else if("property"===type){var _container=run(section,before,VARREF),_isRef=(ret=VarRef.create(_container,token.name),isVarRef||TwineError.containsError(ret));ret=_isRef?ret:ret.get(),_isRef=isVarRef||TwineError.containsError(ret),hasEvalReplay&&VarRef.isPrototypeOf(_container)&&!_isRef?makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(_container.get()),"'s ").concat(token.name," "),tokens:tokens,i:i}):_isRef||(evalReplayReason="The value to the left of 's, ".concat(typeName(_container),', had a "').concat(token.name,'" data name corresponding to that data value.'))}else if("itsProperty"===type||"belongingItProperty"===type)ret=VarRef.create(section.Identifiers.it,token.name),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:"itsProperty"===type?" ".concat(toSource(section.Identifiers.it),"'s ").concat(token.name," "):" ".concat(token.name," of ").concat(toSource(section.Identifiers.it)," "),tokens:tokens,i:i});else if("possessiveOperator"===type||"itsOperator"===type){!after||!before&&"itsOperator"!==token.type?ret=missingSideError(!before,!after,token):(_value4=run(section,after),"random"===_value4&&section.freeVariables&&"object"===_typeof(section.freeVariables)&&!section.freeVariables.seed&&(section.freeVariables.seed=State.seed,section.freeVariables.seedIter=State.seedIter),ret=VarRef.create("itsOperator"===token.type?section.Identifiers.it:run(section,before,isVarRef),{computed:!0,value:_value4}),ret=isVarRef||TwineError.containsError(ret)?ret:ret.get(),"itsOperator"===type&&hasEvalReplay&&makeEvalReplayFrame(evalReplay,{toCode:" ".concat(toSource(section.Identifiers.it),"'s ").concat(toSource(_value4)," "),tokens:tokens,i:i}))}else if("twineLink"===type)ret=Macros.run("link-goto",section,[token.innerText,token.passage]),evalReplayReason=hasEvalReplay&&"Passage links are the same as (link-goto:) macro calls.";else if("macro"===type)if(token.blockedValue&&!section.blocked){if(ret=section.blockedValue(),void 0===ret)return impossible("Runner.run","section.blockedValue() returned undefined"),0}else{var macroNameToken=token.children[0],variableCall="$"===macroNameToken.text[0]||"_"===macroNameToken.text[0],macroRef;if("macroName"!==macroNameToken.type&&!variableCall)return impossible("Runner.run","macro token had no macroName child token"),0;variableCall?(macroRef=VarRef.create("_"===macroNameToken.text[0]?section.stackTop.tempVariables:State.variables,macroNameToken.text.trim().slice(1,-1)),TwineError.containsError(macroRef)||(macroRef=macroRef.get())):macroRef=token.name,ret=Macros[variableCall?"runCustom":"run"](macroRef,section,token.children.slice(1).reduce(function(e,t){return"comma"===t.type?e.push([]):e[e.length-1].push(t),e},[[]]).filter(function(e){return e.length&&(1<e.length||"whitespace"!==e[0].type)}).map(function(e){return run(section,e,!1,isTypedVar)})),evalReplayReason=hasEvalReplay&&variableCall&&"I called ".concat(objectName(macroRef),".")}else if("grouping"===type)ret=run(section,token.children,isVarRef),evalReplaySkip=!0;else if("error"===type)ret=TwineError.create("syntax",token.message,token.explanation||"");else{if("text"!==type)return impossible("Section.run","unknown syntax token type: ".concat(type,"!!")),0;token.text.trim().match(/^\d+(?:th|nd|st|rd)(?:last)?(?:to\d+(?:nth|nd|st|rd)(?:last)?)?$/g)&&(msg='Position data names like "'.concat(token.text,'" need to be either left of "of" or right of "\'s".')),ret=TwineError.create("syntax",msg||'"'.concat(token.text,"\" isn't valid Harlowe syntax for the inside of a macro call."),"Maybe you misspelled something? Also, as of 3.3.0, Javascript syntax is not allowed inside macro calls.")}}return void 0===ret?(impossible("Section.run","token ".concat(type).concat(token.name?" (".concat(token.name,":)"):""," produced undefined")),0):ret===section?(impossible("Section.run","token ".concat(type).concat(token.name?" (".concat(token.name,":)"):""," produced the section")),0):(hasEvalReplay&&!evalReplaySkip&&makeEvalReplayFrame(evalReplay,{val:ret,reason:evalReplayReason,it:evalReplayIt,tokens:tokens,i:i}),ret)}}),define("utils/jqueryplugins",["jquery"],function(e){e.prototype.extend({popAttr:function(e){var t=this.attr(e);return this.removeAttr(e),t},popData:function(e){var t=this.data(e);return this.removeData(e),t},tag:function(){return this[0]&&this[0].tagName&&this[0].tagName.toLowerCase()},textNodes:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"*";return 1===this.length&&this[0]&&this[0].nodeType===Node.TEXT_NODE?[this[0]]:this.get().concat(this.contents().get(),this.find(e).contents().get()).filter(function(e,t,n){return(null==e?void 0:e.nodeType)===Node.TEXT_NODE&&n.indexOf(e)===t}).sort(function(e,t){return 2&e.compareDocumentPosition(t)?1:-1})},findAndFilter:function(e){var t=this.find(e),e=this.filter(e);return e.length?t.add(e):t}})}),define("utils/naturalsort",[],function(){return function(h){var m=1<arguments.length&&void 0!==arguments[1]?arguments[1]:String;return function(e,t){var n,r,a,o,i=/(^-?[0-9]+(\.?[0-9]*)[df]?e?[0-9]?$|^0x[0-9a-f]+$|[0-9]+)/gi,s=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[/-]\d{1,4}[/-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,c=/^0x[0-9a-f]+$/i,l=/^0/,e=m(e).trim(),t=m(t).trim(),u=e.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),p=t.replace(i,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),i=parseInt(e.match(c))||1!==u.length&&e.match(s)&&Date.parse(e),e=parseInt(t.match(c))||i&&t.match(s)&&Date.parse(t)||null;if(h&&window.Intl&&window.Intl.Collator&&(a=window.Intl.Collator(h)),e){if(i<e)return-1;if(e<i)return 1}for(var d=0,f=Math.max(u.length,p.length);d<f;d++){if(n=!(u[d]||"").match(l)&&parseFloat(u[d])||u[d]||0,r=!(p[d]||"").match(l)&&parseFloat(p[d])||p[d]||0,isNaN(n)!==isNaN(r))return isNaN(n)?1:-1;if(_typeof(n)!==_typeof(r))n+="",r+="";else if("string"==typeof n&&a&&0!==(o=a.compare(n,r)))return o;if(n<r)return-1;if(r<n)return 1}return 0}}}),define("utils/operationutils",["utils/naturalsort","utils","internaltypes/twineerror","patterns"],function(f,e,h,t){var m=e.impossible,g=e.nth,u=e.permutations,s=e.plural,y=t.validPropertyName,r="object",n="boolean",b="string",v="number",w="function";function a(e){return!!e&&(_typeof(e)===r||_typeof(e)===w)}var k=Array.isArray;function S(e){return e&&Object.getPrototypeOf(e)===Object.prototype}function i(e){return k(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":_typeof(e)===b?b:e&&_typeof(e)===r?r:""}function c(e){if(a(e)){if(_typeof(e.TwineScript_Clone)===w)return e.TwineScript_Clone();if(k(e))return _toConsumableArray(e);if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(_typeof(e)===w)return Object.assign(e.bind(),e);switch(Object.getPrototypeOf(e)){case Object.prototype:return _objectSpread({},e);case null:return Object.assign(Object.create(null),e)}m("OperationUtils.clone","The value "+e+" cannot be cloned!")}return e}function o(e,t,n,r){for(var a="",o=0;a.length<=t&&o<e.length;){var i=r(e[o]);if(!(i.length+a.length<=t)){a+=(0<o?" and ":"")+s(e.length-o,(0<o?"other ":"")+n);break}a+=(0<o&&o===e.length-1?" and ":"")+i+(o<e.length-1?", ":""),o+=1}return a}function l(e){var t;return a(e)&&"TwineScript_ObjectName"in e?e.TwineScript_ObjectName:k(e)?0===e.length?"an empty array":"an array (with "+o(e,48,"item",l)+")":e instanceof Map?0===e.size?"an empty datamap":"a datamap (with "+o(_toConsumableArray(e.keys()),48,"dataname",_)+")":e instanceof Set?0===e.size?"an empty dataset":"a dataset (with "+o(_toConsumableArray(e.values()),48,"item",l)+")":_typeof(e)===b?0===e.length?"an empty string":48<(t=_toConsumableArray(e)).length?"a ".concat(t.length,"-character string starting with ").concat(JSON.stringify(t.slice(0,48).join(""))):"the string ".concat(JSON.stringify(e)):_typeof(e)===n?"the boolean value '"+e+"'":_typeof(e)===v?"the number "+JSON.stringify(e):void 0===e?"an empty variable":"...whatever this is"}function T(e,t){return[e[0],t[0]].sort(f("en"))[0]===e[0]?-1:1}function _(e,t){var n=h.containsError(e);if(n&&m("toSource","received a TwineError: "+n.message),_typeof(e.TwineScript_ToSource)===w)return e.TwineScript_ToSource();if(S(e)&&"first"in e&&"last"in e)return(e.first<0?(-1!==e.first?g(-e.first):"")+"last":g(e.first+1))+"to"+(e.last<0?(-1!==e.last?g(-e.last):"")+"last":g(e.last+1));if(k(e)){var r,a="",o=_createForOfIteratorHelper(e);try{for(o.s();!(r=o.n()).done;)var i=r.value,a=(a+=a?",":"(a:")+("property"===t?i+(0<i):_(i))}catch(e){o.e(e)}finally{o.f()}return a+(a?")":"(a:)")}if(e instanceof Map){var s,c="",l=_createForOfIteratorHelper(Array.from(e.entries()).sort(T));try{for(l.s();!(s=l.n()).done;){var u=_slicedToArray(s.value,2),p=u[0],d=u[1];c+=(c?",":"(dm:")+_(p)+","+_(d)}}catch(e){l.e(e)}finally{l.f()}return c+(c?")":"(dm:)")}return e instanceof Set?"(ds:"+Array.from(e).sort(f("en")).map(_)+")":_typeof(e)===v&&"property"===t?e<0?-1===e?"last":g(-e)+"last":g(e+1):_typeof(e)===b&&"property"===t?RegExp(y).test(e)?e:"("+JSON.stringify(e)+")":JSON.stringify(e)}function p(t,n){return _typeof(t)!==r&&_typeof(n)!==r?t===n:k(t)&&k(n)?t.length===n.length&&t.every(function(e,t){return p(n[t],e)}):t instanceof Map&&n instanceof Map?p(Array.from(t.entries()).sort(),Array.from(n.entries()).sort()):t instanceof Set&&n instanceof Set?p(_toConsumableArray(t),_toConsumableArray(n)):t&&_typeof(t.TwineScript_is)===w?t.TwineScript_is(n):t&&_typeof(t)===r&&n&&_typeof(n)===r&&S(t)&&S(n)?p(Object.getOwnPropertyNames(t).map(function(e){return[e,t[e]]}),Object.getOwnPropertyNames(n).map(function(e){return[e,n[e]]})):Object.is(t,n)}return Object.freeze({isObject:a,isValidDatamapName:function(e,t){var n;return e instanceof Map||m("isValidDatamapName","called with non-Map"),h.containsError(t)?t:_typeof(t)!==b&&_typeof(t)!==v?h.create("property","Only strings and numbers can be used as data names for "+l(e)+", not "+l(t)+"."):(n=_typeof(t)===b?+t:""+t,!(!Number.isNaN(n)&&e.has(n))||h.create("property","You mustn't use both "+l(t)+" and "+l(n)+" as data names in the same datamap."))},collectionType:i,isSequential:function(e){return _typeof(e)===b||k(e)||_typeof(e.hooks)===w},unstorableValue:function e(t){return(null==t?void 0:t.TwineScript_Unstorable)&&t||k(t)&&t.find(e)||t instanceof Map&&_toConsumableArray(t.values()).find(e)||t instanceof Set&&_toConsumableArray(t).find(e)},isHarloweJSValue:function e(t){return _typeof(t)===b||_typeof(t)===n||_typeof(t)===v&&!Number.isNaN(t)&&Math.abs(t)!==1/0||Array.isArray(t)&&t.every(e)||t instanceof Set&&_toConsumableArray(t).every(e)||t instanceof Map&&_toConsumableArray(t.values()).every(e)&&_toConsumableArray(t.keys()).every(function(e){return _typeof(e)===b})},clone:c,objectName:l,typeName:function e(t){var n,r=S(t);return r&&t.innerType?t.typeName||("insensitive set"===t.pattern?"a case-insensitive string name":"either"===t.pattern?(k(t.innerType)||m("typeName",'"either" pattern had non-array inner type'),t.innerType.map(e).join(" or ")):"optional"===t.pattern?"(optional) "+e(t.innerType):e(t.innerType)):r&&"range"===t.pattern?t.name||(r=t.min,n=t.max,"a"+(0<r?" positive":"")+(t.integer?" whole":"")+" number"+(0===r?" between 0 and "+n:n<1/0?" up to "+n:"")):t===String||t===Number||t===Boolean?"a "+_typeof(t()):t===parseInt?"a whole number":t===Map?"a datamap":t===Set?"a dataset":t===Array?"an array":a(t)&&"TwineScript_TypeName"in t?t.TwineScript_TypeName:l(t)},typeID:function(e){var t=_typeof(e);return[n,b,v].includes(t)?t:k(e)?"array":e instanceof Map?"datamap":e instanceof Set?"dataset":e.TwineScript_TypeID||""},toSource:_,is:p,contains:function(e,t){if(e||""===e){if(_typeof(e)===b)return _typeof(t)!==b?h.create("operation",l(e)+" can only contain strings, not "+l(t)+"."):e.includes(t);if(k(e))return e.some(function(e){return p(e,t)});if(e instanceof Set||e instanceof Map)return Array.from(e.keys()).some(function(e){return p(e,t)})}return h.create("operation",l(e)+" cannot contain any values, let alone "+l(t))},isA:function(e,t){return _typeof(t.TwineScript_IsTypeOf)===w?t.TwineScript_IsTypeOf(e):h.create("operation",'"is a" should only be used to compare type names, not '+l(t)+".")},matches:function t(n,e){var r=!1;if(n&&_typeof(n.TwineScript_IsTypeOf)===w){var a=n.TwineScript_IsTypeOf(e);if(h.containsError(a))return a;r|=a}if(e&&_typeof(e.TwineScript_IsTypeOf)===w){if(a=e.TwineScript_IsTypeOf(n),h.containsError(a))return a;r|=a}if(r)return!0;if(k(n)&&k(e)){for(var o=0,i=0,s=!0;s&&o<n.length&&i<e.length;){var c=n[o],l=e[i];if(c.rest){for(;i<e.length&&t(c,l);)l=e[i+=1];o+=1}else if(l.rest){for(;o<n.length&&t(c,l);)c=n[o+=1];i+=1}else t(c,l)?(o+=1,i+=1):s=!1}return s&&o>=n.length&&i>=e.length}return n instanceof Map&&e instanceof Map?t(Array.from(n.entries()).sort(),Array.from(e.entries()).sort()):n instanceof Set&&e instanceof Set?(n=_toConsumableArray(n),u.apply(void 0,_toConsumableArray(e)).some(function(e){return t(n,e)})):p(n,e)},subset:function e(t,n,r){var a,o;return n&&r?((a=_typeof(t)===b)&&(t=Array.from(t)),n<0&&(n=Math.max(0,t.length+n+1)),(r=r<0?Math.max(0,t.length+r+1):r)<n?e(arguments[0],r,n):(o=t.slice(0<n?n-1:n,r).map(c),a?o.join(""):o)):h.create("macrocall","The sub"+i(t)+" index value must not be "+(n&&r)+".")},range:function e(t,n){if(n<t)return e(n,t);var r=[t];for(n-=t;0<n--;)r.push(++t);return r},printBuiltinValue:function r(e){return h.containsError(e)?e:e&&_typeof(e.TwineScript_Print)===w?e.TwineScript_Print():e instanceof Map?(e=Array.from(e.entries()),h.containsError(e)?e:e.reduce(function(e,t){var n=(t=_slicedToArray(t,2))[0],t=t[1];return e+"<tr><td>`"+r(n)+"`</td><td>`"+r(t)+"`</td></tr>"},"<table class=datamap>")+"</table>"):e instanceof Set?Array.from(e.values()).map(r)+"":k(e)?e.map(r)+"":e&&_typeof(e.jquery)===b?e:a(e)?h.create("unimplemented","I don't know how to print this value yet."):e+""},unique:function(t,e,n){return n.findIndex(function(e){return p(t,e)})===e}})}),define("utils/polyfills",[],function(){var o=Array.prototype;"function"!=typeof o.includes&&(o.includes=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(!Number.isNaN(e)&&Number.isFinite(t)&&void 0!==e)return-1<o.indexOf.call(this,e,t);var n=Object(this),r=parseInt(n.length);if(!(r<=0))for(var a=0<=t?t:Math.max(0,r+t);a<r;){if(Object.is(e,n[a]))return!0;a+=1}return!1}),window.Symbol||(window.Symbol={iterator:"_es6-shim iterator_"})}),define("utils/renderutils",["jquery","utils","renderer"],function(l,u,p){var n=RegExp(u.realWhitespace+"+"),s=RegExp(u.realWhitespace+"+","g");function d(e,t,n){var r,a=e.textContent.length;if(!(a<=t))return r=[e=0===t?e:e.splitText(t)],n&&(n=n<=0?a-n:n)<a&&r.push(e.splitText(n-t)),r}var t,c=function(){var e;return void 0!==t?t:(e=l("<p>"),t=!!e[0].normalize&&(e.append(document.createTextNode("0-"),document.createTextNode("2"),document.createTextNode(""))[0].normalize(),1===e.contents().length))};var f="tw-collapsed,[collapsing=true]";var o=/^(=*)([^=]+)=*$/;return Object.freeze({dialog:function(){var e,t=(c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).section,n=void 0===(n=c.parent)?u.storyElement:n,r=c.cd,a=void 0===(a=c.message)?"":a,o=c.defaultValue,i=void 0===(c=c.buttons)?[{name:"OK",confirm:!0,callback:Object}]:c,s=("a code hook"===a.TwineScript_TypeName&&(a=a.code),l("<tw-backdrop><tw-dialog>"+(o||""===o?"<input type=text style='display:block;margin:0 auto'></input>\n":"")+"<tw-dialog-links>"+(i.length?i.reduce(function(e,t,n){t=t.name;return e+"<tw-link style='margin:0 "+(n===i.length-1?"0 0 0.5em":0===n?"0.5em 0 0":"0.5em")+"' tabindex=0>"+t+"</tw-link>"},""):"<tw-link tabindex=0>"+i[0].name+"</tw-link>")+"</tw-dialog-links></tw-dialog></tw-backdrop>")),c=s.find("tw-dialog");return n.append(s),t?(t.renderInto(a,c,_objectSpread(_objectSpread({},r),{},{append:"prepend"})),null!=(n=(null==r?void 0:r.transition)&&s.find("tw-dialog > tw-transition-container"))&&n.length&&n.appendTo(s).append(c.prepend(n.contents().detach()))):c.prepend(p.exec(a)),o&&((e=s.find("input").last()).val(o).on("keypress",function(e){13===e.which&&(s.remove(),i.filter(function(e){return e.confirm}).forEach(function(e){return e.callback()}))}),setTimeout(function(){return e.focus()},100)),i.reverse().forEach(function(e,t){l(s.find("tw-link").get(-t-1)).on("click",function(){u.options.debug&&u.options.ignoreClickEvents&&!l(s).is(".eval-replay, .harlowe-crash")||(s.remove(),e.callback())})}),s},realWhitespace:n,textNodeToChars:function(r){var e=_toConsumableArray(r.textContent);return 1===e.length?[r]:e.reduce(function(e,t){return t.match(n)&&e.length&&e[e.length-1].match(n)?e[e.length-1]+=t:e.push(t),e},[]).reduce(function(e,t){var n=r;return t.length<r.textContent.length&&(r=r.splitText(t.length)),e.concat(n)},[])},findTextInNodes:function e(t,n){var r=[],a="",o=[];if(!t.length||!n)return o;for(;0<t.length;){r.push(t[0]),a+=t[0].textContent,t.shift();var i=a.indexOf(n);if(-1<i){for(var s=a.length-(i+n.length);i>=r[0].textContent.length;)i-=r[0].textContent.length,r.shift();if(1===r.length){var c=d(r[0],i,i+n.length);o.push(c[0]),c[1]&&t.unshift(c[1]);break}o.push(d(r[0],i,r[0].length)[0]),o.push.apply(o,_toConsumableArray(r.slice(1,-1))),c=d(r[r.length-1],0,r[r.length-1].textContent.length-s),o.push(c[0]),c[1]&&t.unshift(c[1]),o=o.filter(Boolean);break}}return[o].concat(_toConsumableArray(e(t,n)))},collapse:function(e){function n(e){return 0===l(this||e).parentsUntil(f).filter("tw-verbatim, tw-expression, [collapsing=false]").length}var t=function e(t){var n=t[0],r=t.parent();return!r.length||t.findAndFilter("tw-story").length?null:(t=(t=r.textNodes().filter(function(e){return 4&(e=e.compareDocumentPosition(n))&&!(8&e)}))[t.length-1])||e(r)}(e),r=(l(t).parents(f).length||(t=null),function e(t){var n=t[0],r=t.parent();return!r.length||t.findAndFilter("tw-story").length?null:r.textNodes().filter(function(e){return 2&(e=e.compareDocumentPosition(n))&&!(8&e)})[0]||e(r)}(e)),a=(l(r).parents(f).length||(r=null),"br:not([data-raw]),tw-consecutive-br:not([data-raw])"),o=(e.find(a).filter(n).replaceWith(document.createTextNode(" ")),(e=l(e.get().map(function(e){return l(e).filter(n).is(a)?l(document.createTextNode(" ")).replaceAll(e)[0]:e}))).textNodes()),i=0;o.reduce(function(e,t){return n(t)?(t.textContent=t.textContent.replace(s," ")," "!==t.textContent[0]||e&&e.textContent&&!(-1<e.textContent.search(/\s$/))||(t.textContent=t.textContent.slice(1)),t):document.createTextNode("A")},t),_toConsumableArray(o).reverse().every(function(e){return!(!n(e)||(e.textContent.match(/^\s*$/)?(i+=e.textContent.length,e.textContent=""):(e.textContent=e.textContent.replace(/\s+$/,function(e){return i+=e.length,""}),1)))}),0<i&&r&&(o[o.length-1].textContent+=" "),e[0]&&c()&&e[0].normalize()},geomStringRegExp:o,geomParse:function(e){var t,n,r,a;return!e||(t=e.length,n=(a=_slicedToArray(o.exec(e)||[],3))[0],r=a[1],a=a[2],!n)||a===e&&1<a.length?{marginLeft:0,size:0}:{marginLeft:r.length/t*100,size:a.length/t*100}}})}),define("utils/scripttag",["state","utils/operationutils","internaltypes/varref","internaltypes/twineerror"],function(a,o,i,s){return function(e,r){Function("script","scope","with(scope){var scope=void 0,arguments=void 0;eval([script,script=void 0][0]);}")(e,Object.create(null,Object.keys(a.variables).map(function(e){return!e.startsWith("TwineScript_")&&"$"+e}).concat(Object.keys(r).map(function(e){return!e.startsWith("TwineScript_")&&"_"+e})).reduce(function(e,n){return n&&(e[n]={get:function(){var e=("$"===n[0]?a.variables:r)[n.slice(1)];if(o.isHarloweJSValue(e))return o.clone(e);throw s.create("","The contents of the variable ".concat(n,", ").concat(o.objectName(e),", couldn't be converted to a Javascript value."),"Only booleans, strings, numbers, datamaps, datasets and arrays can be converted to Javascript values.")},set:function(e){var t="$"===n[0]?a.variables:r;if(!o.isHarloweJSValue(e))throw s.create("","The Javascript value, ".concat(e,", couldn't be converted to a Harlowe value and assigned to the variable ").concat(n,"."),"Only booleans, strings, numbers (except NaN and Infinity), Maps, Sets and Arrays can be converted to Harlowe values.");e=o.clone(e);t=i.create(t,n.slice(1)).set(e);if(s.containsError(t))throw t}}),e},{})))}}),!function(){function e(t,n,r){return function(e){return"background-color: hsla(".concat(t,",").concat(n,"%,").concat(r,"%,").concat(e,");")}}var t={boolean:"color:hsla(0,0%,30%,1.0)",array:"color:hsla(0,100%,30%,1.0)",dataset:"color:hsla(30,100%,40%,1.0)",number:"color:hsla(30,100%,30%,1.0)",datamap:"color:hsla(60,100%,30%,1.0)",changer:"color:hsla(90,100%,30%,1.0)",lambda:"color:hsla(120,100%,40%,1.0)",hookName:"color:hsla(160,100%,30%,1.0)",string:"color:hsla(180,100%,30%,1.0)",identifier:"color:hsla(200,80%,40%,1.0)",variable:"color:hsla(200,100%,30%,1.0)",tempVariable:"color:hsla(200,70%,20%,1.0)",datatype:"color:hsla(220,100%,30%,1.0)",colour:"color:hsla(280,100%,30%,1.0)",macro:"color:hsla(320,80%,30%,1.0)",twineLink:"color:hsla(240,100%,20%,1.0)"},o=(t.gradient=t.colour,t.command=t.twineLink,t.instant=t.metadata=t.any=t.customMacro=t.macro,Math.min),n=e(40,100,50),r=e(220,100,50),i=/hsla\((\d+),\s*(\d+)%,\s*(\d+)%,\s*(\d+\.\d+)\)/g,s="cm-harlowe-3-",a=(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n={root:"box-sizing:border-box;",hook:n(.05),"hook-2":n(.1),"hook-3":n(.15),"hook-4":n(.2),"hook-5":n(.25),"hook-6":n(.3),"hook-7":n(.35),"hook-8":n(.4),"^=hook , ^=hook-":"font-weight:bold;",unclosedHook:n(.05)+"font-weight:bold;"},"error:not([class*='"+s+"string'])","background-color: hsla(17,100%,50%,0.5) !important;"),"^=macroName","font-style:italic;"),"macroName-boolean",t.boolean),"macroName-array",t.array),"macroName-dataset",t.dataset),"macroName-datatype",t.datatype),"macroName-number",t.number),"macroName-datamap",t.datamap),"macroName-changer",t.changer),"macroName-string",t.string),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"macroName-colour, macroName-gradient",t.colour),"macroName-command, macroName-instant, macroName-metadata",t.command),"macroName-custommacro, macroName-macro, macroName-any",t.macro),"^=macro ","font-weight:bold;"+t.macro),"comma, spread",t.macro),"addition",t.any),"subtraction, multiplication, division",t.number),"is, and, or, not, isNot, contains, doesNotContain, isIn, isA, isNotA, isNotIn, matches, doesNotMatch",t.boolean),"bold, strong","font-weight:bold;"),"italic, em","font-style:italic;"),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"sup","vertical-align: super;font-size:0.8em;"),"strike","text-decoration: line-through;"),"verbatim","background-color: hsla(0,0%,50%,0.1);font:var(--font-monospaced)"),"^=bold, ^=strong, ^=italic, ^=em, ^=sup, ^=verbatim, ^=strike","font-weight:100; color: hsla(0,0%,0%,0.5)"),"^=collapsed","font-weight:bold; color: hsla(201,100%,30%,1.0);"),"unclosedCollapsed",r(.025)+"font-weight:bold; color: hsla(201,100%,30%,1.0);"),"collapsed",r(.025)),"collapsed.hook",r(.05)),"collapsed.hook-2",r(.1)),"collapsed.hook-3",r(.15)),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"collapsed.hook-4",r(.2)),"collapsed.hook-5",r(.25)),"collapsed.hook-6",r(.3)),"collapsed.hook-7",r(.35)),"collapsed.hook-8",r(.4)),"twineLink:not(.text)",t.twineLink),"tag, scriptStyleTag, comment","color: hsla(240,34%,25%,1.0);"),"boolean",t.boolean),"string",t.string),"number",t.number),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"variable",t.variable),"tempVariable",t.tempVariable),"hookName",t.hookName),"datatype",t.datatype),"colour",t.colour),"cssTime",t.number),"passageString",t.variable+";text-decoration:underline 1px;"),"tagString",t.variable+";text-decoration:underline 1px dotted;"),"variableOccurrence, hookOccurrence","background: hsla(159,50%,75%,1.0) !important;"),"^=where, ^=via, ^=with, ^=making, ^=each, ^=when",t.lambda+"; font-style:italic;"),_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(_defineProperty(n,"heading","font-weight:bold;"),"hr","background-image: linear-gradient(0deg, transparent, transparent 45%, hsla(0,0%,75%,1.0) 45%, transparent 55%, transparent);"),"align","color: hsla(14,99%,37%,1.0); background-color: hsla(14,99%,87%,0.1);"),"column","color: hsla(204,99%,37%,1.0); background-color: hsla(204,99%,87%,0.1);"),"escapedLine","font-weight:bold; color: hsla(51,100%,30%,1.0);"),"identifier, property, belongingProperty, itsProperty, belongingItProperty, belongingItOperator, possessiveOperator, belongingOperator",t.identifier),"toString",function(){var a=this;return Object.keys(this).reduce(function(e,n){var r;return"toString"!==n&&(r=n.split(", ").map(function e(t){return-1<t.indexOf(".")?t.split(/\./g).map(e).join(""):0===t.indexOf("^=")?"[class^='"+s+t.slice(2)+"']":"."+s+t}),e+=r.join(", ")+"{"+a[n]+"}",a[n].match(i))&&[".theme-dark","[data-app-theme=dark]"].forEach(function(t){e+=r.map(function(e){return t+" "+e}).join(", ")+"{"+a[n].replace(i,function(e,t,n,r,a){return"hsla("+t+","+o(100,1.5*+n)+"%,"+(100-r)+"%,"+a+")"})+"}"}),e},"")})+"");"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports={Colours:t,CSS:a,versionClass:s}:"function"==typeof define&&define.amd&&define("utils/typecolours",[],function(){return{Colours:t,CSS:a,versionClass:s}})}.call(void 0);
;require("harlowe")}());
</script>

</body>
</html>
